<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Andrew Heiss&#39;s blog</title>
<link>https://knuutila.net/atom.html</link>
<atom:link href="https://knuutila.net/atom.xml" rel="self" type="application/rss+xml"/>
<description>Andrew Heiss&#39;s blog</description>
<language>en</language>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Mon, 14 Aug 2023 21:00:00 GMT</lastBuildDate>
<item>
  <title>Manually generate predicted values for logistic regression with matrix multiplication in R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/index.html</link>
  <description><![CDATA[ 




<div class="page-columns page-full"><p>In a project I’m working on, I need to generate predictions from a logistic regression model. That’s typically a really straightforward task—we can just use <code>predict()</code> to plug a dataset of values into a model, which will spit out predictions either on the (gross, uninterpretable) log odds scale or on the (nice, interpretable) percentage-point scale.<sup>1</sup></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;And for pro-level predictions, use <code>predictions()</code> from <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html">{marginaleffects}</a>.</p></li></div></div>
<p>However, in this project I cannot use <code>predict()</code>—I’m working with a big matrix of posterior coefficient draws from a Bayesian model fit with raw Stan code, so there’s no special <code>predict()</code> function that will work. Instead, I need to use matrix multiplication and manually multiply a matrix of new data with a vector of slopes from the model.</p>
<p>I haven’t had to matrix multiply coefficients with data since my first PhD stats class back in 2012 and I’ve completely forgotten how.</p>
<p>I created this little guide as a reference for myself, and I figured it’d probably be useful for others, so up on the blog it goes (<a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/index.html">see the introduction to this post for more about my philosophy of public work</a>).</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/social-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Image generated with Bing Image Creator with the prompt “regression matrix multiplication in a sketchy style”</figcaption>
</figure>
</div>
<section id="example-1-logistic-regression-model-with-an-intercept-and-slopes" class="level2">
<h2 class="anchored" data-anchor-id="example-1-logistic-regression-model-with-an-intercept-and-slopes">Example 1: Logistic regression model with an intercept and slopes</h2>
<p>Here’s a basic regression model where we predict if a penguin is a Gentoo based on its bill length and body mass.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(palmerpenguins)</span>
<span id="cb1-2"></span>
<span id="cb1-3">penguins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-4">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(sex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_gentoo =</span> species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gentoo"</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb1-8">  is_gentoo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> body_mass_g,</span>
<span id="cb1-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins,</span>
<span id="cb1-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb1-11">)</span></code></pre></div>
</div>
<p>We can generate predicted values across different three different values of bill length: 40 mm, 44 mm, and 48 mm, holding body mass constant at the average (4207 g):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">data_to_plug_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bill_length_mm =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>),</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body_mass_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(penguins<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>body_mass_g)</span>
<span id="cb2-4">)</span>
<span id="cb2-5">data_to_plug_in</span>
<span id="cb2-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   bill_length_mm body_mass_g</span></span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1             40        4207</span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2             44        4207</span></span>
<span id="cb2-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3             48        4207</span></span></code></pre></div>
</div>
<p>We can feed this little dataset into the model using <code>predict()</code>, which can generate predictions as log odds (<code>type = "link"</code>) or probabilities (<code>type = "response"</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb3-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb3-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -2.097 -1.741 -1.385</span></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb3-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb3-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
<p>Yay, nice and easy.</p>
<p>Here’s how to do the same thing with manual matrix multiplication:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get all the coefficients</span></span>
<span id="cb4-2">(coefs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model))</span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    (Intercept) bill_length_mm    body_mass_g </span></span>
<span id="cb4-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     -32.401514       0.088906       0.006358</span></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split intercept and slope coefficients into separate objects</span></span>
<span id="cb4-7">(intercept <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coefs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       -32.4</span></span>
<span id="cb4-10">(slopes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coefs[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## bill_length_mm    body_mass_g </span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       0.088906       0.006358</span></span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the data frame of new data into a matrix</span></span>
<span id="cb4-15">(data_to_plug_in_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(data_to_plug_in))</span>
<span id="cb4-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      bill_length_mm body_mass_g</span></span>
<span id="cb4-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]             40        4207</span></span>
<span id="cb4-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,]             44        4207</span></span>
<span id="cb4-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [3,]             48        4207</span></span>
<span id="cb4-20"></span>
<span id="cb4-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the new data with the slope coefficients, then add the intercept</span></span>
<span id="cb4-22">(log_odds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>((data_to_plug_in_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> slopes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> intercept))</span>
<span id="cb4-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] -2.097 -1.741 -1.385</span></span>
<span id="cb4-24"></span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to probability scale</span></span>
<span id="cb4-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds)</span>
<span id="cb4-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
<p>The results are the same as <code>predict()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -2.097 -1.741 -1.385</span></span>
<span id="cb5-4">log_odds</span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] -2.097 -1.741 -1.385</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 0.1094 0.1492 0.2002</span></span>
<span id="cb5-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds)</span>
<span id="cb5-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
</section>
<section id="example-2-logistic-regression-model-with-a-categorical-predictor-and-no-intercept" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-2-logistic-regression-model-with-a-categorical-predictor-and-no-intercept">Example 2: Logistic regression model with a categorical predictor and no intercept</h2>
<p>This gets a little more complex when working with categorical predictors, especially if you’ve omitted the intercept term. For instance, in the data I’m working with, we have a model that looks something like this, with <code>0</code> added as a term to suppress the intercept and give separate coefficients for each of the levels of <code>sex</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">model_categorical <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb6-2">  is_gentoo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> body_mass_g,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb6-5">)</span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_categorical)</span>
<span id="cb6-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sexfemale        sexmale bill_length_mm    body_mass_g </span></span>
<span id="cb6-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      -75.68237      -89.88199        0.03387        0.01831</span></span></code></pre></div>
</div>
<p>When using <code>predict()</code>, we don’t have to do anything special with this intercept-free model. We can plug in a dataset with different variations of predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">data_to_plug_in_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"female"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"male"</span>),</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bill_length_mm =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>),</span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body_mass_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(penguins<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>body_mass_g)</span>
<span id="cb7-5">)</span>
<span id="cb7-6">data_to_plug_in_cat</span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sex bill_length_mm body_mass_g</span></span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 female             40        4207</span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2   male             40        4207</span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 female             44        4207</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4   male             44        4207</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 female             48        4207</span></span>
<span id="cb7-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6   male             48        4207</span></span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb7-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       1       2       3       4       5       6 </span></span>
<span id="cb7-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb7-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         1         2         3         4         5         6 </span></span>
<span id="cb7-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>
<p>If we want to do this manually, we have to create a matrix version of <code>data_to_plug_in_cat</code> that has separate columns for <code>sexfemale</code> and <code>sexmale</code>. We can’t just use <code>as.matrix(data_to_plug_in_cat)</code>, since that only has a single column for <code>sex</code> (and because that column contains text, it forces the rest of the matrix to be text, which makes it so we can’t do math with it anymore):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(data_to_plug_in_cat)</span>
<span id="cb8-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sex      bill_length_mm body_mass_g</span></span>
<span id="cb8-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] "female" "40"           "4207"     </span></span>
<span id="cb8-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,] "male"   "40"           "4207"     </span></span>
<span id="cb8-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [3,] "female" "44"           "4207"     </span></span>
<span id="cb8-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [4,] "male"   "44"           "4207"     </span></span>
<span id="cb8-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [5,] "female" "48"           "4207"     </span></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [6,] "male"   "48"           "4207"</span></span></code></pre></div>
</div>
<div class="page-columns page-full"><p>Instead, we can use <code>model.matrix()</code> to create a design matrix—also called a dummy-encoded matrix<sup>2</sup> or a one-hot encoded matrix—which makes columns of 0s and 1s for each of the levels of <code>sex</code></p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;Though we should probably quit using the word “dummy” because of its ableist connotations—see <a href="https://developers.google.com/style/word-list#dummy-variable">Google’s developer documentation style guide for alternatives</a>.</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">data_to_plug_in_cat_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(</span>
<span id="cb9-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data_to_plug_in_cat</span>
<span id="cb9-3">)</span>
<span id="cb9-4">data_to_plug_in_cat_mat</span>
<span id="cb9-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   sexfemale sexmale bill_length_mm body_mass_g</span></span>
<span id="cb9-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1         1       0             40        4207</span></span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2         0       1             40        4207</span></span>
<span id="cb9-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3         1       0             44        4207</span></span>
<span id="cb9-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4         0       1             44        4207</span></span>
<span id="cb9-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5         1       0             48        4207</span></span>
<span id="cb9-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6         0       1             48        4207</span></span>
<span id="cb9-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"assign")</span></span>
<span id="cb9-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 1 1 2 3</span></span>
<span id="cb9-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"contrasts")</span></span>
<span id="cb9-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"contrasts")$sex</span></span>
<span id="cb9-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "contr.treatment"</span></span></code></pre></div>
</div>
<p>We can now do math with this matrix. Since we don’t have an intercept term, we don’t need to create separate objects for the slopes and intercepts and can matrix multiply the new data matrix with the model coefficients:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get all the coefficients</span></span>
<span id="cb10-2">(coefs_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_categorical))</span>
<span id="cb10-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sexfemale        sexmale bill_length_mm    body_mass_g </span></span>
<span id="cb10-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      -75.68237      -89.88199        0.03387        0.01831</span></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the newdata with the slope coefficients</span></span>
<span id="cb10-7">(log_odds_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(data_to_plug_in_cat_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> coefs_cat))</span>
<span id="cb10-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1]   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to probability scale</span></span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds_cat)</span>
<span id="cb10-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>
<p>The results are the same!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb11-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       1       2       3       4       5       6 </span></span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb11-4">log_odds_cat</span>
<span id="cb11-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1]   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         1         2         3         4         5         6 </span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span>
<span id="cb11-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds_cat)</span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {Manually Generate Predicted Values for Logistic Regression
    with Matrix Multiplication in {R}},
  date = {2023-08-15},
  url = {https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict},
  doi = {10.59350/qba9a-b3561},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“Manually Generate Predicted Values for
Logistic Regression with Matrix Multiplication in R.”</span> August 15,
2023. <a href="https://doi.org/10.59350/qba9a-b3561">https://doi.org/10.59350/qba9a-b3561</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>statistics</category>
  <category>regression</category>
  <guid>https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/index.html</guid>
  <pubDate>Mon, 14 Aug 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/social-image.png" medium="image" type="image/png" height="75" width="144"/>
</item>
<item>
  <title>The ultimate practical guide to multilevel multinomial conjoint analysis with R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index.html</link>
  <description><![CDATA[ 




<p>I recently <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">posted a guide</a> (mostly for future-me) about how to analyze conjoint survey data with R. I explore two different estimands that social scientists are interested in—causal average marginal component effects (AMCEs) and descriptive marginal means—and show how to find them with R, with both frequentist and Bayesian approaches.</p>
<p>However, that post is a little wrong. It’s not <em>wrong</em> wrong, but it is a bit oversimplified.</p>
<p>When political scientists, psychologists, economists, and other social scientists analyze conjoint data, they overwhelmingly do it with <a href="https://en.wikipedia.org/wiki/Ordinary_least_squares">ordinary least squares (OLS) regression</a>, or just standard linear regression (<code>lm(y ~ x)</code> in R; <code>reg y x</code> in Stata). Even if the outcome is binary, they’ll use OLS and call it a linear probability model. The main R package for working with conjoint data in a frequentist way (<a href="https://thomasleeper.com/cregg/">{cregg}</a>) uses OLS and linear probability models. Social scientists (and economists in particular) adore OLS.</p>
<figure class="figure">
<video controls="" loop="" width="90%" style="display: block; margin: auto;">
  <source src="img/parks-rec-ols.mp4" type="video/mp4">
</video>
<figcaption class="figure-caption">Video by <a href="https://twitter.com/theotheredmund/status/1349453230762196992">Edmund Helmer</a></figcaption>
</figure>
<p>In my earlier guide, <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/#the-overall-model">I showed how to analyze the data with logistic regression</a>, but even that is still overly simplified. In reality, conjoint choice-based experiments are more complex than what regular old OLS regression—or even logistic regression—can handle (though I’m sure some econometrician somewhere has a proof showing that OLS works just fine for multinomial conjoint data :shrug:).</p>
<p>A recent paper published in <em>Political Science Research and Methods</em> <span class="citation" data-cites="JensenMarbleScheve:2021">(Jensen et al. 2021)</span> does an excellent job explaining the problem with using plain old OLS to estimate AMCEs and marginal means with conjoint data (<a href="https://williammarble.co/docs/CityLimits-April2020.pdf">access the preprint here</a>). Their main argument boils down to this: OLS throws away too much useful information about (1) the relationships and covariance between the different combinations of feature levels offered to respondents, and (2) individual-specific differences in how respondents react to different feature levels.</p>
<p>Jensen et al.&nbsp;explain three different approaches to analyzing data that has a natural hierarchical structure like conjoint data (where lots of choices related to different “products” are nested within individuals). This also is the same argument from <a href="https://www.bayesrulesbook.com/chapter-15">chapter 15 of <em>Bayes Rules!</em></a>.</p>
<ol type="1">
<li><p><strong>Pooled data</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#ch15-complete">“no room for individuality”</a>): The easiest way to deal with individual-specific effects is to not to. Lump each choice by each respondent into one big dataset, run OLS on it, and be done. Believe it or not, linear regression right away.</p>
<p>However, this erases all individual-level heterogeneity and details about how different feature levels interact with individual characteristics.</p></li>
<li><p><strong>No pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#no-pooling">“every person for themselves”</a>): An alternative way to deal with individual-specific effects is to run a separate model for each individual. If 800 people participated in the experiment, run 800 different models. That way you can perfectly model the relationship between each individual’s characteristics (political party, age, income, education, etc.) with their choices and preferences.</p>
<p>This sounds neat, but has substantial issues. It’ll only show an identified causal effect if each respondent saw every combination of conjoint features at least once. In the candidate experiment <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">from my previous post</a>, there were 8 features with different counts of attributes: 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6 = 186,624 possibilities. Every respondent would need to see each of the nearly 200,000 options. lol.</p></li>
<li><p><strong>Partial pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#partial-pooling-with-hierarchical-models">“a welcome middle ground”</a>): Jensen et al.’s solution is to use hierarchical models that allow individual-level characteristics to inform choice-level decisions. As <em>Bayes Rules!</em> says:</p>
<blockquote class="blockquote">
<p>[T]hough each group is <em>unique</em>, having been sampled from the same population, all groups are connected and thus might contain valuable information about one another.</p>
</blockquote>
<p>In this kind of model, we want individual-level characteristics like age, income, education, etc. to inform the decision to choose specific outcomes and interact with different feature levels in different ways. Not every respondent needs to have seen all 200,000 options—information about respondents with similar characteristics facing similar sets of choices gets shared because of the hierarchical-ness of the model.</p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Best overview of multilevel models
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overviews I’ve found of how multilevel models work, check out these two resources:</p>
<ul>
<li>Chapters 15–17 in <a href="https://www.bayesrulesbook.com/"><em>Bayes Rules!</em></a> (<a href="https://www.bayesrulesbook.com/chapter-17">especially chapter 17</a>)</li>
<li>Michael Clark’s <a href="https://m-clark.github.io/mixed-models-with-R/"><em>Mixed Models with R</em> guide</a></li>
</ul>
<p><a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">I also have a guide here</a>, but it’s nowhere near as good as those ↑</p>
</div>
</div>
<p>By using a multilevel hierarchical model, <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (2021)</span> show that we can still find AMCEs and causal effects, just like in my previous guide, but we can take advantage of the far richer heterogeneity that we get from these complex statements. We can make cool statements like this (in an experiment that varied policies related to unions):</p>
<blockquote class="blockquote">
<p>On average, Democrats are <img src="https://latex.codecogs.com/png.latex?x"> percentage points more likely than demographically similar Republicans to support a plan that includes expanding union power, relative to the status quo.</p>
</blockquote>
<p>Using hierarchical models for conjoint experiments in political science is new and exciting and revolutionary and neat. That’s the whole point of Jensen et al.’s paper—it’s a call to stop using OLS for everything.</p>
<p>I’ve been working on a conjoint experiment with my coauthors <a href="https://marriott.byu.edu/directory/details?id=50683">Marc Dotson</a> and <a href="https://www.suparnachaudhry.com/">Suparna Chaudhry</a>. Suparna and I are political scientists and this multilevel stuff in general is still relatively new and wildly underused in the discipline. Marc, though, is a marketing scholar. The marketing world has been using hierarchical models for conjoint experiments for a long time and it’s standard practice in that discipline. There’s a whole textbook about the hierarchical model approach in marketing <span class="citation" data-cites="ChapmanFeit:2019">(Chapman and Feit 2019)</span>, and these fancy conjoint multilevel models are used widely throughout the marketing industry.</p>
<p>lol at political science, just now discovering this.</p>
<hr>
<p>So, I need to expand <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">my previous conjoint guide</a>. That’s what this post is for.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with linear regression and packages like <a href="https://broom.tidymodels.org/">{broom}</a> for converting regression results into tidy data frames and <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> for calculating <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">marginal effects</a>.</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws. You <em>don’t</em> need to know how to write stuff in raw Stan.</li>
</ul>
</div>
</div>
<p>I’ll do three things in this guide:</p>
<ol type="1">
<li><strong>Chocolate</strong>: Analyze a simple choice-based conjoint experiment where respondents only saw one set of options. This is so I can (1) explore the {mlogit} package, and (2) figure out how to work with multinomial models and predictions both frequentistly and Bayesianly.</li>
<li><strong>Minivans</strong>: Analyze a more complex choice-based conjoint experiment where respondents saw three randomly selected options fifteen times. I do this with both {mlogit} and {brms} to figure out how to work with true multinomial outcomes both frequentistly and Bayesianly.</li>
<li><strong>Minivans again</strong>: Analyze the same complex choice-based experiment but incorporate respondent-level characteristics into the estimates using a hierarchical or multilevel model. I only do this with {brms} because in reality I have no interest in working with {mlogit} (I only use it here as a sort of baseline for my {brms} explorations).</li>
</ol>
<p>Throughout this example, I’ll use data from two different simulated conjoint choice experiments. You can download these files and follow along:</p>
<ul>
<li><a href="data/choco_candy.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>choco_candy.csv</code></a>: This is simulated data for a hypothetical experiment about consumer preferences for candy features. It comes from p.&nbsp;292 in <span class="citation" data-cites="Kuhfeld:2010">Kuhfeld (2010)</span>, a <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">SAS technical note</a> about how to run multinomial models in SAS. Instead of copying/pasting from the PDF, <a href="https://github.com/sangwoo-statistics/dataset">I found a version of it here</a>, cleaned up by Sangwoo Kim (who also has <a href="https://www.youtube.com/watch?v=ra8Y2FjRqOE">a YouTube tutorial</a> using the same candy data)</li>
<li><a href="data/choco_candy.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>rintro-chapter13conjoint.csv</code></a>: This is simultated data for a hypothetical experiment about consumer preferences for minivan features. It comes from chapter 13 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> and is available from the <a href="http://r-marketing.r-forge.r-project.org/">book’s resources page</a> (or <a href="http://r-marketing.r-forge.r-project.org/data/">directly from their data folder</a>)</li>
</ul>
<p>Additionally, in Part 3, I fit a huge Stan model with {brms} that takes ≈30 minutes to run on my fast laptop. If you want to follow along and not melt your CPU for half an hour, you can download an .rds file of that fitted model that I stuck in <a href="https://osf.io/3y7es/">an OSF project</a>. The code for <code>brm()</code> later in this guide will load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(osfr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interact with OSF via R</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb1-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>)) { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>) }</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_retrieve_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://osf.io/zp6eh"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_download</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conflicts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overwrite"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<p>Let’s load some libraries, create some helper functions, load the data, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert model objects to tidy data frames</span></span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(parameters)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show model results as nice tables</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(survey)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Panel-ish frequentist regression models</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mlogit)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Frequentist multinomial regression models</span></span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dfidx)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Structure data for {mlogit} models</span></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate marginal effects</span></span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggforce)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For facet_col()</span></span>
<span id="cb2-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The best formula-based interface to Stan</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Manipulate Stan results in tidy ways</span></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdist)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fancy distribution plots</span></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine ggplot plots</span></span>
<span id="cb2-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rcartocolor)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Color palettes from CARTOColors (https://carto.com/carto-colors/)</span></span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://github.com/intel/clear-sans</span></span>
<span id="cb2-18">theme_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb2-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb2-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb2-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb2-25">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb2-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb2-27">}</span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>())</span>
<span id="cb2-30"></span>
<span id="cb2-31">clrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">carto_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prism"</span>)</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions for formatting things as percentage points</span></span>
<span id="cb2-34">label_pp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb2-35">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" pp."</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_negative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minus"</span>)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">chocolate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/choco_candy.csv"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(dark, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>),</span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dark, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>)),</span>
<span id="cb3-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(soft, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>),</span>
<span id="cb3-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(soft, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>)),</span>
<span id="cb3-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(nuts, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>),</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(nuts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>))</span>
<span id="cb3-9">  )</span>
<span id="cb3-10"></span>
<span id="cb3-11">minivans <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/rintro-chapter13conjoint.csv"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(seat, cargo, price), factor),</span>
<span id="cb3-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(carpool, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>)),</span>
<span id="cb3-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>))</span>
<span id="cb3-16">  )</span></code></pre></div>
</div>
<p>&nbsp;</p>
<section id="part-1-candy-single-question-basic-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 1: Candy; single question; basic multinomial logit</h1>
<section id="the-setup" class="level2">
<h2 class="anchored" data-anchor-id="the-setup">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these kinds of candies they’d want to buy. Respondents only see this question one time and all possible options are presented simultaneously.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="table">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
<th style="text-align: center;">G</th>
<th style="text-align: center;">H</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Chocolate</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
</tr>
<tr class="even">
<td>Center</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
</tr>
<tr class="odd">
<td>Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
</tr>
<tr class="even">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>The data for this kind of experiment looks like this, with one row for each possible alternative (so eight rows per person, or <code>subj</code>), with the alternative that was selected marked as 1 in <code>choice</code>. Here, Subject 1 chose option E (dark, chewy, no nuts). There were 10 respondents, with 8 rows each, so there are 10 × 8 = 80 rows.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">chocolate</span>
<span id="cb4-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 80 × 6</span></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     subj choice alt   dark  soft  nuts   </span></span>
<span id="cb4-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  </span></span>
<span id="cb4-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1     1      0 A     Milk  Chewy No nuts</span></span>
<span id="cb4-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2     1      0 B     Milk  Chewy Nuts   </span></span>
<span id="cb4-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3     1      0 C     Milk  Soft  No nuts</span></span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4     1      0 D     Milk  Soft  Nuts   </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5     1      1 E     Dark  Chewy No nuts</span></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6     1      0 F     Dark  Chewy Nuts   </span></span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7     1      0 G     Dark  Soft  No nuts</span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8     1      0 H     Dark  Soft  Nuts   </span></span>
<span id="cb4-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9     2      0 A     Milk  Chewy No nuts</span></span>
<span id="cb4-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10     2      0 B     Milk  Chewy Nuts   </span></span>
<span id="cb4-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 70 more rows</span></span></code></pre></div>
</div>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>Respondents were shown eight different options and asked to select one. While this seems like a binary yes/no choice that could work with just regular plain old logistic regression, we want to account for the features and levels in all the unchosen categories too. To do this, we can use <a href="https://en.wikipedia.org/wiki/Multinomial_logistic_regression">multinomial logistic regression</a>, where the outcome variable is an unordered categorical variable with more than two categories. In this case we have eight different possible outcomes: alternatives A through H.</p>
<section id="original-sas-model-as-a-baseline" class="level3">
<h3 class="anchored" data-anchor-id="original-sas-model-as-a-baseline">Original SAS model as a baseline</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol SAS
</div>
</div>
<div class="callout-body-container callout-body">
<p>I know nothing about SAS. I have never opened SAS in my life. It is a mystery to me.</p>
<p>I copied these results directly from p.&nbsp;297 in SAS’s massive <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">“Discrete Choice” technical note</a> <span class="citation" data-cites="Kuhfeld:2010">(Kuhfeld 2010)</span>.</p>
<p>I only have this SAS output here as a baseline reference for what the actual correct coefficients are supposed to be.</p>
</div>
</div>
<p>SAS apparently fits these models with proportional hazard survival-style models, which feels weird, but there’s probably a mathematical or statistical reason for it. You use PROC PHREG to do it:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1">proc phreg data=chocs outest=betas;</span>
<span id="cb5-2">   strata subj set;</span>
<span id="cb5-3">   model c*c(2) = dark soft nuts / ties=breslow;</span>
<span id="cb5-4">   run;</span></code></pre></div>
<p>It gives these results:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1">                   Choice of Chocolate Candies</span>
<span id="cb6-2"></span>
<span id="cb6-3">                       The PHREG Procedure</span>
<span id="cb6-4"></span>
<span id="cb6-5">              Multinomial Logit Parameter Estimates</span>
<span id="cb6-6">              </span>
<span id="cb6-7">                      Parameter     Standard</span>
<span id="cb6-8">                 DF    Estimate        Error  Chi-Square   Pr &gt; ChiSq</span>
<span id="cb6-9">Dark Chocolate   1      1.38629      0.79057      3.0749       0.0795</span>
<span id="cb6-10">Soft Center      1     -2.19722      1.05409      4.3450       0.0371</span>
<span id="cb6-11">With Nuts        1      0.84730      0.69007      1.5076       0.2195</span></code></pre></div>
</section>
<section id="survival-model" class="level3">
<h3 class="anchored" data-anchor-id="survival-model">Survival model</h3>
<p>Ew, enough SAS. Let’s do this with R instead.</p>
<p>We can recreate the same proportional hazards model with <code>coxph()</code> from the {survival} package. Again, this feels weird and not like an intended purpose of survival models and not like multinomial logit at all—in my mind it is neither (1) multinomial nor (2) logit, but whatever. People far smarter than me invented these things, so I’ll just trust them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">model_chocolate_survival <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coxph</span>(</span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Surv</span>(subj, choice) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts, </span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate, </span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"breslow"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is what SAS uses</span></span>
<span id="cb7-5">)</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_survival, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Coefficient |     SE |         95% CI |       z |      p</span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ----------------------------------------------------------------------</span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |      1.3863 | 0.7906 | [-0.16,  2.94] |  1.7535 | 0.0795</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |     -2.1972 | 1.0541 | [-4.26, -0.13] | -2.0845 | 0.0371</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |      0.8473 | 0.6901 | [-0.51,  2.20] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>The coefficients, standard errors, and p-values are identical to the SAS output! The only difference is the statistic: in SAS they use a chi-square statistic, while <code>survival:coxph()</code> uses a z statistic. There’s probably a way to make <code>coxph()</code> use a chi-square statistic, but I don’t care about that. I never use survival models and I’m only doing this to replicate the SAS output and it just doesn’t matter.</p>
</section>
<section id="poisson-model" class="level3">
<h3 class="anchored" data-anchor-id="poisson-model">Poisson model</h3>
<p>An alternative way to fit a multinomial logit model without resorting to survival models is to actually (mis?)use another model family. We can use a Poisson model, even though <code>choice</code> isn’t technically count data, because of obscure stats reasons. <a href="https://online.stat.psu.edu/stat504/lesson/2/2.3/2.3.6">See here</a> for an illustration of the relationship between multinomial and Poisson distributions; or <a href="https://doi.org/10.1093/biomet/asr026">see this 2011 <em>Biometrika</em> paper</a> about using Poisson models to reduce bias in multinomial logit models. Richard McElreath has a subsection about this in <em>Statistical Rethinking</em> as well: “Multinomial in disguise as Poisson” (11.3.3). Or <a href="https://bsky.app/profile/rmcelreath.bsky.social/post/3k4e5s6zbxc2j">as he said over on the currently-walled-garden Bluesky</a>, “All count distributions are just one or more Poisson distributions in a trench coat.”</p>
<p>To account for the repeated subjects in the data, we’ll use <code>svyglm()</code> from the {survey} package so that the standard errors are more accurate.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">model_chocolate_poisson <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb8-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts, </span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate, </span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poisson</span>()</span>
<span id="cb8-5">)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_poisson, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Mean |     SE |         95% CI |       z |      p</span></span>
<span id="cb8-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------</span></span>
<span id="cb8-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) |  -2.9188 | 0.8628 | [-4.97, -1.49] | -3.3829 | 0.0007</span></span>
<span id="cb8-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |   1.3863 | 0.7906 | [ 0.00,  3.28] |  1.7535 | 0.0795</span></span>
<span id="cb8-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |  -2.1972 | 1.0541 | [-5.11, -0.53] | -2.0845 | 0.0371</span></span>
<span id="cb8-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.43,  2.38] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>Lovely—the results are the same.</p>
</section>
<section id="mlogit-model" class="level3">
<h3 class="anchored" data-anchor-id="mlogit-model"><code>mlogit</code> model</h3>
<p>Finally, we can use the {mlogit} package to fit the model. Before using <code>mlogit()</code>, we need to transform our data a bit to specify which column represents the choice (<code>choice)</code> and how the data is indexed: subjects (<code>subj</code>) with repeated alternatives (<code>alt</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">chocolate_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dfidx</span>(</span>
<span id="cb9-2">  chocolate,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subj"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alt"</span>),</span>
<span id="cb9-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice"</span>,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span></span>
<span id="cb9-6">)</span></code></pre></div>
</div>
<p>We can then use this indexed data frame with <code>mlogit()</code>, which uses the familiar R formula interface, but with some extra features separated by <code>|</code>s</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1">outcome ~ features | individual-level variables | alternative-level variables</span></code></pre></div>
<p>If we had columns related to individual-level characteristics or alternative-level characteristics, we could include those in the model—and we’ll do precisely that later in this post. (Incorporating individual-level covariates is the whole point of this post!)</p>
<p>Let’s fit the model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">model_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb11-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb11-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate_idx</span>
<span id="cb11-4">)</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Odds |     SE |         95% CI |       z |      p</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------</span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |   1.3863 | 0.7906 | [-0.16,  2.94] |  1.7535 | 0.0795</span></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |  -2.1972 | 1.0541 | [-4.26, -0.13] | -2.0845 | 0.0371</span></span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.51,  2.20] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>Delightful. All the results are the same as the survival model and the Poisson model.</p>
</section>
<section id="bayesian-model" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-model">Bayesian model</h3>
<p>We can also fit this model in a Bayesian way using {brms}. Stan has a categorical distribution family for multinomial models, and we’ll use it in the next example. For now, for the sake of simplicity, we’ll use a Poisson family, since, as we saw above, that’s a legal way of parameterizing multinomial distributions.</p>
<p>The data has a natural hierarchical structure to it, with 8 choices (for alternatives A through H) nested inside each of the 10 subjects.</p>
<div class="cell" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/chocolate-multilevel-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with candy choices <img src="https://latex.codecogs.com/png.latex?y_%7B%5Ctext%7BA%7D%5Cdots%5Ctext%7BH%7D%7D"> nested in subjects</figcaption>
</figure>
</div>
</div>
</div>
<p>We want to model candy choice (<code>choice</code>) based on candy characteristics (<code>dark</code>, <code>soft</code>, and <code>nuts</code>). We’ll use the subscript <img src="https://latex.codecogs.com/png.latex?i"> to refer to individual candy choices and <img src="https://latex.codecogs.com/png.latex?j"> to refer to subjects.</p>
<p>Since we can legally pretend that this multinomial selection process is actually Poisson, we’ll model it as a Poisson process that has a rate of <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7Bi_j%7D">. We’ll model that <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7Bi_j%7D"> with a log-linked regression model with covariates for each of the levels of each candy feature. To account for the multilevel structure, we’ll include subject-specific offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">) from the global average, thus creating random intercepts. We’ll specify fairly wide priors just because.</p>
<p>Here’s the formal model for all this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BProbability%20of%20selection%20of%20alternative%7D_i%20%5Ctextbf%7B%20in%20subject%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BPoisson%7D(%5Clambda_%7Bi_j%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5Clog(%5Clambda_%7Bi_j%7D)%20=&amp;%5C%20(%5Cbeta_0%20+%20b_%7B0_j%7D)%20+%20%5Cbeta_1%20%5Ctext%7BDark%7D_%7Bi_j%7D%20+%20%5Cbeta_2%20%5Ctext%7BSoft%7D_%7Bi_j%7D%20+%20%5Cbeta_3%20%5Ctext%7BNuts%7D_%7Bi_j%7D%20%5C%5C%5B5pt%5D%0Ab_%7B0_j%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%5Cqquad%5Cqquad%5Cquad%20%5Ctext%7BSubject-specific%20offsets%20from%20global%20choice%20probability%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_0%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%203)%20%5Cqquad%5Cqquad%5Cquad%5C%20%5C%20%5Ctext%7BPrior%20for%20global%20average%20choice%20probability%7D%20%5C%5C%0A%5Cbeta_1,%20%5Cbeta_2,%20%5Cbeta_3%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%203)%20%5Cqquad%5Cqquad%5Cquad%5C%20%5C%20%5Ctext%7BPrior%20for%20candy%20feature%20levels%7D%20%5C%5C%0A%5Csigma_0%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cqquad%20%5Ctext%7BPrior%20for%20between-subject%20variability%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>And here’s the {brms} model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">model_chocolate_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> subj)),</span>
<span id="cb12-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate,</span>
<span id="cb12-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poisson</span>(),</span>
<span id="cb12-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb12-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> Intercept),</span>
<span id="cb12-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b),</span>
<span id="cb12-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd)</span>
<span id="cb12-9">  ),</span>
<span id="cb12-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb12-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_chocolate_brms"</span></span>
<span id="cb12-13">)</span></code></pre></div>
</div>
<p>The results are roughly the same as what we found with all the other models—they’re slightly off because of random MCMC sampling.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_brms)</span>
<span id="cb13-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Fixed Effects</span></span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ----------------------------------------------------------------</span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) |  -3.04 | [-5.07, -1.60] |   100% | 1.000 | 3598.00</span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## darkDark    |   1.35 | [-0.05,  3.16] | 96.92% | 1.000 | 4238.00</span></span>
<span id="cb13-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## softSoft    |  -2.03 | [-4.35, -0.47] | 99.60% | 1.000 | 2867.00</span></span>
<span id="cb13-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nutsNuts    |   0.83 | [-0.40,  2.27] | 90.28% | 1.000 | 4648.00</span></span></code></pre></div>
</div>
</section>
</section>
<section id="predictions" class="level2">
<h2 class="anchored" data-anchor-id="predictions">Predictions</h2>
<p>In the SAS technical note example, they use the model to generated predicted probabilities of the choice of each of the options. In the world of marketing, this can also be seen as the predicted market share for each option. To do this, they plug each of the eight different different combinations of dark, soft, and nuts into the model and calculate the predicted output on the response (i.e.&nbsp;probability) scale. They get these results, where dark, chewy, and nuts is the most likely and popular option (commanding a 50% market share).</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb14-1">      Choice of Chocolate Candies</span>
<span id="cb14-2"></span>
<span id="cb14-3">Obs    Dark    Soft     Nuts       p</span>
<span id="cb14-4"></span>
<span id="cb14-5">  1    Dark    Chewy    Nuts       0.50400</span>
<span id="cb14-6">  2    Dark    Chewy    No Nuts    0.21600</span>
<span id="cb14-7">  3    Milk    Chewy    Nuts       0.12600</span>
<span id="cb14-8">  4    Dark    Soft     Nuts       0.05600</span>
<span id="cb14-9">  5    Milk    Chewy    No Nuts    0.05400</span>
<span id="cb14-10">  6    Dark    Soft     No Nuts    0.02400</span>
<span id="cb14-11">  7    Milk    Soft     Nuts       0.01400</span>
<span id="cb14-12">  8    Milk    Soft     No Nuts    0.00600</span></code></pre></div>
<p>We can do the same thing with R.</p>
<section id="frequentist-predictions" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-predictions">Frequentist predictions</h3>
<p>{mlogit} model objects have predicted values stored in one of their slots (<code>model_chocolate_mlogit$probabilities</code>), but they’re in a weird non-tidy matrix form and I like working with tidy data. I’m also a huge fan of <a href="https://vincentarelbundock.github.io/marginaleffects/">the {marginaleffects} package</a>, which provides a consistent way to calculate predictions, comparisons, and slopes/marginal effects (with <code>predictions()</code>, <code>comparisons()</code>, and <code>slopes()</code>) for dozens of kinds of models, including <code>mlogit()</code> models.</p>
<p>So instead of wrangling the built-in <code>mlogit()</code> probabilities, we’ll generate predictions by feeding the model the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code> to <code>marginaleffects::predictions()</code>, which will provide us with probability- or proportion-scale predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">preds_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb15-2">  model_chocolate_mlogit, </span>
<span id="cb15-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb15-4">)</span>
<span id="cb15-5"></span>
<span id="cb15-6">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions() hides a bunch of columns; forcing it to be a tibble unhides them</span></span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(group, dark, soft, nuts, estimate, std.error, statistic, p.value)</span>
<span id="cb15-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 8</span></span>
<span id="cb15-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   group dark  soft  nuts    estimate std.error statistic  p.value</span></span>
<span id="cb15-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb15-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 F     Dark  Chewy Nuts     0.504     0.142       3.56  0.000373</span></span>
<span id="cb15-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 E     Dark  Chewy No nuts  0.216     0.112       1.93  0.0540  </span></span>
<span id="cb15-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 B     Milk  Chewy Nuts     0.126     0.0849      1.48  0.138   </span></span>
<span id="cb15-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 H     Dark  Soft  Nuts     0.0560    0.0551      1.02  0.309   </span></span>
<span id="cb15-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 A     Milk  Chewy No nuts  0.0540    0.0433      1.25  0.213   </span></span>
<span id="cb15-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 G     Dark  Soft  No nuts  0.0240    0.0258      0.929 0.353   </span></span>
<span id="cb15-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 D     Milk  Soft  Nuts     0.0140    0.0162      0.863 0.388   </span></span>
<span id="cb15-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 C     Milk  Soft  No nuts  0.00600   0.00743     0.808 0.419</span></span></code></pre></div>
</div>
<p>Perfect! They’re identical to the SAS output.</p>
<p>We can play around with these predictions to describe the overall market for candy. Chewy candies dominate the market…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(estimate))</span>
<span id="cb16-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb16-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  share</span></span>
<span id="cb16-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;dbl&gt;</span></span>
<span id="cb16-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk  0.200</span></span>
<span id="cb16-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark  0.800</span></span></code></pre></div>
</div>
<p>…and dark chewy candies are by far the most popular:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark, soft) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(estimate))</span>
<span id="cb17-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb17-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   dark [2]</span></span>
<span id="cb17-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  soft   share</span></span>
<span id="cb17-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb17-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk  Chewy 0.180 </span></span>
<span id="cb17-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Milk  Soft  0.0200</span></span>
<span id="cb17-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Dark  Chewy 0.720 </span></span>
<span id="cb17-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Dark  Soft  0.0800</span></span></code></pre></div>
</div>
</section>
<section id="bayesian-predictions" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-predictions">Bayesian predictions</h3>
<p>{marginaleffects} supports {brms} models too, so we can basically run the same <code>predictions()</code> function to generate predictions for our Bayesian model. Magical.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol subject offsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When plugging values into <code>predictions()</code> (or <code>avg_slopes()</code> or any function that calculates predictions from a model), we have to decide how to handle the random subject offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">). <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary">I have a whole other blog post guide about this</a> and how absolutely maddening the nomenclature for all this is.</p>
<p>By default, <code>predictions()</code> and friends will calculate predictions for subjects on average by using the <code>re_formula = NULL</code> argument. This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average subject. When working with slopes, this is also called a <em>marginal effect</em>.</p>
<p>We could also use <code>re_formula = NA</code> to calculate predictions for a typical subject, or a subject where the random offset is set to 0. When working with slopes, this is also called a <em>conditional effect</em>.</p>
<ul>
<li>Conditional predictions/effect = average subject = <code>re_formula = NA</code></li>
<li>Marginal predictions/effect = subjects on average = <code>re_formula = NULL</code> (default), using existing subject levels or a new simulated subject</li>
</ul>
<p>Again, <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects">see this guide for way more about these distinctions</a>. In this example here, we’ll just use the default marginal predictions/effects (<code>re_formula = NULL</code>), or the effect for subjects on average.</p>
</div>
</div>
<p>The predicted proportions aren’t identical to the SAS output, but they’re close enough, given that it’s a completely different modeling approach.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">preds_chocolate_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb18-2">  model_chocolate_brms, </span>
<span id="cb18-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb18-4">) </span>
<span id="cb18-5"></span>
<span id="cb18-6">preds_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(dark, soft, nuts, estimate, conf.low, conf.high)</span>
<span id="cb18-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 6</span></span>
<span id="cb18-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  soft  nuts    estimate conf.low conf.high</span></span>
<span id="cb18-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb18-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Dark  Chewy Nuts     0.432   0.144       1.09  </span></span>
<span id="cb18-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark  Chewy No nuts  0.186   0.0424      0.571 </span></span>
<span id="cb18-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Milk  Chewy Nuts     0.110   0.0168      0.419 </span></span>
<span id="cb18-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Dark  Soft  Nuts     0.0553  0.00519     0.279 </span></span>
<span id="cb18-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Milk  Chewy No nuts  0.0465  0.00552     0.219 </span></span>
<span id="cb18-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Dark  Soft  No nuts  0.0230  0.00182     0.141 </span></span>
<span id="cb18-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 Milk  Soft  Nuts     0.0136  0.00104     0.0881</span></span>
<span id="cb18-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 Milk  Soft  No nuts  0.00556 0.000326    0.0414</span></span></code></pre></div>
</div>
</section>
<section id="plots" class="level3">
<h3 class="anchored" data-anchor-id="plots">Plots</h3>
<p>Since <code>predictions()</code> returns a tidy data frame, we can plot these predicted probabilities (or market shares or however we want to think about them) with {ggplot2}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_sentence</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dark} chocolate, {soft} interior, {nuts}"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb19-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted probability of selection"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb19-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist {mlogit} predictions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb19-12"></span>
<span id="cb19-13">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the posterior draws of the predictions</span></span>
<span id="cb19-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_sentence</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dark} chocolate, {soft} interior, {nuts}"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>])  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb19-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted probability of selection"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb19-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bayesian {brms} predictions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the x-axis match the mlogit plot</span></span>
<span id="cb19-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>))</span>
<span id="cb19-27"></span>
<span id="cb19-28">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-chocolate-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="amces" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="amces">AMCEs</h2>
<p>The marketing world doesn’t typically look at coefficients or marginal effects, but the political science world definitely does. In political science, the estimand we often care about the most is the average marginal component effect (AMCE), or the causal effect of moving one feature level to a different value, holding all other features constant. <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">I have a whole in-depth blog post about AMCEs and how to calculate them</a>—go look at that for more details. Long story short—AMCEs are basically the coefficients in a regression model.</p>
<p>Interpreting the coefficients is difficult with models that aren’t basic linear regression. Here, all these coefficients are on the log scale, so they’re not directly interpretable. The original SAS technical note also doesn’t really interpret any of these , they don’t really interpret these things anyway, since they’re more focused on predictions. All they say is this:</p>
<blockquote class="blockquote">
<p>The parameter estimate with the smallest <em>p</em>-value is for soft center. Since the parameter estimate is negative, chewy is the more preferred level. Dark is preferred over milk, and nuts over no nuts, however only the <em>p</em>-value for Soft is less than 0.05.</p>
</blockquote>
<p>We could exponentiate the coefficients to make them multiplicative (akin to odds ratios in logistic regression). For center = soft, <img src="https://latex.codecogs.com/png.latex?e%5E%7B-2.19722%7D"> = 0.1111, which means that candies with a soft center are 89% less likely to be chosen than candies with a chewy center, relative to the average candy. But that’s weird to think about.</p>
<p>So instead we can turn to {marginaleffects} once again to calculate percentage-point scale estimands that we can interpret far more easily.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol marginal effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nobody is ever consistent about the word “marginal effect.” Some people use it to refer to averages; some people use it to refer to slopes. These are complete opposites. In calculus, averages = integrals and slopes = derivatives and they’re the inverse of each other.</p>
<p>I like to think of marginal effects as what happens to the outcome when you move an explanatory variable a tiny bit. With continuous variables, that’s a slope; with categorical variables, that’s an offset in average outcomes. These correspond directly to how you normally interpret regression coefficients. Or returning to <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards">my favorite analogy about regression</a>, with numeric variables we care what happens to the outcome when we slide the value up a tiny bit; with categorical variables we care about what happens to the outcome when we switch on a category.</p>
<p>Additionally, there are like a billion different ways to calculate marginal effects: average marginal effects (AMEs), group-average marginal effects (G-AMEs), marginal effects at user-specified values, marginal effects at the mean (MEM), and counterfactual marginal effects. See <a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">the documentation for {marginaleffects}</a> + <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this mega blog post</a> for more about these subtle differences.</p>
</div>
</div>
<section id="bayesian-comparisonscontrasts" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts">Bayesian comparisons/contrasts</h3>
<p>We can use <code>avg_comparisons()</code> to calculate the difference (or average marginal effect) for each of the categorical coefficients on the percentage-point scale, showing the effect of moving from milk → dark, chewy → soft, and nuts → no nuts.</p>
<p>(Technically we can also use <code>avg_slopes()</code>, even though none of these coefficients are actually slopes. {marginaleffects} is smart enough to show contrasts for categorical variables and partial derivatives/slopes for continuous variables.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model_chocolate_brms)</span>
<span id="cb20-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb20-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Term       Contrast Estimate    2.5 %  97.5 %</span></span>
<span id="cb20-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  dark Dark - Milk       0.139 -0.00551  0.3211</span></span>
<span id="cb20-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  nuts Nuts - No nuts    0.092 -0.05221  0.2599</span></span>
<span id="cb20-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  soft Soft - Chewy     -0.182 -0.35800 -0.0523</span></span>
<span id="cb20-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb20-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, contrast, estimate, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>When holding all other features constant, moving from chewy → soft is associated with a posterior median 18 percentage point decrease in the probability of selection (or drop in market share if you want to think of it that way), on average.</p>
</section>
<section id="frequentist-comparisonscontrasts" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts">Frequentist comparisons/contrasts</h3>
<p>We went out of order in this section and showed how to use <code>avg_comparisons()</code> with the Bayesian model first instead of the frequentist model. That’s because it was easy. <code>mlogit()</code> models <a href="https://vincentarelbundock.github.io/marginaleffects/articles/categorical.html#mlogit-package">behave strangely with {marginaleffects}</a> because {mlogit} forces its predictions to use every possible value of the alternatives A–H. Accordingly, the estimate for any coefficients in the attributes section of the {mlogit} formula (<code>dark</code>, <code>soft</code>, and <code>nuts</code> here) will automatically be zero. Note how here there are 24 rows of comparisons instead of 3, since we get comparisons in each of the 8 groups, and note how the estimates are all zero:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model_chocolate_mlogit)</span>
<span id="cb21-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb21-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Term       Contrast  Estimate Std. Error         z Pr(&gt;|z|)     2.5 %   97.5 %</span></span>
<span id="cb21-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A dark Dark - Milk    -2.78e-17   7.27e-13 -3.82e-05        1 -1.42e-12 1.42e-12</span></span>
<span id="cb21-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B dark Dark - Milk     0.00e+00         NA        NA       NA        NA       NA</span></span>
<span id="cb21-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C dark Dark - Milk     0.00e+00   1.62e-14  0.00e+00        1 -3.17e-14 3.17e-14</span></span>
<span id="cb21-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D dark Dark - Milk    -6.94e-18   1.73e-13 -4.02e-05        1 -3.38e-13 3.38e-13</span></span>
<span id="cb21-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E dark Dark - Milk    -2.78e-17   7.27e-13 -3.82e-05        1 -1.42e-12 1.42e-12</span></span>
<span id="cb21-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F dark Dark - Milk     0.00e+00         NA        NA       NA        NA       NA</span></span>
<span id="cb21-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G dark Dark - Milk     0.00e+00   1.62e-14  0.00e+00        1 -3.17e-14 3.17e-14</span></span>
<span id="cb21-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H dark Dark - Milk    -6.94e-18   1.73e-13 -4.02e-05        1 -3.38e-13 3.38e-13</span></span>
<span id="cb21-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A nuts Nuts - No nuts  1.39e-17         NA        NA       NA        NA       NA</span></span>
<span id="cb21-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B nuts Nuts - No nuts  1.39e-17         NA        NA       NA        NA       NA</span></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C nuts Nuts - No nuts  0.00e+00   1.41e-14  0.00e+00        1 -2.77e-14 2.77e-14</span></span>
<span id="cb21-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D nuts Nuts - No nuts  0.00e+00   1.41e-14  0.00e+00        1 -2.77e-14 2.77e-14</span></span>
<span id="cb21-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E nuts Nuts - No nuts  0.00e+00   9.74e-13  0.00e+00        1 -1.91e-12 1.91e-12</span></span>
<span id="cb21-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F nuts Nuts - No nuts  0.00e+00   9.74e-13  0.00e+00        1 -1.91e-12 1.91e-12</span></span>
<span id="cb21-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G nuts Nuts - No nuts  0.00e+00   1.08e-13  0.00e+00        1 -2.11e-13 2.11e-13</span></span>
<span id="cb21-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H nuts Nuts - No nuts  0.00e+00   1.08e-13  0.00e+00        1 -2.11e-13 2.11e-13</span></span>
<span id="cb21-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A soft Soft - Chewy    6.94e-18   1.08e-13  6.42e-05        1 -2.12e-13 2.12e-13</span></span>
<span id="cb21-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B soft Soft - Chewy    1.39e-17   2.16e-13  6.43e-05        1 -4.23e-13 4.23e-13</span></span>
<span id="cb21-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C soft Soft - Chewy    6.94e-18   1.08e-13  6.42e-05        1 -2.12e-13 2.12e-13</span></span>
<span id="cb21-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D soft Soft - Chewy    1.39e-17   2.16e-13  6.43e-05        1 -4.23e-13 4.23e-13</span></span>
<span id="cb21-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E soft Soft - Chewy    1.39e-17   4.33e-13  3.21e-05        1 -8.48e-13 8.48e-13</span></span>
<span id="cb21-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F soft Soft - Chewy    0.00e+00   4.52e-13  0.00e+00        1 -8.86e-13 8.86e-13</span></span>
<span id="cb21-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G soft Soft - Chewy    1.39e-17   4.33e-13  3.21e-05        1 -8.48e-13 8.48e-13</span></span>
<span id="cb21-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H soft Soft - Chewy    0.00e+00   4.52e-13  0.00e+00        1 -8.86e-13 8.86e-13</span></span>
<span id="cb21-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb21-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>If we had continuous variables, we could work around this by <a href="https://vincentarelbundock.github.io/marginaleffects/articles/categorical.html#mlogit-package">specifying our own tiny amount of marginal change</a> to compare across, but we’re working with categories and can’t do that. Instead, with categorical variables, we can return to <code>predictions()</code> and <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html#multinomial-models">define custom aggregations of different features and levels</a>.</p>
<p>Before making custom aggregations, though, it’ll be helpful to illustrate what exactly we’re looking at when collapsing these results. Remember that earlier we calculated predictions for all the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">preds_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb22-2">  model_chocolate_mlogit, </span>
<span id="cb22-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb22-4">) </span>
<span id="cb22-5"></span>
<span id="cb22-6">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(group, dark, soft, nuts, estimate)</span>
<span id="cb22-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 5</span></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   group dark  soft  nuts    estimate</span></span>
<span id="cb22-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;</span></span>
<span id="cb22-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 A     Milk  Chewy No nuts  0.0540 </span></span>
<span id="cb22-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 B     Milk  Chewy Nuts     0.126  </span></span>
<span id="cb22-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 C     Milk  Soft  No nuts  0.00600</span></span>
<span id="cb22-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 D     Milk  Soft  Nuts     0.0140 </span></span>
<span id="cb22-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 E     Dark  Chewy No nuts  0.216  </span></span>
<span id="cb22-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 F     Dark  Chewy Nuts     0.504  </span></span>
<span id="cb22-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 G     Dark  Soft  No nuts  0.0240 </span></span>
<span id="cb22-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 H     Dark  Soft  Nuts     0.0560</span></span></code></pre></div>
</div>
<p>Four of the groups have <code>dark</code> = Milk and four have <code>dark</code> = Dark, with other varying characteristics across those groups (chewy/soft, nuts/no nuts). If we want the average proportion of all milk and dark chocolate options, we can group and summarize:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(estimate))</span>
<span id="cb23-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb23-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  avg_pred</span></span>
<span id="cb23-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span id="cb23-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk    0.0500</span></span>
<span id="cb23-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark    0.200</span></span></code></pre></div>
</div>
<p>The average market share for milk chocolate candies, holding all other features constant, is 5% (<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B0.0540%20+%200.126%20+%200.006%20+%200.014%7D%7B2%7D%20=%200.05">); the average market share for dark chocolate candies is 20% (<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B0.216%20+%200.504%20+%200.024%20+%200.056%7D%7B2%7D%20=%200.2">). These values are the averages of the predictions from the four groups where <code>dark</code> is either Milk or Dark.</p>
<p>Instead of calculating these averages manually (which would also force us to calculate standard errors and p-values manually, which, ugh), we can calculate these aggregate group means with <code>predictions()</code>. To do this, we can feed a little data frame to <code>predictions()</code> with the <code>by</code> argument. The data frame needs to contain columns for the features we want to collapse, and a <code>by</code> column with the labels we want to include in the output. For example, if we want to collapse the eight possible choices into those with milk chocolate and those with dark chocolate, we could create a <code>by</code> data frame like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>))</span>
<span id="cb24-2">by</span>
<span id="cb24-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark   by</span></span>
<span id="cb24-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk Milk</span></span>
<span id="cb24-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark Dark</span></span></code></pre></div>
</div>
<p>If we use that <code>by</code> data frame in <code>predictions()</code>, we get the same 5% and 20% from before, but now with all of {marginaleffects}’s extra features like standard errors and confidence intervals:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb25-2">  model_chocolate_mlogit,</span>
<span id="cb25-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> by</span>
<span id="cb25-4">)</span>
<span id="cb25-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb25-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %   By</span></span>
<span id="cb25-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0.20     0.0316 6.32   &lt;0.001  0.138  0.262 Dark</span></span>
<span id="cb25-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0.05     0.0316 1.58    0.114 -0.012  0.112 Milk</span></span>
<span id="cb25-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb25-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: estimate, std.error, statistic, p.value, conf.low, conf.high, by</span></span></code></pre></div>
</div>
<p>Even better, we can use the <code>hypothesis</code> functionality of <code>predictions()</code> to conduct a hypothesis test and calculate the difference (or contrast) between these two averages, which is <em>exactly what we’re looking for</em> with categorical AMCEs. This shows the average causal effect of moving from milk → dark—holding all other features constant, switching the chocolate type from milk to dark causes a 15 percentage point increase in the probability of selecting the candy, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb26-2">  model_chocolate_mlogit,</span>
<span id="cb26-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> by,</span>
<span id="cb26-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb26-5">)</span>
<span id="cb26-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb26-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb26-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Milk - Dark    -0.15     0.0632 -2.37   0.0177 -0.274 -0.026</span></span>
<span id="cb26-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb26-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can’t simultaneously specify all the contrasts we’re interested in single <code>by</code> argument, but we can do them separately and combine them into a single data frame:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">amces_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb27-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-3">    model_chocolate_mlogit,</span>
<span id="cb27-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>)),</span>
<span id="cb27-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-6">  ),</span>
<span id="cb27-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-8">    model_chocolate_mlogit,</span>
<span id="cb27-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>)),</span>
<span id="cb27-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-11">  ),</span>
<span id="cb27-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-13">    model_chocolate_mlogit,</span>
<span id="cb27-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>)),</span>
<span id="cb27-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-16">  ),</span>
<span id="cb27-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span></span>
<span id="cb27-18">)</span>
<span id="cb27-19">amces_chocolate_mlogit</span>
<span id="cb27-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##            Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb27-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Milk - Dark       -0.15     0.0632 -2.37   0.0177 -0.274 -0.026</span></span>
<span id="cb27-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Soft - Chewy      -0.20     0.0474 -4.22   &lt;0.001 -0.293 -0.107</span></span>
<span id="cb27-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Nuts - No nuts     0.10     0.0725  1.38   0.1675 -0.042  0.242</span></span>
<span id="cb27-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: variable, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
</section>
<section id="plots-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="plots-1">Plots</h3>
<p>Plotting these AMCEs requires a bit of data wrangling, but we get really neat plots, so it’s worth it. I’ve hidden all the code here for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">chocolate_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb28-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"soft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuts"</span>)</span>
<span id="cb28-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb28-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate[[.x]]</span>
<span id="cb28-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb28-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb28-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb28-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb28-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb28-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb28-12">    }</span>
<span id="cb28-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb28-16"></span>
<span id="cb28-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb28-18">chocolate_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb28-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb28-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Type of chocolate"</span>,</span>
<span id="cb28-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"soft"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Type of center"</span>,</span>
<span id="cb28-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuts"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span></span>
<span id="cb28-23">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">amces_chocolate_mlogit_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb29-3">    term,</span>
<span id="cb29-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb29-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb29-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> variable)</span>
<span id="cb29-8"></span>
<span id="cb29-9">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb29-11">    amces_chocolate_mlogit_split,</span>
<span id="cb29-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb29-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb29-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb29-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb29-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb29-18">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb29-19">    )</span>
<span id="cb29-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(chocolate_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb29-23"></span>
<span id="cb29-24">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb29-25">  plot_data,</span>
<span id="cb29-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb29-27">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb29-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of candy selection"</span>,</span>
<span id="cb29-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb29-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb29-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with posterior draws and make {brms} plot</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is much easier than the mlogit mess because we can use avg_comparisons() directly</span></span>
<span id="cb30-2">posterior_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>() </span>
<span id="cb30-5"></span>
<span id="cb30-6">posterior_mfx_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb30-8">    contrast,</span>
<span id="cb30-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb30-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb30-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with model results</span></span>
<span id="cb30-16">plot_data_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb30-18">    posterior_mfx_nested,</span>
<span id="cb30-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb30-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">draw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(chocolate_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb30-25"></span>
<span id="cb30-26">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data_bayes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb30-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb30-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of candy selection"</span>,</span>
<span id="cb30-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb30-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb30-37">  )</span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p2</span></code></pre></div>
<div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-chocolate-both-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section>
</section>
</section>
<section id="part-2-minivans-repeated-questions-basic-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 2: Minivans; repeated questions; basic multinomial logit</h1>
<section id="the-setup-1" class="level2">
<h2 class="anchored" data-anchor-id="the-setup-1">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these minivans they’d want to buy, based on four different features/attributes with different levels:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Passengers</td>
<td style="text-align: left;">6, 7, 8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cargo area</td>
<td style="text-align: left;">2 feet, 3 feet</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Engine</td>
<td style="text-align: left;">Gas, electric, hybrid</td>
</tr>
<tr class="even">
<td style="text-align: left;">Price</td>
<td style="text-align: left;">$30,000; $35,000; $40,000</td>
</tr>
</tbody>
</table>
<p>Respondents see this a question similar to this fifteen different times, with three options with randomly shuffled levels for each of the features.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">Option 1</th>
<th style="text-align: center;">Option 2</th>
<th style="text-align: center;">Option 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Passengers</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">6</td>
</tr>
<tr class="even">
<td>Cargo area</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">2 feet</td>
</tr>
<tr class="odd">
<td>Engine</td>
<td style="text-align: center;">Electric</td>
<td style="text-align: center;">Gas</td>
<td style="text-align: center;">Hybrid</td>
</tr>
<tr class="even">
<td>Price</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$30,000</td>
</tr>
<tr class="odd">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="the-data-1" class="level2">
<h2 class="anchored" data-anchor-id="the-data-1">The data</h2>
<p>The data for this kind of experiment has one row for each possible alternative (<code>alt</code>) within each set of 15 questions (<code>ques</code>), thus creating 3 × 15 = 45 rows per respondent (<code>resp.id</code>). There were 200 respondents, with 45 rows each, so there are 200 × 45 = 9,000 rows. Here, Respondent 1 chose a $30,000 gas van with 6 seats and 3 feet of cargo space in the first set of three options, a $35,000 gas van with 7 seats and 3 feet of cargo space in the second set of three options, and so on.</p>
<p>There’s also a column here for <code>carpool</code> indicating if the respondent carpools with others when commuting. It’s an individual respondent-level characteristic and is constant throughout all the questions and alternatives, and we’ll use it later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">minivans</span>
<span id="cb32-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 9</span></span>
<span id="cb32-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt carpool seat  cargo eng   price choice</span></span>
<span id="cb32-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb32-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 yes     6     2ft   gas   35         0</span></span>
<span id="cb32-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 yes     8     3ft   hyb   30         0</span></span>
<span id="cb32-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 yes     6     3ft   gas   30         1</span></span>
<span id="cb32-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 yes     6     2ft   gas   30         0</span></span>
<span id="cb32-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 yes     7     3ft   gas   35         1</span></span>
<span id="cb32-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 yes     6     2ft   elec  35         0</span></span>
<span id="cb32-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 yes     8     3ft   gas   35         1</span></span>
<span id="cb32-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 yes     7     3ft   elec  30         0</span></span>
<span id="cb32-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 yes     8     2ft   elec  40         0</span></span>
<span id="cb32-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 yes     7     3ft   elec  40         1</span></span>
<span id="cb32-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span></code></pre></div>
</div>
</section>
<section id="the-model-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-model-1">The model</h2>
<p>Respondents were shown three different options and asked to select one. We thus have three possible outcomes: a respondent could have selected option 1, option 2, or option 3. Because everything was randomized, there shouldn’t be any patterns in which options people choose—we don’t want to see that the first column is more common, since that would indicate that respondents are just repeatedly selecting the first column to get through the survey. Since there are three possible outcomes (option 1, 2, and 3), we’ll use multinomial logistic regression.</p>
<section id="original-model-as-a-baseline" class="level3">
<h3 class="anchored" data-anchor-id="original-model-as-a-baseline">Original model as a baseline</h3>
<p>In the example in their textbook, <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> use {mlogit} to estimate this model and they find these results. This will be our baseline throughout this example.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/img/chapman-feit-mlogit.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Original results from <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> p.&nbsp;371</figcaption>
</figure>
</div>
</section>
<section id="mlogit-model-1" class="level3">
<h3 class="anchored" data-anchor-id="mlogit-model-1"><code>mlogit</code> model</h3>
<p>This data is a little more complex now, since there are alternatives nested inside questions inside respondents. To account for this panel structure when using {mlogit}, we need to define two index columns: one for the unique set of alternatives offered to the respondent and one for the respondent ID. We still do this with <code>dfidx()</code>, but need to create a new column with an ID number for each unique combination of respondent ID and question number:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">minivans_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mlogit() needs a column with unique question id numbers</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp.id, ques) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice.id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cur_group_id</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make indexed data frame for mlogit</span></span>
<span id="cb33-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dfidx</span>(</span>
<span id="cb33-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice.id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resp.id"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alt"</span>),</span>
<span id="cb33-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice"</span>,</span>
<span id="cb33-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span></span>
<span id="cb33-11">  )</span></code></pre></div>
</div>
<p>Now we can fit the model. Note the <code>0 ~ seat</code> syntax here. That suppresses the intercept for the model, which behaves weirdly with multinomial models. Since there are three categories for the outcome (options 1, 2, and 3), there are two intercepts, representing cutpoints-from-ordered-logit-esque shifts in the probability of selecting option 1 vs.&nbsp;option 2 and option 2 vs.&nbsp;option 3. We don’t want to deal with those, so we’ll suppress them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">model_minivans_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb34-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb34-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_idx</span>
<span id="cb34-4">)</span>
<span id="cb34-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_minivans_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb34-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Odds |     SE |         95% CI |        z |           p</span></span>
<span id="cb34-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------------</span></span>
<span id="cb34-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## seat [7]    |  -0.5353 | 0.0624 | [-0.66, -0.41] |  -8.5837 | 9.1863e-18 </span></span>
<span id="cb34-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## seat [8]    |  -0.3058 | 0.0611 | [-0.43, -0.19] |  -5.0032 | 5.6376e-07 </span></span>
<span id="cb34-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## cargo [3ft] |   0.4774 | 0.0509 | [ 0.38,  0.58] |   9.3824 | 6.4514e-21 </span></span>
<span id="cb34-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## eng [hyb]   |  -0.8113 | 0.0601 | [-0.93, -0.69] | -13.4921 | 1.7408e-41 </span></span>
<span id="cb34-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## eng [elec]  |  -1.5308 | 0.0675 | [-1.66, -1.40] | -22.6926 | 5.3004e-114</span></span>
<span id="cb34-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## price [35]  |  -0.9137 | 0.0606 | [-1.03, -0.79] | -15.0765 | 2.3123e-51 </span></span>
<span id="cb34-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## price [40]  |  -1.7259 | 0.0696 | [-1.86, -1.59] | -24.7856 | 1.2829e-135</span></span></code></pre></div>
</div>
<p>These are the same results from p.&nbsp;371 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span>, so it worked. Again, the marketing world doesn’t typically do much with these coefficients beyond looking at their direction and magnitude. For instance, in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> they say that the estimate for <code>seat [7]</code> here is negative, which means that a 7-seat option is less preferred than 6-seat option, and that the estimate for <code>price [40]</code> is more negative than the already-negative estimate for <code>price [35]</code>, which means that (1) respondents don’t like the $35,000 option compared to the baseline $30,000 and that (2) respondents <em>really</em> don’t like the $40,000 option. We could theoretically exponentiate these things—like, seeing 7 seats makes it <img src="https://latex.codecogs.com/png.latex?e%5E%7B-0.5353%7D"> = 0.5855 = 41% less likely to select the option compared to 6 seats—but again, that’s weird.</p>
</section>
<section id="bayesian-model-with-brms" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="bayesian-model-with-brms">Bayesian model with {brms}</h3>
<p>We can also fit this multinomial model in a Bayesian way using {brms}. Stan has a categorical family for dealing with mulitnomial/categorical outcomes. But first, we’ll look at the nested structure of this data and incorporate that into the model, since we won’t be using the weird {mlogit}-style indexed data frame. As with the chocolate experiment, the data has a natural hierarchy in it, with three questions nested inside 15 separate question sets, nested inside each of the 200 respondents.</p>
<div class="cell page-columns page-full" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display column-page">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/minivan-multilevel-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with minivan choices <img src="https://latex.codecogs.com/png.latex?%5C%7By_1,%20y_2,%20y_3%5C%7D"> nested in sets of questions in respondents</figcaption>
</figure>
</div>
</div>
</div>
<p>Currently, our main outcome variable <code>choice</code> is binary. If we run the model with <code>choice</code> as the outcome with a categorical family, the model will fit, but it will go slow and {brms} will complain about it and recommend switching to regular logistic regression. The categorical family in Stan requires 2+ outcomes and a reference category. Here we have three possible options (1, 2, and 3), and we can imagine a reference category of 0 for rows that weren’t selected.</p>
<p>We can create a new outcome column (<code>choice_alt</code>) that indicates which option each respondent selected: 0 if they didn’t choose the option and 1–3 if they chose the first, second, or third option. Because of how the data is recorded, this only requires multiplying <code>alt</code> and <code>choice</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">minivans_choice_alt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice_alt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> choice))</span>
<span id="cb35-3"></span>
<span id="cb35-4">minivans_choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(resp.id, ques, alt, seat, cargo, eng, price, choice, choice_alt)</span>
<span id="cb35-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 9</span></span>
<span id="cb35-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt seat  cargo eng   price choice choice_alt</span></span>
<span id="cb35-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;fct&gt;     </span></span>
<span id="cb35-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 6     2ft   gas   35         0 0         </span></span>
<span id="cb35-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 8     3ft   hyb   30         0 0         </span></span>
<span id="cb35-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 6     3ft   gas   30         1 3         </span></span>
<span id="cb35-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 6     2ft   gas   30         0 0         </span></span>
<span id="cb35-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 7     3ft   gas   35         1 2         </span></span>
<span id="cb35-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 6     2ft   elec  35         0 0         </span></span>
<span id="cb35-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 8     3ft   gas   35         1 1         </span></span>
<span id="cb35-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 7     3ft   elec  30         0 0         </span></span>
<span id="cb35-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 8     2ft   elec  40         0 0         </span></span>
<span id="cb35-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 7     3ft   elec  40         1 1         </span></span>
<span id="cb35-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span></code></pre></div>
</div>
<p>We can now use the new four-category <code>choice_alt</code> column as our outcome with the <code>categorical()</code> family.</p>
<p>If we <em>realllly</em> wanted, we could add random effects for question sets nested inside respondents, like <code>(1 | resp.id / ques)</code>. We’d want to do that if there were set-specific things that could influences choices. Like maybe we want to account for the possibility that everyone’s just choosing the first option, so it behaves differently? Or maybe the 5th set of questions is set to an extra difficult level on a quiz or something? Or maybe we have so many sets that we think the later ones will be less accurate because of respondent fatigue? idk. In this case, question set-specific effects don’t matter at all. Each question set is equally randomized and no different from the others, so we won’t bother modeling that layer of the hierarchy.</p>
<p>We want to model the choice of option 1, 2, or 3 (<code>choice_alt</code>) based on minivan characteristics (<code>seat</code>, <code>cargo</code>, <code>eng</code>, price). With the categorical model, we actually get a set of parameters to estimate the probability of selecting each of the options, which Stan calls <img src="https://latex.codecogs.com/png.latex?%5Cmu">, so we have a set of three probabilities: <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmu_1,%20%5Cmu_2,%20%5Cmu_3%5C%7D">. We’ll use the subscript <img src="https://latex.codecogs.com/png.latex?i"> to refer to individual minivan choices and <img src="https://latex.codecogs.com/png.latex?j"> to refer to respondents. Here’s the fun formal model:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20(%5Cbeta_0%20+%20b_%7B0_j%7D)%20+%20%5Cbeta_1%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_2%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_3%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_4%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_5%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_6%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_7%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B5pt%5D%0Ab_%7B0_j%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%5Cqquad%5Cquad%5Cquad%20%5Ctext%7BRespondent-specific%20offsets%20from%20global%20probability%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_%7B0%20%5Cdots%207%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5C%20%5Ctext%7BPrior%20for%20choice-level%20coefficients%7D%20%5C%5C%0A%5Csigma_0%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cquad%20%5Ctext%7BPrior%20for%20between-respondent%20variability%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>And here’s the {brms} model. Notice the much-more-verbose prior section—because the categorical family in Stan estimates separate parameters for each of the categories (<img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmu_1,%20%5Cmu_2,%20%5Cmu_3%5C%7D">), we have a mean and standard deviation for the probability of selecting each of those options. We need to specify each of these separately too instead of just doing something like <code>prior(normal(0, 3), class = b)</code>. Also notice the <code>refcat</code> argument in <code>categorical()</code>—this makes it so that all the estimates are relative to not choosing an option (or when <code>choice_alt</code> is 0). And <em>also</em> notice the slightly different syntax for the random respondent intercepts: <code>(1 | ID | resp.id)</code>. That new middle <code>ID</code> is special {brms} formula syntax that we can use when working with categorical or ordinal families, and it makes it so that the group-level effects for the different outcomes (here options 0, 1, 2, and 3) are correlated (see p.&nbsp;4 of <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">this {brms} vignette</a> for more about this special syntax).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">model_minivans_categorical_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id)),</span>
<span id="cb36-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_choice_alt,</span>
<span id="cb36-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refcat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>),</span>
<span id="cb36-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb36-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb36-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb36-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb36-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb36-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb36-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3)</span>
<span id="cb36-12">  ),</span>
<span id="cb36-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb36-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb36-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_minivans_categorical_brms"</span></span>
<span id="cb36-16">)</span></code></pre></div>
</div>
<p>This model gives us a ton of parameters! We get three estimates per feature level (i.e.&nbsp;<code>mu1_cargo3ft</code>, <code>mu2_cargo3ft</code>, and <code>mu3_cargo3ft</code> for the <code>cargo3ft</code> effect), since we’re actually estimating the effect of each covariate on the probability of selecting each of the three options.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_minivans_categorical_brms)</span>
<span id="cb37-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter    | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span id="cb37-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -----------------------------------------------------------------</span></span>
<span id="cb37-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat6    |  -0.34 | [-0.52, -0.16] | 99.95% | 1.001 | 2673.00</span></span>
<span id="cb37-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat7    |  -0.86 | [-1.04, -0.67] |   100% | 1.000 | 3167.00</span></span>
<span id="cb37-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat8    |  -0.59 | [-0.77, -0.41] |   100% | 1.000 | 3373.00</span></span>
<span id="cb37-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_cargo3ft |   0.46 | [ 0.32,  0.60] |   100% | 1.000 | 6314.00</span></span>
<span id="cb37-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_enghyb   |  -0.76 | [-0.92, -0.60] |   100% | 1.001 | 4628.00</span></span>
<span id="cb37-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_engelec  |  -1.51 | [-1.69, -1.33] |   100% | 0.999 | 4913.00</span></span>
<span id="cb37-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_price35  |  -0.82 | [-0.99, -0.67] |   100% | 0.999 | 4574.00</span></span>
<span id="cb37-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_price40  |  -1.74 | [-1.94, -1.56] |   100% | 1.000 | 4637.00</span></span>
<span id="cb37-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat6    |  -0.39 | [-0.57, -0.20] |   100% | 1.000 | 2387.00</span></span>
<span id="cb37-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat7    |  -0.95 | [-1.15, -0.77] |   100% | 1.001 | 2470.00</span></span>
<span id="cb37-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat8    |  -0.67 | [-0.85, -0.49] |   100% | 1.001 | 2489.00</span></span>
<span id="cb37-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_cargo3ft |   0.49 | [ 0.35,  0.63] |   100% | 1.000 | 4836.00</span></span>
<span id="cb37-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_enghyb   |  -0.79 | [-0.95, -0.63] |   100% | 1.000 | 4421.00</span></span>
<span id="cb37-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_engelec  |  -1.40 | [-1.57, -1.22] |   100% | 1.000 | 4261.00</span></span>
<span id="cb37-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_price35  |  -0.79 | [-0.95, -0.63] |   100% | 1.001 | 3699.00</span></span>
<span id="cb37-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_price40  |  -1.47 | [-1.65, -1.29] |   100% | 0.999 | 3978.00</span></span>
<span id="cb37-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat6    |  -0.28 | [-0.46, -0.11] | 99.85% | 1.000 | 2077.00</span></span>
<span id="cb37-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat7    |  -0.78 | [-0.96, -0.60] |   100% | 1.000 | 3025.00</span></span>
<span id="cb37-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat8    |  -0.63 | [-0.81, -0.46] |   100% | 1.000 | 2483.00</span></span>
<span id="cb37-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_cargo3ft |   0.36 | [ 0.23,  0.50] |   100% | 0.999 | 5327.00</span></span>
<span id="cb37-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_enghyb   |  -0.73 | [-0.88, -0.58] |   100% | 1.000 | 4039.00</span></span>
<span id="cb37-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_engelec  |  -1.41 | [-1.59, -1.23] |   100% | 1.001 | 3818.00</span></span>
<span id="cb37-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_price35  |  -0.85 | [-1.01, -0.69] |   100% | 1.000 | 4315.00</span></span>
<span id="cb37-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_price40  |  -1.56 | [-1.75, -1.39] |   100% | 0.999 | 4774.00</span></span></code></pre></div>
</div>
<p>Importantly, the estimates here are all roughly equivalent to what we get from {mlogit}: the {mlogit} estimate for <code>cargo3ft</code> was 0.4775, while the three median posterior {brms} estimates are 0.46 (95% credible interval: 0.32–0.60), 0.49 (0.35–0.63), and 0.36 (0.23–0.50)</p>
<p>Since all the features are randomly shuffled between the three options each time, and each option is selected 1/3rd of the time, it’s probably maybe legal to pool these posterior estimates together (maaaaybeee???) so that we don’t have to work with three separate estimates for each parameter? To do this we’ll take the average of each of the three <img src="https://latex.codecogs.com/png.latex?%5Cmu"> estimates within each draw, which is also called “marginalizing” across the three options.</p>
<p>Here’s how we’d do that with {tidybayes}. The medians are all roughly the same now!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">minivans_cat_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">^b_.*$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regex =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb38-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb38-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb38-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable name ("seat6")</span></span>
<span id="cb38-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_regex</span>(</span>
<span id="cb38-8">    .variable,</span>
<span id="cb38-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patterns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_mu</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d_"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*"</span>)</span>
<span id="cb38-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb38-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb38-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.value)) </span>
<span id="cb38-15"></span>
<span id="cb38-16">minivans_cat_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>()</span>
<span id="cb38-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 7</span></span>
<span id="cb38-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .variable .value .lower .upper .width .point .interval</span></span>
<span id="cb38-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb38-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 cargo3ft   0.439  0.340  0.532   0.95 median qi       </span></span>
<span id="cb38-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 engelec   -1.44  -1.56  -1.32    0.95 median qi       </span></span>
<span id="cb38-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 enghyb    -0.762 -0.871 -0.651   0.95 median qi       </span></span>
<span id="cb38-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 price35   -0.823 -0.935 -0.713   0.95 median qi       </span></span>
<span id="cb38-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 price40   -1.59  -1.72  -1.47    0.95 median qi       </span></span>
<span id="cb38-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 seat6     -0.337 -0.464 -0.208   0.95 median qi       </span></span>
<span id="cb38-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 seat7     -0.862 -0.994 -0.734   0.95 median qi       </span></span>
<span id="cb38-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 seat8     -0.629 -0.753 -0.503   0.95 median qi</span></span></code></pre></div>
</div>
<p>And for fun, here’s what the posterior for new combined/collapsed/marginalized <code>cargo3ft</code> looks like. Great.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">minivans_cat_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo3ft"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior distribution of β (logit-scale)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-cargo3ft-combined-posterior-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="predictions-1" class="level2">
<h2 class="anchored" data-anchor-id="predictions-1">Predictions</h2>
<p>As we saw in the first example with chocolates, the marketing world typically uses predictions from these kinds of models to estimate the predicted market share for products with different constellations of features. That was a pretty straightforward task with the chocolate model since respondents were shown all 8 options simultaneously. It’s a lot trickier with the minivan example where respondents were shown 15 sets of 3 options. Dealing with multinomial predictions is a bear of a task because these models are a lot more complex.</p>
<section id="frequentist-predictions-1" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-predictions-1">Frequentist predictions</h3>
<p>With the chocolate model, we could just use <code>avg_predictions(model_chocolate_mlogit)</code> and automatically get predictions for all 8 options. That’s not the case here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_predictions</span>(model_minivans_mlogit)</span>
<span id="cb40-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb40-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span id="cb40-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1    0.333   0.000349  955   &lt;0.001 0.332  0.334</span></span>
<span id="cb40-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      2    0.333   0.000145 2291   &lt;0.001 0.333  0.334</span></span>
<span id="cb40-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      3    0.334   0.000376  889   &lt;0.001 0.333  0.335</span></span>
<span id="cb40-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb40-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We get three predictions, and they’re all 33ish%. That’s because respondents were presented with three randomly shuffled options and chose one of them. All these predictions tell us is that across all 15 iterations of the questions, 1/3 of respondents selected the first option, 1/3 the second, and 1/3 the third. That’s a good sign in this case—there’s no evidence that people were just repeatedly choosing the first option. But in the end, these predictions aren’t super useful.</p>
<p>We instead want to be able to get predicted market shares (or predicted probabilities) for any given mix of products. For instance, here are six hypothetical products with different combinations of seats, cargo space, engines, and prices:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">example_product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb41-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>seat, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>cargo, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>eng, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>price,</span>
<span id="cb41-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb41-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb41-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35"</span></span>
<span id="cb41-9">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb41-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), factor)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb41-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)))</span>
<span id="cb41-12">example_product_mix</span>
<span id="cb41-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 4</span></span>
<span id="cb41-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  cargo eng   price</span></span>
<span id="cb41-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span id="cb41-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 7     2ft   hyb   30   </span></span>
<span id="cb41-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 6     2ft   gas   30   </span></span>
<span id="cb41-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 8     2ft   gas   30   </span></span>
<span id="cb41-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7     3ft   gas   40   </span></span>
<span id="cb41-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 6     2ft   elec  40   </span></span>
<span id="cb41-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 7     2ft   hyb   35</span></span></code></pre></div>
</div>
<p>If we were working with any other type of model, we could plug this data into the <code>newdata</code> argument of <code>predictions()</code> and get predicted values. That doesn’t work here though. There were 200 respondents in the original data, and {mlogit}-predictions need to happen on a dataset with a multiple of that many rows. We can’t just feed it 6 values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(model_minivans_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix)</span>
<span id="cb42-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Error: The `newdata` argument for `mlogit` models must be a data frame with a number of rows equal to a multiple of the number of choices: 200.</span></span></code></pre></div>
</div>
<p>Instead, following <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> (and <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335">this Stan forum post</a>), we can manually multiply the covariates in <code>example_product_mix</code> with the model coefficients to calculate “utility” (or predicted vales on the logit scale), which we can then exponentiate and divide to calculate market shares.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Limits of {marginaleffects} and {mlogit}
</div>
</div>
<div class="callout-body-container callout-body">
<p>From what I can tell, this is not possible with {marginaleffects} because that package can’t work with the coefficients from {mlogit} models and can only really work with predictions. {mlogit} predictions are forced to be on the response/probability scale since they’re, like, predictions, so there’s no way to get them on the log/logit link scale to calculate utilities and shares.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a matrix of 0s and 1s for the values in `example_product_mix`, omitting</span></span>
<span id="cb43-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the first column (seat6)</span></span>
<span id="cb43-3">example_product_dummy_encoded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(</span>
<span id="cb43-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>formula, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .),</span>
<span id="cb43-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> example_product_mix</span>
<span id="cb43-6">)[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb43-7">example_product_dummy_encoded</span>
<span id="cb43-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat7 seat8 cargo3ft enghyb engelec price35 price40</span></span>
<span id="cb43-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1     0        0      1       0       0       0</span></span>
<span id="cb43-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     0     0        0      0       0       0       0</span></span>
<span id="cb43-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     0     1        0      0       0       0       0</span></span>
<span id="cb43-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4     1     0        1      0       0       0       1</span></span>
<span id="cb43-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5     0     0        0      0       1       0       1</span></span>
<span id="cb43-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6     1     0        0      1       0       1       0</span></span>
<span id="cb43-15"></span>
<span id="cb43-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the matrix of 0s and 1s with the model coefficients to get</span></span>
<span id="cb43-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logit-scale predictions, or utility</span></span>
<span id="cb43-18">utility <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_product_dummy_encoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_minivans_mlogit)</span>
<span id="cb43-19"></span>
<span id="cb43-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Divide each exponentiated utility by the sum of the exponentiated utilities to</span></span>
<span id="cb43-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the market share</span></span>
<span id="cb43-22">share <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))</span>
<span id="cb43-23"></span>
<span id="cb43-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stick all of these in one final dataset</span></span>
<span id="cb43-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logits =</span> utility, example_product_mix)</span>
<span id="cb43-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 6</span></span>
<span id="cb43-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   share[,1] logits[,1] seat  cargo eng   price</span></span>
<span id="cb43-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span id="cb43-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1    0.113      -1.35  7     2ft   hyb   30   </span></span>
<span id="cb43-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2    0.433       0     6     2ft   gas   30   </span></span>
<span id="cb43-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3    0.319      -0.306 8     2ft   gas   30   </span></span>
<span id="cb43-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4    0.0728     -1.78  7     3ft   gas   40   </span></span>
<span id="cb43-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5    0.0167     -3.26  6     2ft   elec  40   </span></span>
<span id="cb43-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6    0.0452     -2.26  7     2ft   hyb   35</span></span></code></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Function version of this kind of prediction
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>On p.&nbsp;375 of <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> (and at <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335/">this Stan forum post</a>), there’s a function called <code>predict.mnl()</code> that does this utility and share calculation automatically. Because this post is more didactic and because I’m more interested in the Bayesian approach, I didn’t use it earlier, but it works well.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">predict.mnl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(model, data) {</span>
<span id="cb44-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for predicting shares from a multinomial logit model </span></span>
<span id="cb44-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model: mlogit object returned by mlogit()</span></span>
<span id="cb44-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data: a data frame containing the set of designs for which you want to </span></span>
<span id="cb44-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#       predict shares. Same format at the data used to estimate model. </span></span>
<span id="cb44-6">  data.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>formula, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data)[ , <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb44-7">  utility <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef</span>
<span id="cb44-8">  share <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))</span>
<span id="cb44-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(share, data)</span>
<span id="cb44-10">}</span>
<span id="cb44-11"></span>
<span id="cb44-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict.mnl</span>(model_minivans_mlogit, example_product_mix)</span>
<span id="cb44-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     share seat cargo  eng price</span></span>
<span id="cb44-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 0.11273    7   2ft  hyb    30</span></span>
<span id="cb44-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 0.43337    6   2ft  gas    30</span></span>
<span id="cb44-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 0.31918    8   2ft  gas    30</span></span>
<span id="cb44-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 0.07281    7   3ft  gas    40</span></span>
<span id="cb44-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 0.01669    6   2ft elec    40</span></span>
<span id="cb44-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 0.04521    7   2ft  hyb    35</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<p>This new predicted <code>share</code> column sums to one, and it shows us the predicted market share assuming these are the only six products available. The $30,000 six-seater 2ft gas van and the $30,000 eight-seater 2ft gas van would comprise more than 75% (0.43337 + 0.31918) of a market consisting of these six products. Because we did this calculation by hand, we lose all of {marginaleffects}’s extra features like standard errors and hypothesis tests. Alas.</p>
</section>
<section id="bayesian-predictions-1" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-predictions-1">Bayesian predictions</h3>
<p>If we use the categorical multinomial {brms} model we run into the same issue of getting weird predictions. Here it shows that 2/3rds of predictions are 0, which makes sense—if a respondent is offered 10 iterations of 3 possible choices, that would be 30 total choices, but they can only choose one option per iteration, so 20 choices (or 20/30 or 2/3) wouldn’t be selected. The other three groups are each 11%, since that’s the remaining 33% divided evenly across three options. Neat, I guess, but still not super helpful.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/show-brms-categorical-predictions-wrong_ec72a368432ec4df0fba88419083c3cf">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_predictions</span>(model_minivans_categorical_brms)</span>
<span id="cb45-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Estimate 2.5 % 97.5 %</span></span>
<span id="cb45-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0    0.667 0.657  0.676</span></span>
<span id="cb45-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1    0.109 0.103  0.115</span></span>
<span id="cb45-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      2    0.112 0.105  0.118</span></span>
<span id="cb45-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      3    0.113 0.106  0.119</span></span>
<span id="cb45-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, estimate, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>Instead of going through the manual process of matrix-multiplying a dataset of some mix of products with a single set of coefficients, we can use <code>predictions(..., type = "link")</code> to get predicted values on the log-odds scale, or that utility value that we found before.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>marginaleffects::predictions()</code> vs.&nbsp;{tidybayes} functions
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can actually use either <code>marginaleffects::predictions()</code> or {tidybayes}’s <code>*_draw()</code> functions for these posterior predictions. They do the same thing, with slightly different syntax:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Logit-scale predictions with marginaleffects::predictions()</span></span>
<span id="cb46-2">model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>()</span>
<span id="cb46-5"></span>
<span id="cb46-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Logit-scale predictions with tidybayes::add_linpred_draws()</span></span>
<span id="cb46-7">model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
</div>
<p>Earlier in the chocolate example, I used <code>marginaleffects::predictions()</code> with the Bayesian {brms} model. Here I’m going to switch to the {tidybayes} prediction functions instead, in part because these multinomial models with the <code>categorical()</code> family are a lot more complex (though {marginaleffects} can handle them nicely), but mostly because in the actual paper I’m working on with real conjoint data, our MCMC results were generated with raw Stan code through <code>rstan</code>, and {marginaleffects} doesn’t support raw Stan models.</p>
<p><a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">Check out this guide</a> for the differences between {tidybayes}’s three general prediction functions: <code>predicted_draws()</code>, <code>epred_draws()</code>, and <code>linpred_draws()</code>.</p>
</div>
</div>
<p>Additionally, we now actually have 4,000 draws in 3 categories (option 1, option 2, and option 3), so we actually have 12,000 sets of coefficients (!). To take advantage of the full posterior distribution of these coefficients, we can calculate shares within each set of draws within each of the three categories, resulting in a distribution of shares rather than single values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_product_mix <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(model_minivans_categorical_brms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb47-3"></span>
<span id="cb47-4">shares_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb47-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># three outcomes</span></span>
<span id="cb47-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb47-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb47-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(mix_type, share)</span>
<span id="cb47-13">  )</span></code></pre></div>
</div>
<p>We can summarize this huge dataset of posterior shares to get medians and credible intervals, but we need to do one extra step first. Right now, we have three predictions for each mix type, one for each of the categories (i.e.&nbsp;option 1, option 2, and option 3.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, .category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb48-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 18 × 8</span></span>
<span id="cb48-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    mix_type      .category  share .lower .upper .width .point .interval</span></span>
<span id="cb48-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;         &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb48-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6 2ft elec 40 1         0.0161 0.0123 0.0208   0.95 median qi       </span></span>
<span id="cb48-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6 2ft elec 40 2         0.0238 0.0183 0.0302   0.95 median qi       </span></span>
<span id="cb48-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6 2ft elec 40 3         0.0216 0.0168 0.0275   0.95 median qi       </span></span>
<span id="cb48-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 7 2ft hyb 35  1         0.0513 0.0400 0.0647   0.95 median qi       </span></span>
<span id="cb48-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 7 2ft hyb 35  2         0.0485 0.0379 0.0605   0.95 median qi       </span></span>
<span id="cb48-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 7 2ft hyb 35  3         0.0532 0.0424 0.0660   0.95 median qi       </span></span>
<span id="cb48-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 7 3ft gas 40  1         0.0693 0.0543 0.0876   0.95 median qi       </span></span>
<span id="cb48-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 7 3ft gas 40  2         0.0891 0.0705 0.111    0.95 median qi       </span></span>
<span id="cb48-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 7 3ft gas 40  3         0.0775 0.0615 0.0967   0.95 median qi       </span></span>
<span id="cb48-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 7 2ft hyb 30  1         0.117  0.0976 0.139    0.95 median qi       </span></span>
<span id="cb48-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 7 2ft hyb 30  2         0.107  0.0891 0.128    0.95 median qi       </span></span>
<span id="cb48-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 7 2ft hyb 30  3         0.124  0.104  0.146    0.95 median qi       </span></span>
<span id="cb48-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 8 2ft gas 30  1         0.326  0.292  0.363    0.95 median qi       </span></span>
<span id="cb48-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 8 2ft gas 30  2         0.314  0.282  0.348    0.95 median qi       </span></span>
<span id="cb48-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 8 2ft gas 30  3         0.299  0.267  0.331    0.95 median qi       </span></span>
<span id="cb48-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 16 6 2ft gas 30  1         0.418  0.380  0.457    0.95 median qi       </span></span>
<span id="cb48-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 17 6 2ft gas 30  2         0.416  0.379  0.454    0.95 median qi       </span></span>
<span id="cb48-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 18 6 2ft gas 30  3         0.423  0.387  0.462    0.95 median qi</span></span></code></pre></div>
</div>
<p>Since those options were all randomized, we can lump them all together as a single choice. To do this we’ll take the average share across the three categories (this is also called “marginalizing”) within each posterior draw.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1">shares_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across categories within each draw</span></span>
<span id="cb49-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb49-6"></span>
<span id="cb49-7">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb49-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 7</span></span>
<span id="cb49-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   mix_type       share .lower .upper .width .point .interval</span></span>
<span id="cb49-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb49-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6 2ft elec 40 0.0206 0.0173 0.0242   0.95 median qi       </span></span>
<span id="cb49-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 7 2ft hyb 35  0.0512 0.0435 0.0600   0.95 median qi       </span></span>
<span id="cb49-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 7 3ft gas 40  0.0788 0.0673 0.0915   0.95 median qi       </span></span>
<span id="cb49-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7 2ft hyb 30  0.116  0.103  0.131    0.95 median qi       </span></span>
<span id="cb49-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 8 2ft gas 30  0.313  0.291  0.337    0.95 median qi       </span></span>
<span id="cb49-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 6 2ft gas 30  0.419  0.394  0.446    0.95 median qi</span></span></code></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb50-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xy"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hypothetical product mix"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-brms-categorical-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is great because (1) it includes the uncertainty in the estimated shares, and (2) it lets us do neat Bayesian inference and say things like “there’s a 93% chance that in this market of 6 options, a $30,000 6-passenger gas minivan with 2 feet of storage would reach at least 40% market share”:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mix_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6 2ft gas 30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop_greater_40 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(share <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb51-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 1</span></span>
<span id="cb51-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   prop_greater_40</span></span>
<span id="cb51-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##             &lt;dbl&gt;</span></span>
<span id="cb51-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1           0.931</span></span>
<span id="cb51-8"></span>
<span id="cb51-9">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mix_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6 2ft gas 30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_ramp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">after_stat</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_ramp_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-pd-example-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="amces-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="amces-1">AMCEs</h2>
<p>As explained in the AMCEs section for the chocolate data, in the social sciences we’re less concerned about predicted market shares and more concerned about causal effects. Holding all other features constant, what is the effect of a $5,000 increase in price or moving from 2 feet → 3 feet of storage space on the probability (or favorability) of selecting a minivan?</p>
<p>In the chocolate example, we were able to use <code>marginaleffects::avg_comparisons()</code> with the Bayesian model and get categorical contrasts automatically. This was because we cheated and used a Poisson model, since those can secretly behave like multinomial models. For the frequentist {mlogit}-based model, we had to use <code>marginaleffects::predictions()</code> instead and specify a special <code>by</code> argument to collapse the predictions into the different contrasts we were interested in.</p>
<p>In this case, since both the frequentist and Bayesian models for minivans are true multinomial models, we have to return to <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html#multinomial-models">{marginaleffects}’s special syntax</a> that lets us pass a data frame as the <code>by</code> argument.</p>
<section id="frequentist-comparisonscontrasts-1" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts-1">Frequentist comparisons/contrasts</h3>
<p>To help with the intuition behind this, since it’s more complex this time, we’ll first create a data frame with all 54 combinations of all the feature levels (3 seats × 2 cargos × 3 engines × 3 prices) and create a <code>by</code> column label that concatenates all the labels together so there’s a single unique label for each row:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">by_all_combos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb52-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb52-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>))</span>
<span id="cb52-4">by_all_combos</span>
<span id="cb52-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 5</span></span>
<span id="cb52-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price by           </span></span>
<span id="cb52-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;chr&gt;        </span></span>
<span id="cb52-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    6_2ft_gas_30 </span></span>
<span id="cb52-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   35    6_2ft_gas_35 </span></span>
<span id="cb52-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   40    6_2ft_gas_40 </span></span>
<span id="cb52-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   hyb   30    6_2ft_hyb_30 </span></span>
<span id="cb52-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   hyb   35    6_2ft_hyb_35 </span></span>
<span id="cb52-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   hyb   40    6_2ft_hyb_40 </span></span>
<span id="cb52-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   elec  30    6_2ft_elec_30</span></span>
<span id="cb52-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   elec  35    6_2ft_elec_35</span></span>
<span id="cb52-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   elec  40    6_2ft_elec_40</span></span>
<span id="cb52-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     3ft   gas   30    6_3ft_gas_30 </span></span>
<span id="cb52-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>We can then feed this <code>by_all_combos</code> data frame into <code>predictions()</code>, which will generate predictions for all these levels <em>collapsed by all three of the possible groups</em> (i.e.&nbsp;option 1, option 2, and option 3). We can then split the <code>by</code> column back into separate columns for each of the feature levels so that we have those original columns back.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">all_preds_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb53-2">  model_minivans_mlogit,</span>
<span id="cb53-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions.mlogit() weirdly gets mad when working with tibbles :shrug:</span></span>
<span id="cb53-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(by_all_combos)</span>
<span id="cb53-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb53-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split the `by` column up into separate columns</span></span>
<span id="cb53-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate</span>(by, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">into =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>))</span>
<span id="cb53-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(all_preds_mlogit)</span>
<span id="cb53-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 10</span></span>
<span id="cb53-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    estimate std.error statistic   p.value conf.low conf.high seat  cargo eng   price</span></span>
<span id="cb53-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span id="cb53-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1   0.348    0.0135       25.8 1.89e-146   0.321     0.374  6     2ft   elec  30   </span></span>
<span id="cb53-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2   0.173    0.00907      19.0 7.82e- 81   0.155     0.190  6     2ft   elec  35   </span></span>
<span id="cb53-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3   0.0872   0.00565      15.4 1.04e- 53   0.0761    0.0983 6     2ft   elec  40   </span></span>
<span id="cb53-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4   0.695    0.0122       57.0 0           0.671     0.719  6     2ft   gas   30   </span></span>
<span id="cb53-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5   0.491    0.0147       33.3 1.08e-243   0.462     0.520  6     2ft   gas   35   </span></span>
<span id="cb53-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6   0.311    0.0130       23.8 1.40e-125   0.285     0.336  6     2ft   gas   40   </span></span>
<span id="cb53-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7   0.499    0.0138       36.3 3.76e-288   0.472     0.526  6     2ft   hyb   30   </span></span>
<span id="cb53-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8   0.300    0.0126       23.8 8.97e-125   0.275     0.324  6     2ft   hyb   35   </span></span>
<span id="cb53-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9   0.161    0.00952      16.9 3.90e- 64   0.142     0.180  6     2ft   hyb   40   </span></span>
<span id="cb53-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10   0.430    0.0147       29.2 2.13e-187   0.402     0.459  6     3ft   elec  30   </span></span>
<span id="cb53-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>There are a lot of predicted probabilities here, so we need to collapse and average these by groups to make any sense of them. For instance, suppose we’re interested in the AMCE of cargo space. We can first find the average predicted probability of selection with some grouping and summarizing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">manual_cargo_example <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(estimate))</span>
<span id="cb54-4">manual_cargo_example</span>
<span id="cb54-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb54-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo avg_pred</span></span>
<span id="cb54-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span id="cb54-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft      0.292</span></span>
<span id="cb54-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft      0.375</span></span>
<span id="cb54-10"></span>
<span id="cb54-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(manual_cargo_example<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>avg_pred)</span>
<span id="cb54-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.08326</span></span></code></pre></div>
</div>
<p>Holding all other features constant, the average probability (or average favorability, or average market share, or whatever we want to call it) of selecting a minivan with 2 feet of storage space is 0.292 (this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>2ft</code>); the average probability for a minivan with 3 feet of storage space is 0.375 (again, this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>3ft</code>). There’s an 8.3 percentage point difference between these groups. <strong>This is the causal effect or AMCE</strong>: switching from 2 feet to 3 feet increases minivan favorability by 8 percentage points on average.</p>
<p>This manual calculation works, but it’s tedious and doesn’t include anything about standard errors. So instead, we can do it automatically with <code>predictions(..., by = data.frame(...))</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1">preds_minivan_cargo_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb55-2">  model_minivans_mlogit, </span>
<span id="cb55-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb55-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo),</span>
<span id="cb55-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo)</span>
<span id="cb55-6">  )</span>
<span id="cb55-7">)</span>
<span id="cb55-8">preds_minivan_cargo_mlogit</span>
<span id="cb55-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb55-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %  By</span></span>
<span id="cb55-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     0.291    0.00440 66.2   &lt;0.001 0.283  0.300 2ft</span></span>
<span id="cb55-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     0.375    0.00441 85.2   &lt;0.001 0.367  0.384 3ft</span></span>
<span id="cb55-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb55-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: estimate, std.error, statistic, p.value, conf.low, conf.high, by</span></span></code></pre></div>
</div>
<p>And if we use the <code>hypothesis</code> argument (or the standalone <code>hypotheses()</code> function), we can get the difference between these average predictions, or the AMCE we care about—moving from 2 feet → 3 feet causes an 8 percentage point increase in favorability.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_cargo_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span>)</span>
<span id="cb56-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb56-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       Term Estimate Std. Error   z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb56-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3ft - 2ft   0.0837    0.00881 9.5   &lt;0.001 0.0664  0.101</span></span>
<span id="cb56-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb56-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>The <code>hypothesis</code> functionality works with more than 2 levels too. If calculate average predictions for the 3 seat configurations and specify <code>pariwise</code> or <code>revpairwise</code>, {marginaleffects} will give three differences: row 2 − row 1; row 3 − row 1; and row 3 − row 2. If we specify <code>reference</code> or <code>revreference</code>, it’ll only give two, all based on the first row.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">preds_minivan_seat_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb57-2">  model_minivans_mlogit, </span>
<span id="cb57-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb57-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat),</span>
<span id="cb57-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat)</span>
<span id="cb57-6">  )</span>
<span id="cb57-7">)</span>
<span id="cb57-8"></span>
<span id="cb57-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span>)</span>
<span id="cb57-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb57-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6  -0.0996     0.0107 -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb57-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6  -0.0557     0.0109 -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb57-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 7   0.0439     0.0106  4.13   &lt;0.001  0.0230  0.0647</span></span>
<span id="cb57-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span id="cb57-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>)</span>
<span id="cb57-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb57-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6  -0.0996     0.0107 -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb57-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6  -0.0557     0.0109 -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb57-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can specify any other comparisons with <code>bN</code>, where <code>N</code> stands for the row number from <code>predictions()</code>. For instance, if we just want the difference between 6 (row 1) and 8 (row 2), we can do this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b2 = b1"</span>)</span>
<span id="cb58-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb58-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span id="cb58-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  b2=b1  -0.0996     0.0107 -9.29   &lt;0.001 -0.121 -0.0786</span></span>
<span id="cb58-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb58-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can make a big data frame with all the AMCEs we’re interested in. I’ve hidden the code here because it’s really repetitive.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Make separate datasets of predictions and combine them in one data frame</summary>
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1">preds_minivan_seat_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-2">  model_minivans_mlogit, </span>
<span id="cb59-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat),</span>
<span id="cb59-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat)</span>
<span id="cb59-6">  )</span>
<span id="cb59-7">)</span>
<span id="cb59-8"></span>
<span id="cb59-9">preds_minivan_cargo_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-10">  model_minivans_mlogit, </span>
<span id="cb59-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo),</span>
<span id="cb59-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo)</span>
<span id="cb59-14">  )</span>
<span id="cb59-15">)</span>
<span id="cb59-16"></span>
<span id="cb59-17">preds_minivan_eng_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-18">  model_minivans_mlogit, </span>
<span id="cb59-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng),</span>
<span id="cb59-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)</span>
<span id="cb59-22">  )</span>
<span id="cb59-23">)</span>
<span id="cb59-24"></span>
<span id="cb59-25">preds_minivan_price_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-26">  model_minivans_mlogit, </span>
<span id="cb59-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price),</span>
<span id="cb59-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price)</span>
<span id="cb59-30">  )</span>
<span id="cb59-31">)</span>
<span id="cb59-32"></span>
<span id="cb59-33">amces_minivan_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb59-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_cargo_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_eng_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-37">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Need to specify these two tests manually because `hypotheses()` reeeeallly</span></span>
<span id="cb59-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># wants to use 35 as the reference level because it's the first value that</span></span>
<span id="cb59-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># appears in the original data. See</span></span>
<span id="cb59-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://github.com/vincentarelbundock/marginaleffects/issues/861</span></span>
<span id="cb59-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb59-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_price_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b1 = b2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35 - 30"</span>),</span>
<span id="cb59-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_price_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b3 = b2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40 - 30"</span>)</span>
<span id="cb59-44">  ),</span>
<span id="cb59-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span></span>
<span id="cb59-46">)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1">amces_minivan_mlogit</span>
<span id="cb60-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb60-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##        Term Estimate Std. Error      z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb60-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6       -0.0996    0.01072  -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb60-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6       -0.0557    0.01091  -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb60-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3ft - 2ft    0.0837    0.00881   9.50   &lt;0.001  0.0664  0.1010</span></span>
<span id="cb60-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  gas - elec   0.2785    0.01021  27.28   &lt;0.001  0.2585  0.2985</span></span>
<span id="cb60-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  hyb - elec   0.1156    0.01032  11.20   &lt;0.001  0.0954  0.1358</span></span>
<span id="cb60-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  35 - 30      0.1767    0.01117  15.82   &lt;0.001  0.1548  0.1986</span></span>
<span id="cb60-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  40 - 30     -0.1333    0.01014 -13.14   &lt;0.001 -0.1532 -0.1134</span></span>
<span id="cb60-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb60-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: variable, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
</section>
<section id="bayesian-comparisonscontrasts-1" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts-1">Bayesian comparisons/contrasts</h3>
<p>Unlike the chocolate example, where the outcome variable was binary, we have to do similar <code>by</code>-like shenanigans with the Bayesian minivan model here. We could theoretically work with things like <code>marginaleffects::comparisons()</code> or <code>marginaleffects::slopes()</code> to extract the AMCEs from the model, but as I’ll show below, there are some weird mathy things we have to deal with because of the multinomial outcome, and I think it’s beyond what {marginaleffects} is designed to easily do.</p>
<p>So instead we can use <code>epred_draws()</code> from {tidybayes} and calculate posterior predictions ourselves (<a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">see this guide</a> for an overview of all of {tidybayes}’s different prediction functions).</p>
<p>To illustrate why predicting things with this multinomial model is so weird, we’ll first predict the probability that someone chooses a $30,000 6-seater electric van with 2 feet of storage space. For this combination of minivan characteristics, there’s a 66% chance that someone does not select it, shown as category 0. That means there’s a 33% chance that someone <em>does</em> select it. Because options 1, 2 and 3 were randomized, that 33% is split evenly across categories 1, 2, and 3 in the predictions here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1">one_prediction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb61-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb61-4">  )</span>
<span id="cb61-5"></span>
<span id="cb61-6">one_prediction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb61-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 7</span></span>
<span id="cb61-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .category .epred .lower .upper .width .point .interval</span></span>
<span id="cb61-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb61-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 0          0.661 0.629   0.694   0.95 median qi       </span></span>
<span id="cb61-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 1          0.104 0.0843  0.128   0.95 median qi       </span></span>
<span id="cb61-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 2          0.112 0.0894  0.138   0.95 median qi       </span></span>
<span id="cb61-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 3          0.121 0.0990  0.147   0.95 median qi</span></span></code></pre></div>
</div>
<p>We could add the predictions for categories 1, 2, and 3 together, but that would take a bit of extra data manipulation work. Instead, we can rely on the the fact that the prediction for category 0 is actually the inverse of the sum of categories 1+2+3, so we can instead just use <code>1 - .epred</code> and only look at category 0. Even though the <code>category</code> column here says <code>0</code>, it’s really the combined probability of choosing options 1, 2, or 3:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1">one_prediction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb62-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb62-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb62-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb62-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 13</span></span>
<span id="cb62-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  cargo eng   price resp.id  .row .category .epred .lower .upper .width .point .interval</span></span>
<span id="cb62-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb62-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6     2ft   elec  30          1     1 0          0.339  0.306  0.371   0.95 median qi</span></span></code></pre></div>
</div>
<p>With {mlogit}, we found AMCEs by essentially calculating marginal means for specific contrasts of predicted probabilities. We created a data frame of all 54 combinations of feature levels and then grouped and summarized that data frame as needed (e.g., the average of the 27 predictions for 2 feet of cargo space and the average of the 27 predictions for 3 feed of cargo space).</p>
<p>We can do the same thing with the {brms} model, but selecting only the 0 category and reversing the predicted value:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1">newdata_all_combos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb63-4"></span>
<span id="cb63-5">all_preds_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newdata_all_combos) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span></code></pre></div>
</div>
<p>To make sure it worked, here are the posterior medians for all the different levels. It’s roughly the same as what we found with in <code>all_preds_mlogit</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb64-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb64-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb64-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 10</span></span>
<span id="cb64-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price .epred .lower .upper .width .point .interval</span></span>
<span id="cb64-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb64-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    0.682  0.651   0.713   0.95 median qi       </span></span>
<span id="cb64-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   35    0.485  0.451   0.520   0.95 median qi       </span></span>
<span id="cb64-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   40    0.305  0.275   0.338   0.95 median qi       </span></span>
<span id="cb64-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   hyb   30    0.502  0.466   0.537   0.95 median qi       </span></span>
<span id="cb64-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   hyb   35    0.306  0.276   0.338   0.95 median qi       </span></span>
<span id="cb64-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   hyb   40    0.171  0.150   0.194   0.95 median qi       </span></span>
<span id="cb64-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   elec  30    0.339  0.306   0.371   0.95 median qi       </span></span>
<span id="cb64-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   elec  35    0.183  0.161   0.207   0.95 median qi       </span></span>
<span id="cb64-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   elec  40    0.0952 0.0819  0.110   0.95 median qi       </span></span>
<span id="cb64-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     3ft   gas   30    0.769  0.743   0.795   0.95 median qi       </span></span>
<span id="cb64-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>To pull out specific group-level averages, we can group and summarize. For example, here are the posterior median predictions for the two levels of cargo space:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb65-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb65-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb65-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb65-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo .epred .lower .upper .width .point .interval</span></span>
<span id="cb65-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb65-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft    0.256 0.0606  0.676   0.95 median qi       </span></span>
<span id="cb65-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft    0.348 0.0905  0.763   0.95 median qi</span></span></code></pre></div>
</div>
<p>The medians here are correct and basically what we found with {mlogit}, but the credible intervals are <em>wildly</em> off (5% to 75% favorability?!). If we plot this we can see why:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb66-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> cargo)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-combo-wrong-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>hahahaha check out those mountain ranges. All those peaks come from combining the 27 different 2ft- and 3ft- posterior distributions for all the different combinations of other feature levels.</p>
<p>To get the actual marginal mean for cargo space, we need to marginalize out (or average out) all those other covariates. To do this, we need to group by the <code>cargo</code> column <em>and</em> the <code>.draw</code> column so that we find the average within each set of MCMC draws. To help with the intuition, look how many rows are in each of these groups of <code>cargo</code> and <code>.draw</code>—there are 27 different estimates for each of the 4,000 draws for 2 feet and 27 different estimates for each of the 4,000 draws for 3 feet. We want to collapse (or marginalize) those 27 rows into just one average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb67-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb67-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrows =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb67-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8,000 × 3</span></span>
<span id="cb67-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   cargo [2]</span></span>
<span id="cb67-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    cargo .draw nrows</span></span>
<span id="cb67-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb67-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 2ft       1    27</span></span>
<span id="cb67-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 2ft       2    27</span></span>
<span id="cb67-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 2ft       3    27</span></span>
<span id="cb67-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 2ft       4    27</span></span>
<span id="cb67-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 2ft       5    27</span></span>
<span id="cb67-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 2ft       6    27</span></span>
<span id="cb67-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 2ft       7    27</span></span>
<span id="cb67-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 2ft       8    27</span></span>
<span id="cb67-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 2ft       9    27</span></span>
<span id="cb67-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 2ft      10    27</span></span>
<span id="cb67-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 7,990 more rows</span></span></code></pre></div>
</div>
<p>To do that, we can find the average predicted value in those groups, then work with that as our main estimand. Check out these marginalized-out posteriors now—the medians are the same as before, but the credible intervals make a lot more sense:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1">preds_cargo_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates</span></span>
<span id="cb68-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb68-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb68-5"></span>
<span id="cb68-6">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>()</span>
<span id="cb68-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb68-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo   avg .lower .upper .width .point .interval</span></span>
<span id="cb68-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb68-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft   0.292  0.275  0.309   0.95 median qi       </span></span>
<span id="cb68-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft   0.374  0.356  0.393   0.95 median qi</span></span></code></pre></div>
</div>
<p>We can confirm that marginalizing out the other covariates worked by plotting it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb69-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> cargo)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-cargo-marginalized-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>heck. yes.</p>
<p>Finally, we’re actually most interested in the AMCE, or the difference between these two cargo sizes. The <code>compare_levels()</code> function from {tidybayes} can calculate this automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb70-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb70-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb70-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 7</span></span>
<span id="cb70-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo        avg .lower .upper .width .point .interval</span></span>
<span id="cb70-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb70-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 3ft - 2ft 0.0830 0.0643  0.100   0.95 median qi</span></span></code></pre></div>
</div>
<p>That’s it! The <strong>causal effect</strong> of moving from 2 feet → 3 feet of storage space, holding all other features constant, is 8 percentage points (with a 95% credible interval of 6.5 to 10 percentage points).</p>
<p>We can combine all these AMCEs into a huge data frame. The marginalization process + <code>compare_levels()</code> has to happen with one feature at a time, so we need to create several separate data frames:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I could probably do this with purrr::map() to reduce all this repetition, but</span></span>
<span id="cb71-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># whatever, it works</span></span>
<span id="cb71-3">amces_minivan_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb71-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> seat),</span>
<span id="cb71-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> cargo),</span>
<span id="cb71-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(eng, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> eng),</span>
<span id="cb71-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(price, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> price),</span>
<span id="cb71-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"term"</span></span>
<span id="cb71-25">)</span>
<span id="cb71-26"></span>
<span id="cb71-27">amces_minivan_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb71-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 7 × 8</span></span>
<span id="cb71-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term  contrast       avg  .lower  .upper .width .point .interval</span></span>
<span id="cb71-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb71-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 cargo 3ft - 2ft   0.0830  0.0643  0.100    0.95 median qi       </span></span>
<span id="cb71-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 eng   elec - gas -0.279  -0.300  -0.256    0.95 median qi       </span></span>
<span id="cb71-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 eng   hyb - gas  -0.161  -0.184  -0.138    0.95 median qi       </span></span>
<span id="cb71-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 price 35 - 30    -0.178  -0.201  -0.155    0.95 median qi       </span></span>
<span id="cb71-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 price 40 - 30    -0.309  -0.330  -0.287    0.95 median qi       </span></span>
<span id="cb71-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 seat  7 - 6      -0.0995 -0.121  -0.0785   0.95 median qi       </span></span>
<span id="cb71-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 seat  8 - 6      -0.0570 -0.0788 -0.0355   0.95 median qi</span></span></code></pre></div>
</div>
</section>
<section id="plots-2" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="plots-2">Plots</h3>
<p>Again, plotting these AMCEs so that there’s a reference category at 0 requires some extra data work, so I’ve hidden all that code for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1">minivan_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb72-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>)</span>
<span id="cb72-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb72-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans[[.x]]</span>
<span id="cb72-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb72-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb72-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb72-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb72-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb72-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb72-12">    }</span>
<span id="cb72-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb72-16"></span>
<span id="cb72-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb72-18">minivan_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb72-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb72-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passengers"</span>,</span>
<span id="cb72-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>,</span>
<span id="cb72-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Engine type"</span>,</span>
<span id="cb72-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Price (thousands of $)"</span></span>
<span id="cb72-24">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary>
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1">amces_minivan_mlogit_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb73-3">    term,</span>
<span id="cb73-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb73-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb73-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> variable)</span>
<span id="cb73-8"></span>
<span id="cb73-9">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb73-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb73-11">    amces_minivan_mlogit_split,</span>
<span id="cb73-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb73-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb73-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb73-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb73-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb73-18">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb73-19">    )</span>
<span id="cb73-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb73-23"></span>
<span id="cb73-24">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb73-25">  plot_data,</span>
<span id="cb73-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb73-27">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb73-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of minivan selection"</span>,</span>
<span id="cb73-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb73-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb73-36">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with marginalized posterior draws and make {brms} plot</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1">posterior_mfx_minivan_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb74-3">    contrast,</span>
<span id="cb74-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb74-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb74-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb74-9"></span>
<span id="cb74-10">plot_data_minivan_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb74-12">    posterior_mfx_minivan_nested,</span>
<span id="cb74-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb74-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb74-19"></span>
<span id="cb74-20">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data_minivan_bayes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb74-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb74-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of minivan selection"</span>,</span>
<span id="cb74-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb74-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb74-30">  )</span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p2</span></code></pre></div>
<div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-both-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section>
</section>
</section>
<section id="part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 3: Minivans; repeated questions; full hierarchical multinomial logit</h1>
<section id="the-setup-2" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-setup-2">The setup</h2>
<p>We’ve cheated a little and have already used multilevel structures in the Bayesian models for the chocolate experiment and the minivan experiment. This was because these datasets had a natural panel grouping structure inside them. {mlogit} can work with panel-indexed data frames (that’s the point of that strange <code>dfidx()</code> function). By creating respondent-specific intercepts like we did with the {brms} models, we helped account for some of the variation caused by respondent differences.</p>
<p>But we can do better than that and get far richer and more complex models and estimates and predictions. In addition to using respondent-specific intercepts, we can (1) include respondent-level characteristics as covariates, and (2) include respondent-specific slopes for the minivan characteristic.</p>
<p>In the minivan data, we have data on feature levels (<code>seat</code>, <code>cargo</code>, <code>eng</code>, <code>price</code>) <em>and</em> on individual characteristics (<code>carpool</code>). The <code>carpool</code> variable indicates if the respondent uses their vehicle for carpooling. This is measured at the respondent level and not the choice level (i.e.&nbsp;someone won’t stop being a carpooler during one set of choices and then resume being a carpooler for another set). We can visualize where these different columns are measured by returning to the hierarchical model diagram:</p>
<div class="cell page-columns page-full" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display column-page">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/minivan-multilevel-structure-annotated-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with minivan choices <img src="https://latex.codecogs.com/png.latex?%5C%7By_1,%20y_2,%20y_3%5C%7D"> nested in sets of questions in respondents, w ith variables measured at different levels</figcaption>
</figure>
</div>
</div>
</div>
<p>We can use hierarchical models (or multilevel models, or mixed effects models, or whatever you want to call them) to account for choice-level and respondent-level covariates <em>and</em> incorporate respondent-level heterogeneity and covariance into the model estimates.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/img/chelsea-meme.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption class="figure-caption">Image by <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Chelsea Parlett-Pelleriti</a></figcaption>
</figure>
</div>
</section>
<section id="important-sidenote-on-notation" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="important-sidenote-on-notation">Important sidenote on notation</h2>
<div class="page-columns page-full"><p>But before looking at how to incorporate that <code>carpool</code> column into the model, we need to take a quick little detour into the world of notation. There’s no consistent way of writing out multilevel models,<sup>1</sup> and accordingly, I thought it was impossible to run fully specified marketing-style hierarchical Bayesian models with {brms}—all because of notation!</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;These are not the only approaches—section 12.5 in <span class="citation" data-cites="GelmanHill:2007">Gelman and Hill (2007)</span> is called “Five ways to write the same model,” and they don’t include the offset notation as one of their five!</p></li></div></div>
<p>There are a couple general ways I’ve seen group-level random effects written out in formal model notation: one with complete random β terms and one with random offsets from a global β term.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
{brms} / {lme4} syntax
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overview of how to use {brms} and {lme4} with different random group-level intercept and slope specifications, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">check out this summary table by Ben Bolker</a>.</p>
</div>
</div>
<section id="random-intercepts" class="level3">
<h3 class="anchored" data-anchor-id="random-intercepts">Random intercepts</h3>
<p>If you want group-specific intercept terms, you can use a formula like this:</p>
<div class="sourceCode" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> group))</span></code></pre></div>
<p>In formal mathy terms, we can write this group-specific intercept as a complete coefficient: <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B0_j%7D">. Each group <img src="https://latex.codecogs.com/png.latex?j"> gets its own intercept coefficient. Nice and straightforward.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cbeta_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cbeta_0,%20%5Csigma_0)%20&amp;%20%5Ctext%7BRandom%20group-specific%20intercepts%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>However, I actually like to think of these random effects in a slightly different way, where each group intercept is actually a combination of a global average (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) and a group-specific offset from that average (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">), like this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_%7B0_j%7D%20=%20%5Cbeta_0%20+%20b_%7B0_j%7D%0A"></p>
<p>That offset is assumed to be normally distributed with a mean of 0 (<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(0,%20%5Csigma_0)">):</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0Ab_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20&amp;%20%5Ctext%7BRandom%20group-specific%20offsets%20from%20global%20intercept%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>I prefer this offset notation because it aligns with the output of {brms}, which reports population-level coefficients (i.e.&nbsp;the global average <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) along with group-specific offsets from that average (i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">), which you can access with <code>ranef(model_name)</code>.</p>
</section>
<section id="random-slopes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="random-slopes">Random slopes</h3>
<p>If you want group-specific intercepts <em>and</em> slopes, you can use a formula like this:</p>
<div class="sourceCode" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> group))</span></code></pre></div>
<p>The same dual syntax applies when using random slopes too. We can either use whole group-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7Bn_j%7D"> terms, or use offsets (<img src="https://latex.codecogs.com/png.latex?b_%7Bn_j%7D">) from a global average slope (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_n">). When working with random slopes, the math notation gets a little fancier because the random intercept and slope terms are actually correlated and move together across groups. The <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> terms come from a multivariate (or joint) normal distribution with shared covariance.</p>
<p>With the complete β approach, we’re estimating the joint distribution of <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D%20%5Cbeta_%7B0_j%7D%20%5C%5C%20%5Cbeta_%7B1_j%7D%20%5Cend%7Bpmatrix%7D">:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%5Cbeta_%7B1_j%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%0A%5Cleft(%0A%20%20%5Cleft(%0A%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbeta_0%20%5C%5C%0A%20%20%20%20%5Cbeta_1%20%5C%5C%0A%20%20%20%20%5Cend%7Barray%7D%0A%20%20%5Cright)%0A%20%20,%20%5C,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%20&amp;%20%5Ctext%7BRandom%20group-specific%20slopes%20and%20intercepts%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>With the offset approach, we’re estimating the joint distribution of the offsets from the global intercept and slope, or <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D%20b_%7B0_j%7D%20%5C%5C%20b_%7B1_j%7D%20%5Cend%7Bpmatrix%7D">:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20(b_%7B1_j%7D%20+%20%5Cbeta_1)%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20b_%7B0_j%7D%20%5C%5C%0A%20%20b_%7B1_j%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%0A%5Cleft(%0A%20%20%5Cleft(%0A%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%200%20%5C%5C%0A%20%20%20%200%20%5C%5C%0A%20%20%20%20%5Cend%7Barray%7D%0A%20%20%5Cright)%0A%20%20,%20%5C,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%20&amp;%20%5Ctext%7BRandom%20group-specific%20offsets%20from%20global%20intercept%20and%20slope%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
</section>
<section id="summary-table" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="summary-table">Summary table</h3>
<p>And here’s a helpful little table summarizing these two types of notation (mostly for future me).</p>
<div class="column-page-inset">
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 22%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Formula syntax</th>
<th style="text-align: center;">Full <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> notation</th>
<th style="text-align: center;">Offset notation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Random intercept</td>
<td><code>y ~ x + (1 | group)</code></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cbeta_0,%20%5Csigma_0)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
</tr>
<tr class="even">
<td>Random intercept + slope</td>
<td><code>y ~ x + (1 + x | group)</code></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B0_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B1_j%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_0%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_1%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%20%5C,%20%5CSigma%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5CSigma%20&amp;%5Csim%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bcc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20(b_%7B1_j%7D%20+%20%5Cbeta_1)%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B0_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B1_j%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%20%5C,%20%5CSigma%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5CSigma%20&amp;%5Csim%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bcc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="translating-from-marketing-style-stan-notation-to-brms-syntax" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="translating-from-marketing-style-stan-notation-to-brms-syntax">Translating from marketing-style Stan notation to {brms} syntax</h2>
<p>In <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> and in all the marketing papers I’ve seen that use hierarchical Bayesian models—and even one I coauthored! <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">(Chaudhry, Dotson, and Heiss 2021)</span> (<a href="https://stats.andrewheiss.com/who-cares-about-crackdowns/output/appendix.html#model-details">see the appendix</a>)—they define their models using notation like this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BChoice%7D%20&amp;%5Csim%20%5Coperatorname%7BMultinomial%5C%20logit%7D(%5Cbeta%20X)%20&amp;%20%5Ctext%7Bwhere%20%7D%20X%20=%20%5Ctext%7Bfeature%20levels%7D%20%5C%5C%0A%5Cbeta%20&amp;%5Csim%20%5Coperatorname%7BMultivariate%7D%20%5Cmathcal%7BN%7D(%5Cgamma%20Z,%20%5CSigma)%20&amp;%20%5Ctext%7Bwhere%20%7D%20Z%20=%20%5Ctext%7Bindividual%20characteristics%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>For the longest time this threw me off because it’s slightly different from the two different notations we just reviewed (full βs vs.&nbsp;offsets from global β), and I figured that specifying a model like this with {brms} was impossible. The main reason for my confusion is that there are two different datasets involved in this model, and {brms} can only really work with one dataset.</p>
<p>In raw Stan (like <a href="https://github.com/ksvanhorn/ART-Forum-2017-Stan-Tutorial">in this tutorial on conjoint hierarchical Bayes models</a>, or in <a href="https://github.com/Bartosz-G/Conjoint-Analysis-in-R/">this example of a different conjoint hierarchical model</a>), you’d typically work with two different datasets or matrices: one <img src="https://latex.codecogs.com/png.latex?X"> with feature levels and one <img src="https://latex.codecogs.com/png.latex?Z"> with respondent-level characteristics. (<a href="https://mc-stan.org/docs/stan-users-guide/multivariate-hierarchical-priors.html">This is actually the recommended way to write hierarchical models in raw Stan!</a>).</p>
<p>Here’s what separate <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Z"> matrices would look like with the minivan data—<code>X</code> contains the full data without respondent-level covariates like <code>carpool</code> and it has 9,000 rows; <code>Z</code> contains only respondent-level characteristics like <code>carpool</code> and it only has 200 rows (one per respondent).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>carpool)</span>
<span id="cb78-2">X</span>
<span id="cb78-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 8</span></span>
<span id="cb78-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt seat  cargo eng   price choice</span></span>
<span id="cb78-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb78-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 6     2ft   gas   35         0</span></span>
<span id="cb78-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 8     3ft   hyb   30         0</span></span>
<span id="cb78-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 6     3ft   gas   30         1</span></span>
<span id="cb78-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 6     2ft   gas   30         0</span></span>
<span id="cb78-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 7     3ft   gas   35         1</span></span>
<span id="cb78-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 6     2ft   elec  35         0</span></span>
<span id="cb78-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 8     3ft   gas   35         1</span></span>
<span id="cb78-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 7     3ft   elec  30         0</span></span>
<span id="cb78-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 8     2ft   elec  40         0</span></span>
<span id="cb78-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 7     3ft   elec  40         1</span></span>
<span id="cb78-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span>
<span id="cb78-17"></span>
<span id="cb78-18">Z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb78-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep the first row of each respondent</span></span>
<span id="cb78-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp.id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb78-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep the respondent-level columns</span></span>
<span id="cb78-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(resp.id, carpool)</span>
<span id="cb78-23">Z</span>
<span id="cb78-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 200 × 2</span></span>
<span id="cb78-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id carpool</span></span>
<span id="cb78-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;fct&gt;  </span></span>
<span id="cb78-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1 yes    </span></span>
<span id="cb78-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       2 no     </span></span>
<span id="cb78-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       3 no     </span></span>
<span id="cb78-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       4 no     </span></span>
<span id="cb78-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       5 yes    </span></span>
<span id="cb78-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       6 no     </span></span>
<span id="cb78-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       7 no     </span></span>
<span id="cb78-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       8 yes    </span></span>
<span id="cb78-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       9 no     </span></span>
<span id="cb78-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10      10 no     </span></span>
<span id="cb78-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 190 more rows</span></span></code></pre></div>
</div>
<p><code>X</code> and <code>Z</code> are then passed to Stan as separate matrices and used at different places in the model fitting process. Here’s what that looks like in pseudo-Stan code. The matrix of individual characteristics <code>Z</code> is matrix-multiplied with a bunch of estimated <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> coefficients (<code>Gamma</code> here) to generate individual-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients (<code>Beta</code> here). The matrix of choices <code>X</code> is then matrix-multiplied with the individual-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients to generate predicted outcomes (<code>Y</code> here).</p>
<div class="sourceCode" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb79-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n_respondents) {</span>
<span id="cb79-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// All the individual-specific slopes and intercepts</span></span>
<span id="cb79-3">  Beta[,r] ~ multi_normal(Gamma * Z[,r], ...);</span>
<span id="cb79-4"></span>
<span id="cb79-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// All the question-level outcomes, using individual-specific slopes and intercepts</span></span>
<span id="cb79-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n_questions) {</span>
<span id="cb79-7">     Y[r,s] ~ categorical_logit( X [r,s] * Beta[,r]);</span>
<span id="cb79-8">  }</span>
<span id="cb79-9">}</span></code></pre></div>
<p>That’s a neat way of working with multilevel models, but it’s different from how I’ve always worked with them (and it requires working with raw Stan). As seen throughout this post, I’m a fan of {brms}’s formula-style syntax for specifying multilevel models, but {brms} can only work with one dataset at a time—you can’t pass it both <code>X</code> and <code>Z</code> like you’d do with raw Stan. So I (naively) figured that this went beyond {brms}’s abilities and was only possible with raw Stan.</p>
<p>However, if we use {brms}’s <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">special formula syntax</a>, we can actually specify an identical model with only one dataset (again, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">see this for a fantastic overview of the syntax</a>).</p>
<p>First, let’s look at the marketing-style syntax again:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BChoice%7D%20&amp;%5Csim%20%5Coperatorname%7BMultinomial%5C%20logit%7D(%5Cbeta%20X)%20&amp;%20%5Ctext%7Bwhere%20%7D%20X%20=%20%5Ctext%7Bfeature%20levels%7D%20%5C%5C%0A%5Cbeta%20&amp;%5Csim%20%5Coperatorname%7BMultivariate%7D%20%5Cmathcal%7BN%7D(%5Cgamma%20Z,%20%5CSigma)%20&amp;%20%5Ctext%7Bwhere%20%7D%20Z%20=%20%5Ctext%7Bindividual%20characteristics%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>This is actually just a kind of <em>really</em> compact notation. That second line with the <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Csim%20%5Coperatorname%7BMultivariate%7D%5C,%20%5Cmathcal%7BN%7D(%5Ccdot)"> distribution is a shorthand version of the full-β syntax from earlier. To illustrate this, let’s expand this out to a more complete formal definition of the model. Instead of using <img src="https://latex.codecogs.com/png.latex?X"> to stand in for all the feature levels and <img src="https://latex.codecogs.com/png.latex?Z"> for all the individual characteristics, we’ll expand those to include all the covariates we’re using. And instead of calling the distribution “Multinomial logit” we’ll call it “Categorical” so it aligns with Stan. It’ll make for a <em>really massive formula</em>, but it shows what’s really going on.</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B2_j%7D%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B3_j%7D%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B4_j%7D%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B5_j%7D%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B6_j%7D%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B7_j%7D%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B20pt%5D%20%20%0A&amp;%5C%20%5Ctextbf%7BRespondent-specific%20slopes%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7_j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%20%5Csim&amp;%5C%20%5Coperatorname%7BMultivariate%7D%5C%20%5Cmathcal%7BN%7D%20%5Cleft%5B%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_%7B0j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright%5D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>&nbsp;</p>
<p>Importantly, pay attention to where the choice-level and respondent-level variables show up in this expanded version. All the choice-level variables have respondent-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients, while the respondent-level variable (<code>carpool</code>) is down in that massive multivariate normal matrix with its own <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> coefficients, helping determine the respondent-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients. That’s great and exactly what we want, and we can do that with raw Stan, but raw Stan is no fun.</p>
<p>We can create this exact same model structure with {brms} like this:</p>
<div class="sourceCode" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb80-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choice-level predictors that are nested within respondents...</span></span>
<span id="cb80-3">  (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb80-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...interacted with all respondent-level predictors...</span></span>
<span id="cb80-5">  (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb80-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... with random respondent-specific slopes for the</span></span>
<span id="cb80-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># nested choice-level predictors</span></span>
<span id="cb80-8">  (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id))</span></code></pre></div>
<p>We can confirm that this worked by using <a href="https://datalorax.github.io/equatiomatic/">the miraculous {equatiomatic} package</a>, which automatically converts model objects into LaTeX code. {equatiomatic} doesn’t work with {brms} models, but it does work with frequentist {lme4} models, so we can fit a throwaway frequentist model with this syntax (it won’t actually converge and it’ll give a warning, but that’s fine—we don’t actually care about this model) and then feed it to <code>equatiomatic::extract_eq()</code> to see what it looks like in formal notation.</p>
<p>(This is actually how I figured out the correct combination of interactions and random slopes—I kept trying different combinations that I thought were right until the math matched the huge full model above, with the <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> terms in the right places.)</p>
<div class="cell column-page" data-layout-align="center" data-hash="index_cache/html/lme4-equatiomatic_11cd43e0bdfaf4c833f9c444c77012c6">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lme4)</span>
<span id="cb81-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(equatiomatic)</span>
<span id="cb81-3"></span>
<span id="cb81-4">model_throwaway <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lmer</span>(</span>
<span id="cb81-5">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb81-6">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id),</span>
<span id="cb81-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans</span>
<span id="cb81-8">)</span>
<span id="cb81-9"></span>
<span id="cb81-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_eq</span>(model_throwaway))</span></code></pre></div>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Coperatorname%7Bchoice%7D_%7Bi%7D%20%20&amp;%5Csim%20N%20%5Cleft(%5Cmu,%20%5Csigma%5E2%20%5Cright)%20%5C%5C%0A%20%20%20%20%5Cmu%20&amp;=%5Calpha_%7Bj%5Bi%5D%7D%20+%20%5Cbeta_%7B1j%5Bi%5D%7D(%5Coperatorname%7Bseat%7D_%7B%5Coperatorname%7B7%7D%7D)%20+%20%5Cbeta_%7B2j%5Bi%5D%7D(%5Coperatorname%7Bseat%7D_%7B%5Coperatorname%7B8%7D%7D)%20+%20%5Cbeta_%7B3j%5Bi%5D%7D(%5Coperatorname%7Bcargo%7D_%7B%5Coperatorname%7B3ft%7D%7D)%20+%20%5Cbeta_%7B4j%5Bi%5D%7D(%5Coperatorname%7Beng%7D_%7B%5Coperatorname%7Bhyb%7D%7D)%20+%20%5Cbeta_%7B5j%5Bi%5D%7D(%5Coperatorname%7Beng%7D_%7B%5Coperatorname%7Belec%7D%7D)%20+%20%5Cbeta_%7B6j%5Bi%5D%7D(%5Coperatorname%7Bprice%7D_%7B%5Coperatorname%7B35%7D%7D)%20+%20%5Cbeta_%7B7j%5Bi%5D%7D(%5Coperatorname%7Bprice%7D_%7B%5Coperatorname%7B40%7D%7D)%20%5C%5C%20%20%20%20%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Calpha_%7Bj%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%20%20&amp;%5Csim%20N%20%5Cleft(%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma_%7B0%7D%5E%7B%5Calpha%7D%20+%20%5Cgamma_%7B1%7D%5E%7B%5Calpha%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%0A%20%20%20%20%5Ctext%7B,%20for%20resp.id%20j%20=%201,%7D%20%5Cdots%20%5Ctext%7B,J%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<section id="different-variations-of-group-level-interactions" class="level3">
<h3 class="anchored" data-anchor-id="different-variations-of-group-level-interactions">Different variations of group-level interactions</h3>
<p>This syntax is a special R shortcut for interacting <code>carpool</code> with each of the feature variables:</p>
<div class="sourceCode" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Short way</span></span>
<span id="cb82-2">(seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool)</span>
<span id="cb82-3"></span>
<span id="cb82-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This expands to this</span></span>
<span id="cb82-5">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool</span></code></pre></div>
<p>If we had other respondent-level columns like age (<code>age</code>) and education (<code>ed</code>), the shortcut syntax is really helpful:</p>
<div class="sourceCode" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Short way</span></span>
<span id="cb83-2">(seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ed)</span>
<span id="cb83-3"></span>
<span id="cb83-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This expands to this</span></span>
<span id="cb83-5">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb83-6">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb83-7">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed</span></code></pre></div>
<p>We don’t necessarily need to fully interact everything. For instance, if we have theoretical reasons to think that carpool status is associated with seat count preferences, but not other features, we can only interact <code>seat</code> and <code>carpool</code>:</p>
<div class="sourceCode" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb84-2">    (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb84-3">  (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id))</span></code></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model running times
</div>
</div>
<div class="callout-body-container callout-body">
<p>The more individual-level interactions you add, the longer it will take for the model to run. As we’ll see below, interacting <code>carpool</code> with the four feature levels takes ≈30 minutes to fit. As you add more individual-level interactions, the running time blows up.</p>
<p>In the replication code for <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (2021)</span>, where they model a ton of individual variables, they say it takes several days to run. Our models in <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">Chaudhry, Dotson, and Heiss (2021)</span> take hours and hours to run.</p>
</div>
</div>
</section>
</section>
<section id="mlogit-model-2" class="level2">
<h2 class="anchored" data-anchor-id="mlogit-model-2"><code>mlogit</code> model</h2>
<p>{mlogit} can estimate hierarchical models with something like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the random parameters</span></span>
<span id="cb85-2">model_mlogit_rpar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef))</span>
<span id="cb85-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(model_mlogit_rpar) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef)</span>
<span id="cb85-4"></span>
<span id="cb85-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This means these random terms are all normally distributed</span></span>
<span id="cb85-6">model_mlogit_rpar</span>
<span id="cb85-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; seat7    seat8 cargo3ft   enghyb  engelec  price35  price40 </span></span>
<span id="cb85-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   "n"      "n"      "n"      "n"      "n"      "n"      "n" </span></span>
<span id="cb85-9"></span>
<span id="cb85-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the model with carpool as an individual-level covariate</span></span>
<span id="cb85-11">model_mlogit_hierarchical <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb85-12">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> carpool,</span>
<span id="cb85-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_idx,</span>
<span id="cb85-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rpar =</span> model_mlogit_rpar, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">correlation =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb85-15">)</span>
<span id="cb85-16"></span>
<span id="cb85-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the results</span></span>
<span id="cb85-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(model_mlogit_hierarchical)</span></code></pre></div>
</div>
<p>However, I’m not a frequentist and I’m already not a huge fan of extracting the predictions and AMCEs from these {mlogit} models. Running and interpreting and working with the results of that object is left as an exercise for the reader :). (See p.&nbsp;381 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> for a worked example of how to do it.)</p>
</section>
<section id="finally-the-full-brms-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="finally-the-full-brms-model">Finally, the full {brms} model</h2>
<p>This is a really complex model with a ton of moving parts, but it’s also incredibly powerful. It lets us account for individual-specific differences across each of the minivan features. For instance, whether an individual carpools probably influences their preferences for the number of seats, and maybe cargo space, but probably doesn’t influence their preferences for engine type. If we had other individual-level characteristics, we could also let those influence feature preferences. Like, the number of kids an individual has probably influences seat count preferences; the individual’s income probably influences their price preferences; and so on.</p>
<p>Let’s define the model more formally again, this time with priors for the parameters we’ll be estimating:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B2_j%7D%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B3_j%7D%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B4_j%7D%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B5_j%7D%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B6_j%7D%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B7_j%7D%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B20pt%5D%20%20%0A&amp;%5C%20%5Ctextbf%7BRespondent-specific%20slopes%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7_j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%20%5Csim&amp;%5C%20%5Coperatorname%7BMultivariate%7D%5C%20%5Cmathcal%7BN%7D%20%5Cleft%5B%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_%7B0j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright%5D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_%7B0%20%5Cdots%207%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5B%5Ctext%7BPrior%20for%20choice-level%20coefficients%7D%5D%20%5C%5C%0A%5Cgamma%5E%7B%5Cbeta_%7B0%20%5Cdots%207%7D%7D_0%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5B%5Ctext%7BPrior%20for%20individual-level%20coefficients%7D%5D%20%5C%5C%0A%5Csigma_%7B%5Cbeta_%7B0%20%5Cdots%207%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cqquad%20%5B%5Ctext%7BPrior%20for%20between-respondent%20intercept%20and%20slope%20variability%7D%5D%20%5C%5C%0A%5Crho%20%5Csim&amp;%5C%20%5Coperatorname%7BLKJ%7D(1)%20%5Cqquad%5Cqquad%20%5B%5Ctext%7BPrior%20for%20correlation%20between%20random%20slopes%20and%20intercepts%7D%5D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>&nbsp;</p>
<p>Here it is in code form. There are a couple new things here in the Stan settings. First, we’re going to create 4 MCMC chains with 4,000 draws rather than 2,000—there are so many parameters to be estimated that we need to let the simulation run longer. Second, we’ve modified the <code>adapt_delta</code> setting to 0.99. Conceptually, this adjusts the size of the steps the MCMC algorithm takes as it traverses the posterior space for each parameter—higher numbers make the steps smaller and more granular. This slows down the MCMC simulation, but it also helps avoid divergent transitions (or failed out-of-bounds draws).</p>
<p>On my 2021 M1 MacBook Pro, running through cmdstanr with 2 CPU cores per chain, it took about 30 minutes to fit. If you’re following along with this post, start running this and go get some lunch or go for a walk or something.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pre-run model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Alternatively, you can download <a href="https://osf.io/zp6eh">an .rds file of this completed</a>. This <code>brm()</code> code load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(osfr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interact with OSF via R</span></span>
<span id="cb86-2"></span>
<span id="cb86-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb86-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>)) { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>) }</span>
<span id="cb86-5"></span>
<span id="cb86-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb86-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_retrieve_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://osf.io/zp6eh"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb86-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_download</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conflicts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overwrite"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1">model_minivans_mega_mlm_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb87-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb87-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choice-level predictors that are nested within respondents...</span></span>
<span id="cb87-4">    (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb87-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...interacted with all respondent-level predictors...</span></span>
<span id="cb87-6">    (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb87-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... with random respondent-specific slopes for the</span></span>
<span id="cb87-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># nested choice-level predictors</span></span>
<span id="cb87-9">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id)),</span>
<span id="cb87-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_choice_alt,</span>
<span id="cb87-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refcat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>),</span>
<span id="cb87-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb87-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb87-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb87-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb87-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb87-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb87-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb87-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lkj</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> cor)</span>
<span id="cb87-20">  ),</span>
<span id="cb87-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb87-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># refresh = 0,</span></span>
<span id="cb87-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>),</span>
<span id="cb87-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_minivans_mega_mlm_brms"</span></span>
<span id="cb87-25">)</span></code></pre></div>
</div>
<p>This model is incredibly rich. We just estimated more than 5,000 parameters (!!!)—we have three sets of coefficients for each of the three options, and those are all interacted with <code>carpool</code>, plus we have individual-specific offsets to each of those coefficients, plus all the <img src="https://latex.codecogs.com/png.latex?%5Crho"> terms in that massive correlation matrix.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_variables</span>(model_minivans_mega_mlm_brms))</span>
<span id="cb88-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 5156</span></span></code></pre></div>
</div>
<p>Since we’re dealing with interaction terms, these raw log odds coefficients are even <em>less</em> helpful on their own. It’s nearly impossible to interpret these coefficients in any meaningful way—there’s no point in even trying to combine each of the individual parts of each effect (random parts, interaction parts, etc.). The only way we’ll be able to interpret these things is by making predictions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1">minivans_mega_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_mega_mlm_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">^b_.*$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regex =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb89-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb89-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb89-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable name ("seat6")</span></span>
<span id="cb89-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_regex</span>(</span>
<span id="cb89-8">    .variable,</span>
<span id="cb89-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patterns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_mu</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d_"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*"</span>)</span>
<span id="cb89-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb89-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb89-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.value)) </span>
<span id="cb89-15"></span>
<span id="cb89-16">minivans_mega_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.value)</span>
<span id="cb89-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 16 × 7</span></span>
<span id="cb89-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    .variable            .value  .lower  .upper .width .point .interval</span></span>
<span id="cb89-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb89-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 Intercept           -0.127  -0.281   0.0321   0.95 median qi       </span></span>
<span id="cb89-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 cargo3ft             0.405   0.290   0.521    0.95 median qi       </span></span>
<span id="cb89-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 cargo3ft:carpoolyes  0.162  -0.0488  0.380    0.95 median qi       </span></span>
<span id="cb89-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 carpoolyes          -0.718  -1.00   -0.437    0.95 median qi       </span></span>
<span id="cb89-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 engelec             -1.59   -1.77   -1.42     0.95 median qi       </span></span>
<span id="cb89-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 engelec:carpoolyes   0.0852 -0.211   0.375    0.95 median qi       </span></span>
<span id="cb89-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 enghyb              -0.774  -0.910  -0.640    0.95 median qi       </span></span>
<span id="cb89-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 enghyb:carpoolyes   -0.0543 -0.307   0.196    0.95 median qi       </span></span>
<span id="cb89-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 price35             -0.812  -0.947  -0.675    0.95 median qi       </span></span>
<span id="cb89-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 price35:carpoolyes  -0.164  -0.414   0.0845   0.95 median qi       </span></span>
<span id="cb89-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 price40             -1.58   -1.74   -1.43     0.95 median qi       </span></span>
<span id="cb89-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 price40:carpoolyes  -0.248  -0.528   0.0320   0.95 median qi       </span></span>
<span id="cb89-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 seat7               -0.879  -1.03   -0.735    0.95 median qi       </span></span>
<span id="cb89-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 seat7:carpoolyes     1.14    0.872   1.41     0.95 median qi       </span></span>
<span id="cb89-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 seat8               -0.646  -0.794  -0.501    0.95 median qi       </span></span>
<span id="cb89-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 16 seat8:carpoolyes     1.13    0.859   1.40     0.95 median qi</span></span></code></pre></div>
</div>
</section>
<section id="predictions-2" class="level2">
<h2 class="anchored" data-anchor-id="predictions-2">Predictions</h2>
<p>In the non-hierarchical model earlier, we made marketing-style predictions by thinking of a product mix and figuring out the predicted utility and market share of each product in that mix. We can do the same thing here, but now we can incorporate individual-level characteristics too.</p>
<p>Here’s our example product mix again, but this time we’ll repeat it twice—once with <code>carpool</code> set to “yes” and once with it set to “no”. This will let us see the predicted market share for each mix of products for a market of only carpoolers and only non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1">example_product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb90-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>seat, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>cargo, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>eng, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>price,</span>
<span id="cb90-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb90-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb90-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35"</span></span>
<span id="cb90-9">)</span>
<span id="cb90-10"></span>
<span id="cb90-11">product_mix_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb90-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>),</span>
<span id="cb90-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>)</span>
<span id="cb90-14">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb90-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), factor)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb90-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)))</span></code></pre></div>
</div>
<p>We can now go through the same process from earlier where we get logit-scale predictions for this smaller dataset and find the shares inside each draw + category (options 1, 2, and 3) + carpool status group.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> product_mix_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(model_minivans_mega_mlm_brms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb91-3"></span>
<span id="cb91-4">shares_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb91-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># three outcomes across both levels of carpooling</span></span>
<span id="cb91-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb91-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb91-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(mix_type, share)</span>
<span id="cb91-13">  )</span></code></pre></div>
</div>
<p>This new dataset contains 576,000 (!!) rows: 6 products × 2 carpool types × 3 <img src="https://latex.codecogs.com/png.latex?%5Cmu">-specific sets of coefficients × 16,000 MCMC draws. We can summarize this to get posterior medians and credible intervals, making sure to find the average share across the three outcomes (choice 1, 2, and 3), or marginalizing across the outcome.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the three outcomes within each draw</span></span>
<span id="cb92-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb92-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 12 × 8</span></span>
<span id="cb92-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    mix_type      carpool   share  .lower .upper .width .point .interval</span></span>
<span id="cb92-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;         &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb92-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6 2ft elec 40 no      0.0217  0.0173  0.0272   0.95 median qi       </span></span>
<span id="cb92-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6 2ft elec 40 yes     0.00946 0.00647 0.0136   0.95 median qi       </span></span>
<span id="cb92-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 7 2ft hyb 35  no      0.0434  0.0350  0.0532   0.95 median qi       </span></span>
<span id="cb92-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 7 2ft hyb 35  yes     0.0573  0.0425  0.0761   0.95 median qi       </span></span>
<span id="cb92-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 7 3ft gas 40  no      0.0655  0.0533  0.0798   0.95 median qi       </span></span>
<span id="cb92-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 7 3ft gas 40  yes     0.0976  0.0716  0.130    0.95 median qi       </span></span>
<span id="cb92-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 7 2ft hyb 30  no      0.0972  0.0824  0.114    0.95 median qi       </span></span>
<span id="cb92-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 7 2ft hyb 30  yes     0.148   0.118   0.183    0.95 median qi       </span></span>
<span id="cb92-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 8 2ft gas 30  no      0.265   0.239   0.293    0.95 median qi       </span></span>
<span id="cb92-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 8 2ft gas 30  yes     0.423   0.367   0.479    0.95 median qi       </span></span>
<span id="cb92-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 6 2ft gas 30  no      0.506   0.472   0.540    0.95 median qi       </span></span>
<span id="cb92-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 6 2ft gas 30  yes     0.261   0.223   0.303    0.95 median qi</span></span></code></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(carpool, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the three outcomes within each draw</span></span>
<span id="cb93-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb93-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>),</span>
<span id="cb93-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb93-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(carpool)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hypothetical product mix"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is so cool! In general, the market share for these six hypothetical products is roughly the same across carpoolers and non-carpoolers, with one obvious exception—among non-carpoolers, the $30,000 8-passenger gas minivan with 2 feet of space has 26% of the market, while among carpoolers it has 42%. Individuals who carpool apparently <em>really</em> care about the number of passengers their vehicle can carry.</p>
</section>
<section id="amces-2" class="level2">
<h2 class="anchored" data-anchor-id="amces-2">AMCEs</h2>
<p>To find the average marginal component effects (AMCEs), or the causal effect of moving one of these features to another value, holding all other variables constant, we can go through the same process as before. We’ll calculate the predicted probabilities of choosing option 0, 1, 2, and 3 across a full grid of all the combinations of feature levels <em>and</em> carpool status. We’ll then filter those predictions to only look at option 0 and reverse the predicted probabilities. Again, that feels weird, but it’s a neat little trick—if there’s a 33% chance that someone will select a specific combination of features, that would imply a 66% chance of not selecting it and an 11% chance of selecting it when it appears in option 1, option 2, and option 3. Rather than adding the probabilities within those three options together, we can do 100% − 66% to get the same 33% value, only it’s automatically combined.</p>
<p>Earlier we had 54 combinations—now we have 108 (54 × 2). We’ll set <code>resp.id</code> to one that’s not in the dataset (201) so that these effects all deal with a generic hypothetical respondent (we could also do some fancy “integrating out” work and find population-level averages; <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/">see here for more about that</a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1">newdata_all_combos_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb94-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb94-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">201</span>)</span>
<span id="cb94-4">newdata_all_combos_carpool</span>
<span id="cb94-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 108 × 6</span></span>
<span id="cb94-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price carpool resp.id</span></span>
<span id="cb94-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;     &lt;dbl&gt;</span></span>
<span id="cb94-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    no          201</span></span>
<span id="cb94-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   30    yes         201</span></span>
<span id="cb94-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   35    no          201</span></span>
<span id="cb94-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   gas   35    yes         201</span></span>
<span id="cb94-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   gas   40    no          201</span></span>
<span id="cb94-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   gas   40    yes         201</span></span>
<span id="cb94-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   hyb   30    no          201</span></span>
<span id="cb94-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   hyb   30    yes         201</span></span>
<span id="cb94-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   hyb   35    no          201</span></span>
<span id="cb94-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     2ft   hyb   35    yes         201</span></span>
<span id="cb94-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 98 more rows</span></span></code></pre></div>
</div>
<p>Next we can plug this grid into the model, filter to only keep option 0, and reverse the predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1">all_preds_brms_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_mega_mlm_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(</span>
<span id="cb95-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newdata_all_combos_carpool,</span>
<span id="cb95-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb95-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span></code></pre></div>
</div>
<p>This thing has 1.7 million rows in it, so we need to group and summarize to do anything useful with it. We also need to marginalize across all the other covariates when grouping (i.e.&nbsp;if we want the estimates for passenger seat count across carpool status, we need to average out all the other covariates).</p>
<p>To test that this worked, here are the posterior marginal means for seat count:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1">preds_seat_carpool_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb96-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb96-5"></span>
<span id="cb96-6">preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb96-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 8</span></span>
<span id="cb96-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  carpool   avg .lower .upper .width .point .interval</span></span>
<span id="cb96-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb96-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6     no      0.425  0.377  0.483   0.95 median qi       </span></span>
<span id="cb96-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 6     yes     0.287  0.245  0.339   0.95 median qi       </span></span>
<span id="cb96-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 7     no      0.262  0.205  0.337   0.95 median qi       </span></span>
<span id="cb96-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7     yes     0.335  0.267  0.419   0.95 median qi       </span></span>
<span id="cb96-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 8     no      0.305  0.225  0.409   0.95 median qi       </span></span>
<span id="cb96-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 8     yes     0.378  0.288  0.488   0.95 median qi</span></span></code></pre></div>
</div>
<p>Those credible intervals all look reasonable (i.e.&nbsp;not ranging from 5% to 80% or whatever), but it’s hard to see any trends from just this table. Let’s plot it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1">preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb97-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb97-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb97-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb97-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb97-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb97-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb97-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb97-11">    )</span>
<span id="cb97-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb97-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>,</span>
<span id="cb97-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb97-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb97-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb97-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb97-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb97-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb97-22">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-marginal-means-seat-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Neat! The average posterior predicted probability of choosing six seats is substantially higher for carpoolers than for non-carpoolers, while the probability for seven and eight seats is bigger for carpoolers.</p>
<p>We’re most interested in the AMCE though, and not the marginal means, so we’ll use <code>compare_levels()</code> to find the carpool-specific differences between the effect of moving from 6 → 7 and 6 → seats:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1">amces_seat_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) </span>
<span id="cb98-4"></span>
<span id="cb98-5">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb98-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 8</span></span>
<span id="cb98-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   carpool seat      avg  .lower   .upper .width .point .interval</span></span>
<span id="cb98-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb98-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 no      7 - 6 -0.162  -0.231  -0.0877    0.95 median qi       </span></span>
<span id="cb98-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 no      8 - 6 -0.120  -0.219  -0.00669   0.95 median qi       </span></span>
<span id="cb98-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 yes     7 - 6  0.0478 -0.0247  0.129     0.95 median qi       </span></span>
<span id="cb98-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 yes     8 - 6  0.0912 -0.0114  0.207     0.95 median qi</span></span></code></pre></div>
</div>
<p>Among carpoolers, the causal effect of moving from 6 → 7 passengers, holding all other features constant, is a 5ish percentage point increase in the probability of selecting the vehicle. The effect is bigger (9ish percentage points) when moving from 6 → 8.</p>
<p>Among non-carpoolers, the causal effect is reversed. Moving from 6 → 7 passengers causes a 16 percentage point decrease in the probability of selection, while moving from 6 → 8 causes a 12 percentage point decrease, holding all other features constant.</p>
<p>These effects are “significant” and have a 90–97% probability of being greater than zero for carpoolers and 98–99% probability of being less than zero for the non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate probability of direction</span></span>
<span id="cb99-2">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_gt_0 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(avg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_lt_0 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_gt_0)</span>
<span id="cb99-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 4</span></span>
<span id="cb99-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   seat [2]</span></span>
<span id="cb99-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  carpool   p_gt_0 p_lt_0</span></span>
<span id="cb99-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb99-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 7 - 6 no      0.000625 0.999 </span></span>
<span id="cb99-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 7 - 6 yes     0.908    0.0916</span></span>
<span id="cb99-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 8 - 6 no      0.0208   0.979 </span></span>
<span id="cb99-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 8 - 6 yes     0.961    0.0387</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb100-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb100-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb100-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb100-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb100-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb100-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb100-12">    )</span>
<span id="cb100-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb100-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of minivan selection"</span>,</span>
<span id="cb100-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb100-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb100-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb100-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb100-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb100-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb100-23">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-seat-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Here are all the AMCEs across carpool status:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1">amces_minivan_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb101-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> seat),</span>
<span id="cb101-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> cargo),</span>
<span id="cb101-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(eng, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> eng),</span>
<span id="cb101-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(price, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> price),</span>
<span id="cb101-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"term"</span></span>
<span id="cb101-23">)</span>
<span id="cb101-24"></span>
<span id="cb101-25">amces_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, carpool, contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb101-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 14 × 9</span></span>
<span id="cb101-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term  carpool contrast       avg  .lower   .upper .width .point .interval</span></span>
<span id="cb101-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt; &lt;fct&gt;   &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb101-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 cargo no      3ft - 2ft   0.0750  0.0358  0.117     0.95 median qi       </span></span>
<span id="cb101-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 cargo yes     3ft - 2ft   0.102   0.0555  0.152     0.95 median qi       </span></span>
<span id="cb101-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 eng   no      elec - gas -0.288  -0.400  -0.147     0.95 median qi       </span></span>
<span id="cb101-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 eng   no      hyb - gas  -0.160  -0.208  -0.108     0.95 median qi       </span></span>
<span id="cb101-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 eng   yes     elec - gas -0.273  -0.389  -0.125     0.95 median qi       </span></span>
<span id="cb101-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 eng   yes     hyb - gas  -0.166  -0.223  -0.104     0.95 median qi       </span></span>
<span id="cb101-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 price no      35 - 30    -0.167  -0.223  -0.107     0.95 median qi       </span></span>
<span id="cb101-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 price no      40 - 30    -0.294  -0.354  -0.230     0.95 median qi       </span></span>
<span id="cb101-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 price yes     35 - 30    -0.203  -0.270  -0.131     0.95 median qi       </span></span>
<span id="cb101-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 price yes     40 - 30    -0.342  -0.412  -0.272     0.95 median qi       </span></span>
<span id="cb101-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 seat  no      7 - 6      -0.162  -0.231  -0.0877    0.95 median qi       </span></span>
<span id="cb101-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 seat  no      8 - 6      -0.120  -0.219  -0.00669   0.95 median qi       </span></span>
<span id="cb101-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 seat  yes     7 - 6       0.0478 -0.0247  0.129     0.95 median qi       </span></span>
<span id="cb101-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 seat  yes     8 - 6       0.0912 -0.0114  0.207     0.95 median qi</span></span></code></pre></div>
</div>
<p>And finally, here’s a polisci-style plot of all these AMCEs, which is so so neat. An individual’s carpooling behavior interacts with seat count (increasing the seat count causes carpoolers to select the minivan more often), and it also interacts a bit with cargo space (increasing the cargo space makes both types of individuals more likely to select the minivan, but moreso for carpoolers) and also with price (increasing the price makes both types of individuals less likely to select the minivan, but moreso for carpoolers). Switching from gas → hybrid and gas → electric has a negative effect on both types of consumers, and there’s no carpooling-based difference.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1">minivan_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb102-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>)</span>
<span id="cb102-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb102-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans[[.x]]</span>
<span id="cb102-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb102-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb102-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb102-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb102-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb102-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb102-12">    }</span>
<span id="cb102-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb102-16"></span>
<span id="cb102-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb102-18">minivan_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb102-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb102-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passengers"</span>,</span>
<span id="cb102-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>,</span>
<span id="cb102-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Engine type"</span>,</span>
<span id="cb102-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Price (thousands of $)"</span></span>
<span id="cb102-24">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with marginalized posterior draws and make plot</summary>
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1">posterior_amces_minivan_carpool_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb103-3">    contrast,</span>
<span id="cb103-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb103-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb103-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb103-9"></span>
<span id="cb103-10">plot_data_minivan_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb103-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb103-12">    posterior_amces_minivan_carpool_nested,</span>
<span id="cb103-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb103-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb103-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the missing carpool values be "yes" for the reference category</span></span>
<span id="cb103-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(carpool, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>))</span>
<span id="cb103-21"></span>
<span id="cb103-22">plot_data_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb103-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb103-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb103-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb103-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb103-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb103-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb103-34">    )</span>
<span id="cb103-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb103-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of minivan selection"</span>,</span>
<span id="cb103-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb103-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs across respondent carpool status"</span>,</span>
<span id="cb103-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb103-42">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb103-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb103-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb103-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb103-47">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="tldr-moral-of-the-story" class="level1">
<h1>tl;dr: Moral of the story</h1>
<p>holy crap this might be the longest guide I’ve ever posted here. This is hard.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Main points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>OLS is nice and easy, but it fails to capture all the dynamics between sets of features and individual characteristics. Use multilevel multinomial models to account for all the heterogeneity in choices and individuals.</p></li>
<li><p>{brms} provides a powerful, easy-to-use frontend for running complex multilevel models in Stan. There’s no need to write raw Stan code if you don’t want to.</p></li>
<li><p>This is hard stuff. Multinomial logit models are complex and weird to work with. But the power and flexibility and richness is worth it.</p></li>
</ul>
</div>
</div>
<p>Here’s a general summary of the main code for all this, based on a hypothetical conjoint survey with three features, like this:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Brand (<code>brand</code>)</td>
<td style="text-align: left;">A, B, C</td>
</tr>
<tr class="even">
<td style="text-align: left;">Color (<code>color</code>)</td>
<td style="text-align: left;">Blue, red, yellow</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Size (<code>size</code>)</td>
<td style="text-align: left;">Small, large</td>
</tr>
</tbody>
</table>
<p>And imagine that we have data on respondent age (<code>resp_age</code>) and education (<code>resp_ed</code>).</p>
<ul>
<li><p>Specify a full luxury multilevel model with individual-level characteristics informing choice-level coefficients like this (see here):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb104-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb104-3">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Columns for feature interacted with respondent-level covariates</span></span>
<span id="cb104-4">      (brand <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> color <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> size) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (resp_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> resp_ed) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-5">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Respondent-specific intercepts and slopes for all features</span></span>
<span id="cb104-6">      (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> brand <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> color <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp_id)),</span>
<span id="cb104-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(),</span>
<span id="cb104-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data</span>
<span id="cb104-9">)</span></code></pre></div>
</div></li>
<li><p>Find marketing-style predicted shares for hypothetical mixes of products by feeding a smaller dataset of hypothetical mixes to <code>brms::posterior_linpred()</code> (or <code>tidybayes::linpred_draws()</code>) to find utility (or logit-scale predictions), then calculate the share for each draw, and then marginalize (or average) the shares across the multiple choices within each draw. (See here.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1">product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb105-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>brand, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>color,   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>size,   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resp_age,</span>
<span id="cb105-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blue"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Red"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellow"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Large"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blue"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>,</span>
<span id="cb105-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Red"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>,</span>
<span id="cb105-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellow"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Large"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span></span>
<span id="cb105-9">)</span>
<span id="cb105-10"></span>
<span id="cb105-11">model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linpred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category, resp_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the outcomes within each draw</span></span>
<span id="cb105-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, color, size, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share))</span></code></pre></div>
</div></li>
<li><p>Find political science-style marginal means and AMCEs by feeding a <em>complete grid of all possible feature levels</em>, along with any respondent-level characteristics of interest to <code>brms::posterior_epred()</code> (or <code>tidybayes::epred_draws()</code>), then filter those probabilities to look only at option 0 (i.e.&nbsp;not choosing an option), and calculate <code>1 - prediction</code> to reverse it. Then group by the feature level and respondent-level characteristics you’re interested in, find the average of predictions, and marginalize (or average) out the other covariates in each draw. (See here.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1">all_feature_combos_with_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(brand, color, size, resp_age)</span>
<span id="cb106-3"></span>
<span id="cb106-4">all_predictions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> all_feature_combos_with_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only look at category 0 and reverse predictions</span></span>
<span id="cb106-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span>
<span id="cb106-9"></span>
<span id="cb106-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginal means for brand across respondent age</span></span>
<span id="cb106-11">all_predictions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb106-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb106-15"></span>
<span id="cb106-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AMCEs for brand across respondent age</span></span>
<span id="cb106-17">all_predictions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb106-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> brand, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>)</span></code></pre></div>
</div></li>
</ul>
<hr>
<p>Fin.</p>


<!-- -->


</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ChapmanFeit:2019" class="csl-entry">
Chapman, Chris, and Elea McDonnell Feit. 2019. <em>R For Marketing Research and Analytics</em>. 2nd ed. Use R! Cham, Switzerland: Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-030-14316-9">https://doi.org/10.1007/978-3-030-14316-9</a>.
</div>
<div id="ref-ChaudhryDotsonHeiss:2021" class="csl-entry">
Chaudhry, Suparna, Marc Dotson, and Andrew Heiss. 2021. <span>“Who Cares about Crackdowns? Exploring the Role of Trust in Individual Philanthropy.”</span> <em>Global Policy</em> 12 (S5): 45–58. <a href="https://doi.org/10.1111/1758-5899.12984">https://doi.org/10.1111/1758-5899.12984</a>.
</div>
<div id="ref-GelmanHill:2007" class="csl-entry">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511790942">https://doi.org/10.1017/CBO9780511790942</a>.
</div>
<div id="ref-JensenMarbleScheve:2021" class="csl-entry">
Jensen, Amalie, William Marble, Kenneth Scheve, and Matthew J. Slaughter. 2021. <span>“City Limits to Partisan Polarization in the American Public.”</span> <em>Political Science Research and Methods</em> 9 (2): 223–41. <a href="https://doi.org/10.1017/psrm.2020.56">https://doi.org/10.1017/psrm.2020.56</a>.
</div>
<div id="ref-Kuhfeld:2010" class="csl-entry">
Kuhfeld, Warren F. 2010. <span>“Discrete Choice.”</span> SAS Technical Paper MR2010F. SAS Institute. <a href="http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html">http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {The Ultimate Practical Guide to Multilevel Multinomial
    Conjoint Analysis with {R}},
  date = {2023-08-12},
  url = {https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide},
  doi = {10.59350/2mz75-rrc46},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“The Ultimate Practical Guide to Multilevel
Multinomial Conjoint Analysis with R.”</span> August 12, 2023. <a href="https://doi.org/10.59350/2mz75-rrc46">https://doi.org/10.59350/2mz75-rrc46</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>statistics</category>
  <category>brms</category>
  <category>stan</category>
  <guid>https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index.html</guid>
  <pubDate>Fri, 11 Aug 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png" medium="image" type="image/png" height="120" width="144"/>
</item>
</channel>
</rss>
