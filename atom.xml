<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Andrew Heiss&#39;s blog</title>
<link>https://knuutila.net/atom.html</link>
<atom:link href="https://knuutila.net/atom.xml" rel="self" type="application/rss+xml"/>
<description>Andrew Heiss&#39;s blog</description>
<language>en</language>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Mon, 14 Aug 2023 21:00:00 GMT</lastBuildDate>
<item>
  <title>Manually generate predicted values for logistic regression with matrix multiplication in R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/index.html</link>
  <description><![CDATA[ 




<div class="page-columns page-full"><p>In a project I’m working on, I need to generate predictions from a logistic regression model. That’s typically a really straightforward task—we can just use <code>predict()</code> to plug a dataset of values into a model, which will spit out predictions either on the (gross, uninterpretable) log odds scale or on the (nice, interpretable) percentage-point scale.<sup>1</sup></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;And for pro-level predictions, use <code>predictions()</code> from <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html">{marginaleffects}</a>.</p></li></div></div>
<p>However, in this project I cannot use <code>predict()</code>—I’m working with a big matrix of posterior coefficient draws from a Bayesian model fit with raw Stan code, so there’s no special <code>predict()</code> function that will work. Instead, I need to use matrix multiplication and manually multiply a matrix of new data with a vector of slopes from the model.</p>
<p>I haven’t had to matrix multiply coefficients with data since my first PhD stats class back in 2012 and I’ve completely forgotten how.</p>
<p>I created this little guide as a reference for myself, and I figured it’d probably be useful for others, so up on the blog it goes (<a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/index.html">see the introduction to this post for more about my philosophy of public work</a>).</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/social-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Image generated with Bing Image Creator with the prompt “regression matrix multiplication in a sketchy style”</figcaption>
</figure>
</div>
<section id="example-1-logistic-regression-model-with-an-intercept-and-slopes" class="level2">
<h2 class="anchored" data-anchor-id="example-1-logistic-regression-model-with-an-intercept-and-slopes">Example 1: Logistic regression model with an intercept and slopes</h2>
<p>Here’s a basic regression model where we predict if a penguin is a Gentoo based on its bill length and body mass.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(palmerpenguins)</span>
<span id="cb1-2"></span>
<span id="cb1-3">penguins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-4">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(sex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_gentoo =</span> species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gentoo"</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb1-8">  is_gentoo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> body_mass_g,</span>
<span id="cb1-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins,</span>
<span id="cb1-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb1-11">)</span></code></pre></div>
</div>
<p>We can generate predicted values across different three different values of bill length: 40 mm, 44 mm, and 48 mm, holding body mass constant at the average (4207 g):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">data_to_plug_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bill_length_mm =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>),</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body_mass_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(penguins<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>body_mass_g)</span>
<span id="cb2-4">)</span>
<span id="cb2-5">data_to_plug_in</span>
<span id="cb2-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   bill_length_mm body_mass_g</span></span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1             40        4207</span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2             44        4207</span></span>
<span id="cb2-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3             48        4207</span></span></code></pre></div>
</div>
<p>We can feed this little dataset into the model using <code>predict()</code>, which can generate predictions as log odds (<code>type = "link"</code>) or probabilities (<code>type = "response"</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb3-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb3-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -2.097 -1.741 -1.385</span></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb3-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb3-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
<p>Yay, nice and easy.</p>
<p>Here’s how to do the same thing with manual matrix multiplication:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get all the coefficients</span></span>
<span id="cb4-2">(coefs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model))</span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    (Intercept) bill_length_mm    body_mass_g </span></span>
<span id="cb4-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     -32.401514       0.088906       0.006358</span></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split intercept and slope coefficients into separate objects</span></span>
<span id="cb4-7">(intercept <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coefs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       -32.4</span></span>
<span id="cb4-10">(slopes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coefs[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## bill_length_mm    body_mass_g </span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       0.088906       0.006358</span></span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the data frame of new data into a matrix</span></span>
<span id="cb4-15">(data_to_plug_in_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(data_to_plug_in))</span>
<span id="cb4-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      bill_length_mm body_mass_g</span></span>
<span id="cb4-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]             40        4207</span></span>
<span id="cb4-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,]             44        4207</span></span>
<span id="cb4-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [3,]             48        4207</span></span>
<span id="cb4-20"></span>
<span id="cb4-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the new data with the slope coefficients, then add the intercept</span></span>
<span id="cb4-22">(log_odds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>((data_to_plug_in_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> slopes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> intercept))</span>
<span id="cb4-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] -2.097 -1.741 -1.385</span></span>
<span id="cb4-24"></span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to probability scale</span></span>
<span id="cb4-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds)</span>
<span id="cb4-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
<p>The results are the same as <code>predict()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -2.097 -1.741 -1.385</span></span>
<span id="cb5-4">log_odds</span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] -2.097 -1.741 -1.385</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1      2      3 </span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 0.1094 0.1492 0.2002</span></span>
<span id="cb5-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds)</span>
<span id="cb5-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.1094 0.1492 0.2002</span></span></code></pre></div>
</div>
</section>
<section id="example-2-logistic-regression-model-with-a-categorical-predictor-and-no-intercept" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-2-logistic-regression-model-with-a-categorical-predictor-and-no-intercept">Example 2: Logistic regression model with a categorical predictor and no intercept</h2>
<p>This gets a little more complex when working with categorical predictors, especially if you’ve omitted the intercept term. For instance, in the data I’m working with, we have a model that looks something like this, with <code>0</code> added as a term to suppress the intercept and give separate coefficients for each of the levels of <code>sex</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">model_categorical <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb6-2">  is_gentoo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> body_mass_g,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb6-5">)</span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_categorical)</span>
<span id="cb6-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sexfemale        sexmale bill_length_mm    body_mass_g </span></span>
<span id="cb6-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      -75.68237      -89.88199        0.03387        0.01831</span></span></code></pre></div>
</div>
<p>When using <code>predict()</code>, we don’t have to do anything special with this intercept-free model. We can plug in a dataset with different variations of predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">data_to_plug_in_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"female"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"male"</span>),</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bill_length_mm =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>),</span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body_mass_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(penguins<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>body_mass_g)</span>
<span id="cb7-5">)</span>
<span id="cb7-6">data_to_plug_in_cat</span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sex bill_length_mm body_mass_g</span></span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 female             40        4207</span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2   male             40        4207</span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 female             44        4207</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4   male             44        4207</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 female             48        4207</span></span>
<span id="cb7-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6   male             48        4207</span></span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb7-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       1       2       3       4       5       6 </span></span>
<span id="cb7-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb7-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         1         2         3         4         5         6 </span></span>
<span id="cb7-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>
<p>If we want to do this manually, we have to create a matrix version of <code>data_to_plug_in_cat</code> that has separate columns for <code>sexfemale</code> and <code>sexmale</code>. We can’t just use <code>as.matrix(data_to_plug_in_cat)</code>, since that only has a single column for <code>sex</code> (and because that column contains text, it forces the rest of the matrix to be text, which makes it so we can’t do math with it anymore):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(data_to_plug_in_cat)</span>
<span id="cb8-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sex      bill_length_mm body_mass_g</span></span>
<span id="cb8-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] "female" "40"           "4207"     </span></span>
<span id="cb8-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,] "male"   "40"           "4207"     </span></span>
<span id="cb8-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [3,] "female" "44"           "4207"     </span></span>
<span id="cb8-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [4,] "male"   "44"           "4207"     </span></span>
<span id="cb8-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [5,] "female" "48"           "4207"     </span></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [6,] "male"   "48"           "4207"</span></span></code></pre></div>
</div>
<div class="page-columns page-full"><p>Instead, we can use <code>model.matrix()</code> to create a design matrix—also called a dummy-encoded matrix<sup>2</sup> or a one-hot encoded matrix—which makes columns of 0s and 1s for each of the levels of <code>sex</code></p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;Though we should probably quit using the word “dummy” because of its ableist connotations—see <a href="https://developers.google.com/style/word-list#dummy-variable">Google’s developer documentation style guide for alternatives</a>.</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">data_to_plug_in_cat_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(</span>
<span id="cb9-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data_to_plug_in_cat</span>
<span id="cb9-3">)</span>
<span id="cb9-4">data_to_plug_in_cat_mat</span>
<span id="cb9-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   sexfemale sexmale bill_length_mm body_mass_g</span></span>
<span id="cb9-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1         1       0             40        4207</span></span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2         0       1             40        4207</span></span>
<span id="cb9-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3         1       0             44        4207</span></span>
<span id="cb9-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4         0       1             44        4207</span></span>
<span id="cb9-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5         1       0             48        4207</span></span>
<span id="cb9-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6         0       1             48        4207</span></span>
<span id="cb9-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"assign")</span></span>
<span id="cb9-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 1 1 2 3</span></span>
<span id="cb9-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"contrasts")</span></span>
<span id="cb9-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## attr(,"contrasts")$sex</span></span>
<span id="cb9-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "contr.treatment"</span></span></code></pre></div>
</div>
<p>We can now do math with this matrix. Since we don’t have an intercept term, we don’t need to create separate objects for the slopes and intercepts and can matrix multiply the new data matrix with the model coefficients:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get all the coefficients</span></span>
<span id="cb10-2">(coefs_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_categorical))</span>
<span id="cb10-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      sexfemale        sexmale bill_length_mm    body_mass_g </span></span>
<span id="cb10-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      -75.68237      -89.88199        0.03387        0.01831</span></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the newdata with the slope coefficients</span></span>
<span id="cb10-7">(log_odds_cat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(data_to_plug_in_cat_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> coefs_cat))</span>
<span id="cb10-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1]   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to probability scale</span></span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds_cat)</span>
<span id="cb10-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>
<p>The results are the same!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>)</span>
<span id="cb11-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       1       2       3       4       5       6 </span></span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb11-4">log_odds_cat</span>
<span id="cb11-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1]   2.707 -11.493   2.842 -11.357   2.978 -11.222</span></span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(model_categorical, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> data_to_plug_in_cat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         1         2         3         4         5         6 </span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span>
<span id="cb11-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(log_odds_cat)</span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 9.374e-01 1.020e-05 9.449e-01 1.169e-05 9.516e-01 1.338e-05</span></span></code></pre></div>
</div>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {Manually Generate Predicted Values for Logistic Regression
    with Matrix Multiplication in {R}},
  date = {2023-08-15},
  url = {https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict},
  doi = {10.59350/qba9a-b3561},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“Manually Generate Predicted Values for
Logistic Regression with Matrix Multiplication in R.”</span> August 15,
2023. <a href="https://doi.org/10.59350/qba9a-b3561">https://doi.org/10.59350/qba9a-b3561</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>statistics</category>
  <category>regression</category>
  <guid>https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/index.html</guid>
  <pubDate>Mon, 14 Aug 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/08/15/matrix-multiply-logit-predict/social-image.png" medium="image" type="image/png" height="75" width="144"/>
</item>
<item>
  <title>The ultimate practical guide to multilevel multinomial conjoint analysis with R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index.html</link>
  <description><![CDATA[ 




<p>I recently <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">posted a guide</a> (mostly for future-me) about how to analyze conjoint survey data with R. I explore two different estimands that social scientists are interested in—causal average marginal component effects (AMCEs) and descriptive marginal means—and show how to find them with R, with both frequentist and Bayesian approaches.</p>
<p>However, that post is a little wrong. It’s not <em>wrong</em> wrong, but it is a bit oversimplified.</p>
<p>When political scientists, psychologists, economists, and other social scientists analyze conjoint data, they overwhelmingly do it with <a href="https://en.wikipedia.org/wiki/Ordinary_least_squares">ordinary least squares (OLS) regression</a>, or just standard linear regression (<code>lm(y ~ x)</code> in R; <code>reg y x</code> in Stata). Even if the outcome is binary, they’ll use OLS and call it a linear probability model. The main R package for working with conjoint data in a frequentist way (<a href="https://thomasleeper.com/cregg/">{cregg}</a>) uses OLS and linear probability models. Social scientists (and economists in particular) adore OLS.</p>
<figure class="figure">
<video controls="" loop="" width="90%" style="display: block; margin: auto;">
  <source src="img/parks-rec-ols.mp4" type="video/mp4">
</video>
<figcaption class="figure-caption">Video by <a href="https://twitter.com/theotheredmund/status/1349453230762196992">Edmund Helmer</a></figcaption>
</figure>
<p>In my earlier guide, <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/#the-overall-model">I showed how to analyze the data with logistic regression</a>, but even that is still overly simplified. In reality, conjoint choice-based experiments are more complex than what regular old OLS regression—or even logistic regression—can handle (though I’m sure some econometrician somewhere has a proof showing that OLS works just fine for multinomial conjoint data :shrug:).</p>
<p>A recent paper published in <em>Political Science Research and Methods</em> <span class="citation" data-cites="JensenMarbleScheve:2021">(Jensen et al. 2021)</span> does an excellent job explaining the problem with using plain old OLS to estimate AMCEs and marginal means with conjoint data (<a href="https://williammarble.co/docs/CityLimits-April2020.pdf">access the preprint here</a>). Their main argument boils down to this: OLS throws away too much useful information about (1) the relationships and covariance between the different combinations of feature levels offered to respondents, and (2) individual-specific differences in how respondents react to different feature levels.</p>
<p>Jensen et al.&nbsp;explain three different approaches to analyzing data that has a natural hierarchical structure like conjoint data (where lots of choices related to different “products” are nested within individuals). This also is the same argument from <a href="https://www.bayesrulesbook.com/chapter-15">chapter 15 of <em>Bayes Rules!</em></a>.</p>
<ol type="1">
<li><p><strong>Pooled data</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#ch15-complete">“no room for individuality”</a>): The easiest way to deal with individual-specific effects is to not to. Lump each choice by each respondent into one big dataset, run OLS on it, and be done. Believe it or not, linear regression right away.</p>
<p>However, this erases all individual-level heterogeneity and details about how different feature levels interact with individual characteristics.</p></li>
<li><p><strong>No pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#no-pooling">“every person for themselves”</a>): An alternative way to deal with individual-specific effects is to run a separate model for each individual. If 800 people participated in the experiment, run 800 different models. That way you can perfectly model the relationship between each individual’s characteristics (political party, age, income, education, etc.) with their choices and preferences.</p>
<p>This sounds neat, but has substantial issues. It’ll only show an identified causal effect if each respondent saw every combination of conjoint features at least once. In the candidate experiment <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">from my previous post</a>, there were 8 features with different counts of attributes: 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6 = 186,624 possibilities. Every respondent would need to see each of the nearly 200,000 options. lol.</p></li>
<li><p><strong>Partial pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#partial-pooling-with-hierarchical-models">“a welcome middle ground”</a>): Jensen et al.’s solution is to use hierarchical models that allow individual-level characteristics to inform choice-level decisions. As <em>Bayes Rules!</em> says:</p>
<blockquote class="blockquote">
<p>[T]hough each group is <em>unique</em>, having been sampled from the same population, all groups are connected and thus might contain valuable information about one another.</p>
</blockquote>
<p>In this kind of model, we want individual-level characteristics like age, income, education, etc. to inform the decision to choose specific outcomes and interact with different feature levels in different ways. Not every respondent needs to have seen all 200,000 options—information about respondents with similar characteristics facing similar sets of choices gets shared because of the hierarchical-ness of the model.</p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Best overview of multilevel models
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overviews I’ve found of how multilevel models work, check out these two resources:</p>
<ul>
<li>Chapters 15–17 in <a href="https://www.bayesrulesbook.com/"><em>Bayes Rules!</em></a> (<a href="https://www.bayesrulesbook.com/chapter-17">especially chapter 17</a>)</li>
<li>Michael Clark’s <a href="https://m-clark.github.io/mixed-models-with-R/"><em>Mixed Models with R</em> guide</a></li>
</ul>
<p><a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">I also have a guide here</a>, but it’s nowhere near as good as those ↑</p>
</div>
</div>
<p>By using a multilevel hierarchical model, <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (2021)</span> show that we can still find AMCEs and causal effects, just like in my previous guide, but we can take advantage of the far richer heterogeneity that we get from these complex statements. We can make cool statements like this (in an experiment that varied policies related to unions):</p>
<blockquote class="blockquote">
<p>On average, Democrats are <img src="https://latex.codecogs.com/png.latex?x"> percentage points more likely than demographically similar Republicans to support a plan that includes expanding union power, relative to the status quo.</p>
</blockquote>
<p>Using hierarchical models for conjoint experiments in political science is new and exciting and revolutionary and neat. That’s the whole point of Jensen et al.’s paper—it’s a call to stop using OLS for everything.</p>
<p>I’ve been working on a conjoint experiment with my coauthors <a href="https://marriott.byu.edu/directory/details?id=50683">Marc Dotson</a> and <a href="https://www.suparnachaudhry.com/">Suparna Chaudhry</a>. Suparna and I are political scientists and this multilevel stuff in general is still relatively new and wildly underused in the discipline. Marc, though, is a marketing scholar. The marketing world has been using hierarchical models for conjoint experiments for a long time and it’s standard practice in that discipline. There’s a whole textbook about the hierarchical model approach in marketing <span class="citation" data-cites="ChapmanFeit:2019">(Chapman and Feit 2019)</span>, and these fancy conjoint multilevel models are used widely throughout the marketing industry.</p>
<p>lol at political science, just now discovering this.</p>
<hr>
<p>So, I need to expand <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">my previous conjoint guide</a>. That’s what this post is for.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with linear regression and packages like <a href="https://broom.tidymodels.org/">{broom}</a> for converting regression results into tidy data frames and <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> for calculating <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">marginal effects</a>.</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws. You <em>don’t</em> need to know how to write stuff in raw Stan.</li>
</ul>
</div>
</div>
<p>I’ll do three things in this guide:</p>
<ol type="1">
<li><strong>Chocolate</strong>: Analyze a simple choice-based conjoint experiment where respondents only saw one set of options. This is so I can (1) explore the {mlogit} package, and (2) figure out how to work with multinomial models and predictions both frequentistly and Bayesianly.</li>
<li><strong>Minivans</strong>: Analyze a more complex choice-based conjoint experiment where respondents saw three randomly selected options fifteen times. I do this with both {mlogit} and {brms} to figure out how to work with true multinomial outcomes both frequentistly and Bayesianly.</li>
<li><strong>Minivans again</strong>: Analyze the same complex choice-based experiment but incorporate respondent-level characteristics into the estimates using a hierarchical or multilevel model. I only do this with {brms} because in reality I have no interest in working with {mlogit} (I only use it here as a sort of baseline for my {brms} explorations).</li>
</ol>
<p>Throughout this example, I’ll use data from two different simulated conjoint choice experiments. You can download these files and follow along:</p>
<ul>
<li><a href="data/choco_candy.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>choco_candy.csv</code></a>: This is simulated data for a hypothetical experiment about consumer preferences for candy features. It comes from p.&nbsp;292 in <span class="citation" data-cites="Kuhfeld:2010">Kuhfeld (2010)</span>, a <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">SAS technical note</a> about how to run multinomial models in SAS. Instead of copying/pasting from the PDF, <a href="https://github.com/sangwoo-statistics/dataset">I found a version of it here</a>, cleaned up by Sangwoo Kim (who also has <a href="https://www.youtube.com/watch?v=ra8Y2FjRqOE">a YouTube tutorial</a> using the same candy data)</li>
<li><a href="data/choco_candy.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>rintro-chapter13conjoint.csv</code></a>: This is simultated data for a hypothetical experiment about consumer preferences for minivan features. It comes from chapter 13 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> and is available from the <a href="http://r-marketing.r-forge.r-project.org/">book’s resources page</a> (or <a href="http://r-marketing.r-forge.r-project.org/data/">directly from their data folder</a>)</li>
</ul>
<p>Additionally, in Part 3, I fit a huge Stan model with {brms} that takes ≈30 minutes to run on my fast laptop. If you want to follow along and not melt your CPU for half an hour, you can download an .rds file of that fitted model that I stuck in <a href="https://osf.io/3y7es/">an OSF project</a>. The code for <code>brm()</code> later in this guide will load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(osfr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interact with OSF via R</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb1-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>)) { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>) }</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_retrieve_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://osf.io/zp6eh"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_download</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conflicts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overwrite"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<p>Let’s load some libraries, create some helper functions, load the data, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert model objects to tidy data frames</span></span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(parameters)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show model results as nice tables</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(survey)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Panel-ish frequentist regression models</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mlogit)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Frequentist multinomial regression models</span></span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dfidx)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Structure data for {mlogit} models</span></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate marginal effects</span></span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggforce)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For facet_col()</span></span>
<span id="cb2-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The best formula-based interface to Stan</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Manipulate Stan results in tidy ways</span></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdist)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fancy distribution plots</span></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine ggplot plots</span></span>
<span id="cb2-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rcartocolor)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Color palettes from CARTOColors (https://carto.com/carto-colors/)</span></span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://github.com/intel/clear-sans</span></span>
<span id="cb2-18">theme_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb2-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb2-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb2-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clear Sans"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb2-25">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb2-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb2-27">}</span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>())</span>
<span id="cb2-30"></span>
<span id="cb2-31">clrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">carto_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prism"</span>)</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions for formatting things as percentage points</span></span>
<span id="cb2-34">label_pp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb2-35">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" pp."</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_negative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minus"</span>)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">chocolate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/choco_candy.csv"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(dark, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>),</span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dark, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>)),</span>
<span id="cb3-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(soft, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>),</span>
<span id="cb3-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(soft, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>)),</span>
<span id="cb3-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(nuts, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>),</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(nuts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>))</span>
<span id="cb3-9">  )</span>
<span id="cb3-10"></span>
<span id="cb3-11">minivans <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/rintro-chapter13conjoint.csv"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(seat, cargo, price), factor),</span>
<span id="cb3-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(carpool, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>)),</span>
<span id="cb3-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>))</span>
<span id="cb3-16">  )</span></code></pre></div>
</div>
<p>&nbsp;</p>
<section id="part-1-candy-single-question-basic-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 1: Candy; single question; basic multinomial logit</h1>
<section id="the-setup" class="level2">
<h2 class="anchored" data-anchor-id="the-setup">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these kinds of candies they’d want to buy. Respondents only see this question one time and all possible options are presented simultaneously.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="table">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
<th style="text-align: center;">G</th>
<th style="text-align: center;">H</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Chocolate</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
</tr>
<tr class="even">
<td>Center</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
</tr>
<tr class="odd">
<td>Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
</tr>
<tr class="even">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>The data for this kind of experiment looks like this, with one row for each possible alternative (so eight rows per person, or <code>subj</code>), with the alternative that was selected marked as 1 in <code>choice</code>. Here, Subject 1 chose option E (dark, chewy, no nuts). There were 10 respondents, with 8 rows each, so there are 10 × 8 = 80 rows.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">chocolate</span>
<span id="cb4-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 80 × 6</span></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     subj choice alt   dark  soft  nuts   </span></span>
<span id="cb4-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  </span></span>
<span id="cb4-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1     1      0 A     Milk  Chewy No nuts</span></span>
<span id="cb4-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2     1      0 B     Milk  Chewy Nuts   </span></span>
<span id="cb4-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3     1      0 C     Milk  Soft  No nuts</span></span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4     1      0 D     Milk  Soft  Nuts   </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5     1      1 E     Dark  Chewy No nuts</span></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6     1      0 F     Dark  Chewy Nuts   </span></span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7     1      0 G     Dark  Soft  No nuts</span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8     1      0 H     Dark  Soft  Nuts   </span></span>
<span id="cb4-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9     2      0 A     Milk  Chewy No nuts</span></span>
<span id="cb4-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10     2      0 B     Milk  Chewy Nuts   </span></span>
<span id="cb4-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 70 more rows</span></span></code></pre></div>
</div>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>Respondents were shown eight different options and asked to select one. While this seems like a binary yes/no choice that could work with just regular plain old logistic regression, we want to account for the features and levels in all the unchosen categories too. To do this, we can use <a href="https://en.wikipedia.org/wiki/Multinomial_logistic_regression">multinomial logistic regression</a>, where the outcome variable is an unordered categorical variable with more than two categories. In this case we have eight different possible outcomes: alternatives A through H.</p>
<section id="original-sas-model-as-a-baseline" class="level3">
<h3 class="anchored" data-anchor-id="original-sas-model-as-a-baseline">Original SAS model as a baseline</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol SAS
</div>
</div>
<div class="callout-body-container callout-body">
<p>I know nothing about SAS. I have never opened SAS in my life. It is a mystery to me.</p>
<p>I copied these results directly from p.&nbsp;297 in SAS’s massive <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">“Discrete Choice” technical note</a> <span class="citation" data-cites="Kuhfeld:2010">(Kuhfeld 2010)</span>.</p>
<p>I only have this SAS output here as a baseline reference for what the actual correct coefficients are supposed to be.</p>
</div>
</div>
<p>SAS apparently fits these models with proportional hazard survival-style models, which feels weird, but there’s probably a mathematical or statistical reason for it. You use PROC PHREG to do it:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1">proc phreg data=chocs outest=betas;</span>
<span id="cb5-2">   strata subj set;</span>
<span id="cb5-3">   model c*c(2) = dark soft nuts / ties=breslow;</span>
<span id="cb5-4">   run;</span></code></pre></div>
<p>It gives these results:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1">                   Choice of Chocolate Candies</span>
<span id="cb6-2"></span>
<span id="cb6-3">                       The PHREG Procedure</span>
<span id="cb6-4"></span>
<span id="cb6-5">              Multinomial Logit Parameter Estimates</span>
<span id="cb6-6">              </span>
<span id="cb6-7">                      Parameter     Standard</span>
<span id="cb6-8">                 DF    Estimate        Error  Chi-Square   Pr &gt; ChiSq</span>
<span id="cb6-9">Dark Chocolate   1      1.38629      0.79057      3.0749       0.0795</span>
<span id="cb6-10">Soft Center      1     -2.19722      1.05409      4.3450       0.0371</span>
<span id="cb6-11">With Nuts        1      0.84730      0.69007      1.5076       0.2195</span></code></pre></div>
</section>
<section id="survival-model" class="level3">
<h3 class="anchored" data-anchor-id="survival-model">Survival model</h3>
<p>Ew, enough SAS. Let’s do this with R instead.</p>
<p>We can recreate the same proportional hazards model with <code>coxph()</code> from the {survival} package. Again, this feels weird and not like an intended purpose of survival models and not like multinomial logit at all—in my mind it is neither (1) multinomial nor (2) logit, but whatever. People far smarter than me invented these things, so I’ll just trust them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">model_chocolate_survival <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coxph</span>(</span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Surv</span>(subj, choice) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts, </span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate, </span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"breslow"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is what SAS uses</span></span>
<span id="cb7-5">)</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_survival, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Coefficient |     SE |         95% CI |       z |      p</span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ----------------------------------------------------------------------</span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |      1.3863 | 0.7906 | [-0.16,  2.94] |  1.7535 | 0.0795</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |     -2.1972 | 1.0541 | [-4.26, -0.13] | -2.0845 | 0.0371</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |      0.8473 | 0.6901 | [-0.51,  2.20] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>The coefficients, standard errors, and p-values are identical to the SAS output! The only difference is the statistic: in SAS they use a chi-square statistic, while <code>survival:coxph()</code> uses a z statistic. There’s probably a way to make <code>coxph()</code> use a chi-square statistic, but I don’t care about that. I never use survival models and I’m only doing this to replicate the SAS output and it just doesn’t matter.</p>
</section>
<section id="poisson-model" class="level3">
<h3 class="anchored" data-anchor-id="poisson-model">Poisson model</h3>
<p>An alternative way to fit a multinomial logit model without resorting to survival models is to actually (mis?)use another model family. We can use a Poisson model, even though <code>choice</code> isn’t technically count data, because of obscure stats reasons. <a href="https://online.stat.psu.edu/stat504/lesson/2/2.3/2.3.6">See here</a> for an illustration of the relationship between multinomial and Poisson distributions; or <a href="https://doi.org/10.1093/biomet/asr026">see this 2011 <em>Biometrika</em> paper</a> about using Poisson models to reduce bias in multinomial logit models. Richard McElreath has a subsection about this in <em>Statistical Rethinking</em> as well: “Multinomial in disguise as Poisson” (11.3.3). Or <a href="https://bsky.app/profile/rmcelreath.bsky.social/post/3k4e5s6zbxc2j">as he said over on the currently-walled-garden Bluesky</a>, “All count distributions are just one or more Poisson distributions in a trench coat.”</p>
<p>To account for the repeated subjects in the data, we’ll use <code>svyglm()</code> from the {survey} package so that the standard errors are more accurate.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">model_chocolate_poisson <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb8-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts, </span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate, </span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poisson</span>()</span>
<span id="cb8-5">)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_poisson, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Mean |     SE |         95% CI |       z |      p</span></span>
<span id="cb8-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------</span></span>
<span id="cb8-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) |  -2.9188 | 0.8628 | [-4.97, -1.49] | -3.3829 | 0.0007</span></span>
<span id="cb8-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |   1.3863 | 0.7906 | [ 0.00,  3.28] |  1.7535 | 0.0795</span></span>
<span id="cb8-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |  -2.1972 | 1.0541 | [-5.11, -0.53] | -2.0845 | 0.0371</span></span>
<span id="cb8-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.43,  2.38] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>Lovely—the results are the same.</p>
</section>
<section id="mlogit-model" class="level3">
<h3 class="anchored" data-anchor-id="mlogit-model"><code>mlogit</code> model</h3>
<p>Finally, we can use the {mlogit} package to fit the model. Before using <code>mlogit()</code>, we need to transform our data a bit to specify which column represents the choice (<code>choice)</code> and how the data is indexed: subjects (<code>subj</code>) with repeated alternatives (<code>alt</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">chocolate_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dfidx</span>(</span>
<span id="cb9-2">  chocolate,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subj"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alt"</span>),</span>
<span id="cb9-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice"</span>,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span></span>
<span id="cb9-6">)</span></code></pre></div>
</div>
<p>We can then use this indexed data frame with <code>mlogit()</code>, which uses the familiar R formula interface, but with some extra features separated by <code>|</code>s</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1">outcome ~ features | individual-level variables | alternative-level variables</span></code></pre></div>
<p>If we had columns related to individual-level characteristics or alternative-level characteristics, we could include those in the model—and we’ll do precisely that later in this post. (Incorporating individual-level covariates is the whole point of this post!)</p>
<p>Let’s fit the model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">model_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb11-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb11-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate_idx</span>
<span id="cb11-4">)</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Odds |     SE |         95% CI |       z |      p</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------</span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dark [Dark] |   1.3863 | 0.7906 | [-0.16,  2.94] |  1.7535 | 0.0795</span></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## soft [Soft] |  -2.1972 | 1.0541 | [-4.26, -0.13] | -2.0845 | 0.0371</span></span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.51,  2.20] |  1.2279 | 0.2195</span></span></code></pre></div>
</div>
<p>Delightful. All the results are the same as the survival model and the Poisson model.</p>
</section>
<section id="bayesian-model" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-model">Bayesian model</h3>
<p>We can also fit this model in a Bayesian way using {brms}. Stan has a categorical distribution family for multinomial models, and we’ll use it in the next example. For now, for the sake of simplicity, we’ll use a Poisson family, since, as we saw above, that’s a legal way of parameterizing multinomial distributions.</p>
<p>The data has a natural hierarchical structure to it, with 8 choices (for alternatives A through H) nested inside each of the 10 subjects.</p>
<div class="cell" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/chocolate-multilevel-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with candy choices <img src="https://latex.codecogs.com/png.latex?y_%7B%5Ctext%7BA%7D%5Cdots%5Ctext%7BH%7D%7D"> nested in subjects</figcaption>
</figure>
</div>
</div>
</div>
<p>We want to model candy choice (<code>choice</code>) based on candy characteristics (<code>dark</code>, <code>soft</code>, and <code>nuts</code>). We’ll use the subscript <img src="https://latex.codecogs.com/png.latex?i"> to refer to individual candy choices and <img src="https://latex.codecogs.com/png.latex?j"> to refer to subjects.</p>
<p>Since we can legally pretend that this multinomial selection process is actually Poisson, we’ll model it as a Poisson process that has a rate of <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7Bi_j%7D">. We’ll model that <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7Bi_j%7D"> with a log-linked regression model with covariates for each of the levels of each candy feature. To account for the multilevel structure, we’ll include subject-specific offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">) from the global average, thus creating random intercepts. We’ll specify fairly wide priors just because.</p>
<p>Here’s the formal model for all this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BProbability%20of%20selection%20of%20alternative%7D_i%20%5Ctextbf%7B%20in%20subject%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BPoisson%7D(%5Clambda_%7Bi_j%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5Clog(%5Clambda_%7Bi_j%7D)%20=&amp;%5C%20(%5Cbeta_0%20+%20b_%7B0_j%7D)%20+%20%5Cbeta_1%20%5Ctext%7BDark%7D_%7Bi_j%7D%20+%20%5Cbeta_2%20%5Ctext%7BSoft%7D_%7Bi_j%7D%20+%20%5Cbeta_3%20%5Ctext%7BNuts%7D_%7Bi_j%7D%20%5C%5C%5B5pt%5D%0Ab_%7B0_j%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%5Cqquad%5Cqquad%5Cquad%20%5Ctext%7BSubject-specific%20offsets%20from%20global%20choice%20probability%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_0%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%203)%20%5Cqquad%5Cqquad%5Cquad%5C%20%5C%20%5Ctext%7BPrior%20for%20global%20average%20choice%20probability%7D%20%5C%5C%0A%5Cbeta_1,%20%5Cbeta_2,%20%5Cbeta_3%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%203)%20%5Cqquad%5Cqquad%5Cquad%5C%20%5C%20%5Ctext%7BPrior%20for%20candy%20feature%20levels%7D%20%5C%5C%0A%5Csigma_0%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cqquad%20%5Ctext%7BPrior%20for%20between-subject%20variability%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>And here’s the {brms} model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">model_chocolate_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dark <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> soft <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> nuts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> subj)),</span>
<span id="cb12-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> chocolate,</span>
<span id="cb12-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poisson</span>(),</span>
<span id="cb12-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb12-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> Intercept),</span>
<span id="cb12-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b),</span>
<span id="cb12-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd)</span>
<span id="cb12-9">  ),</span>
<span id="cb12-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb12-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_chocolate_brms"</span></span>
<span id="cb12-13">)</span></code></pre></div>
</div>
<p>The results are roughly the same as what we found with all the other models—they’re slightly off because of random MCMC sampling.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_chocolate_brms)</span>
<span id="cb13-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Fixed Effects</span></span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ----------------------------------------------------------------</span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept) |  -3.04 | [-5.07, -1.60] |   100% | 1.000 | 3598.00</span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## darkDark    |   1.35 | [-0.05,  3.16] | 96.92% | 1.000 | 4238.00</span></span>
<span id="cb13-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## softSoft    |  -2.03 | [-4.35, -0.47] | 99.60% | 1.000 | 2867.00</span></span>
<span id="cb13-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nutsNuts    |   0.83 | [-0.40,  2.27] | 90.28% | 1.000 | 4648.00</span></span></code></pre></div>
</div>
</section>
</section>
<section id="predictions" class="level2">
<h2 class="anchored" data-anchor-id="predictions">Predictions</h2>
<p>In the SAS technical note example, they use the model to generated predicted probabilities of the choice of each of the options. In the world of marketing, this can also be seen as the predicted market share for each option. To do this, they plug each of the eight different different combinations of dark, soft, and nuts into the model and calculate the predicted output on the response (i.e.&nbsp;probability) scale. They get these results, where dark, chewy, and nuts is the most likely and popular option (commanding a 50% market share).</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb14-1">      Choice of Chocolate Candies</span>
<span id="cb14-2"></span>
<span id="cb14-3">Obs    Dark    Soft     Nuts       p</span>
<span id="cb14-4"></span>
<span id="cb14-5">  1    Dark    Chewy    Nuts       0.50400</span>
<span id="cb14-6">  2    Dark    Chewy    No Nuts    0.21600</span>
<span id="cb14-7">  3    Milk    Chewy    Nuts       0.12600</span>
<span id="cb14-8">  4    Dark    Soft     Nuts       0.05600</span>
<span id="cb14-9">  5    Milk    Chewy    No Nuts    0.05400</span>
<span id="cb14-10">  6    Dark    Soft     No Nuts    0.02400</span>
<span id="cb14-11">  7    Milk    Soft     Nuts       0.01400</span>
<span id="cb14-12">  8    Milk    Soft     No Nuts    0.00600</span></code></pre></div>
<p>We can do the same thing with R.</p>
<section id="frequentist-predictions" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-predictions">Frequentist predictions</h3>
<p>{mlogit} model objects have predicted values stored in one of their slots (<code>model_chocolate_mlogit$probabilities</code>), but they’re in a weird non-tidy matrix form and I like working with tidy data. I’m also a huge fan of <a href="https://vincentarelbundock.github.io/marginaleffects/">the {marginaleffects} package</a>, which provides a consistent way to calculate predictions, comparisons, and slopes/marginal effects (with <code>predictions()</code>, <code>comparisons()</code>, and <code>slopes()</code>) for dozens of kinds of models, including <code>mlogit()</code> models.</p>
<p>So instead of wrangling the built-in <code>mlogit()</code> probabilities, we’ll generate predictions by feeding the model the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code> to <code>marginaleffects::predictions()</code>, which will provide us with probability- or proportion-scale predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">preds_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb15-2">  model_chocolate_mlogit, </span>
<span id="cb15-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb15-4">)</span>
<span id="cb15-5"></span>
<span id="cb15-6">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions() hides a bunch of columns; forcing it to be a tibble unhides them</span></span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(group, dark, soft, nuts, estimate, std.error, statistic, p.value)</span>
<span id="cb15-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 8</span></span>
<span id="cb15-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   group dark  soft  nuts    estimate std.error statistic  p.value</span></span>
<span id="cb15-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb15-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 F     Dark  Chewy Nuts     0.504     0.142       3.56  0.000373</span></span>
<span id="cb15-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 E     Dark  Chewy No nuts  0.216     0.112       1.93  0.0540  </span></span>
<span id="cb15-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 B     Milk  Chewy Nuts     0.126     0.0849      1.48  0.138   </span></span>
<span id="cb15-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 H     Dark  Soft  Nuts     0.0560    0.0551      1.02  0.309   </span></span>
<span id="cb15-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 A     Milk  Chewy No nuts  0.0540    0.0433      1.25  0.213   </span></span>
<span id="cb15-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 G     Dark  Soft  No nuts  0.0240    0.0258      0.929 0.353   </span></span>
<span id="cb15-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 D     Milk  Soft  Nuts     0.0140    0.0162      0.863 0.388   </span></span>
<span id="cb15-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 C     Milk  Soft  No nuts  0.00600   0.00743     0.808 0.419</span></span></code></pre></div>
</div>
<p>Perfect! They’re identical to the SAS output.</p>
<p>We can play around with these predictions to describe the overall market for candy. Chewy candies dominate the market…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(estimate))</span>
<span id="cb16-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb16-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  share</span></span>
<span id="cb16-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;dbl&gt;</span></span>
<span id="cb16-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk  0.200</span></span>
<span id="cb16-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark  0.800</span></span></code></pre></div>
</div>
<p>…and dark chewy candies are by far the most popular:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark, soft) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(estimate))</span>
<span id="cb17-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb17-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   dark [2]</span></span>
<span id="cb17-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  soft   share</span></span>
<span id="cb17-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb17-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk  Chewy 0.180 </span></span>
<span id="cb17-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Milk  Soft  0.0200</span></span>
<span id="cb17-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Dark  Chewy 0.720 </span></span>
<span id="cb17-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Dark  Soft  0.0800</span></span></code></pre></div>
</div>
</section>
<section id="bayesian-predictions" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-predictions">Bayesian predictions</h3>
<p>{marginaleffects} supports {brms} models too, so we can basically run the same <code>predictions()</code> function to generate predictions for our Bayesian model. Magical.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol subject offsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When plugging values into <code>predictions()</code> (or <code>avg_slopes()</code> or any function that calculates predictions from a model), we have to decide how to handle the random subject offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">). <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary">I have a whole other blog post guide about this</a> and how absolutely maddening the nomenclature for all this is.</p>
<p>By default, <code>predictions()</code> and friends will calculate predictions for subjects on average by using the <code>re_formula = NULL</code> argument. This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average subject. When working with slopes, this is also called a <em>marginal effect</em>.</p>
<p>We could also use <code>re_formula = NA</code> to calculate predictions for a typical subject, or a subject where the random offset is set to 0. When working with slopes, this is also called a <em>conditional effect</em>.</p>
<ul>
<li>Conditional predictions/effect = average subject = <code>re_formula = NA</code></li>
<li>Marginal predictions/effect = subjects on average = <code>re_formula = NULL</code> (default), using existing subject levels or a new simulated subject</li>
</ul>
<p>Again, <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects">see this guide for way more about these distinctions</a>. In this example here, we’ll just use the default marginal predictions/effects (<code>re_formula = NULL</code>), or the effect for subjects on average.</p>
</div>
</div>
<p>The predicted proportions aren’t identical to the SAS output, but they’re close enough, given that it’s a completely different modeling approach.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">preds_chocolate_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb18-2">  model_chocolate_brms, </span>
<span id="cb18-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb18-4">) </span>
<span id="cb18-5"></span>
<span id="cb18-6">preds_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(dark, soft, nuts, estimate, conf.low, conf.high)</span>
<span id="cb18-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 6</span></span>
<span id="cb18-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  soft  nuts    estimate conf.low conf.high</span></span>
<span id="cb18-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb18-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Dark  Chewy Nuts     0.432   0.144       1.09  </span></span>
<span id="cb18-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark  Chewy No nuts  0.186   0.0424      0.571 </span></span>
<span id="cb18-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Milk  Chewy Nuts     0.110   0.0168      0.419 </span></span>
<span id="cb18-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Dark  Soft  Nuts     0.0553  0.00519     0.279 </span></span>
<span id="cb18-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Milk  Chewy No nuts  0.0465  0.00552     0.219 </span></span>
<span id="cb18-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Dark  Soft  No nuts  0.0230  0.00182     0.141 </span></span>
<span id="cb18-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 Milk  Soft  Nuts     0.0136  0.00104     0.0881</span></span>
<span id="cb18-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 Milk  Soft  No nuts  0.00556 0.000326    0.0414</span></span></code></pre></div>
</div>
</section>
<section id="plots" class="level3">
<h3 class="anchored" data-anchor-id="plots">Plots</h3>
<p>Since <code>predictions()</code> returns a tidy data frame, we can plot these predicted probabilities (or market shares or however we want to think about them) with {ggplot2}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_sentence</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dark} chocolate, {soft} interior, {nuts}"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb19-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted probability of selection"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb19-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist {mlogit} predictions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb19-12"></span>
<span id="cb19-13">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the posterior draws of the predictions</span></span>
<span id="cb19-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_sentence</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dark} chocolate, {soft} interior, {nuts}"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> label)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>])  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb19-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted probability of selection"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb19-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bayesian {brms} predictions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the x-axis match the mlogit plot</span></span>
<span id="cb19-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>))</span>
<span id="cb19-27"></span>
<span id="cb19-28">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-chocolate-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="amces" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="amces">AMCEs</h2>
<p>The marketing world doesn’t typically look at coefficients or marginal effects, but the political science world definitely does. In political science, the estimand we often care about the most is the average marginal component effect (AMCE), or the causal effect of moving one feature level to a different value, holding all other features constant. <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">I have a whole in-depth blog post about AMCEs and how to calculate them</a>—go look at that for more details. Long story short—AMCEs are basically the coefficients in a regression model.</p>
<p>Interpreting the coefficients is difficult with models that aren’t basic linear regression. Here, all these coefficients are on the log scale, so they’re not directly interpretable. The original SAS technical note also doesn’t really interpret any of these , they don’t really interpret these things anyway, since they’re more focused on predictions. All they say is this:</p>
<blockquote class="blockquote">
<p>The parameter estimate with the smallest <em>p</em>-value is for soft center. Since the parameter estimate is negative, chewy is the more preferred level. Dark is preferred over milk, and nuts over no nuts, however only the <em>p</em>-value for Soft is less than 0.05.</p>
</blockquote>
<p>We could exponentiate the coefficients to make them multiplicative (akin to odds ratios in logistic regression). For center = soft, <img src="https://latex.codecogs.com/png.latex?e%5E%7B-2.19722%7D"> = 0.1111, which means that candies with a soft center are 89% less likely to be chosen than candies with a chewy center, relative to the average candy. But that’s weird to think about.</p>
<p>So instead we can turn to {marginaleffects} once again to calculate percentage-point scale estimands that we can interpret far more easily.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol marginal effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nobody is ever consistent about the word “marginal effect.” Some people use it to refer to averages; some people use it to refer to slopes. These are complete opposites. In calculus, averages = integrals and slopes = derivatives and they’re the inverse of each other.</p>
<p>I like to think of marginal effects as what happens to the outcome when you move an explanatory variable a tiny bit. With continuous variables, that’s a slope; with categorical variables, that’s an offset in average outcomes. These correspond directly to how you normally interpret regression coefficients. Or returning to <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards">my favorite analogy about regression</a>, with numeric variables we care what happens to the outcome when we slide the value up a tiny bit; with categorical variables we care about what happens to the outcome when we switch on a category.</p>
<p>Additionally, there are like a billion different ways to calculate marginal effects: average marginal effects (AMEs), group-average marginal effects (G-AMEs), marginal effects at user-specified values, marginal effects at the mean (MEM), and counterfactual marginal effects. See <a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">the documentation for {marginaleffects}</a> + <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this mega blog post</a> for more about these subtle differences.</p>
</div>
</div>
<section id="bayesian-comparisonscontrasts" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts">Bayesian comparisons/contrasts</h3>
<p>We can use <code>avg_comparisons()</code> to calculate the difference (or average marginal effect) for each of the categorical coefficients on the percentage-point scale, showing the effect of moving from milk → dark, chewy → soft, and nuts → no nuts.</p>
<p>(Technically we can also use <code>avg_slopes()</code>, even though none of these coefficients are actually slopes. {marginaleffects} is smart enough to show contrasts for categorical variables and partial derivatives/slopes for continuous variables.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model_chocolate_brms)</span>
<span id="cb20-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb20-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Term       Contrast Estimate    2.5 %  97.5 %</span></span>
<span id="cb20-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  dark Dark - Milk       0.139 -0.00551  0.3211</span></span>
<span id="cb20-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  nuts Nuts - No nuts    0.092 -0.05221  0.2599</span></span>
<span id="cb20-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  soft Soft - Chewy     -0.182 -0.35800 -0.0523</span></span>
<span id="cb20-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb20-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, contrast, estimate, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>When holding all other features constant, moving from chewy → soft is associated with a posterior median 18 percentage point decrease in the probability of selection (or drop in market share if you want to think of it that way), on average.</p>
</section>
<section id="frequentist-comparisonscontrasts" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts">Frequentist comparisons/contrasts</h3>
<p>We went out of order in this section and showed how to use <code>avg_comparisons()</code> with the Bayesian model first instead of the frequentist model. That’s because it was easy. <code>mlogit()</code> models <a href="https://vincentarelbundock.github.io/marginaleffects/articles/categorical.html#mlogit-package">behave strangely with {marginaleffects}</a> because {mlogit} forces its predictions to use every possible value of the alternatives A–H. Accordingly, the estimate for any coefficients in the attributes section of the {mlogit} formula (<code>dark</code>, <code>soft</code>, and <code>nuts</code> here) will automatically be zero. Note how here there are 24 rows of comparisons instead of 3, since we get comparisons in each of the 8 groups, and note how the estimates are all zero:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model_chocolate_mlogit)</span>
<span id="cb21-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb21-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Term       Contrast  Estimate Std. Error         z Pr(&gt;|z|)     2.5 %   97.5 %</span></span>
<span id="cb21-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A dark Dark - Milk    -2.78e-17   7.27e-13 -3.82e-05        1 -1.42e-12 1.42e-12</span></span>
<span id="cb21-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B dark Dark - Milk     0.00e+00         NA        NA       NA        NA       NA</span></span>
<span id="cb21-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C dark Dark - Milk     0.00e+00   1.62e-14  0.00e+00        1 -3.17e-14 3.17e-14</span></span>
<span id="cb21-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D dark Dark - Milk    -6.94e-18   1.73e-13 -4.02e-05        1 -3.38e-13 3.38e-13</span></span>
<span id="cb21-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E dark Dark - Milk    -2.78e-17   7.27e-13 -3.82e-05        1 -1.42e-12 1.42e-12</span></span>
<span id="cb21-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F dark Dark - Milk     0.00e+00         NA        NA       NA        NA       NA</span></span>
<span id="cb21-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G dark Dark - Milk     0.00e+00   1.62e-14  0.00e+00        1 -3.17e-14 3.17e-14</span></span>
<span id="cb21-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H dark Dark - Milk    -6.94e-18   1.73e-13 -4.02e-05        1 -3.38e-13 3.38e-13</span></span>
<span id="cb21-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A nuts Nuts - No nuts  1.39e-17         NA        NA       NA        NA       NA</span></span>
<span id="cb21-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B nuts Nuts - No nuts  1.39e-17         NA        NA       NA        NA       NA</span></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C nuts Nuts - No nuts  0.00e+00   1.41e-14  0.00e+00        1 -2.77e-14 2.77e-14</span></span>
<span id="cb21-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D nuts Nuts - No nuts  0.00e+00   1.41e-14  0.00e+00        1 -2.77e-14 2.77e-14</span></span>
<span id="cb21-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E nuts Nuts - No nuts  0.00e+00   9.74e-13  0.00e+00        1 -1.91e-12 1.91e-12</span></span>
<span id="cb21-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F nuts Nuts - No nuts  0.00e+00   9.74e-13  0.00e+00        1 -1.91e-12 1.91e-12</span></span>
<span id="cb21-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G nuts Nuts - No nuts  0.00e+00   1.08e-13  0.00e+00        1 -2.11e-13 2.11e-13</span></span>
<span id="cb21-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H nuts Nuts - No nuts  0.00e+00   1.08e-13  0.00e+00        1 -2.11e-13 2.11e-13</span></span>
<span id="cb21-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      A soft Soft - Chewy    6.94e-18   1.08e-13  6.42e-05        1 -2.12e-13 2.12e-13</span></span>
<span id="cb21-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      B soft Soft - Chewy    1.39e-17   2.16e-13  6.43e-05        1 -4.23e-13 4.23e-13</span></span>
<span id="cb21-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      C soft Soft - Chewy    6.94e-18   1.08e-13  6.42e-05        1 -2.12e-13 2.12e-13</span></span>
<span id="cb21-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      D soft Soft - Chewy    1.39e-17   2.16e-13  6.43e-05        1 -4.23e-13 4.23e-13</span></span>
<span id="cb21-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      E soft Soft - Chewy    1.39e-17   4.33e-13  3.21e-05        1 -8.48e-13 8.48e-13</span></span>
<span id="cb21-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      F soft Soft - Chewy    0.00e+00   4.52e-13  0.00e+00        1 -8.86e-13 8.86e-13</span></span>
<span id="cb21-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      G soft Soft - Chewy    1.39e-17   4.33e-13  3.21e-05        1 -8.48e-13 8.48e-13</span></span>
<span id="cb21-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      H soft Soft - Chewy    0.00e+00   4.52e-13  0.00e+00        1 -8.86e-13 8.86e-13</span></span>
<span id="cb21-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb21-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>If we had continuous variables, we could work around this by <a href="https://vincentarelbundock.github.io/marginaleffects/articles/categorical.html#mlogit-package">specifying our own tiny amount of marginal change</a> to compare across, but we’re working with categories and can’t do that. Instead, with categorical variables, we can return to <code>predictions()</code> and <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html#multinomial-models">define custom aggregations of different features and levels</a>.</p>
<p>Before making custom aggregations, though, it’ll be helpful to illustrate what exactly we’re looking at when collapsing these results. Remember that earlier we calculated predictions for all the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">preds_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb22-2">  model_chocolate_mlogit, </span>
<span id="cb22-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> unique, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> unique)</span>
<span id="cb22-4">) </span>
<span id="cb22-5"></span>
<span id="cb22-6">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(group, dark, soft, nuts, estimate)</span>
<span id="cb22-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 5</span></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   group dark  soft  nuts    estimate</span></span>
<span id="cb22-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;</span></span>
<span id="cb22-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 A     Milk  Chewy No nuts  0.0540 </span></span>
<span id="cb22-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 B     Milk  Chewy Nuts     0.126  </span></span>
<span id="cb22-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 C     Milk  Soft  No nuts  0.00600</span></span>
<span id="cb22-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 D     Milk  Soft  Nuts     0.0140 </span></span>
<span id="cb22-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 E     Dark  Chewy No nuts  0.216  </span></span>
<span id="cb22-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 F     Dark  Chewy Nuts     0.504  </span></span>
<span id="cb22-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 G     Dark  Soft  No nuts  0.0240 </span></span>
<span id="cb22-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 H     Dark  Soft  Nuts     0.0560</span></span></code></pre></div>
</div>
<p>Four of the groups have <code>dark</code> = Milk and four have <code>dark</code> = Dark, with other varying characteristics across those groups (chewy/soft, nuts/no nuts). If we want the average proportion of all milk and dark chocolate options, we can group and summarize:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">preds_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dark) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(estimate))</span>
<span id="cb23-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb23-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark  avg_pred</span></span>
<span id="cb23-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span id="cb23-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk    0.0500</span></span>
<span id="cb23-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark    0.200</span></span></code></pre></div>
</div>
<p>The average market share for milk chocolate candies, holding all other features constant, is 5% (<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B0.0540%20+%200.126%20+%200.006%20+%200.014%7D%7B2%7D%20=%200.05">); the average market share for dark chocolate candies is 20% (<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B0.216%20+%200.504%20+%200.024%20+%200.056%7D%7B2%7D%20=%200.2">). These values are the averages of the predictions from the four groups where <code>dark</code> is either Milk or Dark.</p>
<p>Instead of calculating these averages manually (which would also force us to calculate standard errors and p-values manually, which, ugh), we can calculate these aggregate group means with <code>predictions()</code>. To do this, we can feed a little data frame to <code>predictions()</code> with the <code>by</code> argument. The data frame needs to contain columns for the features we want to collapse, and a <code>by</code> column with the labels we want to include in the output. For example, if we want to collapse the eight possible choices into those with milk chocolate and those with dark chocolate, we could create a <code>by</code> data frame like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>))</span>
<span id="cb24-2">by</span>
<span id="cb24-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dark   by</span></span>
<span id="cb24-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Milk Milk</span></span>
<span id="cb24-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Dark Dark</span></span></code></pre></div>
</div>
<p>If we use that <code>by</code> data frame in <code>predictions()</code>, we get the same 5% and 20% from before, but now with all of {marginaleffects}’s extra features like standard errors and confidence intervals:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb25-2">  model_chocolate_mlogit,</span>
<span id="cb25-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> by</span>
<span id="cb25-4">)</span>
<span id="cb25-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb25-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %   By</span></span>
<span id="cb25-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0.20     0.0316 6.32   &lt;0.001  0.138  0.262 Dark</span></span>
<span id="cb25-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0.05     0.0316 1.58    0.114 -0.012  0.112 Milk</span></span>
<span id="cb25-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb25-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: estimate, std.error, statistic, p.value, conf.low, conf.high, by</span></span></code></pre></div>
</div>
<p>Even better, we can use the <code>hypothesis</code> functionality of <code>predictions()</code> to conduct a hypothesis test and calculate the difference (or contrast) between these two averages, which is <em>exactly what we’re looking for</em> with categorical AMCEs. This shows the average causal effect of moving from milk → dark—holding all other features constant, switching the chocolate type from milk to dark causes a 15 percentage point increase in the probability of selecting the candy, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb26-2">  model_chocolate_mlogit,</span>
<span id="cb26-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> by,</span>
<span id="cb26-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb26-5">)</span>
<span id="cb26-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb26-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb26-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Milk - Dark    -0.15     0.0632 -2.37   0.0177 -0.274 -0.026</span></span>
<span id="cb26-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb26-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can’t simultaneously specify all the contrasts we’re interested in single <code>by</code> argument, but we can do them separately and combine them into a single data frame:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">amces_chocolate_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb27-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-3">    model_chocolate_mlogit,</span>
<span id="cb27-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dark =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Milk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dark"</span>)),</span>
<span id="cb27-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-6">  ),</span>
<span id="cb27-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-8">    model_chocolate_mlogit,</span>
<span id="cb27-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chewy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Soft"</span>)),</span>
<span id="cb27-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-11">  ),</span>
<span id="cb27-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb27-13">    model_chocolate_mlogit,</span>
<span id="cb27-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nuts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No nuts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span>)),</span>
<span id="cb27-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span></span>
<span id="cb27-16">  ),</span>
<span id="cb27-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span></span>
<span id="cb27-18">)</span>
<span id="cb27-19">amces_chocolate_mlogit</span>
<span id="cb27-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##            Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb27-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Milk - Dark       -0.15     0.0632 -2.37   0.0177 -0.274 -0.026</span></span>
<span id="cb27-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Soft - Chewy      -0.20     0.0474 -4.22   &lt;0.001 -0.293 -0.107</span></span>
<span id="cb27-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Nuts - No nuts     0.10     0.0725  1.38   0.1675 -0.042  0.242</span></span>
<span id="cb27-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: variable, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
</section>
<section id="plots-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="plots-1">Plots</h3>
<p>Plotting these AMCEs requires a bit of data wrangling, but we get really neat plots, so it’s worth it. I’ve hidden all the code here for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">chocolate_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb28-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"soft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuts"</span>)</span>
<span id="cb28-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb28-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate[[.x]]</span>
<span id="cb28-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb28-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb28-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb28-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb28-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb28-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb28-12">    }</span>
<span id="cb28-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb28-16"></span>
<span id="cb28-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb28-18">chocolate_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb28-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb28-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Type of chocolate"</span>,</span>
<span id="cb28-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"soft"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Type of center"</span>,</span>
<span id="cb28-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuts"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nuts"</span></span>
<span id="cb28-23">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">amces_chocolate_mlogit_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_chocolate_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb29-3">    term,</span>
<span id="cb29-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb29-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb29-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> variable)</span>
<span id="cb29-8"></span>
<span id="cb29-9">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb29-11">    amces_chocolate_mlogit_split,</span>
<span id="cb29-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb29-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb29-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb29-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb29-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb29-18">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb29-19">    )</span>
<span id="cb29-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(chocolate_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb29-23"></span>
<span id="cb29-24">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb29-25">  plot_data,</span>
<span id="cb29-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb29-27">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb29-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of candy selection"</span>,</span>
<span id="cb29-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb29-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb29-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with posterior draws and make {brms} plot</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is much easier than the mlogit mess because we can use avg_comparisons() directly</span></span>
<span id="cb30-2">posterior_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_chocolate_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>() </span>
<span id="cb30-5"></span>
<span id="cb30-6">posterior_mfx_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb30-8">    contrast,</span>
<span id="cb30-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb30-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb30-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with model results</span></span>
<span id="cb30-16">plot_data_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chocolate_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb30-18">    posterior_mfx_nested,</span>
<span id="cb30-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb30-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">draw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(chocolate_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb30-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb30-25"></span>
<span id="cb30-26">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data_bayes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb30-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb30-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of candy selection"</span>,</span>
<span id="cb30-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb30-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb30-37">  )</span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p2</span></code></pre></div>
<div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-chocolate-both-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section>
</section>
</section>
<section id="part-2-minivans-repeated-questions-basic-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 2: Minivans; repeated questions; basic multinomial logit</h1>
<section id="the-setup-1" class="level2">
<h2 class="anchored" data-anchor-id="the-setup-1">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these minivans they’d want to buy, based on four different features/attributes with different levels:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Passengers</td>
<td style="text-align: left;">6, 7, 8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cargo area</td>
<td style="text-align: left;">2 feet, 3 feet</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Engine</td>
<td style="text-align: left;">Gas, electric, hybrid</td>
</tr>
<tr class="even">
<td style="text-align: left;">Price</td>
<td style="text-align: left;">$30,000; $35,000; $40,000</td>
</tr>
</tbody>
</table>
<p>Respondents see this a question similar to this fifteen different times, with three options with randomly shuffled levels for each of the features.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">Option 1</th>
<th style="text-align: center;">Option 2</th>
<th style="text-align: center;">Option 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Passengers</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">6</td>
</tr>
<tr class="even">
<td>Cargo area</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">2 feet</td>
</tr>
<tr class="odd">
<td>Engine</td>
<td style="text-align: center;">Electric</td>
<td style="text-align: center;">Gas</td>
<td style="text-align: center;">Hybrid</td>
</tr>
<tr class="even">
<td>Price</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$30,000</td>
</tr>
<tr class="odd">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="the-data-1" class="level2">
<h2 class="anchored" data-anchor-id="the-data-1">The data</h2>
<p>The data for this kind of experiment has one row for each possible alternative (<code>alt</code>) within each set of 15 questions (<code>ques</code>), thus creating 3 × 15 = 45 rows per respondent (<code>resp.id</code>). There were 200 respondents, with 45 rows each, so there are 200 × 45 = 9,000 rows. Here, Respondent 1 chose a $30,000 gas van with 6 seats and 3 feet of cargo space in the first set of three options, a $35,000 gas van with 7 seats and 3 feet of cargo space in the second set of three options, and so on.</p>
<p>There’s also a column here for <code>carpool</code> indicating if the respondent carpools with others when commuting. It’s an individual respondent-level characteristic and is constant throughout all the questions and alternatives, and we’ll use it later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">minivans</span>
<span id="cb32-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 9</span></span>
<span id="cb32-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt carpool seat  cargo eng   price choice</span></span>
<span id="cb32-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb32-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 yes     6     2ft   gas   35         0</span></span>
<span id="cb32-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 yes     8     3ft   hyb   30         0</span></span>
<span id="cb32-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 yes     6     3ft   gas   30         1</span></span>
<span id="cb32-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 yes     6     2ft   gas   30         0</span></span>
<span id="cb32-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 yes     7     3ft   gas   35         1</span></span>
<span id="cb32-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 yes     6     2ft   elec  35         0</span></span>
<span id="cb32-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 yes     8     3ft   gas   35         1</span></span>
<span id="cb32-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 yes     7     3ft   elec  30         0</span></span>
<span id="cb32-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 yes     8     2ft   elec  40         0</span></span>
<span id="cb32-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 yes     7     3ft   elec  40         1</span></span>
<span id="cb32-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span></code></pre></div>
</div>
</section>
<section id="the-model-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-model-1">The model</h2>
<p>Respondents were shown three different options and asked to select one. We thus have three possible outcomes: a respondent could have selected option 1, option 2, or option 3. Because everything was randomized, there shouldn’t be any patterns in which options people choose—we don’t want to see that the first column is more common, since that would indicate that respondents are just repeatedly selecting the first column to get through the survey. Since there are three possible outcomes (option 1, 2, and 3), we’ll use multinomial logistic regression.</p>
<section id="original-model-as-a-baseline" class="level3">
<h3 class="anchored" data-anchor-id="original-model-as-a-baseline">Original model as a baseline</h3>
<p>In the example in their textbook, <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> use {mlogit} to estimate this model and they find these results. This will be our baseline throughout this example.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/img/chapman-feit-mlogit.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Original results from <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> p.&nbsp;371</figcaption>
</figure>
</div>
</section>
<section id="mlogit-model-1" class="level3">
<h3 class="anchored" data-anchor-id="mlogit-model-1"><code>mlogit</code> model</h3>
<p>This data is a little more complex now, since there are alternatives nested inside questions inside respondents. To account for this panel structure when using {mlogit}, we need to define two index columns: one for the unique set of alternatives offered to the respondent and one for the respondent ID. We still do this with <code>dfidx()</code>, but need to create a new column with an ID number for each unique combination of respondent ID and question number:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">minivans_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mlogit() needs a column with unique question id numbers</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp.id, ques) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice.id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cur_group_id</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make indexed data frame for mlogit</span></span>
<span id="cb33-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dfidx</span>(</span>
<span id="cb33-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice.id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resp.id"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alt"</span>),</span>
<span id="cb33-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"choice"</span>,</span>
<span id="cb33-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span></span>
<span id="cb33-11">  )</span></code></pre></div>
</div>
<p>Now we can fit the model. Note the <code>0 ~ seat</code> syntax here. That suppresses the intercept for the model, which behaves weirdly with multinomial models. Since there are three categories for the outcome (options 1, 2, and 3), there are two intercepts, representing cutpoints-from-ordered-logit-esque shifts in the probability of selecting option 1 vs.&nbsp;option 2 and option 2 vs.&nbsp;option 3. We don’t want to deal with those, so we’ll suppress them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">model_minivans_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb34-2">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb34-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_idx</span>
<span id="cb34-4">)</span>
<span id="cb34-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_minivans_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb34-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter   | Log-Odds |     SE |         95% CI |        z |           p</span></span>
<span id="cb34-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -------------------------------------------------------------------------</span></span>
<span id="cb34-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## seat [7]    |  -0.5353 | 0.0624 | [-0.66, -0.41] |  -8.5837 | 9.1863e-18 </span></span>
<span id="cb34-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## seat [8]    |  -0.3058 | 0.0611 | [-0.43, -0.19] |  -5.0032 | 5.6376e-07 </span></span>
<span id="cb34-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## cargo [3ft] |   0.4774 | 0.0509 | [ 0.38,  0.58] |   9.3824 | 6.4514e-21 </span></span>
<span id="cb34-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## eng [hyb]   |  -0.8113 | 0.0601 | [-0.93, -0.69] | -13.4921 | 1.7408e-41 </span></span>
<span id="cb34-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## eng [elec]  |  -1.5308 | 0.0675 | [-1.66, -1.40] | -22.6926 | 5.3004e-114</span></span>
<span id="cb34-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## price [35]  |  -0.9137 | 0.0606 | [-1.03, -0.79] | -15.0765 | 2.3123e-51 </span></span>
<span id="cb34-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## price [40]  |  -1.7259 | 0.0696 | [-1.86, -1.59] | -24.7856 | 1.2829e-135</span></span></code></pre></div>
</div>
<p>These are the same results from p.&nbsp;371 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span>, so it worked. Again, the marketing world doesn’t typically do much with these coefficients beyond looking at their direction and magnitude. For instance, in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> they say that the estimate for <code>seat [7]</code> here is negative, which means that a 7-seat option is less preferred than 6-seat option, and that the estimate for <code>price [40]</code> is more negative than the already-negative estimate for <code>price [35]</code>, which means that (1) respondents don’t like the $35,000 option compared to the baseline $30,000 and that (2) respondents <em>really</em> don’t like the $40,000 option. We could theoretically exponentiate these things—like, seeing 7 seats makes it <img src="https://latex.codecogs.com/png.latex?e%5E%7B-0.5353%7D"> = 0.5855 = 41% less likely to select the option compared to 6 seats—but again, that’s weird.</p>
</section>
<section id="bayesian-model-with-brms" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="bayesian-model-with-brms">Bayesian model with {brms}</h3>
<p>We can also fit this multinomial model in a Bayesian way using {brms}. Stan has a categorical family for dealing with mulitnomial/categorical outcomes. But first, we’ll look at the nested structure of this data and incorporate that into the model, since we won’t be using the weird {mlogit}-style indexed data frame. As with the chocolate experiment, the data has a natural hierarchy in it, with three questions nested inside 15 separate question sets, nested inside each of the 200 respondents.</p>
<div class="cell page-columns page-full" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display column-page">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/minivan-multilevel-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with minivan choices <img src="https://latex.codecogs.com/png.latex?%5C%7By_1,%20y_2,%20y_3%5C%7D"> nested in sets of questions in respondents</figcaption>
</figure>
</div>
</div>
</div>
<p>Currently, our main outcome variable <code>choice</code> is binary. If we run the model with <code>choice</code> as the outcome with a categorical family, the model will fit, but it will go slow and {brms} will complain about it and recommend switching to regular logistic regression. The categorical family in Stan requires 2+ outcomes and a reference category. Here we have three possible options (1, 2, and 3), and we can imagine a reference category of 0 for rows that weren’t selected.</p>
<p>We can create a new outcome column (<code>choice_alt</code>) that indicates which option each respondent selected: 0 if they didn’t choose the option and 1–3 if they chose the first, second, or third option. Because of how the data is recorded, this only requires multiplying <code>alt</code> and <code>choice</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">minivans_choice_alt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choice_alt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> choice))</span>
<span id="cb35-3"></span>
<span id="cb35-4">minivans_choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(resp.id, ques, alt, seat, cargo, eng, price, choice, choice_alt)</span>
<span id="cb35-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 9</span></span>
<span id="cb35-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt seat  cargo eng   price choice choice_alt</span></span>
<span id="cb35-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;fct&gt;     </span></span>
<span id="cb35-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 6     2ft   gas   35         0 0         </span></span>
<span id="cb35-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 8     3ft   hyb   30         0 0         </span></span>
<span id="cb35-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 6     3ft   gas   30         1 3         </span></span>
<span id="cb35-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 6     2ft   gas   30         0 0         </span></span>
<span id="cb35-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 7     3ft   gas   35         1 2         </span></span>
<span id="cb35-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 6     2ft   elec  35         0 0         </span></span>
<span id="cb35-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 8     3ft   gas   35         1 1         </span></span>
<span id="cb35-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 7     3ft   elec  30         0 0         </span></span>
<span id="cb35-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 8     2ft   elec  40         0 0         </span></span>
<span id="cb35-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 7     3ft   elec  40         1 1         </span></span>
<span id="cb35-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span></code></pre></div>
</div>
<p>We can now use the new four-category <code>choice_alt</code> column as our outcome with the <code>categorical()</code> family.</p>
<p>If we <em>realllly</em> wanted, we could add random effects for question sets nested inside respondents, like <code>(1 | resp.id / ques)</code>. We’d want to do that if there were set-specific things that could influences choices. Like maybe we want to account for the possibility that everyone’s just choosing the first option, so it behaves differently? Or maybe the 5th set of questions is set to an extra difficult level on a quiz or something? Or maybe we have so many sets that we think the later ones will be less accurate because of respondent fatigue? idk. In this case, question set-specific effects don’t matter at all. Each question set is equally randomized and no different from the others, so we won’t bother modeling that layer of the hierarchy.</p>
<p>We want to model the choice of option 1, 2, or 3 (<code>choice_alt</code>) based on minivan characteristics (<code>seat</code>, <code>cargo</code>, <code>eng</code>, price). With the categorical model, we actually get a set of parameters to estimate the probability of selecting each of the options, which Stan calls <img src="https://latex.codecogs.com/png.latex?%5Cmu">, so we have a set of three probabilities: <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmu_1,%20%5Cmu_2,%20%5Cmu_3%5C%7D">. We’ll use the subscript <img src="https://latex.codecogs.com/png.latex?i"> to refer to individual minivan choices and <img src="https://latex.codecogs.com/png.latex?j"> to refer to respondents. Here’s the fun formal model:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20(%5Cbeta_0%20+%20b_%7B0_j%7D)%20+%20%5Cbeta_1%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_2%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_3%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_4%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_5%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_6%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_7%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B5pt%5D%0Ab_%7B0_j%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%5Cqquad%5Cquad%5Cquad%20%5Ctext%7BRespondent-specific%20offsets%20from%20global%20probability%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_%7B0%20%5Cdots%207%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5C%20%5Ctext%7BPrior%20for%20choice-level%20coefficients%7D%20%5C%5C%0A%5Csigma_0%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cquad%20%5Ctext%7BPrior%20for%20between-respondent%20variability%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>And here’s the {brms} model. Notice the much-more-verbose prior section—because the categorical family in Stan estimates separate parameters for each of the categories (<img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmu_1,%20%5Cmu_2,%20%5Cmu_3%5C%7D">), we have a mean and standard deviation for the probability of selecting each of those options. We need to specify each of these separately too instead of just doing something like <code>prior(normal(0, 3), class = b)</code>. Also notice the <code>refcat</code> argument in <code>categorical()</code>—this makes it so that all the estimates are relative to not choosing an option (or when <code>choice_alt</code> is 0). And <em>also</em> notice the slightly different syntax for the random respondent intercepts: <code>(1 | ID | resp.id)</code>. That new middle <code>ID</code> is special {brms} formula syntax that we can use when working with categorical or ordinal families, and it makes it so that the group-level effects for the different outcomes (here options 0, 1, 2, and 3) are correlated (see p.&nbsp;4 of <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">this {brms} vignette</a> for more about this special syntax).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">model_minivans_categorical_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id)),</span>
<span id="cb36-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_choice_alt,</span>
<span id="cb36-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refcat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>),</span>
<span id="cb36-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb36-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb36-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb36-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb36-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb36-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb36-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3)</span>
<span id="cb36-12">  ),</span>
<span id="cb36-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb36-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb36-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_minivans_categorical_brms"</span></span>
<span id="cb36-16">)</span></code></pre></div>
</div>
<p>This model gives us a ton of parameters! We get three estimates per feature level (i.e.&nbsp;<code>mu1_cargo3ft</code>, <code>mu2_cargo3ft</code>, and <code>mu3_cargo3ft</code> for the <code>cargo3ft</code> effect), since we’re actually estimating the effect of each covariate on the probability of selecting each of the three options.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>(model_minivans_categorical_brms)</span>
<span id="cb37-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Parameter    | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span id="cb37-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -----------------------------------------------------------------</span></span>
<span id="cb37-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat6    |  -0.34 | [-0.52, -0.16] | 99.95% | 1.001 | 2673.00</span></span>
<span id="cb37-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat7    |  -0.86 | [-1.04, -0.67] |   100% | 1.000 | 3167.00</span></span>
<span id="cb37-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_seat8    |  -0.59 | [-0.77, -0.41] |   100% | 1.000 | 3373.00</span></span>
<span id="cb37-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_cargo3ft |   0.46 | [ 0.32,  0.60] |   100% | 1.000 | 6314.00</span></span>
<span id="cb37-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_enghyb   |  -0.76 | [-0.92, -0.60] |   100% | 1.001 | 4628.00</span></span>
<span id="cb37-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_engelec  |  -1.51 | [-1.69, -1.33] |   100% | 0.999 | 4913.00</span></span>
<span id="cb37-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_price35  |  -0.82 | [-0.99, -0.67] |   100% | 0.999 | 4574.00</span></span>
<span id="cb37-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu1_price40  |  -1.74 | [-1.94, -1.56] |   100% | 1.000 | 4637.00</span></span>
<span id="cb37-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat6    |  -0.39 | [-0.57, -0.20] |   100% | 1.000 | 2387.00</span></span>
<span id="cb37-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat7    |  -0.95 | [-1.15, -0.77] |   100% | 1.001 | 2470.00</span></span>
<span id="cb37-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_seat8    |  -0.67 | [-0.85, -0.49] |   100% | 1.001 | 2489.00</span></span>
<span id="cb37-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_cargo3ft |   0.49 | [ 0.35,  0.63] |   100% | 1.000 | 4836.00</span></span>
<span id="cb37-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_enghyb   |  -0.79 | [-0.95, -0.63] |   100% | 1.000 | 4421.00</span></span>
<span id="cb37-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_engelec  |  -1.40 | [-1.57, -1.22] |   100% | 1.000 | 4261.00</span></span>
<span id="cb37-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_price35  |  -0.79 | [-0.95, -0.63] |   100% | 1.001 | 3699.00</span></span>
<span id="cb37-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu2_price40  |  -1.47 | [-1.65, -1.29] |   100% | 0.999 | 3978.00</span></span>
<span id="cb37-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat6    |  -0.28 | [-0.46, -0.11] | 99.85% | 1.000 | 2077.00</span></span>
<span id="cb37-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat7    |  -0.78 | [-0.96, -0.60] |   100% | 1.000 | 3025.00</span></span>
<span id="cb37-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_seat8    |  -0.63 | [-0.81, -0.46] |   100% | 1.000 | 2483.00</span></span>
<span id="cb37-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_cargo3ft |   0.36 | [ 0.23,  0.50] |   100% | 0.999 | 5327.00</span></span>
<span id="cb37-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_enghyb   |  -0.73 | [-0.88, -0.58] |   100% | 1.000 | 4039.00</span></span>
<span id="cb37-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_engelec  |  -1.41 | [-1.59, -1.23] |   100% | 1.001 | 3818.00</span></span>
<span id="cb37-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_price35  |  -0.85 | [-1.01, -0.69] |   100% | 1.000 | 4315.00</span></span>
<span id="cb37-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mu3_price40  |  -1.56 | [-1.75, -1.39] |   100% | 0.999 | 4774.00</span></span></code></pre></div>
</div>
<p>Importantly, the estimates here are all roughly equivalent to what we get from {mlogit}: the {mlogit} estimate for <code>cargo3ft</code> was 0.4775, while the three median posterior {brms} estimates are 0.46 (95% credible interval: 0.32–0.60), 0.49 (0.35–0.63), and 0.36 (0.23–0.50)</p>
<p>Since all the features are randomly shuffled between the three options each time, and each option is selected 1/3rd of the time, it’s probably maybe legal to pool these posterior estimates together (maaaaybeee???) so that we don’t have to work with three separate estimates for each parameter? To do this we’ll take the average of each of the three <img src="https://latex.codecogs.com/png.latex?%5Cmu"> estimates within each draw, which is also called “marginalizing” across the three options.</p>
<p>Here’s how we’d do that with {tidybayes}. The medians are all roughly the same now!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">minivans_cat_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">^b_.*$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regex =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb38-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb38-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb38-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable name ("seat6")</span></span>
<span id="cb38-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_regex</span>(</span>
<span id="cb38-8">    .variable,</span>
<span id="cb38-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patterns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_mu</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d_"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*"</span>)</span>
<span id="cb38-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb38-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb38-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.value)) </span>
<span id="cb38-15"></span>
<span id="cb38-16">minivans_cat_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>()</span>
<span id="cb38-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 7</span></span>
<span id="cb38-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .variable .value .lower .upper .width .point .interval</span></span>
<span id="cb38-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb38-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 cargo3ft   0.439  0.340  0.532   0.95 median qi       </span></span>
<span id="cb38-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 engelec   -1.44  -1.56  -1.32    0.95 median qi       </span></span>
<span id="cb38-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 enghyb    -0.762 -0.871 -0.651   0.95 median qi       </span></span>
<span id="cb38-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 price35   -0.823 -0.935 -0.713   0.95 median qi       </span></span>
<span id="cb38-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 price40   -1.59  -1.72  -1.47    0.95 median qi       </span></span>
<span id="cb38-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 seat6     -0.337 -0.464 -0.208   0.95 median qi       </span></span>
<span id="cb38-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 seat7     -0.862 -0.994 -0.734   0.95 median qi       </span></span>
<span id="cb38-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 seat8     -0.629 -0.753 -0.503   0.95 median qi</span></span></code></pre></div>
</div>
<p>And for fun, here’s what the posterior for new combined/collapsed/marginalized <code>cargo3ft</code> looks like. Great.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">minivans_cat_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo3ft"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior distribution of β (logit-scale)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-cargo3ft-combined-posterior-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="predictions-1" class="level2">
<h2 class="anchored" data-anchor-id="predictions-1">Predictions</h2>
<p>As we saw in the first example with chocolates, the marketing world typically uses predictions from these kinds of models to estimate the predicted market share for products with different constellations of features. That was a pretty straightforward task with the chocolate model since respondents were shown all 8 options simultaneously. It’s a lot trickier with the minivan example where respondents were shown 15 sets of 3 options. Dealing with multinomial predictions is a bear of a task because these models are a lot more complex.</p>
<section id="frequentist-predictions-1" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-predictions-1">Frequentist predictions</h3>
<p>With the chocolate model, we could just use <code>avg_predictions(model_chocolate_mlogit)</code> and automatically get predictions for all 8 options. That’s not the case here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_predictions</span>(model_minivans_mlogit)</span>
<span id="cb40-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb40-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span id="cb40-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1    0.333   0.000349  955   &lt;0.001 0.332  0.334</span></span>
<span id="cb40-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      2    0.333   0.000145 2291   &lt;0.001 0.333  0.334</span></span>
<span id="cb40-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      3    0.334   0.000376  889   &lt;0.001 0.333  0.335</span></span>
<span id="cb40-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb40-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We get three predictions, and they’re all 33ish%. That’s because respondents were presented with three randomly shuffled options and chose one of them. All these predictions tell us is that across all 15 iterations of the questions, 1/3 of respondents selected the first option, 1/3 the second, and 1/3 the third. That’s a good sign in this case—there’s no evidence that people were just repeatedly choosing the first option. But in the end, these predictions aren’t super useful.</p>
<p>We instead want to be able to get predicted market shares (or predicted probabilities) for any given mix of products. For instance, here are six hypothetical products with different combinations of seats, cargo space, engines, and prices:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">example_product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb41-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>seat, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>cargo, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>eng, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>price,</span>
<span id="cb41-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb41-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb41-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb41-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35"</span></span>
<span id="cb41-9">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb41-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), factor)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb41-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)))</span>
<span id="cb41-12">example_product_mix</span>
<span id="cb41-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 4</span></span>
<span id="cb41-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  cargo eng   price</span></span>
<span id="cb41-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span id="cb41-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 7     2ft   hyb   30   </span></span>
<span id="cb41-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 6     2ft   gas   30   </span></span>
<span id="cb41-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 8     2ft   gas   30   </span></span>
<span id="cb41-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7     3ft   gas   40   </span></span>
<span id="cb41-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 6     2ft   elec  40   </span></span>
<span id="cb41-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 7     2ft   hyb   35</span></span></code></pre></div>
</div>
<p>If we were working with any other type of model, we could plug this data into the <code>newdata</code> argument of <code>predictions()</code> and get predicted values. That doesn’t work here though. There were 200 respondents in the original data, and {mlogit}-predictions need to happen on a dataset with a multiple of that many rows. We can’t just feed it 6 values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(model_minivans_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix)</span>
<span id="cb42-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Error: The `newdata` argument for `mlogit` models must be a data frame with a number of rows equal to a multiple of the number of choices: 200.</span></span></code></pre></div>
</div>
<p>Instead, following <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> (and <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335">this Stan forum post</a>), we can manually multiply the covariates in <code>example_product_mix</code> with the model coefficients to calculate “utility” (or predicted vales on the logit scale), which we can then exponentiate and divide to calculate market shares.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Limits of {marginaleffects} and {mlogit}
</div>
</div>
<div class="callout-body-container callout-body">
<p>From what I can tell, this is not possible with {marginaleffects} because that package can’t work with the coefficients from {mlogit} models and can only really work with predictions. {mlogit} predictions are forced to be on the response/probability scale since they’re, like, predictions, so there’s no way to get them on the log/logit link scale to calculate utilities and shares.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a matrix of 0s and 1s for the values in `example_product_mix`, omitting</span></span>
<span id="cb43-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the first column (seat6)</span></span>
<span id="cb43-3">example_product_dummy_encoded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(</span>
<span id="cb43-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>formula, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .),</span>
<span id="cb43-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> example_product_mix</span>
<span id="cb43-6">)[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb43-7">example_product_dummy_encoded</span>
<span id="cb43-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat7 seat8 cargo3ft enghyb engelec price35 price40</span></span>
<span id="cb43-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1     0        0      1       0       0       0</span></span>
<span id="cb43-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     0     0        0      0       0       0       0</span></span>
<span id="cb43-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     0     1        0      0       0       0       0</span></span>
<span id="cb43-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4     1     0        1      0       0       0       1</span></span>
<span id="cb43-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5     0     0        0      0       1       0       1</span></span>
<span id="cb43-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6     1     0        0      1       0       1       0</span></span>
<span id="cb43-15"></span>
<span id="cb43-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiply the matrix of 0s and 1s with the model coefficients to get</span></span>
<span id="cb43-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logit-scale predictions, or utility</span></span>
<span id="cb43-18">utility <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_product_dummy_encoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(model_minivans_mlogit)</span>
<span id="cb43-19"></span>
<span id="cb43-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Divide each exponentiated utility by the sum of the exponentiated utilities to</span></span>
<span id="cb43-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the market share</span></span>
<span id="cb43-22">share <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))</span>
<span id="cb43-23"></span>
<span id="cb43-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stick all of these in one final dataset</span></span>
<span id="cb43-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logits =</span> utility, example_product_mix)</span>
<span id="cb43-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 6</span></span>
<span id="cb43-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   share[,1] logits[,1] seat  cargo eng   price</span></span>
<span id="cb43-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span id="cb43-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1    0.113      -1.35  7     2ft   hyb   30   </span></span>
<span id="cb43-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2    0.433       0     6     2ft   gas   30   </span></span>
<span id="cb43-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3    0.319      -0.306 8     2ft   gas   30   </span></span>
<span id="cb43-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4    0.0728     -1.78  7     3ft   gas   40   </span></span>
<span id="cb43-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5    0.0167     -3.26  6     2ft   elec  40   </span></span>
<span id="cb43-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6    0.0452     -2.26  7     2ft   hyb   35</span></span></code></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Function version of this kind of prediction
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>On p.&nbsp;375 of <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> (and at <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335/">this Stan forum post</a>), there’s a function called <code>predict.mnl()</code> that does this utility and share calculation automatically. Because this post is more didactic and because I’m more interested in the Bayesian approach, I didn’t use it earlier, but it works well.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">predict.mnl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(model, data) {</span>
<span id="cb44-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for predicting shares from a multinomial logit model </span></span>
<span id="cb44-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model: mlogit object returned by mlogit()</span></span>
<span id="cb44-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data: a data frame containing the set of designs for which you want to </span></span>
<span id="cb44-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#       predict shares. Same format at the data used to estimate model. </span></span>
<span id="cb44-6">  data.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>formula, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data)[ , <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb44-7">  utility <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef</span>
<span id="cb44-8">  share <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))</span>
<span id="cb44-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(share, data)</span>
<span id="cb44-10">}</span>
<span id="cb44-11"></span>
<span id="cb44-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict.mnl</span>(model_minivans_mlogit, example_product_mix)</span>
<span id="cb44-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     share seat cargo  eng price</span></span>
<span id="cb44-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 0.11273    7   2ft  hyb    30</span></span>
<span id="cb44-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 0.43337    6   2ft  gas    30</span></span>
<span id="cb44-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 0.31918    8   2ft  gas    30</span></span>
<span id="cb44-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 0.07281    7   3ft  gas    40</span></span>
<span id="cb44-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 0.01669    6   2ft elec    40</span></span>
<span id="cb44-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 0.04521    7   2ft  hyb    35</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<p>This new predicted <code>share</code> column sums to one, and it shows us the predicted market share assuming these are the only six products available. The $30,000 six-seater 2ft gas van and the $30,000 eight-seater 2ft gas van would comprise more than 75% (0.43337 + 0.31918) of a market consisting of these six products. Because we did this calculation by hand, we lose all of {marginaleffects}’s extra features like standard errors and hypothesis tests. Alas.</p>
</section>
<section id="bayesian-predictions-1" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-predictions-1">Bayesian predictions</h3>
<p>If we use the categorical multinomial {brms} model we run into the same issue of getting weird predictions. Here it shows that 2/3rds of predictions are 0, which makes sense—if a respondent is offered 10 iterations of 3 possible choices, that would be 30 total choices, but they can only choose one option per iteration, so 20 choices (or 20/30 or 2/3) wouldn’t be selected. The other three groups are each 11%, since that’s the remaining 33% divided evenly across three options. Neat, I guess, but still not super helpful.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/show-brms-categorical-predictions-wrong_ec72a368432ec4df0fba88419083c3cf">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_predictions</span>(model_minivans_categorical_brms)</span>
<span id="cb45-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Group Estimate 2.5 % 97.5 %</span></span>
<span id="cb45-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      0    0.667 0.657  0.676</span></span>
<span id="cb45-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      1    0.109 0.103  0.115</span></span>
<span id="cb45-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      2    0.112 0.105  0.118</span></span>
<span id="cb45-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      3    0.113 0.106  0.119</span></span>
<span id="cb45-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: group, estimate, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>Instead of going through the manual process of matrix-multiplying a dataset of some mix of products with a single set of coefficients, we can use <code>predictions(..., type = "link")</code> to get predicted values on the log-odds scale, or that utility value that we found before.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>marginaleffects::predictions()</code> vs.&nbsp;{tidybayes} functions
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can actually use either <code>marginaleffects::predictions()</code> or {tidybayes}’s <code>*_draw()</code> functions for these posterior predictions. They do the same thing, with slightly different syntax:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Logit-scale predictions with marginaleffects::predictions()</span></span>
<span id="cb46-2">model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"link"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>()</span>
<span id="cb46-5"></span>
<span id="cb46-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Logit-scale predictions with tidybayes::add_linpred_draws()</span></span>
<span id="cb46-7">model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb46-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
</div>
<p>Earlier in the chocolate example, I used <code>marginaleffects::predictions()</code> with the Bayesian {brms} model. Here I’m going to switch to the {tidybayes} prediction functions instead, in part because these multinomial models with the <code>categorical()</code> family are a lot more complex (though {marginaleffects} can handle them nicely), but mostly because in the actual paper I’m working on with real conjoint data, our MCMC results were generated with raw Stan code through <code>rstan</code>, and {marginaleffects} doesn’t support raw Stan models.</p>
<p><a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">Check out this guide</a> for the differences between {tidybayes}’s three general prediction functions: <code>predicted_draws()</code>, <code>epred_draws()</code>, and <code>linpred_draws()</code>.</p>
</div>
</div>
<p>Additionally, we now actually have 4,000 draws in 3 categories (option 1, option 2, and option 3), so we actually have 12,000 sets of coefficients (!). To take advantage of the full posterior distribution of these coefficients, we can calculate shares within each set of draws within each of the three categories, resulting in a distribution of shares rather than single values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_product_mix <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(model_minivans_categorical_brms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb47-3"></span>
<span id="cb47-4">shares_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb47-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># three outcomes</span></span>
<span id="cb47-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb47-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb47-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(mix_type, share)</span>
<span id="cb47-13">  )</span></code></pre></div>
</div>
<p>We can summarize this huge dataset of posterior shares to get medians and credible intervals, but we need to do one extra step first. Right now, we have three predictions for each mix type, one for each of the categories (i.e.&nbsp;option 1, option 2, and option 3.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, .category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb48-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 18 × 8</span></span>
<span id="cb48-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    mix_type      .category  share .lower .upper .width .point .interval</span></span>
<span id="cb48-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;         &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb48-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6 2ft elec 40 1         0.0161 0.0123 0.0208   0.95 median qi       </span></span>
<span id="cb48-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6 2ft elec 40 2         0.0238 0.0183 0.0302   0.95 median qi       </span></span>
<span id="cb48-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6 2ft elec 40 3         0.0216 0.0168 0.0275   0.95 median qi       </span></span>
<span id="cb48-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 7 2ft hyb 35  1         0.0513 0.0400 0.0647   0.95 median qi       </span></span>
<span id="cb48-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 7 2ft hyb 35  2         0.0485 0.0379 0.0605   0.95 median qi       </span></span>
<span id="cb48-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 7 2ft hyb 35  3         0.0532 0.0424 0.0660   0.95 median qi       </span></span>
<span id="cb48-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 7 3ft gas 40  1         0.0693 0.0543 0.0876   0.95 median qi       </span></span>
<span id="cb48-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 7 3ft gas 40  2         0.0891 0.0705 0.111    0.95 median qi       </span></span>
<span id="cb48-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 7 3ft gas 40  3         0.0775 0.0615 0.0967   0.95 median qi       </span></span>
<span id="cb48-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 7 2ft hyb 30  1         0.117  0.0976 0.139    0.95 median qi       </span></span>
<span id="cb48-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 7 2ft hyb 30  2         0.107  0.0891 0.128    0.95 median qi       </span></span>
<span id="cb48-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 7 2ft hyb 30  3         0.124  0.104  0.146    0.95 median qi       </span></span>
<span id="cb48-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 8 2ft gas 30  1         0.326  0.292  0.363    0.95 median qi       </span></span>
<span id="cb48-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 8 2ft gas 30  2         0.314  0.282  0.348    0.95 median qi       </span></span>
<span id="cb48-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 8 2ft gas 30  3         0.299  0.267  0.331    0.95 median qi       </span></span>
<span id="cb48-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 16 6 2ft gas 30  1         0.418  0.380  0.457    0.95 median qi       </span></span>
<span id="cb48-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 17 6 2ft gas 30  2         0.416  0.379  0.454    0.95 median qi       </span></span>
<span id="cb48-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 18 6 2ft gas 30  3         0.423  0.387  0.462    0.95 median qi</span></span></code></pre></div>
</div>
<p>Since those options were all randomized, we can lump them all together as a single choice. To do this we’ll take the average share across the three categories (this is also called “marginalizing”) within each posterior draw.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1">shares_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across categories within each draw</span></span>
<span id="cb49-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb49-6"></span>
<span id="cb49-7">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb49-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 7</span></span>
<span id="cb49-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   mix_type       share .lower .upper .width .point .interval</span></span>
<span id="cb49-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb49-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6 2ft elec 40 0.0206 0.0173 0.0242   0.95 median qi       </span></span>
<span id="cb49-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 7 2ft hyb 35  0.0512 0.0435 0.0600   0.95 median qi       </span></span>
<span id="cb49-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 7 3ft gas 40  0.0788 0.0673 0.0915   0.95 median qi       </span></span>
<span id="cb49-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7 2ft hyb 30  0.116  0.103  0.131    0.95 median qi       </span></span>
<span id="cb49-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 8 2ft gas 30  0.313  0.291  0.337    0.95 median qi       </span></span>
<span id="cb49-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 6 2ft gas 30  0.419  0.394  0.446    0.95 median qi</span></span></code></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb50-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xy"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hypothetical product mix"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-brms-categorical-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is great because (1) it includes the uncertainty in the estimated shares, and (2) it lets us do neat Bayesian inference and say things like “there’s a 93% chance that in this market of 6 options, a $30,000 6-passenger gas minivan with 2 feet of storage would reach at least 40% market share”:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mix_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6 2ft gas 30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop_greater_40 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(share <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb51-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 1</span></span>
<span id="cb51-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   prop_greater_40</span></span>
<span id="cb51-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##             &lt;dbl&gt;</span></span>
<span id="cb51-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1           0.931</span></span>
<span id="cb51-8"></span>
<span id="cb51-9">shares_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mix_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6 2ft gas 30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_ramp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">after_stat</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_ramp_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-pd-example-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="amces-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="amces-1">AMCEs</h2>
<p>As explained in the AMCEs section for the chocolate data, in the social sciences we’re less concerned about predicted market shares and more concerned about causal effects. Holding all other features constant, what is the effect of a $5,000 increase in price or moving from 2 feet → 3 feet of storage space on the probability (or favorability) of selecting a minivan?</p>
<p>In the chocolate example, we were able to use <code>marginaleffects::avg_comparisons()</code> with the Bayesian model and get categorical contrasts automatically. This was because we cheated and used a Poisson model, since those can secretly behave like multinomial models. For the frequentist {mlogit}-based model, we had to use <code>marginaleffects::predictions()</code> instead and specify a special <code>by</code> argument to collapse the predictions into the different contrasts we were interested in.</p>
<p>In this case, since both the frequentist and Bayesian models for minivans are true multinomial models, we have to return to <a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html#multinomial-models">{marginaleffects}’s special syntax</a> that lets us pass a data frame as the <code>by</code> argument.</p>
<section id="frequentist-comparisonscontrasts-1" class="level3">
<h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts-1">Frequentist comparisons/contrasts</h3>
<p>To help with the intuition behind this, since it’s more complex this time, we’ll first create a data frame with all 54 combinations of all the feature levels (3 seats × 2 cargos × 3 engines × 3 prices) and create a <code>by</code> column label that concatenates all the labels together so there’s a single unique label for each row:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">by_all_combos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb52-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb52-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>))</span>
<span id="cb52-4">by_all_combos</span>
<span id="cb52-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 5</span></span>
<span id="cb52-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price by           </span></span>
<span id="cb52-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;chr&gt;        </span></span>
<span id="cb52-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    6_2ft_gas_30 </span></span>
<span id="cb52-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   35    6_2ft_gas_35 </span></span>
<span id="cb52-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   40    6_2ft_gas_40 </span></span>
<span id="cb52-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   hyb   30    6_2ft_hyb_30 </span></span>
<span id="cb52-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   hyb   35    6_2ft_hyb_35 </span></span>
<span id="cb52-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   hyb   40    6_2ft_hyb_40 </span></span>
<span id="cb52-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   elec  30    6_2ft_elec_30</span></span>
<span id="cb52-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   elec  35    6_2ft_elec_35</span></span>
<span id="cb52-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   elec  40    6_2ft_elec_40</span></span>
<span id="cb52-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     3ft   gas   30    6_3ft_gas_30 </span></span>
<span id="cb52-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>We can then feed this <code>by_all_combos</code> data frame into <code>predictions()</code>, which will generate predictions for all these levels <em>collapsed by all three of the possible groups</em> (i.e.&nbsp;option 1, option 2, and option 3). We can then split the <code>by</code> column back into separate columns for each of the feature levels so that we have those original columns back.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">all_preds_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb53-2">  model_minivans_mlogit,</span>
<span id="cb53-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions.mlogit() weirdly gets mad when working with tibbles :shrug:</span></span>
<span id="cb53-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(by_all_combos)</span>
<span id="cb53-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb53-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split the `by` column up into separate columns</span></span>
<span id="cb53-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate</span>(by, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">into =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>))</span>
<span id="cb53-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(all_preds_mlogit)</span>
<span id="cb53-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 10</span></span>
<span id="cb53-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    estimate std.error statistic   p.value conf.low conf.high seat  cargo eng   price</span></span>
<span id="cb53-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span id="cb53-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1   0.348    0.0135       25.8 1.89e-146   0.321     0.374  6     2ft   elec  30   </span></span>
<span id="cb53-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2   0.173    0.00907      19.0 7.82e- 81   0.155     0.190  6     2ft   elec  35   </span></span>
<span id="cb53-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3   0.0872   0.00565      15.4 1.04e- 53   0.0761    0.0983 6     2ft   elec  40   </span></span>
<span id="cb53-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4   0.695    0.0122       57.0 0           0.671     0.719  6     2ft   gas   30   </span></span>
<span id="cb53-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5   0.491    0.0147       33.3 1.08e-243   0.462     0.520  6     2ft   gas   35   </span></span>
<span id="cb53-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6   0.311    0.0130       23.8 1.40e-125   0.285     0.336  6     2ft   gas   40   </span></span>
<span id="cb53-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7   0.499    0.0138       36.3 3.76e-288   0.472     0.526  6     2ft   hyb   30   </span></span>
<span id="cb53-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8   0.300    0.0126       23.8 8.97e-125   0.275     0.324  6     2ft   hyb   35   </span></span>
<span id="cb53-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9   0.161    0.00952      16.9 3.90e- 64   0.142     0.180  6     2ft   hyb   40   </span></span>
<span id="cb53-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10   0.430    0.0147       29.2 2.13e-187   0.402     0.459  6     3ft   elec  30   </span></span>
<span id="cb53-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>There are a lot of predicted probabilities here, so we need to collapse and average these by groups to make any sense of them. For instance, suppose we’re interested in the AMCE of cargo space. We can first find the average predicted probability of selection with some grouping and summarizing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">manual_cargo_example <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(estimate))</span>
<span id="cb54-4">manual_cargo_example</span>
<span id="cb54-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb54-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo avg_pred</span></span>
<span id="cb54-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span id="cb54-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft      0.292</span></span>
<span id="cb54-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft      0.375</span></span>
<span id="cb54-10"></span>
<span id="cb54-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(manual_cargo_example<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>avg_pred)</span>
<span id="cb54-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.08326</span></span></code></pre></div>
</div>
<p>Holding all other features constant, the average probability (or average favorability, or average market share, or whatever we want to call it) of selecting a minivan with 2 feet of storage space is 0.292 (this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>2ft</code>); the average probability for a minivan with 3 feet of storage space is 0.375 (again, this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>3ft</code>). There’s an 8.3 percentage point difference between these groups. <strong>This is the causal effect or AMCE</strong>: switching from 2 feet to 3 feet increases minivan favorability by 8 percentage points on average.</p>
<p>This manual calculation works, but it’s tedious and doesn’t include anything about standard errors. So instead, we can do it automatically with <code>predictions(..., by = data.frame(...))</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1">preds_minivan_cargo_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb55-2">  model_minivans_mlogit, </span>
<span id="cb55-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb55-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo),</span>
<span id="cb55-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo)</span>
<span id="cb55-6">  )</span>
<span id="cb55-7">)</span>
<span id="cb55-8">preds_minivan_cargo_mlogit</span>
<span id="cb55-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb55-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %  By</span></span>
<span id="cb55-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     0.291    0.00440 66.2   &lt;0.001 0.283  0.300 2ft</span></span>
<span id="cb55-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     0.375    0.00441 85.2   &lt;0.001 0.367  0.384 3ft</span></span>
<span id="cb55-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb55-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: estimate, std.error, statistic, p.value, conf.low, conf.high, by</span></span></code></pre></div>
</div>
<p>And if we use the <code>hypothesis</code> argument (or the standalone <code>hypotheses()</code> function), we can get the difference between these average predictions, or the AMCE we care about—moving from 2 feet → 3 feet causes an 8 percentage point increase in favorability.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_cargo_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span>)</span>
<span id="cb56-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb56-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       Term Estimate Std. Error   z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span id="cb56-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3ft - 2ft   0.0837    0.00881 9.5   &lt;0.001 0.0664  0.101</span></span>
<span id="cb56-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb56-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>The <code>hypothesis</code> functionality works with more than 2 levels too. If calculate average predictions for the 3 seat configurations and specify <code>pariwise</code> or <code>revpairwise</code>, {marginaleffects} will give three differences: row 2 − row 1; row 3 − row 1; and row 3 − row 2. If we specify <code>reference</code> or <code>revreference</code>, it’ll only give two, all based on the first row.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">preds_minivan_seat_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb57-2">  model_minivans_mlogit, </span>
<span id="cb57-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb57-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat),</span>
<span id="cb57-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat)</span>
<span id="cb57-6">  )</span>
<span id="cb57-7">)</span>
<span id="cb57-8"></span>
<span id="cb57-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revpairwise"</span>)</span>
<span id="cb57-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb57-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6  -0.0996     0.0107 -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb57-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6  -0.0557     0.0109 -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb57-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 7   0.0439     0.0106  4.13   &lt;0.001  0.0230  0.0647</span></span>
<span id="cb57-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span id="cb57-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>)</span>
<span id="cb57-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb57-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6  -0.0996     0.0107 -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb57-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6  -0.0557     0.0109 -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb57-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb57-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can specify any other comparisons with <code>bN</code>, where <code>N</code> stands for the row number from <code>predictions()</code>. For instance, if we just want the difference between 6 (row 1) and 8 (row 2), we can do this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b2 = b1"</span>)</span>
<span id="cb58-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb58-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span id="cb58-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  b2=b1  -0.0996     0.0107 -9.29   &lt;0.001 -0.121 -0.0786</span></span>
<span id="cb58-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb58-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>We can make a big data frame with all the AMCEs we’re interested in. I’ve hidden the code here because it’s really repetitive.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Make separate datasets of predictions and combine them in one data frame</summary>
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1">preds_minivan_seat_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-2">  model_minivans_mlogit, </span>
<span id="cb59-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat),</span>
<span id="cb59-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seat)</span>
<span id="cb59-6">  )</span>
<span id="cb59-7">)</span>
<span id="cb59-8"></span>
<span id="cb59-9">preds_minivan_cargo_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-10">  model_minivans_mlogit, </span>
<span id="cb59-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo),</span>
<span id="cb59-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cargo)</span>
<span id="cb59-14">  )</span>
<span id="cb59-15">)</span>
<span id="cb59-16"></span>
<span id="cb59-17">preds_minivan_eng_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-18">  model_minivans_mlogit, </span>
<span id="cb59-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng),</span>
<span id="cb59-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)</span>
<span id="cb59-22">  )</span>
<span id="cb59-23">)</span>
<span id="cb59-24"></span>
<span id="cb59-25">preds_minivan_price_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb59-26">  model_minivans_mlogit, </span>
<span id="cb59-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb59-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price),</span>
<span id="cb59-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price)</span>
<span id="cb59-30">  )</span>
<span id="cb59-31">)</span>
<span id="cb59-32"></span>
<span id="cb59-33">amces_minivan_mlogit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb59-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_seat_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_cargo_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_eng_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference"</span>),</span>
<span id="cb59-37">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Need to specify these two tests manually because `hypotheses()` reeeeallly</span></span>
<span id="cb59-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># wants to use 35 as the reference level because it's the first value that</span></span>
<span id="cb59-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># appears in the original data. See</span></span>
<span id="cb59-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://github.com/vincentarelbundock/marginaleffects/issues/861</span></span>
<span id="cb59-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb59-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_price_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b1 = b2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35 - 30"</span>),</span>
<span id="cb59-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypotheses</span>(preds_minivan_price_mlogit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b3 = b2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40 - 30"</span>)</span>
<span id="cb59-44">  ),</span>
<span id="cb59-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span></span>
<span id="cb59-46">)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1">amces_minivan_mlogit</span>
<span id="cb60-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb60-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##        Term Estimate Std. Error      z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span id="cb60-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 - 6       -0.0996    0.01072  -9.29   &lt;0.001 -0.1206 -0.0786</span></span>
<span id="cb60-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 - 6       -0.0557    0.01091  -5.11   &lt;0.001 -0.0771 -0.0343</span></span>
<span id="cb60-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3ft - 2ft    0.0837    0.00881   9.50   &lt;0.001  0.0664  0.1010</span></span>
<span id="cb60-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  gas - elec   0.2785    0.01021  27.28   &lt;0.001  0.2585  0.2985</span></span>
<span id="cb60-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  hyb - elec   0.1156    0.01032  11.20   &lt;0.001  0.0954  0.1358</span></span>
<span id="cb60-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  35 - 30      0.1767    0.01117  15.82   &lt;0.001  0.1548  0.1986</span></span>
<span id="cb60-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  40 - 30     -0.1333    0.01014 -13.14   &lt;0.001 -0.1532 -0.1134</span></span>
<span id="cb60-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb60-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: variable, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
</section>
<section id="bayesian-comparisonscontrasts-1" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts-1">Bayesian comparisons/contrasts</h3>
<p>Unlike the chocolate example, where the outcome variable was binary, we have to do similar <code>by</code>-like shenanigans with the Bayesian minivan model here. We could theoretically work with things like <code>marginaleffects::comparisons()</code> or <code>marginaleffects::slopes()</code> to extract the AMCEs from the model, but as I’ll show below, there are some weird mathy things we have to deal with because of the multinomial outcome, and I think it’s beyond what {marginaleffects} is designed to easily do.</p>
<p>So instead we can use <code>epred_draws()</code> from {tidybayes} and calculate posterior predictions ourselves (<a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">see this guide</a> for an overview of all of {tidybayes}’s different prediction functions).</p>
<p>To illustrate why predicting things with this multinomial model is so weird, we’ll first predict the probability that someone chooses a $30,000 6-seater electric van with 2 feet of storage space. For this combination of minivan characteristics, there’s a 66% chance that someone does not select it, shown as category 0. That means there’s a 33% chance that someone <em>does</em> select it. Because options 1, 2 and 3 were randomized, that 33% is split evenly across categories 1, 2, and 3 in the predictions here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1">one_prediction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb61-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb61-4">  )</span>
<span id="cb61-5"></span>
<span id="cb61-6">one_prediction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.category) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb61-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb61-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 7</span></span>
<span id="cb61-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .category .epred .lower .upper .width .point .interval</span></span>
<span id="cb61-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb61-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 0          0.661 0.629   0.694   0.95 median qi       </span></span>
<span id="cb61-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 1          0.104 0.0843  0.128   0.95 median qi       </span></span>
<span id="cb61-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 2          0.112 0.0894  0.138   0.95 median qi       </span></span>
<span id="cb61-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 3          0.121 0.0990  0.147   0.95 median qi</span></span></code></pre></div>
</div>
<p>We could add the predictions for categories 1, 2, and 3 together, but that would take a bit of extra data manipulation work. Instead, we can rely on the the fact that the prediction for category 0 is actually the inverse of the sum of categories 1+2+3, so we can instead just use <code>1 - .epred</code> and only look at category 0. Even though the <code>category</code> column here says <code>0</code>, it’s really the combined probability of choosing options 1, 2, or 3:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1">one_prediction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb62-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb62-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb62-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb62-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 13</span></span>
<span id="cb62-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  cargo eng   price resp.id  .row .category .epred .lower .upper .width .point .interval</span></span>
<span id="cb62-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb62-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6     2ft   elec  30          1     1 0          0.339  0.306  0.371   0.95 median qi</span></span></code></pre></div>
</div>
<p>With {mlogit}, we found AMCEs by essentially calculating marginal means for specific contrasts of predicted probabilities. We created a data frame of all 54 combinations of feature levels and then grouped and summarized that data frame as needed (e.g., the average of the 27 predictions for 2 feet of cargo space and the average of the 27 predictions for 3 feed of cargo space).</p>
<p>We can do the same thing with the {brms} model, but selecting only the 0 category and reversing the predicted value:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1">newdata_all_combos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb63-4"></span>
<span id="cb63-5">all_preds_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_categorical_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newdata_all_combos) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb63-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span></code></pre></div>
</div>
<p>To make sure it worked, here are the posterior medians for all the different levels. It’s roughly the same as what we found with in <code>all_preds_mlogit</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb64-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, cargo, eng, price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb64-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb64-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 54 × 10</span></span>
<span id="cb64-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price .epred .lower .upper .width .point .interval</span></span>
<span id="cb64-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb64-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    0.682  0.651   0.713   0.95 median qi       </span></span>
<span id="cb64-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   35    0.485  0.451   0.520   0.95 median qi       </span></span>
<span id="cb64-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   40    0.305  0.275   0.338   0.95 median qi       </span></span>
<span id="cb64-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   hyb   30    0.502  0.466   0.537   0.95 median qi       </span></span>
<span id="cb64-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   hyb   35    0.306  0.276   0.338   0.95 median qi       </span></span>
<span id="cb64-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   hyb   40    0.171  0.150   0.194   0.95 median qi       </span></span>
<span id="cb64-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   elec  30    0.339  0.306   0.371   0.95 median qi       </span></span>
<span id="cb64-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   elec  35    0.183  0.161   0.207   0.95 median qi       </span></span>
<span id="cb64-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   elec  40    0.0952 0.0819  0.110   0.95 median qi       </span></span>
<span id="cb64-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     3ft   gas   30    0.769  0.743   0.795   0.95 median qi       </span></span>
<span id="cb64-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 44 more rows</span></span></code></pre></div>
</div>
<p>To pull out specific group-level averages, we can group and summarize. For example, here are the posterior median predictions for the two levels of cargo space:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb65-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb65-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred)</span>
<span id="cb65-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb65-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo .epred .lower .upper .width .point .interval</span></span>
<span id="cb65-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb65-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft    0.256 0.0606  0.676   0.95 median qi       </span></span>
<span id="cb65-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft    0.348 0.0905  0.763   0.95 median qi</span></span></code></pre></div>
</div>
<p>The medians here are correct and basically what we found with {mlogit}, but the credible intervals are <em>wildly</em> off (5% to 75% favorability?!). If we plot this we can see why:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb66-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> cargo)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb66-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-combo-wrong-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>hahahaha check out those mountain ranges. All those peaks come from combining the 27 different 2ft- and 3ft- posterior distributions for all the different combinations of other feature levels.</p>
<p>To get the actual marginal mean for cargo space, we need to marginalize out (or average out) all those other covariates. To do this, we need to group by the <code>cargo</code> column <em>and</em> the <code>.draw</code> column so that we find the average within each set of MCMC draws. To help with the intuition, look how many rows are in each of these groups of <code>cargo</code> and <code>.draw</code>—there are 27 different estimates for each of the 4,000 draws for 2 feet and 27 different estimates for each of the 4,000 draws for 3 feet. We want to collapse (or marginalize) those 27 rows into just one average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1">all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb67-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb67-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrows =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb67-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8,000 × 3</span></span>
<span id="cb67-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   cargo [2]</span></span>
<span id="cb67-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    cargo .draw nrows</span></span>
<span id="cb67-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb67-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 2ft       1    27</span></span>
<span id="cb67-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 2ft       2    27</span></span>
<span id="cb67-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 2ft       3    27</span></span>
<span id="cb67-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 2ft       4    27</span></span>
<span id="cb67-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 2ft       5    27</span></span>
<span id="cb67-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 2ft       6    27</span></span>
<span id="cb67-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 2ft       7    27</span></span>
<span id="cb67-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 2ft       8    27</span></span>
<span id="cb67-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 2ft       9    27</span></span>
<span id="cb67-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 2ft      10    27</span></span>
<span id="cb67-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 7,990 more rows</span></span></code></pre></div>
</div>
<p>To do that, we can find the average predicted value in those groups, then work with that as our main estimand. Check out these marginalized-out posteriors now—the medians are the same as before, but the credible intervals make a lot more sense:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1">preds_cargo_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates</span></span>
<span id="cb68-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb68-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb68-5"></span>
<span id="cb68-6">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb68-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>()</span>
<span id="cb68-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb68-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo   avg .lower .upper .width .point .interval</span></span>
<span id="cb68-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb68-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2ft   0.292  0.275  0.309   0.95 median qi       </span></span>
<span id="cb68-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 3ft   0.374  0.356  0.393   0.95 median qi</span></span></code></pre></div>
</div>
<p>We can confirm that marginalizing out the other covariates worked by plotting it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb69-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> cargo)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb69-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-preds-cargo-marginalized-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>heck. yes.</p>
<p>Finally, we’re actually most interested in the AMCE, or the difference between these two cargo sizes. The <code>compare_levels()</code> function from {tidybayes} can calculate this automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1">preds_cargo_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb70-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb70-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb70-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 7</span></span>
<span id="cb70-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   cargo        avg .lower .upper .width .point .interval</span></span>
<span id="cb70-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb70-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 3ft - 2ft 0.0830 0.0643  0.100   0.95 median qi</span></span></code></pre></div>
</div>
<p>That’s it! The <strong>causal effect</strong> of moving from 2 feet → 3 feet of storage space, holding all other features constant, is 8 percentage points (with a 95% credible interval of 6.5 to 10 percentage points).</p>
<p>We can combine all these AMCEs into a huge data frame. The marginalization process + <code>compare_levels()</code> has to happen with one feature at a time, so we need to create several separate data frames:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I could probably do this with purrr::map() to reduce all this repetition, but</span></span>
<span id="cb71-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># whatever, it works</span></span>
<span id="cb71-3">amces_minivan_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb71-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> seat),</span>
<span id="cb71-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> cargo),</span>
<span id="cb71-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(eng, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> eng),</span>
<span id="cb71-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> all_preds_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(price, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> price),</span>
<span id="cb71-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"term"</span></span>
<span id="cb71-25">)</span>
<span id="cb71-26"></span>
<span id="cb71-27">amces_minivan_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb71-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb71-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 7 × 8</span></span>
<span id="cb71-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term  contrast       avg  .lower  .upper .width .point .interval</span></span>
<span id="cb71-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb71-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 cargo 3ft - 2ft   0.0830  0.0643  0.100    0.95 median qi       </span></span>
<span id="cb71-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 eng   elec - gas -0.279  -0.300  -0.256    0.95 median qi       </span></span>
<span id="cb71-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 eng   hyb - gas  -0.161  -0.184  -0.138    0.95 median qi       </span></span>
<span id="cb71-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 price 35 - 30    -0.178  -0.201  -0.155    0.95 median qi       </span></span>
<span id="cb71-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 price 40 - 30    -0.309  -0.330  -0.287    0.95 median qi       </span></span>
<span id="cb71-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 seat  7 - 6      -0.0995 -0.121  -0.0785   0.95 median qi       </span></span>
<span id="cb71-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 seat  8 - 6      -0.0570 -0.0788 -0.0355   0.95 median qi</span></span></code></pre></div>
</div>
</section>
<section id="plots-2" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="plots-2">Plots</h3>
<p>Again, plotting these AMCEs so that there’s a reference category at 0 requires some extra data work, so I’ve hidden all that code for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1">minivan_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb72-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>)</span>
<span id="cb72-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb72-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans[[.x]]</span>
<span id="cb72-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb72-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb72-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb72-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb72-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb72-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb72-12">    }</span>
<span id="cb72-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb72-16"></span>
<span id="cb72-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb72-18">minivan_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb72-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb72-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passengers"</span>,</span>
<span id="cb72-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>,</span>
<span id="cb72-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Engine type"</span>,</span>
<span id="cb72-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Price (thousands of $)"</span></span>
<span id="cb72-24">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb72-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary>
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1">amces_minivan_mlogit_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_mlogit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb73-3">    term,</span>
<span id="cb73-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb73-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb73-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> variable)</span>
<span id="cb73-8"></span>
<span id="cb73-9">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb73-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb73-11">    amces_minivan_mlogit_split,</span>
<span id="cb73-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb73-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb73-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb73-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb73-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb73-18">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb73-19">    )</span>
<span id="cb73-20">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb73-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb73-23"></span>
<span id="cb73-24">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb73-25">  plot_data,</span>
<span id="cb73-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb73-27">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb73-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of minivan selection"</span>,</span>
<span id="cb73-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb73-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb73-36">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with marginalized posterior draws and make {brms} plot</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1">posterior_mfx_minivan_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb74-3">    contrast,</span>
<span id="cb74-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb74-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb74-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb74-9"></span>
<span id="cb74-10">plot_data_minivan_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb74-12">    posterior_mfx_minivan_nested,</span>
<span id="cb74-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb74-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb74-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb74-19"></span>
<span id="cb74-20">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data_minivan_bayes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb74-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb74-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">probability of minivan selection"</span>,</span>
<span id="cb74-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb74-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb74-30">  )</span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p2</span></code></pre></div>
<div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-both-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section>
</section>
</section>
<section id="part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit" class="level1 page-columns page-full">
<h1>Part 3: Minivans; repeated questions; full hierarchical multinomial logit</h1>
<section id="the-setup-2" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-setup-2">The setup</h2>
<p>We’ve cheated a little and have already used multilevel structures in the Bayesian models for the chocolate experiment and the minivan experiment. This was because these datasets had a natural panel grouping structure inside them. {mlogit} can work with panel-indexed data frames (that’s the point of that strange <code>dfidx()</code> function). By creating respondent-specific intercepts like we did with the {brms} models, we helped account for some of the variation caused by respondent differences.</p>
<p>But we can do better than that and get far richer and more complex models and estimates and predictions. In addition to using respondent-specific intercepts, we can (1) include respondent-level characteristics as covariates, and (2) include respondent-specific slopes for the minivan characteristic.</p>
<p>In the minivan data, we have data on feature levels (<code>seat</code>, <code>cargo</code>, <code>eng</code>, <code>price</code>) <em>and</em> on individual characteristics (<code>carpool</code>). The <code>carpool</code> variable indicates if the respondent uses their vehicle for carpooling. This is measured at the respondent level and not the choice level (i.e.&nbsp;someone won’t stop being a carpooler during one set of choices and then resume being a carpooler for another set). We can visualize where these different columns are measured by returning to the hierarchical model diagram:</p>
<div class="cell page-columns page-full" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display column-page">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/minivan-multilevel-structure-annotated-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel experimental structure, with minivan choices <img src="https://latex.codecogs.com/png.latex?%5C%7By_1,%20y_2,%20y_3%5C%7D"> nested in sets of questions in respondents, w ith variables measured at different levels</figcaption>
</figure>
</div>
</div>
</div>
<p>We can use hierarchical models (or multilevel models, or mixed effects models, or whatever you want to call them) to account for choice-level and respondent-level covariates <em>and</em> incorporate respondent-level heterogeneity and covariance into the model estimates.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/img/chelsea-meme.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption class="figure-caption">Image by <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Chelsea Parlett-Pelleriti</a></figcaption>
</figure>
</div>
</section>
<section id="important-sidenote-on-notation" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="important-sidenote-on-notation">Important sidenote on notation</h2>
<div class="page-columns page-full"><p>But before looking at how to incorporate that <code>carpool</code> column into the model, we need to take a quick little detour into the world of notation. There’s no consistent way of writing out multilevel models,<sup>1</sup> and accordingly, I thought it was impossible to run fully specified marketing-style hierarchical Bayesian models with {brms}—all because of notation!</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;These are not the only approaches—section 12.5 in <span class="citation" data-cites="GelmanHill:2007">Gelman and Hill (2007)</span> is called “Five ways to write the same model,” and they don’t include the offset notation as one of their five!</p></li></div></div>
<p>There are a couple general ways I’ve seen group-level random effects written out in formal model notation: one with complete random β terms and one with random offsets from a global β term.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
{brms} / {lme4} syntax
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overview of how to use {brms} and {lme4} with different random group-level intercept and slope specifications, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">check out this summary table by Ben Bolker</a>.</p>
</div>
</div>
<section id="random-intercepts" class="level3">
<h3 class="anchored" data-anchor-id="random-intercepts">Random intercepts</h3>
<p>If you want group-specific intercept terms, you can use a formula like this:</p>
<div class="sourceCode" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> group))</span></code></pre></div>
<p>In formal mathy terms, we can write this group-specific intercept as a complete coefficient: <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B0_j%7D">. Each group <img src="https://latex.codecogs.com/png.latex?j"> gets its own intercept coefficient. Nice and straightforward.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cbeta_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cbeta_0,%20%5Csigma_0)%20&amp;%20%5Ctext%7BRandom%20group-specific%20intercepts%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>However, I actually like to think of these random effects in a slightly different way, where each group intercept is actually a combination of a global average (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) and a group-specific offset from that average (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">), like this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_%7B0_j%7D%20=%20%5Cbeta_0%20+%20b_%7B0_j%7D%0A"></p>
<p>That offset is assumed to be normally distributed with a mean of 0 (<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(0,%20%5Csigma_0)">):</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0Ab_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20&amp;%20%5Ctext%7BRandom%20group-specific%20offsets%20from%20global%20intercept%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>I prefer this offset notation because it aligns with the output of {brms}, which reports population-level coefficients (i.e.&nbsp;the global average <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) along with group-specific offsets from that average (i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">), which you can access with <code>ranef(model_name)</code>.</p>
</section>
<section id="random-slopes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="random-slopes">Random slopes</h3>
<p>If you want group-specific intercepts <em>and</em> slopes, you can use a formula like this:</p>
<div class="sourceCode" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> group))</span></code></pre></div>
<p>The same dual syntax applies when using random slopes too. We can either use whole group-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7Bn_j%7D"> terms, or use offsets (<img src="https://latex.codecogs.com/png.latex?b_%7Bn_j%7D">) from a global average slope (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_n">). When working with random slopes, the math notation gets a little fancier because the random intercept and slope terms are actually correlated and move together across groups. The <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> terms come from a multivariate (or joint) normal distribution with shared covariance.</p>
<p>With the complete β approach, we’re estimating the joint distribution of <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D%20%5Cbeta_%7B0_j%7D%20%5C%5C%20%5Cbeta_%7B1_j%7D%20%5Cend%7Bpmatrix%7D">:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%5Cbeta_%7B1_j%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%0A%5Cleft(%0A%20%20%5Cleft(%0A%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbeta_0%20%5C%5C%0A%20%20%20%20%5Cbeta_1%20%5C%5C%0A%20%20%20%20%5Cend%7Barray%7D%0A%20%20%5Cright)%0A%20%20,%20%5C,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%20&amp;%20%5Ctext%7BRandom%20group-specific%20slopes%20and%20intercepts%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>With the offset approach, we’re estimating the joint distribution of the offsets from the global intercept and slope, or <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D%20b_%7B0_j%7D%20%5C%5C%20b_%7B1_j%7D%20%5Cend%7Bpmatrix%7D">:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AY_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20&amp;%20%5Ctext%7BOutcome%20for%20individual%7D_i%20%5Ctext%7B%20within%20group%7D_j%20%5C%5C%0A%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20(b_%7B1_j%7D%20+%20%5Cbeta_1)%20X_%7Bi_j%7D%20&amp;%20%5Ctext%7BLinear%20model%20of%20within-group%20variation%20%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20b_%7B0_j%7D%20%5C%5C%0A%20%20b_%7B1_j%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%0A%5Cleft(%0A%20%20%5Cleft(%0A%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%200%20%5C%5C%0A%20%20%20%200%20%5C%5C%0A%20%20%20%20%5Cend%7Barray%7D%0A%20%20%5Cright)%0A%20%20,%20%5C,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%20&amp;%20%5Ctext%7BRandom%20group-specific%20offsets%20from%20global%20intercept%20and%20slope%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
</section>
<section id="summary-table" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="summary-table">Summary table</h3>
<p>And here’s a helpful little table summarizing these two types of notation (mostly for future me).</p>
<div class="column-page-inset">
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 22%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Formula syntax</th>
<th style="text-align: center;">Full <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> notation</th>
<th style="text-align: center;">Offset notation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Random intercept</td>
<td><code>y ~ x + (1 | group)</code></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cbeta_0,%20%5Csigma_0)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20%5Cbeta_1%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B0_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
</tr>
<tr class="even">
<td>Random intercept + slope</td>
<td><code>y ~ x + (1 + x | group)</code></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B0_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_%7B1_j%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_0%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbeta_1%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%20%5C,%20%5CSigma%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5CSigma%20&amp;%5Csim%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bcc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_%7Bi_j%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bi_j%7D,%20%5Csigma_y)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cmu_%7Bi_j%7D%20&amp;=%20(b_%7B0_j%7D%20+%20%5Cbeta_0)%20+%20(b_%7B1_j%7D%20+%20%5Cbeta_1)%20X_%7Bi_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B0_j%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b_%7B1_j%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%5Csim%20%5Coperatorname%7BMV%7D%5C,%20%5Cmathcal%7BN%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%20%5C,%20%5CSigma%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5CSigma%20&amp;%5Csim%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cleft(%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cbegin%7Barray%7D%7Bcc%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_0%7D%20&amp;%20%5Crho_%7B%5Cbeta_0,%20%5Cbeta_1%7D%5C,%20%5Csigma_%7B%5Cbeta_0%7D%20%5Csigma_%7B%5Cbeta_1%7D%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_1%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Barray%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cright)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cend%7Baligned%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20"></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="translating-from-marketing-style-stan-notation-to-brms-syntax" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="translating-from-marketing-style-stan-notation-to-brms-syntax">Translating from marketing-style Stan notation to {brms} syntax</h2>
<p>In <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> and in all the marketing papers I’ve seen that use hierarchical Bayesian models—and even one I coauthored! <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">(Chaudhry, Dotson, and Heiss 2021)</span> (<a href="https://stats.andrewheiss.com/who-cares-about-crackdowns/output/appendix.html#model-details">see the appendix</a>)—they define their models using notation like this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BChoice%7D%20&amp;%5Csim%20%5Coperatorname%7BMultinomial%5C%20logit%7D(%5Cbeta%20X)%20&amp;%20%5Ctext%7Bwhere%20%7D%20X%20=%20%5Ctext%7Bfeature%20levels%7D%20%5C%5C%0A%5Cbeta%20&amp;%5Csim%20%5Coperatorname%7BMultivariate%7D%20%5Cmathcal%7BN%7D(%5Cgamma%20Z,%20%5CSigma)%20&amp;%20%5Ctext%7Bwhere%20%7D%20Z%20=%20%5Ctext%7Bindividual%20characteristics%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>For the longest time this threw me off because it’s slightly different from the two different notations we just reviewed (full βs vs.&nbsp;offsets from global β), and I figured that specifying a model like this with {brms} was impossible. The main reason for my confusion is that there are two different datasets involved in this model, and {brms} can only really work with one dataset.</p>
<p>In raw Stan (like <a href="https://github.com/ksvanhorn/ART-Forum-2017-Stan-Tutorial">in this tutorial on conjoint hierarchical Bayes models</a>, or in <a href="https://github.com/Bartosz-G/Conjoint-Analysis-in-R/">this example of a different conjoint hierarchical model</a>), you’d typically work with two different datasets or matrices: one <img src="https://latex.codecogs.com/png.latex?X"> with feature levels and one <img src="https://latex.codecogs.com/png.latex?Z"> with respondent-level characteristics. (<a href="https://mc-stan.org/docs/stan-users-guide/multivariate-hierarchical-priors.html">This is actually the recommended way to write hierarchical models in raw Stan!</a>).</p>
<p>Here’s what separate <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Z"> matrices would look like with the minivan data—<code>X</code> contains the full data without respondent-level covariates like <code>carpool</code> and it has 9,000 rows; <code>Z</code> contains only respondent-level characteristics like <code>carpool</code> and it only has 200 rows (one per respondent).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>carpool)</span>
<span id="cb78-2">X</span>
<span id="cb78-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 9,000 × 8</span></span>
<span id="cb78-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id  ques   alt seat  cargo eng   price choice</span></span>
<span id="cb78-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb78-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1     1     1 6     2ft   gas   35         0</span></span>
<span id="cb78-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       1     1     2 8     3ft   hyb   30         0</span></span>
<span id="cb78-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       1     1     3 6     3ft   gas   30         1</span></span>
<span id="cb78-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1     2     1 6     2ft   gas   30         0</span></span>
<span id="cb78-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1     2     2 7     3ft   gas   35         1</span></span>
<span id="cb78-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       1     2     3 6     2ft   elec  35         0</span></span>
<span id="cb78-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       1     3     1 8     3ft   gas   35         1</span></span>
<span id="cb78-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       1     3     2 7     3ft   elec  30         0</span></span>
<span id="cb78-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       1     3     3 8     2ft   elec  40         0</span></span>
<span id="cb78-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10       1     4     1 7     3ft   elec  40         1</span></span>
<span id="cb78-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 8,990 more rows</span></span>
<span id="cb78-17"></span>
<span id="cb78-18">Z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb78-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep the first row of each respondent</span></span>
<span id="cb78-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp.id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb78-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep the respondent-level columns</span></span>
<span id="cb78-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(resp.id, carpool)</span>
<span id="cb78-23">Z</span>
<span id="cb78-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 200 × 2</span></span>
<span id="cb78-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resp.id carpool</span></span>
<span id="cb78-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      &lt;dbl&gt; &lt;fct&gt;  </span></span>
<span id="cb78-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1       1 yes    </span></span>
<span id="cb78-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       2 no     </span></span>
<span id="cb78-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3       3 no     </span></span>
<span id="cb78-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       4 no     </span></span>
<span id="cb78-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       5 yes    </span></span>
<span id="cb78-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6       6 no     </span></span>
<span id="cb78-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7       7 no     </span></span>
<span id="cb78-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8       8 yes    </span></span>
<span id="cb78-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9       9 no     </span></span>
<span id="cb78-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10      10 no     </span></span>
<span id="cb78-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 190 more rows</span></span></code></pre></div>
</div>
<p><code>X</code> and <code>Z</code> are then passed to Stan as separate matrices and used at different places in the model fitting process. Here’s what that looks like in pseudo-Stan code. The matrix of individual characteristics <code>Z</code> is matrix-multiplied with a bunch of estimated <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> coefficients (<code>Gamma</code> here) to generate individual-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients (<code>Beta</code> here). The matrix of choices <code>X</code> is then matrix-multiplied with the individual-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients to generate predicted outcomes (<code>Y</code> here).</p>
<div class="sourceCode" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb79-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n_respondents) {</span>
<span id="cb79-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// All the individual-specific slopes and intercepts</span></span>
<span id="cb79-3">  Beta[,r] ~ multi_normal(Gamma * Z[,r], ...);</span>
<span id="cb79-4"></span>
<span id="cb79-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// All the question-level outcomes, using individual-specific slopes and intercepts</span></span>
<span id="cb79-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n_questions) {</span>
<span id="cb79-7">     Y[r,s] ~ categorical_logit( X [r,s] * Beta[,r]);</span>
<span id="cb79-8">  }</span>
<span id="cb79-9">}</span></code></pre></div>
<p>That’s a neat way of working with multilevel models, but it’s different from how I’ve always worked with them (and it requires working with raw Stan). As seen throughout this post, I’m a fan of {brms}’s formula-style syntax for specifying multilevel models, but {brms} can only work with one dataset at a time—you can’t pass it both <code>X</code> and <code>Z</code> like you’d do with raw Stan. So I (naively) figured that this went beyond {brms}’s abilities and was only possible with raw Stan.</p>
<p>However, if we use {brms}’s <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">special formula syntax</a>, we can actually specify an identical model with only one dataset (again, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">see this for a fantastic overview of the syntax</a>).</p>
<p>First, let’s look at the marketing-style syntax again:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BChoice%7D%20&amp;%5Csim%20%5Coperatorname%7BMultinomial%5C%20logit%7D(%5Cbeta%20X)%20&amp;%20%5Ctext%7Bwhere%20%7D%20X%20=%20%5Ctext%7Bfeature%20levels%7D%20%5C%5C%0A%5Cbeta%20&amp;%5Csim%20%5Coperatorname%7BMultivariate%7D%20%5Cmathcal%7BN%7D(%5Cgamma%20Z,%20%5CSigma)%20&amp;%20%5Ctext%7Bwhere%20%7D%20Z%20=%20%5Ctext%7Bindividual%20characteristics%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>This is actually just a kind of <em>really</em> compact notation. That second line with the <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Csim%20%5Coperatorname%7BMultivariate%7D%5C,%20%5Cmathcal%7BN%7D(%5Ccdot)"> distribution is a shorthand version of the full-β syntax from earlier. To illustrate this, let’s expand this out to a more complete formal definition of the model. Instead of using <img src="https://latex.codecogs.com/png.latex?X"> to stand in for all the feature levels and <img src="https://latex.codecogs.com/png.latex?Z"> for all the individual characteristics, we’ll expand those to include all the covariates we’re using. And instead of calling the distribution “Multinomial logit” we’ll call it “Categorical” so it aligns with Stan. It’ll make for a <em>really massive formula</em>, but it shows what’s really going on.</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B2_j%7D%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B3_j%7D%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B4_j%7D%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B5_j%7D%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B6_j%7D%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B7_j%7D%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B20pt%5D%20%20%0A&amp;%5C%20%5Ctextbf%7BRespondent-specific%20slopes%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7_j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%20%5Csim&amp;%5C%20%5Coperatorname%7BMultivariate%7D%5C%20%5Cmathcal%7BN%7D%20%5Cleft%5B%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_%7B0j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright%5D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>&nbsp;</p>
<p>Importantly, pay attention to where the choice-level and respondent-level variables show up in this expanded version. All the choice-level variables have respondent-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients, while the respondent-level variable (<code>carpool</code>) is down in that massive multivariate normal matrix with its own <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> coefficients, helping determine the respondent-specific <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> coefficients. That’s great and exactly what we want, and we can do that with raw Stan, but raw Stan is no fun.</p>
<p>We can create this exact same model structure with {brms} like this:</p>
<div class="sourceCode" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb80-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choice-level predictors that are nested within respondents...</span></span>
<span id="cb80-3">  (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb80-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...interacted with all respondent-level predictors...</span></span>
<span id="cb80-5">  (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb80-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... with random respondent-specific slopes for the</span></span>
<span id="cb80-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># nested choice-level predictors</span></span>
<span id="cb80-8">  (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id))</span></code></pre></div>
<p>We can confirm that this worked by using <a href="https://datalorax.github.io/equatiomatic/">the miraculous {equatiomatic} package</a>, which automatically converts model objects into LaTeX code. {equatiomatic} doesn’t work with {brms} models, but it does work with frequentist {lme4} models, so we can fit a throwaway frequentist model with this syntax (it won’t actually converge and it’ll give a warning, but that’s fine—we don’t actually care about this model) and then feed it to <code>equatiomatic::extract_eq()</code> to see what it looks like in formal notation.</p>
<p>(This is actually how I figured out the correct combination of interactions and random slopes—I kept trying different combinations that I thought were right until the math matched the huge full model above, with the <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> terms in the right places.)</p>
<div class="cell column-page" data-layout-align="center" data-hash="index_cache/html/lme4-equatiomatic_11cd43e0bdfaf4c833f9c444c77012c6">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lme4)</span>
<span id="cb81-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(equatiomatic)</span>
<span id="cb81-3"></span>
<span id="cb81-4">model_throwaway <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lmer</span>(</span>
<span id="cb81-5">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb81-6">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id),</span>
<span id="cb81-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans</span>
<span id="cb81-8">)</span>
<span id="cb81-9"></span>
<span id="cb81-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_eq</span>(model_throwaway))</span></code></pre></div>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%5Coperatorname%7Bchoice%7D_%7Bi%7D%20%20&amp;%5Csim%20N%20%5Cleft(%5Cmu,%20%5Csigma%5E2%20%5Cright)%20%5C%5C%0A%20%20%20%20%5Cmu%20&amp;=%5Calpha_%7Bj%5Bi%5D%7D%20+%20%5Cbeta_%7B1j%5Bi%5D%7D(%5Coperatorname%7Bseat%7D_%7B%5Coperatorname%7B7%7D%7D)%20+%20%5Cbeta_%7B2j%5Bi%5D%7D(%5Coperatorname%7Bseat%7D_%7B%5Coperatorname%7B8%7D%7D)%20+%20%5Cbeta_%7B3j%5Bi%5D%7D(%5Coperatorname%7Bcargo%7D_%7B%5Coperatorname%7B3ft%7D%7D)%20+%20%5Cbeta_%7B4j%5Bi%5D%7D(%5Coperatorname%7Beng%7D_%7B%5Coperatorname%7Bhyb%7D%7D)%20+%20%5Cbeta_%7B5j%5Bi%5D%7D(%5Coperatorname%7Beng%7D_%7B%5Coperatorname%7Belec%7D%7D)%20+%20%5Cbeta_%7B6j%5Bi%5D%7D(%5Coperatorname%7Bprice%7D_%7B%5Coperatorname%7B35%7D%7D)%20+%20%5Cbeta_%7B7j%5Bi%5D%7D(%5Coperatorname%7Bprice%7D_%7B%5Coperatorname%7B40%7D%7D)%20%5C%5C%20%20%20%20%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Calpha_%7Bj%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%20%20&amp;%5Csim%20N%20%5Cleft(%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma_%7B0%7D%5E%7B%5Calpha%7D%20+%20%5Cgamma_%7B1%7D%5E%7B%5Calpha%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D(%5Coperatorname%7Bcarpool%7D_%7B%5Coperatorname%7Byes%7D%7D)%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Calpha_%7Bj%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Calpha_%7Bj%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B7j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright)%0A%20%20%20%20%5Ctext%7B,%20for%20resp.id%20j%20=%201,%7D%20%5Cdots%20%5Ctext%7B,J%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<section id="different-variations-of-group-level-interactions" class="level3">
<h3 class="anchored" data-anchor-id="different-variations-of-group-level-interactions">Different variations of group-level interactions</h3>
<p>This syntax is a special R shortcut for interacting <code>carpool</code> with each of the feature variables:</p>
<div class="sourceCode" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Short way</span></span>
<span id="cb82-2">(seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool)</span>
<span id="cb82-3"></span>
<span id="cb82-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This expands to this</span></span>
<span id="cb82-5">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool</span></code></pre></div>
<p>If we had other respondent-level columns like age (<code>age</code>) and education (<code>ed</code>), the shortcut syntax is really helpful:</p>
<div class="sourceCode" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Short way</span></span>
<span id="cb83-2">(seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ed)</span>
<span id="cb83-3"></span>
<span id="cb83-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This expands to this</span></span>
<span id="cb83-5">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb83-6">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb83-7">seat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ed</span></code></pre></div>
<p>We don’t necessarily need to fully interact everything. For instance, if we have theoretical reasons to think that carpool status is associated with seat count preferences, but not other features, we can only interact <code>seat</code> and <code>carpool</code>:</p>
<div class="sourceCode" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb84-2">    (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb84-3">  (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id))</span></code></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model running times
</div>
</div>
<div class="callout-body-container callout-body">
<p>The more individual-level interactions you add, the longer it will take for the model to run. As we’ll see below, interacting <code>carpool</code> with the four feature levels takes ≈30 minutes to fit. As you add more individual-level interactions, the running time blows up.</p>
<p>In the replication code for <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (2021)</span>, where they model a ton of individual variables, they say it takes several days to run. Our models in <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">Chaudhry, Dotson, and Heiss (2021)</span> take hours and hours to run.</p>
</div>
</div>
</section>
</section>
<section id="mlogit-model-2" class="level2">
<h2 class="anchored" data-anchor-id="mlogit-model-2"><code>mlogit</code> model</h2>
<p>{mlogit} can estimate hierarchical models with something like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the random parameters</span></span>
<span id="cb85-2">model_mlogit_rpar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef))</span>
<span id="cb85-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(model_mlogit_rpar) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(model_minivans_mlogit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef)</span>
<span id="cb85-4"></span>
<span id="cb85-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This means these random terms are all normally distributed</span></span>
<span id="cb85-6">model_mlogit_rpar</span>
<span id="cb85-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; seat7    seat8 cargo3ft   enghyb  engelec  price35  price40 </span></span>
<span id="cb85-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   "n"      "n"      "n"      "n"      "n"      "n"      "n" </span></span>
<span id="cb85-9"></span>
<span id="cb85-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the model with carpool as an individual-level covariate</span></span>
<span id="cb85-11">model_mlogit_hierarchical <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mlogit</span>(</span>
<span id="cb85-12">  choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> carpool,</span>
<span id="cb85-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_idx,</span>
<span id="cb85-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rpar =</span> model_mlogit_rpar, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">correlation =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb85-15">)</span>
<span id="cb85-16"></span>
<span id="cb85-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the results</span></span>
<span id="cb85-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(model_mlogit_hierarchical)</span></code></pre></div>
</div>
<p>However, I’m not a frequentist and I’m already not a huge fan of extracting the predictions and AMCEs from these {mlogit} models. Running and interpreting and working with the results of that object is left as an exercise for the reader :). (See p.&nbsp;381 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (2019)</span> for a worked example of how to do it.)</p>
</section>
<section id="finally-the-full-brms-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="finally-the-full-brms-model">Finally, the full {brms} model</h2>
<p>This is a really complex model with a ton of moving parts, but it’s also incredibly powerful. It lets us account for individual-specific differences across each of the minivan features. For instance, whether an individual carpools probably influences their preferences for the number of seats, and maybe cargo space, but probably doesn’t influence their preferences for engine type. If we had other individual-level characteristics, we could also let those influence feature preferences. Like, the number of kids an individual has probably influences seat count preferences; the individual’s income probably influences their price preferences; and so on.</p>
<p>Let’s define the model more formally again, this time with priors for the parameters we’ll be estimating:</p>
<div class="column-page-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BMultinomial%20probability%20of%20selection%20of%20choice%7D_i%20%5Ctextbf%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Ctext%7BChoice%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BCategorical%7D(%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BModel%20for%20probability%20of%20each%20option%7D%20%5C%5C%0A%5C%7B%5Cmu_%7B1,i_j%7D,%20%5Cmu_%7B2,i_j%7D,%20%5Cmu_%7B3,i_j%7D%5C%7D%20=&amp;%5C%20%5Cbeta_%7B0_j%7D%20+%20%5Cbeta_%7B1_j%7D%20%5Ctext%7BSeat%5B7%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B2_j%7D%20%5Ctext%7BSeat%5B8%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B3_j%7D%20%5Ctext%7BCargo%5B3ft%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B4_j%7D%20%5Ctext%7BEngine%5Bhyb%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B5_j%7D%20%5Ctext%7BEngine%5Belec%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_%7B6_j%7D%20%5Ctext%7BPrice%5B35k%5D%7D_%7Bi_j%7D%20+%20%5Cbeta_%7B7_j%7D%20%5Ctext%7BPrice%5B40k%5D%7D_%7Bi_j%7D%20%5C%5C%5B20pt%5D%20%20%0A&amp;%5C%20%5Ctextbf%7BRespondent-specific%20slopes%7D%20%5C%5C%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B0_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B1_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B2_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B3_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B4_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B5_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B6_j%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cbeta_%7B7_j%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%20%5Csim&amp;%5C%20%5Coperatorname%7BMultivariate%7D%5C%20%5Cmathcal%7BN%7D%20%5Cleft%5B%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B0%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B1%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B2%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B3%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B4%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B5%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B6%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%20%5C%5C%0A%20%20%20%20%20%20&amp;%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B0%7D%20+%20%5Cgamma%5E%7B%5Cbeta_%7B7%7D%7D_%7B1%7D%5Ctext%7BCarpool%7D%0A%20%20%20%20%5Cend%7Baligned%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A,%0A%5Cleft(%0A%20%20%5Cbegin%7Barray%7D%7Bcccccccc%7D%0A%20%20%20%20%20%5Csigma%5E2_%7B%5Cbeta_%7B0j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B0j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B1j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B1j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B2j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B2j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B3j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B3j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B4j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B4j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B5j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B5j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B6j%7D%7D%20&amp;%20%5Crho_%7B%5Cbeta_%7B6j%7D%5Cbeta_%7B7j%7D%7D%20%5C%5C%0A%20%20%20%20%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Cdots%20&amp;%20%5Csigma%5E2_%7B%5Cbeta_%7B7j%7D%7D%0A%20%20%5Cend%7Barray%7D%0A%5Cright)%0A%5Cright%5D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Cbeta_%7B0%20%5Cdots%207%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5B%5Ctext%7BPrior%20for%20choice-level%20coefficients%7D%5D%20%5C%5C%0A%5Cgamma%5E%7B%5Cbeta_%7B0%20%5Cdots%207%7D%7D_0%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D%20(0,%203)%20%5Cqquad%5Cqquad%5C%20%5B%5Ctext%7BPrior%20for%20individual-level%20coefficients%7D%5D%20%5C%5C%0A%5Csigma_%7B%5Cbeta_%7B0%20%5Cdots%207%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20%5Cqquad%20%5B%5Ctext%7BPrior%20for%20between-respondent%20intercept%20and%20slope%20variability%7D%5D%20%5C%5C%0A%5Crho%20%5Csim&amp;%5C%20%5Coperatorname%7BLKJ%7D(1)%20%5Cqquad%5Cqquad%20%5B%5Ctext%7BPrior%20for%20correlation%20between%20random%20slopes%20and%20intercepts%7D%5D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>&nbsp;</p>
<p>Here it is in code form. There are a couple new things here in the Stan settings. First, we’re going to create 4 MCMC chains with 4,000 draws rather than 2,000—there are so many parameters to be estimated that we need to let the simulation run longer. Second, we’ve modified the <code>adapt_delta</code> setting to 0.99. Conceptually, this adjusts the size of the steps the MCMC algorithm takes as it traverses the posterior space for each parameter—higher numbers make the steps smaller and more granular. This slows down the MCMC simulation, but it also helps avoid divergent transitions (or failed out-of-bounds draws).</p>
<p>On my 2021 M1 MacBook Pro, running through cmdstanr with 2 CPU cores per chain, it took about 30 minutes to fit. If you’re following along with this post, start running this and go get some lunch or go for a walk or something.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pre-run model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Alternatively, you can download <a href="https://osf.io/zp6eh">an .rds file of this completed</a>. This <code>brm()</code> code load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(osfr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interact with OSF via R</span></span>
<span id="cb86-2"></span>
<span id="cb86-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb86-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>)) { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>) }</span>
<span id="cb86-5"></span>
<span id="cb86-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb86-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_retrieve_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://osf.io/zp6eh"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb86-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osf_download</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conflicts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overwrite"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1">model_minivans_mega_mlm_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb87-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice_alt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb87-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choice-level predictors that are nested within respondents...</span></span>
<span id="cb87-4">    (seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb87-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...interacted with all respondent-level predictors...</span></span>
<span id="cb87-6">    (carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb87-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... with random respondent-specific slopes for the</span></span>
<span id="cb87-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># nested choice-level predictors</span></span>
<span id="cb87-9">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> seat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cargo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eng <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp.id)),</span>
<span id="cb87-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> minivans_choice_alt,</span>
<span id="cb87-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refcat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>),</span>
<span id="cb87-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb87-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb87-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb87-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb87-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu1),</span>
<span id="cb87-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu2),</span>
<span id="cb87-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> mu3),</span>
<span id="cb87-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lkj</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> cor)</span>
<span id="cb87-20">  ),</span>
<span id="cb87-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb87-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># refresh = 0,</span></span>
<span id="cb87-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>),</span>
<span id="cb87-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"models/model_minivans_mega_mlm_brms"</span></span>
<span id="cb87-25">)</span></code></pre></div>
</div>
<p>This model is incredibly rich. We just estimated more than 5,000 parameters (!!!)—we have three sets of coefficients for each of the three options, and those are all interacted with <code>carpool</code>, plus we have individual-specific offsets to each of those coefficients, plus all the <img src="https://latex.codecogs.com/png.latex?%5Crho"> terms in that massive correlation matrix.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_variables</span>(model_minivans_mega_mlm_brms))</span>
<span id="cb88-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 5156</span></span></code></pre></div>
</div>
<p>Since we’re dealing with interaction terms, these raw log odds coefficients are even <em>less</em> helpful on their own. It’s nearly impossible to interpret these coefficients in any meaningful way—there’s no point in even trying to combine each of the individual parts of each effect (random parts, interaction parts, etc.). The only way we’ll be able to interpret these things is by making predictions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1">minivans_mega_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_mega_mlm_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">^b_.*$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regex =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb89-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb89-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb89-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable name ("seat6")</span></span>
<span id="cb89-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_regex</span>(</span>
<span id="cb89-8">    .variable,</span>
<span id="cb89-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patterns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_mu</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d_"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*"</span>)</span>
<span id="cb89-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb89-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb89-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.value)) </span>
<span id="cb89-15"></span>
<span id="cb89-16">minivans_mega_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.variable) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb89-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.value)</span>
<span id="cb89-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 16 × 7</span></span>
<span id="cb89-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    .variable            .value  .lower  .upper .width .point .interval</span></span>
<span id="cb89-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb89-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 Intercept           -0.127  -0.281   0.0321   0.95 median qi       </span></span>
<span id="cb89-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 cargo3ft             0.405   0.290   0.521    0.95 median qi       </span></span>
<span id="cb89-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 cargo3ft:carpoolyes  0.162  -0.0488  0.380    0.95 median qi       </span></span>
<span id="cb89-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 carpoolyes          -0.718  -1.00   -0.437    0.95 median qi       </span></span>
<span id="cb89-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 engelec             -1.59   -1.77   -1.42     0.95 median qi       </span></span>
<span id="cb89-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 engelec:carpoolyes   0.0852 -0.211   0.375    0.95 median qi       </span></span>
<span id="cb89-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 enghyb              -0.774  -0.910  -0.640    0.95 median qi       </span></span>
<span id="cb89-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 enghyb:carpoolyes   -0.0543 -0.307   0.196    0.95 median qi       </span></span>
<span id="cb89-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 price35             -0.812  -0.947  -0.675    0.95 median qi       </span></span>
<span id="cb89-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 price35:carpoolyes  -0.164  -0.414   0.0845   0.95 median qi       </span></span>
<span id="cb89-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 price40             -1.58   -1.74   -1.43     0.95 median qi       </span></span>
<span id="cb89-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 price40:carpoolyes  -0.248  -0.528   0.0320   0.95 median qi       </span></span>
<span id="cb89-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 seat7               -0.879  -1.03   -0.735    0.95 median qi       </span></span>
<span id="cb89-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 seat7:carpoolyes     1.14    0.872   1.41     0.95 median qi       </span></span>
<span id="cb89-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 seat8               -0.646  -0.794  -0.501    0.95 median qi       </span></span>
<span id="cb89-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 16 seat8:carpoolyes     1.13    0.859   1.40     0.95 median qi</span></span></code></pre></div>
</div>
</section>
<section id="predictions-2" class="level2">
<h2 class="anchored" data-anchor-id="predictions-2">Predictions</h2>
<p>In the non-hierarchical model earlier, we made marketing-style predictions by thinking of a product mix and figuring out the predicted utility and market share of each product in that mix. We can do the same thing here, but now we can incorporate individual-level characteristics too.</p>
<p>Here’s our example product mix again, but this time we’ll repeat it twice—once with <code>carpool</code> set to “yes” and once with it set to “no”. This will let us see the predicted market share for each mix of products for a market of only carpoolers and only non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1">example_product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb90-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>seat, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>cargo, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>eng, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>price,</span>
<span id="cb90-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30"</span>,</span>
<span id="cb90-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb90-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"elec"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40"</span>,</span>
<span id="cb90-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2ft"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hyb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"35"</span></span>
<span id="cb90-9">)</span>
<span id="cb90-10"></span>
<span id="cb90-11">product_mix_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb90-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>),</span>
<span id="cb90-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(example_product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>)</span>
<span id="cb90-14">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb90-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), factor)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb90-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(minivans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eng)))</span></code></pre></div>
</div>
<p>We can now go through the same process from earlier where we get logit-scale predictions for this smaller dataset and find the shares inside each draw + category (options 1, 2, and 3) + carpool status group.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> product_mix_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_linpred_draws</span>(model_minivans_mega_mlm_brms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb91-3"></span>
<span id="cb91-4">shares_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb91-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># three outcomes across both levels of carpooling</span></span>
<span id="cb91-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb91-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(seat, cargo, eng, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb91-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(mix_type, share)</span>
<span id="cb91-13">  )</span></code></pre></div>
</div>
<p>This new dataset contains 576,000 (!!) rows: 6 products × 2 carpool types × 3 <img src="https://latex.codecogs.com/png.latex?%5Cmu">-specific sets of coefficients × 16,000 MCMC draws. We can summarize this to get posterior medians and credible intervals, making sure to find the average share across the three outcomes (choice 1, 2, and 3), or marginalizing across the outcome.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the three outcomes within each draw</span></span>
<span id="cb92-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb92-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(share)</span>
<span id="cb92-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 12 × 8</span></span>
<span id="cb92-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    mix_type      carpool   share  .lower .upper .width .point .interval</span></span>
<span id="cb92-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;         &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb92-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6 2ft elec 40 no      0.0217  0.0173  0.0272   0.95 median qi       </span></span>
<span id="cb92-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6 2ft elec 40 yes     0.00946 0.00647 0.0136   0.95 median qi       </span></span>
<span id="cb92-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 7 2ft hyb 35  no      0.0434  0.0350  0.0532   0.95 median qi       </span></span>
<span id="cb92-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 7 2ft hyb 35  yes     0.0573  0.0425  0.0761   0.95 median qi       </span></span>
<span id="cb92-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 7 3ft gas 40  no      0.0655  0.0533  0.0798   0.95 median qi       </span></span>
<span id="cb92-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 7 3ft gas 40  yes     0.0976  0.0716  0.130    0.95 median qi       </span></span>
<span id="cb92-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 7 2ft hyb 30  no      0.0972  0.0824  0.114    0.95 median qi       </span></span>
<span id="cb92-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 7 2ft hyb 30  yes     0.148   0.118   0.183    0.95 median qi       </span></span>
<span id="cb92-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 8 2ft gas 30  no      0.265   0.239   0.293    0.95 median qi       </span></span>
<span id="cb92-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 8 2ft gas 30  yes     0.423   0.367   0.479    0.95 median qi       </span></span>
<span id="cb92-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 6 2ft gas 30  no      0.506   0.472   0.540    0.95 median qi       </span></span>
<span id="cb92-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 6 2ft gas 30  yes     0.261   0.223   0.303    0.95 median qi</span></span></code></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1">shares_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(carpool, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the three outcomes within each draw</span></span>
<span id="cb93-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(mix_type, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb93-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> share, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mix_type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb93-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>),</span>
<span id="cb93-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb93-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(carpool)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb93-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted market share"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hypothetical product mix"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-shares-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is so cool! In general, the market share for these six hypothetical products is roughly the same across carpoolers and non-carpoolers, with one obvious exception—among non-carpoolers, the $30,000 8-passenger gas minivan with 2 feet of space has 26% of the market, while among carpoolers it has 42%. Individuals who carpool apparently <em>really</em> care about the number of passengers their vehicle can carry.</p>
</section>
<section id="amces-2" class="level2">
<h2 class="anchored" data-anchor-id="amces-2">AMCEs</h2>
<p>To find the average marginal component effects (AMCEs), or the causal effect of moving one of these features to another value, holding all other variables constant, we can go through the same process as before. We’ll calculate the predicted probabilities of choosing option 0, 1, 2, and 3 across a full grid of all the combinations of feature levels <em>and</em> carpool status. We’ll then filter those predictions to only look at option 0 and reverse the predicted probabilities. Again, that feels weird, but it’s a neat little trick—if there’s a 33% chance that someone will select a specific combination of features, that would imply a 66% chance of not selecting it and an 11% chance of selecting it when it appears in option 1, option 2, and option 3. Rather than adding the probabilities within those three options together, we can do 100% − 66% to get the same 33% value, only it’s automatically combined.</p>
<p>Earlier we had 54 combinations—now we have 108 (54 × 2). We’ll set <code>resp.id</code> to one that’s not in the dataset (201) so that these effects all deal with a generic hypothetical respondent (we could also do some fancy “integrating out” work and find population-level averages; <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/">see here for more about that</a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1">newdata_all_combos_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb94-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(seat, cargo, eng, price, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb94-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resp.id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">201</span>)</span>
<span id="cb94-4">newdata_all_combos_carpool</span>
<span id="cb94-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 108 × 6</span></span>
<span id="cb94-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    seat  cargo eng   price carpool resp.id</span></span>
<span id="cb94-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;     &lt;dbl&gt;</span></span>
<span id="cb94-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 6     2ft   gas   30    no          201</span></span>
<span id="cb94-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 6     2ft   gas   30    yes         201</span></span>
<span id="cb94-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 6     2ft   gas   35    no          201</span></span>
<span id="cb94-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 6     2ft   gas   35    yes         201</span></span>
<span id="cb94-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 6     2ft   gas   40    no          201</span></span>
<span id="cb94-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 6     2ft   gas   40    yes         201</span></span>
<span id="cb94-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 6     2ft   hyb   30    no          201</span></span>
<span id="cb94-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 6     2ft   hyb   30    yes         201</span></span>
<span id="cb94-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 6     2ft   hyb   35    no          201</span></span>
<span id="cb94-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 6     2ft   hyb   35    yes         201</span></span>
<span id="cb94-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 98 more rows</span></span></code></pre></div>
</div>
<p>Next we can plug this grid into the model, filter to only keep option 0, and reverse the predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1">all_preds_brms_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_minivans_mega_mlm_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(</span>
<span id="cb95-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newdata_all_combos_carpool,</span>
<span id="cb95-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">re_formula =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb95-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span></code></pre></div>
</div>
<p>This thing has 1.7 million rows in it, so we need to group and summarize to do anything useful with it. We also need to marginalize across all the other covariates when grouping (i.e.&nbsp;if we want the estimates for passenger seat count across carpool status, we need to average out all the other covariates).</p>
<p>To test that this worked, here are the posterior marginal means for seat count:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1">preds_seat_carpool_marginalized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb96-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb96-5"></span>
<span id="cb96-6">preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb96-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb96-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 8</span></span>
<span id="cb96-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  carpool   avg .lower .upper .width .point .interval</span></span>
<span id="cb96-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb96-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 6     no      0.425  0.377  0.483   0.95 median qi       </span></span>
<span id="cb96-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 6     yes     0.287  0.245  0.339   0.95 median qi       </span></span>
<span id="cb96-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 7     no      0.262  0.205  0.337   0.95 median qi       </span></span>
<span id="cb96-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 7     yes     0.335  0.267  0.419   0.95 median qi       </span></span>
<span id="cb96-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 8     no      0.305  0.225  0.409   0.95 median qi       </span></span>
<span id="cb96-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 8     yes     0.378  0.288  0.488   0.95 median qi</span></span></code></pre></div>
</div>
<p>Those credible intervals all look reasonable (i.e.&nbsp;not ranging from 5% to 80% or whatever), but it’s hard to see any trends from just this table. Let’s plot it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1">preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb97-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb97-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb97-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb97-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb97-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb97-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb97-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb97-11">    )</span>
<span id="cb97-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb97-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>,</span>
<span id="cb97-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb97-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb97-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb97-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb97-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb97-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb97-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb97-22">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-marginal-means-seat-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Neat! The average posterior predicted probability of choosing six seats is substantially higher for carpoolers than for non-carpoolers, while the probability for seven and eight seats is bigger for carpoolers.</p>
<p>We’re most interested in the AMCE though, and not the marginal means, so we’ll use <code>compare_levels()</code> to find the carpool-specific differences between the effect of moving from 6 → 7 and 6 → seats:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1">amces_seat_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> preds_seat_carpool_marginalized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) </span>
<span id="cb98-4"></span>
<span id="cb98-5">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb98-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb98-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 8</span></span>
<span id="cb98-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   carpool seat      avg  .lower   .upper .width .point .interval</span></span>
<span id="cb98-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb98-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 no      7 - 6 -0.162  -0.231  -0.0877    0.95 median qi       </span></span>
<span id="cb98-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 no      8 - 6 -0.120  -0.219  -0.00669   0.95 median qi       </span></span>
<span id="cb98-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 yes     7 - 6  0.0478 -0.0247  0.129     0.95 median qi       </span></span>
<span id="cb98-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 yes     8 - 6  0.0912 -0.0114  0.207     0.95 median qi</span></span></code></pre></div>
</div>
<p>Among carpoolers, the causal effect of moving from 6 → 7 passengers, holding all other features constant, is a 5ish percentage point increase in the probability of selecting the vehicle. The effect is bigger (9ish percentage points) when moving from 6 → 8.</p>
<p>Among non-carpoolers, the causal effect is reversed. Moving from 6 → 7 passengers causes a 16 percentage point decrease in the probability of selection, while moving from 6 → 8 causes a 12 percentage point decrease, holding all other features constant.</p>
<p>These effects are “significant” and have a 90–97% probability of being greater than zero for carpoolers and 98–99% probability of being less than zero for the non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate probability of direction</span></span>
<span id="cb99-2">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_gt_0 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(avg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb99-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_lt_0 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_gt_0)</span>
<span id="cb99-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 4</span></span>
<span id="cb99-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   seat [2]</span></span>
<span id="cb99-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   seat  carpool   p_gt_0 p_lt_0</span></span>
<span id="cb99-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb99-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 7 - 6 no      0.000625 0.999 </span></span>
<span id="cb99-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 7 - 6 yes     0.908    0.0916</span></span>
<span id="cb99-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 8 - 6 no      0.0208   0.979 </span></span>
<span id="cb99-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 8 - 6 yes     0.961    0.0387</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1">amces_seat_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb100-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> seat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb100-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb100-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb100-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb100-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb100-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb100-12">    )</span>
<span id="cb100-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb100-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of minivan selection"</span>,</span>
<span id="cb100-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb100-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb100-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb100-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb100-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb100-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb100-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb100-23">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-seat-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Here are all the AMCEs across carpool status:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1">amces_minivan_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb101-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seat =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(seat, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> seat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> seat),</span>
<span id="cb101-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cargo =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cargo, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> cargo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> cargo),</span>
<span id="cb101-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eng =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(eng, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> eng, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> eng),</span>
<span id="cb101-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> all_preds_brms_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(price, carpool, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> price),</span>
<span id="cb101-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"term"</span></span>
<span id="cb101-23">)</span>
<span id="cb101-24"></span>
<span id="cb101-25">amces_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, carpool, contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb101-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(avg)</span>
<span id="cb101-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 14 × 9</span></span>
<span id="cb101-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term  carpool contrast       avg  .lower   .upper .width .point .interval</span></span>
<span id="cb101-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt; &lt;fct&gt;   &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb101-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 cargo no      3ft - 2ft   0.0750  0.0358  0.117     0.95 median qi       </span></span>
<span id="cb101-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 cargo yes     3ft - 2ft   0.102   0.0555  0.152     0.95 median qi       </span></span>
<span id="cb101-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 eng   no      elec - gas -0.288  -0.400  -0.147     0.95 median qi       </span></span>
<span id="cb101-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 eng   no      hyb - gas  -0.160  -0.208  -0.108     0.95 median qi       </span></span>
<span id="cb101-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 eng   yes     elec - gas -0.273  -0.389  -0.125     0.95 median qi       </span></span>
<span id="cb101-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 eng   yes     hyb - gas  -0.166  -0.223  -0.104     0.95 median qi       </span></span>
<span id="cb101-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 price no      35 - 30    -0.167  -0.223  -0.107     0.95 median qi       </span></span>
<span id="cb101-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 price no      40 - 30    -0.294  -0.354  -0.230     0.95 median qi       </span></span>
<span id="cb101-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 price yes     35 - 30    -0.203  -0.270  -0.131     0.95 median qi       </span></span>
<span id="cb101-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 price yes     40 - 30    -0.342  -0.412  -0.272     0.95 median qi       </span></span>
<span id="cb101-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 seat  no      7 - 6      -0.162  -0.231  -0.0877    0.95 median qi       </span></span>
<span id="cb101-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 seat  no      8 - 6      -0.120  -0.219  -0.00669   0.95 median qi       </span></span>
<span id="cb101-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 seat  yes     7 - 6       0.0478 -0.0247  0.129     0.95 median qi       </span></span>
<span id="cb101-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 seat  yes     8 - 6       0.0912 -0.0114  0.207     0.95 median qi</span></span></code></pre></div>
</div>
<p>And finally, here’s a polisci-style plot of all these AMCEs, which is so so neat. An individual’s carpooling behavior interacts with seat count (increasing the seat count causes carpoolers to select the minivan more often), and it also interacts a bit with cargo space (increasing the cargo space makes both types of individuals more likely to select the minivan, but moreso for carpoolers) and also with price (increasing the price makes both types of individuals less likely to select the minivan, but moreso for carpoolers). Switching from gas → hybrid and gas → electric has a negative effect on both types of consumers, and there’s no carpooling-based difference.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Extract variable labels</summary>
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1">minivan_var_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb102-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>)</span>
<span id="cb102-3">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb102-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivans[[.x]]</span>
<span id="cb102-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb102-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb102-8">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb102-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb102-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb102-11">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb102-12">    }</span>
<span id="cb102-13">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb102-16"></span>
<span id="cb102-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb102-18">minivan_var_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb102-19">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb102-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seat"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passengers"</span>,</span>
<span id="cb102-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cargo"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cargo space"</span>,</span>
<span id="cb102-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eng"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Engine type"</span>,</span>
<span id="cb102-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Price (thousands of $)"</span></span>
<span id="cb102-24">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb102-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Combine full dataset of factor levels with marginalized posterior draws and make plot</summary>
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1">posterior_amces_minivan_carpool_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> amces_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb103-3">    contrast,</span>
<span id="cb103-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb103-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb103-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb103-9"></span>
<span id="cb103-10">plot_data_minivan_carpool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> minivan_var_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb103-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb103-12">    posterior_amces_minivan_carpool_nested,</span>
<span id="cb103-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb103-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb103-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(minivan_var_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the missing carpool values be "yes" for the reference category</span></span>
<span id="cb103-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carpool =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(carpool, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>))</span>
<span id="cb103-21"></span>
<span id="cb103-22">plot_data_minivan_carpool <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb103-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> carpool), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb103-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_slab_alpha_discrete</span>(</span>
<span id="cb103-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb103-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-carpoolers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carpoolers"</span>),</span>
<span id="cb103-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb103-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey10"</span>), </span>
<span id="cb103-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb103-34">    )</span>
<span id="cb103-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb103-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of minivan selection"</span>,</span>
<span id="cb103-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb103-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs across respondent carpool status"</span>,</span>
<span id="cb103-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_alpha =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb103-42">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb103-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb103-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb103-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb103-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb103-47">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="tldr-moral-of-the-story" class="level1">
<h1>tl;dr: Moral of the story</h1>
<p>holy crap this might be the longest guide I’ve ever posted here. This is hard.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Main points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>OLS is nice and easy, but it fails to capture all the dynamics between sets of features and individual characteristics. Use multilevel multinomial models to account for all the heterogeneity in choices and individuals.</p></li>
<li><p>{brms} provides a powerful, easy-to-use frontend for running complex multilevel models in Stan. There’s no need to write raw Stan code if you don’t want to.</p></li>
<li><p>This is hard stuff. Multinomial logit models are complex and weird to work with. But the power and flexibility and richness is worth it.</p></li>
</ul>
</div>
</div>
<p>Here’s a general summary of the main code for all this, based on a hypothetical conjoint survey with three features, like this:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Brand (<code>brand</code>)</td>
<td style="text-align: left;">A, B, C</td>
</tr>
<tr class="even">
<td style="text-align: left;">Color (<code>color</code>)</td>
<td style="text-align: left;">Blue, red, yellow</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Size (<code>size</code>)</td>
<td style="text-align: left;">Small, large</td>
</tr>
</tbody>
</table>
<p>And imagine that we have data on respondent age (<code>resp_age</code>) and education (<code>resp_ed</code>).</p>
<ul>
<li><p>Specify a full luxury multilevel model with individual-level characteristics informing choice-level coefficients like this (see here):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb104-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(choice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb104-3">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Columns for feature interacted with respondent-level covariates</span></span>
<span id="cb104-4">      (brand <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> color <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> size) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (resp_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> resp_ed) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-5">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Respondent-specific intercepts and slopes for all features</span></span>
<span id="cb104-6">      (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> brand <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> color <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resp_id)),</span>
<span id="cb104-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(),</span>
<span id="cb104-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data</span>
<span id="cb104-9">)</span></code></pre></div>
</div></li>
<li><p>Find marketing-style predicted shares for hypothetical mixes of products by feeding a smaller dataset of hypothetical mixes to <code>brms::posterior_linpred()</code> (or <code>tidybayes::linpred_draws()</code>) to find utility (or logit-scale predictions), then calculate the share for each draw, and then marginalize (or average) the shares across the multiple choices within each draw. (See here.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1">product_mix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb105-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>brand, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>color,   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>size,   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resp_age,</span>
<span id="cb105-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blue"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Red"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellow"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Large"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb105-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blue"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>,</span>
<span id="cb105-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Red"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>,</span>
<span id="cb105-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellow"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Large"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span></span>
<span id="cb105-9">)</span>
<span id="cb105-10"></span>
<span id="cb105-11">model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linpred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> product_mix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.draw, .category, resp_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(utility))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize across the outcomes within each draw</span></span>
<span id="cb105-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, color, size, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb105-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(share))</span></code></pre></div>
</div></li>
<li><p>Find political science-style marginal means and AMCEs by feeding a <em>complete grid of all possible feature levels</em>, along with any respondent-level characteristics of interest to <code>brms::posterior_epred()</code> (or <code>tidybayes::epred_draws()</code>), then filter those probabilities to look only at option 0 (i.e.&nbsp;not choosing an option), and calculate <code>1 - prediction</code> to reverse it. Then group by the feature level and respondent-level characteristics you’re interested in, find the average of predictions, and marginalize (or average) out the other covariates in each draw. (See here.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1">all_feature_combos_with_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-2">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand</span>(brand, color, size, resp_age)</span>
<span id="cb106-3"></span>
<span id="cb106-4">all_predictions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> all_feature_combos_with_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only look at category 0 and reverse predictions</span></span>
<span id="cb106-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.category <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .epred)</span>
<span id="cb106-9"></span>
<span id="cb106-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginal means for brand across respondent age</span></span>
<span id="cb106-11">all_predictions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb106-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred))</span>
<span id="cb106-15"></span>
<span id="cb106-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AMCEs for brand across respondent age</span></span>
<span id="cb106-17">all_predictions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginalize out the other covariates in each draw</span></span>
<span id="cb106-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(brand, resp_age, .draw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resp_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb106-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> avg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> brand, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>)</span></code></pre></div>
</div></li>
</ul>
<hr>
<p>Fin.</p>


<!-- -->


</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ChapmanFeit:2019" class="csl-entry">
Chapman, Chris, and Elea McDonnell Feit. 2019. <em>R For Marketing Research and Analytics</em>. 2nd ed. Use R! Cham, Switzerland: Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-030-14316-9">https://doi.org/10.1007/978-3-030-14316-9</a>.
</div>
<div id="ref-ChaudhryDotsonHeiss:2021" class="csl-entry">
Chaudhry, Suparna, Marc Dotson, and Andrew Heiss. 2021. <span>“Who Cares about Crackdowns? Exploring the Role of Trust in Individual Philanthropy.”</span> <em>Global Policy</em> 12 (S5): 45–58. <a href="https://doi.org/10.1111/1758-5899.12984">https://doi.org/10.1111/1758-5899.12984</a>.
</div>
<div id="ref-GelmanHill:2007" class="csl-entry">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511790942">https://doi.org/10.1017/CBO9780511790942</a>.
</div>
<div id="ref-JensenMarbleScheve:2021" class="csl-entry">
Jensen, Amalie, William Marble, Kenneth Scheve, and Matthew J. Slaughter. 2021. <span>“City Limits to Partisan Polarization in the American Public.”</span> <em>Political Science Research and Methods</em> 9 (2): 223–41. <a href="https://doi.org/10.1017/psrm.2020.56">https://doi.org/10.1017/psrm.2020.56</a>.
</div>
<div id="ref-Kuhfeld:2010" class="csl-entry">
Kuhfeld, Warren F. 2010. <span>“Discrete Choice.”</span> SAS Technical Paper MR2010F. SAS Institute. <a href="http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html">http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {The Ultimate Practical Guide to Multilevel Multinomial
    Conjoint Analysis with {R}},
  date = {2023-08-12},
  url = {https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide},
  doi = {10.59350/2mz75-rrc46},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“The Ultimate Practical Guide to Multilevel
Multinomial Conjoint Analysis with R.”</span> August 12, 2023. <a href="https://doi.org/10.59350/2mz75-rrc46">https://doi.org/10.59350/2mz75-rrc46</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>statistics</category>
  <category>brms</category>
  <category>stan</category>
  <guid>https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index.html</guid>
  <pubDate>Fri, 11 Aug 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png" medium="image" type="image/png" height="120" width="144"/>
</item>
<item>
  <title>How to fill maps with density gradients with R, {ggplot2}, and {sf}</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index.html</link>
  <description><![CDATA[ 




<p>The students in my <a href="https://datavizs23.classes.andrewheiss.com/">summer data visualization class</a> are finishing up their <a href="https://datavizs23.classes.andrewheiss.com/assignment/final-project.html">final projects</a> this week and I’ve been answering a bunch of questions on our class Slack. Often these are relatively standard reminders of how to tinker with specific ggplot layers (chaning the colors of a legend, adding line breaks in labels, etc.), but today one student had a fascinating and tricky question that led me down a realy fun dataviz rabbit hole. She was making a map with hundreds of points representing specific locations of events. This led to <a href="https://r-graphics.org/recipe-scatter-overplot">overplotting</a>—it’s really hard to stick hundreds of dots on a small map of a city and have it make any sense. To help fix this, she wanted to fill areas of the map by the count of events, making a filled gradient rather than a bunch of points. This is fairly straightforward with regular scatterplots, but working with geographic data adds some extra wrinkles to the process.</p>
<p>So let’s all go down this rabbit hole together (mostly so future-me can remember how to do this)!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re somewhat familiar with <a href="https://r-spatial.github.io/sf/">{sf}</a> for working with geographic data. I have a <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html">whole tutorial here</a> and a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles">simplified one here</a> and the <a href="https://r-spatial.github.io/sf/">{sf} documentation has a ton of helpful vignettes and blog posts</a>, and there are also two free books about it: <a href="https://r-spatial.org/book/"><em>Spatial Data Science</em></a> and <a href="https://r.geocompx.org/"><em>Geocomputation with R</em></a>. Also <a href="https://www.jessesadler.com/post/simple-feature-objects/">check this fantastic post out</a> to learn more about the anatomy of a <code>geometry</code> column with {sf}.</li>
</ul>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(spatstat)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tigris)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rnaturalearth)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(</span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Roboto Slab"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb1-11">)</span></code></pre></div>
</div>
<section id="fixing-overplotted-scatterplots" class="level1">
<h1>Fixing overplotted scatterplots</h1>
<p>Overplotting happens when there are too many data points in one place in a plot. For instance, here’s a scatterplot of carats and prices for 54,000 diamonds, using {ggplot2}’s built-in <code>diamonds</code> dataset:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(diamonds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-overplot-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>Woof. It’s just a blob of black points.</p>
<p>To fix overplotting, you can either restyle the points somehow so they’re not so crowded, or you can summarize the data and display it a slightly different way. There are lots of possible ways to fix this though—here’s a quick overview of some:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">Smaller points</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Semi-transparent points</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">■-binned points</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false">⬢-binned points</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false">Density countours</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>We can try shrinking the points down a bunch:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(diamonds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-size-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>We can make the points partially transparent so that clusters of points are darker (with more points stacked on top of each other)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(diamonds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-alpha-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p>We can draw a grid across the x- and y-axes and count how many points fall inside each box, then fill each box by that count.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(diamonds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_bin2d</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-bin-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<p>We can draw a hexagonal grid across the x- and y-axes and count how many points fall inside each hexagon, then fill each hexagon by that count.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(diamonds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_binhex</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-hexbin-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<p>We can also find the combined density of points along both the x- and y-axes and plot the contours of those densities. Here, the brighter the area, the more concentrated the points:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">withr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4393</span>, {</span>
<span id="cb7-2">  dsmall <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diamonds[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(diamonds), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>), ]</span>
<span id="cb7-3">})</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dsmall, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> carat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density2d_filled</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-xy-density-contour-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="initial-overplotted-map" class="level1">
<h1>Initial overplotted map</h1>
<p>Geographic data, however, is a little trickier to work with. Fundamentally, putting points on a map is the same as making a scatterplot, with latitude on the x-axis and longitude on the y-axis. But maps are strange. Scatterplots are nice rectangles; maps have oddly shaped borders. Scatterplots are naturally flat; maps are curved chunks of a globe and <a href="https://www.youtube.com/watch?v=kIID5FDi2JQ">have to be flattened</a> and <a href="https://observablehq.com/@d3/projection-comparison">reprojected</a> into two dimensions somehow. Scatterplots come from nice rectangular datasets; maps from from complex shapefiles.</p>
<p>Shrinking and transparentifying points with map points is the same as with regular points: play with the <code>size</code> and <code>alpha</code> arguments in <code>geom_sf()</code>. Making bins and gradients, however, takes a little more work (hence this rabbit hole).</p>
<p>To illustrate this, we’ll plot all 264 campgrounds in the state of Georgia. This doesn’t involve <em>severe</em> overplotting (though at the end I’ve included an example of dealing with 10,000 map points), but it’s useful for playing with these different techniques.</p>
<p>The data comes from <a href="https://data.georgiaspatial.org/">Georgia’s GIS Clearinghouse</a>, which is a miserable ancient website that requires a (free) login. I downloaded the GNIS Cultural Features dataset (last updated in 1996; <a href="https://data.georgiaspatial.org/index.asp?body=preview&amp;dataId=11422">direct link</a> + <a href="https://data.georgiaspatial.org/data/statewide/gnis/gnis.html">documentation</a>). Since it’s government data from the US Department of the Interior and ostensibly public domain, you can download the shapefile here:</p>
<ul>
<li><a href="data/cultural.zip"><i class="fa-solid fa-file-archive" aria-label="file-archive"></i><code>cultural.zip</code></a></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll make all the shapefiles use ESRI:102118 (NAD 1927 Georgia Statewide</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers: https://epsg.io/102118)</span></span>
<span id="cb8-3">ga_crs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102118"</span>)</span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Geographic data from Georgia</span></span>
<span id="cb8-6">ga_cultural <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/cultural/cultural.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This shapefile uses EPSG:4326 (WGS 84), but that projection information</span></span>
<span id="cb8-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isn't included in the shapefile for whatever reason, so we need to set it</span></span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>))</span>
<span id="cb8-10"></span>
<span id="cb8-11">ga_campgrounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ga_cultural <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(DESCRIPTOR <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CAMP/CAMPGROUND"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(ga_crs)</span></code></pre></div>
</div>
<p>We’ll also grab a state map of Georgia and a map of all Georgia counties from the US Census Bureau using <a href="https://github.com/walkerke/tigris">the {tigris} package</a>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Geographic data from the US Census</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tigris_use_cache =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.setenv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">TIGRIS_CACHE_DIR =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"maps"</span>)</span>
<span id="cb9-4"></span>
<span id="cb9-5">ga_state <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">states</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cb =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"500k"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(STUSPS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GA"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(ga_crs)</span>
<span id="cb9-8"></span>
<span id="cb9-9">ga_counties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">counties</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">state =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cb =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"500k"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(ga_crs)</span></code></pre></div>
</div>
<p>And finally, to help illustrate maps aren’t mere scatterplots, we’ll add all of Georgia’s rivers and lakes to the maps we make. Lots of campgrounds are clustered around lakes, so this will also help us see some patterns in the data. We’ll get river and lake data from the Natural Earth project, which provides all sorts of <a href="https://www.naturalearthdata.com/downloads/10m-physical-vectors/">physical map data</a> like coastlines, reefs, islands, and so on. They provide shapefiles for large rivers and lakes globally (<code>rivers_lake_centerlines</code> and <code>lakes</code>) and smaller rivers and lakes in North America specifically (<code>rivers_north_america</code> and <code>lakes_north_america</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># See rnaturalearth::df_layers_physical for all possible names</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a vector of the four datasets we want</span></span>
<span id="cb10-3">ne_shapes_to_get <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb10-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rivers_lake_centerlines"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rivers_north_america"</span>,</span>
<span id="cb10-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lakes"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lakes_north_america"</span></span>
<span id="cb10-6">)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop through ne_shapes_to_get and download each shapefile and store it locally</span></span>
<span id="cb10-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"maps/ne_10m_lakes.shp"</span>)) {</span>
<span id="cb10-10">  ne_shapes_to_get <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">walk</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ne_download</span>(</span>
<span id="cb10-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> .x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"physical"</span>,</span>
<span id="cb10-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"maps"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">load =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb10-14">    ))</span>
<span id="cb10-15">}</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load each pre-downloaded shapefile and store it in a list</span></span>
<span id="cb10-18">ne_data_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ne_shapes_to_get <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> {</span>
<span id="cb10-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ne_load</span>(</span>
<span id="cb10-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> .x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"physical"</span>,</span>
<span id="cb10-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"maps"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">returnclass =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf"</span></span>
<span id="cb10-23">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(ga_crs)</span>
<span id="cb10-25">  }) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(ne_shapes_to_get)</span>
<span id="cb10-27"></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load all the datasets in the list into the global environment</span></span>
<span id="cb10-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(ne_data_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">envir =</span> .GlobalEnv)</span>
<span id="cb10-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
</div>
<p>These physical shapefiles from Natural Earth contain thousands of rivers and lakes, but we only want the ones that exist in or cross through Georgia. We can use the Georgia state shapefile we got from the Census (<code>ga_state</code>) as a sort of cookie cutter on each of these larger shapefiles to only keep the parts of rivers and lakes that fall within Georgia’s boundaries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ↓ these give a bunch of (harmless?) warnings about spatially constant attributes</span></span>
<span id="cb11-2">rivers_global_ga <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(ga_state, rivers_lake_centerlines)</span>
<span id="cb11-3">rivers_na_ga <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(ga_state, rivers_north_america)</span>
<span id="cb11-4">lakes_global_ga <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(ga_state, lakes)</span>
<span id="cb11-5">lakes_na_ga <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(ga_state, lakes_north_america)</span></code></pre></div>
</div>
<p>Here’s what our initial map looks like, with fancy rivers and maps added. It looks nice and detailed, but there are a lot of points, and even shrinking them down to 0.5, there are a few overplotted clusters.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">plot_initial <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_campgrounds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically this isn't necessary since all the layers already use 102118, but</span></span>
<span id="cb12-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we'll add it just in case I forgot to do that to one of them</span></span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> ga_crs)</span>
<span id="cb12-11">plot_initial</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-initial-map-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="option-1-fill-each-county-by-the-number-of-campgrounds" class="level1">
<h1>Option 1: Fill each county by the number of campgrounds</h1>
<p>One way to address this overplotting is to create bins with counts of the campgrounds in each bin. US states have a natural kind of “bin”, since they’re subdivided into counties. Georgia has <a href="https://www.wabe.org/why-ga-has-second-highest-number-counties-us/">an inordinate number of counties</a>, so we can count the number of campgrounds per county and fill each county by that count. We’ll join the campground data to the county data with <code>st_join()</code> (which is the geographic equivalent of <code>left_join()</code>) and then use some <code>group_by() %&gt;% summarize()</code> magic to find the number of locations per county.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># st_join() adds extra rows for repeated counties and returns partially blank</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rows for counties with no campgrounds. It would ordinarily be easy to use</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `summarize(total = n())`, but this won't be entirely accurate since counties</span></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># without campgrounds still appear in the combined data and would get</span></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># incorrectly counted. So instead, we look at one of the columns from</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ga_campgrounds (DESCRIPTOR). If it's NA, it means that the county it was</span></span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># joined to didn't have any campgrounds, so we can ignore it when counting.</span></span>
<span id="cb13-8">ga_counties_campgrounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ga_counties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_join</span>(ga_campgrounds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(NAMELSAD) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(DESCRIPTOR)))</span></code></pre></div>
</div>
<p>We can plot this new <code>ga_counties_campgrounds</code> data and fill by <code>total</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">plot_county <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_counties_campgrounds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> total), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> ga_crs)</span>
<span id="cb14-10">plot_county</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-county-fills-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>This already helps. We can see a cluster of campgrounds in central Georgia around the Piedmont National Wildlife Refuge and the Oconee National Forest, and another cluster in the mountains of northeast Georgia in the Chattahoochee-Oconee National forests.</p>
</section>
<section id="option-2-create-a-grid-and-fill-each-grid-box-by-the-number-of-campgrounds" class="level1">
<h1>Option 2: Create a grid and fill each grid box by the number of campgrounds</h1>
<p>Counties are oddly shaped, though, and not all states or cities have this many subdivisions to work with. So instead, we can create our own subdivisions. We can use <code>st_make_grid()</code> to divide the state area up into a grid—here we’ll use 400 boxes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Spit the state area into a 20x20 grid</span></span>
<span id="cb15-2">ga_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ga_state <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_make_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_grid, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/create-grid-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can then use <code>st_intersection()</code> to cut the Georgia map into pieces that fall in each of those grid boxes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">ga_grid_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(ga_state, ga_grid) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb16-4"></span>
<span id="cb16-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_grid_map) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/cut-map-grid-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>Next we can join the campground data to these boxes just like we did with the counties, and we can use <code>group_by() %&gt;% summarize()</code> to get counts in each grid box:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">campgrounds_per_grid_box <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ga_grid_map <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_join</span>(ga_campgrounds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(grid_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(DESCRIPTOR)))</span></code></pre></div>
</div>
<p>Finally we can plot it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">plot_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> campgrounds_per_grid_box, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> total), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> ga_crs)</span>
<span id="cb18-10">plot_grid</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-grid-fills-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>That feels more uniform than the counties and still highlights the clusters of campgrounds in central and northeast Georgia.</p>
</section>
<section id="option-3-fill-with-a-gradient-of-the-density-of-the-number-of-campgrounds" class="level1">
<h1>Option 3: Fill with a gradient of the density of the number of campgrounds</h1>
<p>However, it is a little misleading. Technically there are more campgrounds in northeast Georgia than in central Georgia, but because of how (1) county boundaries happened to be drawn, and (2) how the gridlines happened to be drawn, the campgrounds in the northeast were spread across multiple counties/tiles while the campgrounds in central Georgia happened to mostly fall in one county/tile, so it looks like there are more down there.</p>
<p>To make the shading more accurate, we can turn to turn to calculus and imagine grid boxes that are infinitely small. We can calculate densities instead of binned or clustered subunits.</p>
<p>Doing this with geographic data is tricky, though, and requires some extra math and an extra package to handle the fancy math: <a href="https://spatstat.org/">{spatstat}</a>. (See <a href="https://rspatial.org/rosu/Chapter5.html">this</a> and <a href="https://mgimond.github.io/Spatial/point-pattern-analysis-in-r.html">this</a> and <a href="https://maczokni.github.io/crime_mapping_textbook/studying-spatial-point-patterns.html">this</a> and <a href="https://stackoverflow.com/a/68647062/120898">this</a> for some examples of using {spatstat}.)</p>
<p>To calculate the density of campground latitudes and longitudes, we need to first convert our geometry column to a spatial point pattern object (or a <code>ppp</code> object) that {spatstat} can work with. Like <code>sf</code> objects, a <code>ppp</code> object is a collection of geographic points, and it can have overall boundaries embedded in it, or what {spatstat} calls a “window”:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the campground coordinates to a ppp object with a built-in window</span></span>
<span id="cb19-2">ga_campgrounds_ppp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.ppp</span>(ga_campgrounds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.owin</span>(ga_state))</span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check to see if it worked</span></span>
<span id="cb19-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(ga_campgrounds_ppp)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/make-campground-ppp-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p><code>ppp</code> objects have a corresponding <code>density()</code> function that can calculate the joint densities of each point’s latitude and longitude coordinates. It also has a <code>dimyx</code> argument that controls the number of pixels of the density—higher numbers will create smoother and higher resolution images; smaller numbers will be chunkier and less granular. The resulting object is a pixel-based bitmap image with extra attributes that describe how to connect it back to latitude and longitude points. If we feed that image to <code>stars::st_as_stars()</code> (from <a href="https://r-spatial.github.io/stars/">the {stars} package</a>), we’ll force the image to use that geographic data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a stars object of the density of campground locations</span></span>
<span id="cb20-2">density_campgrounds_stars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_stars</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(ga_campgrounds_ppp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimyx =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>))</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check to see what it looks like</span></span>
<span id="cb20-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(density_campgrounds_stars)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/make-campground-density-stars-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
{spatstat} and projections
</div>
</div>
<div class="callout-body-container callout-body">
<p>IMPORTANTLY <code>density.ppp()</code> doesn’t work with all CRS systems. From my experimenting, it seems to only work with projections that use meters as their units, like Albers and NAD 83. It gave me an error anytime I tried working with decimal degrees (i.e.&nbsp;the −180° to 180° scale). I don’t know why :(. That’s why I’ve forced all the different geographic datasets in this post to use <a href="https://epsg.io/102118">ESRI:102118</a> (Georgia Statewide Albers)—it uses meters and it works.</p>
</div>
</div>
<p>We can convert this {stars} object back to {sf} so it’s normal and plottable with <code>geom_sf()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">ga_campgrounds_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(density_campgrounds_stars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(ga_crs)</span></code></pre></div>
</div>
<p>We can then plot it with <code>ggplot()</code> and <code>geom_sf()</code> like normal, filling by <code>v</code>, which is the column that stores the calculated density:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">plot_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_campgrounds_density, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> v), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb22-5">plot_density</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-density-simple-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>ooooh that’s so pretty already. Let’s add all the rivers and lakes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">plot_density_fancy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_campgrounds_density, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> v), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> ga_crs)</span>
<span id="cb23-10">plot_density_fancy</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-density-fancy-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>Absolutely stunning.</p>
<p>We can add the actual campground points back in too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">plot_density_fancy_points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_campgrounds_density, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> v), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_global_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes_na_ga, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_campgrounds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> ga_crs)</span>
<span id="cb24-11">plot_density_fancy_points</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-density-fancy-points-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>That’s so so cool.</p>
</section>
<section id="comparison" class="level1 page-columns page-full">
<h1>Comparison</h1>
<p>Here’s what all these options look like together. There’s no one single best option—it depends on what story you’re trying to tell, how the data is distributed, how crowded it is, and so on—but it’s cool that there are so many options!</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">layout <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb25-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#####</span></span>
<span id="cb25-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#A#BC</span></span>
<span id="cb25-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#####</span></span>
<span id="cb25-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#D#EF</span></span>
<span id="cb25-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#####</span></span>
<span id="cb25-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">G####</span></span>
<span id="cb25-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb25-9"></span>
<span id="cb25-10">(plot_initial <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overplotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-11">  (plot_county <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filled by county"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-13">  (plot_grid <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filled by grid"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-14">  (plot_density_fancy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filled by density"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">design =</span> layout, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">widths =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heights =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">theme =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey95"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)))</span></code></pre></div>
</details>
<div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-all-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extra-bonus-fun-10000-churches" class="level1">
<h1>Extra bonus fun: 10,000+ churches</h1>
<p>Finally, for some extra fun, let’s plot something that’s <em>actually</em> overplotted—Georgia’s 10,000+ churches!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">ga_churches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ga_cultural <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(DESCRIPTOR <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CHURCH"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102118"</span>))</span>
<span id="cb26-4"></span>
<span id="cb26-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_churches)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-churches-initial-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>lol this is basically just a wildly overplotted <a href="https://xkcd.com/1138/">population map</a> at this point. Let’s calculate the density of these locations and plot a gradient:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the church coordinates to a ppp object with a built-in window</span></span>
<span id="cb27-2">ga_churches_ppp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.ppp</span>(ga_churches<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.owin</span>(ga_state))</span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a stars object (whatever that is) of the density of church locations</span></span>
<span id="cb27-5">density_churches_stars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_stars</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(ga_churches_ppp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimyx =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>))</span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the stars object to an sf object so it's normal and plottable again</span></span>
<span id="cb27-8">ga_churches_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(density_churches_stars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(ga_crs)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_churches_density, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> v), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ga_churches, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rocket"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-church-density-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>Check out that hugely bright spot in Atlanta!</p>


<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {How to Fill Maps with Density Gradients with {R,}
    \{Ggplot2\}, and \{Sf\}},
  date = {2023-07-28},
  url = {https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf},
  doi = {10.59350/bsctw-0a955},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“How to Fill Maps with Density Gradients with
R, {Ggplot2}, and {Sf}.”</span> July 28, 2023. <a href="https://doi.org/10.59350/bsctw-0a955">https://doi.org/10.59350/bsctw-0a955</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>gis</category>
  <category>maps</category>
  <guid>https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index.html</guid>
  <pubDate>Thu, 27 Jul 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/07/28/gradient-map-fills-r-sf/index_files/figure-html/plot-all-1.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>The ultimate practical guide to conjoint analysis with R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index.html</link>
  <description><![CDATA[ 




<p>In my research, I study international nongovernmental organizations (INGOs) and look at how lots of different institutional and organizational factors influence INGO behavior. For instance, many authoritarian regimes have passed anti-NGO laws and engaged in other forms of legal crackdown, which has forced NGOs to change their programming strategies and their sources of funding.</p>
<div class="page-columns page-full"><p>In one ongoing project with <a href="https://www.suparnachaudhry.com/">Suparna Chaudhry</a> and <a href="https://marriott.byu.edu/directory/details?id=50683">Marc Dotson</a>, we look at how individual private donors feel about NGOs that face legal crackdown abroad and how the experience of crackdown interacts with donor characteristics (like how much education a person has, whether they’ve traveled abroad, what their income is, etc.) with organizational characteristics (like whether it deals with humanitarian or human rights issues, whether it has an open commitment to transparency, whether it faces legal crackdown abroad, etc.) to shape an individual’s decision to give money to an NGO.<sup>1</sup></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;<a href="https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-philanthropy/">In earlier work with Suparna Chaudhry, we do a similar thing too</a>, just with far fewer experimental conditions.</p></li></div></div>
<div class="page-columns page-full"><p>We use a conjoint experiment to test a bunch of different hypotheses related to INGO characteristics and donor behavior<sup>2</sup> However, in all my previous stats training, I never learned how to analyze conjoint data or how to test specific causal claims and estimate causal effects with this kind of data. So, in the course of analyzing our INGO conjoint data, I’ve been making a guide for future-me (and anyone else who’s interested) in how to analyze conjoint survey data.</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;<a href="https://stats.andrewheiss.com/why-donors-donate/preregistration.html">See our preregistration here.</a></p></li></div></div>
<p>This is that guide.</p>
<p>I explore three main things here:</p>
<ol type="1">
<li>What kinds of causal and descriptive estimands (or quantities of interest) can you get from conjoint designs?</li>
<li>How can you estimate these things with “standard” frequentist statistics?</li>
<li>How can you estimate these things with Bayesian statistics?</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with linear regression and packages like <a href="https://broom.tidymodels.org/">{broom}</a> for converting regression results into tidy data frames and <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> for calculating <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">marginal effects</a>.</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws.</li>
</ul>
</div>
</div>
<p>Throughout this example, I’ll use data from a political candidate conjoint experiment from <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span>. <a href="https://doi.org/10.7910/DVN/THJYQR">The data is available at the Harvard Dataverse</a> and it’s public domain, so you can also download it here if you want to follow along:</p>
<ul>
<li><a href="data/candidate.dta"><i class="fa-solid fa-table" aria-label="table"></i> <code>candidate.dta</code></a> (this is a Stata file)<sup>3</sup></li>
</ul>
<div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;booo</p></li></div><p>Let’s load some packages and data, create some helper functions and nice theme stuff, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(haven)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read Stata files</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert model objects to tidy data frames</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cregg)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Automatically calculate frequentist conjoint AMCEs and MMs</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(survey)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Panel-ish regression models</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate marginal effects</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom.helpers)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add empty reference categories to tidy model data frames</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggforce)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For facet_col()</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The best formula-based interface to Stan</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Manipulate Stan results in tidy ways</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdist)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fancy distribution plots</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine ggplot plots</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span id="cb1-17">theme_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost Medium"</span>),</span>
<span id="cb1-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb1-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb1-25">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb1-27">}</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set default theme and font stuff</span></span>
<span id="cb1-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>())</span>
<span id="cb1-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Party colors from the Urban Institute's data visualization style guide, for fun</span></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># http://urbaninstitute.github.io/graphics-styleguide/</span></span>
<span id="cb1-36">parties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1696d2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#db2b27"</span>)</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions for formatting things as percentage points</span></span>
<span id="cb1-39">label_pp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb1-40">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" pp."</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_negative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minus"</span>)</span>
<span id="cb1-41"></span>
<span id="cb1-42">label_amce <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" pp."</span>, </span>
<span id="cb1-43">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_negative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minus"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_positive =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plus"</span>)</span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data from https://doi.org/10.7910/DVN/THJYQR</span></span>
<span id="cb1-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It's public domain</span></span>
<span id="cb1-47">candidate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_stata</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/candidate.dta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert all the Stata categories to factors</span></span>
<span id="cb1-49"></span>
<span id="cb1-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb1-51">variable_lookup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb1-52">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable,    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>variable_nice,</span>
<span id="cb1-53">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military"</span>,</span>
<span id="cb1-54">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Religion"</span>,</span>
<span id="cb1-55">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ated"</span>,       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Education"</span>,</span>
<span id="cb1-56">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atprof"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Profession"</span>,</span>
<span id="cb1-57">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmale"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gender"</span>,</span>
<span id="cb1-58">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atinc"</span>,      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Income"</span>,</span>
<span id="cb1-59">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atrace"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Race"</span>,</span>
<span id="cb1-60">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atage"</span>,      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age"</span></span>
<span id="cb1-61">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(variable_nice))</span></code></pre></div>
</div>
<section id="how-conjoint-experiments-work" class="level1">
<h1>How conjoint experiments work</h1>
<p><a href="https://en.wikipedia.org/wiki/Conjoint_analysis">Conjoint experiments</a> are a special kind of randomized experiment where study participants are asked questions that have experimental manipulations. However, unlike a standard randomized experiment where one feature of interest is manipulated (like in an A/B test), conjoint experiments are choose-your-own-adventure randomized experiments. Participants are presented with 2+ possible options that have a variety of features with different levels in those features, and then they’re asked to choose one (for a binary outcome) or rate them on some sort of scale (for a continuous outcome).</p>
<p>For instance, throughout this post we’ll play with data from a conjoint experiment by <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span> where they were interested in seeing the effect of different political candidate characteristics on the probability that a respondent would select that candidate (or on candidate favorability).</p>
<p>Respondents were shown the following question multiple times and asked to choose which candidate they’d vote for. Each candidate had a set of eight features with randomly chosen levels inside each feature, like this:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example conjoint survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="table">
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">Candidate 1</th>
<th style="text-align: center;">Candidate 2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Military service</td>
<td style="text-align: center;">Did not serve</td>
<td style="text-align: center;">Served</td>
</tr>
<tr class="even">
<td>Religion</td>
<td style="text-align: center;">None</td>
<td style="text-align: center;">Mormon</td>
</tr>
<tr class="odd">
<td>College</td>
<td style="text-align: center;">State university</td>
<td style="text-align: center;">Ivy League university</td>
</tr>
<tr class="even">
<td>Profession</td>
<td style="text-align: center;">Lawyer</td>
<td style="text-align: center;">Business owner</td>
</tr>
<tr class="odd">
<td>Gender</td>
<td style="text-align: center;">Female</td>
<td style="text-align: center;">Female</td>
</tr>
<tr class="even">
<td>Income</td>
<td style="text-align: center;">$54,000</td>
<td style="text-align: center;">$92,000</td>
</tr>
<tr class="odd">
<td>Race/Ethnicity</td>
<td style="text-align: center;">White</td>
<td style="text-align: center;">Asian American</td>
</tr>
<tr class="even">
<td>Age</td>
<td style="text-align: center;">45</td>
<td style="text-align: center;">68</td>
</tr>
</tbody>
</table>
<div class="rounded bg-success text-white p-2">
<p><strong>If you had to choose between them, which of these two candidates would you vote for?</strong></p>
<ul>
<li><strong>Candidate 1</strong></li>
<li><strong>Candidate 2</strong></li>
</ul>
</div>
</div>
</div>
<p>Each of these eight features had different levels within them that respondents could possibly see:</p>
<table class="table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>Features/Attributes</th>
<th>Levels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Military service</td>
<td>Served, Did not serve</td>
</tr>
<tr class="even">
<td>Religion</td>
<td>None, Jewish, Catholic, Mainline protestant, Evangelical protestant, Mormon</td>
</tr>
<tr class="odd">
<td>College</td>
<td>No BA, Baptist college, Community college, State university, Small college, Ivy League university</td>
</tr>
<tr class="even">
<td>Profession</td>
<td>Business owner, Lawyer, Doctor, High school teacher, Farmer, Car dealer</td>
</tr>
<tr class="odd">
<td>Gender</td>
<td>Male, Female</td>
</tr>
<tr class="even">
<td>Income</td>
<td>$32,000; $54,000; $65,000; $92,000; $210,000; $5,100,000</td>
</tr>
<tr class="odd">
<td>Race/Ethnicity</td>
<td>White, Native American, Black, Hispanic, Caucasian, Asian American</td>
</tr>
<tr class="even">
<td>Age</td>
<td>36, 45, 52, 60, 68, 75</td>
</tr>
</tbody>
</table>
</section>
<section id="estimands-what-quantities-of-interest-can-you-get-from-conjoint-designs" class="level1 page-columns page-full">
<h1>Estimands: what quantities of interest can you get from conjoint designs?</h1>
<p>There are a ton of possible combinations of features and levels that can be offered to respondents—in this candidate experiment, there are 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6, or 186,624 options(!). Even in a survey with thousands of respondents, it’s unlikely that every possible version of the 186,624 potential combinations would be seen by the whole sample. Regardless, with some statistical magic, you can still find valid quantities of interest from these complex experimental designs.</p>
<p>In general, there are two types of estimands that you can find using conjoint designs: causal and descriptive <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span>. The exact research question you have determines what quantity of interest you’ll want to find and how you analyze the data to find it. This table summarizes the two types of estimands, how they’re calculated, and shows some example questions you can answer with them:</p>
<div class="column-page-inset">
<div id="tbl-conjoint-estimands" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Causal and descriptive estimands from conjoint designs</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 32%">
<col style="width: 34%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Purpose</th>
<th>Estimand</th>
<th>Example interpretation</th>
<th>Practical calculation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Causal inference</strong></td>
<td><p><strong>Average marginal component effect (AMCE)</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;%5Ctextbf%7BE%7D%20%5B%5Ctext%7BOutcome%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BFeature%7D%20=%20%5Ctext%7Breference%20level%7D)%5D%5C%20-%20%5C%5C%0A&amp;%5Ctextbf%7BE%7D%5B%5Ctext%7BOutcome%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BFeature%7D%20=%20%5Ctext%7Blevel%20of%20interest%7D)%5D%0A%5Cend%7Baligned%7D%0A"></p></td>
<td>Changing a candidate’s religion from none to Mormon decreases the probability of selection by X percentage points.</td>
<td>Categorical regression coefficients or marginal effects where one level is omitted</td>
</tr>
<tr class="even">
<td><strong>Preference description</strong></td>
<td><p><strong>Marginal mean (MM)</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%20%5Ctextbf%7BE%7D%5B%5Ctext%7BOutcome%7D%20%5Cmid%20%5Ctext%7BFeature%20=%20Level%20of%20interest%7D%5D%0A"></p>
<p><em>or</em></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;%5Ctextbf%7BE%7D%5B%5Ctext%7BOutcome%7D%20%5Cmid%20%5Ctext%7BFeature%20=%20Level%20of%20interest%7D%5D%5C%20-%20%5C%5C%0A&amp;%5Ctextbf%7BE%7D%5B%5Ctext%7BOutcome%7D%20%5Cmid%20%5Ctext%7BFeature%20=%20Other%20level%20of%20interest%7D%5D%0A%5Cend%7Baligned%7D%0A"></p></td>
<td><p>Mormon candidates are supported by X% of respondents.</p>
<p><em>or</em></p>
<p>Mormon candidates are X percentage points less likely to be selected than Catholic candidates.</p></td>
<td>Average outcome value conditional on different levels</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="average-marginal-component-effect-amce" class="level2">
<h2 class="anchored" data-anchor-id="average-marginal-component-effect-amce">Average marginal component effect (AMCE)</h2>
<p>This distinction between causal and descriptive estimands makes sense if we look at the notation for the estimands themselves. <a href="https://www.andrewheiss.com/blog/2021/09/07/do-calculus-backdoors/">In the world of do-calculus</a>, causal questions are asked using the <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7Bdo%7D()"> operator, which represents <a href="https://stats.stackexchange.com/questions/211008/dox-operator-meaning">a direct intervention into a data generating process</a>. In this case, the researcher randomly sets the attributes to specific levels—the respondent does not self-select into different conditions or decide for themselves that Candidate 1 is a Catholic lawyer or that Candidate 2 is a Jewish farmer. This thus eliminates selection bias and other external confounding, leaving us with an average causal effect.</p>
<p>We can calculate (1) the average outcome when a feature is set to a level we’re interested in (e.g., when religion = Mormon), (2) the average outcome when a feature is set to some reference level (e.g., when religion = none), and (3) find the difference between the two:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;P%20%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BReligion%7D%20=%20%5Ctext%7Bnone%7D)%5D%5C%20-%20%5C%5C%0A&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BReligion%7D%20=%20%5Ctext%7BMormon%7D)%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>Practically speaking, the easiest way to think about the average marginal component effect (AMCE) is as categorical coefficients in a linear regression model.</p>
<p>In my favorite analogy for thinking about regression, <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards">model covariates can either be sliders or switches</a>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/slider-switch-annotated-80.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Numeric covariates are sliders—a one unit change in X is associated with a <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> unit change in Y. You can slide that X variable up and down and influence Y accordingly (a 10 unit change in X is associated with a <img src="https://latex.codecogs.com/png.latex?10%20%5Ctimes%20%5Cbeta"> change in Y; a −1 unit change in X is associated with a <img src="https://latex.codecogs.com/png.latex?-%5Cbeta"> change in Y; and so on). The <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is a slider that you can move up and down and see what happens to the outcome.</p>
<p>Categorical covariates, on the other hand, are switches. One of the categories is omitted and represents the baseline average for that category, or the average when the switch is off. The other category coefficients represent shifts in that baseline, or what happens when the switch is flipped on.</p>
<p>Here’s a quick super basic reference example with data from {palmerpenguins} (this is not actual conjoint data!). We’ll model penguin weight based on penguin species and sex:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(palmerpenguins)</span>
<span id="cb2-2"></span>
<span id="cb2-3">penguins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(sex)</span>
<span id="cb2-4"></span>
<span id="cb2-5">penguin_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(penguin_model)</span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 5</span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term             estimate std.error statistic   p.value</span></span>
<span id="cb2-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb2-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 (Intercept)        3372.       31.4   107.    4.34e-258</span></span>
<span id="cb2-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 speciesChinstrap     26.9      46.5     0.579 5.63e-  1</span></span>
<span id="cb2-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 speciesGentoo      1378.       39.1    35.2   1.05e-113</span></span>
<span id="cb2-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 sexmale             668.       34.7    19.2   8.73e- 56</span></span></code></pre></div>
</div>
<p>There are three species and two sexes of penguins, but we only get coefficients for two species (Chinstrap and Gentoo) and one sex (male) because of how regression works—one category is omitted. The coefficients here represent changes in average body mass when switching on the corresponding category. For sex, the omitted category is “female,” so the coefficient for <code>sexmale</code> shows that male penguins are 667 grams heavier than female penguins, on average. Imagine a “sex” switch—when it’s flipped up to the male position, body mass goes up. The same idea works for species—the omitted species is Adélie, so on average Chinstraps are 27 grams heavier than Adélies, and Gentoos are 1,378 grams heavier than Adélies. We can flip the “Chinstrap” or “Gentoo” switches on and increase body mass accordingly.</p>
<p>The nice thing about the slider and switch analogy is that it makes it easier to think about holding everything constant—we have switches for both species and sex, but if we just tinker with one, we’ll get the effect of being a Chinstrap or a Gentoo or a male. It’s like a mixer board:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/mixer-board-annotated-80.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>That’s all standard regression-with-categorical-variables stuff.</p>
<p>The magic of AMCEs is that in the case of ordinary least squares (OLS) linear regression without any squared or nonlinear terms, <strong>AMCEs are just coefficients</strong>. It’s a little more complicated with non-linear terms or models with nonlinear link functions like logistic regression—we’d need to calculate marginal effects to get the AMCEs in those cases (but I’ll explore that a lot more below).</p>
</section>
<section id="marginal-means" class="level2">
<h2 class="anchored" data-anchor-id="marginal-means">Marginal means</h2>
<p>The descriptive estimand, on the other hand, does not have a <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7Bdo%7D()"> operator, which means that there’s no experimental intervention or causal effect. Instead, we’re working with the observed averages of different levels.</p>
<p>For instance, if we wanted to know what proportion of respondents support Mormon candidates, we could calculate this estimand:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%20P(%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Mormon%7D)%0A"></p>
<p>Or if we wanted to know the percentage point difference between the probabilities of Mormon and Catholic candidates, we could calculate this estimand:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Mormon%7D%5D%5C%20-%20%5C%5C%0A&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Catholic%7D%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>Importantly these aren’t causal estimands—they’re descriptive. They’re also not relative to any baseline level. They’re not regression-style “switches” but instead are group averages.</p>
<p>We can see this really quick with the penguin data (again, this isn’t related to conjoint stuff! this is just to help with the intuition). To find these marginal means, we calculate the category-specific means. We can do that without regression with some grouping and summarizing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginal means for species</span></span>
<span id="cb3-2">penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(body_mass_g))</span>
<span id="cb3-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 3 × 2</span></span>
<span id="cb3-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   species     avg</span></span>
<span id="cb3-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;     &lt;dbl&gt;</span></span>
<span id="cb3-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Adelie    3706.</span></span>
<span id="cb3-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Chinstrap 3733.</span></span>
<span id="cb3-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Gentoo    5092.</span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Marginal means for sex</span></span>
<span id="cb3-13">penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(body_mass_g))</span>
<span id="cb3-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb3-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   sex      avg</span></span>
<span id="cb3-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span id="cb3-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 female 3862.</span></span>
<span id="cb3-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 male   4546.</span></span></code></pre></div>
</div>
<p>Or we could use a couple intercept-free models to get the same values. Mathematically this is the same as grouping and summarizing, since regression is ultimately <a href="https://twitter.com/ajeanstevenson/status/1488601482505060352">just fancy averaging</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/fancy-averaging-tweet.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption class="figure-caption"><a href="https://twitter.com/ajeanstevenson/status/1488601482505060352">“Many things got easier once I accepted that regression is just fancy averaging.” —@ajeanstevenson</a></figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins)),</span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins))</span>
<span id="cb4-4">)</span>
<span id="cb4-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 5 × 5</span></span>
<span id="cb4-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term             estimate std.error statistic   p.value</span></span>
<span id="cb4-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 speciesAdelie       3706.      38.1      97.2 6.88e-245</span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 speciesChinstrap    3733.      55.9      66.8 8.16e-194</span></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 speciesGentoo       5092.      42.2     121.  6.31e-275</span></span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 sexfemale           3862.      56.8      68.0 1.70e-196</span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 sexmale             4546.      56.3      80.7 8.39e-220</span></span></code></pre></div>
</div>
<p>Or even better, we can use <a href="https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html"><code>marginal_means()</code></a> from <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> (way more on that below!)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_means</span>(penguin_model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"species"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sex"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells"</span>)</span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     Term     Value Mean Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span id="cb5-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  species Adelie    3706       26.2 141.4   &lt;0.001  3655   3758</span></span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  species Chinstrap 3733       38.4  97.2   &lt;0.001  3658   3808</span></span>
<span id="cb5-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  species Gentoo    5092       29.0 175.5   &lt;0.001  5036   5149</span></span>
<span id="cb5-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  sex     female    3862       24.6 156.7   &lt;0.001  3814   3911</span></span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  sex     male      4546       24.4 186.1   &lt;0.001  4498   4594</span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb5-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Results averaged over levels of: species, sex </span></span>
<span id="cb5-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, value, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>Regardless of how we calculate these, the numbers are the same, and they represent average penguin weights in each of the species and both of the sexes. We can answer descriptive questions about the average weight of female penguins or the difference in average weights between Gentoo and Chinstrap penguins. There’s no reference level—there are no regression switches or sliders—these are just averages.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bonus: Market simulations
</div>
</div>
<div class="callout-body-container callout-body">
<p>There’s an extra third option that I didn’t include in Table&nbsp;1 because it’s not used often in my worlds of public policy and political science, but it is used <em>a lot</em> in marketing. In this approach, researchers use conjoint experiments to simulate the data generating process for an overall “market” of “products” (or candidates in this running example).</p>
<p>Researchers build rich multilevel models to capture all the dynamics of the different respondent-level characteristics and the experimental features and levels and then create hypothetical “purchasers” with different covariate levels and see which combinations of individual characteristics and product characteristics influence the overall market share of products. Using the candidate experiment example, the market simulation would model the effect of different candidate features (religion, military experience, education, and so on) on the probability of choosing a candidate across individual respondent characteristics like ideology, political preferences, age, education, and so.</p>
<p>From what I’ve seen, this market simulation-based approach is really rare in social science. In fact, <a href="https://www.andrewheiss.com/research/articles/chaudhry-dotson-heiss-2021/">this paper</a> <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">(Chaudhry, Dotson, and Heiss 2021)</span> coauthored by Suparna Chaudhry, Marc Dotson, and me is the only political science-y one I know of! In it, we were interested in a host of different factors that drive individual preferences for charitable donations. We generated dozens of hypothetical donor personas and looked at how different categories of respondents felt about different features and how those preferences then influenced the market share of hypothetical nonprofits/NGOs.</p>
<p>For example, here we can see the average predicted donation market shares across all donor personas, segmented by persona public affairs knowledge, political ideology, and social trust across different NGO–host government relationships. NGOs with friendly relationships with their host governments will receive a greater share of donations from the market, regardless of individual political ideology or political knowledge and travelling experience.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/who-cares_fig4.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure 4 from <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">Chaudhry, Dotson, and Heiss (2021)</span></figcaption>
</figure>
</div>
<p>Returning to the slider + switch analogy, this kind of market simulation is like an ultimate-super-mega-huge mixer board. We had to create a Shiny dashboard (<a href="https://andrewheiss.shinyapps.io/why-donors-donate_market-simulator/">accessible here</a>) to explore all the different possible outcomes. It’s wild.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/simulator-screenshot.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Screenshot of market simulator</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="relationship-between-amces-and-marginal-means" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="relationship-between-amces-and-marginal-means">Relationship between AMCEs and marginal means</h2>
<p>Technically AMCEs and marginal means measure the same thing, just in different ways. Thinking about this in regression terms helps—with categorical marginal effects, the intercept for the model represents the average outcome for the omitted category, while the coefficient represents the offset from the average. The coefficient is the switch—turning it on changes the baseline reference category average by <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> amount.</p>
<section id="penguin-example" class="level3">
<h3 class="anchored" data-anchor-id="penguin-example">Penguin example</h3>
<p>Here’s one last example from the non-conjoint penguins data, just to drive the point home. Let’s make a super basic model that predicts weight based on sex only:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">model_sex_only <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sex, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(model_sex_only)</span>
<span id="cb6-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 5</span></span>
<span id="cb6-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term        estimate std.error statistic   p.value</span></span>
<span id="cb6-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb6-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 (Intercept)    3862.      56.8     68.0  1.70e-196</span></span>
<span id="cb6-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 sexmale         683.      80.0      8.54 4.90e- 16</span></span></code></pre></div>
</div>
<p>The intercept shows average weight for female penguins (3862 grams), while the coefficient for <code>sexmale</code> shows the change from that average when the “male” switch is turned on (683 more grams, on average).</p>
<p>We can actually use these two pieces of information to find the average penguin weight across both sexes: females are 3862.3 grams, males are 3862.3 + 683.4 = 4546 grams. We can confirm this with a quick <code>group_by() %&gt;% summarize()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_weight =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(body_mass_g))</span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb7-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   sex    avg_weight</span></span>
<span id="cb7-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;       &lt;dbl&gt;</span></span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 female      3862.</span></span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 male        4546.</span></span></code></pre></div>
</div>
<p>Visualizing this should help even more with the general intuition. The horizontal distance between these two points is the same in each panel (683 grams). In the left panel, female weight is set at 0 since it’s the omitted reference category. In the right panel, both males and females have specific group averages. These two panels are analgous to the conjoint idea of AMCEs and marginal means.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_sex_only <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_and_attach</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_add_reference_rows</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_add_estimate_to_reference_rows</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Intercept)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> term)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb8-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>,</span>
<span id="cb8-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">683.4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb8-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey70"</span></span>
<span id="cb8-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb8-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>,</span>
<span id="cb8-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">683.4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb8-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"683.4 grams"</span>,</span>
<span id="cb8-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb8-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb8-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grams"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb8-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Relative shift in average"</span>,</span>
<span id="cb8-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Similar to AMCEs"</span></span>
<span id="cb8-23">  )</span>
<span id="cb8-24"></span>
<span id="cb8-25">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> term)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb8-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>,</span>
<span id="cb8-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3862</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3862</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4546</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb8-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey70"</span></span>
<span id="cb8-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb8-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>,</span>
<span id="cb8-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4546</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">683.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb8-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"683.4 grams"</span>,</span>
<span id="cb8-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb8-39">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb8-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grams"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb8-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group averages"</span>,</span>
<span id="cb8-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Similar to marginal means"</span></span>
<span id="cb8-45">  )</span>
<span id="cb8-46"></span>
<span id="cb8-47">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p2</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-penguin-averages-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conjoint-amces-and-marginal-means-finally" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="conjoint-amces-and-marginal-means-finally">Conjoint AMCEs and marginal means (finally!)</h3>
<p>Okay, with that intuition nailed down, we can finally look at conjoint results. We’ll look at the results from the candidate experiment in <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span>, which <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span> replicate and explore in their paper distinguishing between AMCEs and marginal means, and which we explored at the beginning of this post to show how conjoints work (i.e.&nbsp;there are seven candidate attributes like military service history, religion, gender, age, and so on).</p>
<p>Here’s an excerpt from Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span>, which shows both the published AMCEs and the Leeper, et al.-calculated marginal means from Hainmueller, Hopkins, and Yamamoto’s original candidate study:</p>
<div class="column-page-inset my-4">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/SVG/leeper-et-al-2019_fig1_excerpt.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="page-columns page-full"><p>The AMCEs in the left panel have a direct causal interpretation. In this case, holding all else equal, changing a candidate from not having military service to serving in the military increases the probability of support (or overall favorability) by 0.09, or 9 percentage points. Similarly, changing from a nonreligious candidate to a Mormon candidate decreases the probability of support by 14 percentage points (!!!).<sup>4</sup> There is no sex-based effect—changing a candidate from male to female has an AMCE of 0.0.</p><div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;This study was written and published in 2013, right after the 2012 presidential election between Barack Obama and Mitt Romney, a Mormon who did surprisingly well considering longstanding anti-Mormon sentiment in American politics (for more on Mormons and American politics, see <span class="citation" data-cites="Reeve:2015">Reeve (2015)</span> and <span class="citation" data-cites="McBrideRogersErekson:2020">McBride, Rogers, and Erekson (2020)</span>).</p></li></div></div>
<p>The marginal means in the right panel don’t rely on a reference category and are all centered around 50%—if there’s no difference between the the levels in a two-level feature, we’d expect the averages for each level to be 50%. We can see this with sex, where both male and female candidates have a 50% probability of selection (or 50% favorability, or however we want to interpret the outcome here).</p>
<p>With the AMCEs, we saw a 9 percentage point increase in favorability caused by military service. That same 9-point difference is visible in the marginal means: candidates without military service history have 46% favorability compared to the 54% favorability among those with military history (54−46 = 9).</p>
<p>The presence of a reference category doesn’t matter much when dealing with binary treatments like sex and military service here. If we reversed the reference category, we’d get the same causal effect but in reverse—not serving in the military causes a 9 percentage point drop in favorability.</p>
<p>The reference category matters a lot, however, in attributes with more than two levels, like religion. In the AMCE panel, all the causal effects are in reference to a candidate with no religion. Being Mormon causes a 14 percentage point drop from having no religion; being Evangelical causes a 12 percentage point drop from having no religion; and so on. Deciding which level to use as the omitted reference category matters and can seriously change the causal interpretation of the AMCEs. For instance, here it looks like there’s a serious penalty for being Mormon or Evangelical, while being Protestant, Catholic, or Jewish doesn’t matter. But that’s only the case from a certain point of view. If an Evangelical candidate were the reference category, there wouldn’t be any significant Mormon effect (but there would be a Protestant, Catholic, Jewish, and None effect).</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/obiwan-pov.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">“What I told you was true… from a certain point of view”<br>—Obi-Wan Kenobi</figcaption>
</figure>
</div>
</div></div><p>The reference category gets in the way of making descriptive statements like “Mormon candidates see 42% favorability, while Jewish candidates see 52% favorability.” You can’t get numbers like that from the AMCEs alone unless you know the underlying favorability of the reference category and then reconstruct the other categories’ averages by hand. But researchers working with conjoint experiments try to do this with AMCEs all the time. <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span> argue that</p>
<blockquote class="blockquote">
<p>AMCEs are relative, not absolute, statements about preferences. As such, there is simply no predictable connection between subgroup causal effects and the levels of underlying subgroup preferences. Yet, analysts and their readers frequently interpret differences in conditional AMCEs as differences in underlying preferences <span class="citation" data-cites="LeeperHoboltTilley:2020">(Leeper, Hobolt, and Tilley 2020, 214)</span>.</p>
</blockquote>
<p><strong>The key point is this</strong>: AMCEs are relative statements, not absolute statements. If we want to talk about the causal effect of moving one attribute level (None → Mormon, None → Catholic, Male → Female, etc.), we can use AMCEs. If we want to talk about general preferences or favorabilities or probabilities or average outcomes, we need to talk about marginal means.</p>
</section>
</section>
<section id="amces-and-marginal-means-across-subgroups" class="level2">
<h2 class="anchored" data-anchor-id="amces-and-marginal-means-across-subgroups">AMCEs and marginal means across subgroups</h2>
<p>This issue with relative vs.&nbsp;absolute estimands is <em>especially</em> complex when thinking about subgroups or controlling for respondent-level characteristics like political ideology, sex, education, and so on. Suppose we want to know if this Mormon penalty is bigger among Democratic respondents than Republican respondents. We could control for respondent ideology, or calculate two different AMCEs—one when Democrat = true and one when Republican = true. This seems all good and logical. And it it’s fine if you’re talking about causal effects. But once you start trying to compare overall trends across respondent-level subgroups, AMCEs will give you wrong estimates! The main argument in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span> is that looking at AMCEs across respondent subgroups doesn’t work people think it does because AMCEs are relative and not absolute. The difference between the relative Mormon candidate AMCE among Democratic-leaning and Republican-leaning respondents isn’t really comparable to the party-based differences in other levels (Evangelicals, Catholics, etc.).</p>
<p><span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span> illustrate this idea in a neat way in their Figure 2 (included below). This figure recreates the results for the “candidate sex” feature in a different candidate conjoint experiment done by <span class="citation" data-cites="TeeleKallaRosenbluth:2018">Teele, Kalla, and Rosenbluth (2018)</span>. In this case, unlike our running example from <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span>’s study, there <em>is</em> a sex effect—a candidate being female causes a 4.5 percentage point increase in favorability. We can see this in the top two panels, both as an AMCE of 0.045 and as marginal means (female = 0.52; male = 0.48; difference = AMCE = 0.045).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/SVG/leeper-et-al-2019_fig2.svg" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>The third panel shows two different AMCEs conditional on respondent political party, and it appeared in the published study. Because AMCEs require a reference category as the baseline, and because AMCEs are relative quantities, it looks like there’s a huge party-based difference in favorability toward women candidates—being a woman causes a 7ish percentage point boost in favorability among Democrats, while it does nothing (or maybe something negative) among Republicans. These are conditional AMCEs (or CAMCEs), or the causal effect of turning on the “female” switch for a hypothetical candidate across Republican and Democratic respondents.</p>
<p>Conditional AMCEs are fine for causal work, but what trips people up often is that it’s tempting to use those conditional effects to describe actual overall patterns of preferences. Because there’s a reference category involved (male candidates), we can’t really say anything about the general respondent-party-ID-based preferences for male and female candidates. The conditional AMCE here combines the party-based difference in favorability toward female candidates (53.7% among Democrats; 49.2% among Republicans; difference of 4.5 percentage points) and the party-based difference in favorability toward male candidates (46.3% among Democrats; 50.8% among Republicans; difference of 4.5 percentage points). According to Leeper, et al.:</p>
<blockquote class="blockquote">
<p>Because Democrats and Republicans actually differ in their views of profiles containing the reference (male) category, AMCEs sum the true differences in preferences for a given feature level with the difference in preferences toward the reference category. Visual or numerical similarity of subgroup AMCEs is therefore an analytical artifact, not an accurate statement of the similarity of patterns of preferences <span class="citation" data-cites="LeeperHoboltTilley:2020">(Leeper, Hobolt, and Tilley 2020, 215)</span>.</p>
</blockquote>
<p>If we’re interested not in describing a causal effect (i.e.&nbsp;the effect of switching from male → female) but instead describing general preferences (i.e.&nbsp;the difference in overall candidate sex favorability between Republicans and Democrats), we have to look at marginal means (and the difference in marginal means) instead of conditional AMCEs. It is really tempting to look at the distance between Republicans and Democrats in the “Female” level in the third panel and say that there’s a nearly 10 percentage point difference in favorability across parties, but that’s wrong! It only looks that way because the effect sizes are all relative to the reference “Male” level.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/SVG/leeper-et-al-2019_fig2_excerpt.svg" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>In reality, Democrats are 4.5 percentage points less likely to select a male candidate and 4.5 percentage points more likely to select a female candidate. The differences in marginal means within party subgroups would look like this:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Teele, Kalla, and Rosenbluth 2018 data from https://doi.org/10.7910/DVN/FVCGHC</span></span>
<span id="cb9-2">candidate_parties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_stata</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/conjoint_data.dta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">female =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(orig_cand_gender_string)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">female =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(female, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Male"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">party_respondent =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb9-7">    democrat_respondent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Democrat"</span>,</span>
<span id="cb9-8">    republican_respondent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican"</span></span>
<span id="cb9-9">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">party_respondent =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(party_respondent)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"usa voter"</span>)</span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm_diffs</span>(</span>
<span id="cb9-14">  candidate_parties,</span>
<span id="cb9-15">  winner <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> female,</span>
<span id="cb9-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>party_respondent</span>
<span id="cb9-17">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> level)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb9-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper, </span>
<span id="cb9-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb9-23">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb9-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means"</span>,</span>
<span id="cb9-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb9-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb9-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means between</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Republican and Democratic respondents"</span>,</span>
<span id="cb9-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Positive differences = Republicans prefer the level"</span></span>
<span id="cb9-32">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Candidate sex"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb9-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb9-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb9-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb9-38">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-diff-mm-parties-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>(For more about this, see <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span> for a few other examples of the substantive differences between subgroup conditional AMCEs and subgroup differences-between-marginal-means.)</p>
<p><strong>Long story short</strong>: because AMCEs are relative estimands, they get weird (and can’t really be used) when using them for descriptive estimands across subgroups or when controlling for other respondent characteristics. To account for this weirdness, calculate marginal means instead and find the subgroup differences in marginal means for each level.</p>
</section>
</section>
<section id="sec-frequentist" class="level1 page-columns page-full">
<h1>Finding conjoint AMCEs and marginal means frequentistly</h1>
<p>So now that we know what these two estimands are actually measuring and we have a general sense for how to calculate them (AMCE = regression coefficients where there’s an omitted reference category; marginal means = conditional averages for different category levels), let’s replicate the results from the candidate experiment in <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span>. We’ll do it the easy automatic way with <a href="https://thomasleeper.com/cregg/">Thomas Leeper’s {cregg} package</a> (named after <a href="https://en.wikipedia.org/wiki/C._J._Cregg">CJ Cregg from <em>The West Wing</em></a>), then we’ll do it more manually to see what’s going on behind the scenes.</p>
<section id="amces" class="level2">
<h2 class="anchored" data-anchor-id="amces">AMCEs</h2>
<p>First we’ll calculate the average marginal component effects (AMCEs), which are the partial derivatives (or coefficients) from a linear regression model. These represent the <em>causal</em> effect of switching from some reference level to a level of interest, while holding everything else constant.</p>
<section id="automatic-estimates-with-creggamce" class="level3">
<h3 class="anchored" data-anchor-id="automatic-estimates-with-creggamce">Automatic estimates with <code>cregg::amce()</code></h3>
<p>The <code>amce()</code> function from {cregg} calculates AMCEs automatically and returns them in a nice tidy data frame:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">model_candidate_amce <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">amce</span>(</span>
<span id="cb10-2">  candidate,</span>
<span id="cb10-3">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-4">    atprof <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atinc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atrace <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmale,</span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resID</span>
<span id="cb10-6">)</span>
<span id="cb10-7"></span>
<span id="cb10-8">model_candidate_amce <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb10-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 40 × 10</span></span>
<span id="cb10-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    outcome  statistic feature          level                  estimate std.error      z            p   lower   upper</span></span>
<span id="cb10-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;    &lt;chr&gt;     &lt;fct&gt;            &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb10-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 selected amce      Military Service Did Not Serve            0        NA      NA     NA           NA      NA     </span></span>
<span id="cb10-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 selected amce      Military Service Served                   0.0873    0.0177  4.95   0.000000761  0.0527  0.122 </span></span>
<span id="cb10-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 selected amce      Religion         None                     0        NA      NA     NA           NA      NA     </span></span>
<span id="cb10-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 selected amce      Religion         Jewish                  -0.0373    0.0263 -1.42   0.156       -0.0889  0.0143</span></span>
<span id="cb10-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 selected amce      Religion         Catholic                -0.0156    0.0278 -0.561  0.575       -0.0702  0.0389</span></span>
<span id="cb10-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 selected amce      Religion         Mainline protestant     -0.0149    0.0308 -0.484  0.629       -0.0753  0.0455</span></span>
<span id="cb10-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 selected amce      Religion         Evangelical protestant  -0.117     0.0309 -3.78   0.000157    -0.178  -0.0563</span></span>
<span id="cb10-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 selected amce      Religion         Mormon                  -0.137     0.0307 -4.46   0.00000838  -0.197  -0.0767</span></span>
<span id="cb10-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 selected amce      College          No BA                    0        NA      NA     NA           NA      NA     </span></span>
<span id="cb10-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 selected amce      College          Baptist college          0.139     0.0289  4.82   0.00000143   0.0827  0.196 </span></span>
<span id="cb10-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 30 more rows</span></span></code></pre></div>
</div>
<p>It also provides an automatic plot function. Compare this with the original—the results are identical.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true"><code>plot(cregg::amce())</code></a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Original AMCE coefficent plot</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(model_candidate_amce) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs from cregg::amce()"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-amce-automatic-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>Right panel of Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span>:</p>
<img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/SVG/leeper-et-al-2019_fig1_amces.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_amces@3x.png'; this.onerror=null">
</div>
</div>
</div>
</section>
<section id="ols-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="ols-coefficients">OLS coefficients</h3>
<p>Behind the scenes, {cregg} uses <code>survey::svyglm()</code> to run OLS with ID-specific adjustments to standard errors:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">candidate_svy_design <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">svydesign</span>(</span>
<span id="cb12-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ids =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resID,</span>
<span id="cb12-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb12-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate</span>
<span id="cb12-5">)</span>
<span id="cb12-6"></span>
<span id="cb12-7">model_svy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">svyglm</span>(</span>
<span id="cb12-8">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-9">    atprof <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atinc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atrace <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmale,</span>
<span id="cb12-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">design =</span> candidate_svy_design</span>
<span id="cb12-11">)</span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(model_svy)</span>
<span id="cb12-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 33 × 5</span></span>
<span id="cb12-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term                             estimate std.error statistic  p.value</span></span>
<span id="cb12-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb12-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 (Intercept)                        0.397     0.0484     8.20  9.18e-15</span></span>
<span id="cb12-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 atmilitaryServed                   0.0873    0.0177     4.95  1.32e- 6</span></span>
<span id="cb12-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 atreligionJewish                  -0.0373    0.0263    -1.42  1.58e- 1</span></span>
<span id="cb12-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 atreligionCatholic                -0.0156    0.0278    -0.561 5.75e- 1</span></span>
<span id="cb12-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 atreligionMainline protestant     -0.0149    0.0308    -0.484 6.29e- 1</span></span>
<span id="cb12-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 atreligionEvangelical protestant  -0.117     0.0309    -3.78  1.92e- 4</span></span>
<span id="cb12-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 atreligionMormon                  -0.137     0.0307    -4.46  1.22e- 5</span></span>
<span id="cb12-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 atedBaptist college                0.139     0.0289     4.82  2.36e- 6</span></span>
<span id="cb12-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 atedCommunity college              0.150     0.0290     5.17  4.44e- 7</span></span>
<span id="cb12-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 atedState university               0.188     0.0277     6.77  7.80e-11</span></span>
<span id="cb12-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 23 more rows</span></span></code></pre></div>
</div>
<p>These estimates and standard errors are the same results that we get from <code>cregg::amce()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine the estimates from cregg::amce() with the estimates from</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># survey::svglm() just to check that they're the same (they are)</span></span>
<span id="cb13-3">amce_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_candidate_amce <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(std.error) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(level, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">amce_estimate =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">amce_std.error =</span> std.error)</span>
<span id="cb13-7"></span>
<span id="cb13-8">svy_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_svy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Intercept)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">svy_estimate =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">svy_std.error =</span> std.error)</span>
<span id="cb13-12"></span>
<span id="cb13-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(amce_estimates, svy_estimates)</span>
<span id="cb13-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 32 × 5</span></span>
<span id="cb13-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    level                  amce_estimate amce_std.error svy_estimate svy_std.error</span></span>
<span id="cb13-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;                          &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb13-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 Served                        0.0873         0.0177       0.0873        0.0177</span></span>
<span id="cb13-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 Jewish                       -0.0373         0.0263      -0.0373        0.0263</span></span>
<span id="cb13-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 Catholic                     -0.0156         0.0278      -0.0156        0.0278</span></span>
<span id="cb13-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 Mainline protestant          -0.0149         0.0308      -0.0149        0.0308</span></span>
<span id="cb13-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 Evangelical protestant       -0.117          0.0309      -0.117         0.0309</span></span>
<span id="cb13-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 Mormon                       -0.137          0.0307      -0.137         0.0307</span></span>
<span id="cb13-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Baptist college               0.139          0.0289       0.139         0.0289</span></span>
<span id="cb13-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Community college             0.150          0.0290       0.150         0.0290</span></span>
<span id="cb13-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 State university              0.188          0.0277       0.188         0.0277</span></span>
<span id="cb13-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Small college                 0.178          0.0273       0.178         0.0273</span></span>
<span id="cb13-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 22 more rows</span></span></code></pre></div>
</div>
</section>
<section id="marginal-effects-instead-of-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="marginal-effects-instead-of-coefficients">Marginal effects instead of coefficients</h3>
<p>So these OLS coefficients here are the AMCEs. That’s super straightforward.</p>
<p>That’s only true because we’re estimating a <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#linear-probability-models">linear probability model (LPM)</a> here. <code>selected</code> is a binary 0/1 variable, but we’re pretending it’s numeric and using OLS with it. In this special case, the marginal effects (slopes) are just the partial derivatives reported in the regression table.</p>
<p>But if we’re going to have interaction terms, or nonlinear terms (like polynomials), or if we’re going to use a model family that’s not OLS (like logistic regression), raw coefficients won’t work. Instead we need to calculate actual marginal effects (see <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this post</a> and the <a href="https://vincentarelbundock.github.io/marginaleffects/articles/marginaleffects.html">“Get Started” page at the {marginaleffects} documentation</a> for more details about these).</p>
<p>At one point, {cregg} supported this by using the {margins} package (which makes sense—<a href="https://thomasleeper.com/">Thomas Leeper</a> developed both {cregg} and {margins}), but <a href="https://github.com/leeper/cregg/blob/main/NEWS.md#cregg-0114">starting with {cregg} version 0.1.14</a>, the {margins} support disappeared, leaving only support for OLS linear probability models.</p>
<p>We can use the <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects} package</a> (the successor to {margins}) to calculate the average marginal effects/slopes for each of these effects. Here we’ll just hold all the predictors at their means (but there are <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches">a ton of different estimands</a> we could calculate). In this case they’re the same as the raw coefficients, since it’s just a linear model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">mfx_svy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_svy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine the average marginal effects with the original coefficients just to</span></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check that they're the same (they are)</span></span>
<span id="cb14-6">mfx_svy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(contrast, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfx_estimate =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfx_std.error =</span> std.error) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(svy_estimates) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb14-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 32 × 5</span></span>
<span id="cb14-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    contrast                      mfx_estimate mfx_std.error svy_estimate svy_std.error</span></span>
<span id="cb14-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                                &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb14-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 45 - 36                            0.0259         0.0295       0.0873        0.0177</span></span>
<span id="cb14-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 52 - 36                            0.0236         0.0303      -0.0373        0.0263</span></span>
<span id="cb14-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 60 - 36                            0.00414        0.0288      -0.0156        0.0278</span></span>
<span id="cb14-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 68 - 36                           -0.0639         0.0294      -0.0149        0.0308</span></span>
<span id="cb14-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 75 - 36                           -0.146          0.0289      -0.117         0.0309</span></span>
<span id="cb14-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 Baptist college - No BA            0.139          0.0289      -0.137         0.0307</span></span>
<span id="cb14-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Community college - No BA          0.150          0.0290       0.139         0.0289</span></span>
<span id="cb14-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Ivy League university - No BA      0.269          0.0291       0.150         0.0290</span></span>
<span id="cb14-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Small college - No BA              0.178          0.0273       0.188         0.0277</span></span>
<span id="cb14-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 State university - No BA           0.188          0.0277       0.178         0.0273</span></span>
<span id="cb14-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 22 more rows</span></span></code></pre></div>
</div>
</section>
<section id="coefficient-plots" class="level3">
<h3 class="anchored" data-anchor-id="coefficient-plots">Coefficient plots</h3>
<p>What about that neat coefficient plot with the reference categories? <code>tidy()</code> can’t return empty rows for the reference levels like <code>cregg::amce()</code> does, but we can make it work in a couple different ways: (1) automatically with <code>broom.helpers::tidy_add_reference_rows()</code>, or (2) manually with some data wrangling.</p>
<section id="automatically-with-broom.helpers" class="level4">
<h4 class="anchored" data-anchor-id="automatically-with-broom.helpers">Automatically with {broom.helpers}</h4>
<p>The easiest way to do this is to use <code>broom.helpers::tidy_add_reference_rows()</code>, which adds the reference levels automatically with estimates of 0, so we can use <code>geom_pointrange()</code> and make basically the same plot as {cregg}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">plot_data_manual <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_svy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_and_attach</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_add_reference_rows</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_add_estimate_to_reference_rows</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Intercept)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(term, variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(term_nice, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb15-9"></span>
<span id="cb15-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb15-11">  plot_data_manual,</span>
<span id="cb15-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> term_nice, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb15-13">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb15-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb15-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb15-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs plotted with tidy_add_reference_rows()"</span></span>
<span id="cb15-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Automatically resize each facet height with ggforce::facet_col()</span></span>
<span id="cb15-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-amce-broom-helper-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="manually-with-dplyr-wrangling-magic" class="level4">
<h4 class="anchored" data-anchor-id="manually-with-dplyr-wrangling-magic">Manually with {dplyr} wrangling magic</h4>
<p>However, <code>tidy_add_reference_rows()</code> doesn’t work with {marginaleffects} objects or multilevel models or Bayesian models, so ultimately I can’t use this in the real project I’m working on :(</p>
<p>But we can get the same thing with some fancy data wrangling:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract all the right-hand variables</span></span>
<span id="cb16-2">rhs_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.vars</span>(stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formula</span>(model_svy), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .))</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a data frame of all the levels of all the non-numeric things</span></span>
<span id="cb16-5">model_variable_levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb16-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> rhs_vars</span>
<span id="cb16-7">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(variable, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb16-9">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> candidate[[.x]]</span>
<span id="cb16-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x)) {</span>
<span id="cb16-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb16-12">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.factor</span>(x)) {</span>
<span id="cb16-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(x)</span>
<span id="cb16-14">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb16-15">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb16-16">    }</span>
<span id="cb16-17">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(levels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(variable, levels))</span>
<span id="cb16-20"></span>
<span id="cb16-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract model results</span></span>
<span id="cb16-22">model_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(model_svy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb16-23"></span>
<span id="cb16-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with model results</span></span>
<span id="cb16-25">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_variable_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(model_results, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(term)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb16-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb16-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb16-30">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb16-31">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb16-32">    )</span>
<span id="cb16-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Intercept)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb16-37"></span>
<span id="cb16-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb16-39">  plot_data,</span>
<span id="cb16-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb16-41">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb16-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb16-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb16-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs from fancy data wrangling"</span></span>
<span id="cb16-50">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-amce-tidy-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The process is a little different with marginal effects because the <code>term</code> column is for the overarching variable (e.g., <code>taxrate1</code>) and the individual levels are built as contrasts in a column named <code>contrast</code>, like <code>"&lt;10k: 5% - &lt;10k: 0%"</code>. We need to clean up that <code>contrast</code> column for joining with <code>model_variable_levels</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract marginal effects</span></span>
<span id="cb17-2">model_results_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_svy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb17-5">    contrast,</span>
<span id="cb17-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb17-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb17-8">  )</span>
<span id="cb17-9"></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb17-11">plot_data_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_variable_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb17-13">    model_results_mfx,</span>
<span id="cb17-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb17-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb17-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb17-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb17-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb17-20">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb17-21">    )</span>
<span id="cb17-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb17-25"></span>
<span id="cb17-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb17-27">  plot_data_mfx,</span>
<span id="cb17-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb17-29">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb17-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb17-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb17-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs from OLS marginal effects"</span></span>
<span id="cb17-38">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-amce-mfx-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="logistic-regression-instead-of-ols" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression-instead-of-ols">Logistic regression instead of OLS</h3>
<p>What if you don’t want use a linear probability model and instead want to use a different family like logistic regression (which treats the outcome as actual 0 and 1 categories instead of numbers)? Or what if you have 3+ possible choices for outcomes and need to use a multinomial logistic regression model? We can still calculate AMCEs, but we can’t use raw regression coefficients. Instead we have to calculate response-scale (i.e.&nbsp;probability scale) marginal effects.</p>
<p>Let’s make a logistic regression model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">model_logit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> survey<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">svyglm</span>(</span>
<span id="cb18-2">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-3">    atprof <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atinc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atrace <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmale,</span>
<span id="cb18-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">design =</span> candidate_svy_design,</span>
<span id="cb18-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb18-6">)</span></code></pre></div>
</div>
<p>Check out those sweet sweet uninterpretable log odds:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(model_logit)</span>
<span id="cb19-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 33 × 5</span></span>
<span id="cb19-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term                             estimate std.error statistic  p.value</span></span>
<span id="cb19-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb19-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 (Intercept)                       -0.466     0.215     -2.17  3.07e- 2</span></span>
<span id="cb19-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 atmilitaryServed                   0.385     0.0775     4.96  1.22e- 6</span></span>
<span id="cb19-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 atreligionJewish                  -0.162     0.116     -1.40  1.62e- 1</span></span>
<span id="cb19-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 atreligionCatholic                -0.0651    0.123     -0.531 5.96e- 1</span></span>
<span id="cb19-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 atreligionMainline protestant     -0.0634    0.136     -0.468 6.40e- 1</span></span>
<span id="cb19-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 atreligionEvangelical protestant  -0.510     0.137     -3.72  2.44e- 4</span></span>
<span id="cb19-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 atreligionMormon                  -0.600     0.137     -4.39  1.64e- 5</span></span>
<span id="cb19-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 atedBaptist college                0.619     0.131      4.74  3.43e- 6</span></span>
<span id="cb19-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 atedCommunity college              0.663     0.131      5.06  7.73e- 7</span></span>
<span id="cb19-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 atedState university               0.828     0.126      6.57  2.43e-10</span></span>
<span id="cb19-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 23 more rows</span></span></code></pre></div>
</div>
<p>We can convert these log odds into probability-scale marginal effects with <code>slopes()</code> or <code>avg_slopes()</code> from {marginaleffects}. Conceptually this involves plugging in different covariate values—here we’re plugging in all the original values in the data into the model and then collapsing the predictions into averages. (Again, <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches">see this</a> and <a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">this</a> for more details about average marginal effects/slopes.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">mfx_logit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>()</span>
<span id="cb20-3"></span>
<span id="cb20-4">mfx_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb20-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 32 × 8</span></span>
<span id="cb20-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term  contrast                      estimate std.error statistic  p.value conf.low conf.high</span></span>
<span id="cb20-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt; &lt;chr&gt;                            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb20-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 atage 45 - 36                        0.0258     0.0296     0.874 3.82e- 1  -0.0321   0.0838 </span></span>
<span id="cb20-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 atage 52 - 36                        0.0232     0.0303     0.765 4.44e- 1  -0.0362   0.0826 </span></span>
<span id="cb20-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 atage 60 - 36                        0.00406    0.0289     0.141 8.88e- 1  -0.0526   0.0607 </span></span>
<span id="cb20-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 atage 68 - 36                       -0.0639     0.0294    -2.17  3.00e- 2  -0.122   -0.00619</span></span>
<span id="cb20-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 atage 75 - 36                       -0.145      0.0289    -5.03  4.86e- 7  -0.202   -0.0888 </span></span>
<span id="cb20-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 ated  Baptist college - No BA        0.140      0.0290     4.82  1.45e- 6   0.0828   0.196  </span></span>
<span id="cb20-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 ated  Community college - No BA      0.150      0.0291     5.15  2.56e- 7   0.0928   0.207  </span></span>
<span id="cb20-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 ated  Ivy League university - No BA  0.269      0.0291     9.26  2.11e-20   0.212    0.326  </span></span>
<span id="cb20-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 ated  Small college - No BA          0.178      0.0274     6.50  8.07e-11   0.124    0.231  </span></span>
<span id="cb20-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 ated  State university - No BA       0.188      0.0277     6.80  1.04e-11   0.134    0.243  </span></span>
<span id="cb20-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 22 more rows</span></span></code></pre></div>
</div>
<p>heck yes these percentage-point-scale estimates are basically the same as what we get from the LPM model!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract marginal effects</span></span>
<span id="cb21-2">model_results_logit_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mfx_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb21-4">    contrast,</span>
<span id="cb21-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb21-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb21-7">  )</span>
<span id="cb21-8"></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb21-10">plot_data_logit_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_variable_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb21-12">    model_results_logit_mfx,</span>
<span id="cb21-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb21-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb21-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb21-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb21-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb21-19">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb21-20">    )</span>
<span id="cb21-21">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb21-24"></span>
<span id="cb21-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb21-26">  plot_data_logit_mfx,</span>
<span id="cb21-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb21-28">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb21-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb21-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb21-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs from logistic regression marginal effects"</span></span>
<span id="cb21-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-amce-mfx-logit-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="marginal-means-1" class="level2">
<h2 class="anchored" data-anchor-id="marginal-means-1">Marginal means</h2>
<p>Next we’ll calculate marginal means for these different attributes and levels, which are conditional averages and not regression coefficients. These are <em>descriptive</em> estimands/quantities of interest and they don’t rely on any reference category or baseline level.</p>
<section id="automatic-estimates-with-creggmm" class="level3">
<h3 class="anchored" data-anchor-id="automatic-estimates-with-creggmm">Automatic estimates with <code>cregg::mm()</code></h3>
<p>The <code>mm()</code> function from {cregg} calculates marginal means automatically and returns them in a nice tidy data frame. I include the package namespace prefix here (i.e.&nbsp;<code>cregg::mm()</code> instead of just <code>mm()</code>) because I’ve loaded the {brms} package and it has its own <code>mm()</code> function that’s used for creating multi-membership grouping terms (whatever those are).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">candidate_mms_auto <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cregg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(</span>
<span id="cb22-2">  candidate,</span>
<span id="cb22-3">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-4">    atprof <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atinc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atrace <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmale,</span>
<span id="cb22-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> resID</span>
<span id="cb22-6">)</span>
<span id="cb22-7"></span>
<span id="cb22-8">candidate_mms_auto <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb22-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 40 × 10</span></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    outcome  statistic feature          level                  estimate std.error     z         p lower upper</span></span>
<span id="cb22-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;    &lt;chr&gt;     &lt;fct&gt;            &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb22-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 selected mm        Military Service Did Not Serve             0.458   0.00907  50.5 0         0.440 0.475</span></span>
<span id="cb22-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 selected mm        Military Service Served                    0.543   0.00914  59.4 0         0.525 0.560</span></span>
<span id="cb22-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 selected mm        Religion         None                      0.556   0.0200   27.8 1.88e-170 0.517 0.595</span></span>
<span id="cb22-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 selected mm        Religion         Jewish                    0.520   0.0186   28.0 2.77e-172 0.484 0.557</span></span>
<span id="cb22-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 selected mm        Religion         Catholic                  0.526   0.0177   29.7 2.82e-193 0.491 0.560</span></span>
<span id="cb22-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 selected mm        Religion         Mainline protestant       0.543   0.0194   28.0 3.93e-172 0.505 0.581</span></span>
<span id="cb22-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 selected mm        Religion         Evangelical protestant    0.437   0.0200   21.9 4.11e-106 0.398 0.476</span></span>
<span id="cb22-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 selected mm        Religion         Mormon                    0.417   0.0194   21.5 7.40e-103 0.379 0.455</span></span>
<span id="cb22-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 selected mm        College          No BA                     0.340   0.0186   18.3 1.12e- 74 0.303 0.376</span></span>
<span id="cb22-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 selected mm        College          Baptist college           0.482   0.0200   24.1 3.89e-128 0.443 0.521</span></span>
<span id="cb22-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 30 more rows</span></span></code></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true"><code>plot(cregg::mm())</code></a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Original AMCE coefficent plot</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(candidate_mms_auto, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vline =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means from from cregg::mm()"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-mm-automatic-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<p>Left panel of Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span>:</p>
<img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/img/SVG/leeper-et-al-2019_fig1_mms.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_mms@3x.png'; this.onerror=null">
</div>
</div>
</div>
</section>
<section id="quick-and-dirty-marginal-means" class="level3">
<h3 class="anchored" data-anchor-id="quick-and-dirty-marginal-means">Quick-and-dirty marginal means</h3>
<p>Marginal means are just conditional group averages, so we can actually get the same estimates with some basic {dplyr} grouping and summarizing. I’ll just show the averages for military and religion here for the sake of space, but the averages are the same as what we get with <code>cregg::mm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atmilitary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb24-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb24-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb24-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary      avg</span></span>
<span id="cb24-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;dbl&gt;</span></span>
<span id="cb24-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve 0.458</span></span>
<span id="cb24-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Served        0.543</span></span>
<span id="cb24-9"></span>
<span id="cb24-10">candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb24-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atreligion) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb24-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb24-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 2</span></span>
<span id="cb24-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atreligion               avg</span></span>
<span id="cb24-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;                  &lt;dbl&gt;</span></span>
<span id="cb24-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 None                   0.556</span></span>
<span id="cb24-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Jewish                 0.520</span></span>
<span id="cb24-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Catholic               0.526</span></span>
<span id="cb24-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Mainline protestant    0.543</span></span>
<span id="cb24-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Evangelical protestant 0.437</span></span>
<span id="cb24-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Mormon                 0.417</span></span></code></pre></div>
</div>
<p>Behind the scenes, <code>cregg::mm()</code> creates simple intercept-less models for each of the categorical terms in the model and then returns their coefficients. Again, for the sake of space, here are the regression-based averages for just military and religion:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmilitary, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate)),</span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate))</span>
<span id="cb25-4">)</span>
<span id="cb25-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 8 × 5</span></span>
<span id="cb25-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term                             estimate std.error statistic   p.value</span></span>
<span id="cb25-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 atmilitaryDid Not Serve             0.458    0.0120      38.3 1.16e-267</span></span>
<span id="cb25-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 atmilitaryServed                    0.543    0.0120      45.3 0        </span></span>
<span id="cb25-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 atreligionNone                      0.556    0.0205      27.1 3.39e-147</span></span>
<span id="cb25-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 atreligionJewish                    0.520    0.0208      25.0 9.62e-127</span></span>
<span id="cb25-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 atreligionCatholic                  0.526    0.0205      25.6 1.34e-132</span></span>
<span id="cb25-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 atreligionMainline protestant       0.543    0.0209      26.0 1.36e-136</span></span>
<span id="cb25-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 atreligionEvangelical protestant    0.437    0.0209      20.9 1.53e- 91</span></span>
<span id="cb25-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 8 atreligionMormon                    0.417    0.0207      20.2 8.15e- 86</span></span></code></pre></div>
</div>
<p>Regardless of how we calculate them, we can see that these estimates are just group averages. 46% of respondents chose candidates who didn’t serve in the military; 54% chose candidates who did; and so on.</p>
</section>
<section id="marginal-means-with-marginaleffects" class="level3">
<h3 class="anchored" data-anchor-id="marginal-means-with-marginaleffects">Marginal means with {marginaleffects}</h3>
<p>Combining a bunch of smaller <code>group_by() %&gt;% summarize()</code> datasets, or combining a bunch of intercept-less models involves a bit of extra code and can get tedious. Plus it can get more complex when not using a linear model, or if you want interaction terms, or if you want group averages across multiple groups (i.e.&nbsp;average proportions for military across Republican and Democratic respondents). Additionally, the standard errors from these basic averages are wrong since they don’t take into account the nested structure of the data (i.e.&nbsp;respondents each have 6–12 responses).</p>
<p>To make life easier and more flexible, we can use <code>marginal_means()</code> from {marginaleffects} to calculate the unique categorical group means from a regression model.</p>
<section id="how-marginal_means-works" class="level4">
<h4 class="anchored" data-anchor-id="how-marginal_means-works">How <code>marginal_means()</code> works</h4>
<p>But first we need to look at a quick example to build the intuition behind what happens with <code>marginal_means()</code>. First we’ll make a simpler regresison model with just the military and religion features. We’ll then calculate predicted values for all the levels of those features using <code>predictions()</code>—this essentially involves plugging in all the unique values of <code>atmilitary</code> and <code>atreligion</code> into the model and finding the predicted values. We’ll then reshape the results a little so that we can see the average proportions of religion conditional on military service:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">model_candidate_simple <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(</span>
<span id="cb26-2">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion, </span>
<span id="cb26-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate</span>
<span id="cb26-4">)</span>
<span id="cb26-5"></span>
<span id="cb26-6">predictions_simple <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb26-7">  model_candidate_simple,</span>
<span id="cb26-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>)</span>
<span id="cb26-9">)</span>
<span id="cb26-10"></span>
<span id="cb26-11">predictions_simple_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> predictions_simple <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(estimate, atmilitary, atreligion) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"estimate"</span>)</span>
<span id="cb26-14">predictions_simple_wide</span>
<span id="cb26-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 3</span></span>
<span id="cb26-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atreligion             `Did Not Serve` Served</span></span>
<span id="cb26-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;                            &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb26-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 None                             0.514  0.598</span></span>
<span id="cb26-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Jewish                           0.479  0.563</span></span>
<span id="cb26-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Catholic                         0.483  0.567</span></span>
<span id="cb26-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Mainline protestant              0.500  0.584</span></span>
<span id="cb26-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Evangelical protestant           0.394  0.478</span></span>
<span id="cb26-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Mormon                           0.376  0.460</span></span></code></pre></div>
</div>
<p>Great. The average proportion for non-military Mormons is 37.6% and for military Mormons is 46%, and so on.</p>
<p>If we find the average of these averages and add a column and row in the literal right and bottom margins of the table, we’ll have marginal means of religion and military service:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">predictions_simple_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Religion marginal mean</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Did Not Serve</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Served) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb27-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb27-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atreligion =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military marginal mean"</span>, </span>
<span id="cb27-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Did Not Serve</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(predictions_simple_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Did Not Serve</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>),</span>
<span id="cb27-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Served =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(predictions_simple_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Served)</span>
<span id="cb27-7">  )</span>
<span id="cb27-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 7 × 4</span></span>
<span id="cb27-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atreligion             `Did Not Serve` Served `Religion marginal mean`</span></span>
<span id="cb27-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                            &lt;dbl&gt;  &lt;dbl&gt;                    &lt;dbl&gt;</span></span>
<span id="cb27-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 None                             0.514  0.598                    0.556</span></span>
<span id="cb27-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Jewish                           0.479  0.563                    0.521</span></span>
<span id="cb27-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Catholic                         0.483  0.567                    0.525</span></span>
<span id="cb27-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Mainline protestant              0.500  0.584                    0.542</span></span>
<span id="cb27-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Evangelical protestant           0.394  0.478                    0.436</span></span>
<span id="cb27-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Mormon                           0.376  0.460                    0.418</span></span>
<span id="cb27-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7 Military marginal mean           0.458  0.542                   NA</span></span></code></pre></div>
</div>
<p>To me this is wild. The marginal mean for Mormons is 41%, which is basically what we found with <code>group_by(atreligion) %&gt;% summarize()</code> earlier. The marginal mean for candidates who served in the military is 54.2%, again roughly the same as what we found with <code>group_by(atmilitary) %&gt;% summarize(...)</code>.</p>
<p>Instead of manually creating these marginal rows and columns, the <code>marginal_means()</code> function will find those values automatically for us, based on a grid of values (in <code>newdata</code>) that it’ll plug into the model. Here it’ll plug all combinations of <code>atreligion</code> and <code>atmilitary</code> into the simple model. The <code>wts = "cells"</code> argument here makes it so that the marginal mean is weighted by the actual distribution of the levels of religion and military. For instance, imagine that only 30% of rows served in the military and 70% did not. Calculating the average of those two averages by just doing <code>(Did Not Serve + Served) / 2</code> wouldn’t take that underlying distribution into account. Weighting by cells make it so that <code>marginal_means()</code> computes a weighted marginal mean proportional to each level’s frequency in the original data.</p>
<p>Let’s let <code>marginal_means()</code> work its magic:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">marginal_means_simple <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_means</span>(</span>
<span id="cb28-2">  model_candidate_simple,</span>
<span id="cb28-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>),</span>
<span id="cb28-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells"</span></span>
<span id="cb28-5">)</span>
<span id="cb28-6">marginal_means_simple</span>
<span id="cb28-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb28-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##        Term                  Value  Mean Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span id="cb28-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atmilitary Did Not Serve          0.458     0.0119 38.5   &lt;0.001 0.434  0.481</span></span>
<span id="cb28-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atmilitary Served                 0.543     0.0119 45.5   &lt;0.001 0.519  0.566</span></span>
<span id="cb28-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion None                   0.556     0.0204 27.2   &lt;0.001 0.516  0.596</span></span>
<span id="cb28-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion Jewish                 0.520     0.0208 25.1   &lt;0.001 0.479  0.561</span></span>
<span id="cb28-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion Catholic               0.526     0.0205 25.7   &lt;0.001 0.485  0.566</span></span>
<span id="cb28-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion Mainline protestant    0.543     0.0208 26.1   &lt;0.001 0.502  0.584</span></span>
<span id="cb28-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion Evangelical protestant 0.437     0.0208 21.0   &lt;0.001 0.396  0.477</span></span>
<span id="cb28-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atreligion Mormon                 0.417     0.0206 20.3   &lt;0.001 0.377  0.458</span></span>
<span id="cb28-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb28-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Results averaged over levels of: atmilitary, atreligion </span></span>
<span id="cb28-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, value, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<p>Et voilà, the averages here are basically the same as what we found in the manual version we did earlier. The only differences are due to the weighted averaging—by default <code>marginal_means()</code> assumes equal weights in the columns, so it’s literally going to just calculate <code>(Did Not Serve + Served) / 2</code>. With <code>wts = "cells"</code>, it creates a weighted average: <code>(Did Not Serve * cell_weight + Served * other_cell_weight) / 2</code>.</p>
</section>
<section id="marginal_means-with-the-full-actual-model" class="level4">
<h4 class="anchored" data-anchor-id="marginal_means-with-the-full-actual-model"><code>marginal_means()</code> with the full actual model</h4>
<p>Now that we understand what’s happening with <code>marginal_means()</code>, we can use it with the full <code>model_svy</code> model. We’ll find the marginal means for all the different features and make sure that we weight by cells so that we get weighted averages. Because there are so many combinations of attribute levels here, it takes a while to run:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/create-mm-mfx_d52969d33f342207792d6db0095acc4c">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This takes a while...</span></span>
<span id="cb29-2">tictoc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tic</span>()</span>
<span id="cb29-3">mm_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_means</span>(</span>
<span id="cb29-4">  model_svy, </span>
<span id="cb29-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb29-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ated"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atprof"</span>, </span>
<span id="cb29-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atinc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atrace"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atage"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmale"</span></span>
<span id="cb29-8">  ),</span>
<span id="cb29-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells"</span></span>
<span id="cb29-10">)</span>
<span id="cb29-11">tictoc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc</span>()</span>
<span id="cb29-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 82.563 sec elapsed</span></span></code></pre></div>
</div>
<p>The results are identical to what we find when using <code>group_by() %&gt;% summarize()</code>, but</p>
<ol type="1">
<li>the standard errors are correct (and actually present; we’d need to calculate those on our own with <code>summarize()</code> and that’s a pain), and</li>
<li>we have the ability to use other extra {marginaleffects} things like hypothesis tests, counterfactual estimates, p-value adjustments for multiple comparisons, clustered robust standard errors, and so on</li>
</ol>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true"><code>marginal_means()</code></a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false"><code>group_by() %&gt;% summarize()</code></a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">mm_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb30-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 40 × 8</span></span>
<span id="cb30-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term       value                  estimate std.error statistic   p.value conf.low conf.high</span></span>
<span id="cb30-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;      &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb30-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 atmilitary Did Not Serve             0.458   0.00913      50.1 0            0.440     0.476</span></span>
<span id="cb30-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 atmilitary Served                    0.543   0.00928      58.4 0            0.524     0.561</span></span>
<span id="cb30-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 atreligion None                      0.556   0.0195       28.5 1.64e-178    0.518     0.594</span></span>
<span id="cb30-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 atreligion Jewish                    0.520   0.0175       29.7 1.90e-194    0.486     0.554</span></span>
<span id="cb30-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 atreligion Catholic                  0.526   0.0177       29.7 3.14e-193    0.491     0.560</span></span>
<span id="cb30-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 atreligion Mainline protestant       0.543   0.0184       29.6 1.86e-192    0.507     0.579</span></span>
<span id="cb30-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 atreligion Evangelical protestant    0.437   0.0198       22.0 1.07e-107    0.398     0.475</span></span>
<span id="cb30-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 atreligion Mormon                    0.417   0.0189       22.1 8.22e-108    0.380     0.454</span></span>
<span id="cb30-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 ated       No BA                     0.340   0.0184       18.5 5.02e- 76    0.304     0.376</span></span>
<span id="cb30-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 ated       Baptist college           0.482   0.0198       24.4 1.63e-131    0.443     0.521</span></span>
<span id="cb30-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 30 more rows</span></span></code></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atmilitary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb31-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb31-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary      avg</span></span>
<span id="cb31-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;dbl&gt;</span></span>
<span id="cb31-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve 0.458</span></span>
<span id="cb31-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Served        0.543</span></span>
<span id="cb31-9"></span>
<span id="cb31-10">candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atreligion) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb31-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 2</span></span>
<span id="cb31-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atreligion               avg</span></span>
<span id="cb31-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;                  &lt;dbl&gt;</span></span>
<span id="cb31-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 None                   0.556</span></span>
<span id="cb31-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Jewish                 0.520</span></span>
<span id="cb31-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Catholic               0.526</span></span>
<span id="cb31-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Mainline protestant    0.543</span></span>
<span id="cb31-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 Evangelical protestant 0.437</span></span>
<span id="cb31-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 Mormon                 0.417</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<p>Since there’s no reference level to deal with, plotting these these marginal means is pretty straightforward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">plot_mm_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mm_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(value, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb32-8">  plot_mm_mfx,</span>
<span id="cb32-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> variable_nice)</span>
<span id="cb32-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb32-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal mean"</span>,</span>
<span id="cb32-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb32-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means with marginaleffects::marginal_means()"</span></span>
<span id="cb32-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/taxes-mm-plot-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="subgroup-differences-in-amces-and-marginal-means" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="subgroup-differences-in-amces-and-marginal-means">Subgroup differences in AMCEs and marginal means</h2>
<p><span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (2014)</span> did not include any individual respondent-level characteristics in their data, so we can’t look at how these causal effects differ across individual traits like party identification (Republicans and Democrats) or education or income or anything else like that.</p>
<p>So instead we’ll invent a pretend column for respondent-level party ID! To simplify life, we’ll look at differences between fake-party-ID within the military service history attribute. Arbitrarily (and super stereotypically), we’ll say that if a respondent selected a candidate more than 60% of the time when seeing that they had served in the military, there’s a 90% chance they’re a Republican. If they didn’t select the military candidate 60% of the time, there’s a 75% chance they’re a Democrat. AGAIN THESE PROBABILITIES ARE COMPLETELY ARBITRARY AND JUST CAME FROM MY HEAD—THEY ARE NOT REAL. We’ll make a new dataset called <code>candidate_fake</code> with a column named <code>respondent_party</code> for each respondent’s fake party:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code for generating fake <code>respondent_party</code> column</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wrap this in withr::with_seed() so that the randomness is reproducible but the</span></span>
<span id="cb33-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># overall document seed doesn't get set or messed up</span></span>
<span id="cb33-3">withr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>, {</span>
<span id="cb33-4">  respondents_party_military <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(resID, atmilitary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the proportion of times each respondent selected the candidate when</span></span>
<span id="cb33-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># military service history was "Served"</span></span>
<span id="cb33-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_select =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Served"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>atmilitary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If a respondent selected the candidate more than 60% of the time when</span></span>
<span id="cb33-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># seeing that they had served in the military, there's a 90% chance they're</span></span>
<span id="cb33-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># a Republican. If they didn't select the military candidate 60% of the</span></span>
<span id="cb33-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time, there's a 75% chance they're a Democrat.</span></span>
<span id="cb33-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">respondent_party =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb33-17">      prob_select <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb33-18">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb33-19">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Democrat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb33-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb33-21">        ),</span>
<span id="cb33-22">      prob_select <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb33-23">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb33-24">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Democrat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb33-25">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb33-26">        )</span>
<span id="cb33-27">    )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">respondent_party =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(respondent_party))</span>
<span id="cb33-29">})</span>
<span id="cb33-30"></span>
<span id="cb33-31">candidate_fake <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(respondents_party_military, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(resID))</span></code></pre></div>
</details>
</div>
<p>Let’s check the average of <code>selected</code> across both the candidate military attribute and our new fake respondent party to see how all that random assignment shook out:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">candidate_fake <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atmilitary, respondent_party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb34-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb34-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   atmilitary [2]</span></span>
<span id="cb34-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary    respondent_party   avg</span></span>
<span id="cb34-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;</span></span>
<span id="cb34-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve Democrat         0.551</span></span>
<span id="cb34-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Did Not Serve Republican       0.378</span></span>
<span id="cb34-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Served        Democrat         0.447</span></span>
<span id="cb34-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Served        Republican       0.619</span></span></code></pre></div>
</div>
<p>Cool cool. Republican respondents are way more favorable towards candidates who served in the military (61.9%) than Democratic respondents (44.8%). And that kind of interpretation is actually mathematically and conceptually legal and recommended by <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (2020)</span>—technically these are subgroup marginal means and what we should be looking at for descriptive purposes already, but more on that below.</p>
<section id="conditional-amces" class="level4">
<h4 class="anchored" data-anchor-id="conditional-amces">Conditional AMCEs</h4>
<p>Let’s first look at the two different party-based causal effects of switching a candidate from having no military history to having served in the military. For the sake of simplicity we’ll just use regular OLS instead of logistic regression, and we’ll use <code>marginaleffects::avg_slopes()</code> to find the marginal since the regression model involves interaction terms. We’ll also only look at the <code>atmilitary</code> feature instead of all the features, since it’s the only one where we built in a party effect.</p>
<p>We can find conditional AMCEs with {cregg} using the <code>cj()</code> function, which is a general function for all of the different estimands that {cregg} can calculate:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">cregg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cj</span>(</span>
<span id="cb35-2">  candidate_fake, </span>
<span id="cb35-3">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary, </span>
<span id="cb35-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resID, </span>
<span id="cb35-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"amce"</span>, </span>
<span id="cb35-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>respondent_party</span>
<span id="cb35-7">)</span>
<span id="cb35-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##           BY  outcome statistic          feature         level estimate std.error      z         p   lower    upper respondent_party</span></span>
<span id="cb35-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1   Democrat selected      amce Military Service Did Not Serve   0.0000        NA     NA        NA      NA       NA         Democrat</span></span>
<span id="cb35-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2   Democrat selected      amce Military Service        Served  -0.1032   0.02063 -5.003 5.655e-07 -0.1437 -0.06278         Democrat</span></span>
<span id="cb35-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Republican selected      amce Military Service Did Not Serve   0.0000        NA     NA        NA      NA       NA       Republican</span></span>
<span id="cb35-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Republican selected      amce Military Service        Served   0.2405   0.02246 10.710 9.095e-27  0.1965  0.28455       Republican</span></span></code></pre></div>
</div>
<p>We can do the same thing using regression if we use an interaction term for the subgroup:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">model_military_party <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(</span>
<span id="cb36-2">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> respondent_party, </span>
<span id="cb36-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate_fake</span>
<span id="cb36-4">)</span>
<span id="cb36-5"></span>
<span id="cb36-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(model_military_party)</span>
<span id="cb36-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 5</span></span>
<span id="cb36-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term                                        estimate std.error statistic   p.value</span></span>
<span id="cb36-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                                          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb36-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 (Intercept)                                    0.551    0.0174     31.7  7.90e-194</span></span>
<span id="cb36-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 atmilitaryServed                              -0.103    0.0248     -4.16 3.21e-  5</span></span>
<span id="cb36-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 respondent_partyRepublican                    -0.172    0.0236     -7.28 3.97e- 13</span></span>
<span id="cb36-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 atmilitaryServed:respondent_partyRepublican    0.344    0.0335     10.3  2.48e- 24</span></span></code></pre></div>
</div>
<p>Those coefficients by themselves aren’t super informative without doing some tricky algebra to piece everything together. Instead, we can use <code>avg_slopes()</code> from {marginaleffects} to find the partial derivative (or AMCE) for <code>atmilitary</code> across each party. These are the same results we get from {cregg}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">party_amces <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_military_party <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>(</span>
<span id="cb37-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>,</span>
<span id="cb37-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span></span>
<span id="cb37-5">  )</span>
<span id="cb37-6">party_amces</span>
<span id="cb37-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb37-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##        Term                           Contrast respondent_party Estimate Std. Error     z Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span id="cb37-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atmilitary mean(Served) - mean(Did Not Serve)       Democrat     -0.103     0.0248 -4.16   &lt;0.001 -0.152 -0.0546</span></span>
<span id="cb37-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  atmilitary mean(Served) - mean(Did Not Serve)       Republican    0.241     0.0226 10.66   &lt;0.001  0.196  0.2847</span></span>
<span id="cb37-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb37-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Columns: term, contrast, respondent_party, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Click to show the code since it’s so long; you can make a quick basic version of it with two calls to <code>plot(amce(...))</code>—one on data filtered to only include Democrats and one that only includes Republicans</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean up marginal effects</span></span>
<span id="cb38-2">party_amces_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_amces <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The contrast column contains values like this:</span></span>
<span id="cb38-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   mean(Served) - mean(Did Not Serve)</span></span>
<span id="cb38-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span id="cb38-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># just brute force it and remove "mean(" and ")" with two separate</span></span>
<span id="cb38-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># str_remove()s</span></span>
<span id="cb38-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb38-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(contrast, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>),</span>
<span id="cb38-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(contrast, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb38-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb38-13">    contrast,</span>
<span id="cb38-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb38-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb38-16">  )</span>
<span id="cb38-17"></span>
<span id="cb38-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb38-19">plot_amces_party_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand_grid</span>(</span>
<span id="cb38-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">respondent_party =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(candidate_fake<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>respondent_party),</span>
<span id="cb38-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(model_variable_levels, variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>)</span>
<span id="cb38-22">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb38-24">    party_amces_mfx,</span>
<span id="cb38-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level, respondent_party)</span>
<span id="cb38-26">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb38-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb38-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb38-30">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(estimate, conf.low, conf.high),</span>
<span id="cb38-31">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb38-32">    )</span>
<span id="cb38-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb38-37">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_amce</span>(estimate),</span>
<span id="cb38-38">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb38-39">  ))</span>
<span id="cb38-40"></span>
<span id="cb38-41">p_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb38-42">  plot_amces_party_mfx, </span>
<span id="cb38-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> respondent_party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(</span>
<span id="cb38-46">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high),</span>
<span id="cb38-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>)</span>
<span id="cb38-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(</span>
<span id="cb38-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> estimate_nice), </span>
<span id="cb38-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>),</span>
<span id="cb38-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb38-53">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> parties) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb38-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb38-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb38-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb38-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AMCEs by respondent party"</span></span>
<span id="cb38-61">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-63">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb38-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb38-65">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb38-66">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb38-67">  )</span>
<span id="cb38-68">p_mfx</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-mfx-party-amce-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>These have a straightforward causal interpretation. Among Democratic-identifying respondents, flipping a hypothetical candidate’s military status from “did not serve” to “serve” causes a 10 percentage point drop in favorability (or in the probability of being selected). Among Republican-identifying respondents, a candidate’s military service causes a 24 percentage point increase in favorability. Both effects are statistically significantly different from zero.</p>
</section>
<section id="conditional-marginal-means" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="conditional-marginal-means">Conditional marginal means</h3>
<p>If we’re describing overall trends in the data, though, these conditional AMCEs are misleading. It’s really tempting to look at this and conclude that there’s a 34ish percentage point difference between Democrats and Republicans when they’re presented with a candidate with military service, since that’s the distance between the two AMCEs in the plot. <strong>But that’s wrong!</strong> That distance is an illusion—a mirage caused by the fact that the AMCEs are based on a reference category that is set to zero.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">p_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb39-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"errorbar"</span>,</span>
<span id="cb39-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.103</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.241</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb39-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb39-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb39-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, </span>
<span id="cb39-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.241</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.241</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.103</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb39-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This difference isn't</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">what you think it is!"</span>, </span>
<span id="cb39-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb39-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb39-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>,</span>
<span id="cb39-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb39-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>))</span>
<span id="cb39-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb39-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, </span>
<span id="cb39-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb39-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"These 0s mess things up!"</span>, </span>
<span id="cb39-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb39-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb39-24">  ) </span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-mfx-party-amce-annotated-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>To get the correct party-based difference in support for candidates, we need to find the party-based marginal means of support for the different levels of the military feature and then talk about <em>those</em> differences. As discussed above, this technically just involves finding the conditional averages across groups—in this case the average outcome within the two levels of “Served” and “Did not serve” between Republican and Democratic respondents. We can find these marginal means with some basic <code>group_by() %&gt;% summarize()</code> and the difference between Republican and Democratic marginal means with some pivoting and subtracting:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">party_mms_manual <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> candidate_fake <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atmilitary, respondent_party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(selected))</span>
<span id="cb40-4">party_mms_manual</span>
<span id="cb40-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb40-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   atmilitary [2]</span></span>
<span id="cb40-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary    respondent_party   avg</span></span>
<span id="cb40-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;</span></span>
<span id="cb40-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve Democrat         0.551</span></span>
<span id="cb40-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Did Not Serve Republican       0.378</span></span>
<span id="cb40-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Served        Democrat         0.447</span></span>
<span id="cb40-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Served        Republican       0.619</span></span>
<span id="cb40-13"></span>
<span id="cb40-14">party_mms_manual <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"avg"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mm_diff =</span> Republican <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Democrat)</span>
<span id="cb40-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 4</span></span>
<span id="cb40-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   atmilitary [2]</span></span>
<span id="cb40-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary    Democrat Republican mm_diff</span></span>
<span id="cb40-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;            &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb40-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve    0.551      0.378  -0.172</span></span>
<span id="cb40-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Served           0.447      0.619   0.172</span></span></code></pre></div>
</div>
<p>Or we can use <code>cregg::cj(..., estimate = "mm_diff")</code> to do that automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cj</span>(</span>
<span id="cb41-2">  candidate_fake, </span>
<span id="cb41-3">  selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary, </span>
<span id="cb41-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>resID, </span>
<span id="cb41-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mm_diff"</span>, </span>
<span id="cb41-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>respondent_party</span>
<span id="cb41-7">)</span>
<span id="cb41-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                      BY     statistic  outcome          feature         level estimate std.error      z         p   lower   upper respondent_party</span></span>
<span id="cb41-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Republican - Democrat mm_difference selected Military Service Did Not Serve  -0.1722   0.01531 -11.25 2.361e-29 -0.2022 -0.1422       Republican</span></span>
<span id="cb41-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Republican - Democrat mm_difference selected Military Service        Served   0.1715   0.01574  10.89 1.219e-27  0.1407  0.2024       Republican</span></span></code></pre></div>
</div>
<p>Or, to be extra thorough and allow for any type of regression family (logisitic! multinomial!) with any other types of covariates, we can find these manually with our own regression model fed through <code>marginaleffects::marginal_means()</code>. By specifying <code>cross = TRUE</code>, we get all combinations of military service and party (without it, we’d get separate marginal means for just the two levels of military and the two levels of party).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">party_mms_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_means</span>(</span>
<span id="cb42-2">  model_military_party,</span>
<span id="cb42-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>),</span>
<span id="cb42-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cross =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb42-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells"</span></span>
<span id="cb42-6">)</span>
<span id="cb42-7">party_mms_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb42-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 11</span></span>
<span id="cb42-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   rowid atmilitary    respondent_party estimate std.error statistic   p.value conf.low conf.high selected   wts</span></span>
<span id="cb42-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;int&gt; &lt;fct&gt;         &lt;fct&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb42-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1 Did Not Serve Democrat            0.551    0.0174      31.7 1.68e-220    0.517     0.585      0.5 0.231</span></span>
<span id="cb42-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     2 Did Not Serve Republican          0.378    0.0160      23.6 3.56e-123    0.347     0.410      0.5 0.271</span></span>
<span id="cb42-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     3 Served        Democrat            0.447    0.0177      25.3 3.11e-141    0.413     0.482      0.5 0.222</span></span>
<span id="cb42-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4     4 Served        Republican          0.619    0.0159      39.0 0            0.588     0.650      0.5 0.276</span></span></code></pre></div>
</div>
<p>To find the differences in those marginal means, we could pivot wider and subtract the <code>Democrat</code> column from the <code>Republican</code> column, or we can use the <code>hypothesis</code> argument in <code>marginal_means()</code> to have {marginaleffects} automatically calculate differences between categories for us without needing to pivot. If we were only concerned with one contrast, like Republican − Democrat, we could specify <code>hypothesis = "pairwise"</code> and it would subtract the two groups’ marginal means. However, we want two differences: Republican − Democrat in both the “served” and the “did not serve” levels. As seen above, <code>party_mms_mfx</code> has four rows in it. We want the differences between rows 2 and 1 (Republican − Democrat for “Did not serve”) and between rows 4 and 3 (Republican − Democrat for “Served”). We can control which rows are used when calculating differences with a vector of <a href="https://en.wikipedia.org/wiki/Linear_combination">linear combinations</a>. If we use a vector like <code>c(-1, 1, 0, 0)</code>, {marginaleffects} will essentially make the first row negative, leave the second row as is, and give no weight to (or ignore) the third and fourth row, which will calculate the difference between rows 2 and 1. Similarly, <code>c(0, 0, -1, 1)</code> will ignore rows 1 and 2 and find the difference between row 4 and 3. If we feed <code>marginal_means()</code> a matrix of these two vectors, with each vector as a column, it’ll find the differences for us:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">group_diffs_terms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb43-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb43-3">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb43-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb43-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-6">  magrittr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(candidate_fake<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>atmilitary))</span>
<span id="cb43-7">group_diffs_terms</span>
<span id="cb43-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      Did Not Serve Served</span></span>
<span id="cb43-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]            -1      0</span></span>
<span id="cb43-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,]             1      0</span></span>
<span id="cb43-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [3,]             0     -1</span></span>
<span id="cb43-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [4,]             0      1</span></span>
<span id="cb43-13"></span>
<span id="cb43-14">party_mms_mfx_diff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_means</span>(</span>
<span id="cb43-15">  model_military_party,</span>
<span id="cb43-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>),</span>
<span id="cb43-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cross =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb43-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells"</span>,</span>
<span id="cb43-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> group_diffs_terms</span>
<span id="cb43-20">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb43-22">party_mms_mfx_diff</span>
<span id="cb43-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb43-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term          estimate std.error statistic  p.value conf.low conf.high</span></span>
<span id="cb43-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb43-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve   -0.172    0.0236     -7.28 3.22e-13   -0.219    -0.126</span></span>
<span id="cb43-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Served           0.172    0.0238      7.22 5.23e-13    0.125     0.218</span></span></code></pre></div>
</div>
<p>We can plot these conditional marginal means along with the party-based differences:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Click to see all the plotting code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">mm_party_plot1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_mms_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb44-4">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()(estimate),</span>
<span id="cb44-5">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb44-6">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> atmilitary, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> respondent_party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(</span>
<span id="cb44-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> estimate_nice), </span>
<span id="cb44-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>),</span>
<span id="cb44-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb44-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> parties) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb44-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>,</span>
<span id="cb44-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb44-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb44-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means by respondent party"</span></span>
<span id="cb44-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb44-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb44-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb44-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb44-28">  )</span>
<span id="cb44-29"></span>
<span id="cb44-30">mm_party_plot2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_mms_mfx_diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_amce</span>(estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> term)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb44-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high, </span>
<span id="cb44-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb44-37">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(</span>
<span id="cb44-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> estimate_nice), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>,</span>
<span id="cb44-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span></span>
<span id="cb44-41">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb44-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means"</span>,</span>
<span id="cb44-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb44-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb44-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means by respondent party"</span>,</span>
<span id="cb44-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Positive differences = Republicans prefer the level"</span></span>
<span id="cb44-50">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb44-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb44-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb44-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb44-56">  )</span>
<span id="cb44-57"></span>
<span id="cb44-58">mm_party_plot1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> mm_party_plot2</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-mms-party-diffs-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>These marginal means have a direct descriptive interpretation. In the left panel above we can see that Democratic respondents tend to prefer candidates that haven’t served in the military (55%) to those that have (45%), but compared to Republican respondents, this divergence isn’t as dramatic. Republicans tend to strongly prefer candidates with a military history, with 62% expressing favorability. In general, Republicans are more extreme in their preferences for and against candidates with and without military service history.</p>
<p>In the right panel we can see the differences between the parties’ marginal means within each level. There’s a 17 percentage point distance between Republican and Democratic marginal means within the served level and a 17 percentage point distance between their marginal means in the did not serve level. Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</p>
</section>
</section>
</section>
<section id="finding-conjoint-amces-and-marginal-means-bayesianly" class="level1 page-columns page-full">
<h1>Finding conjoint AMCEs and marginal means Bayesianly</h1>
<p>Now that we know (1) what the AMCE actually is, and (2) that it works with logistic models, we can finally do it all Bayesianly with {brms}.</p>
<div class="page-columns page-full"><p>Why try to do this Bayesianly? <a href="https://www.andrewheiss.com/blog/2023/05/15/fancy-bayes-diffs-props/#why-bayesian-modeling">I don’t like null hypotheses and I don’t like flowcharts</a>.<sup>5</sup></p><div class="no-row-height column-margin column-container"><li id="fn5"><p><sup>5</sup>&nbsp;See <a href="https://www.youtube.com/watch?v=cclUd_HoRlo">this video by Richard McElreath introducing his idea of “statistical rethinking”</a></p></li></div></div>
<p>Rather than choose the <a href="https://www.google.com/search?q=statistical+test+flow+chart">exact statistical test in a flowchart</a>, I can compare the posterior distributions of AMCEs or marginal means directly. And rather than define a null hypothesis, I can find the probability that the estimand I care about is different from whatever other value I’m interested in.</p>
<p>But first, a note on the complexity of all this estimation and plotting thus far. In the “Finding conjoint AMCEs and marginal means frequentistly” section above, I spent a ton of extra time showing how to calculate and plot these estimands multiple ways:</p>
<ul>
<li>find the estimands with <code>cregg::amce()</code>, <code>cregg::mm()</code>, and <code>cregg::cj(..., estimate = "diff_mm")</code></li>
<li>find the estimands with {dplyr}’s <code>group_by() %&gt;% summarize()</code></li>
<li>find the estimands with OLS regression models like <code>lm()</code> and <code>survey::svyglm()</code> or with logistic models like <code>glm()</code> and <code>survey::svyglm()</code> which are then fed into <code>marginaleffects::avg_slopes()</code> and <code>marginaleffects::marginal_means()</code></li>
<li>plot the estimands automatically with <code>plot(cregg::amce(...))</code></li>
<li>tidy the estimands with reference levels with <code>broom.helpers::tidy_add_reference_rows()</code> and plot them manually</li>
<li>tidy the estimands with reference levels manually with some {tidyr} and {dplyr} magic and plot them manually</li>
</ul>
<p>We have <a href="https://www.youtube.com/watch?v=kf1bu5sUXaU">a veritable smorgasbord</a> of options!</p>
<p>I did this because I generally like thinking about averages as regressions and prefer to have total control over plotting instead of relying on convenience functions like <code>cregg::amce()</code>. If I were analyzing my own conjoint data in a frequentist way, I’d use regression + {marginaleffects} + manual tidying and plotting.</p>
<p>I also showed all these options becuase if we’re going to calculate these estimands in a Bayesian way, none of the convenience functions like <code>cregg::amce()</code> or <code>broom.helpers::tidy_add_reference_rows()</code> work with Bayesian models, so we have to use the manual approach anyway. And Bayesian models have their own extra dimension of complexity, so we might as well embrace it all. As Richard McElreath says,</p>
<blockquote class="blockquote">
<p>[A]s models become more monstrous, so too does the code needed to compute predictions and display them. <strong>With power comes hardship.</strong> <strong>It’s better to see the guts of the machine than to live in awe or fear of it.</strong> <span class="citation" data-cites="McElreath:2020">(McElreath 2020, 391)</span></p>
</blockquote>
<p>yay complexity.</p>
<section id="the-overall-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-overall-model">The overall model</h2>
<p>The easiest way for me to think about all these estimands is as moving parts (marginal effects or partial derivatives) in a regression model. We can model the whole data-generating system (i.e.&nbsp;all the candidate features and levels + any subgroups or covariates we’re interested in) and then look at individual parts of that system for the different estimands we’re interested in.</p>
<p>Each survey respondent saw multiple pairs of hypothetical candidates—some saw 4, some 5, some 6, and so on:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">candidate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(resID) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pairs_seen =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb45-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 311 × 3</span></span>
<span id="cb45-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    resID              n pairs_seen</span></span>
<span id="cb45-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;          &lt;int&gt;      &lt;dbl&gt;</span></span>
<span id="cb45-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 A10ZOUOZZ3EOAJ    12          6</span></span>
<span id="cb45-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 A11F3HMX0N23V4    10          5</span></span>
<span id="cb45-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 A12H2RTXSAQPRH     8          4</span></span>
<span id="cb45-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 A13DPXX91VQ49Q    12          6</span></span>
<span id="cb45-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 A13KTOZC30NBS6    10          5</span></span>
<span id="cb45-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 A142W1RAF1TBWP    12          6</span></span>
<span id="cb45-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 A15A4X84A1CJPF    12          6</span></span>
<span id="cb45-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 A15Q5F9YWO45EI    12          6</span></span>
<span id="cb45-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 A1610EPXM31F9D    12          6</span></span>
<span id="cb45-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 A1650FELH3UL2F    10          5</span></span>
<span id="cb45-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 301 more rows</span></span></code></pre></div>
</div>
<p>This means that we have a natural multilevel structure in our data. Individual candidate selection choices are nested inside respondents:</p>
<div class="cell" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/respondent-conjoint-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Multilevel conjoint data structure, with candidate choices <img src="https://latex.codecogs.com/png.latex?y"> nested in respondents</figcaption>
</figure>
</div>
</div>
</div>
<p>We want to model candidate selection (<code>selected</code>) based on candidate characteristics (and maybe individual respondent characteristics, if we had those). We’ll use the subscript <img src="https://latex.codecogs.com/png.latex?i"> to refer to individual candidate choices and <img src="https://latex.codecogs.com/png.latex?j"> to refer to respondents, which each contain multiple <img src="https://latex.codecogs.com/png.latex?i">s.</p>
<p>Since candidate selection <code>selected</code> is binary, we can model it as a Bernoulli process that has a probability <img src="https://latex.codecogs.com/png.latex?%5Cpi_%7Bi_j%7D"> of success. We’ll model that <img src="https://latex.codecogs.com/png.latex?%5Cpi_%7Bi_j%7D"> using a logistic regression model with covariates for each of the levels of each candidate feature. To account for respondent-level differences in probabilities, we’ll use respondent-specific offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">) from the global success rate, thus creating random intercepts. We’ll specify priors for each of the logit-scale coefficients/partial derivatives and the between respondent variability (<img src="https://latex.codecogs.com/png.latex?%5Csigma_0">). If we <em>really</em> wanted we could specify priors for each individual coefficient, but for simplicity we’ll just use a normal distribution with a mean of 0 and a standard deviation of 1 for all of them (<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#super-fancy-detailed-model-with-lots-of-moving-parts-just-for-fun">since logit-scale coefficients don’t ever get really big</a>). We’ll use an exponential prior for (<img src="https://latex.codecogs.com/png.latex?%5Csigma_0">) because we don’t know much about it.</p>
<p>Here’s what that all looks like more formally:</p>
<div class="column-screen-inset">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BSelection%7D_%7Bi_j%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBernoulli%7D(%5Cpi_%7Bi_j%7D)%20&amp;%20%5Ctext%7BProbability%20of%20selection%20for%20choice%7D_i%20%5Ctext%7B%20in%20respondent%7D_j%20%5C%5C%0A%5Coperatorname%7Blogit%7D(%5Cpi_%7Bi_j%7D)%20=&amp;%5C%20(%5Cbeta_0%20+%20b_%7B0_j%7D)%20+%20%5Cbeta_1%5C,%20%5Ctext%7BMilitary%5BServed%5D%7D_%7Bi_j%7D%20+%20&amp;%20%5Ctext%7BModel%20for%20probability%7D%5C%5C%0A&amp;%5C%20%5Cbeta_2%5C,%20%5Ctext%7BReligion%5BMormon%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cbeta_3%5C,%20%5Ctext%7BReligion%5BEvangelical%5D%7D_%7Bi_j%7D%20+%20%5C%5C%0A&amp;%5C%20%5Cdots%20+%5C%20%5C%5C%0A&amp;%5C%20%5Cbeta_n%5C,%20%5Ctext%7BSex%5BFemale%5D%7D_%7Bi_j%7D%20%5C%5C%0Ab_%7B0_j%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%20%5Csigma_0)%20&amp;%20%5Ctext%7BRespondent-specific%20offsets%20from%20global%20success%20rate%7D%20%5C%5C%0A%5C%5C%0A%5Cbeta_%7B0_c%7D%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%201)%20&amp;%20%5Ctext%7BPrior%20for%20global%20average%20success%20rate%7D%20%5C%5C%0A%5Cbeta_1%20%5Cdots%20%5Cbeta_n%20%5Csim&amp;%5C%20%5Cmathcal%7BN%7D(0,%201)%20&amp;%20%5Ctext%7BPrior%20for%20candidate%20feature%20levels%7D%20%5C%5C%0A%5Csigma_0%20%5Csim&amp;%5C%20%5Coperatorname%7BExponential%7D(1)%20&amp;%20%5Ctext%7BPrior%20for%20between-respondent%20variability%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>Let’s build the model!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">priors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb46-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> Intercept),</span>
<span id="cb46-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b),</span>
<span id="cb46-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd)</span>
<span id="cb46-5">)</span>
<span id="cb46-6"></span>
<span id="cb46-7">model_brms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb46-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atreligion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb46-9">    atprof <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atinc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atrace <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> atmale <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb46-10">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resID)),</span>
<span id="cb46-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate,</span>
<span id="cb46-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bernoulli</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb46-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> priors,</span>
<span id="cb46-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb46-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb46-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"candidate_model_brms"</span></span>
<span id="cb46-17">)</span></code></pre></div>
</div>
</section>
<section id="amces-1" class="level2">
<h2 class="anchored" data-anchor-id="amces-1">AMCEs</h2>
<p>If we’re interested in the causal effect of specific candidate levels, we need to find the average marginal component effect (AMCE). Here’s the formal definition of the no religion → Mormon AMCE, for example:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;P%20%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BReligion%7D%20=%20%5Ctext%7Bnone%7D)%5D%5C%20-%20%5C%5C%0A&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Coperatorname%7Bdo%7D(%5Ctext%7BReligion%7D%20=%20%5Ctext%7BMormon%7D)%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>We can find this AMCE (and all the other AMCEs) by calculating the marginal effect/partial derivative of each candidate-level covariate. <code>marginaleffects::avg_slopes()</code> makes this easy and gives us percentage-point-scale estimates instead of logit-scale estimates</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dealing with respondent offsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When plugging values into <code>avg_slopes</code> (or <code>predictions()</code> or <code>marginal_means()</code> or any function that calculates predictions from a model), we have to decide how to handle the random respondent offsets (<img src="https://latex.codecogs.com/png.latex?b_%7B0_j%7D">). <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary">I have a whole other blog post guide about this</a> and how absolutely maddening the nomenclature for all this is.</p>
<p>By default, <code>avg_slopes()</code> and friends will calculate the effects for a typical respondent, or a respondent where the random offset is set to 0. It invisibly uses the <code>re_formula = NA</code> argument to do this. This is also called a <em>conditional effect</em>.</p>
<p>We could also use <code>re_formula = NULL</code> to calculate the effect for respondents on average. This is also called a <em>marginal effect</em>. (ARGH I HATE THESE NAMES.). This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average respondent.</p>
<ul>
<li>Conditional effect = average respondent = <code>re_formula = NA</code> (default)</li>
<li>Marginal effect = respondents on average = <code>re_formula = NULL</code> + existing respondent levels or a new simulated respondent</li>
</ul>
<p>Again, <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects">see this guide for way more about these distinctions</a>. In this example here, we’ll just use conditional effects, or the effect for an average respondent.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">posterior_mfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_brms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>() </span>
<span id="cb47-4"></span>
<span id="cb47-5">posterior_mfx_nested <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb47-7">    contrast,</span>
<span id="cb47-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb47-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb47-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term, variable_level) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb47-13"></span>
<span id="cb47-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with model results</span></span>
<span id="cb47-15">plot_data_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_variable_levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb47-17">    posterior_mfx_nested,</span>
<span id="cb47-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level)</span>
<span id="cb47-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_if</span>(data, is.null, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">draw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb47-24"></span>
<span id="cb47-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data_bayes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb47-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb47-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb47-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb47-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior AMCEs"</span></span>
<span id="cb47-35">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/amce-mfx-bayes-plot-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The results here are all basically the same as what we found with all the frequentist approaches earlier, but now we have full posteriors for each of these AMCEs so we can do all sorts of neat Bayesian inference things, like calculating the probability that the effect is larger than zero. For instance, there’s a 100% posterior probability that the None → Mormon effect is negative. The Business owner → Lawyer effect, on the other hand, is generally negative, but sometimes positive—there’s a 78% posterior probability that it’s negative.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">example_amces <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mfx <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb48-3">    term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> contrast <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mormon - None"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb48-4">    term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atprof"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> contrast <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lawyer - Business owner"</span></span>
<span id="cb48-5">  )</span>
<span id="cb48-6"></span>
<span id="cb48-7">example_amces_p_direction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_amces <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop_lt_0 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(draw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb48-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()(prop_lt_0),</span>
<span id="cb48-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P(θ &lt; 0) = {prob_nice}"</span>)</span>
<span id="cb48-13">  )</span>
<span id="cb48-14"></span>
<span id="cb48-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(example_amces, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_ramp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">after_stat</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(</span>
<span id="cb48-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> example_amces_p_direction, </span>
<span id="cb48-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.21</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> label),</span>
<span id="cb48-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb48-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_ramp_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF851B"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb48-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>, </span>
<span id="cb48-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb48-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Two example AMCEs"</span></span>
<span id="cb48-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(contrast))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb48-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb48-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb48-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb48-35">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="marginal-means-2" class="level2">
<h2 class="anchored" data-anchor-id="marginal-means-2">Marginal means</h2>
<p>Instead of working with causal AMCEs, which are all relative to an omitted feature level, we can work with absolute marginal means to be more descriptive with our estimands. We could find the overall level of favorability of Mormon candidates…</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%20P(%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Mormon%7D)%0A"></p>
<p>…or the difference between Mormon and Catholic favorability…</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta%20=%5C%20&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Mormon%7D%5D%5C%20-%20%5C%5C%0A&amp;P%5B%5Ctext%7BCandidate%20selection%7D%20%5Cmid%20%5Ctext%7BReligion%20=%20Catholic%7D%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>Unfortunately <code>marginaleffects::marginal_means()</code> doesn’t work with brms models. BUT we can fake it by finding the posterior marginal means for each of the features individually and then combining them into one big data frame.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/calc-bayes-mms_97aa3325c164a84a45f00c8f971d0f5b">
<details>
<summary>Click to show the code. It’s hidden because it’s long and repetitive.</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># There's probably a more efficient way to do with with mapping or loops or</span></span>
<span id="cb49-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># whatever but I don't want to figure it out right now, so we brute force it</span></span>
<span id="cb49-3">posterior_mms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb49-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atmilitary =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-5">    model_brms,</span>
<span id="cb49-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>,</span>
<span id="cb49-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atmilitary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atreligion =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-10">    model_brms,</span>
<span id="cb49-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>,</span>
<span id="cb49-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atreligion) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ated =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-15">    model_brms,</span>
<span id="cb49-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ated"</span>,</span>
<span id="cb49-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> ated) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atprof =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-20">    model_brms,</span>
<span id="cb49-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atprof"</span>,</span>
<span id="cb49-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-23">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atprof) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atprof =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-25">    model_brms,</span>
<span id="cb49-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atprof"</span>,</span>
<span id="cb49-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-28">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atprof) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atinc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-30">    model_brms,</span>
<span id="cb49-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atinc"</span>,</span>
<span id="cb49-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atinc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atrace =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-35">    model_brms,</span>
<span id="cb49-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atrace"</span>,</span>
<span id="cb49-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-38">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atrace) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atage =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-40">    model_brms,</span>
<span id="cb49-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atage"</span>,</span>
<span id="cb49-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-43">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atage) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">atmale =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb49-45">    model_brms,</span>
<span id="cb49-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmale"</span>,</span>
<span id="cb49-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb49-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> atmale) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>(),</span>
<span id="cb49-49">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"term"</span></span>
<span id="cb49-50">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb49-52">posterior_mms</span>
<span id="cb49-53"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 184,000 × 7</span></span>
<span id="cb49-54"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    term       drawid  draw value         estimate conf.low conf.high</span></span>
<span id="cb49-55"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;      &lt;fct&gt;  &lt;dbl&gt; &lt;fct&gt;            &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb49-56"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 atmilitary 1      0.455 Did Not Serve    0.458    0.436     0.481</span></span>
<span id="cb49-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 atmilitary 1      0.546 Served           0.542    0.520     0.564</span></span>
<span id="cb49-58"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 atmilitary 2      0.459 Did Not Serve    0.458    0.436     0.481</span></span>
<span id="cb49-59"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 atmilitary 2      0.531 Served           0.542    0.520     0.564</span></span>
<span id="cb49-60"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 atmilitary 3      0.463 Did Not Serve    0.458    0.436     0.481</span></span>
<span id="cb49-61"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 atmilitary 3      0.543 Served           0.542    0.520     0.564</span></span>
<span id="cb49-62"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 atmilitary 4      0.450 Did Not Serve    0.458    0.436     0.481</span></span>
<span id="cb49-63"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 atmilitary 4      0.544 Served           0.542    0.520     0.564</span></span>
<span id="cb49-64"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 atmilitary 5      0.468 Did Not Serve    0.458    0.436     0.481</span></span>
<span id="cb49-65"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 atmilitary 5      0.554 Served           0.542    0.520     0.564</span></span>
<span id="cb49-66"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 183,990 more rows</span></span></code></pre></div>
</details>
</div>
<p>Here are the marginal means for all the levels of all candidate features:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1">plot_posterior_mms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb50-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb50-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(value, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.)))</span>
<span id="cb50-4">  </span>
<span id="cb50-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb50-6">  plot_posterior_mms,</span>
<span id="cb50-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> variable_nice)</span>
<span id="cb50-8">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the heights of the distributions equal within each facet</span></span>
<span id="cb50-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">facets =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_nice"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">space =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb50-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb50-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means of probabilities"</span>,</span>
<span id="cb50-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb50-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior marginal means"</span></span>
<span id="cb50-18">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/mm-mfx-bayes-plot-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>And here are the two we mentioned at the beginning of this section—overall favorability of Mormon candidates and the difference between Mormon and Catholic favorability. Mormon candidates have a median posterior favorability of 41.8%, with a 95% credible interval of 38–46%. The median posterior difference between Mormon and Catholic favorability is 10.8 percentage points, with a 95% credible interval of 5–16 percentage points. Neat.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">mms_mormon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mormon"</span>)</span>
<span id="cb51-3">mms_mormon <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(draw)</span>
<span id="cb51-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 6</span></span>
<span id="cb51-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    draw .lower .upper .width .point .interval</span></span>
<span id="cb51-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb51-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 0.418  0.381  0.456   0.95 median qi</span></span>
<span id="cb51-8"></span>
<span id="cb51-9">mms_mormon_catholic <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_mms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atreligion"</span>, value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mormon"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Catholic"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(drawid, draw, value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"draw"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diff =</span> Mormon <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Catholic)</span>
<span id="cb51-14">mms_mormon_catholic <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(diff)</span>
<span id="cb51-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 6</span></span>
<span id="cb51-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     diff .lower  .upper .width .point .interval</span></span>
<span id="cb51-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb51-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 -0.107 -0.160 -0.0537   0.95 median qi</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">mm1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mms_mormon, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF851B"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mormon favorability"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb52-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb52-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb52-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb52-10">  )</span>
<span id="cb52-11"></span>
<span id="cb52-12">mm2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mms_mormon_catholic, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> diff)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B10DC9"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference between Mormons and Catholics"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb52-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb52-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb52-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb52-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb52-21">  )</span>
<span id="cb52-22"></span>
<span id="cb52-23">mm1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> mm2</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/mm-mfx-bayes-plot-excerpt-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="subgroup-differences" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="subgroup-differences">Subgroup differences</h2>
<p>Finally, if we’re interested in subgroup differences, we can run a separate model with an interaction term for the subgroups we’re interested in. Again, this candidate experiment didn’t include any respondent-level covariates, so we’ll use the made-up, fake respondent political party that we used earlier.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">priors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb53-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> Intercept),</span>
<span id="cb53-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b),</span>
<span id="cb53-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sd)</span>
<span id="cb53-5">)</span>
<span id="cb53-6"></span>
<span id="cb53-7">model_brms_military_party <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb53-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> atmilitary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> respondent_party <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> resID)),</span>
<span id="cb53-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> candidate_fake,</span>
<span id="cb53-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bernoulli</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb53-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> priors,</span>
<span id="cb53-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb53-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">threading</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb53-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"candidate_model_brms_interaction"</span></span>
<span id="cb53-15">)</span></code></pre></div>
</div>
<section id="conditional-amces-1" class="level3">
<h3 class="anchored" data-anchor-id="conditional-amces-1">Conditional AMCEs</h3>
<p>We can calculate two different causal estimands, the conditional AMCE across each respondent political party of switching a candidate from having no military history to having served in the military. Because this model (1) uses logit-scale coefficients and (2) splits the causal effects across a bunch of different regression terms, we’ll use <code>marginaleffects::avg_slopes()</code> to find the group-specific probability-scale marginal effects.</p>
<p>Among Republican respondents, the causal effect of a candidate switching from no military history to having military service history has a posterior median of 23.8 percentage points, with a 95% credible interval of 19–28 percentage points. For Democrats, the same causal effect is negative, with a posterior median of −9.8 percentage points and a 95% credible interval of −5 to −14.7 percentage points.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">posterior_party_amces <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_brms_military_party <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_slopes</span>(</span>
<span id="cb54-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>,</span>
<span id="cb54-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>,</span>
<span id="cb54-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>,</span>
<span id="cb54-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb54-7">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posteriordraws</span>()</span>
<span id="cb54-9"></span>
<span id="cb54-10">posterior_party_amces <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(respondent_party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(draw)</span>
<span id="cb54-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb54-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   respondent_party    draw .lower  .upper .width .point .interval</span></span>
<span id="cb54-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;              &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb54-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Democrat         -0.0982 -0.148 -0.0481   0.95 median qi       </span></span>
<span id="cb54-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Republican        0.238   0.194  0.279    0.95 median qi</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Click to show the code since it’s so long</summary>
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1">posterior_party_amces_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior_party_amces <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb55-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The contrast column contains values like this:</span></span>
<span id="cb55-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   mean(Served) - mean(Did Not Serve)</span></span>
<span id="cb55-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span id="cb55-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># just brute force it and remove "mean(" and ")" with two separate</span></span>
<span id="cb55-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># str_remove()s</span></span>
<span id="cb55-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb55-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(contrast, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">("</span>),</span>
<span id="cb55-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contrast =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(contrast, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb55-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_wider_delim</span>(</span>
<span id="cb55-12">    contrast,</span>
<span id="cb55-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" - "</span>, </span>
<span id="cb55-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable_level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_level"</span>)</span>
<span id="cb55-15">  )</span>
<span id="cb55-16"></span>
<span id="cb55-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb55-18">plot_posterior_party_amces <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand_grid</span>(</span>
<span id="cb55-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">respondent_party =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(candidate_fake<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>respondent_party),</span>
<span id="cb55-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(model_variable_levels, variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>)</span>
<span id="cb55-21">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb55-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb55-23">    posterior_party_amces_wide,</span>
<span id="cb55-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> term, levels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> variable_level, respondent_party)</span>
<span id="cb55-25">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb55-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make these zero</span></span>
<span id="cb55-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb55-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb55-29">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(draw, estimate),</span>
<span id="cb55-30">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .x)</span>
<span id="cb55-31">    )</span>
<span id="cb55-32">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(variable_lookup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(levels, variable_nice), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(.))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb55-36">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_amce</span>(estimate),</span>
<span id="cb55-37">    estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb55-38">  ))</span>
<span id="cb55-39"></span>
<span id="cb55-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb55-41">  plot_posterior_party_amces, </span>
<span id="cb55-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> levels, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> respondent_party, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> respondent_party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(</span>
<span id="cb55-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> parties,</span>
<span id="cb55-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb55-49">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> parties),</span>
<span id="cb55-50">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb55-51">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(</span>
<span id="cb55-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(parties, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>), </span>
<span id="cb55-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb55-55">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb55-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point change in probability of candidate selection"</span>,</span>
<span id="cb55-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb55-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb55-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior AMCEs by respondent party"</span></span>
<span id="cb55-61">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(variable_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-63">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb55-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb55-65">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb55-66">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb55-67">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-posterior-party-amce-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conditional-marginal-means-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="conditional-marginal-means-1">Conditional marginal means</h3>
<p>And finally, we can calculate subgroup conditional marginal means to describe general party-based trends (since the relative conditional AMCEs create an illusion of difference). Again, since <code>marginaleffects::marginal_means()</code> doesn’t work with brms models, we can instead use <code>marginaleffects::predictions()</code>, which still works with the neat <code>hypothesis</code> argument for calculating contrasts.</p>
<p>In the left panel below, Democratic respondents prefer candidates that haven’t served in the military (55% median posterior; 95% credible interval: 51–58%) to those that have (45% median posterior; 95% credible interval: 41–48%). Republicans strongly prefer candidates with a military history, with a posterior median 62% expressing favorability (95% credible interval: 59–65%). In general, Republicans are more extreme in their preferences for and against candidates with and without military service history.</p>
<p>In the right panel we can see the differences between the parties’ marginal means within each level. There’s a posterior median 17 percentage point distance between Republican and Democratic marginal means within the served level and a posterior median 17 percentage point distance between their marginal means in the did not serve level (95% credible interval: 12–21 percentage points). Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1">posterior_party_mms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb56-2">  model_brms_military_party,</span>
<span id="cb56-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>),</span>
<span id="cb56-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb56-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>()</span>
<span id="cb56-7"></span>
<span id="cb56-8">posterior_party_mms <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(atmilitary, respondent_party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(draw)</span>
<span id="cb56-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 8</span></span>
<span id="cb56-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   atmilitary    respondent_party  draw .lower .upper .width .point .interval</span></span>
<span id="cb56-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb56-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve Democrat         0.548  0.513  0.582   0.95 median qi       </span></span>
<span id="cb56-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Did Not Serve Republican       0.380  0.351  0.412   0.95 median qi       </span></span>
<span id="cb56-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Served        Democrat         0.450  0.415  0.485   0.95 median qi       </span></span>
<span id="cb56-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 Served        Republican       0.618  0.587  0.648   0.95 median qi</span></span>
<span id="cb56-18"></span>
<span id="cb56-19">group_diffs_terms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb56-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb56-21">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb56-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb56-23">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-24">  magrittr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(candidate_fake<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>atmilitary))</span>
<span id="cb56-25"></span>
<span id="cb56-26">posterior_party_mms_diff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predictions</span>(</span>
<span id="cb56-27">  model_brms_military_party,</span>
<span id="cb56-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"atmilitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"respondent_party"</span>),</span>
<span id="cb56-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">allow_new_levels =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb56-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypothesis =</span> group_diffs_terms</span>
<span id="cb56-31">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_draws</span>()</span>
<span id="cb56-33"></span>
<span id="cb56-34">posterior_party_mms_diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(term) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(draw)</span>
<span id="cb56-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb56-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   term            draw .lower .upper .width .point .interval</span></span>
<span id="cb56-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb56-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Did Not Serve -0.167 -0.213 -0.121   0.95 median qi       </span></span>
<span id="cb56-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Served         0.168  0.120  0.215   0.95 median qi</span></span></code></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Click to show the code since it’s so long</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">mm_posterior_party1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb57-2">  posterior_party_mms, </span>
<span id="cb57-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> atmilitary, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> respondent_party, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> respondent_party)</span>
<span id="cb57-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(</span>
<span id="cb57-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> parties,</span>
<span id="cb57-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb57-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> parties),</span>
<span id="cb57-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb57-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(</span>
<span id="cb57-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(parties, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>), </span>
<span id="cb57-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb57-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb57-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal means"</span>,</span>
<span id="cb57-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb57-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb57-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior marginal means by respondent party"</span></span>
<span id="cb57-23">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb57-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb57-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb57-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb57-29">  )</span>
<span id="cb57-30"></span>
<span id="cb57-31">mm_posterior_party2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(</span>
<span id="cb57-32">  posterior_party_mms_diff,</span>
<span id="cb57-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> draw, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> term)</span>
<span id="cb57-34">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb57-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican marginal mean − Democrat marginal mean"</span>,</span>
<span id="cb57-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb57-39">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(</span>
<span id="cb57-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span>,</span>
<span id="cb57-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(</span>
<span id="cb57-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span>),</span>
<span id="cb57-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keywidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keyheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb57-46">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(</span>
<span id="cb57-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#85144b"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>), </span>
<span id="cb57-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb57-50">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb57-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means"</span>,</span>
<span id="cb57-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb57-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb57-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in marginal means by respondent party"</span>,</span>
<span id="cb57-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Positive differences = Republicans prefer the level"</span></span>
<span id="cb57-57">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Military"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb57-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb57-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb57-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">l =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb57-63">  )</span>
<span id="cb57-64"></span>
<span id="cb57-65">mm_posterior_party1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> mm_posterior_party2</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/plot-posterior-mms-party-diffs-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


<!-- -->


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ChaudhryDotsonHeiss:2021" class="csl-entry">
Chaudhry, Suparna, Marc Dotson, and Andrew Heiss. 2021. <span>“Who Cares about Crackdowns? Exploring the Role of Trust in Individual Philanthropy.”</span> <em>Global Policy</em> 12 (S5): 45–58. <a href="https://doi.org/10.1111/1758-5899.12984">https://doi.org/10.1111/1758-5899.12984</a>.
</div>
<div id="ref-HainmuellerHopkinsYamamoto:2014" class="csl-entry">
Hainmueller, Jens, Daniel J. Hopkins, and Teppei Yamamoto. 2014. <span>“Causal Inference in Conjoint Analysis: Understanding Multidimensional Choices via Stated Preference Experiments.”</span> <em>Political Analysis</em> 22 (1): 1–30. <a href="https://doi.org/10.1093/pan/mpt024">https://doi.org/10.1093/pan/mpt024</a>.
</div>
<div id="ref-LeeperHoboltTilley:2020" class="csl-entry">
Leeper, Thomas J., Sara B. Hobolt, and James Tilley. 2020. <span>“Measuring Subgroup Preferences in Conjoint Experiments.”</span> <em>Political Analysis</em> 28 (2): 207–21. <a href="https://doi.org/10.1017/pan.2019.30">https://doi.org/10.1017/pan.2019.30</a>.
</div>
<div id="ref-McBrideRogersErekson:2020" class="csl-entry">
McBride, Spencer W., Brent M. Rogers, and Keith A. Erekson, eds. 2020. <em>Contingent Citizens: Shifting Perceptions of Latter-Day Saints in American Political Culture</em>. Ithaca, New York: Cornell University Press. <a href="https://doi.org/10.1515/9781501716744">https://doi.org/10.1515/9781501716744</a>.
</div>
<div id="ref-McElreath:2020" class="csl-entry">
McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. 2nd ed. Boca Raton, Florida: Chapman and Hall / CRC.
</div>
<div id="ref-Reeve:2015" class="csl-entry">
Reeve, W. Paul. 2015. <em>Religion of a Different Color: Race and the Mormon Struggle for Whiteness</em>. Oxford: Oxford University Press. <a href="https://doi.org/10.1093/acprof:oso/9780199754076.001.0001">https://doi.org/10.1093/acprof:oso/9780199754076.001.0001</a>.
</div>
<div id="ref-TeeleKallaRosenbluth:2018" class="csl-entry">
Teele, Dawn Langan, Joshua Kalla, and Frances Rosenbluth. 2018. <span>“The Ties That Double Bind: Social Roles and Women’s Underrepresentation in Politics.”</span> <em>American Political Science Review</em> 112 (3): 525–41. <a href="https://doi.org/10.1017/S0003055418000217">https://doi.org/10.1017/S0003055418000217</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {The Ultimate Practical Guide to Conjoint Analysis with {R}},
  date = {2023-07-25},
  url = {https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide},
  doi = {10.59350/xgwjy-dyj66},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“The Ultimate Practical Guide to Conjoint
Analysis with R.”</span> July 25, 2023. <a href="https://doi.org/10.59350/xgwjy-dyj66">https://doi.org/10.59350/xgwjy-dyj66</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>statistics</category>
  <category>brms</category>
  <category>stan</category>
  <guid>https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index.html</guid>
  <pubDate>Mon, 24 Jul 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>Road trip analysis! How to use and play with Google Location History in R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index.html</link>
  <description><![CDATA[ 




<p>As I explained <a href="https://www.andrewheiss.com/blog/2023/06/01/geocoding-routing-openstreetmap-r/">in my previous blog post</a>, in June 2023 I drove my family across the country in a 5,000-mile roundtrip odyssey from Atlanta, Georgia to just-south-of-Salt Lake City, Utah, and back again. Instead of taking a direct path through the middle the United States, we decided to hit as many tourist-y stops along the way, making a big circle along the southern US on the way out and along the northern US on the way back, stopping at a dozen really neat places, including:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/French_Quarter">The French Quarter</a> in New Orleans, Louisiana</li>
<li><a href="https://en.wikipedia.org/wiki/Alamo_Mission">The Alamo</a> in San Antonio, Texas</li>
<li><a href="https://en.wikipedia.org/wiki/Carlsbad_Caverns_National_Park">Carlsbad Caverns National Park</a> in New Mexico</li>
<li><a href="https://en.wikipedia.org/wiki/Grand_Canyon">Grand Canyon National Park</a> in Arizona</li>
<li><a href="https://en.wikipedia.org/wiki/Capitol_Reef_National_Park">Capitol Reef National Park</a> in southern Utah (staying at <a href="https://www.heissatopia.com/search?q=Grover">my aunt’s cabin</a> in Grover, Utah)</li>
<li><a href="https://en.wikipedia.org/wiki/Goblin_Valley_State_Park">Goblin Valley</a> in southern Utah</li>
<li><a href="https://en.wikipedia.org/wiki/Yellowstone_National_Park">Yellowstone National Park</a> in Wyoming</li>
<li><a href="https://en.wikipedia.org/wiki/Devils_Tower">Devil’s Tower National Monument</a> in Wyoming</li>
<li><a href="https://en.wikipedia.org/wiki/Mount_Rushmore">Mount Rushmore National Memorial</a> in South Dakota</li>
<li><a href="https://en.wikipedia.org/wiki/Nauvoo,_Illinois">Nauvoo, Illinois</a> and other <a href="https://www.churchofjesuschrist.org/learn/locations/historic-nauvoo">LDS history</a> locations like the <a href="https://en.wikipedia.org/wiki/Smith_Family_Cemetery">Smith Family Cemetery</a>, <a href="https://en.wikipedia.org/wiki/Winter_Quarters_(North_Omaha,_Nebraska)">Winter Quarters</a>, and <a href="https://en.wikipedia.org/wiki/Carthage_Jail">Carthage Jail</a></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pictures!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Check out the <a href="https://www.heissatopia.com/search/label/%23Roadtrip2023">#Roadtrip2023 tag on our blog</a> for photos and details of all these places.</p>
</div>
</div>
<p>In an effort to stay On Brand™, I wanted to keep a log of all our stops so I could go back and analyze the trip. How many miles would we drive? How much time would we spend in the car? How long would each gas stop and bathroom break be? Could I make some sort of map showing our journey?</p>
<p>So, at the first gas station we stopped at in Alabama, I started a new file in my phone’s Notes app and dutifully wrote down the arrival time, name and address of the gas station, and departure time. I had a nascent data file and was ready to use it through the trip.</p>
<p>About an hour after leaving our second gas station stop just outside Mississippi, I realized that I forgot to write down anything about the second gas station stop. My data collection process died after a single entry.</p>
<p>I was initially disappointed that I wouldn’t have any sort of data to work with at the end of the trip, but then I remembered that my phone was tracking every part of the whole trip through Google Maps. When we got to the first hotel, I searched Google to see if it was possible to export your location history from Google Maps and saw that it was, so I gave up on trying to keep my own log and outsourced all that to Google instead. I didn’t know what exactly Google was tracking, but I figured it would at least have the date, time, and location of where we went, so that was good enough.</p>
<p>Right after we got home from our trip last week, I exported my data and was shocked by how much detail Google actually had. The exported JSON files contained 100,000+ location entries going all the back to 2013 (!!!). Parsing and sifting through and working with all this data initially seemed overwhelming (especially since Google doesn’t actually provide any formal documentation for these files!), but once I worked through a few tricky issues, it was surprisingly straightforward to make maps, calculate distances and times, and do all sorts of other fun things with the data.</p>
<p>So in this post I do three things:</p>
<ol type="1">
<li>Give a basic overview of what exactly Google tracks in your Location History and how they store it across dozens of JSON files</li>
<li>Show how to load, process, and clean this data using R</li>
<li>Create some neat plots and tables with details from our mega summer road trip around the US</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re somewhat familiar with <a href="https://r-spatial.github.io/sf/">{sf}</a> for working with geographic data. I have a <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html">whole tutorial here</a> and a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles">simplified one here</a> and the <a href="https://r-spatial.github.io/sf/">{sf} documentation has a ton of helpful vignettes and blog posts</a>, and there are also two free books about it: <a href="https://r-spatial.org/book/"><em>Spatial Data Science</em></a> and <a href="https://r.geocompx.org/"><em>Geocomputation with R</em></a>. Also <a href="https://www.jessesadler.com/post/simple-feature-objects/">check this fantastic post out</a> to learn more about the anatomy of a <code>geometry</code> column with {sf}.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Follow along!
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to follow along with this post, I’ve created mostly-anonymized excerpts of the main JSON files for the first four days of this road trip that you can download:</p>
<ul>
<li><a href="data.zip"><i class="fa-solid fa-file-zipper" aria-label="file-zipper"></i> <code>data.zip</code></a></li>
</ul>
</div>
</div>
<section id="packages-and-functions" class="level1">
<h1>Packages and functions</h1>
<p>Before officially getting started, let’s load all the packages we need and create some helpful functions and variables:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jsonlite)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read JSON files</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Handle spatial data in a tidy way</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tigris)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Access deographic data from the US Census</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer non-overlapping labels</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Easier string interpolation</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine plots nicely</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggspatial)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer map features like scale bars</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(leaflet)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make interactive maps</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lutz)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look up time zones for lat/lon coordinates</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make fancy tables</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rcartocolor)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use CARTO colors (https://carto.com/carto-colors/)</span></span>
<span id="cb1-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggnewscale)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use multiple scales for the same aesthetic in ggplot</span></span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot themes to make pretty plots</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://fonts.google.com/specimen/Overpass</span></span>
<span id="cb1-18">theme_roadtrip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Medium"</span>),</span>
<span id="cb1-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-24">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb1-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(</span>
<span id="cb1-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>,</span>
<span id="cb1-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb1-29">}</span>
<span id="cb1-30"></span>
<span id="cb1-31">theme_roadtrip_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-33">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb1-34">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb1-35">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(</span>
<span id="cb1-36">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>,</span>
<span id="cb1-37">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-38">    )</span>
<span id="cb1-39">}</span>
<span id="cb1-40"></span>
<span id="cb1-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make labels use Overpass by default</span></span>
<span id="cb1-42"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label_repel"</span>, </span>
<span id="cb1-43">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-44">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-45"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, </span>
<span id="cb1-46">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-47">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-48"></span>
<span id="cb1-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_repel"</span>, </span>
<span id="cb1-50">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-51">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, </span>
<span id="cb1-53">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-54">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-55"></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CARTO Prism palette</span></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://carto.com/carto-colors/</span></span>
<span id="cb1-58">clrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rcartocolor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">carto_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prism"</span>)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">states</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20m"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cb =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-2"></span>
<span id="cb2-3">lower_48 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alaska"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hawaii"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Puerto Rico"</span>)))</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>A bunch of helper functions that I’ve hidden because this chunk is long</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Format difftime in minutes and hours</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' This function takes a difftime input \code{x} and formats the result as a </span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' string indicating the number of hours and minutes in the duration.</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param x A difftime input.</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @return A character vector of formatted duration strings.</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @examples</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' x &lt;- as.difftime(c(93, 1007, 3056), units = "secs")</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' fmt_duration(x)</span></span>
<span id="cb3-11">fmt_difftime <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-12">  n_seconds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.double</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"secs"</span>))</span>
<span id="cb3-13">  n_seconds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds_to_period</span>(n_seconds)</span>
<span id="cb3-14">  </span>
<span id="cb3-15">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(n_seconds, \(n) {</span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3600</span>) {</span>
<span id="cb3-17">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If this is less than an hour, don't format anything with hours</span></span>
<span id="cb3-18">      glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{MM} minutes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MM =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minute</span>(n))</span>
<span id="cb3-19">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb3-20">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I only want to format this as a number of hours. If the duration is</span></span>
<span id="cb3-21">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># longer than 24 hours, seconds_to_period() rolls over into days (i.e.</span></span>
<span id="cb3-22">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># seconds_to_period(60 * 60 * 24) returns "1d 0H 0M 0S"), and it shows</span></span>
<span id="cb3-23">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># zero hours. So we extract the day part of the period, multiply it by 24,</span></span>
<span id="cb3-24">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and add it to the hour component that we want to display</span></span>
<span id="cb3-25">      extra_day_hours <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb3-26">      </span>
<span id="cb3-27">      glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{HH} hour{s} {MM} minutes"</span>,</span>
<span id="cb3-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">HH =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>()(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> extra_day_hours),</span>
<span id="cb3-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MM =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minute</span>(n),</span>
<span id="cb3-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s"</span>)</span>
<span id="cb3-31">      )</span>
<span id="cb3-32">    }</span>
<span id="cb3-33">  })</span>
<span id="cb3-34">  </span>
<span id="cb3-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb3-36">}</span>
<span id="cb3-37"></span>
<span id="cb3-38">fmt_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" miles"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">big.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)</span>
<span id="cb3-39"></span>
<span id="cb3-40">miles_to_meters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-41">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb3-42">}</span>
<span id="cb3-43"></span>
<span id="cb3-44">meters_to_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-45">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb3-46">}</span>
<span id="cb3-47"></span>
<span id="cb3-48">meters_to_feet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-49">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.28084</span></span>
<span id="cb3-50">}</span>
<span id="cb3-51"></span>
<span id="cb3-52">km_to_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_miles</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb3-54">}</span></code></pre></div>
</details>
</div>
</section>
<section id="anatomy-of-google-takeout-location-history-data" class="level1 page-columns page-full">
<h1>Anatomy of Google Takeout Location History data</h1>
<p>You can use <a href="https://takeout.google.com/">Google Takeout</a> to export your personal location history if you have it enabled in Google Maps, which you probably do—it’s the default. (Though after looking at this post you might be tempted to disable it—it’s surprising to see how much fine-grained data Google has about your location over time!)</p>
<p>Go to <a href="https://takeout.google.com/">Google Takeout</a> and create a new export. You can select data from any number of Google’s different services, but here we only want Location History, so scroll all the way down to it, check its box, and then select “Next Step”:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/google-takeout.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Location History in Google Takeout</figcaption>
</figure>
</div>
<p>Tell it to e-mail you a link to a one-time .zip export and then wait a couple minutes to get the link. Download it, unzip it, and you’re ready to go!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/google-takeout-options.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Location History export options in Google Takeout</figcaption>
</figure>
</div>
<p>Your Location History data includes a bunch of JSON files:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb4-1">.</span>
<span id="cb4-2">├── Settings.json</span>
<span id="cb4-3">├── Records.json</span>
<span id="cb4-4">└── Semantic Location History</span>
<span id="cb4-5">    ├── 2013</span>
<span id="cb4-6">    ├── ...</span>
<span id="cb4-7">    ├── 2022</span>
<span id="cb4-8">    │   ├── 2022_APRIL.json</span>
<span id="cb4-9">    │   ├── ...</span>
<span id="cb4-10">    │   └── ...</span>
<span id="cb4-11">    └── 2023</span>
<span id="cb4-12">        ├── 2023_APRIL.json</span>
<span id="cb4-13">        ├── ...</span>
<span id="cb4-14">        └── ...</span></code></pre></div>
<p>For whatever reason, Google doesn’t provide any documentation for these files and their contents! Lots of the data and JSON entries are self-explanatory and fairly straightforward, but lots are not!. Fortunately <a href="https://locationhistoryformat.com/">this community project for the Location History Format</a> provides excellent definitions, documentation, and JSON schemas for all these JSON files.</p>
<p>Before loading these files into R and playing with them, understanding what’s in them is useful, so let’s take a quick tour.</p>
<section id="settings" class="level2">
<h2 class="anchored" data-anchor-id="settings">Settings</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Complete documentation for <code>Settings.json</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://locationhistoryformat.com/reference/settings/">Full documentation</a></li>
</ul>
</div>
</div>
<p><code>Settings.json</code> is a small file that contains a bunch of device-specific settings and details, like the unique ID for your phone, the date and time when you added your phone to your account, and so on. It’s not super important for working with your data—consider it extra metadata.</p>
</section>
<section id="records" class="level2">
<h2 class="anchored" data-anchor-id="records">Records</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Complete documentation for <code>Records.json</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://locationhistoryformat.com/guides/raw-location/">Basic overview</a></li>
<li><a href="https://locationhistoryformat.com/reference/records/">Full documentation</a></li>
</ul>
</div>
</div>
<p><code>Records.json</code> <em>is</em> important. This contains an entry for every time Google Maps recorded your location somewhere. Here’s what a typical entry looks like (each entry is nested under a <code>"locations"</code> property):</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"locations"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"latitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300489450</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"longitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-899629451</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"accuracy"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"velocity"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"heading"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">329</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"altitude"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"verticalAccuracy"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"deviceTag"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"platformType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IOS"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"serverTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-04T01:05:58.248Z"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"deviceTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-04T01:05:57.559Z"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"batteryCharging"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"formFactor"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PHONE"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"timestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-04T00:52:57Z"</span></span>
<span id="cb5-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>Location details like <code>latitudeE7</code> and <code>longitudeE7</code>, multiplied by 10,000,000 so there are no decimals</li>
<li>Accuracy details like <code>accuracy</code>, or radius of the location measurement, in meters. Smaller numbers mean better precision.</li>
<li>Position details like <code>heading</code> (degrees east of north, from 0 to 359), <code>velocity</code> (meters per second), <code>altitude</code> (meters), and <code>verticalAccuracy</code> (accuracy of altitude in meters; smaller means better precision)</li>
<li>Device details like <code>deviceTag</code> (Google’s internal ID for your device; I changed mine to 0 in this post for privacy reasons), <code>platformType</code> and <code>formFactor</code> (type of device), <code>batteryCharging</code> (whether your device was charging at the time), and some timestamps for the device time, server time, and UTC time.</li>
</ul>
<p>This is pretty straightforward to work with, since it’s essentially rectangular data, or data that can be thought of as rows and columns. Each location entry in the JSON file is a row; each property is a column (<code>accuracy</code> is 9, <code>altitude</code> is 1, and so on), like this:</p>
<table class="table">
<caption>Example dataset from Google Location History JSON</caption>
<colgroup>
<col style="width: 9%">
<col style="width: 16%">
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 16%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>rowid</th>
<th>latitudeE7</th>
<th>longitudeE7</th>
<th>…</th>
<th>formFactor</th>
<th>timestamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>54383</td>
<td>300489450</td>
<td>-899629451</td>
<td>…</td>
<td>PHONE</td>
<td>2023-06-04T00:52:57Z</td>
</tr>
<tr class="even">
<td>54384</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>The only data manipulation we need to do is modify the latitude and longitude columns. Both of those have been multiplied by 10,000,000 so that there are no decimal points in the coordinates (probably to avoid <a href="https://floating-point-gui.de/basic/">the weirdness inherent in floating point math</a>). There’s actually a hint about this in the column names for <code>latitudeE7</code> and <code>longitudeE7</code>—in R and most other programming languages, <code>1e7</code> is computer notation for <img src="https://latex.codecogs.com/png.latex?10%5E7">. If we divide both those columns by 10,000,000, we’ll get standard-looking geographic coordinates:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300489450</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000000</span></span>
<span id="cb6-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 30.05</span></span>
<span id="cb6-3"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">899629451</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We can write it as 1e7 too</span></span>
<span id="cb6-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] -89.96</span></span></code></pre></div>
</div>
<p>For the sake of this post, the most important pieces of data here will be location (<code>latitudeE7</code> and <code>longitudeE7</code>), time (<code>timestamp</code>), and elevation (<code>altitude</code>). The velocity data might be cool to do something with some day, but I won’t touch it for now.</p>
</section>
<section id="semantic-location-history" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="semantic-location-history">Semantic location history</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Complete documentation for semantic location history files
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://locationhistoryformat.com/guides/semantic-location/">Basic overview</a></li>
<li><a href="https://locationhistoryformat.com/reference/semantic/">Full documentation</a></li>
</ul>
</div>
</div>
<p>These month-specific JSON files are super neat and full of really rich data. Each entry is one of two types of events: activity segments (<code>activitySegment</code>) and place visits (<code>placeVisit</code>).</p>
<p>Here’s what the beginning of a typical activity segment entry looks like (with a <em>lot</em> of parts omitted for space—<a href="data/example-activitySegment.json">click here for a complete example entry</a>):</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"timelineObjects"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb7-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"activitySegment"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"startLocation"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-6">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"latitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">339703585</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-7">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"longitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-842416959</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-8">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sourceInfo"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-9">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"deviceTag"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-10">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-11">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb7-12">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"endLocation"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-13">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"latitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">339786509</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-14">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"longitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-842006268</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-15">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sourceInfo"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"deviceTag"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-17">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-18">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb7-19">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"duration"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-20">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"startTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01T00:15:26.999Z"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-21">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"endTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01T00:28:47Z"</span></span>
<span id="cb7-22">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb7-23">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"distance"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5483</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-24">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"activityType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IN_PASSENGER_VEHICLE"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-25">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"confidence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HIGH"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-26">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"activities"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb7-27">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-28">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"activityType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IN_PASSENGER_VEHICLE"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"probability"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.4052665233612</span></span>
<span id="cb7-30">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-31">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"activityType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"STILL"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"probability"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.64205327630043</span></span>
<span id="cb7-34">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-35">          <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb7-36">        <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-37">        <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb7-38">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-40">  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>And here’s the beginning typical place visit entry (<a href="data/example-placeVisit.json">click here for a complete example entry</a>)</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"timelineObjects"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb8-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"placeVisit"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"location"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-6">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"latitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">323281024</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-7">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"longitudeE7"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-863373283</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-8">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"placeId"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJQ0NgzsqAjogRISqopW4DZMc"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-9">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"address"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1030 W South Blvd, Montgomery, AL 36105, USA"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-10">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chevron"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-11">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sourceInfo"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-12">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"deviceTag"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-13">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb8-14">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"locationConfidence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">89.41639</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-15">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"calibratedProbability"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.56358</span></span>
<span id="cb8-16">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb8-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"duration"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-18">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"startTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-03T14:27:23.001Z"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-19">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"endTimestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-03T14:50:24Z"</span></span>
<span id="cb8-20">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb8-21">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"placeConfidence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MEDIUM_CONFIDENCE"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-22">        <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb8-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-25">  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Working with these gnarly JSON files is a lot trickier than working with <code>Records.json</code> because all this data is deeply nested within specific properties of the activity or place visit.</p>
<p>To help visualize all this nesting, here’s what a single <code>placeVisit</code> entry looks like (screenshot via <a href="https://akhiljay.github.io/JSON-tree-visualizer/">this JSON tree visualizer</a>), with the visit details + alternative places + child visits and <em>their</em> alternative locations and confidence levels + lots of other details:</p>
<div class="column-screen-inset-right">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/json-tree.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">JSON tree for one <code>placeVisit</code> entry</figcaption>
</figure>
</div>
</div>
<p>Yikes.</p>
<p>For this post, I don’t care about all the alternative possible locations or possible modes of transportation or confidence levels or anything. I cleaned those up in my <a href="https://timeline.google.com/">Google Timeline</a> before exporting the data, so I’m pretty confident everything is relatively correct.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More on cleaning up your Google Timeline
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Google actually has a really nice web-based frontend for your whole location history at <a href="https://timeline.google.com">Google Timeline</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/google-timeline.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">My Google Timeline from June 4, 2023</figcaption>
</figure>
</div>
<p>Before downloading my location data from this road trip, I checked my history for each day at Google Timeline to confirm that it was marking the right trips locations. It generally did a good job, but when an entry has lower confidence (the <code>confidence</code> entry in the JSON data), Google shows you its uncertainty. For instance, here it’s not sure about two stops:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/timeline-confirm-location.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Google’s uncertainty about two locations</figcaption>
</figure>
</div>
<p>Those are both correct, so I clicked on the check to confirm.</p>
<p>Other times, it gets things wrong. Like here, it thought I was on a motorcycle for this leg of the trip:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/timeline-motorcycle.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Google’s incorrect guess that I was motorcycling instead of driving</figcaption>
</figure>
</div>
<p>That’s obviously not correct, so I edited it to be “Driving” instead:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/timeline-fixed.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Switching motorcylcing to driving</figcaption>
</figure>
</div>
<p>And other times, when cell reception is bad, it misses entire activities. Like here, where we went to <a href="https://www.nps.gov/deto/index.htm">Devil’s Tower</a> where there’s no cell reception at all, Google saw that we left the hotel at 8:14 AM and somehow magically arrived at Devil’s Tower at 9:21 AM. It failed to record how we did it, so I clicked on “Add activity” and told Google I was driving.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/img/timeline-missing-activity.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Missing activity</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Here’s all I’ll worry about here:</p>
<p><strong>For <code>placeVisit</code>s:</strong></p>
<ul>
<li>Location coordinates (<code>location</code> → <code>latitudeE7</code> and <code>location</code> → <code>longitudeE7</code>)</li>
<li>Location ID (<code>location</code> → <code>placeId</code>): Google’s internal ID for the place</li>
<li>Location name (<code>location</code> → <code>name</code>)</li>
<li>Location address (<code>location</code> → <code>address</code>)</li>
<li>Start and end times (<code>duration</code> → <code>startTimestamp</code> and <code>duration</code> → <code>endTimestamp</code>)</li>
</ul>
<p><strong>For <code>activitySegment</code>s:</strong></p>
<ul>
<li>Distance (<code>distance</code>)</li>
<li>Activity type (<code>activityType</code>)</li>
<li>Start and end coordinates (<code>startLocation</code> → (<code>latitudeE7</code> &amp; <code>longitudeE7</code>) and <code>endLocation</code> → (<code>latitudeE7</code> &amp; <code>longitudeE7</code>))</li>
<li>Start and end times (<code>duration</code> → <code>startTimestamp</code> and <code>duration</code> → <code>endTimestamp</code>)</li>
</ul>
</section>
</section>
<section id="loading-and-playing-with-your-location-history-in-r" class="level1">
<h1>Loading and playing with your location history in R</h1>
<p>We can load all these JSON files with R using the <code>read_json()</code> function from {jsonlite}, but we need to do a little bit of fancy data wrangling with the more complex semantic location history JSON files.</p>
<section id="records.json" class="level2">
<h2 class="anchored" data-anchor-id="records.json"><code>Records.json</code></h2>
<section id="loading-and-cleaning-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-and-cleaning-data">Loading and cleaning data</h3>
<p>Loading <code>Records.json</code> is easy. Because it is essentially rectangular data already, we can use <code>simplifyVector = TRUE</code> to have R convert the <code>locations</code> slot of the JSON file to a data frame automatically.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">all_locations_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_json</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Records.json"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplifyVector =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull out the "locations" slot (this is the same as doing full_data$locations)</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"locations"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make this a tibble just so it prints nicer here on the blog</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() </span>
<span id="cb9-6">all_locations_raw</span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2,288 × 15</span></span>
<span id="cb9-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    latitudeE7 longitudeE7 accuracy velocity heading altitude verticalAccuracy deviceTag platformType serverTimestamp          batteryCharging formFactor timestamp                source deviceTimestamp</span></span>
<span id="cb9-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         &lt;int&gt;       &lt;int&gt;    &lt;int&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;            &lt;int&gt;     &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;lgl&gt;           &lt;chr&gt;      &lt;chr&gt;                    &lt;chr&gt;  &lt;chr&gt;          </span></span>
<span id="cb9-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1  338465853  -843051758        4       30     205      271                3         0 IOS          2023-06-03T12:00:21.140Z TRUE            PHONE      2023-06-03T12:00:21.001Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2  338361607  -843273246       25       32     238      272                3         0 IOS          2023-06-03T12:01:41.112Z TRUE            PHONE      2023-06-03T12:01:41Z     &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3  338283154  -843438356        4       29     228      270                3         0 IOS          2023-06-03T12:02:36.183Z TRUE            PHONE      2023-06-03T12:02:36.001Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4  338185757  -843621145        4       30     203      259                3         0 IOS          2023-06-03T12:03:46.098Z TRUE            PHONE      2023-06-03T12:03:46Z     &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5  338086421  -843782498        4       30     233      277                3         0 IOS          2023-06-03T12:04:51.107Z TRUE            PHONE      2023-06-03T12:04:51.001Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6  337970326  -843935971        4       27     192      269                3         0 IOS          2023-06-03T12:05:56.167Z TRUE            PHONE      2023-06-03T12:05:55.999Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7  337805263  -843911732        4       27     180      282                3         0 IOS          2023-06-03T12:07:03.134Z TRUE            PHONE      2023-06-03T12:07:03.001Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8  337672676  -843890003        4       23     125      291                3         0 IOS          2023-06-03T12:08:08.143Z TRUE            PHONE      2023-06-03T12:08:08Z     &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9  337553940  -843786019        4       27     181      310                3         0 IOS          2023-06-03T12:09:16.194Z TRUE            PHONE      2023-06-03T12:09:16.001Z &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10  337437364  -843914546        4       26     207      295                3         0 IOS          2023-06-03T12:10:24.118Z TRUE            PHONE      2023-06-03T12:10:24Z     &lt;NA&gt;   &lt;NA&gt;           </span></span>
<span id="cb9-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 2,278 more rows</span></span></code></pre></div>
</div>
<p>We need to clean this data up a bit before using it:</p>
<ul>
<li><p>Right now the latitude and longitude coordinates are multiplied by 10,000,000, and they’re just numbers—R doesn’t know that they’re geographic coordinates. We need to divide them by <img src="https://latex.codecogs.com/png.latex?10%5E7"> and then use them to create an {sf}-enabled <code>geometry</code> column using <code>st_as_sf()</code> from {sf}.</p></li>
<li><p>Right now all the timestamps are in UTC (Greenwich Mean Time), not local time. Ordinarily converting UTC times to local time zones is really easy with <code>with_tz()</code> from {lubridate}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One of the times from the trip</span></span>
<span id="cb10-2">time_utc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-03 14:27:23"</span>)</span>
<span id="cb10-3">time_utc</span>
<span id="cb10-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "2023-06-03 14:27:23 UTC"</span></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert it to US Central Daylight Time since we were in Alabama at the time</span></span>
<span id="cb10-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(time_utc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tzone =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Chicago"</span>)</span>
<span id="cb10-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "2023-06-03 09:27:23 CDT"</span></span></code></pre></div>
</div>
<p>However, this was a big road trip and we covered every possible time zone in the continental US (technically not Pacific Daylight Time, but Arizona doesn’t use daylight saving time, so it’s the same time as Pacific time during the summer), so we can’t just convert all the timestamps to just one time zone. We need to figure out which US time zone each latitude/longitude point is in.</p>
<p>I fretted a lot about the best way to do this! I eventually stumbled across <a href="https://github.com/evansiroky/timezone-boundary-builder">a project that has shapefiles for all the world’s time zones</a> and was about to start using that to look up which time zone each point fell inside, but then I discovered that there’s already an R package that does this (and it uses the same time zone boundary project behind the scenes): <a href="https://andyteucher.ca/lutz/">{lutz}</a> (<strong>l</strong>ook <strong>u</strong>p <strong>t</strong>ime <strong>z</strong>ones). We just have to use <code>tz_lookup()</code> and it’ll identify the correct time zone for each point.</p>
<p>But there’s one more wrinkle! This is <em>surprisingly</em> difficult! You’d think we could just use something like <code>mutate(local_time = with_tz(timestamp, tzone = "whatever")</code> and make a local time column, but NOPE. R stores time zone details as an attribute for the entire column, so there’s no way to have a column with times across multiple time zones (<a href="https://github.com/tidyverse/lubridate/issues/359">see this issue here</a>). Notice how the <code>local_time</code> column here is the same regardless of time zone:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">example_thing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb11-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>timestamp, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>tz,</span>
<span id="cb11-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01 00:00:00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/New_York"</span>,</span>
<span id="cb11-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01 01:00:00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/New_York"</span>,</span>
<span id="cb11-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01 00:00:00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Phoenix"</span>,</span>
<span id="cb11-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01 01:00:00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Phoenix"</span></span>
<span id="cb11-7">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(timestamp))</span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The local times are all the same (New York) because columns can only have one time zone</span></span>
<span id="cb11-11">example_thing <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Have to use rowwise() because with_tz() isn't vectorized (with good reason)</span></span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">local_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(timestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tzone =</span> tz))</span>
<span id="cb11-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb11-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Rowwise: </span></span>
<span id="cb11-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   timestamp           tz               local_time         </span></span>
<span id="cb11-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dttm&gt;              &lt;chr&gt;            &lt;dttm&gt;             </span></span>
<span id="cb11-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2023-06-01 00:00:00 America/New_York 2023-05-31 20:00:00</span></span>
<span id="cb11-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 2023-06-01 01:00:00 America/New_York 2023-05-31 21:00:00</span></span>
<span id="cb11-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 2023-06-01 00:00:00 America/Phoenix  2023-05-31 20:00:00</span></span>
<span id="cb11-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 2023-06-01 01:00:00 America/Phoenix  2023-05-31 21:00:00</span></span></code></pre></div>
</div>
<p>So as a workaround, we can group by time zone, which lets us work on a smaller subset of the data for each time zone, thus getting around the “one time zone per column” rule. However, that still doesn’t quite work, because when R is done with the grouping, it puts everything back together in one column, thus breaking the “one time zone per column” rule, and New York time takes over for the whole column again:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">example_thing <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">local_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(timestamp, tz))</span>
<span id="cb12-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb12-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   tz [2]</span></span>
<span id="cb12-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   timestamp           tz               local_time         </span></span>
<span id="cb12-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dttm&gt;              &lt;chr&gt;            &lt;dttm&gt;             </span></span>
<span id="cb12-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2023-06-01 00:00:00 America/New_York 2023-05-31 20:00:00</span></span>
<span id="cb12-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 2023-06-01 01:00:00 America/New_York 2023-05-31 21:00:00</span></span>
<span id="cb12-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 2023-06-01 00:00:00 America/Phoenix  2023-05-31 20:00:00</span></span>
<span id="cb12-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 2023-06-01 01:00:00 America/Phoenix  2023-05-31 21:00:00</span></span></code></pre></div>
</div>
<p>To get around that, we can use <code>force_tz()</code> to convert each local time back to a fake version of UTC. Each timestamp all have the same time zone attribute (UTC), but the time will be US Eastern, Central, Mountain, or whatever. It’s the local time as if it were UTC. It works!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">example_thing <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">local_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(timestamp, tz), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>))</span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   tz [2]</span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   timestamp           tz               local_time         </span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dttm&gt;              &lt;chr&gt;            &lt;dttm&gt;             </span></span>
<span id="cb13-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 2023-06-01 00:00:00 America/New_York 2023-05-31 20:00:00</span></span>
<span id="cb13-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 2023-06-01 01:00:00 America/New_York 2023-05-31 21:00:00</span></span>
<span id="cb13-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 2023-06-01 00:00:00 America/Phoenix  2023-05-31 17:00:00</span></span>
<span id="cb13-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 2023-06-01 01:00:00 America/Phoenix  2023-05-31 18:00:00</span></span></code></pre></div>
</div></li>
<li><p>Finally we’ll add some extra columns for the day, month, and year based on the local time. The file I’m working with here only contains a few days from our trip, but if you’re using your own data, you’ll likely have years of entries, so these columns help with filtering (i.e.&nbsp;you can use <code>filter(year == 2017)</code> to see your whole location history for that year.)</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">all_locations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_locations_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scale down the location data (divide any column that ends in E7 by 10000000)</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ends_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E7"</span>), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a geometry column with the coordinates</span></span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"longitudeE7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latitudeE7"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a column with the time zone for each point</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tz_lookup</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accurate"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the timestamp to an actual UTC-based timestamp</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(timestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a version of the timestamp in local time, but in UTC</span></span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">timestamp_local =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(timestamp, tz), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add some helper columns for filtering, grouping, etc.</span></span>
<span id="cb14-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb14-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(timestamp_local),</span>
<span id="cb14-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">month</span>(timestamp_local),</span>
<span id="cb14-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(timestamp_local)</span>
<span id="cb14-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb14-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(timestamp_local, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%B %e"</span>),</span>
<span id="cb14-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># With %e, there's a leading space for single-digit numbers, so we remove</span></span>
<span id="cb14-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># any double spaces and replace them with single spaces </span></span>
<span id="cb14-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (e.g., "June  3" becomes "June 3")</span></span>
<span id="cb14-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(day_month, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb14-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(day_month)</span>
<span id="cb14-27">  )</span>
<span id="cb14-28">all_locations</span>
<span id="cb14-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 2288 features and 19 fields</span></span>
<span id="cb14-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb14-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb14-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -111.6 ymin: 29.4 xmax: -84.31 ymax: 35.53</span></span>
<span id="cb14-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb14-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2,288 × 20</span></span>
<span id="cb14-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    accuracy velocity heading altitude verticalAccuracy deviceTag platformType serverTimestamp          batteryCharging formFactor timestamp           source deviceTimestamp       geometry tz               timestamp_local      year month   day day_month</span></span>
<span id="cb14-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  *    &lt;int&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;            &lt;int&gt;     &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;lgl&gt;           &lt;chr&gt;      &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt;              &lt;POINT [°]&gt; &lt;chr&gt;            &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;    </span></span>
<span id="cb14-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1        4       30     205      271                3         0 IOS          2023-06-03T12:00:21.140Z TRUE            PHONE      2023-06-03 12:00:21 &lt;NA&gt;   &lt;NA&gt;            (-84.31 33.85) America/New_York 2023-06-03 08:00:21  2023     6     3 June 3   </span></span>
<span id="cb14-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2       25       32     238      272                3         0 IOS          2023-06-03T12:01:41.112Z TRUE            PHONE      2023-06-03 12:01:41 &lt;NA&gt;   &lt;NA&gt;            (-84.33 33.84) America/New_York 2023-06-03 08:01:41  2023     6     3 June 3   </span></span>
<span id="cb14-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3        4       29     228      270                3         0 IOS          2023-06-03T12:02:36.183Z TRUE            PHONE      2023-06-03 12:02:36 &lt;NA&gt;   &lt;NA&gt;            (-84.34 33.83) America/New_York 2023-06-03 08:02:36  2023     6     3 June 3   </span></span>
<span id="cb14-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4        4       30     203      259                3         0 IOS          2023-06-03T12:03:46.098Z TRUE            PHONE      2023-06-03 12:03:46 &lt;NA&gt;   &lt;NA&gt;            (-84.36 33.82) America/New_York 2023-06-03 08:03:46  2023     6     3 June 3   </span></span>
<span id="cb14-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5        4       30     233      277                3         0 IOS          2023-06-03T12:04:51.107Z TRUE            PHONE      2023-06-03 12:04:51 &lt;NA&gt;   &lt;NA&gt;            (-84.38 33.81) America/New_York 2023-06-03 08:04:51  2023     6     3 June 3   </span></span>
<span id="cb14-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6        4       27     192      269                3         0 IOS          2023-06-03T12:05:56.167Z TRUE            PHONE      2023-06-03 12:05:55 &lt;NA&gt;   &lt;NA&gt;             (-84.39 33.8) America/New_York 2023-06-03 08:05:55  2023     6     3 June 3   </span></span>
<span id="cb14-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7        4       27     180      282                3         0 IOS          2023-06-03T12:07:03.134Z TRUE            PHONE      2023-06-03 12:07:03 &lt;NA&gt;   &lt;NA&gt;            (-84.39 33.78) America/New_York 2023-06-03 08:07:03  2023     6     3 June 3   </span></span>
<span id="cb14-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8        4       23     125      291                3         0 IOS          2023-06-03T12:08:08.143Z TRUE            PHONE      2023-06-03 12:08:08 &lt;NA&gt;   &lt;NA&gt;            (-84.39 33.77) America/New_York 2023-06-03 08:08:08  2023     6     3 June 3   </span></span>
<span id="cb14-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9        4       27     181      310                3         0 IOS          2023-06-03T12:09:16.194Z TRUE            PHONE      2023-06-03 12:09:16 &lt;NA&gt;   &lt;NA&gt;            (-84.38 33.76) America/New_York 2023-06-03 08:09:16  2023     6     3 June 3   </span></span>
<span id="cb14-46"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10        4       26     207      295                3         0 IOS          2023-06-03T12:10:24.118Z TRUE            PHONE      2023-06-03 12:10:24 &lt;NA&gt;   &lt;NA&gt;            (-84.39 33.74) America/New_York 2023-06-03 08:10:24  2023     6     3 June 3   </span></span>
<span id="cb14-47"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 2,278 more rows</span></span></code></pre></div>
</div>
<p>Over the 4 days I’ve included in this JSON file, Google recorded my location 2,288 times(!!).</p>
</section>
<section id="basic-maps" class="level3">
<h3 class="anchored" data-anchor-id="basic-maps">Basic maps</h3>
<p>Since we converted the latitude and longitude coordinates into a <code>geometry</code> column, we can plot it really easily:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I used https://www.openstreetmap.org/export to make this window</span></span>
<span id="cb15-2">trip_window <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_sfc</span>(</span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">115.137</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.567</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># left (west), bottom (south)</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.146</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">37.475</span>)),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># right (east), top (north)</span></span>
<span id="cb15-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># WGS 84</span></span>
<span id="cb15-6">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>()</span>
<span id="cb15-8">trip_window</span>
<span id="cb15-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##            X     Y</span></span>
<span id="cb15-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] -115.14 24.57</span></span>
<span id="cb15-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,]  -79.15 37.48</span></span>
<span id="cb15-12"></span>
<span id="cb15-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_locations) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb15-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>],</span>
<span id="cb15-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip_map</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/basic-map-points-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>That looks like a solid thick black line, but it’s not. It’s actually 2,288 individual dots. We can confirm if we zoom in really close (this is the area around The Alamo in San Antonio, Texas):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">all_locations <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">leaflet</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addTiles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addCircles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I got these coordinates from Google Maps</span></span>
<span id="cb16-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setView</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">29.425733271447523</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lng =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">98.48627553904525</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zoom =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-1b4ff99564eb6e8884a5" style="width:100%;height:415.327564894932px;"></div>
<script type="application/json" data-for="htmlwidget-1b4ff99564eb6e8884a5">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircles","args":[[33.8465853,33.8361607,33.8283154,33.8185757,33.8086421,33.7970326,33.7805263,33.7672676,33.755394,33.7437364,33.7266033,33.7120551,33.6977384,33.6854827,33.6724931,33.6614919,33.6505909,33.6382219,33.6206107,33.6188275,33.6017875,33.5894309,33.575587,33.5612994,33.551666,33.5419701,33.5307047,33.5196752,33.5025841,33.4868779,33.4695842,33.4529994,33.4410196,33.4307704,33.4164157,33.400236,33.3845295,33.367116,33.3473453,33.329622,33.3141708,33.2946076,33.2756129,33.2570992,33.2388582,33.2211068,33.2070114,33.1947363,33.1800601,33.1635535,33.1469295,33.1313731,33.1133854,33.0953763,33.0804292,33.0661186,33.0536296,33.0401393,33.0241776,33.0100232,32.9975247,32.984959,32.9766727,32.9661492,32.9520121,32.9343297,32.9153437,32.8990072,32.8830232,32.8685804,32.8535169,32.8390878,32.8251834,32.8092655,32.7935376,32.7775912,32.761054,32.7444772,32.7263163,32.7074977,32.6889266,32.6724289,32.655765,32.6396942,32.6307417,32.62115,32.6111249,32.6023451,32.5912678,32.5778347,32.566639,32.5567551,32.5458052,32.5357867,32.5268961,32.5138636,32.5051784,32.4927251,32.4830665,32.4761401,32.472994,32.4659154,32.4543746,32.4479079,32.4456109,32.4450559,32.4421467,32.4368088,32.4369081,32.4282755,32.4253472,32.417796,32.4046326,32.3937649,32.383276,32.3772266,32.3708433,32.368239,32.3663068,32.3681836,32.3674677,32.3623099,32.3620472,32.3633132,32.3601972,32.3625554,32.3656225,32.3679243,32.365449,32.3490366,32.3348526,32.3281331,32.328181,32.3282387,32.328219,32.3281521,32.3281942,32.3283146,32.3284652,32.3284945,32.3284747,32.3285068,32.3284623,32.3284699,32.3283168,32.3284881,32.3282939,32.3283059,32.3284885,32.3283173,32.328255,32.3282621,32.3280175,32.3283076,32.3228458,32.3025838,32.2837481,32.2660126,32.2490936,32.2318429,32.2169014,32.2000606,32.181882,32.1638748,32.145883,32.1284689,32.1106098,32.0933267,32.0732255,32.0565843,32.0388402,32.0210906,32.0014736,31.9819484,31.9615367,31.94599,31.9284032,31.9098954,31.8919927,31.8740803,31.8587958,31.8456354,31.8275285,31.8072821,31.7872142,31.7708241,31.7520598,31.7338749,31.7160622,31.6990567,31.685201,31.6683284,31.6502702,31.6339555,31.6177417,31.6021115,31.5862065,31.5722019,31.5591425,31.5468064,31.5334551,31.5170671,31.5010555,31.4857736,31.4703785,31.4530374,31.4368718,31.4246471,31.4100812,31.394028,31.3774742,31.3629033,31.3511947,31.3421016,31.3316287,31.3188693,31.3076475,31.2942295,31.2793378,31.2651871,31.2513789,31.24066,31.2302515,31.2176633,31.202361,31.1876348,31.1727007,31.1615484,31.1514874,31.1420276,31.1317233,31.1210225,31.1109729,31.1047457,31.0951692,31.0828245,31.0691315,31.061016,31.0500195,31.0412343,31.0337267,31.0214083,31.0091086,30.9958549,30.98203,30.9725589,30.9655336,30.961153,30.9583572,30.9536361,30.9520923,30.946395,30.9410888,30.9349072,30.928652,30.9189927,30.9095054,30.905613,30.8946628,30.8835377,30.8722132,30.8603503,30.8421501,30.8246759,30.8062728,30.7899996,30.7746541,30.7557289,30.7410989,30.7278948,30.7088952,30.6892435,30.6709399,30.6520902,30.6339786,30.622899,30.6112068,30.5984575,30.5952165,30.5968347,30.5947506,30.5945862,30.5946134,30.593956,30.5942222,30.5953955,30.5953997,30.5953938,30.5942057,30.5944558,30.595026,30.5949843,30.5952165,30.5966323,30.586948,30.5760961,30.5650693,30.5534265,30.5438065,30.5351421,30.5256766,30.5145257,30.5057563,30.4990393,30.4948295,30.4888101,30.4806684,30.4719487,30.4635727,30.4592954,30.4574283,30.4554239,30.4462839,30.4397106,30.4384038,30.4381834,30.4379877,30.4371161,30.4348084,30.4328351,30.4358939,30.4442478,30.4474018,30.4554281,30.458571,30.4545417,30.4543823,30.4542241,30.4540025,30.4476636,30.4521596,30.4607795,30.4580429,30.4494179,30.4452661,30.4414173,30.4375919,30.4315039,30.4261591,30.4236737,30.4187226,30.4172202,30.4116514,30.4044444,30.403439,30.4040394,30.4006194,30.3902237,30.382794,30.3757163,30.3689249,30.3621521,30.3561502,30.3503511,30.3446993,30.3389576,30.333219,30.3333054,30.3273871,30.3210271,30.314124,30.30707,30.3021601,30.2974261,30.2975609,30.2989761,30.3045912,30.2907077,30.2724161,30.2553238,30.236162,30.2209636,30.2060746,30.1909248,30.1756789,30.1603898,30.1453435,30.1279953,30.1126541,30.0977123,30.0822151,30.0674338,30.0559491,30.0492333,30.0483896,30.0481172,30.0486619,30.0483953,30.0493447,30.0486958,30.0487032,30.0489771,30.0488432,30.0488832,30.0488515,30.0489484,30.0488609,30.0491397,30.0486922,30.0485854,30.0486399,30.0484413,30.0475104,30.0477322,30.0477151,30.0476216,30.0485587,30.0425982,30.033528,30.0274905,30.0179842,30.0059231,30.0024907,29.9910691,29.9782112,29.96631,29.9645202,29.9614949,29.9597695,29.9561512,29.9588282,29.9578756,29.9572829,29.9569766,29.9564419,29.956197,29.9569818,29.9578915,29.958136,29.9578768,29.9576923,29.9570057,29.9567951,29.9576175,29.9575051,29.9566267,29.9566282,29.9551868,29.9550549,29.955944,29.9571275,29.9567951,29.9593109,29.9620029,29.960799,29.9615694,29.9621612,29.9614436,29.9620029,29.9574772,29.959868,29.959701,29.9591854,29.9589734,29.9584065,29.9579042,29.9574824,29.9590051,29.9563931,29.957031,29.9565776,29.9563484,29.95623,29.9562698,29.9562665,29.9562579,29.9560295,29.9562264,29.9566011,29.9563931,29.9573154,29.9579891,29.9596762,29.9633068,29.9681582,29.9729652,29.9794238,29.9899345,30.0015705,30.0056644,30.0180968,30.0277624,30.0348076,30.0437517,30.044553,30.0482173,30.0488184,30.0481775,30.0485714,30.0488577,30.0488991,30.0483757,30.0490243,30.0489821,30.0489226,30.0491197,30.048945,30.0488652,30.048923,30.048872,30.0489176,30.0488804,30.0489307,30.0488966,30.0489278,30.0491186,30.0490468,30.0488489,30.0488619,30.0489528,30.0488882,30.0488068,30.0488706,30.0488852,30.0490002,30.0489248,30.0487611,30.0488768,30.0488171,30.0491572,30.0488308,30.0484679,30.0489697,30.0484701,30.0490594,30.0490268,30.049002,30.0492231,30.04832,30.0486199,30.0485211,30.0486766,30.04851,30.0485164,30.0485207,30.0485315,30.0485426,30.0486791,30.0488184,30.0466457,30.0457894,30.053524,30.0513113,30.0330897,30.0158572,30.0027887,29.9876518,29.9716765,29.9576357,29.9494325,29.9429562,29.9372376,29.9406198,29.9447873,29.9447244,29.9447195,29.9455162,29.9463288,29.9419702,29.9418763,29.9418411,29.9417632,29.9408523,29.9401584,29.9419311,29.9419878,29.9423854,29.9427192,29.9431043,29.9421209,29.942002,29.9430796,29.9422869,29.9418971,29.9419082,29.9418152,29.9420659,29.941895,29.9418865,29.9418865,29.942002,29.9449369,29.9501731,29.9578683,29.9613603,29.9646362,29.966494,29.9691236,29.9697512,29.9716122,29.9738942,29.9800474,29.9904125,29.9917045,29.9921273,29.9939539,29.9957089,29.9967826,29.9976885,29.9988265,30.0008335,30.008163,30.0095047,30.0082292,30.0067708,30.0088306,30.0194187,30.0306567,30.0414135,30.0529394,30.0639916,30.075206,30.0823303,30.0888533,30.0950689,30.1018521,30.107986,30.1102461,30.1122893,30.1143561,30.1163727,30.1184716,30.1208097,30.1231064,30.1264204,30.1336406,30.1405891,30.1475801,30.151914,30.1557399,30.1622492,30.1689298,30.1772475,30.187719,30.1972445,30.2105928,30.2275046,30.2442869,30.2632523,30.2830125,30.3041545,30.3222978,30.3382712,30.3540899,30.3712223,30.3833788,30.394535,30.4080512,30.4190201,30.4223517,30.4232489,30.4236348,30.424783,30.4272611,30.4384984,30.4394988,30.4405393,30.445572,30.4494212,30.4536966,30.4524923,30.4512944,30.4465134,30.4409137,30.4353813,30.4298946,30.4225949,30.4168324,30.4114911,30.4057936,30.3997036,30.3939256,30.3884027,30.3824092,30.376519,30.370966,30.3656092,30.3608347,30.3552631,30.3500071,30.3447489,30.3398202,30.3347094,30.3290675,30.3239067,30.3192156,30.316481,30.3161281,30.3164817,30.3164817,30.316481,30.3164848,30.3164925,30.3164799,30.3166402,30.3167719,30.3167404,30.3168353,30.3166172,30.3164813,30.3164633,30.3164701,30.3164606,30.3164489,30.3164493,30.316496,30.3164746,30.316627,30.3167314,30.3167313,30.3165209,30.316527,30.3165837,30.3165775,30.3165652,30.316524,30.3165701,30.3165512,30.316569,30.3165486,30.3165732,30.3165523,30.3155591,30.3119713,30.3065294,30.3003064,30.2939645,30.2845527,30.2771102,30.2708426,30.2635503,30.2549325,30.2474187,30.2471289,30.2472771,30.2474158,30.2475565,30.2477364,30.2478235,30.2479346,30.2504388,30.2525202,30.252378,30.2467353,30.240019,30.2357022,30.2357659,30.2358427,30.2360391,30.2361764,30.2339539,30.2310425,30.2315196,30.2321887,30.2363777,30.2364564,30.2365462,30.2415237,30.2468031,30.246761,30.2466271,30.2469025,30.2479421,30.2474105,30.2473069,30.2471401,30.2468592,30.2467995,30.2467505,30.2466962,30.2467297,30.2466341,30.2467456,30.2497215,30.2496946,30.247973,30.2477934,30.2477939,30.2476477,30.2440969,30.2456995,30.246735,30.2362666,30.2359139,30.2372353,30.2371048,30.237541,30.2314602,30.2239118,30.2163161,30.2161424,30.2159036,30.2159614,30.2140834,30.2100752,30.2057801,30.2017682,30.197492,30.1931017,30.1886284,30.1874868,30.1860665,30.1875058,30.1877115,30.1874878,30.187535,30.1876029,30.1875639,30.1875872,30.1875701,30.1874138,30.1875686,30.1877636,30.1877565,30.1877457,30.1877457,30.1878483,30.1877912,30.1875657,30.1875636,30.1875651,30.187591,30.1875951,30.1873983,30.1875739,30.1823432,30.1744131,30.1657838,30.1566318,30.1486442,30.1401289,30.1319062,30.1234119,30.1187278,30.1214583,30.1214864,30.1172225,30.1147067,30.1218259,30.1299332,30.1301227,30.1310018,30.1304445,30.1297697,30.1314254,30.1358468,30.1269188,30.1145907,30.1012817,30.0949458,30.0963041,30.0961663,30.0841568,30.0670281,30.0537339,30.0422234,30.0284751,30.0153574,30.0011909,29.9890124,29.9874866,29.989025,29.9890239,29.9890124,29.9890124,29.9890124,29.9890109,29.9891113,29.9891133,29.989034,29.9890386,29.9889321,29.9889256,29.9874489,29.9769762,29.9621112,29.9477574,29.9357698,29.9233092,29.9080018,29.8964045,29.8829088,29.8728625,29.8599723,29.8447456,29.8289724,29.8273439,29.8271901,29.8289584,29.8308363,29.8325583,29.8343155,29.8361249,29.8377596,29.8386866,29.8395933,29.8404937,29.8408012,29.8401336,29.8393227,29.8389926,29.8366096,29.8321052,29.8287807,29.8265652,29.8244758,29.8225147,29.8214048,29.8131636,29.808884,29.8044727,29.8006351,29.7975388,29.7905128,29.7951881,29.7901789,29.7828702,29.7766609,29.7714946,29.7708304,29.7715225,29.7704947,29.773934,29.7748058,29.778008,29.7755132,29.7743993,29.7691574,29.768883,29.7712489,29.778919,29.7766684,29.7775736,29.7785306,29.7828751,29.7840308,29.7845221,29.784567,29.784712,29.7847984,29.7849007,29.785005,29.7850723,29.7851231,29.7851504,29.7851202,29.7853172,29.7853951,29.7853823,29.7854904,29.7856053,29.7793483,29.7774685,29.7775085,29.7774571,29.777401,29.7773386,29.7790054,29.7788481,29.7815697,29.7779346,29.7729372,29.7708885,29.7736268,29.7765488,29.7757869,29.768006,29.7613835,29.7635525,29.7607735,29.7572391,29.7543711,29.7514918,29.7475192,29.7423644,29.7377858,29.7326898,29.7281244,29.7236123,29.7188598,29.7162013,29.7127331,29.7050657,29.6980038,29.6924337,29.6937858,29.6936303,29.6934933,29.6923798,29.6909907,29.6895921,29.6886854,29.691855,29.6923799,29.6920719,29.6904329,29.68872,29.6925165,29.6965352,29.6960631,29.6952933,29.694561,29.6951115,29.6952926,29.6952938,29.6953162,29.6952929,29.6953252,29.694988,29.6951832,29.6949994,29.6950198,29.6950108,29.6950055,29.6949877,29.6950163,29.6949249,29.6949961,29.6949708,29.6950051,29.6949905,29.694985,29.6949995,29.6949799,29.6949923,29.6949923,29.6949583,29.6949834,29.6939309,29.6950355,29.690861,29.6895042,29.6901981,29.6915756,29.6937939,29.6976423,29.6978369,29.6971457,29.6965373,29.6960463,29.6920662,29.6923088,29.6925511,29.6909345,29.6812728,29.6703971,29.6680619,29.666053,29.6638229,29.661334,29.6580477,29.6554521,29.6519818,29.6499565,29.6515075,29.6529857,29.6542449,29.6522375,29.6484697,29.6502838,29.6519585,29.6471379,29.6414476,29.6355497,29.6295354,29.6234628,29.6166257,29.6150693,29.6147526,29.6096299,29.6044961,29.5995464,29.5995156,29.5994571,29.5887632,29.5759157,29.5638083,29.5490237,29.5421814,29.5351037,29.5293553,29.5215814,29.5139625,29.5066623,29.4994738,29.4921952,29.4858184,29.4791777,29.4722598,29.4657127,29.4601318,29.4538347,29.4471473,29.4398762,29.4333161,29.4273955,29.4130703,29.4068638,29.4029223,29.4028277,29.4018215,29.4027972,29.4029548,29.4029489,29.4029915,29.4029375,29.4029872,29.4029251,29.40293,29.4029577,29.4029964,29.4030033,29.4029394,29.4028663,29.4028159,29.4029047,29.4029735,29.402971,29.402975,29.4030331,29.4029135,29.4029811,29.4030115,29.4030312,29.402827,29.4028474,29.4027223,29.4029174,29.402901,29.4029499,29.4028201,29.4027942,29.4027911,29.4028048,29.4028067,29.4027969,29.4027959,29.4029773,29.4028277,29.4028592,29.4018061,29.3971059,29.4091111,29.4198411,29.4215708,29.4215708,29.4226959,29.4228618,29.4233574,29.4238629,29.4238629,29.4228989,29.4229368,29.4232088,29.4224398,29.4236948,29.4239438,29.4242142,29.4245528,29.4249606,29.4250825,29.4252131,29.4237545,29.4259096,29.4255609,29.4257454,29.4257128,29.425811,29.4260218,29.4261176,29.4263047,29.4262991,29.4257508,29.4260027,29.4256512,29.4259096,29.4247173,29.4249482,29.424958,29.4236904,29.4231377,29.4247173,29.4228447,29.4228136,29.4228447,29.4228543,29.4223451,29.4214654,29.4244437,29.4383992,29.4375824,29.4346847,29.4436294,29.4598139,29.4764605,29.4848404,29.4994078,29.5183379,29.5340672,29.5470294,29.5640557,29.582609,29.6000422,29.6160879,29.6339853,29.6499316,29.6671681,29.6855317,29.703233,29.7195113,29.7331239,29.7479716,29.7621824,29.7747121,29.7871975,29.8061248,29.8246543,29.8378831,29.8553474,29.8740292,29.8888496,29.9050816,29.9166312,29.9275443,29.9436809,29.9604115,29.9785062,29.987382,30.0001081,30.0144879,30.030925,30.0436865,30.0534454,30.0563665,30.0678059,30.0698979,30.0705143,30.0729971,30.0848332,30.0953876,30.1094422,30.1183902,30.1288541,30.1462182,30.1635141,30.1718236,30.1798222,30.1851348,30.1910586,30.1981519,30.2061596,30.2170941,30.2311212,30.2455195,30.2562995,30.2667647,30.2792336,30.2910942,30.3041594,30.3185659,30.3368985,30.3576245,30.376199,30.3940374,30.4028829,30.411977,30.4261489,30.4326427,30.4475816,30.4661494,30.4853776,30.4971405,30.5093723,30.5078481,30.5093341,30.5092842,30.509353,30.5093762,30.5093762,30.5093762,30.5091158,30.5091379,30.509263,30.5089787,30.5091819,30.5091269,30.5091004,30.5090255,30.5090199,30.5091519,30.5090295,30.5090221,30.5090031,30.509008,30.5090656,30.5091015,30.5090948,30.5090794,30.5090517,30.5090143,30.5090114,30.5090218,30.5090334,30.5091114,30.5091279,30.509153,30.5090949,30.50916,30.5091342,30.5089669,30.5090961,30.5091137,30.5091224,30.5091075,30.5090916,30.5095308,30.5155731,30.5206869,30.5263948,30.5257386,30.521266,30.514133,30.5011709,30.502665,30.499565,30.4949795,30.4956101,30.4872253,30.4831199,30.4806895,30.4741044,30.4676042,30.4602505,30.4540554,30.4464342,30.4441357,30.4469813,30.4536219,30.4623732,30.4721759,30.4820104,30.4905107,30.4997449,30.5093935,30.5195377,30.5306249,30.5414408,30.5501126,30.5581459,30.5647478,30.56817,30.5714049,30.5737024,30.5759798,30.5782051,30.5862042,30.5905234,30.5983222,30.6084548,30.6158628,30.6159177,30.6159177,30.6159177,30.6159442,30.615945,30.6159507,30.6183986,30.6217144,30.6203113,30.6213548,30.6279375,30.6344472,30.6413469,30.647875,30.6594888,30.6647679,30.669116,30.6742839,30.6799182,30.686052,30.6920937,30.6974189,30.7032523,30.7090121,30.7117672,30.7123651,30.7084867,30.7059429,30.7008529,30.6962079,30.6926178,30.6837017,30.6775566,30.6815373,30.6875281,30.6897695,30.6926688,30.6971386,30.7012187,30.7081393,30.7225587,30.7279736,30.730748,30.7338141,30.7346181,30.7377856,30.742201,30.7476341,30.7407991,30.7334443,30.722359,30.7158168,30.7171441,30.7286475,30.7403671,30.7443231,30.7485107,30.7578267,30.7679732,30.7830614,30.7993252,30.8105303,30.8256231,30.8364127,30.846146,30.8576717,30.8691182,30.877842,30.8854459,30.8921306,30.8916212,30.8935258,30.8931056,30.891124,30.8850684,30.8886106,30.8953101,30.8954239,30.8923034,30.8886856,30.8848811,30.8786211,30.8696713,30.8651162,30.8621126,30.8612475,30.8638652,30.8733272,30.8769578,30.8799581,30.8846343,30.8895136,30.8901274,30.8907464,30.8913958,30.8919809,30.8954531,30.9053575,30.9072242,30.9023997,30.9117423,30.9236961,30.9362895,30.9496983,30.9626819,30.9750872,30.9862491,30.9966061,31.0067894,31.0187309,31.0291175,31.0425461,31.0559604,31.0680859,31.0802724,31.0933402,31.1062553,31.1192344,31.1342525,31.1498098,31.1643261,31.1792094,31.1954698,31.2123287,31.2291314,31.2450689,31.2610738,31.2744772,31.2887209,31.3044786,31.3196304,31.3407316,31.359863,31.3757457,31.3896056,31.3990416,31.3989884,31.3990272,31.3990265,31.3990258,31.3989941,31.3990038,31.3986705,31.399015,31.3991125,31.3991288,31.3991378,31.3989533,31.3990051,31.3989983,31.3989849,31.3990383,31.3989704,31.3989657,31.3989891,31.3989848,31.3990038,31.4014409,31.402124,31.4050046,31.411269,31.4223238,31.4317329,31.4443276,31.4605972,31.4747691,31.4887114,31.5046576,31.5193151,31.5338121,31.5477256,31.5613592,31.5786817,31.5947328,31.6087121,31.6269522,31.6416408,31.648432,31.6546877,31.659829,31.6655745,31.6711724,31.6779387,31.6856573,31.6976348,31.7099242,31.7255386,31.7393658,31.7540745,31.7684988,31.7822298,31.7969771,31.8135032,31.8248853,31.8315656,31.8483901,31.8644699,31.8819006,31.894479,31.9081803,31.9220112,31.9358082,31.9529987,31.9696143,31.9847475,31.9984339,32.0095213,32.0192349,32.0296916,32.0436333,32.0576482,32.0704691,32.083139,32.1089903,32.1227531,32.1352155,32.1465673,32.158499,32.1697046,32.1814462,32.1934507,32.2044362,32.2154614,32.2248038,32.2313629,32.2393833,32.2491167,32.2596715,32.2674543,32.2705449,32.2746968,32.2760694,32.2774765,32.2816896,32.2860913,32.2933042,32.3013663,32.3121074,32.3230633,32.3341045,32.3460087,32.3574034,32.3701118,32.3816616,32.3876021,32.3890064,32.3932268,32.39384,32.3950488,32.4019808,32.3996297,32.4000562,32.4017108,32.4019822,32.402006,32.4020007,32.4019826,32.4015237,32.401498,32.4014477,32.401465,32.4013086,32.4015204,32.401475,32.401423,32.4013926,32.4019865,32.401526,32.4014911,32.4015289,32.4015101,32.4015638,32.4014734,32.401478,32.401515,32.4014765,32.4017801,32.4015363,32.3985848,32.3901043,32.3828983,32.3730361,32.3656891,32.3541027,32.3421912,32.3282748,32.313231,32.2968492,32.2798912,32.2627632,32.2454408,32.2287909,32.2113132,32.1978597,32.1851649,32.1759155,32.178348,32.1883302,32.1896225,32.1901942,32.1812458,32.1748631,32.1748539,32.1747882,32.1749049,32.1748616,32.1753629,32.1751983,32.1750785,32.1754145,32.1751511,32.1748699,32.1751541,32.1750228,32.1749224,32.1749417,32.1749555,32.1749415,32.1749182,32.1750095,32.175166,32.1740686,32.1792362,32.1824583,32.192066,32.1919319,32.1875323,32.1807993,32.1750985,32.1804425,32.1933881,32.2068119,32.2215396,32.2386683,32.2570896,32.2755244,32.2938933,32.3123943,32.330629,32.3465337,32.3601542,32.3703024,32.370427,32.3829743,32.3939728,32.3963634,32.4030209,32.4137359,32.4146754,32.4146817,32.4227966,32.4312838,32.4407674,32.4512995,32.4656893,32.4812548,32.4859967,32.4918643,32.5003348,32.5155014,32.5319325,32.5513967,32.5690746,32.585922,32.604545,32.6221628,32.63993,32.6589936,32.6783401,32.6988503,32.718401,32.7390731,32.7589929,32.7802236,32.8002107,32.8181295,32.8321041,32.8421897,32.8465203,32.8594205,32.873199,32.8879281,32.9006235,32.9160909,32.9340374,32.9518378,32.9695445,32.9888458,33.0069707,33.0270578,33.0491246,33.0695959,33.0891425,33.1109744,33.1315089,33.1537521,33.1745248,33.1958054,33.2159867,33.2379765,33.2581503,33.2795075,33.2986757,33.3119484,33.3235671,33.3393592,33.3545015,33.3651651,33.3725843,33.3794427,33.3869677,33.3930092,33.3951118,33.4000425,33.4081553,33.4119601,33.4154804,33.4226033,33.4293714,33.4357546,33.4466682,33.4583673,33.4721752,33.4897897,33.5063839,33.5251106,33.544604,33.564614,33.5843942,33.6011374,33.6183707,33.6348775,33.6530081,33.6721243,33.6906493,33.7108951,33.7297246,33.7481566,33.7690489,33.7878213,33.8090325,33.8308589,33.8510288,33.8723171,33.8939875,33.9138599,33.929162,33.9431777,33.9586869,33.9736239,33.9884392,34.0021118,34.0183205,34.0336234,34.0487774,34.0668403,34.0850521,34.1014219,34.1200188,34.1381324,34.1568966,34.1735717,34.1922368,34.2125463,34.2327343,34.2516862,34.2694625,34.2883671,34.3090363,34.3269202,34.3442642,34.3610804,34.3797262,34.3985789,34.4177165,34.4353859,34.4545089,34.4720834,34.4894228,34.5077363,34.5251559,34.5423189,34.5596154,34.5778869,34.5924974,34.5945248,34.5944867,34.5944934,34.5944991,34.5945109,34.5944907,34.5944748,34.5944854,34.5944891,34.5946518,34.5946711,34.5947363,34.5947038,34.5947789,34.5947491,34.5947497,34.5947625,34.5947545,34.5947586,34.594742,34.5947335,34.5947335,34.5947786,34.5947756,34.5947205,34.5947176,34.5947213,34.5946146,34.5947492,34.594756,34.5947873,34.5947612,34.5947712,34.5947759,34.5948163,34.5946867,34.6017386,34.6016788,34.5958313,34.5891509,34.5896764,34.5888339,34.5917502,34.5966768,34.6047014,34.6149298,34.6262499,34.6405385,34.6444812,34.6487808,34.6514862,34.6590614,34.6754248,34.6952135,34.7144326,34.7342148,34.7525363,34.7703032,34.7895298,34.8091983,34.8292074,34.8474105,34.8646119,34.88414,34.9042143,34.921876,34.9420986,34.9607739,34.9799413,35.000891,35.0088318,35.0099364,35.008398,35.0044774,35.0047459,35.0049589,35.0051372,35.0053809,35.0053601,35.0059824,35.0066964,35.0050424,35.0049261,35.0048397,35.0048197,35.0079094,35.0114751,35.0194762,35.0290767,35.0387478,35.0480979,35.0566035,35.0645309,35.0726382,35.0814756,35.088602,35.0962417,35.1023702,35.1111509,35.113574,35.1021981,35.0954444,35.0829986,35.080734,35.0665656,35.0616827,35.0632863,35.0669839,35.0742183,35.0813559,35.0885385,35.0965258,35.1039106,35.1047132,35.1073164,35.1075969,35.1061973,35.1055435,35.105164,35.105784,35.1063613,35.1065287,35.1050557,35.106196,35.1058121,35.0986265,35.0900263,35.081275,35.0739654,35.0675105,35.0639599,35.0645294,35.0640966,35.0645294,35.0645294,35.0645294,35.0645294,35.0645294,35.0645322,35.0645486,35.0645577,35.0645296,35.0645222,35.0645523,35.0645284,35.064505,35.0645005,35.0645542,35.0634664,35.0644223,35.0652777,35.0640558,35.0592415,35.0558055,35.0523997,35.0488635,35.0448182,35.0401843,35.0358741,35.030635,35.0253887,35.0202859,35.0135096,35.0077361,35.0012449,34.9949984,34.9887588,34.9817781,34.9787718,34.9826159,34.9862387,34.9897118,34.9930999,34.9934584,34.9937824,35.0025274,35.017368,35.0332082,35.0391018,35.029908,35.0265375,35.0271522,35.0302848,35.0368259,35.047355,35.0605923,35.0738915,35.0744572,35.0751699,35.0758735,35.0763587,35.0727691,35.0652964,35.0644247,35.0684066,35.0759623,35.0902105,35.1033375,35.1154314,35.128837,35.1436452,35.1534231,35.1648985,35.18431,35.2018107,35.2190945,35.2345084,35.2490647,35.2654321,35.284429,35.3044611,35.3244826,35.345128,35.3557055,35.3640564,35.3711625,35.3757293,35.3814413,35.3862194,35.3889273,35.3909351,35.3956468,35.4004878,35.4050212,35.4127504,35.4220817,35.4307836,35.4394532,35.4475328,35.4549797,35.464288,35.4773664,35.483616,35.4892465,35.4952292,35.5039893,35.5126304,35.519325,35.5263163,35.5304126,35.5318327,35.5309028,35.5312918,35.5301682,35.5292555,35.5289845,35.5293723,35.5288397,35.5288977,35.5289845,35.5290159,35.5290302,35.5289874,35.5289909,35.5288933,35.5289843,35.528964,35.5289934,35.5290217,35.528932,35.5289492,35.5289703,35.5289723,35.5290658,35.5288293,35.5288409,35.5288004,35.5290036,35.5288503,35.5288727,35.5288727,35.5288727,35.5288727,35.5288727,35.5288419,35.5288419,35.5288452,35.5288557,35.5288365,35.5288345,35.5288391,35.5288479,35.5291518,35.5292278,35.5289354,35.5294794,35.5297754,35.5298036,35.5297781,35.5297754,35.5297754,35.5297666,35.529744,35.5300424,35.5299654,35.5339859,35.5309401,35.5278771,35.5217775,35.5141771,35.5111428,35.4994334,35.4963824,35.4904935,35.4830319,35.4717062,35.4574662,35.4394875,35.4266782,35.4117447,35.3926383,35.377855,35.367649,35.3532386,35.3371731,35.323655,35.3117692,35.302201,35.29322,35.2845946,35.2810577,35.2829158,35.2830549,35.2784036,35.2678001,35.2520653,35.2382046,35.2252827,35.2138626,35.2065143,35.201923,35.197377,35.19283,35.1898783,35.1904123,35.1899125,35.189917,35.1904394,35.1868323,35.1762627,35.1643605,35.1524732,35.1406332,35.1286086,35.1195993,35.1117762,35.1048929,35.1009459,35.0976543,35.0936916,35.0873559,35.0808512,35.0745756,35.0679109,35.0583592,35.0460352,35.0345984,35.0225393,35.0097146,35.0016478,34.9969775,34.9929113,34.9909038,34.9910128,34.9869085,34.9825768,34.9782519,34.9711568,34.9576821,34.9425257,34.9248805,34.913242,34.9085861,34.9063653,34.9091291,34.9145187,34.9253092,34.9385273,34.947186,34.9551148,34.9546357,34.9584739,34.9623448,34.966522,34.9700623,34.9711846,34.9722381,34.9733671,34.9787203,34.9866368,34.9940989,35.0017038,35.0069728,35.010289,35.0159626,35.0271007,35.0396161,35.038473,35.039775,35.0454316,35.0515274,35.0577443,35.0645163,35.0707673,35.0763362,35.0820775,35.0886579,35.0934724,35.0963778,35.0995505,35.1016518,35.1059921,35.1100548,35.1122864,35.1143879,35.1174734,35.1166029,35.1186637,35.1208743,35.1274509,35.1349042,35.1431939,35.1507018,35.1586973,35.1601679,35.1614299,35.1698075,35.178032,35.1865248,35.1949416,35.2026903,35.2018772,35.2025624,35.2020213,35.2062784,35.2097034,35.2146846,35.2186688,35.2179974,35.2210796,35.2159135,35.2150697,35.2113672],[-84.3051758,-84.3273246,-84.3438356,-84.3621145,-84.3782498,-84.3935971,-84.3911732,-84.3890003,-84.3786019,-84.3914546,-84.3937695,-84.4013967,-84.4049403,-84.4033858,-84.4144991,-84.4276159,-84.4421424,-84.4564173,-84.4613678,-84.4839758,-84.4887164,-84.5062481,-84.5248002,-84.5424602,-84.5646385,-84.5866331,-84.6059195,-84.6256142,-84.6374356,-84.6520712,-84.6677062,-84.680744,-84.69883,-84.7179306,-84.7318536,-84.7456314,-84.7562372,-84.7596283,-84.7612124,-84.7728107,-84.786625,-84.7947233,-84.8018032,-84.8058839,-84.807025,-84.8150928,-84.8312521,-84.8458617,-84.8593035,-84.8675704,-84.878876,-84.89168,-84.9028912,-84.9093494,-84.9206745,-84.9385745,-84.9570798,-84.9714897,-84.9836637,-84.9990069,-85.0169191,-85.0355808,-85.0572835,-85.0768118,-85.0936392,-85.1059977,-85.1170413,-85.1307989,-85.1454572,-85.1637588,-85.1798475,-85.196041,-85.21059,-85.2245422,-85.2382569,-85.2524358,-85.2679604,-85.2825737,-85.2971749,-85.3093569,-85.3197978,-85.3321764,-85.3447665,-85.3571857,-85.3746585,-85.3932607,-85.4146784,-85.4349643,-85.455994,-85.4738014,-85.4921056,-85.5117281,-85.5306126,-85.549378,-85.569207,-85.5869292,-85.6073163,-85.6252638,-85.6456535,-85.6678863,-85.6920666,-85.7143132,-85.7322202,-85.7566331,-85.7814344,-85.8047588,-85.8278582,-85.8514679,-85.8755536,-85.8989607,-85.9212944,-85.9424582,-85.9629879,-85.9827673,-86.0033713,-86.0237652,-86.0458941,-86.0677511,-86.0916638,-86.1166861,-86.1422597,-86.1670989,-86.1908249,-86.2140041,-86.2386041,-86.2623546,-86.2820335,-86.3044964,-86.3224878,-86.3217538,-86.3317209,-86.3372877,-86.337309,-86.3372514,-86.3372421,-86.337279,-86.3372613,-86.3373469,-86.3375387,-86.337604,-86.3375933,-86.3376304,-86.3375527,-86.3375601,-86.3373134,-86.3370365,-86.3372558,-86.3373273,-86.3375594,-86.3372971,-86.3374133,-86.3372955,-86.3376103,-86.3373611,-86.3360363,-86.3378592,-86.3437949,-86.3556782,-86.3689315,-86.3846975,-86.4015093,-86.4152339,-86.4258949,-86.4341185,-86.4398985,-86.4483872,-86.4608243,-86.4729043,-86.4831926,-86.4945197,-86.5071595,-86.5162411,-86.5245639,-86.5313289,-86.5409554,-86.5586452,-86.5729914,-86.5875195,-86.6036833,-86.617037,-86.631198,-86.6480807,-86.663473,-86.6687176,-86.6781064,-86.6949664,-86.7076299,-86.7183131,-86.7301998,-86.7425953,-86.7512885,-86.7614012,-86.7760449,-86.7925313,-86.8089401,-86.8247704,-86.8378959,-86.8516759,-86.8665498,-86.8805601,-86.8958161,-86.9122567,-86.9280967,-86.9418762,-86.9548371,-86.9694358,-86.9858835,-87.0004018,-87.014157,-87.0280989,-87.043812,-87.0625131,-87.082416,-87.1031732,-87.1233355,-87.1443056,-87.1627462,-87.1818657,-87.2013561,-87.2199459,-87.2382332,-87.2574129,-87.2769698,-87.2949576,-87.3129726,-87.3304072,-87.3491384,-87.3717501,-87.3927512,-87.412445,-87.433902,-87.4525246,-87.473308,-87.4974268,-87.5189197,-87.536606,-87.5562319,-87.5768553,-87.594903,-87.6148136,-87.6350677,-87.6530083,-87.6731667,-87.6907528,-87.7103101,-87.7325643,-87.755036,-87.7767482,-87.8001099,-87.8233921,-87.8459861,-87.8682104,-87.8879937,-87.9110178,-87.9342703,-87.9551257,-87.9750624,-87.9961459,-88.0159911,-88.0342458,-88.0531374,-88.0708034,-88.0797175,-88.0930434,-88.1042529,-88.1014838,-88.0964108,-88.0935321,-88.1072451,-88.120166,-88.1221407,-88.1262829,-88.1273447,-88.1225993,-88.1185497,-88.1295092,-88.1431364,-88.1545722,-88.1633546,-88.1627496,-88.164056,-88.1636184,-88.1635537,-88.1628771,-88.1636828,-88.163331,-88.1633528,-88.1633234,-88.1628456,-88.163215,-88.1632969,-88.1649383,-88.1633546,-88.1619295,-88.1608361,-88.1797522,-88.1952027,-88.2112692,-88.2266756,-88.2442671,-88.2622093,-88.2815951,-88.3007814,-88.3225486,-88.3438264,-88.3660706,-88.3856774,-88.4065173,-88.4266286,-88.4497887,-88.4747625,-88.4973883,-88.5185676,-88.5413461,-88.564724,-88.5896637,-88.613324,-88.6368922,-88.6591215,-88.6779027,-88.7012531,-88.7244214,-88.7472499,-88.7704739,-88.7928993,-88.8180255,-88.8432827,-88.8688573,-88.8924655,-88.9172109,-88.9400284,-88.9618745,-88.9842746,-89.003717,-89.027056,-89.051515,-89.0759015,-89.0987927,-89.11984,-89.1444275,-89.1670343,-89.1915449,-89.2126344,-89.2329846,-89.2553419,-89.2774605,-89.3011816,-89.3218668,-89.3446087,-89.3676817,-89.3896083,-89.4112535,-89.4310874,-89.4498428,-89.4715787,-89.4946979,-89.5175762,-89.5408976,-89.5615717,-89.5823447,-89.6048167,-89.6271631,-89.6473842,-89.6693493,-89.6917429,-89.7143931,-89.7359522,-89.7475451,-89.7543693,-89.7607462,-89.7692081,-89.7846152,-89.7991163,-89.8151302,-89.8312415,-89.8473986,-89.8633417,-89.8772868,-89.8907838,-89.9041046,-89.9179121,-89.9310769,-89.9460425,-89.9566957,-89.9626273,-89.9625546,-89.962393,-89.9626219,-89.9627502,-89.9625587,-89.962395,-89.9630299,-89.9625987,-89.962677,-89.962734,-89.9627376,-89.9627972,-89.9629582,-89.9626426,-89.9623835,-89.9623627,-89.9631403,-89.9628741,-89.9627189,-89.9627086,-89.9624403,-89.9626426,-89.9671227,-89.985174,-90.0038414,-90.0138086,-90.0218668,-90.0371769,-90.0504504,-90.0608208,-90.0715954,-90.0735287,-90.0706617,-90.0699522,-90.0643023,-90.0678069,-90.0664403,-90.0655456,-90.0650886,-90.0642548,-90.0645014,-90.0651399,-90.0662793,-90.0646745,-90.0636614,-90.0632259,-90.0647748,-90.061943,-90.0616739,-90.0620035,-90.0616871,-90.0618267,-90.0626007,-90.0625538,-90.0623514,-90.0620957,-90.061943,-90.0646779,-90.0681356,-90.0669614,-90.0678887,-90.0681413,-90.0678327,-90.0681356,-90.0657598,-90.0655122,-90.0652023,-90.0650869,-90.0653102,-90.0658132,-90.0662807,-90.0657676,-90.0657423,-90.0641243,-90.0652485,-90.0645903,-90.064378,-90.0644739,-90.0645501,-90.0645625,-90.0639758,-90.0636348,-90.0632474,-90.0629125,-90.0641243,-90.0622288,-90.0616412,-90.0594821,-90.0562782,-90.0566965,-90.0569814,-90.0575119,-90.0511178,-90.0389504,-90.0224293,-90.0135326,-90.0010175,-89.981357,-89.9647311,-89.9632848,-89.962454,-89.9627352,-89.9625872,-89.9624574,-89.9623103,-89.962923,-89.962505,-89.9627908,-89.9627186,-89.9627579,-89.9628913,-89.9629451,-89.9628887,-89.9628853,-89.96271,-89.9627974,-89.9627082,-89.9627847,-89.962808,-89.9628019,-89.9630248,-89.9626096,-89.962838,-89.9627637,-89.9627437,-89.9626747,-89.9626727,-89.9627372,-89.9628532,-89.9629666,-89.9628419,-89.9626405,-89.9629182,-89.9626114,-89.9631683,-89.9628093,-89.9623937,-89.9629519,-89.9624108,-89.9627089,-89.9628616,-89.9627755,-89.9628757,-89.9625818,-89.96242,-89.962486,-89.9626625,-89.9624686,-89.9624982,-89.9624987,-89.9624969,-89.9624559,-89.9624336,-89.9627352,-89.9616641,-89.9606972,-89.9492587,-89.9389775,-89.9395854,-89.9396195,-89.9387829,-89.9441833,-89.9494789,-89.9562612,-89.9603985,-89.9635606,-89.9662883,-89.9750522,-89.9848618,-89.9862646,-89.9861817,-89.9867016,-89.9917354,-89.9945534,-89.9944559,-89.9944988,-89.9944584,-89.994946,-89.9942526,-89.9942101,-89.9942279,-89.9941622,-89.9936257,-89.9936138,-89.9942406,-89.9943577,-89.9936628,-89.9940157,-89.9944837,-89.9945179,-89.9943001,-89.9944203,-89.9944512,-89.9944614,-89.9944614,-89.9943577,-89.9925906,-89.9937749,-89.9981088,-90.0000297,-90.0087078,-90.0153026,-90.0258363,-90.0297903,-90.0377756,-90.0478308,-90.0484011,-90.0492787,-90.0548469,-90.0746704,-90.0949567,-90.1164968,-90.1358715,-90.1583648,-90.178802,-90.2001345,-90.2194123,-90.2401839,-90.2610107,-90.2799665,-90.3003394,-90.3179435,-90.3345282,-90.3503932,-90.3674039,-90.3838005,-90.4003716,-90.4194594,-90.4422433,-90.4641129,-90.4858953,-90.5080018,-90.5329367,-90.5551955,-90.5792596,-90.6017002,-90.6250516,-90.6511461,-90.6773316,-90.7017946,-90.7258504,-90.7488196,-90.7719778,-90.7948869,-90.8187216,-90.8425152,-90.8671125,-90.8881606,-90.9096978,-90.9294647,-90.9467965,-90.960803,-90.9716418,-90.9821115,-90.9891039,-90.9929929,-91.0058096,-91.022132,-91.0356957,-91.0499163,-91.0674747,-91.0847928,-91.1018977,-91.1176707,-91.1324277,-91.1409507,-91.1447553,-91.1554755,-91.1688332,-91.1782614,-91.1949505,-91.2131674,-91.2315701,-91.2521378,-91.2743141,-91.2949088,-91.3154804,-91.3369397,-91.35804,-91.3788259,-91.399382,-91.4201578,-91.4415798,-91.4656116,-91.4889304,-91.5121529,-91.5333849,-91.5538016,-91.5759476,-91.5976994,-91.6182563,-91.6373315,-91.6556204,-91.6759974,-91.6954307,-91.714146,-91.733038,-91.7518937,-91.7726175,-91.7916227,-91.8137638,-91.8299357,-91.8304352,-91.8298949,-91.8298949,-91.8299357,-91.8298705,-91.8298617,-91.8298801,-91.8298644,-91.8293816,-91.8294105,-91.8294696,-91.8296983,-91.8300217,-91.8300072,-91.829992,-91.8300009,-91.8300312,-91.8300213,-91.8300567,-91.8300673,-91.829696,-91.8294919,-91.8295937,-91.8297877,-91.8299911,-91.8300591,-91.8300225,-91.8300301,-91.8300445,-91.8300122,-91.8300687,-91.8300673,-91.8300768,-91.8300789,-91.829913,-91.8331406,-91.8520597,-91.8757864,-91.8980121,-91.9206678,-91.9414434,-91.9633565,-91.9837103,-92.0062033,-92.0274162,-92.0490908,-92.0720054,-92.0954385,-92.1175512,-92.1422948,-92.1647347,-92.1879952,-92.2104338,-92.23263,-92.2570044,-92.2799836,-92.3009196,-92.3227777,-92.3460385,-92.369855,-92.3930233,-92.416748,-92.4395122,-92.4636154,-92.4884406,-92.5116732,-92.5346027,-92.5574678,-92.5806212,-92.6047091,-92.6263256,-92.6495533,-92.67262,-92.6967695,-92.7206257,-92.7427208,-92.766821,-92.7913635,-92.8161146,-92.8386609,-92.8605283,-92.882203,-92.9038067,-92.925017,-92.9477128,-92.9686132,-92.9895575,-93.0118692,-93.0345734,-93.0596318,-93.0852445,-93.1090749,-93.1330437,-93.1577254,-93.1802843,-93.1968796,-93.2162353,-93.2369146,-93.2549346,-93.2768914,-93.2943596,-93.3115448,-93.3293382,-93.3504942,-93.3735113,-93.3945224,-93.4187245,-93.4403088,-93.4628798,-93.4838998,-93.5054437,-93.5292619,-93.5527458,-93.5708579,-93.5694294,-93.5707539,-93.5708138,-93.5708582,-93.5708805,-93.5707004,-93.5706467,-93.5706896,-93.5706621,-93.5706603,-93.5707097,-93.5706535,-93.570816,-93.5707867,-93.5707867,-93.5707404,-93.5706859,-93.5707157,-93.5707579,-93.5707624,-93.570737,-93.57074,-93.5711306,-93.5707108,-93.5740212,-93.5925198,-93.6125311,-93.6338536,-93.6527072,-93.6721813,-93.6913851,-93.7110438,-93.7292393,-93.749806,-93.7727085,-93.794137,-93.8169854,-93.8371455,-93.8582232,-93.8825494,-93.906949,-93.9314545,-93.9552396,-93.9805135,-94.0030762,-94.0232799,-94.0418403,-94.0618811,-94.0840939,-94.1060243,-94.1272727,-94.1359692,-94.1346845,-94.1413547,-94.1529806,-94.167176,-94.1804731,-94.1946545,-94.2116156,-94.2087377,-94.2116243,-94.2116234,-94.2116156,-94.2116156,-94.2116156,-94.2116139,-94.2117519,-94.2117551,-94.2118634,-94.2118575,-94.2119861,-94.2115925,-94.2095567,-94.2192011,-94.2341754,-94.249152,-94.263924,-94.2791481,-94.2977948,-94.3120668,-94.3285319,-94.3409141,-94.3557119,-94.3729114,-94.389564,-94.414046,-94.4394899,-94.4644555,-94.4888806,-94.5116372,-94.5351353,-94.5593782,-94.582245,-94.6071342,-94.6317356,-94.6559948,-94.6791191,-94.7013396,-94.7250366,-94.7467271,-94.7691803,-94.7931695,-94.8177817,-94.8426686,-94.8668333,-94.8898485,-94.9149705,-94.9375484,-94.9598305,-94.9838035,-95.0084202,-95.0322528,-95.0539933,-95.0719397,-95.0914898,-95.1124667,-95.1310519,-95.152481,-95.1739733,-95.1968262,-95.2187536,-95.2378562,-95.2581779,-95.2780989,-95.2978893,-95.3186094,-95.3369838,-95.3547528,-95.3654825,-95.3783176,-95.3987233,-95.4181803,-95.4368887,-95.456835,-95.4760852,-95.4978813,-95.5170105,-95.5374993,-95.5621296,-95.5798086,-95.6020366,-95.6209502,-95.6424551,-95.6636837,-95.68478,-95.7065571,-95.7278614,-95.749733,-95.7721725,-95.7949697,-95.8142748,-95.8355775,-95.8578256,-95.8790387,-95.9007694,-95.922687,-95.9444572,-95.9646805,-95.985197,-96.0083862,-96.0289354,-96.0525542,-96.0768648,-96.0993793,-96.1218633,-96.1418891,-96.1635005,-96.1869689,-96.2092012,-96.2310186,-96.2551464,-96.2794462,-96.301387,-96.3267529,-96.349496,-96.3746647,-96.3972071,-96.4194199,-96.4432758,-96.4666653,-96.4906237,-96.5118669,-96.5300898,-96.5474582,-96.5692126,-96.5922388,-96.6133176,-96.6374208,-96.6595515,-96.6826387,-96.7042722,-96.7272217,-96.7490864,-96.7739688,-96.7970373,-96.8211438,-96.8442541,-96.8658778,-96.8868403,-96.9021006,-96.9019925,-96.9023357,-96.9022412,-96.902078,-96.9022007,-96.9020749,-96.90211,-96.9019903,-96.9018705,-96.9019047,-96.9018274,-96.9018151,-96.9018945,-96.9019142,-96.9019067,-96.901948,-96.9019511,-96.9019473,-96.9020088,-96.9019414,-96.9019361,-96.901965,-96.9019366,-96.9019079,-96.9019079,-96.9019532,-96.9019216,-96.9033236,-96.9019853,-96.9218103,-96.9452377,-96.9684542,-96.9945896,-97.0194329,-97.0423112,-97.0683249,-97.0949022,-97.1198866,-97.1465076,-97.1715961,-97.1970894,-97.2216314,-97.2473756,-97.2719717,-97.2949048,-97.3192436,-97.3433895,-97.3703273,-97.394405,-97.4198197,-97.4441272,-97.469735,-97.4958223,-97.521259,-97.5456938,-97.5715256,-97.5949492,-97.6195729,-97.6450595,-97.6680602,-97.6902169,-97.7112268,-97.7330134,-97.755595,-97.7766182,-97.7999637,-97.8248332,-97.8500171,-97.8728096,-97.8950279,-97.9187246,-97.9434237,-97.9677906,-97.9871022,-98.0070859,-98.0285542,-98.0465369,-98.067569,-98.0898309,-98.1117833,-98.1322127,-98.1521858,-98.1716649,-98.1910621,-98.2116798,-98.2304163,-98.249883,-98.2704789,-98.2910138,-98.3125984,-98.3336044,-98.3547187,-98.3776855,-98.3991346,-98.4184323,-98.4321544,-98.4393874,-98.4420916,-98.4421992,-98.4420801,-98.4416623,-98.4420462,-98.4417413,-98.4420015,-98.4420623,-98.4422044,-98.4421766,-98.4422474,-98.4422535,-98.4421892,-98.4422033,-98.4422172,-98.4421907,-98.4422605,-98.4422094,-98.4421037,-98.4422456,-98.4421811,-98.442065,-98.442127,-98.4422451,-98.4421795,-98.4421981,-98.4416654,-98.4421866,-98.4424071,-98.4422051,-98.4422228,-98.4416598,-98.4417097,-98.4419328,-98.4416862,-98.4417017,-98.4416858,-98.4416642,-98.4416702,-98.4424005,-98.4421992,-98.443969,-98.4617981,-98.4770016,-98.4795455,-98.4796453,-98.479866,-98.479866,-98.4829642,-98.4868792,-98.485969,-98.4877737,-98.4877737,-98.4868991,-98.4871962,-98.4877761,-98.4878587,-98.4880643,-98.4880638,-98.4882678,-98.4884631,-98.4884437,-98.4880377,-98.4871865,-98.4875204,-98.4862923,-98.4866655,-98.4866538,-98.4863014,-98.4863374,-98.4860623,-98.4860206,-98.4860618,-98.4858503,-98.4857535,-98.4856024,-98.4864695,-98.4862923,-98.4891968,-98.4887821,-98.4896166,-98.4900058,-98.4879643,-98.4891968,-98.4868861,-98.4869063,-98.4868861,-98.486889,-98.4849384,-98.4812999,-98.4813208,-98.4774843,-98.4911451,-98.5027438,-98.5147152,-98.5157777,-98.5192459,-98.5371072,-98.5481692,-98.5543431,-98.5650834,-98.5824599,-98.5912258,-98.5969658,-98.6000376,-98.6064138,-98.6130983,-98.6233851,-98.6317383,-98.6423054,-98.6542831,-98.6658279,-98.6810644,-98.697462,-98.7134223,-98.7297935,-98.7473862,-98.7532584,-98.7589568,-98.7738555,-98.7857385,-98.7959335,-98.8108815,-98.821281,-98.8378366,-98.8577869,-98.8738769,-98.888269,-98.8994705,-98.921338,-98.9406728,-98.9587903,-98.9740887,-98.9944201,-99.0158461,-99.0389721,-99.0568666,-99.0816714,-99.1047441,-99.1269278,-99.1464652,-99.1663313,-99.1827029,-99.2029636,-99.2223537,-99.2318541,-99.2416985,-99.2633593,-99.2862561,-99.3108562,-99.3353206,-99.3595658,-99.3834735,-99.4038053,-99.4236418,-99.4430977,-99.4635565,-99.4868859,-99.5063184,-99.5270998,-99.5503928,-99.5695393,-99.5821037,-99.5951339,-99.6067989,-99.6212006,-99.6435672,-99.6653031,-99.682719,-99.7033386,-99.719045,-99.7299048,-99.7391454,-99.7574828,-99.7732821,-99.7732322,-99.7730391,-99.7731956,-99.7732621,-99.7732839,-99.7732839,-99.7732839,-99.773128,-99.7731031,-99.772818,-99.7730711,-99.7728358,-99.7730955,-99.7731663,-99.7730089,-99.7730211,-99.7730237,-99.7730103,-99.7729978,-99.7730002,-99.7730147,-99.7730146,-99.7730367,-99.773026,-99.7730505,-99.7731059,-99.7729962,-99.7729884,-99.7728914,-99.7729698,-99.7730663,-99.77314,-99.7731381,-99.7731278,-99.773153,-99.7731318,-99.7730065,-99.7730784,-99.7731009,-99.773103,-99.7730981,-99.7730983,-99.7759383,-99.7950482,-99.8160683,-99.8395856,-99.8625217,-99.8855137,-99.9075319,-99.9274127,-99.9498017,-99.9722728,-99.994406,-100.0168538,-100.0376638,-100.0580438,-100.0790289,-100.1000557,-100.1207708,-100.1442924,-100.1676055,-100.192065,-100.2154674,-100.2390158,-100.2638933,-100.2856164,-100.3056967,-100.3260139,-100.3472252,-100.3702842,-100.3915278,-100.4123222,-100.4350974,-100.4573901,-100.4812851,-100.5059455,-100.5284941,-100.5512133,-100.573189,-100.5979841,-100.622992,-100.6453061,-100.665166,-100.6869609,-100.7089451,-100.7285376,-100.7439921,-100.7445242,-100.7445242,-100.7445242,-100.744506,-100.7444978,-100.7444867,-100.7565646,-100.7966809,-100.8183972,-100.8370042,-100.8548652,-100.8719909,-100.8902339,-100.9084917,-100.9440841,-100.9641545,-100.9842257,-101.0068776,-101.0288272,-101.0540171,-101.0793678,-101.1019804,-101.1266147,-101.152225,-101.1642136,-101.1659975,-101.1804691,-101.2040592,-101.2266571,-101.249588,-101.2759296,-101.3017722,-101.3262452,-101.3525032,-101.376332,-101.3984966,-101.4460223,-101.4711558,-101.4943204,-101.5160641,-101.5306587,-101.5536369,-101.578407,-101.6010098,-101.6253506,-101.649218,-101.6728631,-101.6962518,-101.7184191,-101.7392346,-101.7584218,-101.7827445,-101.8067369,-101.8270358,-101.845517,-101.8713383,-101.8950086,-101.9172642,-101.9407319,-101.9582454,-101.971627,-101.9933967,-102.0082217,-102.0320534,-102.0539409,-102.0737593,-102.0935717,-102.1186236,-102.1419664,-102.1668289,-102.1928225,-102.2187721,-102.2442502,-102.2713863,-102.2939639,-102.3187451,-102.3429559,-102.3661984,-102.3913297,-102.4152384,-102.4403164,-102.4623417,-102.4861099,-102.5119566,-102.5377683,-102.5635154,-102.5891976,-102.6136763,-102.6406794,-102.6645647,-102.6913158,-102.7180047,-102.7450755,-102.7723452,-102.8014074,-102.8279361,-102.8513567,-102.8705551,-102.8950112,-102.9113827,-102.9262664,-102.9446472,-102.9640745,-102.9845958,-103.0043405,-103.0232321,-103.0432241,-103.0621598,-103.0807928,-103.1006538,-103.120761,-103.1404019,-103.1600447,-103.1785119,-103.19711,-103.2170419,-103.2367489,-103.2558579,-103.2672297,-103.2788277,-103.2896513,-103.3007569,-103.3129078,-103.3254961,-103.3380585,-103.3499727,-103.3632944,-103.3779289,-103.3934179,-103.4106242,-103.4260419,-103.4342743,-103.4452066,-103.4600478,-103.4730434,-103.4807406,-103.4807125,-103.4807308,-103.4807305,-103.4807435,-103.4807479,-103.4808019,-103.4805504,-103.4803374,-103.480642,-103.4802668,-103.480595,-103.4803208,-103.4803114,-103.480313,-103.480316,-103.4803153,-103.4803055,-103.4803636,-103.4803283,-103.4807852,-103.4805067,-103.4828405,-103.4831861,-103.4845559,-103.4874748,-103.4926302,-103.4970634,-103.5029349,-103.5107439,-103.5193954,-103.5334609,-103.5450861,-103.5557711,-103.5663401,-103.5764977,-103.586454,-103.5990992,-103.6108469,-103.6210747,-103.6344287,-103.6511998,-103.6741456,-103.695326,-103.7127454,-103.7322656,-103.7513243,-103.7742627,-103.7883947,-103.7987173,-103.8093474,-103.8228043,-103.834747,-103.8475013,-103.8598937,-103.8717468,-103.8844753,-103.8987597,-103.9085771,-103.9143153,-103.9261402,-103.937288,-103.9493329,-103.9580212,-103.967479,-103.9770754,-103.9866481,-103.9985667,-104.0100948,-104.0205836,-104.0300895,-104.0404414,-104.0504848,-104.0597465,-104.0624948,-104.0649403,-104.0671888,-104.0694178,-104.0731224,-104.0733309,-104.0735255,-104.0737004,-104.0738513,-104.0709011,-104.0673599,-104.0644196,-104.0673857,-104.0703969,-104.0721834,-104.0764962,-104.0832042,-104.0878913,-104.0875694,-104.0960804,-104.1000816,-104.1009799,-104.1009927,-104.1010022,-104.1010107,-104.1010281,-104.1016559,-104.1081717,-104.1213328,-104.1348134,-104.1484301,-104.1631283,-104.1771887,-104.1928698,-104.2071161,-104.2146469,-104.2174755,-104.2204136,-104.2206072,-104.2210284,-104.2236905,-104.2224815,-104.2226138,-104.223376,-104.2236697,-104.2236715,-104.2236546,-104.2236238,-104.2245061,-104.2244499,-104.2242692,-104.2243675,-104.2247046,-104.2245047,-104.2241716,-104.2245711,-104.2246097,-104.2235774,-104.2243453,-104.2244567,-104.2245333,-104.2244863,-104.2244037,-104.2244845,-104.2244705,-104.2243978,-104.2245537,-104.223708,-104.2242713,-104.2222784,-104.2199164,-104.2241659,-104.2308082,-104.2357888,-104.2436249,-104.2516879,-104.2604626,-104.2679942,-104.2762071,-104.2845393,-104.2931107,-104.30177,-104.3100914,-104.3198605,-104.3367085,-104.3527269,-104.3709007,-104.3821137,-104.3872769,-104.3985121,-104.4093702,-104.4416286,-104.4489906,-104.4428878,-104.4433716,-104.4430743,-104.4430567,-104.4440577,-104.4438402,-104.4443092,-104.4439608,-104.4436341,-104.4431211,-104.4441338,-104.4442474,-104.4430955,-104.4431199,-104.4431141,-104.4430534,-104.4430856,-104.4421019,-104.4436713,-104.4460369,-104.4444136,-104.4320036,-104.4116854,-104.4024784,-104.3897497,-104.3831825,-104.3744657,-104.3583057,-104.3419751,-104.3250274,-104.3134358,-104.3048851,-104.2956658,-104.2864423,-104.277274,-104.2681193,-104.2589951,-104.2486139,-104.2394089,-104.2325111,-104.2374581,-104.2375767,-104.2382404,-104.2498904,-104.2551135,-104.2550073,-104.2617777,-104.2754274,-104.27829,-104.2900912,-104.3017202,-104.3146677,-104.3219041,-104.3259345,-104.3315647,-104.3516903,-104.3715856,-104.385474,-104.3981368,-104.4016051,-104.4130613,-104.4217846,-104.4210396,-104.4116825,-104.401789,-104.3953694,-104.3954724,-104.3957698,-104.3957208,-104.395654,-104.3955758,-104.3955206,-104.3954951,-104.3953337,-104.3967155,-104.3974939,-104.3979366,-104.398962,-104.4004542,-104.4101691,-104.4242627,-104.435633,-104.438786,-104.4387037,-104.4391991,-104.4397424,-104.4402442,-104.4408444,-104.4414675,-104.4419978,-104.4420651,-104.4414323,-104.4438796,-104.4473973,-104.4506864,-104.4540464,-104.4572428,-104.4606718,-104.4638804,-104.4661531,-104.4662913,-104.4795295,-104.4988867,-104.5066429,-104.5102925,-104.5132762,-104.5178435,-104.5225626,-104.522667,-104.5226828,-104.5227038,-104.5227155,-104.522719,-104.5227299,-104.5228932,-104.5229117,-104.5229754,-104.5230453,-104.5231543,-104.5233215,-104.5210497,-104.5192034,-104.5192384,-104.5192107,-104.5192498,-104.5192863,-104.5193208,-104.5300363,-104.5422975,-104.5540465,-104.562272,-104.5646522,-104.56699,-104.5694768,-104.571816,-104.5735822,-104.5743191,-104.5748517,-104.5755207,-104.5785855,-104.5835993,-104.5888887,-104.5942697,-104.5994231,-104.6149472,-104.6308828,-104.6485563,-104.6655628,-104.683767,-104.7055818,-104.7256375,-104.7445667,-104.7623826,-104.7781192,-104.7940044,-104.8083442,-104.8245243,-104.8403358,-104.8567315,-104.8708571,-104.8802175,-104.8901901,-104.9002424,-104.9097382,-104.9188265,-104.9283036,-104.9386104,-104.954073,-104.9692781,-104.9842228,-105.0003976,-105.0169443,-105.0337565,-105.049447,-105.0662604,-105.0817146,-105.0969935,-105.1131238,-105.1284952,-105.143627,-105.1588789,-105.1750193,-105.1880595,-105.1897594,-105.1896783,-105.1896348,-105.1896642,-105.1897732,-105.1897205,-105.1897539,-105.1897319,-105.1897388,-105.189236,-105.1892726,-105.1895044,-105.1895732,-105.1895312,-105.1895175,-105.1894584,-105.1894367,-105.1895062,-105.1895223,-105.1895353,-105.1894963,-105.1894963,-105.1895202,-105.1895206,-105.1895366,-105.1895341,-105.1897566,-105.1896717,-105.1894425,-105.1894914,-105.1894547,-105.189499,-105.1895001,-105.18953,-105.1895235,-105.1895696,-105.2021809,-105.2144095,-105.2292596,-105.2463828,-105.2632554,-105.2838143,-105.3041351,-105.3277184,-105.3515004,-105.37217,-105.3926457,-105.4081205,-105.4287241,-105.4501382,-105.4652788,-105.4779239,-105.4876269,-105.4991587,-105.5104087,-105.5219929,-105.5327205,-105.5431393,-105.554408,-105.5659291,-105.5776807,-105.5883706,-105.598466,-105.6004628,-105.6066064,-105.6163808,-105.6275905,-105.6379522,-105.6485825,-105.6600913,-105.6665102,-105.6886761,-105.7141361,-105.7395201,-105.76396,-105.787455,-105.8120677,-105.8370032,-105.8601041,-105.8852946,-105.9123952,-105.938766,-105.9622905,-105.9864583,-106.0129845,-106.0367368,-106.0609451,-106.08388,-106.1057031,-106.1273348,-106.1502963,-106.1713806,-106.1934782,-106.2148998,-106.236981,-106.2546074,-106.2736918,-106.2909539,-106.3109229,-106.3311974,-106.3499938,-106.3707573,-106.3843967,-106.4057939,-106.4234837,-106.4468143,-106.4699163,-106.4900091,-106.5087211,-106.5272397,-106.5459615,-106.5659069,-106.5856367,-106.6022565,-106.6137408,-106.6171446,-106.6266113,-106.6299411,-106.6369225,-106.6445859,-106.6482547,-106.6569724,-106.6721738,-106.6888226,-106.7070355,-106.7214987,-106.7385995,-106.7558941,-106.7704583,-106.7833569,-106.7870144,-106.784347,-106.783874,-106.784347,-106.784347,-106.784347,-106.784347,-106.784347,-106.7843476,-106.7843512,-106.7843455,-106.7843132,-106.7842909,-106.7843028,-106.7842815,-106.7842628,-106.7842693,-106.7842865,-106.7844497,-106.7843801,-106.7877795,-106.7904228,-106.810139,-106.8325785,-106.8547319,-106.8729047,-106.8910003,-106.9114444,-106.9304484,-106.9533564,-106.9763709,-106.998286,-107.0195949,-107.0377519,-107.0581303,-107.077736,-107.0973079,-107.1193144,-107.1408669,-107.165828,-107.1892484,-107.2120041,-107.2369223,-107.263826,-107.2893396,-107.3104488,-107.3282804,-107.3398191,-107.3632887,-107.3849161,-107.4080329,-107.4347263,-107.4606316,-107.4836605,-107.5069921,-107.5248612,-107.5410788,-107.5647503,-107.5913347,-107.6193395,-107.6446368,-107.665553,-107.6881254,-107.7109335,-107.7365035,-107.7588747,-107.7780265,-107.7979628,-107.8163515,-107.8367367,-107.8522361,-107.8728431,-107.8952501,-107.9017571,-107.9177444,-107.9341535,-107.9487997,-107.962748,-107.9784453,-107.9860025,-107.9901525,-107.9973378,-108.0099702,-108.0330681,-108.0537143,-108.0763233,-108.1007556,-108.1231595,-108.1473207,-108.1726033,-108.1966017,-108.2195331,-108.2431039,-108.2651444,-108.2871105,-108.3084434,-108.3277466,-108.3475778,-108.3662884,-108.3848992,-108.4054609,-108.4249344,-108.4506148,-108.4754274,-108.4983722,-108.5214713,-108.5442841,-108.566027,-108.5892538,-108.6138492,-108.6368058,-108.6586201,-108.6692899,-108.6798984,-108.6960385,-108.708639,-108.7088292,-108.7084008,-108.7084919,-108.708639,-108.7085743,-108.7086344,-108.7086269,-108.7085813,-108.7086513,-108.7085506,-108.7084987,-108.7085236,-108.7085372,-108.708529,-108.7085245,-108.7085763,-108.7084913,-108.7085179,-108.7083725,-108.7083491,-108.7084045,-108.7085246,-108.7083672,-108.7083338,-108.7083338,-108.7083338,-108.7083338,-108.7083338,-108.708365,-108.708365,-108.7083642,-108.7083646,-108.7084047,-108.7083713,-108.7083572,-108.7083419,-108.7086241,-108.7090767,-108.7084779,-108.7121336,-108.7199608,-108.7198517,-108.71987,-108.7199608,-108.7199608,-108.7199417,-108.7197694,-108.7220069,-108.7226758,-108.727051,-108.7431752,-108.7627521,-108.7833931,-108.8046059,-108.8253687,-108.8408765,-108.8632394,-108.8868336,-108.9091483,-108.9290446,-108.9466536,-108.9624511,-108.9813406,-108.9972173,-109.008916,-109.0268054,-109.0444331,-109.0566354,-109.0694042,-109.0843392,-109.1043799,-109.1264349,-109.1471803,-109.1675497,-109.1896357,-109.2099664,-109.2323404,-109.253031,-109.270439,-109.2858316,-109.3029523,-109.3194012,-109.3374409,-109.360508,-109.3824308,-109.4040486,-109.4256762,-109.4355546,-109.4332728,-109.4356427,-109.4356485,-109.4359636,-109.4482559,-109.4683685,-109.4866915,-109.5049764,-109.5231838,-109.5430148,-109.5668214,-109.5894389,-109.6098346,-109.6319443,-109.6548452,-109.6767561,-109.6981361,-109.7201402,-109.7413494,-109.7638727,-109.7850705,-109.8066882,-109.8265821,-109.8476253,-109.870105,-109.895343,-109.9215661,-109.9477268,-109.9717778,-109.9965851,-110.020602,-110.0450421,-110.0694705,-110.0919512,-110.109448,-110.1267058,-110.1366769,-110.1549151,-110.1795649,-110.2025611,-110.2259237,-110.2471948,-110.2637365,-110.2787473,-110.2972281,-110.3167429,-110.3399636,-110.3643883,-110.388822,-110.4151499,-110.4407725,-110.465612,-110.4889228,-110.5120145,-110.5355047,-110.5585834,-110.580425,-110.6026882,-110.6246409,-110.6461984,-110.6670588,-110.682879,-110.696588,-110.7168515,-110.7381446,-110.7595957,-110.7803991,-110.8016346,-110.8247808,-110.8461376,-110.8651937,-110.8846442,-110.9039787,-110.9241769,-110.9438851,-110.9655005,-110.9858347,-111.0059991,-111.0273753,-111.0483255,-111.0683291,-111.0892901,-111.110163,-111.1329721,-111.1553572,-111.1788029,-111.1991014,-111.2216992,-111.242191,-111.2640047,-111.2844899,-111.3053813,-111.3266125,-111.3474504,-111.3690012,-111.3898755,-111.4101438,-111.431626,-111.4554012,-111.4769146,-111.4997985,-111.5203655,-111.5418187,-111.5629336,-111.5812691,-111.5877524,-111.5953976,-111.5968955,-111.6042783],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[29.3971059,35.5339859],"lng":[-111.6042783,-84.3051758]},"setView":[[29.4257332714475,-98.4862755390452],18,[]]},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>&nbsp;</p>
<p>We can convert all these points into a single path (or a <code>LINESTRING</code> simple geographic feature instead of lots of <code>POINT</code>s) so that they can connect, using a combination of <code>st_combine()</code> to concatenate all the points and <code>st_cast()</code> to switch their format from a bunch of points to an official <code>LINESTRING</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">big_long_combined_route <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_locations<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_combine</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_cast</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LINESTRING"</span>)</span>
<span id="cb17-4">big_long_combined_route</span>
<span id="cb17-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry set for 1 feature </span></span>
<span id="cb17-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: LINESTRING</span></span>
<span id="cb17-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb17-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -111.6 ymin: 29.4 xmax: -84.31 ymax: 35.53</span></span>
<span id="cb17-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span></code></pre></div>
</div>
<p>Now instead of having two thousand+ points, it’s just one single <code>LINESTRING</code> feature. It shows up as a line now:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> big_long_combined_route) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb18-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>],</span>
<span id="cb18-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip_map</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/basic-map-linestring-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can confirm if we zoom in around the Alamo again too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">big_long_combined_route <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">leaflet</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addTiles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addPolylines</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setView</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">29.425733271447523</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lng =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">98.48627553904525</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zoom =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-8f836166d559454ecd73" style="width:100%;height:415.327564894932px;"></div>
<script type="application/json" data-for="htmlwidget-8f836166d559454ecd73">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addPolylines","args":[[[[{"lng":[-84.3051758,-84.3273246,-84.3438356,-84.3621145,-84.3782498,-84.3935971,-84.3911732,-84.3890003,-84.3786019,-84.3914546,-84.3937695,-84.4013967,-84.4049403,-84.4033858,-84.4144991,-84.4276159,-84.4421424,-84.4564173,-84.4613678,-84.4839758,-84.4887164,-84.5062481,-84.5248002,-84.5424602,-84.5646385,-84.5866331,-84.6059195,-84.6256142,-84.6374356,-84.6520712,-84.6677062,-84.680744,-84.69883,-84.7179306,-84.7318536,-84.7456314,-84.7562372,-84.7596283,-84.7612124,-84.7728107,-84.786625,-84.7947233,-84.8018032,-84.8058839,-84.807025,-84.8150928,-84.8312521,-84.8458617,-84.8593035,-84.8675704,-84.878876,-84.89168,-84.9028912,-84.9093494,-84.9206745,-84.9385745,-84.9570798,-84.9714897,-84.9836637,-84.9990069,-85.0169191,-85.0355808,-85.0572835,-85.0768118,-85.0936392,-85.1059977,-85.1170413,-85.1307989,-85.1454572,-85.1637588,-85.1798475,-85.196041,-85.21059,-85.2245422,-85.2382569,-85.2524358,-85.2679604,-85.2825737,-85.2971749,-85.3093569,-85.3197978,-85.3321764,-85.3447665,-85.3571857,-85.3746585,-85.3932607,-85.4146784,-85.4349643,-85.455994,-85.4738014,-85.4921056,-85.5117281,-85.5306126,-85.549378,-85.569207,-85.5869292,-85.6073163,-85.6252638,-85.6456535,-85.6678863,-85.6920666,-85.7143132,-85.7322202,-85.7566331,-85.7814344,-85.8047588,-85.8278582,-85.8514679,-85.8755536,-85.8989607,-85.9212944,-85.9424582,-85.9629879,-85.9827673,-86.0033713,-86.0237652,-86.0458941,-86.0677511,-86.0916638,-86.1166861,-86.1422597,-86.1670989,-86.1908249,-86.2140041,-86.2386041,-86.2623546,-86.2820335,-86.3044964,-86.3224878,-86.3217538,-86.3317209,-86.3372877,-86.337309,-86.3372514,-86.3372421,-86.337279,-86.3372613,-86.3373469,-86.3375387,-86.337604,-86.3375933,-86.3376304,-86.3375527,-86.3375601,-86.3373134,-86.3370365,-86.3372558,-86.3373273,-86.3375594,-86.3372971,-86.3374133,-86.3372955,-86.3376103,-86.3373611,-86.3360363,-86.3378592,-86.3437949,-86.3556782,-86.3689315,-86.3846975,-86.4015093,-86.4152339,-86.4258949,-86.4341185,-86.4398985,-86.4483872,-86.4608243,-86.4729043,-86.4831926,-86.4945197,-86.5071595,-86.5162411,-86.5245639,-86.5313289,-86.5409554,-86.5586452,-86.5729914,-86.5875195,-86.6036833,-86.617037,-86.631198,-86.6480807,-86.663473,-86.6687176,-86.6781064,-86.6949664,-86.7076299,-86.7183131,-86.7301998,-86.7425953,-86.7512885,-86.7614012,-86.7760449,-86.7925313,-86.8089401,-86.8247704,-86.8378959,-86.8516759,-86.8665498,-86.8805601,-86.8958161,-86.9122567,-86.9280967,-86.9418762,-86.9548371,-86.9694358,-86.9858835,-87.0004018,-87.014157,-87.0280989,-87.043812,-87.0625131,-87.082416,-87.1031732,-87.1233355,-87.1443056,-87.1627462,-87.1818657,-87.2013561,-87.2199459,-87.2382332,-87.2574129,-87.2769698,-87.2949576,-87.3129726,-87.3304072,-87.3491384,-87.3717501,-87.3927512,-87.412445,-87.433902,-87.4525246,-87.473308,-87.4974268,-87.5189197,-87.536606,-87.5562319,-87.5768553,-87.594903,-87.6148136,-87.6350677,-87.6530083,-87.6731667,-87.6907528,-87.7103101,-87.7325643,-87.755036,-87.7767482,-87.8001099,-87.8233921,-87.8459861,-87.8682104,-87.8879937,-87.9110178,-87.9342703,-87.9551257,-87.9750624,-87.9961459,-88.0159911,-88.0342458,-88.0531374,-88.0708034,-88.0797175,-88.0930434,-88.1042529,-88.1014838,-88.0964108,-88.0935321,-88.1072451,-88.120166,-88.1221407,-88.1262829,-88.1273447,-88.1225993,-88.1185497,-88.1295092,-88.1431364,-88.1545722,-88.1633546,-88.1627496,-88.164056,-88.1636184,-88.1635537,-88.1628771,-88.1636828,-88.163331,-88.1633528,-88.1633234,-88.1628456,-88.163215,-88.1632969,-88.1649383,-88.1633546,-88.1619295,-88.1608361,-88.1797522,-88.1952027,-88.2112692,-88.2266756,-88.2442671,-88.2622093,-88.2815951,-88.3007814,-88.3225486,-88.3438264,-88.3660706,-88.3856774,-88.4065173,-88.4266286,-88.4497887,-88.4747625,-88.4973883,-88.5185676,-88.5413461,-88.564724,-88.5896637,-88.613324,-88.6368922,-88.6591215,-88.6779027,-88.7012531,-88.7244214,-88.7472499,-88.7704739,-88.7928993,-88.8180255,-88.8432827,-88.8688573,-88.8924655,-88.9172109,-88.9400284,-88.9618745,-88.9842746,-89.003717,-89.027056,-89.051515,-89.0759015,-89.0987927,-89.11984,-89.1444275,-89.1670343,-89.1915449,-89.2126344,-89.2329846,-89.2553419,-89.2774605,-89.3011816,-89.3218668,-89.3446087,-89.3676817,-89.3896083,-89.4112535,-89.4310874,-89.4498428,-89.4715787,-89.4946979,-89.5175762,-89.5408976,-89.5615717,-89.5823447,-89.6048167,-89.6271631,-89.6473842,-89.6693493,-89.6917429,-89.7143931,-89.7359522,-89.7475451,-89.7543693,-89.7607462,-89.7692081,-89.7846152,-89.7991163,-89.8151302,-89.8312415,-89.8473986,-89.8633417,-89.8772868,-89.8907838,-89.9041046,-89.9179121,-89.9310769,-89.9460425,-89.9566957,-89.9626273,-89.9625546,-89.962393,-89.9626219,-89.9627502,-89.9625587,-89.962395,-89.9630299,-89.9625987,-89.962677,-89.962734,-89.9627376,-89.9627972,-89.9629582,-89.9626426,-89.9623835,-89.9623627,-89.9631403,-89.9628741,-89.9627189,-89.9627086,-89.9624403,-89.9626426,-89.9671227,-89.985174,-90.0038414,-90.0138086,-90.0218668,-90.0371769,-90.0504504,-90.0608208,-90.0715954,-90.0735287,-90.0706617,-90.0699522,-90.0643023,-90.0678069,-90.0664403,-90.0655456,-90.0650886,-90.0642548,-90.0645014,-90.0651399,-90.0662793,-90.0646745,-90.0636614,-90.0632259,-90.0647748,-90.061943,-90.0616739,-90.0620035,-90.0616871,-90.0618267,-90.0626007,-90.0625538,-90.0623514,-90.0620957,-90.061943,-90.0646779,-90.0681356,-90.0669614,-90.0678887,-90.0681413,-90.0678327,-90.0681356,-90.0657598,-90.0655122,-90.0652023,-90.0650869,-90.0653102,-90.0658132,-90.0662807,-90.0657676,-90.0657423,-90.0641243,-90.0652485,-90.0645903,-90.064378,-90.0644739,-90.0645501,-90.0645625,-90.0639758,-90.0636348,-90.0632474,-90.0629125,-90.0641243,-90.0622288,-90.0616412,-90.0594821,-90.0562782,-90.0566965,-90.0569814,-90.0575119,-90.0511178,-90.0389504,-90.0224293,-90.0135326,-90.0010175,-89.981357,-89.9647311,-89.9632848,-89.962454,-89.9627352,-89.9625872,-89.9624574,-89.9623103,-89.962923,-89.962505,-89.9627908,-89.9627186,-89.9627579,-89.9628913,-89.9629451,-89.9628887,-89.9628853,-89.96271,-89.9627974,-89.9627082,-89.9627847,-89.962808,-89.9628019,-89.9630248,-89.9626096,-89.962838,-89.9627637,-89.9627437,-89.9626747,-89.9626727,-89.9627372,-89.9628532,-89.9629666,-89.9628419,-89.9626405,-89.9629182,-89.9626114,-89.9631683,-89.9628093,-89.9623937,-89.9629519,-89.9624108,-89.9627089,-89.9628616,-89.9627755,-89.9628757,-89.9625818,-89.96242,-89.962486,-89.9626625,-89.9624686,-89.9624982,-89.9624987,-89.9624969,-89.9624559,-89.9624336,-89.9627352,-89.9616641,-89.9606972,-89.9492587,-89.9389775,-89.9395854,-89.9396195,-89.9387829,-89.9441833,-89.9494789,-89.9562612,-89.9603985,-89.9635606,-89.9662883,-89.9750522,-89.9848618,-89.9862646,-89.9861817,-89.9867016,-89.9917354,-89.9945534,-89.9944559,-89.9944988,-89.9944584,-89.994946,-89.9942526,-89.9942101,-89.9942279,-89.9941622,-89.9936257,-89.9936138,-89.9942406,-89.9943577,-89.9936628,-89.9940157,-89.9944837,-89.9945179,-89.9943001,-89.9944203,-89.9944512,-89.9944614,-89.9944614,-89.9943577,-89.9925906,-89.9937749,-89.9981088,-90.0000297,-90.0087078,-90.0153026,-90.0258363,-90.0297903,-90.0377756,-90.0478308,-90.0484011,-90.0492787,-90.0548469,-90.0746704,-90.0949567,-90.1164968,-90.1358715,-90.1583648,-90.178802,-90.2001345,-90.2194123,-90.2401839,-90.2610107,-90.2799665,-90.3003394,-90.3179435,-90.3345282,-90.3503932,-90.3674039,-90.3838005,-90.4003716,-90.4194594,-90.4422433,-90.4641129,-90.4858953,-90.5080018,-90.5329367,-90.5551955,-90.5792596,-90.6017002,-90.6250516,-90.6511461,-90.6773316,-90.7017946,-90.7258504,-90.7488196,-90.7719778,-90.7948869,-90.8187216,-90.8425152,-90.8671125,-90.8881606,-90.9096978,-90.9294647,-90.9467965,-90.960803,-90.9716418,-90.9821115,-90.9891039,-90.9929929,-91.0058096,-91.022132,-91.0356957,-91.0499163,-91.0674747,-91.0847928,-91.1018977,-91.1176707,-91.1324277,-91.1409507,-91.1447553,-91.1554755,-91.1688332,-91.1782614,-91.1949505,-91.2131674,-91.2315701,-91.2521378,-91.2743141,-91.2949088,-91.3154804,-91.3369397,-91.35804,-91.3788259,-91.399382,-91.4201578,-91.4415798,-91.4656116,-91.4889304,-91.5121529,-91.5333849,-91.5538016,-91.5759476,-91.5976994,-91.6182563,-91.6373315,-91.6556204,-91.6759974,-91.6954307,-91.714146,-91.733038,-91.7518937,-91.7726175,-91.7916227,-91.8137638,-91.8299357,-91.8304352,-91.8298949,-91.8298949,-91.8299357,-91.8298705,-91.8298617,-91.8298801,-91.8298644,-91.8293816,-91.8294105,-91.8294696,-91.8296983,-91.8300217,-91.8300072,-91.829992,-91.8300009,-91.8300312,-91.8300213,-91.8300567,-91.8300673,-91.829696,-91.8294919,-91.8295937,-91.8297877,-91.8299911,-91.8300591,-91.8300225,-91.8300301,-91.8300445,-91.8300122,-91.8300687,-91.8300673,-91.8300768,-91.8300789,-91.829913,-91.8331406,-91.8520597,-91.8757864,-91.8980121,-91.9206678,-91.9414434,-91.9633565,-91.9837103,-92.0062033,-92.0274162,-92.0490908,-92.0720054,-92.0954385,-92.1175512,-92.1422948,-92.1647347,-92.1879952,-92.2104338,-92.23263,-92.2570044,-92.2799836,-92.3009196,-92.3227777,-92.3460385,-92.369855,-92.3930233,-92.416748,-92.4395122,-92.4636154,-92.4884406,-92.5116732,-92.5346027,-92.5574678,-92.5806212,-92.6047091,-92.6263256,-92.6495533,-92.67262,-92.6967695,-92.7206257,-92.7427208,-92.766821,-92.7913635,-92.8161146,-92.8386609,-92.8605283,-92.882203,-92.9038067,-92.925017,-92.9477128,-92.9686132,-92.9895575,-93.0118692,-93.0345734,-93.0596318,-93.0852445,-93.1090749,-93.1330437,-93.1577254,-93.1802843,-93.1968796,-93.2162353,-93.2369146,-93.2549346,-93.2768914,-93.2943596,-93.3115448,-93.3293382,-93.3504942,-93.3735113,-93.3945224,-93.4187245,-93.4403088,-93.4628798,-93.4838998,-93.5054437,-93.5292619,-93.5527458,-93.5708579,-93.5694294,-93.5707539,-93.5708138,-93.5708582,-93.5708805,-93.5707004,-93.5706467,-93.5706896,-93.5706621,-93.5706603,-93.5707097,-93.5706535,-93.570816,-93.5707867,-93.5707867,-93.5707404,-93.5706859,-93.5707157,-93.5707579,-93.5707624,-93.570737,-93.57074,-93.5711306,-93.5707108,-93.5740212,-93.5925198,-93.6125311,-93.6338536,-93.6527072,-93.6721813,-93.6913851,-93.7110438,-93.7292393,-93.749806,-93.7727085,-93.794137,-93.8169854,-93.8371455,-93.8582232,-93.8825494,-93.906949,-93.9314545,-93.9552396,-93.9805135,-94.0030762,-94.0232799,-94.0418403,-94.0618811,-94.0840939,-94.1060243,-94.1272727,-94.1359692,-94.1346845,-94.1413547,-94.1529806,-94.167176,-94.1804731,-94.1946545,-94.2116156,-94.2087377,-94.2116243,-94.2116234,-94.2116156,-94.2116156,-94.2116156,-94.2116139,-94.2117519,-94.2117551,-94.2118634,-94.2118575,-94.2119861,-94.2115925,-94.2095567,-94.2192011,-94.2341754,-94.249152,-94.263924,-94.2791481,-94.2977948,-94.3120668,-94.3285319,-94.3409141,-94.3557119,-94.3729114,-94.389564,-94.414046,-94.4394899,-94.4644555,-94.4888806,-94.5116372,-94.5351353,-94.5593782,-94.582245,-94.6071342,-94.6317356,-94.6559948,-94.6791191,-94.7013396,-94.7250366,-94.7467271,-94.7691803,-94.7931695,-94.8177817,-94.8426686,-94.8668333,-94.8898485,-94.9149705,-94.9375484,-94.9598305,-94.9838035,-95.0084202,-95.0322528,-95.0539933,-95.0719397,-95.0914898,-95.1124667,-95.1310519,-95.152481,-95.1739733,-95.1968262,-95.2187536,-95.2378562,-95.2581779,-95.2780989,-95.2978893,-95.3186094,-95.3369838,-95.3547528,-95.3654825,-95.3783176,-95.3987233,-95.4181803,-95.4368887,-95.456835,-95.4760852,-95.4978813,-95.5170105,-95.5374993,-95.5621296,-95.5798086,-95.6020366,-95.6209502,-95.6424551,-95.6636837,-95.68478,-95.7065571,-95.7278614,-95.749733,-95.7721725,-95.7949697,-95.8142748,-95.8355775,-95.8578256,-95.8790387,-95.9007694,-95.922687,-95.9444572,-95.9646805,-95.985197,-96.0083862,-96.0289354,-96.0525542,-96.0768648,-96.0993793,-96.1218633,-96.1418891,-96.1635005,-96.1869689,-96.2092012,-96.2310186,-96.2551464,-96.2794462,-96.301387,-96.3267529,-96.349496,-96.3746647,-96.3972071,-96.4194199,-96.4432758,-96.4666653,-96.4906237,-96.5118669,-96.5300898,-96.5474582,-96.5692126,-96.5922388,-96.6133176,-96.6374208,-96.6595515,-96.6826387,-96.7042722,-96.7272217,-96.7490864,-96.7739688,-96.7970373,-96.8211438,-96.8442541,-96.8658778,-96.8868403,-96.9021006,-96.9019925,-96.9023357,-96.9022412,-96.902078,-96.9022007,-96.9020749,-96.90211,-96.9019903,-96.9018705,-96.9019047,-96.9018274,-96.9018151,-96.9018945,-96.9019142,-96.9019067,-96.901948,-96.9019511,-96.9019473,-96.9020088,-96.9019414,-96.9019361,-96.901965,-96.9019366,-96.9019079,-96.9019079,-96.9019532,-96.9019216,-96.9033236,-96.9019853,-96.9218103,-96.9452377,-96.9684542,-96.9945896,-97.0194329,-97.0423112,-97.0683249,-97.0949022,-97.1198866,-97.1465076,-97.1715961,-97.1970894,-97.2216314,-97.2473756,-97.2719717,-97.2949048,-97.3192436,-97.3433895,-97.3703273,-97.394405,-97.4198197,-97.4441272,-97.469735,-97.4958223,-97.521259,-97.5456938,-97.5715256,-97.5949492,-97.6195729,-97.6450595,-97.6680602,-97.6902169,-97.7112268,-97.7330134,-97.755595,-97.7766182,-97.7999637,-97.8248332,-97.8500171,-97.8728096,-97.8950279,-97.9187246,-97.9434237,-97.9677906,-97.9871022,-98.0070859,-98.0285542,-98.0465369,-98.067569,-98.0898309,-98.1117833,-98.1322127,-98.1521858,-98.1716649,-98.1910621,-98.2116798,-98.2304163,-98.249883,-98.2704789,-98.2910138,-98.3125984,-98.3336044,-98.3547187,-98.3776855,-98.3991346,-98.4184323,-98.4321544,-98.4393874,-98.4420916,-98.4421992,-98.4420801,-98.4416623,-98.4420462,-98.4417413,-98.4420015,-98.4420623,-98.4422044,-98.4421766,-98.4422474,-98.4422535,-98.4421892,-98.4422033,-98.4422172,-98.4421907,-98.4422605,-98.4422094,-98.4421037,-98.4422456,-98.4421811,-98.442065,-98.442127,-98.4422451,-98.4421795,-98.4421981,-98.4416654,-98.4421866,-98.4424071,-98.4422051,-98.4422228,-98.4416598,-98.4417097,-98.4419328,-98.4416862,-98.4417017,-98.4416858,-98.4416642,-98.4416702,-98.4424005,-98.4421992,-98.443969,-98.4617981,-98.4770016,-98.4795455,-98.4796453,-98.479866,-98.479866,-98.4829642,-98.4868792,-98.485969,-98.4877737,-98.4877737,-98.4868991,-98.4871962,-98.4877761,-98.4878587,-98.4880643,-98.4880638,-98.4882678,-98.4884631,-98.4884437,-98.4880377,-98.4871865,-98.4875204,-98.4862923,-98.4866655,-98.4866538,-98.4863014,-98.4863374,-98.4860623,-98.4860206,-98.4860618,-98.4858503,-98.4857535,-98.4856024,-98.4864695,-98.4862923,-98.4891968,-98.4887821,-98.4896166,-98.4900058,-98.4879643,-98.4891968,-98.4868861,-98.4869063,-98.4868861,-98.486889,-98.4849384,-98.4812999,-98.4813208,-98.4774843,-98.4911451,-98.5027438,-98.5147152,-98.5157777,-98.5192459,-98.5371072,-98.5481692,-98.5543431,-98.5650834,-98.5824599,-98.5912258,-98.5969658,-98.6000376,-98.6064138,-98.6130983,-98.6233851,-98.6317383,-98.6423054,-98.6542831,-98.6658279,-98.6810644,-98.697462,-98.7134223,-98.7297935,-98.7473862,-98.7532584,-98.7589568,-98.7738555,-98.7857385,-98.7959335,-98.8108815,-98.821281,-98.8378366,-98.8577869,-98.8738769,-98.888269,-98.8994705,-98.921338,-98.9406728,-98.9587903,-98.9740887,-98.9944201,-99.0158461,-99.0389721,-99.0568666,-99.0816714,-99.1047441,-99.1269278,-99.1464652,-99.1663313,-99.1827029,-99.2029636,-99.2223537,-99.2318541,-99.2416985,-99.2633593,-99.2862561,-99.3108562,-99.3353206,-99.3595658,-99.3834735,-99.4038053,-99.4236418,-99.4430977,-99.4635565,-99.4868859,-99.5063184,-99.5270998,-99.5503928,-99.5695393,-99.5821037,-99.5951339,-99.6067989,-99.6212006,-99.6435672,-99.6653031,-99.682719,-99.7033386,-99.719045,-99.7299048,-99.7391454,-99.7574828,-99.7732821,-99.7732322,-99.7730391,-99.7731956,-99.7732621,-99.7732839,-99.7732839,-99.7732839,-99.773128,-99.7731031,-99.772818,-99.7730711,-99.7728358,-99.7730955,-99.7731663,-99.7730089,-99.7730211,-99.7730237,-99.7730103,-99.7729978,-99.7730002,-99.7730147,-99.7730146,-99.7730367,-99.773026,-99.7730505,-99.7731059,-99.7729962,-99.7729884,-99.7728914,-99.7729698,-99.7730663,-99.77314,-99.7731381,-99.7731278,-99.773153,-99.7731318,-99.7730065,-99.7730784,-99.7731009,-99.773103,-99.7730981,-99.7730983,-99.7759383,-99.7950482,-99.8160683,-99.8395856,-99.8625217,-99.8855137,-99.9075319,-99.9274127,-99.9498017,-99.9722728,-99.994406,-100.0168538,-100.0376638,-100.0580438,-100.0790289,-100.1000557,-100.1207708,-100.1442924,-100.1676055,-100.192065,-100.2154674,-100.2390158,-100.2638933,-100.2856164,-100.3056967,-100.3260139,-100.3472252,-100.3702842,-100.3915278,-100.4123222,-100.4350974,-100.4573901,-100.4812851,-100.5059455,-100.5284941,-100.5512133,-100.573189,-100.5979841,-100.622992,-100.6453061,-100.665166,-100.6869609,-100.7089451,-100.7285376,-100.7439921,-100.7445242,-100.7445242,-100.7445242,-100.744506,-100.7444978,-100.7444867,-100.7565646,-100.7966809,-100.8183972,-100.8370042,-100.8548652,-100.8719909,-100.8902339,-100.9084917,-100.9440841,-100.9641545,-100.9842257,-101.0068776,-101.0288272,-101.0540171,-101.0793678,-101.1019804,-101.1266147,-101.152225,-101.1642136,-101.1659975,-101.1804691,-101.2040592,-101.2266571,-101.249588,-101.2759296,-101.3017722,-101.3262452,-101.3525032,-101.376332,-101.3984966,-101.4460223,-101.4711558,-101.4943204,-101.5160641,-101.5306587,-101.5536369,-101.578407,-101.6010098,-101.6253506,-101.649218,-101.6728631,-101.6962518,-101.7184191,-101.7392346,-101.7584218,-101.7827445,-101.8067369,-101.8270358,-101.845517,-101.8713383,-101.8950086,-101.9172642,-101.9407319,-101.9582454,-101.971627,-101.9933967,-102.0082217,-102.0320534,-102.0539409,-102.0737593,-102.0935717,-102.1186236,-102.1419664,-102.1668289,-102.1928225,-102.2187721,-102.2442502,-102.2713863,-102.2939639,-102.3187451,-102.3429559,-102.3661984,-102.3913297,-102.4152384,-102.4403164,-102.4623417,-102.4861099,-102.5119566,-102.5377683,-102.5635154,-102.5891976,-102.6136763,-102.6406794,-102.6645647,-102.6913158,-102.7180047,-102.7450755,-102.7723452,-102.8014074,-102.8279361,-102.8513567,-102.8705551,-102.8950112,-102.9113827,-102.9262664,-102.9446472,-102.9640745,-102.9845958,-103.0043405,-103.0232321,-103.0432241,-103.0621598,-103.0807928,-103.1006538,-103.120761,-103.1404019,-103.1600447,-103.1785119,-103.19711,-103.2170419,-103.2367489,-103.2558579,-103.2672297,-103.2788277,-103.2896513,-103.3007569,-103.3129078,-103.3254961,-103.3380585,-103.3499727,-103.3632944,-103.3779289,-103.3934179,-103.4106242,-103.4260419,-103.4342743,-103.4452066,-103.4600478,-103.4730434,-103.4807406,-103.4807125,-103.4807308,-103.4807305,-103.4807435,-103.4807479,-103.4808019,-103.4805504,-103.4803374,-103.480642,-103.4802668,-103.480595,-103.4803208,-103.4803114,-103.480313,-103.480316,-103.4803153,-103.4803055,-103.4803636,-103.4803283,-103.4807852,-103.4805067,-103.4828405,-103.4831861,-103.4845559,-103.4874748,-103.4926302,-103.4970634,-103.5029349,-103.5107439,-103.5193954,-103.5334609,-103.5450861,-103.5557711,-103.5663401,-103.5764977,-103.586454,-103.5990992,-103.6108469,-103.6210747,-103.6344287,-103.6511998,-103.6741456,-103.695326,-103.7127454,-103.7322656,-103.7513243,-103.7742627,-103.7883947,-103.7987173,-103.8093474,-103.8228043,-103.834747,-103.8475013,-103.8598937,-103.8717468,-103.8844753,-103.8987597,-103.9085771,-103.9143153,-103.9261402,-103.937288,-103.9493329,-103.9580212,-103.967479,-103.9770754,-103.9866481,-103.9985667,-104.0100948,-104.0205836,-104.0300895,-104.0404414,-104.0504848,-104.0597465,-104.0624948,-104.0649403,-104.0671888,-104.0694178,-104.0731224,-104.0733309,-104.0735255,-104.0737004,-104.0738513,-104.0709011,-104.0673599,-104.0644196,-104.0673857,-104.0703969,-104.0721834,-104.0764962,-104.0832042,-104.0878913,-104.0875694,-104.0960804,-104.1000816,-104.1009799,-104.1009927,-104.1010022,-104.1010107,-104.1010281,-104.1016559,-104.1081717,-104.1213328,-104.1348134,-104.1484301,-104.1631283,-104.1771887,-104.1928698,-104.2071161,-104.2146469,-104.2174755,-104.2204136,-104.2206072,-104.2210284,-104.2236905,-104.2224815,-104.2226138,-104.223376,-104.2236697,-104.2236715,-104.2236546,-104.2236238,-104.2245061,-104.2244499,-104.2242692,-104.2243675,-104.2247046,-104.2245047,-104.2241716,-104.2245711,-104.2246097,-104.2235774,-104.2243453,-104.2244567,-104.2245333,-104.2244863,-104.2244037,-104.2244845,-104.2244705,-104.2243978,-104.2245537,-104.223708,-104.2242713,-104.2222784,-104.2199164,-104.2241659,-104.2308082,-104.2357888,-104.2436249,-104.2516879,-104.2604626,-104.2679942,-104.2762071,-104.2845393,-104.2931107,-104.30177,-104.3100914,-104.3198605,-104.3367085,-104.3527269,-104.3709007,-104.3821137,-104.3872769,-104.3985121,-104.4093702,-104.4416286,-104.4489906,-104.4428878,-104.4433716,-104.4430743,-104.4430567,-104.4440577,-104.4438402,-104.4443092,-104.4439608,-104.4436341,-104.4431211,-104.4441338,-104.4442474,-104.4430955,-104.4431199,-104.4431141,-104.4430534,-104.4430856,-104.4421019,-104.4436713,-104.4460369,-104.4444136,-104.4320036,-104.4116854,-104.4024784,-104.3897497,-104.3831825,-104.3744657,-104.3583057,-104.3419751,-104.3250274,-104.3134358,-104.3048851,-104.2956658,-104.2864423,-104.277274,-104.2681193,-104.2589951,-104.2486139,-104.2394089,-104.2325111,-104.2374581,-104.2375767,-104.2382404,-104.2498904,-104.2551135,-104.2550073,-104.2617777,-104.2754274,-104.27829,-104.2900912,-104.3017202,-104.3146677,-104.3219041,-104.3259345,-104.3315647,-104.3516903,-104.3715856,-104.385474,-104.3981368,-104.4016051,-104.4130613,-104.4217846,-104.4210396,-104.4116825,-104.401789,-104.3953694,-104.3954724,-104.3957698,-104.3957208,-104.395654,-104.3955758,-104.3955206,-104.3954951,-104.3953337,-104.3967155,-104.3974939,-104.3979366,-104.398962,-104.4004542,-104.4101691,-104.4242627,-104.435633,-104.438786,-104.4387037,-104.4391991,-104.4397424,-104.4402442,-104.4408444,-104.4414675,-104.4419978,-104.4420651,-104.4414323,-104.4438796,-104.4473973,-104.4506864,-104.4540464,-104.4572428,-104.4606718,-104.4638804,-104.4661531,-104.4662913,-104.4795295,-104.4988867,-104.5066429,-104.5102925,-104.5132762,-104.5178435,-104.5225626,-104.522667,-104.5226828,-104.5227038,-104.5227155,-104.522719,-104.5227299,-104.5228932,-104.5229117,-104.5229754,-104.5230453,-104.5231543,-104.5233215,-104.5210497,-104.5192034,-104.5192384,-104.5192107,-104.5192498,-104.5192863,-104.5193208,-104.5300363,-104.5422975,-104.5540465,-104.562272,-104.5646522,-104.56699,-104.5694768,-104.571816,-104.5735822,-104.5743191,-104.5748517,-104.5755207,-104.5785855,-104.5835993,-104.5888887,-104.5942697,-104.5994231,-104.6149472,-104.6308828,-104.6485563,-104.6655628,-104.683767,-104.7055818,-104.7256375,-104.7445667,-104.7623826,-104.7781192,-104.7940044,-104.8083442,-104.8245243,-104.8403358,-104.8567315,-104.8708571,-104.8802175,-104.8901901,-104.9002424,-104.9097382,-104.9188265,-104.9283036,-104.9386104,-104.954073,-104.9692781,-104.9842228,-105.0003976,-105.0169443,-105.0337565,-105.049447,-105.0662604,-105.0817146,-105.0969935,-105.1131238,-105.1284952,-105.143627,-105.1588789,-105.1750193,-105.1880595,-105.1897594,-105.1896783,-105.1896348,-105.1896642,-105.1897732,-105.1897205,-105.1897539,-105.1897319,-105.1897388,-105.189236,-105.1892726,-105.1895044,-105.1895732,-105.1895312,-105.1895175,-105.1894584,-105.1894367,-105.1895062,-105.1895223,-105.1895353,-105.1894963,-105.1894963,-105.1895202,-105.1895206,-105.1895366,-105.1895341,-105.1897566,-105.1896717,-105.1894425,-105.1894914,-105.1894547,-105.189499,-105.1895001,-105.18953,-105.1895235,-105.1895696,-105.2021809,-105.2144095,-105.2292596,-105.2463828,-105.2632554,-105.2838143,-105.3041351,-105.3277184,-105.3515004,-105.37217,-105.3926457,-105.4081205,-105.4287241,-105.4501382,-105.4652788,-105.4779239,-105.4876269,-105.4991587,-105.5104087,-105.5219929,-105.5327205,-105.5431393,-105.554408,-105.5659291,-105.5776807,-105.5883706,-105.598466,-105.6004628,-105.6066064,-105.6163808,-105.6275905,-105.6379522,-105.6485825,-105.6600913,-105.6665102,-105.6886761,-105.7141361,-105.7395201,-105.76396,-105.787455,-105.8120677,-105.8370032,-105.8601041,-105.8852946,-105.9123952,-105.938766,-105.9622905,-105.9864583,-106.0129845,-106.0367368,-106.0609451,-106.08388,-106.1057031,-106.1273348,-106.1502963,-106.1713806,-106.1934782,-106.2148998,-106.236981,-106.2546074,-106.2736918,-106.2909539,-106.3109229,-106.3311974,-106.3499938,-106.3707573,-106.3843967,-106.4057939,-106.4234837,-106.4468143,-106.4699163,-106.4900091,-106.5087211,-106.5272397,-106.5459615,-106.5659069,-106.5856367,-106.6022565,-106.6137408,-106.6171446,-106.6266113,-106.6299411,-106.6369225,-106.6445859,-106.6482547,-106.6569724,-106.6721738,-106.6888226,-106.7070355,-106.7214987,-106.7385995,-106.7558941,-106.7704583,-106.7833569,-106.7870144,-106.784347,-106.783874,-106.784347,-106.784347,-106.784347,-106.784347,-106.784347,-106.7843476,-106.7843512,-106.7843455,-106.7843132,-106.7842909,-106.7843028,-106.7842815,-106.7842628,-106.7842693,-106.7842865,-106.7844497,-106.7843801,-106.7877795,-106.7904228,-106.810139,-106.8325785,-106.8547319,-106.8729047,-106.8910003,-106.9114444,-106.9304484,-106.9533564,-106.9763709,-106.998286,-107.0195949,-107.0377519,-107.0581303,-107.077736,-107.0973079,-107.1193144,-107.1408669,-107.165828,-107.1892484,-107.2120041,-107.2369223,-107.263826,-107.2893396,-107.3104488,-107.3282804,-107.3398191,-107.3632887,-107.3849161,-107.4080329,-107.4347263,-107.4606316,-107.4836605,-107.5069921,-107.5248612,-107.5410788,-107.5647503,-107.5913347,-107.6193395,-107.6446368,-107.665553,-107.6881254,-107.7109335,-107.7365035,-107.7588747,-107.7780265,-107.7979628,-107.8163515,-107.8367367,-107.8522361,-107.8728431,-107.8952501,-107.9017571,-107.9177444,-107.9341535,-107.9487997,-107.962748,-107.9784453,-107.9860025,-107.9901525,-107.9973378,-108.0099702,-108.0330681,-108.0537143,-108.0763233,-108.1007556,-108.1231595,-108.1473207,-108.1726033,-108.1966017,-108.2195331,-108.2431039,-108.2651444,-108.2871105,-108.3084434,-108.3277466,-108.3475778,-108.3662884,-108.3848992,-108.4054609,-108.4249344,-108.4506148,-108.4754274,-108.4983722,-108.5214713,-108.5442841,-108.566027,-108.5892538,-108.6138492,-108.6368058,-108.6586201,-108.6692899,-108.6798984,-108.6960385,-108.708639,-108.7088292,-108.7084008,-108.7084919,-108.708639,-108.7085743,-108.7086344,-108.7086269,-108.7085813,-108.7086513,-108.7085506,-108.7084987,-108.7085236,-108.7085372,-108.708529,-108.7085245,-108.7085763,-108.7084913,-108.7085179,-108.7083725,-108.7083491,-108.7084045,-108.7085246,-108.7083672,-108.7083338,-108.7083338,-108.7083338,-108.7083338,-108.7083338,-108.708365,-108.708365,-108.7083642,-108.7083646,-108.7084047,-108.7083713,-108.7083572,-108.7083419,-108.7086241,-108.7090767,-108.7084779,-108.7121336,-108.7199608,-108.7198517,-108.71987,-108.7199608,-108.7199608,-108.7199417,-108.7197694,-108.7220069,-108.7226758,-108.727051,-108.7431752,-108.7627521,-108.7833931,-108.8046059,-108.8253687,-108.8408765,-108.8632394,-108.8868336,-108.9091483,-108.9290446,-108.9466536,-108.9624511,-108.9813406,-108.9972173,-109.008916,-109.0268054,-109.0444331,-109.0566354,-109.0694042,-109.0843392,-109.1043799,-109.1264349,-109.1471803,-109.1675497,-109.1896357,-109.2099664,-109.2323404,-109.253031,-109.270439,-109.2858316,-109.3029523,-109.3194012,-109.3374409,-109.360508,-109.3824308,-109.4040486,-109.4256762,-109.4355546,-109.4332728,-109.4356427,-109.4356485,-109.4359636,-109.4482559,-109.4683685,-109.4866915,-109.5049764,-109.5231838,-109.5430148,-109.5668214,-109.5894389,-109.6098346,-109.6319443,-109.6548452,-109.6767561,-109.6981361,-109.7201402,-109.7413494,-109.7638727,-109.7850705,-109.8066882,-109.8265821,-109.8476253,-109.870105,-109.895343,-109.9215661,-109.9477268,-109.9717778,-109.9965851,-110.020602,-110.0450421,-110.0694705,-110.0919512,-110.109448,-110.1267058,-110.1366769,-110.1549151,-110.1795649,-110.2025611,-110.2259237,-110.2471948,-110.2637365,-110.2787473,-110.2972281,-110.3167429,-110.3399636,-110.3643883,-110.388822,-110.4151499,-110.4407725,-110.465612,-110.4889228,-110.5120145,-110.5355047,-110.5585834,-110.580425,-110.6026882,-110.6246409,-110.6461984,-110.6670588,-110.682879,-110.696588,-110.7168515,-110.7381446,-110.7595957,-110.7803991,-110.8016346,-110.8247808,-110.8461376,-110.8651937,-110.8846442,-110.9039787,-110.9241769,-110.9438851,-110.9655005,-110.9858347,-111.0059991,-111.0273753,-111.0483255,-111.0683291,-111.0892901,-111.110163,-111.1329721,-111.1553572,-111.1788029,-111.1991014,-111.2216992,-111.242191,-111.2640047,-111.2844899,-111.3053813,-111.3266125,-111.3474504,-111.3690012,-111.3898755,-111.4101438,-111.431626,-111.4554012,-111.4769146,-111.4997985,-111.5203655,-111.5418187,-111.5629336,-111.5812691,-111.5877524,-111.5953976,-111.5968955,-111.6042783],"lat":[33.8465853,33.8361607,33.8283154,33.8185757,33.8086421,33.7970326,33.7805263,33.7672676,33.755394,33.7437364,33.7266033,33.7120551,33.6977384,33.6854827,33.6724931,33.6614919,33.6505909,33.6382219,33.6206107,33.6188275,33.6017875,33.5894309,33.575587,33.5612994,33.551666,33.5419701,33.5307047,33.5196752,33.5025841,33.4868779,33.4695842,33.4529994,33.4410196,33.4307704,33.4164157,33.400236,33.3845295,33.367116,33.3473453,33.329622,33.3141708,33.2946076,33.2756129,33.2570992,33.2388582,33.2211068,33.2070114,33.1947363,33.1800601,33.1635535,33.1469295,33.1313731,33.1133854,33.0953763,33.0804292,33.0661186,33.0536296,33.0401393,33.0241776,33.0100232,32.9975247,32.984959,32.9766727,32.9661492,32.9520121,32.9343297,32.9153437,32.8990072,32.8830232,32.8685804,32.8535169,32.8390878,32.8251834,32.8092655,32.7935376,32.7775912,32.761054,32.7444772,32.7263163,32.7074977,32.6889266,32.6724289,32.655765,32.6396942,32.6307417,32.62115,32.6111249,32.6023451,32.5912678,32.5778347,32.566639,32.5567551,32.5458052,32.5357867,32.5268961,32.5138636,32.5051784,32.4927251,32.4830665,32.4761401,32.472994,32.4659154,32.4543746,32.4479079,32.4456109,32.4450559,32.4421467,32.4368088,32.4369081,32.4282755,32.4253472,32.417796,32.4046326,32.3937649,32.383276,32.3772266,32.3708433,32.368239,32.3663068,32.3681836,32.3674677,32.3623099,32.3620472,32.3633132,32.3601972,32.3625554,32.3656225,32.3679243,32.365449,32.3490366,32.3348526,32.3281331,32.328181,32.3282387,32.328219,32.3281521,32.3281942,32.3283146,32.3284652,32.3284945,32.3284747,32.3285068,32.3284623,32.3284699,32.3283168,32.3284881,32.3282939,32.3283059,32.3284885,32.3283173,32.328255,32.3282621,32.3280175,32.3283076,32.3228458,32.3025838,32.2837481,32.2660126,32.2490936,32.2318429,32.2169014,32.2000606,32.181882,32.1638748,32.145883,32.1284689,32.1106098,32.0933267,32.0732255,32.0565843,32.0388402,32.0210906,32.0014736,31.9819484,31.9615367,31.94599,31.9284032,31.9098954,31.8919927,31.8740803,31.8587958,31.8456354,31.8275285,31.8072821,31.7872142,31.7708241,31.7520598,31.7338749,31.7160622,31.6990567,31.685201,31.6683284,31.6502702,31.6339555,31.6177417,31.6021115,31.5862065,31.5722019,31.5591425,31.5468064,31.5334551,31.5170671,31.5010555,31.4857736,31.4703785,31.4530374,31.4368718,31.4246471,31.4100812,31.394028,31.3774742,31.3629033,31.3511947,31.3421016,31.3316287,31.3188693,31.3076475,31.2942295,31.2793378,31.2651871,31.2513789,31.24066,31.2302515,31.2176633,31.202361,31.1876348,31.1727007,31.1615484,31.1514874,31.1420276,31.1317233,31.1210225,31.1109729,31.1047457,31.0951692,31.0828245,31.0691315,31.061016,31.0500195,31.0412343,31.0337267,31.0214083,31.0091086,30.9958549,30.98203,30.9725589,30.9655336,30.961153,30.9583572,30.9536361,30.9520923,30.946395,30.9410888,30.9349072,30.928652,30.9189927,30.9095054,30.905613,30.8946628,30.8835377,30.8722132,30.8603503,30.8421501,30.8246759,30.8062728,30.7899996,30.7746541,30.7557289,30.7410989,30.7278948,30.7088952,30.6892435,30.6709399,30.6520902,30.6339786,30.622899,30.6112068,30.5984575,30.5952165,30.5968347,30.5947506,30.5945862,30.5946134,30.593956,30.5942222,30.5953955,30.5953997,30.5953938,30.5942057,30.5944558,30.595026,30.5949843,30.5952165,30.5966323,30.586948,30.5760961,30.5650693,30.5534265,30.5438065,30.5351421,30.5256766,30.5145257,30.5057563,30.4990393,30.4948295,30.4888101,30.4806684,30.4719487,30.4635727,30.4592954,30.4574283,30.4554239,30.4462839,30.4397106,30.4384038,30.4381834,30.4379877,30.4371161,30.4348084,30.4328351,30.4358939,30.4442478,30.4474018,30.4554281,30.458571,30.4545417,30.4543823,30.4542241,30.4540025,30.4476636,30.4521596,30.4607795,30.4580429,30.4494179,30.4452661,30.4414173,30.4375919,30.4315039,30.4261591,30.4236737,30.4187226,30.4172202,30.4116514,30.4044444,30.403439,30.4040394,30.4006194,30.3902237,30.382794,30.3757163,30.3689249,30.3621521,30.3561502,30.3503511,30.3446993,30.3389576,30.333219,30.3333054,30.3273871,30.3210271,30.314124,30.30707,30.3021601,30.2974261,30.2975609,30.2989761,30.3045912,30.2907077,30.2724161,30.2553238,30.236162,30.2209636,30.2060746,30.1909248,30.1756789,30.1603898,30.1453435,30.1279953,30.1126541,30.0977123,30.0822151,30.0674338,30.0559491,30.0492333,30.0483896,30.0481172,30.0486619,30.0483953,30.0493447,30.0486958,30.0487032,30.0489771,30.0488432,30.0488832,30.0488515,30.0489484,30.0488609,30.0491397,30.0486922,30.0485854,30.0486399,30.0484413,30.0475104,30.0477322,30.0477151,30.0476216,30.0485587,30.0425982,30.033528,30.0274905,30.0179842,30.0059231,30.0024907,29.9910691,29.9782112,29.96631,29.9645202,29.9614949,29.9597695,29.9561512,29.9588282,29.9578756,29.9572829,29.9569766,29.9564419,29.956197,29.9569818,29.9578915,29.958136,29.9578768,29.9576923,29.9570057,29.9567951,29.9576175,29.9575051,29.9566267,29.9566282,29.9551868,29.9550549,29.955944,29.9571275,29.9567951,29.9593109,29.9620029,29.960799,29.9615694,29.9621612,29.9614436,29.9620029,29.9574772,29.959868,29.959701,29.9591854,29.9589734,29.9584065,29.9579042,29.9574824,29.9590051,29.9563931,29.957031,29.9565776,29.9563484,29.95623,29.9562698,29.9562665,29.9562579,29.9560295,29.9562264,29.9566011,29.9563931,29.9573154,29.9579891,29.9596762,29.9633068,29.9681582,29.9729652,29.9794238,29.9899345,30.0015705,30.0056644,30.0180968,30.0277624,30.0348076,30.0437517,30.044553,30.0482173,30.0488184,30.0481775,30.0485714,30.0488577,30.0488991,30.0483757,30.0490243,30.0489821,30.0489226,30.0491197,30.048945,30.0488652,30.048923,30.048872,30.0489176,30.0488804,30.0489307,30.0488966,30.0489278,30.0491186,30.0490468,30.0488489,30.0488619,30.0489528,30.0488882,30.0488068,30.0488706,30.0488852,30.0490002,30.0489248,30.0487611,30.0488768,30.0488171,30.0491572,30.0488308,30.0484679,30.0489697,30.0484701,30.0490594,30.0490268,30.049002,30.0492231,30.04832,30.0486199,30.0485211,30.0486766,30.04851,30.0485164,30.0485207,30.0485315,30.0485426,30.0486791,30.0488184,30.0466457,30.0457894,30.053524,30.0513113,30.0330897,30.0158572,30.0027887,29.9876518,29.9716765,29.9576357,29.9494325,29.9429562,29.9372376,29.9406198,29.9447873,29.9447244,29.9447195,29.9455162,29.9463288,29.9419702,29.9418763,29.9418411,29.9417632,29.9408523,29.9401584,29.9419311,29.9419878,29.9423854,29.9427192,29.9431043,29.9421209,29.942002,29.9430796,29.9422869,29.9418971,29.9419082,29.9418152,29.9420659,29.941895,29.9418865,29.9418865,29.942002,29.9449369,29.9501731,29.9578683,29.9613603,29.9646362,29.966494,29.9691236,29.9697512,29.9716122,29.9738942,29.9800474,29.9904125,29.9917045,29.9921273,29.9939539,29.9957089,29.9967826,29.9976885,29.9988265,30.0008335,30.008163,30.0095047,30.0082292,30.0067708,30.0088306,30.0194187,30.0306567,30.0414135,30.0529394,30.0639916,30.075206,30.0823303,30.0888533,30.0950689,30.1018521,30.107986,30.1102461,30.1122893,30.1143561,30.1163727,30.1184716,30.1208097,30.1231064,30.1264204,30.1336406,30.1405891,30.1475801,30.151914,30.1557399,30.1622492,30.1689298,30.1772475,30.187719,30.1972445,30.2105928,30.2275046,30.2442869,30.2632523,30.2830125,30.3041545,30.3222978,30.3382712,30.3540899,30.3712223,30.3833788,30.394535,30.4080512,30.4190201,30.4223517,30.4232489,30.4236348,30.424783,30.4272611,30.4384984,30.4394988,30.4405393,30.445572,30.4494212,30.4536966,30.4524923,30.4512944,30.4465134,30.4409137,30.4353813,30.4298946,30.4225949,30.4168324,30.4114911,30.4057936,30.3997036,30.3939256,30.3884027,30.3824092,30.376519,30.370966,30.3656092,30.3608347,30.3552631,30.3500071,30.3447489,30.3398202,30.3347094,30.3290675,30.3239067,30.3192156,30.316481,30.3161281,30.3164817,30.3164817,30.316481,30.3164848,30.3164925,30.3164799,30.3166402,30.3167719,30.3167404,30.3168353,30.3166172,30.3164813,30.3164633,30.3164701,30.3164606,30.3164489,30.3164493,30.316496,30.3164746,30.316627,30.3167314,30.3167313,30.3165209,30.316527,30.3165837,30.3165775,30.3165652,30.316524,30.3165701,30.3165512,30.316569,30.3165486,30.3165732,30.3165523,30.3155591,30.3119713,30.3065294,30.3003064,30.2939645,30.2845527,30.2771102,30.2708426,30.2635503,30.2549325,30.2474187,30.2471289,30.2472771,30.2474158,30.2475565,30.2477364,30.2478235,30.2479346,30.2504388,30.2525202,30.252378,30.2467353,30.240019,30.2357022,30.2357659,30.2358427,30.2360391,30.2361764,30.2339539,30.2310425,30.2315196,30.2321887,30.2363777,30.2364564,30.2365462,30.2415237,30.2468031,30.246761,30.2466271,30.2469025,30.2479421,30.2474105,30.2473069,30.2471401,30.2468592,30.2467995,30.2467505,30.2466962,30.2467297,30.2466341,30.2467456,30.2497215,30.2496946,30.247973,30.2477934,30.2477939,30.2476477,30.2440969,30.2456995,30.246735,30.2362666,30.2359139,30.2372353,30.2371048,30.237541,30.2314602,30.2239118,30.2163161,30.2161424,30.2159036,30.2159614,30.2140834,30.2100752,30.2057801,30.2017682,30.197492,30.1931017,30.1886284,30.1874868,30.1860665,30.1875058,30.1877115,30.1874878,30.187535,30.1876029,30.1875639,30.1875872,30.1875701,30.1874138,30.1875686,30.1877636,30.1877565,30.1877457,30.1877457,30.1878483,30.1877912,30.1875657,30.1875636,30.1875651,30.187591,30.1875951,30.1873983,30.1875739,30.1823432,30.1744131,30.1657838,30.1566318,30.1486442,30.1401289,30.1319062,30.1234119,30.1187278,30.1214583,30.1214864,30.1172225,30.1147067,30.1218259,30.1299332,30.1301227,30.1310018,30.1304445,30.1297697,30.1314254,30.1358468,30.1269188,30.1145907,30.1012817,30.0949458,30.0963041,30.0961663,30.0841568,30.0670281,30.0537339,30.0422234,30.0284751,30.0153574,30.0011909,29.9890124,29.9874866,29.989025,29.9890239,29.9890124,29.9890124,29.9890124,29.9890109,29.9891113,29.9891133,29.989034,29.9890386,29.9889321,29.9889256,29.9874489,29.9769762,29.9621112,29.9477574,29.9357698,29.9233092,29.9080018,29.8964045,29.8829088,29.8728625,29.8599723,29.8447456,29.8289724,29.8273439,29.8271901,29.8289584,29.8308363,29.8325583,29.8343155,29.8361249,29.8377596,29.8386866,29.8395933,29.8404937,29.8408012,29.8401336,29.8393227,29.8389926,29.8366096,29.8321052,29.8287807,29.8265652,29.8244758,29.8225147,29.8214048,29.8131636,29.808884,29.8044727,29.8006351,29.7975388,29.7905128,29.7951881,29.7901789,29.7828702,29.7766609,29.7714946,29.7708304,29.7715225,29.7704947,29.773934,29.7748058,29.778008,29.7755132,29.7743993,29.7691574,29.768883,29.7712489,29.778919,29.7766684,29.7775736,29.7785306,29.7828751,29.7840308,29.7845221,29.784567,29.784712,29.7847984,29.7849007,29.785005,29.7850723,29.7851231,29.7851504,29.7851202,29.7853172,29.7853951,29.7853823,29.7854904,29.7856053,29.7793483,29.7774685,29.7775085,29.7774571,29.777401,29.7773386,29.7790054,29.7788481,29.7815697,29.7779346,29.7729372,29.7708885,29.7736268,29.7765488,29.7757869,29.768006,29.7613835,29.7635525,29.7607735,29.7572391,29.7543711,29.7514918,29.7475192,29.7423644,29.7377858,29.7326898,29.7281244,29.7236123,29.7188598,29.7162013,29.7127331,29.7050657,29.6980038,29.6924337,29.6937858,29.6936303,29.6934933,29.6923798,29.6909907,29.6895921,29.6886854,29.691855,29.6923799,29.6920719,29.6904329,29.68872,29.6925165,29.6965352,29.6960631,29.6952933,29.694561,29.6951115,29.6952926,29.6952938,29.6953162,29.6952929,29.6953252,29.694988,29.6951832,29.6949994,29.6950198,29.6950108,29.6950055,29.6949877,29.6950163,29.6949249,29.6949961,29.6949708,29.6950051,29.6949905,29.694985,29.6949995,29.6949799,29.6949923,29.6949923,29.6949583,29.6949834,29.6939309,29.6950355,29.690861,29.6895042,29.6901981,29.6915756,29.6937939,29.6976423,29.6978369,29.6971457,29.6965373,29.6960463,29.6920662,29.6923088,29.6925511,29.6909345,29.6812728,29.6703971,29.6680619,29.666053,29.6638229,29.661334,29.6580477,29.6554521,29.6519818,29.6499565,29.6515075,29.6529857,29.6542449,29.6522375,29.6484697,29.6502838,29.6519585,29.6471379,29.6414476,29.6355497,29.6295354,29.6234628,29.6166257,29.6150693,29.6147526,29.6096299,29.6044961,29.5995464,29.5995156,29.5994571,29.5887632,29.5759157,29.5638083,29.5490237,29.5421814,29.5351037,29.5293553,29.5215814,29.5139625,29.5066623,29.4994738,29.4921952,29.4858184,29.4791777,29.4722598,29.4657127,29.4601318,29.4538347,29.4471473,29.4398762,29.4333161,29.4273955,29.4130703,29.4068638,29.4029223,29.4028277,29.4018215,29.4027972,29.4029548,29.4029489,29.4029915,29.4029375,29.4029872,29.4029251,29.40293,29.4029577,29.4029964,29.4030033,29.4029394,29.4028663,29.4028159,29.4029047,29.4029735,29.402971,29.402975,29.4030331,29.4029135,29.4029811,29.4030115,29.4030312,29.402827,29.4028474,29.4027223,29.4029174,29.402901,29.4029499,29.4028201,29.4027942,29.4027911,29.4028048,29.4028067,29.4027969,29.4027959,29.4029773,29.4028277,29.4028592,29.4018061,29.3971059,29.4091111,29.4198411,29.4215708,29.4215708,29.4226959,29.4228618,29.4233574,29.4238629,29.4238629,29.4228989,29.4229368,29.4232088,29.4224398,29.4236948,29.4239438,29.4242142,29.4245528,29.4249606,29.4250825,29.4252131,29.4237545,29.4259096,29.4255609,29.4257454,29.4257128,29.425811,29.4260218,29.4261176,29.4263047,29.4262991,29.4257508,29.4260027,29.4256512,29.4259096,29.4247173,29.4249482,29.424958,29.4236904,29.4231377,29.4247173,29.4228447,29.4228136,29.4228447,29.4228543,29.4223451,29.4214654,29.4244437,29.4383992,29.4375824,29.4346847,29.4436294,29.4598139,29.4764605,29.4848404,29.4994078,29.5183379,29.5340672,29.5470294,29.5640557,29.582609,29.6000422,29.6160879,29.6339853,29.6499316,29.6671681,29.6855317,29.703233,29.7195113,29.7331239,29.7479716,29.7621824,29.7747121,29.7871975,29.8061248,29.8246543,29.8378831,29.8553474,29.8740292,29.8888496,29.9050816,29.9166312,29.9275443,29.9436809,29.9604115,29.9785062,29.987382,30.0001081,30.0144879,30.030925,30.0436865,30.0534454,30.0563665,30.0678059,30.0698979,30.0705143,30.0729971,30.0848332,30.0953876,30.1094422,30.1183902,30.1288541,30.1462182,30.1635141,30.1718236,30.1798222,30.1851348,30.1910586,30.1981519,30.2061596,30.2170941,30.2311212,30.2455195,30.2562995,30.2667647,30.2792336,30.2910942,30.3041594,30.3185659,30.3368985,30.3576245,30.376199,30.3940374,30.4028829,30.411977,30.4261489,30.4326427,30.4475816,30.4661494,30.4853776,30.4971405,30.5093723,30.5078481,30.5093341,30.5092842,30.509353,30.5093762,30.5093762,30.5093762,30.5091158,30.5091379,30.509263,30.5089787,30.5091819,30.5091269,30.5091004,30.5090255,30.5090199,30.5091519,30.5090295,30.5090221,30.5090031,30.509008,30.5090656,30.5091015,30.5090948,30.5090794,30.5090517,30.5090143,30.5090114,30.5090218,30.5090334,30.5091114,30.5091279,30.509153,30.5090949,30.50916,30.5091342,30.5089669,30.5090961,30.5091137,30.5091224,30.5091075,30.5090916,30.5095308,30.5155731,30.5206869,30.5263948,30.5257386,30.521266,30.514133,30.5011709,30.502665,30.499565,30.4949795,30.4956101,30.4872253,30.4831199,30.4806895,30.4741044,30.4676042,30.4602505,30.4540554,30.4464342,30.4441357,30.4469813,30.4536219,30.4623732,30.4721759,30.4820104,30.4905107,30.4997449,30.5093935,30.5195377,30.5306249,30.5414408,30.5501126,30.5581459,30.5647478,30.56817,30.5714049,30.5737024,30.5759798,30.5782051,30.5862042,30.5905234,30.5983222,30.6084548,30.6158628,30.6159177,30.6159177,30.6159177,30.6159442,30.615945,30.6159507,30.6183986,30.6217144,30.6203113,30.6213548,30.6279375,30.6344472,30.6413469,30.647875,30.6594888,30.6647679,30.669116,30.6742839,30.6799182,30.686052,30.6920937,30.6974189,30.7032523,30.7090121,30.7117672,30.7123651,30.7084867,30.7059429,30.7008529,30.6962079,30.6926178,30.6837017,30.6775566,30.6815373,30.6875281,30.6897695,30.6926688,30.6971386,30.7012187,30.7081393,30.7225587,30.7279736,30.730748,30.7338141,30.7346181,30.7377856,30.742201,30.7476341,30.7407991,30.7334443,30.722359,30.7158168,30.7171441,30.7286475,30.7403671,30.7443231,30.7485107,30.7578267,30.7679732,30.7830614,30.7993252,30.8105303,30.8256231,30.8364127,30.846146,30.8576717,30.8691182,30.877842,30.8854459,30.8921306,30.8916212,30.8935258,30.8931056,30.891124,30.8850684,30.8886106,30.8953101,30.8954239,30.8923034,30.8886856,30.8848811,30.8786211,30.8696713,30.8651162,30.8621126,30.8612475,30.8638652,30.8733272,30.8769578,30.8799581,30.8846343,30.8895136,30.8901274,30.8907464,30.8913958,30.8919809,30.8954531,30.9053575,30.9072242,30.9023997,30.9117423,30.9236961,30.9362895,30.9496983,30.9626819,30.9750872,30.9862491,30.9966061,31.0067894,31.0187309,31.0291175,31.0425461,31.0559604,31.0680859,31.0802724,31.0933402,31.1062553,31.1192344,31.1342525,31.1498098,31.1643261,31.1792094,31.1954698,31.2123287,31.2291314,31.2450689,31.2610738,31.2744772,31.2887209,31.3044786,31.3196304,31.3407316,31.359863,31.3757457,31.3896056,31.3990416,31.3989884,31.3990272,31.3990265,31.3990258,31.3989941,31.3990038,31.3986705,31.399015,31.3991125,31.3991288,31.3991378,31.3989533,31.3990051,31.3989983,31.3989849,31.3990383,31.3989704,31.3989657,31.3989891,31.3989848,31.3990038,31.4014409,31.402124,31.4050046,31.411269,31.4223238,31.4317329,31.4443276,31.4605972,31.4747691,31.4887114,31.5046576,31.5193151,31.5338121,31.5477256,31.5613592,31.5786817,31.5947328,31.6087121,31.6269522,31.6416408,31.648432,31.6546877,31.659829,31.6655745,31.6711724,31.6779387,31.6856573,31.6976348,31.7099242,31.7255386,31.7393658,31.7540745,31.7684988,31.7822298,31.7969771,31.8135032,31.8248853,31.8315656,31.8483901,31.8644699,31.8819006,31.894479,31.9081803,31.9220112,31.9358082,31.9529987,31.9696143,31.9847475,31.9984339,32.0095213,32.0192349,32.0296916,32.0436333,32.0576482,32.0704691,32.083139,32.1089903,32.1227531,32.1352155,32.1465673,32.158499,32.1697046,32.1814462,32.1934507,32.2044362,32.2154614,32.2248038,32.2313629,32.2393833,32.2491167,32.2596715,32.2674543,32.2705449,32.2746968,32.2760694,32.2774765,32.2816896,32.2860913,32.2933042,32.3013663,32.3121074,32.3230633,32.3341045,32.3460087,32.3574034,32.3701118,32.3816616,32.3876021,32.3890064,32.3932268,32.39384,32.3950488,32.4019808,32.3996297,32.4000562,32.4017108,32.4019822,32.402006,32.4020007,32.4019826,32.4015237,32.401498,32.4014477,32.401465,32.4013086,32.4015204,32.401475,32.401423,32.4013926,32.4019865,32.401526,32.4014911,32.4015289,32.4015101,32.4015638,32.4014734,32.401478,32.401515,32.4014765,32.4017801,32.4015363,32.3985848,32.3901043,32.3828983,32.3730361,32.3656891,32.3541027,32.3421912,32.3282748,32.313231,32.2968492,32.2798912,32.2627632,32.2454408,32.2287909,32.2113132,32.1978597,32.1851649,32.1759155,32.178348,32.1883302,32.1896225,32.1901942,32.1812458,32.1748631,32.1748539,32.1747882,32.1749049,32.1748616,32.1753629,32.1751983,32.1750785,32.1754145,32.1751511,32.1748699,32.1751541,32.1750228,32.1749224,32.1749417,32.1749555,32.1749415,32.1749182,32.1750095,32.175166,32.1740686,32.1792362,32.1824583,32.192066,32.1919319,32.1875323,32.1807993,32.1750985,32.1804425,32.1933881,32.2068119,32.2215396,32.2386683,32.2570896,32.2755244,32.2938933,32.3123943,32.330629,32.3465337,32.3601542,32.3703024,32.370427,32.3829743,32.3939728,32.3963634,32.4030209,32.4137359,32.4146754,32.4146817,32.4227966,32.4312838,32.4407674,32.4512995,32.4656893,32.4812548,32.4859967,32.4918643,32.5003348,32.5155014,32.5319325,32.5513967,32.5690746,32.585922,32.604545,32.6221628,32.63993,32.6589936,32.6783401,32.6988503,32.718401,32.7390731,32.7589929,32.7802236,32.8002107,32.8181295,32.8321041,32.8421897,32.8465203,32.8594205,32.873199,32.8879281,32.9006235,32.9160909,32.9340374,32.9518378,32.9695445,32.9888458,33.0069707,33.0270578,33.0491246,33.0695959,33.0891425,33.1109744,33.1315089,33.1537521,33.1745248,33.1958054,33.2159867,33.2379765,33.2581503,33.2795075,33.2986757,33.3119484,33.3235671,33.3393592,33.3545015,33.3651651,33.3725843,33.3794427,33.3869677,33.3930092,33.3951118,33.4000425,33.4081553,33.4119601,33.4154804,33.4226033,33.4293714,33.4357546,33.4466682,33.4583673,33.4721752,33.4897897,33.5063839,33.5251106,33.544604,33.564614,33.5843942,33.6011374,33.6183707,33.6348775,33.6530081,33.6721243,33.6906493,33.7108951,33.7297246,33.7481566,33.7690489,33.7878213,33.8090325,33.8308589,33.8510288,33.8723171,33.8939875,33.9138599,33.929162,33.9431777,33.9586869,33.9736239,33.9884392,34.0021118,34.0183205,34.0336234,34.0487774,34.0668403,34.0850521,34.1014219,34.1200188,34.1381324,34.1568966,34.1735717,34.1922368,34.2125463,34.2327343,34.2516862,34.2694625,34.2883671,34.3090363,34.3269202,34.3442642,34.3610804,34.3797262,34.3985789,34.4177165,34.4353859,34.4545089,34.4720834,34.4894228,34.5077363,34.5251559,34.5423189,34.5596154,34.5778869,34.5924974,34.5945248,34.5944867,34.5944934,34.5944991,34.5945109,34.5944907,34.5944748,34.5944854,34.5944891,34.5946518,34.5946711,34.5947363,34.5947038,34.5947789,34.5947491,34.5947497,34.5947625,34.5947545,34.5947586,34.594742,34.5947335,34.5947335,34.5947786,34.5947756,34.5947205,34.5947176,34.5947213,34.5946146,34.5947492,34.594756,34.5947873,34.5947612,34.5947712,34.5947759,34.5948163,34.5946867,34.6017386,34.6016788,34.5958313,34.5891509,34.5896764,34.5888339,34.5917502,34.5966768,34.6047014,34.6149298,34.6262499,34.6405385,34.6444812,34.6487808,34.6514862,34.6590614,34.6754248,34.6952135,34.7144326,34.7342148,34.7525363,34.7703032,34.7895298,34.8091983,34.8292074,34.8474105,34.8646119,34.88414,34.9042143,34.921876,34.9420986,34.9607739,34.9799413,35.000891,35.0088318,35.0099364,35.008398,35.0044774,35.0047459,35.0049589,35.0051372,35.0053809,35.0053601,35.0059824,35.0066964,35.0050424,35.0049261,35.0048397,35.0048197,35.0079094,35.0114751,35.0194762,35.0290767,35.0387478,35.0480979,35.0566035,35.0645309,35.0726382,35.0814756,35.088602,35.0962417,35.1023702,35.1111509,35.113574,35.1021981,35.0954444,35.0829986,35.080734,35.0665656,35.0616827,35.0632863,35.0669839,35.0742183,35.0813559,35.0885385,35.0965258,35.1039106,35.1047132,35.1073164,35.1075969,35.1061973,35.1055435,35.105164,35.105784,35.1063613,35.1065287,35.1050557,35.106196,35.1058121,35.0986265,35.0900263,35.081275,35.0739654,35.0675105,35.0639599,35.0645294,35.0640966,35.0645294,35.0645294,35.0645294,35.0645294,35.0645294,35.0645322,35.0645486,35.0645577,35.0645296,35.0645222,35.0645523,35.0645284,35.064505,35.0645005,35.0645542,35.0634664,35.0644223,35.0652777,35.0640558,35.0592415,35.0558055,35.0523997,35.0488635,35.0448182,35.0401843,35.0358741,35.030635,35.0253887,35.0202859,35.0135096,35.0077361,35.0012449,34.9949984,34.9887588,34.9817781,34.9787718,34.9826159,34.9862387,34.9897118,34.9930999,34.9934584,34.9937824,35.0025274,35.017368,35.0332082,35.0391018,35.029908,35.0265375,35.0271522,35.0302848,35.0368259,35.047355,35.0605923,35.0738915,35.0744572,35.0751699,35.0758735,35.0763587,35.0727691,35.0652964,35.0644247,35.0684066,35.0759623,35.0902105,35.1033375,35.1154314,35.128837,35.1436452,35.1534231,35.1648985,35.18431,35.2018107,35.2190945,35.2345084,35.2490647,35.2654321,35.284429,35.3044611,35.3244826,35.345128,35.3557055,35.3640564,35.3711625,35.3757293,35.3814413,35.3862194,35.3889273,35.3909351,35.3956468,35.4004878,35.4050212,35.4127504,35.4220817,35.4307836,35.4394532,35.4475328,35.4549797,35.464288,35.4773664,35.483616,35.4892465,35.4952292,35.5039893,35.5126304,35.519325,35.5263163,35.5304126,35.5318327,35.5309028,35.5312918,35.5301682,35.5292555,35.5289845,35.5293723,35.5288397,35.5288977,35.5289845,35.5290159,35.5290302,35.5289874,35.5289909,35.5288933,35.5289843,35.528964,35.5289934,35.5290217,35.528932,35.5289492,35.5289703,35.5289723,35.5290658,35.5288293,35.5288409,35.5288004,35.5290036,35.5288503,35.5288727,35.5288727,35.5288727,35.5288727,35.5288727,35.5288419,35.5288419,35.5288452,35.5288557,35.5288365,35.5288345,35.5288391,35.5288479,35.5291518,35.5292278,35.5289354,35.5294794,35.5297754,35.5298036,35.5297781,35.5297754,35.5297754,35.5297666,35.529744,35.5300424,35.5299654,35.5339859,35.5309401,35.5278771,35.5217775,35.5141771,35.5111428,35.4994334,35.4963824,35.4904935,35.4830319,35.4717062,35.4574662,35.4394875,35.4266782,35.4117447,35.3926383,35.377855,35.367649,35.3532386,35.3371731,35.323655,35.3117692,35.302201,35.29322,35.2845946,35.2810577,35.2829158,35.2830549,35.2784036,35.2678001,35.2520653,35.2382046,35.2252827,35.2138626,35.2065143,35.201923,35.197377,35.19283,35.1898783,35.1904123,35.1899125,35.189917,35.1904394,35.1868323,35.1762627,35.1643605,35.1524732,35.1406332,35.1286086,35.1195993,35.1117762,35.1048929,35.1009459,35.0976543,35.0936916,35.0873559,35.0808512,35.0745756,35.0679109,35.0583592,35.0460352,35.0345984,35.0225393,35.0097146,35.0016478,34.9969775,34.9929113,34.9909038,34.9910128,34.9869085,34.9825768,34.9782519,34.9711568,34.9576821,34.9425257,34.9248805,34.913242,34.9085861,34.9063653,34.9091291,34.9145187,34.9253092,34.9385273,34.947186,34.9551148,34.9546357,34.9584739,34.9623448,34.966522,34.9700623,34.9711846,34.9722381,34.9733671,34.9787203,34.9866368,34.9940989,35.0017038,35.0069728,35.010289,35.0159626,35.0271007,35.0396161,35.038473,35.039775,35.0454316,35.0515274,35.0577443,35.0645163,35.0707673,35.0763362,35.0820775,35.0886579,35.0934724,35.0963778,35.0995505,35.1016518,35.1059921,35.1100548,35.1122864,35.1143879,35.1174734,35.1166029,35.1186637,35.1208743,35.1274509,35.1349042,35.1431939,35.1507018,35.1586973,35.1601679,35.1614299,35.1698075,35.178032,35.1865248,35.1949416,35.2026903,35.2018772,35.2025624,35.2020213,35.2062784,35.2097034,35.2146846,35.2186688,35.2179974,35.2210796,35.2159135,35.2150697,35.2113672]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":false,"fillColor":"#03F","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[29.3971059,35.5339859],"lng":[-111.6042783,-84.3051758]},"setView":[[29.4257332714475,-98.4862755390452],18,[]]},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>&nbsp;</p>
<p>The <code>big_long_combined_route</code> object we just made here isn’t a data frame anymore—it’s a list instead. It still works with <code>geom_sf()</code>, but because we collapsed all the points into one line, we lots lots of detail, like timestamps. We can keep some of those details if we use <code>group_by()</code> to separate lines per day (or hour or whatever grouping variable we want). For instance, earlier we created a column called <code>day</code>. Let’s make a separate linestring for each day using <code>group_by()</code> and <code>nest()</code> and <code>map()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine all the points in the day into a connected linestring</span></span>
<span id="cb20-2">daily_routes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_locations <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(day_month) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_cast</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_combine</span>(.), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LINESTRING"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(path) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path"</span>)</span>
<span id="cb20-8">daily_routes</span>
<span id="cb20-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 4 features and 2 fields</span></span>
<span id="cb20-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: LINESTRING</span></span>
<span id="cb20-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb20-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -111.6 ymin: 29.4 xmax: -84.31 ymax: 35.53</span></span>
<span id="cb20-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb20-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 3</span></span>
<span id="cb20-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   day_month [4]</span></span>
<span id="cb20-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   day_month data                                                                                                 path</span></span>
<span id="cb20-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;     &lt;list&gt;                                                                                   &lt;LINESTRING [°]&gt;</span></span>
<span id="cb20-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 June 3    &lt;sf [521 × 19]&gt; (-84.31 33.85, -84.33 33.84, -84.34 33.83, -84.36 33.82, -84.38 33.81, -84.39 33.8, -8...</span></span>
<span id="cb20-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 June 4    &lt;sf [596 × 19]&gt; (-89.96 30.05, -89.96 30.05, -89.96 30.05, -89.96 30.05, -89.96 30.05, -89.96 30.05, -...</span></span>
<span id="cb20-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 June 5    &lt;sf [509 × 19]&gt; (-98.44 29.4, -98.44 29.4, -98.44 29.4, -98.44 29.4, -98.44 29.4, -98.44 29.4, -98.44 ...</span></span>
<span id="cb20-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 June 6    &lt;sf [662 × 19]&gt; (-104.2 32.4, -104.2 32.4, -104.2 32.4, -104.2 32.4, -104.2 32.4, -104.2 32.4, -104.2 ...</span></span></code></pre></div>
</div>
<p>Now we have a data frame with a row per day, and a corresponding path per day too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> daily_routes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> day_month),</span>
<span id="cb21-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb21-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> daily_routes,</span>
<span id="cb21-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> day_month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> day_month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> path),</span>
<span id="cb21-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12345</span>,</span>
<span id="cb21-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, </span>
<span id="cb21-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">box.padding =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb21-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span></span>
<span id="cb21-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb21-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>],</span>
<span id="cb21-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> trip_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip_map</span>()</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/basic-map-linestring-by-day-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="semantic-location-history-1" class="level2">
<h2 class="anchored" data-anchor-id="semantic-location-history-1">Semantic location history</h2>
<p>Working with <code>Records.json</code> is great and fairly straightforward (once we handle all the weird data cleaning issues and time zones!), but we can do even cooler things with the more detailed semantic location history data. As seen earlier, this data is far more complex, with all sorts of nested entries and predicted probabilities of modes of transportation or location stops, so we can’t use the <code>simplifyVector</code> to get a basic data frame. Instead, we need to pull out each of the elements we’re interested in and build our own data frame.</p>
<p>Additionally, the location history file includes both <code>placeVisit</code>s and <code>activitySegment</code>s in the same file, so to make life a little easier, we can filter the data after we read the file to only keep one of the types of events using <code>map()</code></p>
<section id="placevisits" class="level3">
<h3 class="anchored" data-anchor-id="placevisits"><code>placeVisit</code>s</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">place_visits_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_json</span>(</span>
<span id="cb22-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Semantic Location History/2023/2023_JUNE_truncated.json"</span>, </span>
<span id="cb22-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplifyVector =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb22-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the timelineObjects JSON element</span></span>
<span id="cb22-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"timelineObjects"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter the list to only keep placeVisits</span></span>
<span id="cb22-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># { More verbose function-based approach: map(~ .x[["placeVisit"]]) }</span></span>
<span id="cb22-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Neat selection-based approach with just the name!</span></span>
<span id="cb22-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeVisit"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Discard all the empty elements (i.e. the activitySegments)</span></span>
<span id="cb22-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compact</span>()</span></code></pre></div>
</div>
<p>For this post, I’m interested in looking at all the places we stopped for gas and bathroom breaks along the way. I’m not interested in hotel stops or tourist stops. I want to know how long we typically stopped for breaks. There are 24 entries in this list…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(place_visits_raw)</span>
<span id="cb23-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 24</span></span></code></pre></div>
</div>
<p>…but not all of them are gas or bathroom breaks, so I manually looked through the data and copied the location IDs of the stops that weren’t gas stops.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">not_driving_stops <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb24-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJnwDSTcsDnogRLyt_lqVprLY"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hotel in New Orleans, LA</span></span>
<span id="cb24-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJgcNDAhKmIIYRRA4mio_7VgE"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parking in the French Quarter</span></span>
<span id="cb24-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJv30_Xw-mIIYRpt26QbLBh58"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Louis Armstrong Park</span></span>
<span id="cb24-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ59n6fW8dnogRWi-5N6olcyU"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chalmette Battlefield</span></span>
<span id="cb24-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ_7z4c1_2XIYR6b9p0NvEiVE"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hotel in San Antonio, TX</span></span>
<span id="cb24-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJX4k2TVVfXIYRIsTnhA-P-Rc"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The Alamo</span></span>
<span id="cb24-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJAdu5Qad544YRhyJT8qzimi4"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hotel in Carlsbad, NM</span></span>
<span id="cb24-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJW9e4xBN544YRvbI7vfc91G4"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Carlsbad Caverns</span></span>
<span id="cb24-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJERiZZMWOLYcRQbo78w80s34"</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hotel in Flagstaff, AZ</span></span>
<span id="cb24-11">)</span></code></pre></div>
</div>
<p>Currently, <code>place_visits_raw</code> is a huge nested list with the complete place information from Google. All we care about is a small subset of that data, so we can take the list, extract the parts we need, and build a data frame with <code>map() %&gt;% list_rbind()</code> (the recommended replacement for {purrr}’s now-superseded <code>map_df()</code>). Like we did with <code>Records.json</code>, we’ll also figure out the time zone for each point and make all the timestamps be local.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Computer friendly timezones like America/New_York work for computers, but I</span></span>
<span id="cb25-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># want to sometimes show them as US-standard abbreviations like EDT (Eastern</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Daylight Time), so here's a little lookup table we can use to join to bigger</span></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># datasets for better abbreviations</span></span>
<span id="cb25-5">tz_abbreviations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb25-6">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>tz,                <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>tz_abb,</span>
<span id="cb25-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/New_York"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EDT"</span>,</span>
<span id="cb25-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Chicago"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CDT"</span>,</span>
<span id="cb25-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Denver"</span>,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MDT"</span>,</span>
<span id="cb25-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"America/Phoenix"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MST"</span></span>
<span id="cb25-11">)</span>
<span id="cb25-12"></span>
<span id="cb25-13">place_visits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> place_visits_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract parts of the nested list</span></span>
<span id="cb25-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb25-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb25-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>placeId,</span>
<span id="cb25-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">latitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>latitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb25-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">longitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>longitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb25-20">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name,</span>
<span id="cb25-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">address =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>address,</span>
<span id="cb25-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">startTimestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(.x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>startTimestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>),</span>
<span id="cb25-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">endTimestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(.x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>endTimestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)</span>
<span id="cb25-24">    )</span>
<span id="cb25-25">  }) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list_rbind</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the duration of the stop</span></span>
<span id="cb25-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> endTimestamp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> startTimestamp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make an indicator for if the stop was a gas or bathroom break</span></span>
<span id="cb25-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">driving_stop =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> not_driving_stops)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a geometry column</span></span>
<span id="cb25-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"longitudeE7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latitudeE7"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a column with the time zone for each point</span></span>
<span id="cb25-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tz_lookup</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accurate"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a version of the timestamp in local time, but in UTC</span></span>
<span id="cb25-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb25-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">startTimestamp_local =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(startTimestamp, tz), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>),</span>
<span id="cb25-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">endTimestamp_local =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(endTimestamp, tz), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)</span>
<span id="cb25-40">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-42">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a column for direction</span></span>
<span id="cb25-43">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In the real data, I have values for "There" (the trip from Atlanta to Utah)</span></span>
<span id="cb25-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and "Back again" (the trip from Utah to Atlanta)</span></span>
<span id="cb25-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-46">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add some helper columns for filtering, grouping, etc.</span></span>
<span id="cb25-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb25-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(startTimestamp_local),</span>
<span id="cb25-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">month</span>(startTimestamp_local),</span>
<span id="cb25-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(startTimestamp_local)</span>
<span id="cb25-51">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb25-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(startTimestamp_local, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%B %e"</span>),</span>
<span id="cb25-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># With %e, there's a leading space for single-digit numbers, so we remove</span></span>
<span id="cb25-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># any double spaces and replace them with single spaces </span></span>
<span id="cb25-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (e.g., "June  3" becomes "June 3")</span></span>
<span id="cb25-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(day_month, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb25-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(day_month)</span>
<span id="cb25-59">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-60">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bring in abbreviated time zones</span></span>
<span id="cb25-61">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(tz_abbreviations, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(tz))</span>
<span id="cb25-62">place_visits</span>
<span id="cb25-63"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 24 features and 16 fields</span></span>
<span id="cb25-64"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb25-65"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb25-66"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -111.6 ymin: 29.4 xmax: -86.34 ymax: 35.53</span></span>
<span id="cb25-67"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb25-68"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 24 × 17</span></span>
<span id="cb25-69"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    id                          name                            address                                            startTimestamp      endTimestamp        duration    driving_stop       geometry tz              startTimestamp_local endTimestamp_local  direction  year month   day day_month tz_abb</span></span>
<span id="cb25-70"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;                       &lt;chr&gt;                           &lt;chr&gt;                                              &lt;dttm&gt;              &lt;dttm&gt;              &lt;drtn&gt;      &lt;lgl&gt;           &lt;POINT [°]&gt; &lt;chr&gt;           &lt;dttm&gt;               &lt;dttm&gt;              &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;     &lt;chr&gt; </span></span>
<span id="cb25-71"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 ChIJQ0NgzsqAjogRISqopW4DZMc Chevron                         1030 W South Blvd, Montgomery, AL 36105, USA       2023-06-03 14:27:23 2023-06-03 14:50:24  23.02 mins TRUE         (-86.34 32.33) America/Chicago 2023-06-03 09:27:23  2023-06-03 09:50:24 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-72"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 ChIJMU2weFNKmogRNvJ9RoXN_Vk Walmart Supercenter             5245 Rangeline Service Rd, Mobile, AL 36619, USA   2023-06-03 17:12:34 2023-06-03 17:59:38  47.07 mins TRUE         (-88.16 30.59) America/Chicago 2023-06-03 12:12:34  2023-06-03 12:59:38 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-73"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 ChIJnwDSTcsDnogRLyt_lqVprLY Comfort Suites New Orleans East 7051 Bullard Ave, New Orleans, LA 70128, USA       2023-06-03 19:45:22 2023-06-03 20:52:17  66.90 mins FALSE        (-89.96 30.05) America/Chicago 2023-06-03 14:45:22  2023-06-03 15:52:17 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-74"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 ChIJgcNDAhKmIIYRRA4mio_7VgE P149 - Chartres St Garage       537 Chartres St, New Orleans, LA 70130, USA        2023-06-03 21:08:30 2023-06-03 22:31:08  82.64 mins FALSE        (-90.06 29.96) America/Chicago 2023-06-03 16:08:30  2023-06-03 17:31:08 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-75"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 ChIJv30_Xw-mIIYRpt26QbLBh58 Louis Armstrong Park            701 N Rampart St, New Orleans, LA 70116, USA       2023-06-03 22:44:22 2023-06-03 22:59:51  15.48 mins FALSE        (-90.07 29.96) America/Chicago 2023-06-03 17:44:22  2023-06-03 17:59:51 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-76"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 ChIJgcNDAhKmIIYRRA4mio_7VgE P149 - Chartres St Garage       537 Chartres St, New Orleans, LA 70130, USA        2023-06-03 23:10:10 2023-06-03 23:19:40   9.50 mins FALSE        (-90.06 29.96) America/Chicago 2023-06-03 18:10:10  2023-06-03 18:19:40 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-77"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 ChIJnwDSTcsDnogRLyt_lqVprLY Comfort Suites New Orleans East 7051 Bullard Ave, New Orleans, LA 70128, USA       2023-06-03 23:37:50 2023-06-04 14:01:02 863.20 mins FALSE        (-89.96 30.05) America/Chicago 2023-06-03 18:37:50  2023-06-04 09:01:02 There      2023     6     3 June 3    CDT   </span></span>
<span id="cb25-78"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 ChIJ59n6fW8dnogRWi-5N6olcyU Chalmette Battlefield           1 Battlefield Rd, Chalmette, LA 70043, USA         2023-06-04 14:24:06 2023-06-04 15:54:20  90.25 mins FALSE        (-89.99 29.94) America/Chicago 2023-06-04 09:24:06  2023-06-04 10:54:20 There      2023     6     4 June 4    CDT   </span></span>
<span id="cb25-79"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 ChIJTZPVqVh9JIYRx10_jt-c4LE Exxon                           2939 Grand Point Hwy, Breaux Bridge, LA 70517, USA 2023-06-04 17:54:09 2023-06-04 18:31:35  37.45 mins TRUE         (-91.83 30.32) America/Chicago 2023-06-04 12:54:09  2023-06-04 13:31:35 There      2023     6     4 June 4    CDT   </span></span>
<span id="cb25-80"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 ChIJFWLuzkT3O4YRBX2lqNQDF4w Exxon                           1410 Gum Cove Rd, Vinton, LA 70668, USA            2023-06-04 20:02:26 2023-06-04 20:26:48  24.37 mins TRUE         (-93.57 30.19) America/Chicago 2023-06-04 15:02:26  2023-06-04 15:26:48 There      2023     6     4 June 4    CDT   </span></span>
<span id="cb25-81"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 14 more rows</span></span></code></pre></div>
</div>
</section>
<section id="activitysegments" class="level3">
<h3 class="anchored" data-anchor-id="activitysegments"><code>activitySegment</code>s</h3>
<p>We’ll go through the same data loading and cleaning process for the <code>activitySegments</code>. It’s a little more complicated because we have pairs of timestamps and locations (start/end times, start/end locations), and the times and locations can be in different time zones, so we need to do the <code>group_by(tz)</code> trick twice with <code>group_by(tz_start)</code> and <code>group_by(tz_end)</code>. We also need to get two geometry columns, which requires a little data trickery, as you’ll see below:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">activity_segments_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_json</span>(</span>
<span id="cb26-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Semantic Location History/2023/2023_JUNE_truncated.json"</span>, </span>
<span id="cb26-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplifyVector =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb26-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the timelineObjects JSON element</span></span>
<span id="cb26-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"timelineObjects"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter the list to only keep activitySegments</span></span>
<span id="cb26-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"activitySegment"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Discard all the empty elements (i.e. the placeVisits)</span></span>
<span id="cb26-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compact</span>()</span>
<span id="cb26-11"></span>
<span id="cb26-12">activity_segments_not_clean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> activity_segments_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract parts of the nested list</span></span>
<span id="cb26-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb26-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb26-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_m =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>distance,</span>
<span id="cb26-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">activity_type =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>activityType,</span>
<span id="cb26-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start_latitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>startLocation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>latitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb26-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start_longitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>startLocation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>longitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb26-20">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_latitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>endLocation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>latitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb26-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_longitudeE7 =</span> .x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>endLocation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>longitudeE7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb26-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">startTimestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(.x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>startTimestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>),</span>
<span id="cb26-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">endTimestamp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd_hms</span>(.x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>endTimestamp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)</span>
<span id="cb26-24">    )</span>
<span id="cb26-25">  }) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list_rbind</span>()</span>
<span id="cb26-27"></span>
<span id="cb26-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ↑ that needs to be a separate data frame so that we can refer to it to make a</span></span>
<span id="cb26-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geometry column for the end latitude/longitude</span></span>
<span id="cb26-30">activity_segments <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> activity_segments_not_clean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the duration and distance and speed of the segment</span></span>
<span id="cb26-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> endTimestamp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> startTimestamp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_miles =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_miles</span>(distance_m)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb26-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hours =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>,</span>
<span id="cb26-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_mph =</span> distance_miles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> hours</span>
<span id="cb26-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make two geometry columns</span></span>
<span id="cb26-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start_longitudeE7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start_latitudeE7"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"geometry_start"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"geometry"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry_end =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(</span>
<span id="cb26-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(</span>
<span id="cb26-43">      activity_segments_not_clean, </span>
<span id="cb26-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_longitudeE7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_latitudeE7"</span>), </span>
<span id="cb26-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>))</span>
<span id="cb26-46">    )</span>
<span id="cb26-47">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>end_longitudeE7, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>end_latitudeE7) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-49">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a column with the time zone for each point</span></span>
<span id="cb26-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz_start =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tz_lookup</span>(geometry_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accurate"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz_end =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tz_lookup</span>(geometry_end, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accurate"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a version of the timestamps in local time, but in UTC</span></span>
<span id="cb26-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz_start) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">startTimestamp_local =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(startTimestamp, tz_start), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(tz_end) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">endTimestamp_local =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">force_tz</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_tz</span>(endTimestamp, tz_end), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-59">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add some helper columns for filtering, grouping, etc.</span></span>
<span id="cb26-60">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb26-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(startTimestamp_local),</span>
<span id="cb26-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">month</span>(startTimestamp_local),</span>
<span id="cb26-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(startTimestamp_local)</span>
<span id="cb26-64">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-65">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb26-66">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(startTimestamp_local, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%B %e"</span>),</span>
<span id="cb26-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># With %e, there's a leading space for single-digit numbers, so we remove</span></span>
<span id="cb26-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># any double spaces and replace them with single spaces </span></span>
<span id="cb26-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (e.g., "June  3" becomes "June 3")</span></span>
<span id="cb26-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(day_month, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb26-71">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(day_month)</span>
<span id="cb26-72">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bring in abbreviated time zones for both the start and end time zones</span></span>
<span id="cb26-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb26-75">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(tz_abbreviations, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tz_start_abb"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tz_abb"</span>), </span>
<span id="cb26-76">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(tz_start <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> tz)</span>
<span id="cb26-77">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb26-79">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(tz_abbreviations, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tz_end_abb"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tz_abb"</span>),</span>
<span id="cb26-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(tz_end <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> tz)</span>
<span id="cb26-81">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-82">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an id column so we can better reference individual activities </span></span>
<span id="cb26-83">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make it a character so it can combine with the place visit id column</span></span>
<span id="cb26-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()))</span>
<span id="cb26-85">activity_segments</span>
<span id="cb26-86"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 23 features and 19 fields</span></span>
<span id="cb26-87"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: geometry_start</span></span>
<span id="cb26-88"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb26-89"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb26-90"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -108.7 ymin: 29.4 xmax: -86.34 ymax: 35.53</span></span>
<span id="cb26-91"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb26-92"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 23 × 21</span></span>
<span id="cb26-93"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    distance_m activity_type        startTimestamp      endTimestamp        duration    distance_miles hours avg_mph geometry_start   geometry_end tz_start        tz_end          startTimestamp_local endTimestamp_local   year month   day day_month tz_start_abb tz_end_abb id   </span></span>
<span id="cb26-94"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  *      &lt;int&gt; &lt;chr&gt;                &lt;dttm&gt;              &lt;dttm&gt;              &lt;drtn&gt;               &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;POINT [°]&gt;    &lt;POINT [°]&gt; &lt;chr&gt;           &lt;chr&gt;           &lt;dttm&gt;               &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;     &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;</span></span>
<span id="cb26-95"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1     272317 IN_PASSENGER_VEHICLE 2023-06-03 14:50:24 2023-06-03 17:12:34 142.17 mins        169.    2.37    71.4  (-86.34 32.33) (-88.16 30.59) America/Chicago America/Chicago 2023-06-03 09:50:24  2023-06-03 12:12:34  2023     6     3 June 3    CDT          CDT        1    </span></span>
<span id="cb26-96"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2     195400 IN_PASSENGER_VEHICLE 2023-06-03 17:59:38 2023-06-03 19:45:22 105.75 mins        121.    1.76    68.9   (-88.16 30.6) (-89.96 30.05) America/Chicago America/Chicago 2023-06-03 12:59:38  2023-06-03 14:45:22  2023     6     3 June 3    CDT          CDT        2    </span></span>
<span id="cb26-97"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3      15368 IN_PASSENGER_VEHICLE 2023-06-03 20:52:17 2023-06-03 21:08:30  16.22 mins          9.55  0.270   35.3  (-89.96 30.05) (-90.07 29.96) America/Chicago America/Chicago 2023-06-03 15:52:17  2023-06-03 16:08:30  2023     6     3 June 3    CDT          CDT        3    </span></span>
<span id="cb26-98"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4       1026 WALKING              2023-06-03 22:31:08 2023-06-03 22:44:22  13.23 mins          0.638 0.221    2.89 (-90.06 29.96) (-90.07 29.96) America/Chicago America/Chicago 2023-06-03 17:31:08  2023-06-03 17:44:22  2023     6     3 June 3    CDT          CDT        4    </span></span>
<span id="cb26-99"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5       1280 WALKING              2023-06-03 22:59:51 2023-06-03 23:10:10  10.32 mins          0.795 0.172    4.63 (-90.07 29.96) (-90.06 29.96) America/Chicago America/Chicago 2023-06-03 17:59:51  2023-06-03 18:10:10  2023     6     3 June 3    CDT          CDT        5    </span></span>
<span id="cb26-100"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6      14611 IN_PASSENGER_VEHICLE 2023-06-03 23:19:40 2023-06-03 23:37:50  18.17 mins          9.08  0.303   30.0  (-90.06 29.96) (-89.96 30.05) America/Chicago America/Chicago 2023-06-03 18:19:40  2023-06-03 18:37:50  2023     6     3 June 3    CDT          CDT        6    </span></span>
<span id="cb26-101"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7      14258 IN_PASSENGER_VEHICLE 2023-06-04 14:01:02 2023-06-04 14:24:06  23.07 mins          8.86  0.384   23.0  (-89.96 30.05) (-89.99 29.94) America/Chicago America/Chicago 2023-06-04 09:01:02  2023-06-04 09:24:06  2023     6     4 June 4    CDT          CDT        7    </span></span>
<span id="cb26-102"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8     199631 IN_PASSENGER_VEHICLE 2023-06-04 15:54:20 2023-06-04 17:54:09 119.80 mins        124.    2.00    62.1  (-89.99 29.94) (-91.83 30.32) America/Chicago America/Chicago 2023-06-04 10:54:20  2023-06-04 12:54:09  2023     6     4 June 4    CDT          CDT        8    </span></span>
<span id="cb26-103"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9     169541 IN_PASSENGER_VEHICLE 2023-06-04 18:31:35 2023-06-04 20:02:26  90.83 mins        105.    1.51    69.6  (-91.83 30.32) (-93.57 30.19) America/Chicago America/Chicago 2023-06-04 13:31:35  2023-06-04 15:02:26  2023     6     4 June 4    CDT          CDT        9    </span></span>
<span id="cb26-104"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10      71377 IN_PASSENGER_VEHICLE 2023-06-04 20:26:48 2023-06-04 21:06:44  39.93 mins         44.4   0.666   66.6  (-93.57 30.19) (-94.21 29.99) America/Chicago America/Chicago 2023-06-04 15:26:48  2023-06-04 16:06:44  2023     6     4 June 4    CDT          CDT        10   </span></span>
<span id="cb26-105"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 13 more rows</span></span></code></pre></div>
</div>
</section>
<section id="both-combined" class="level3">
<h3 class="anchored" data-anchor-id="both-combined">Both combined</h3>
<p>All these <code>placeVisit</code> and <code>activitySegment</code> entries were originally in the same JSON file since they actually fit together nicely—activity segments lead to place visits, which are then followed by more activity segments (i.e.&nbsp;you drive to a place, do stuff at that place, and drive to a different place, and so on). Because the two event types are structured so differently, we had to split them up and load and clean them separately. But it can be helpful to put them back together so there’s a consistent timeline—it’ll help with making plots below, and it creates a neat log of the whole trip.</p>
<p>We’ll use <code>bind_rows()</code> to combine the two and then sort. It’s kind of an ugly dataset, with lots of missing data in every other row since each type of entry has slightly different columns in it, but some columns are consistent throughout, like <code>duration</code> and the different timestamps, so it’ll be helpful.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">all_stops_activities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visit =</span> place_visits, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment =</span> activity_segments),</span>
<span id="cb27-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span></span>
<span id="cb27-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb27-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(startTimestamp)</span>
<span id="cb27-6">all_stops_activities</span>
<span id="cb27-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 47 features and 26 fields</span></span>
<span id="cb27-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: geometry (with 23 geometries empty)</span></span>
<span id="cb27-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb27-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb27-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -111.6 ymin: 29.4 xmax: -86.34 ymax: 35.53</span></span>
<span id="cb27-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb27-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 47 × 29</span></span>
<span id="cb27-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    type    id             name  address startTimestamp      endTimestamp        duration driving_stop       geometry tz              startTimestamp_local endTimestamp_local  direction  year month   day day_month tz_abb distance_m activity_type  distance_miles  hours avg_mph geometry_start</span></span>
<span id="cb27-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;   &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt;   &lt;dttm&gt;              &lt;dttm&gt;              &lt;drtn&gt;   &lt;lgl&gt;           &lt;POINT [°]&gt; &lt;chr&gt;           &lt;dttm&gt;               &lt;dttm&gt;              &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;     &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;                   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;POINT [°]&gt;</span></span>
<span id="cb27-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 visit   ChIJQ0NgzsqAj… Chev… 1030 W… 2023-06-03 14:27:23 2023-06-03 14:50:24  23.02 … TRUE         (-86.34 32.33) America/Chicago 2023-06-03 09:27:23  2023-06-03 09:50:24 There      2023     6     3 June 3    CDT            NA &lt;NA&gt;                   NA     NA       NA             EMPTY</span></span>
<span id="cb27-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 segment 1              &lt;NA&gt;  &lt;NA&gt;    2023-06-03 14:50:24 2023-06-03 17:12:34 142.17 … NA                    EMPTY &lt;NA&gt;            2023-06-03 09:50:24  2023-06-03 12:12:34 &lt;NA&gt;       2023     6     3 June 3    &lt;NA&gt;       272317 IN_PASSENGER_…        169.     2.37    71.4  (-86.34 32.33)</span></span>
<span id="cb27-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 visit   ChIJMU2weFNKm… Walm… 5245 R… 2023-06-03 17:12:34 2023-06-03 17:59:38  47.07 … TRUE         (-88.16 30.59) America/Chicago 2023-06-03 12:12:34  2023-06-03 12:59:38 There      2023     6     3 June 3    CDT            NA &lt;NA&gt;                   NA     NA       NA             EMPTY</span></span>
<span id="cb27-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 segment 2              &lt;NA&gt;  &lt;NA&gt;    2023-06-03 17:59:38 2023-06-03 19:45:22 105.75 … NA                    EMPTY &lt;NA&gt;            2023-06-03 12:59:38  2023-06-03 14:45:22 &lt;NA&gt;       2023     6     3 June 3    &lt;NA&gt;       195400 IN_PASSENGER_…        121.     1.76    68.9   (-88.16 30.6)</span></span>
<span id="cb27-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 visit   ChIJnwDSTcsDn… Comf… 7051 B… 2023-06-03 19:45:22 2023-06-03 20:52:17  66.90 … FALSE        (-89.96 30.05) America/Chicago 2023-06-03 14:45:22  2023-06-03 15:52:17 There      2023     6     3 June 3    CDT            NA &lt;NA&gt;                   NA     NA       NA             EMPTY</span></span>
<span id="cb27-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 segment 3              &lt;NA&gt;  &lt;NA&gt;    2023-06-03 20:52:17 2023-06-03 21:08:30  16.22 … NA                    EMPTY &lt;NA&gt;            2023-06-03 15:52:17  2023-06-03 16:08:30 &lt;NA&gt;       2023     6     3 June 3    &lt;NA&gt;        15368 IN_PASSENGER_…          9.55   0.270   35.3  (-89.96 30.05)</span></span>
<span id="cb27-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 visit   ChIJgcNDAhKmI… P149… 537 Ch… 2023-06-03 21:08:30 2023-06-03 22:31:08  82.64 … FALSE        (-90.06 29.96) America/Chicago 2023-06-03 16:08:30  2023-06-03 17:31:08 There      2023     6     3 June 3    CDT            NA &lt;NA&gt;                   NA     NA       NA             EMPTY</span></span>
<span id="cb27-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 segment 4              &lt;NA&gt;  &lt;NA&gt;    2023-06-03 22:31:08 2023-06-03 22:44:22  13.23 … NA                    EMPTY &lt;NA&gt;            2023-06-03 17:31:08  2023-06-03 17:44:22 &lt;NA&gt;       2023     6     3 June 3    &lt;NA&gt;         1026 WALKING                 0.638  0.221    2.89 (-90.06 29.96)</span></span>
<span id="cb27-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 visit   ChIJv30_Xw-mI… Loui… 701 N … 2023-06-03 22:44:22 2023-06-03 22:59:51  15.48 … FALSE        (-90.07 29.96) America/Chicago 2023-06-03 17:44:22  2023-06-03 17:59:51 There      2023     6     3 June 3    CDT            NA &lt;NA&gt;                   NA     NA       NA             EMPTY</span></span>
<span id="cb27-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 segment 5              &lt;NA&gt;  &lt;NA&gt;    2023-06-03 22:59:51 2023-06-03 23:10:10  10.32 … NA                    EMPTY &lt;NA&gt;            2023-06-03 17:59:51  2023-06-03 18:10:10 &lt;NA&gt;       2023     6     3 June 3    &lt;NA&gt;         1280 WALKING                 0.795  0.172    4.63 (-90.07 29.96)</span></span>
<span id="cb27-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 37 more rows</span></span>
<span id="cb27-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 5 more variables: geometry_end &lt;POINT [°]&gt;, tz_start &lt;chr&gt;, tz_end &lt;chr&gt;, tz_start_abb &lt;chr&gt;, tz_end_abb &lt;chr&gt;</span></span></code></pre></div>
</div>
</section>
</section>
</section>
<section id="road-trip-analysis" class="level1 page-columns page-full">
<h1>Road trip analysis</h1>
<p>Phew, that was a lot of work getting this data all wrangled together and cleaned up. Let’s analyze this trip!</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Truncated vs.&nbsp;complete data
</div>
</div>
<div class="callout-body-container callout-body">
<p>All the plots and tables below use the complete data from our road trip, with every day and every stop. Everything above only worked with the first four days (and even then, omitted the first 30 minutes of the first day for the sake of privacy).</p>
<p><a href="data.zip">I provided truncated raw JSON files</a> for the sake of illustrating how to load and process and work with this kind of location data. But I want to analyze my actual full data, so I cleaned that up separately (<a href="clean-data-real.R">with this file</a>; <a href="https://github.com/andrewheiss/ath-quarto/blob/main/blog/2023/07/03/using-google-location-history-with-r-roadtrip/clean-data-real.R">view at GitHub</a>). I’ll load all those complete objects here.</p>
<p>If you’re following along with my truncated data, never fear! These plots and tables will all still generally work, they’ll just show the first few days and not the actual complete plots you see here.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Folded code
</div>
</div>
<div class="callout-body-container callout-body">
<p>There’s been a lot of code in this post already, so I’ve folded all the remaining code chunks so it’s easier to just see the plots and tables. You can see the underlying code if you click on the little toggle triangle.</p>
</div>
</div>
<section id="maps" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="maps">Maps</h2>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find all the states that daily_routes crosses</span></span>
<span id="cb28-2">states_crossed_through <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(</span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(daily_routes)),</span>
<span id="cb28-4">  daily_routes</span>
<span id="cb28-5">)</span>
<span id="cb28-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Warning: attribute variables are assumed to be spatially constant throughout all geometries</span></span>
<span id="cb28-7"></span>
<span id="cb28-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a column that flags if the state is crossed through</span></span>
<span id="cb28-9">lower_48_highlighted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visited =</span> NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(states_crossed_through<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME))</span></code></pre></div>
</details>
</div>
<p>In total, we crossed through 17 different states over the course of our big circular 13-day drive. We made 76 different stops along the way, all marked with points in Figure&nbsp;1:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a map!</span></span>
<span id="cb29-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey98"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> daily_routes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> place_visits, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb29-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb29-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb29-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Each point is a stop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb29-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip_map</span>()</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div id="fig-map-basic" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-map-basic-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Basic map of our mega road trip</figcaption>
</figure>
</div>
</div>
</div>
<p>In Figure&nbsp;2 we can color each leg of the trip a different color to see how the driving was divided up over time:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the same colors for each direction</span></span>
<span id="cb30-2">colors_there <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rcartocolor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">carto_pal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SunsetDark"</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)]</span>
<span id="cb30-3">colors_back_again <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rcartocolor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">carto_pal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SunsetDark"</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb30-4"></span>
<span id="cb30-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CARTO's Sunset Dark is neat, but the first yellow color is a little too light</span></span>
<span id="cb30-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to see comfortably, so we replace it with the yellow from the CARTO Prism</span></span>
<span id="cb30-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># palette</span></span>
<span id="cb30-8">colors_there[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]</span>
<span id="cb30-9">colors_back_again[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]</span>
<span id="cb30-10"></span>
<span id="cb30-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a map!</span></span>
<span id="cb30-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey98"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reset fill scale so that the labels can be filled</span></span>
<span id="cb30-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_scale_fill</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> daily_routes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> day_month), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(colors_there, colors_back_again), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> place_visits, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> day_month), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb30-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> daily_routes,</span>
<span id="cb30-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> day_month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> day_month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> path),</span>
<span id="cb30-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb30-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb30-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span></span>
<span id="cb30-26">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(colors_there, colors_back_again), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb30-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb30-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb30-31">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Each point is a stop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb30-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip_map</span>()</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div id="fig-map-with-dates" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-map-with-dates-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Map of our mega road trip, by day</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-and-time" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="distance-and-time">Distance and time</h2>
<p>Table&nbsp;1 answers a bunch of questions about distance and time:</p>
<ul>
<li><strong>How many miles did we drive each day?</strong> Roughly 500ish miles per day. The way out was longer than the way back (2,832 miles there vs.&nbsp;2,390 miles back). In total we drove <strong>5,222 miles</strong> (!!!). This is <em>shockingly</em> close to the <a href="https://www.andrewheiss.com/blog/2023/06/01/geocoding-routing-openstreetmap-r/#summary-statistics">5,260 miles that OpenStreetMap mapped out for me in this previous blog post</a>, even with some changes to the route (i.e.&nbsp;we didn’t end up going through Minnesota and went through Nebraska instead)</li>
<li><strong>How long did we spend driving each day?</strong> Roughly 8.5 hours per day. The way out was 5 hours longer than the way back (though that’s a little inflated because June 8 doesn’t really count, as we were just driving around Capitol Reef National Park). In total we drove for <strong>91 hours and 47 minutes</strong>,</li>
<li><strong>What was the earliest time we started each day and the latest time we arrived each evening?</strong> The earliest departure was 7:30 AM when we left Atlanta on June 3; the latest arrivals were when we got to Sioux Falls, South Dakota at 10:42 PM on June 22 and when we got to Flagstaff, Arizona on June 6 at 10:35 PM.</li>
</ul>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">time_distance_day <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> activity_segments <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_drop_geometry</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(activity_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IN_PASSENGER_VEHICLE"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(direction, day_month) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb31-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_distance =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(distance_miles),</span>
<span id="cb31-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(duration),</span>
<span id="cb31-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(startTimestamp_local),</span>
<span id="cb31-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start_tz =</span> tz_start_abb[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(startTimestamp_local)],</span>
<span id="cb31-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(endTimestamp_local),</span>
<span id="cb31-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_tz =</span> tz_end_abb[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.max</span>(endTimestamp_local)]</span>
<span id="cb31-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb31-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_start_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(start_time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%I:%M %p"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>), start_tz),</span>
<span id="cb31-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_end_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(end_time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%I:%M %p"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>), end_tz)</span>
<span id="cb31-16">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove leading zeros from hour</span></span>
<span id="cb31-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(nice_start_time, nice_end_time), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^0"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)))</span>
<span id="cb31-19"></span>
<span id="cb31-20">time_distance_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(direction, day_month, total_distance, total_time, nice_start_time, nice_end_time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(direction) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary_rows</span>(</span>
<span id="cb31-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">groups =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(),</span>
<span id="cb31-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(total_distance, total_time),</span>
<span id="cb31-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Subtotal =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.)),</span>
<span id="cb31-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fmt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-29">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_distance, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb31-30">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fns =</span> fmt_difftime)</span>
<span id="cb31-31">    ),</span>
<span id="cb31-32">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grand_summary_rows</span>(</span>
<span id="cb31-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(total_distance, total_time),</span>
<span id="cb31-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Total =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.)),</span>
<span id="cb31-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fmt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-37">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_distance, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb31-38">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fns =</span> fmt_difftime)</span>
<span id="cb31-39">    ),</span>
<span id="cb31-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">missing_text =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb31-41">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_footnote</span>(</span>
<span id="cb31-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">footnote =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This wasn't really a travel day; we spent the day hiking around Capitol Reef National Park and hanging out at my aunt's cabin in Grover, Utah."</span>,</span>
<span id="cb31-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(</span>
<span id="cb31-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> day_month,</span>
<span id="cb31-46">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> day_month <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"June 8"</span></span>
<span id="cb31-47">    )</span>
<span id="cb31-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_label</span>(</span>
<span id="cb31-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day"</span>,</span>
<span id="cb31-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_distance =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles"</span>,</span>
<span id="cb31-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driving time"</span>,</span>
<span id="cb31-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_start_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Start time"</span>,</span>
<span id="cb31-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_end_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"End time"</span></span>
<span id="cb31-55">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_align</span>(</span>
<span id="cb31-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_time,</span>
<span id="cb31-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span></span>
<span id="cb31-59">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-60">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_distance, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-61">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> total_time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fns =</span> fmt_difftime) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb31-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_column_labels</span>(),</span>
<span id="cb31-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-65">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb31-66">    )</span>
<span id="cb31-67">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb31-69">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_row_groups</span>(),</span>
<span id="cb31-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-71">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb31-72">    )</span>
<span id="cb31-73">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb31-75">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_summary</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_stub_summary</span>()),</span>
<span id="cb31-76">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-77">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey95"</span>)</span>
<span id="cb31-78">    )</span>
<span id="cb31-79">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-80">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb31-81">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-82">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_grand_summary</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_stub_grand_summary</span>(), </span>
<span id="cb31-83">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_column_labels</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_stubhead</span>()),</span>
<span id="cb31-84">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-85">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb31-86">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>)</span>
<span id="cb31-87">    )</span>
<span id="cb31-88">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-89">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_horizontal_padding</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-90">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_table_font</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">font =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_options</span>(</span>
<span id="cb31-92">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_group.as_column =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb31-93">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">footnotes.marks =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"standard"</span></span>
<span id="cb31-94">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-distance-time-day" class="anchored">

<div id="pzveloiefp" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#pzveloiefp table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#pzveloiefp thead, #pzveloiefp tbody, #pzveloiefp tfoot, #pzveloiefp tr, #pzveloiefp td, #pzveloiefp th {
  border-style: none;
}

#pzveloiefp p {
  margin: 0;
  padding: 0;
}

#pzveloiefp .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pzveloiefp .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#pzveloiefp .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 10px;
  padding-right: 10px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pzveloiefp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 10px;
  padding-right: 10px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pzveloiefp .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 10px;
  padding-right: 10px;
  overflow-x: hidden;
}

#pzveloiefp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pzveloiefp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pzveloiefp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pzveloiefp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pzveloiefp .gt_spanner_row {
  border-bottom-style: hidden;
}

#pzveloiefp .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#pzveloiefp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pzveloiefp .gt_from_md > :first-child {
  margin-top: 0;
}

#pzveloiefp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pzveloiefp .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pzveloiefp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 10px;
  padding-right: 10px;
}

#pzveloiefp .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 10px;
  padding-right: 10px;
  vertical-align: top;
}

#pzveloiefp .gt_row_group_first td {
  border-top-width: 2px;
}

#pzveloiefp .gt_row_group_first th {
  border-top-width: 2px;
}

#pzveloiefp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
}

#pzveloiefp .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#pzveloiefp .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#pzveloiefp .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
}

#pzveloiefp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pzveloiefp .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 10px;
  padding-right: 10px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pzveloiefp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 10px;
  padding-right: 10px;
}

#pzveloiefp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 10px;
  padding-right: 10px;
}

#pzveloiefp .gt_left {
  text-align: left;
}

#pzveloiefp .gt_center {
  text-align: center;
}

#pzveloiefp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pzveloiefp .gt_font_normal {
  font-weight: normal;
}

#pzveloiefp .gt_font_bold {
  font-weight: bold;
}

#pzveloiefp .gt_font_italic {
  font-style: italic;
}

#pzveloiefp .gt_super {
  font-size: 65%;
}

#pzveloiefp .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#pzveloiefp .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#pzveloiefp .gt_indent_1 {
  text-indent: 5px;
}

#pzveloiefp .gt_indent_2 {
  text-indent: 10px;
}

#pzveloiefp .gt_indent_3 {
  text-indent: 15px;
}

#pzveloiefp .gt_indent_4 {
  text-indent: 20px;
}

#pzveloiefp .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;1:  <p>Daily distance and time details</p> </caption>
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id=""></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Day">Day</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Miles">Miles</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Driving time">Driving time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Start time">Start time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="End time">End time</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_row_group_first"><td headers="There stub_1_1 stub_1" rowspan="7" class="gt_row gt_left gt_stub_row_group" style="font-weight: bold;">There</td>
<td headers="There stub_1_1 day_month" class="gt_row gt_center">June 3</td>
<td headers="There stub_1_1 total_distance" class="gt_row gt_right">492</td>
<td headers="There stub_1_1 total_time" class="gt_row gt_left">7 hours 26 minutes</td>
<td headers="There stub_1_1 nice_start_time" class="gt_row gt_left">7:34 AM EDT</td>
<td headers="There stub_1_1 nice_end_time" class="gt_row gt_left">6:37 PM CDT</td></tr>
    <tr><td headers="There day_month_2 day_month" class="gt_row gt_center">June 4</td>
<td headers="There day_month_2 total_distance" class="gt_row gt_right">544</td>
<td headers="There day_month_2 total_time" class="gt_row gt_left">8 hours 16 minutes</td>
<td headers="There day_month_2 nice_start_time" class="gt_row gt_left">9:01 AM CDT</td>
<td headers="There day_month_2 nice_end_time" class="gt_row gt_left">8:30 PM CDT</td></tr>
    <tr><td headers="There day_month_3 day_month" class="gt_row gt_center">June 5</td>
<td headers="There day_month_3 total_distance" class="gt_row gt_right">442</td>
<td headers="There day_month_3 total_time" class="gt_row gt_left">6 hours 56 minutes</td>
<td headers="There day_month_3 nice_start_time" class="gt_row gt_left">9:06 AM CDT</td>
<td headers="There day_month_3 nice_end_time" class="gt_row gt_left">6:10 PM MDT</td></tr>
    <tr><td headers="There day_month_4 day_month" class="gt_row gt_center">June 6</td>
<td headers="There day_month_4 total_distance" class="gt_row gt_right">626</td>
<td headers="There day_month_4 total_time" class="gt_row gt_left">10 hours 5 minutes</td>
<td headers="There day_month_4 nice_start_time" class="gt_row gt_left">8:24 AM MDT</td>
<td headers="There day_month_4 nice_end_time" class="gt_row gt_left">10:35 PM MST</td></tr>
    <tr><td headers="There day_month_5 day_month" class="gt_row gt_center">June 7</td>
<td headers="There day_month_5 total_distance" class="gt_row gt_right">438</td>
<td headers="There day_month_5 total_time" class="gt_row gt_left">8 hours 31 minutes</td>
<td headers="There day_month_5 nice_start_time" class="gt_row gt_left">8:40 AM MST</td>
<td headers="There day_month_5 nice_end_time" class="gt_row gt_left">8:46 PM MDT</td></tr>
    <tr><td headers="There day_month_6 day_month" class="gt_row gt_center">June 8<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span></td>
<td headers="There day_month_6 total_distance" class="gt_row gt_right">63</td>
<td headers="There day_month_6 total_time" class="gt_row gt_left">2 hours 18 minutes</td>
<td headers="There day_month_6 nice_start_time" class="gt_row gt_left">9:41 AM MDT</td>
<td headers="There day_month_6 nice_end_time" class="gt_row gt_left">7:42 PM MDT</td></tr>
    <tr><td headers="There day_month_7 day_month" class="gt_row gt_center">June 9</td>
<td headers="There day_month_7 total_distance" class="gt_row gt_right">228</td>
<td headers="There day_month_7 total_time" class="gt_row gt_left">4 hours 41 minutes</td>
<td headers="There day_month_7 nice_start_time" class="gt_row gt_left">9:04 AM MDT</td>
<td headers="There day_month_7 nice_end_time" class="gt_row gt_left">3:06 PM MDT</td></tr>
    <tr><th id="summary_stub_There_1" scope="row" class="gt_row gt_left gt_stub gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">Subtotal</th>
<td headers="There summary_stub_There_1 day_month" class="gt_row gt_center gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td>
<td headers="There summary_stub_There_1 total_distance" class="gt_row gt_right gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">2,832</td>
<td headers="There summary_stub_There_1 total_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">48 hours 14 minutes</td>
<td headers="There summary_stub_There_1 nice_start_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td>
<td headers="There summary_stub_There_1 nice_end_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td></tr>
    <tr class="gt_row_group_first"><td headers="Back again stub_1_8 stub_1" rowspan="6" class="gt_row gt_left gt_stub_row_group" style="font-weight: bold;">Back again</td>
<td headers="Back again stub_1_8 day_month" class="gt_row gt_center">June 20</td>
<td headers="Back again stub_1_8 total_distance" class="gt_row gt_right">290</td>
<td headers="Back again stub_1_8 total_time" class="gt_row gt_left">4 hours 50 minutes</td>
<td headers="Back again stub_1_8 nice_start_time" class="gt_row gt_left">8:58 AM MDT</td>
<td headers="Back again stub_1_8 nice_end_time" class="gt_row gt_left">9:17 PM MDT</td></tr>
    <tr><td headers="Back again day_month_9 day_month" class="gt_row gt_center">June 21</td>
<td headers="Back again day_month_9 total_distance" class="gt_row gt_right">408</td>
<td headers="Back again day_month_9 total_time" class="gt_row gt_left">11 hours 36 minutes</td>
<td headers="Back again day_month_9 nice_start_time" class="gt_row gt_left">8:16 AM MDT</td>
<td headers="Back again day_month_9 nice_end_time" class="gt_row gt_left">10:04 PM MDT</td></tr>
    <tr><td headers="Back again day_month_10 day_month" class="gt_row gt_center">June 22</td>
<td headers="Back again day_month_10 total_distance" class="gt_row gt_right">525</td>
<td headers="Back again day_month_10 total_time" class="gt_row gt_left">8 hours 27 minutes</td>
<td headers="Back again day_month_10 nice_start_time" class="gt_row gt_left">8:14 AM MDT</td>
<td headers="Back again day_month_10 nice_end_time" class="gt_row gt_left">10:42 PM CDT</td></tr>
    <tr><td headers="Back again day_month_11 day_month" class="gt_row gt_center">June 23</td>
<td headers="Back again day_month_11 total_distance" class="gt_row gt_right">459</td>
<td headers="Back again day_month_11 total_time" class="gt_row gt_left">7 hours 27 minutes</td>
<td headers="Back again day_month_11 nice_start_time" class="gt_row gt_left">8:11 AM CDT</td>
<td headers="Back again day_month_11 nice_end_time" class="gt_row gt_left">8:22 PM CDT</td></tr>
    <tr><td headers="Back again day_month_12 day_month" class="gt_row gt_center">June 24</td>
<td headers="Back again day_month_12 total_distance" class="gt_row gt_right">446</td>
<td headers="Back again day_month_12 total_time" class="gt_row gt_left">7 hours 9 minutes</td>
<td headers="Back again day_month_12 nice_start_time" class="gt_row gt_left">9:09 AM CDT</td>
<td headers="Back again day_month_12 nice_end_time" class="gt_row gt_left">9:16 PM CDT</td></tr>
    <tr><td headers="Back again day_month_13 day_month" class="gt_row gt_center">June 25</td>
<td headers="Back again day_month_13 total_distance" class="gt_row gt_right">262</td>
<td headers="Back again day_month_13 total_time" class="gt_row gt_left">4 hours 1 minutes</td>
<td headers="Back again day_month_13 nice_start_time" class="gt_row gt_left">7:49 AM CDT</td>
<td headers="Back again day_month_13 nice_end_time" class="gt_row gt_left">12:51 PM EDT</td></tr>
    <tr><th id="summary_stub_Back again_1" scope="row" class="gt_row gt_left gt_stub gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">Subtotal</th>
<td headers="Back again summary_stub_Back again_1 day_month" class="gt_row gt_center gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td>
<td headers="Back again summary_stub_Back again_1 total_distance" class="gt_row gt_right gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">2,390</td>
<td headers="Back again summary_stub_Back again_1 total_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;">43 hours 33 minutes</td>
<td headers="Back again summary_stub_Back again_1 nice_start_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td>
<td headers="Back again summary_stub_Back again_1 nice_end_time" class="gt_row gt_left gt_summary_row gt_first_summary_row gt_last_summary_row" style="background-color: #F2F2F2;"></td></tr>
    <tr><th id="grand_summary_stub_1" scope="row" class="gt_row gt_left gt_stub gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;">Total</th>
<td headers="grand_summary_stub_1 day_month" class="gt_row gt_center gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;"></td>
<td headers="grand_summary_stub_1 total_distance" class="gt_row gt_right gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;">5,222</td>
<td headers="grand_summary_stub_1 total_time" class="gt_row gt_left gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;">91 hours 47 minutes</td>
<td headers="grand_summary_stub_1 nice_start_time" class="gt_row gt_left gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;"></td>
<td headers="grand_summary_stub_1 nice_end_time" class="gt_row gt_left gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row" style="font-weight: bold; background-color: #CCCCCC;"></td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="6"><span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span> This wasn't really a travel day; we spent the day hiking around Capitol Reef National Park and hanging out at my aunt's cabin in Grover, Utah.</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
</div>
<div class="page-columns page-full"><p>Figure&nbsp;3 shows a timeline of each day’s events.<sup>1</sup> We typically started each day with some sort of sightseeing adventure (we didn’t do this on the first day, since we left our house that day—instead, we ended that day with a walk through the French Quarter in New Orleans). Our longest touristy adventure was technically Capitol Reef National Park, since we spent the whole day there, but if we don’t count that and instead look at the along-the-way stops, our longest adventures were Yellowstone, Nauvoo, and Carlsbad Caverns.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;All the times are in local time, which causes some weirdness when crossing time zones. Instead of somehow expanding or shrinking these timelines during stretches where we gained or lost time because of time zone changes, I just put a dotted border around those stretches to point them out.</p></li></div></div>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Little dataset with names for the tourist stops we made</span></span>
<span id="cb32-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gotta do some goofy things here because I don't want things double labeled though</span></span>
<span id="cb32-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb32-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Some IDs, like ChIJgcNDAhKmIIYRRA4mio_7VgE (a parking lot near the </span></span>
<span id="cb32-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   French Quarter) show up twice as placeVisits, but there should only be one </span></span>
<span id="cb32-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   label, so down below, after merging this into the timeline data, I use </span></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   `group_by(visit_label) %&gt;% slice(1)` to only keep the first visit for labeling</span></span>
<span id="cb32-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Yellowstone, though, looks goofy if the first segment is labeled, so I want </span></span>
<span id="cb32-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   to label the second. That messes with the grouping/slicing approach, so I </span></span>
<span id="cb32-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   add a trailing space to the Yellowstone visits I don't want labeled </span></span>
<span id="cb32-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   (i.e. "Yellowstone ") and then filter those out after grouping/slicing</span></span>
<span id="cb32-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Nauvoo happened on two different days, but grouping/slicing only keeps the </span></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   first. So I make the second day's visits use a different label with a space </span></span>
<span id="cb32-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   at the beginning and end of the label (i.e. " Nauvoo ")</span></span>
<span id="cb32-15">sightseeing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb32-16">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>id,                           <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>visit_label,</span>
<span id="cb32-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJgcNDAhKmIIYRRA4mio_7VgE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The French</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Quarter"</span>,</span>
<span id="cb32-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJv30_Xw-mIIYRpt26QbLBh58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The French</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Quarter"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically Louis Armstrong Park</span></span>
<span id="cb32-19">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ59n6fW8dnogRWi-5N6olcyU"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chalmette</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Battlefield"</span>,</span>
<span id="cb32-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJX4k2TVVfXIYRIsTnhA-P-Rc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Alamo"</span>,</span>
<span id="cb32-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJW9e4xBN544YRvbI7vfc91G4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carlsbad</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Caverns"</span>,</span>
<span id="cb32-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJrSLbJJIQM4cR4l5HTswDY8k"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Grand</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Canyon"</span>,</span>
<span id="cb32-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJU6LnB_8ASocRB_9PSFPsO94"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Capitol Reef</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">National Park"</span>,</span>
<span id="cb32-24">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJIw-BhQkZSocRncIWG0YMLJU"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Capitol Reef</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">National Park"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the visitor center</span></span>
<span id="cb32-25">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJaSHejn29SYcR-YzTt_DNlTg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Goblin</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Valley"</span>,</span>
<span id="cb32-26">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJVQ4oZOP4VFMREjDKbf7bHIE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My sister's</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">house"</span>,</span>
<span id="cb32-27">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJp4yR8asLVFMRJJExTuHrYEs"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rexburg"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically Porter Park</span></span>
<span id="cb32-28">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJz6VI3AMLVFMREvSOw9M0VR4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rexburg"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically BYU-I</span></span>
<span id="cb32-29">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"51"</span>,                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the drive to Old Faithful; Google missed this</span></span>
<span id="cb32-30">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ3zGqpb65UVMR0rTSaqVZ5kc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone "</span>,</span>
<span id="cb32-31">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJXy5ZgRvtUVMRoSJoWid8Owg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone "</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically Old Faithful</span></span>
<span id="cb32-32">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJOT5U8z8GM1MResed1BOdJKk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Devil's</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Tower"</span>,</span>
<span id="cb32-33">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ39Y-tdg1fYcRQcZcBb499do"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mount</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Rushmore"</span>,</span>
<span id="cb32-34">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJg_2MNnKRk4cRQGXbuvgqba4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Winter</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Quarters"</span>,</span>
<span id="cb32-35">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJh53YJHIm54cRmpf8_ZA3CVw"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nauvoo"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the visitors center</span></span>
<span id="cb32-36">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJDUPPu3Im54cRKj6BG8UkOko"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nauvoo"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the temple</span></span>
<span id="cb32-37">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJg0abVHYm54cR85yQbfLjt2o"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Nauvoo "</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the family living center</span></span>
<span id="cb32-38">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJm7cRetkl54cR-lEKk-eZnXA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Nauvoo "</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically the Smith family cemetery</span></span>
<span id="cb32-39">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJZ6tHUwsm54cRbmWsF639PjY"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Nauvoo "</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Technically Carthage Jail</span></span>
<span id="cb32-40">)</span>
<span id="cb32-41"></span>
<span id="cb32-42"></span>
<span id="cb32-43">timeline_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_stops_activities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get rid of the geometry column since we're not doing anything map-related</span></span>
<span id="cb32-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_drop_geometry</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-46">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Indicate if there was a time zone change during the activity</span></span>
<span id="cb32-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb32-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz_change =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(tz_start) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> tz_start_abb <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> tz_end_abb, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time zone change"</span>)</span>
<span id="cb32-49">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-50">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the midpoint between the start and end times</span></span>
<span id="cb32-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_mid =</span> startTimestamp_local <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ((startTimestamp_local <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> endTimestamp_local) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add column for the name of the tourist stop</span></span>
<span id="cb32-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(sightseeing, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(id)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add column for more detailed type of stop</span></span>
<span id="cb32-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb32-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stop_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb32-57">      type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"visit"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(visit_label) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sightseeing"</span>,</span>
<span id="cb32-58">      type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"visit"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(visit_label) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gas/bathroom/hotel stop"</span>,</span>
<span id="cb32-59">      type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"51"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sightseeing"</span>,</span>
<span id="cb32-60">      type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Traveling"</span></span>
<span id="cb32-61">    )</span>
<span id="cb32-62">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-63">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># After finishing at Capitol Reef we returned to my aunt's cabin in Grover to</span></span>
<span id="cb32-64">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relax. I had to run back to the nearest town with 5G internet (Torrey) to</span></span>
<span id="cb32-65">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># respond to e-mails and Slack messages (since I was teaching two online</span></span>
<span id="cb32-66">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># classes throughout this whole road trip!), and that doesn't technically</span></span>
<span id="cb32-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count as part of the road trip, so we need to remove everything after 5 PM</span></span>
<span id="cb32-68">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on that day</span></span>
<span id="cb32-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(endTimestamp_local) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-70">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># After arriving at the hotel in Rexburg, we made a late-night milkshake run</span></span>
<span id="cb32-71">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># after the kids were in bed, which Google picked up. That doesn't technically</span></span>
<span id="cb32-72">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count as part of the road trip, so we need to remove everything after 6 PM</span></span>
<span id="cb32-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on that day</span></span>
<span id="cb32-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(endTimestamp_local) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the timestamps for the final stop of the day (i.e. hotels) to NA and</span></span>
<span id="cb32-76">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># then remove those rows for plotting</span></span>
<span id="cb32-77">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb32-79">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(startTimestamp_local, endTimestamp_local), </span>
<span id="cb32-80">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, .x))</span>
<span id="cb32-81">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-82">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(startTimestamp_local)</span>
<span id="cb32-83"></span>
<span id="cb32-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Force all the timestamps to be on the same day for the sake of plotting</span></span>
<span id="cb32-85"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(timeline_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>startTimestamp_local) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-86"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(timeline_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>endTimestamp_local) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-87"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(timeline_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_mid) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-88"></span>
<span id="cb32-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract just the labels for plotting</span></span>
<span id="cb32-90">sightseeing_labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> timeline_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(stop_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sightseeing"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-92">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(visit_label) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-93">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-94">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(visit_label <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone "</span>)</span>
<span id="cb32-95"></span>
<span id="cb32-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Timeline plot</span></span>
<span id="cb32-97"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(timeline_data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-98">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(</span>
<span id="cb32-99">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb32-100">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> startTimestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> endTimestamp_local, </span>
<span id="cb32-101">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb32-102">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> stop_type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> tz_change, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> tz_change, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> tz_change</span>
<span id="cb32-103">    )</span>
<span id="cb32-104">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-105">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(</span>
<span id="cb32-106">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> sightseeing_labels,</span>
<span id="cb32-107">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> time_mid, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> visit_label),</span>
<span id="cb32-108">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lineheight =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb32-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit.aes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb32-110">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-111">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Phew fancy aesthetic and scale work here</span></span>
<span id="cb32-112">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_datetime</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_breaks =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3 hours"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_labels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%I:%M %p"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-113">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-114">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>], clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>], clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-115">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-116">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linewidth_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-117">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linetype_manual</span>(</span>
<span id="cb32-118">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time zone change"</span>,</span>
<span id="cb32-119">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb32-120">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-121">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-122">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(day_month), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-123">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-124">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-125">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb32-126">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb32-127">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb32-128">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span></span>
<span id="cb32-129">  )</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div id="fig-timeline-by-day" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-timeline-by-day-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Timeline of our grand road trip</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="driving-and-breaks" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="driving-and-breaks">Driving and breaks</h2>
<p>As seen in Figure&nbsp;3, we had a pretty good rhythm of driving and taking gas/bathroom breaks—we broke up long stretches of driving with stops for gas and bathrooms.</p>
<p>Table&nbsp;2 shows the top three longest and shortest stretches of driving. The longest stretch was on the final day—we drove 4 hours from Nashville to Atlanta with no bathroom breaks. We apparently just desperately wanted to get home! We did the same push-through-to-the-last-stop approach a few other times too. The third longest stretch was actually our first on the way home, leaving Spanish Fork, Utah to my sister’s house outside of Rexburg, Idaho, which we did in 3.5 hours, while the 2nd and 5th longest stretches involved pushing to our final destinations for the day (a hotel in Nauvoo, Illinois and my aunt’s cabin in Grover, Utah). The only long stretch that broke this patter was the fourth longest one after Carlsbad Caverns—we spent more than 3 hours on a little state road going all the way from southern New Mexico to a gas station at I-20.</p>
<p>The shortest stretches involved going from a main sightseeing stop to a gas station (Mount Rushmore to some Holiday gas station), going between sightseeing stops (the Smith Family Cemetery in Nauvoo to Carthage Jail), or going from a hotel to a sightseeing stop (our hotel in Carlsbad to Carlsbad Caverns National Park).</p>
<p>My favorite short stop is number 4 here, on June 4. We got gas in Louisiana somewhere and then had to stop at another gas station in Texas 39 minutes later for an emergency break for little kids who suddenly needed to use the bathroom again. After that particular stop, we instituted a “no drinking soda or juice in the car” rule for the kids and suddenly—like magic—their bladders worked a lot more slowly and we stopped making such frequent stops.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">driving_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_stops_activities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get rid of the geometry column since we're not doing anything map-related</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_drop_geometry</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the previous and next place visits</span></span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb33-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(name),</span>
<span id="cb33-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_address =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(address),</span>
<span id="cb33-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lead</span>(name),</span>
<span id="cb33-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_address =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lead</span>(address)</span>
<span id="cb33-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># lag() doesn't work for the first entry, so manually add it</span></span>
<span id="cb33-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb33-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Home"</span>, origin_name),</span>
<span id="cb33-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_address =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Atlanta, GA, USA"</span>, origin_address)</span>
<span id="cb33-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only look at driving activities</span></span>
<span id="cb33-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(activity_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IN_PASSENGER_VEHICLE"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get rid of empty, place-related columns</span></span>
<span id="cb33-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(name, address, driving_stop, tz, geometry_start, geometry_end))</span>
<span id="cb33-20"></span>
<span id="cb33-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Longest, shortest stretch of driving</span></span>
<span id="cb33-22">driving_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(distance_miles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration_rank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rank</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>duration)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_bottom =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb33-26">    duration_rank <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Longest stretches"</span>,</span>
<span id="cb33-27">    duration_rank <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shortest stretches"</span></span>
<span id="cb33-28">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(top_bottom)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(</span>
<span id="cb33-31">    top_bottom, </span>
<span id="cb33-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(top_bottom <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shortest stretches"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(duration_rank), duration_rank)</span>
<span id="cb33-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format time stuff nicely</span></span>
<span id="cb33-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb33-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_difftime</span>(duration),</span>
<span id="cb33-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_start_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(startTimestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%I:%M %p"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>), tz_start_abb),</span>
<span id="cb33-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_end_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strftime</span>(endTimestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%I:%M %p"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTC"</span>), tz_end_abb)</span>
<span id="cb33-39">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove leading zeros from hour</span></span>
<span id="cb33-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(nice_start_time, nice_end_time), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^0"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-42">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make nice origin and destination columns</span></span>
<span id="cb33-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb33-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{origin_name}&lt;br&gt;&lt;span class="smaller-address"&gt;{origin_address}&lt;/span&gt;'</span>),</span>
<span id="cb33-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{destination_name}&lt;br&gt;&lt;span class="smaller-address"&gt;{destination_address}&lt;/span&gt;'</span>)</span>
<span id="cb33-46">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb33-48">    top_bottom, day_month, nice_time, nice_start_time, nice_end_time, </span>
<span id="cb33-49">    distance_miles, origin_nice, destination_nice</span>
<span id="cb33-50">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(top_bottom) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_label</span>(</span>
<span id="cb33-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driving time"</span>,</span>
<span id="cb33-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day_month =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day"</span>,</span>
<span id="cb33-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_start_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Start time"</span>,</span>
<span id="cb33-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice_end_time =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"End time"</span>,</span>
<span id="cb33-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_miles =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles"</span>,</span>
<span id="cb33-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_nice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Origin"</span>,</span>
<span id="cb33-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_nice =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Destination"</span></span>
<span id="cb33-61">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb33-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_column_labels</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_stubhead</span>()),</span>
<span id="cb33-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb33-65">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb33-66">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>)</span>
<span id="cb33-67">    )</span>
<span id="cb33-68">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb33-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_row_groups</span>(),</span>
<span id="cb33-71">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb33-72">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb33-73">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey95"</span>)</span>
<span id="cb33-74">    )</span>
<span id="cb33-75">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-76">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_align</span>(</span>
<span id="cb33-77">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(day_month, origin_nice, destination_nice),</span>
<span id="cb33-78">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span></span>
<span id="cb33-79">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-80">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(origin_nice, destination_nice)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-81">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> distance_miles, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-82">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_footnote</span>(</span>
<span id="cb33-83">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">footnote =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stretches less than 10 miles omitted (like if we had lunch somewhere and drove down the street to get gas)."</span></span>
<span id="cb33-84">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-85">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_css</span>(</span>
<span id="cb33-86">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">css =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb33-87"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    .smaller-address {</span></span>
<span id="cb33-88"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      font-size: 0.7em;</span></span>
<span id="cb33-89"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }"</span></span>
<span id="cb33-90">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_table_font</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">font =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div id="tbl-driving-longest-shortest" class="anchored">

<div id="dbgvzfontn" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#dbgvzfontn table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#dbgvzfontn thead, #dbgvzfontn tbody, #dbgvzfontn tfoot, #dbgvzfontn tr, #dbgvzfontn td, #dbgvzfontn th {
  border-style: none;
}

#dbgvzfontn p {
  margin: 0;
  padding: 0;
}

#dbgvzfontn .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dbgvzfontn .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#dbgvzfontn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dbgvzfontn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dbgvzfontn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#dbgvzfontn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dbgvzfontn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dbgvzfontn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dbgvzfontn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dbgvzfontn .gt_spanner_row {
  border-bottom-style: hidden;
}

#dbgvzfontn .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#dbgvzfontn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dbgvzfontn .gt_from_md > :first-child {
  margin-top: 0;
}

#dbgvzfontn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dbgvzfontn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dbgvzfontn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#dbgvzfontn .gt_row_group_first td {
  border-top-width: 2px;
}

#dbgvzfontn .gt_row_group_first th {
  border-top-width: 2px;
}

#dbgvzfontn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#dbgvzfontn .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#dbgvzfontn .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dbgvzfontn .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dbgvzfontn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_left {
  text-align: left;
}

#dbgvzfontn .gt_center {
  text-align: center;
}

#dbgvzfontn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dbgvzfontn .gt_font_normal {
  font-weight: normal;
}

#dbgvzfontn .gt_font_bold {
  font-weight: bold;
}

#dbgvzfontn .gt_font_italic {
  font-style: italic;
}

#dbgvzfontn .gt_super {
  font-size: 65%;
}

#dbgvzfontn .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#dbgvzfontn .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#dbgvzfontn .gt_indent_1 {
  text-indent: 5px;
}

#dbgvzfontn .gt_indent_2 {
  text-indent: 10px;
}

#dbgvzfontn .gt_indent_3 {
  text-indent: 15px;
}

#dbgvzfontn .gt_indent_4 {
  text-indent: 20px;
}

#dbgvzfontn .gt_indent_5 {
  text-indent: 25px;
}

.smaller-address {
  font-size: 0.7em;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;2:  <p>Top five longest and shortest stretches of driving during the
trip</p> </caption>
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Day">Day</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Driving time">Driving time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Start time">Start time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="End time">End time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Miles">Miles</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Origin">Origin</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" style="font-weight: bold; background-color: #CCCCCC;" scope="col" id="Destination">Destination</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="7" class="gt_group_heading" style="font-weight: bold; background-color: #F2F2F2;" scope="colgroup" id="Longest stretches">Longest stretches</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Longest stretches  day_month" class="gt_row gt_left">June 25</td>
<td headers="Longest stretches  nice_time" class="gt_row gt_left">4 hours 1 minutes</td>
<td headers="Longest stretches  nice_start_time" class="gt_row gt_left">7:49 AM CDT</td>
<td headers="Longest stretches  nice_end_time" class="gt_row gt_left">12:51 PM EDT</td>
<td headers="Longest stretches  distance_miles" class="gt_row gt_right">262</td>
<td headers="Longest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Quality Inn<br><span class="smaller-address">2741 York Rd, Pleasant View, TN 37146, USA</span></p>
</div></td>
<td headers="Longest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Home<br><span class="smaller-address">Atlanta, GA, USA</span></p>
</div></td></tr>
    <tr><td headers="Longest stretches  day_month" class="gt_row gt_left">June 23</td>
<td headers="Longest stretches  nice_time" class="gt_row gt_left">3 hours 35 minutes</td>
<td headers="Longest stretches  nice_start_time" class="gt_row gt_left">1:19 PM CDT</td>
<td headers="Longest stretches  nice_end_time" class="gt_row gt_left">4:54 PM CDT</td>
<td headers="Longest stretches  distance_miles" class="gt_row gt_right">198</td>
<td headers="Longest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>McDonald’s<br><span class="smaller-address">120 SE 7th St, Stuart, IA 50250, USA</span></p>
</div></td>
<td headers="Longest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Inn at Old Nauvoo<br><span class="smaller-address">1875 Mulholland St, Nauvoo, IL 62354, USA</span></p>
</div></td></tr>
    <tr><td headers="Longest stretches  day_month" class="gt_row gt_left">June 20</td>
<td headers="Longest stretches  nice_time" class="gt_row gt_left">3 hours 31 minutes</td>
<td headers="Longest stretches  nice_start_time" class="gt_row gt_left">8:58 AM MDT</td>
<td headers="Longest stretches  nice_end_time" class="gt_row gt_left">12:30 PM MDT</td>
<td headers="Longest stretches  distance_miles" class="gt_row gt_right">244</td>
<td headers="Longest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>My aunt’s house<br><span class="smaller-address">Spanish Fork, UT, USA</span></p>
</div></td>
<td headers="Longest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>My sister’s house<br><span class="smaller-address">Shelley, ID, USA</span></p>
</div></td></tr>
    <tr><td headers="Longest stretches  day_month" class="gt_row gt_left">June 6</td>
<td headers="Longest stretches  nice_time" class="gt_row gt_left">3 hours 9 minutes</td>
<td headers="Longest stretches  nice_start_time" class="gt_row gt_left">12:18 PM MDT</td>
<td headers="Longest stretches  nice_end_time" class="gt_row gt_left">3:28 PM MDT</td>
<td headers="Longest stretches  distance_miles" class="gt_row gt_right">191</td>
<td headers="Longest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Carlsbad Caverns National Park<br><span class="smaller-address">Carlsbad, NM 88220, USA</span></p>
</div></td>
<td headers="Longest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Conoco<br><span class="smaller-address">1307 8th St, Vaughn, NM 88353, USA</span></p>
</div></td></tr>
    <tr><td headers="Longest stretches  day_month" class="gt_row gt_left">June 7</td>
<td headers="Longest stretches  nice_time" class="gt_row gt_left">3 hours 7 minutes</td>
<td headers="Longest stretches  nice_start_time" class="gt_row gt_left">5:39 PM MDT</td>
<td headers="Longest stretches  nice_end_time" class="gt_row gt_left">8:46 PM MDT</td>
<td headers="Longest stretches  distance_miles" class="gt_row gt_right">163</td>
<td headers="Longest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Glazier’s Market<br><span class="smaller-address">264 S 100 E, Kanab, UT 84741, USA</span></p>
</div></td>
<td headers="Longest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>My aunt’s cabin<br><span class="smaller-address">Grover, UT, USA</span></p>
</div></td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="7" class="gt_group_heading" style="font-weight: bold; background-color: #F2F2F2;" scope="colgroup" id="Shortest stretches">Shortest stretches</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Shortest stretches  day_month" class="gt_row gt_left">June 22</td>
<td headers="Shortest stretches  nice_time" class="gt_row gt_left">21 minutes</td>
<td headers="Shortest stretches  nice_start_time" class="gt_row gt_left">3:35 PM MDT</td>
<td headers="Shortest stretches  nice_end_time" class="gt_row gt_left">3:56 PM MDT</td>
<td headers="Shortest stretches  distance_miles" class="gt_row gt_right">15</td>
<td headers="Shortest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Mount Rushmore National Memorial<br><span class="smaller-address">13000 SD-244, Keystone, SD 57751, USA</span></p>
</div></td>
<td headers="Shortest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Holiday Stationstores<br><span class="smaller-address">Caregiver Cir, Rapid City, SD 57701, USA</span></p>
</div></td></tr>
    <tr><td headers="Shortest stretches  day_month" class="gt_row gt_left">June 24</td>
<td headers="Shortest stretches  nice_time" class="gt_row gt_left">25 minutes</td>
<td headers="Shortest stretches  nice_start_time" class="gt_row gt_left">12:20 PM CDT</td>
<td headers="Shortest stretches  nice_end_time" class="gt_row gt_left">12:45 PM CDT</td>
<td headers="Shortest stretches  distance_miles" class="gt_row gt_right">18</td>
<td headers="Shortest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Smith Family Cemetery<br><span class="smaller-address">Nauvoo, IL 62354, USA</span></p>
</div></td>
<td headers="Shortest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Carthage Jail<br><span class="smaller-address">310 Buchanan St, Carthage, IL 62321, USA</span></p>
</div></td></tr>
    <tr><td headers="Shortest stretches  day_month" class="gt_row gt_left">June 6</td>
<td headers="Shortest stretches  nice_time" class="gt_row gt_left">33 minutes</td>
<td headers="Shortest stretches  nice_start_time" class="gt_row gt_left">8:24 AM MDT</td>
<td headers="Shortest stretches  nice_end_time" class="gt_row gt_left">8:57 AM MDT</td>
<td headers="Shortest stretches  distance_miles" class="gt_row gt_right">22</td>
<td headers="Shortest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Stevens Inn<br><span class="smaller-address">1829 S Canal St, Carlsbad, NM 88220, USA</span></p>
</div></td>
<td headers="Shortest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Carlsbad Caverns National Park<br><span class="smaller-address">Carlsbad, NM 88220, USA</span></p>
</div></td></tr>
    <tr><td headers="Shortest stretches  day_month" class="gt_row gt_left">June 4</td>
<td headers="Shortest stretches  nice_time" class="gt_row gt_left">39 minutes</td>
<td headers="Shortest stretches  nice_start_time" class="gt_row gt_left">3:26 PM CDT</td>
<td headers="Shortest stretches  nice_end_time" class="gt_row gt_left">4:06 PM CDT</td>
<td headers="Shortest stretches  distance_miles" class="gt_row gt_right">44</td>
<td headers="Shortest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Exxon<br><span class="smaller-address">1410 Gum Cove Rd, Vinton, LA 70668, USA</span></p>
</div></td>
<td headers="Shortest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>Love’s Travel Stop<br><span class="smaller-address">7495 Smith Rd, Beaumont, TX 77713, USA</span></p>
</div></td></tr>
    <tr><td headers="Shortest stretches  day_month" class="gt_row gt_left">June 20</td>
<td headers="Shortest stretches  nice_time" class="gt_row gt_left">42 minutes</td>
<td headers="Shortest stretches  nice_start_time" class="gt_row gt_left">2:14 PM MDT</td>
<td headers="Shortest stretches  nice_end_time" class="gt_row gt_left">2:56 PM MDT</td>
<td headers="Shortest stretches  distance_miles" class="gt_row gt_right">35</td>
<td headers="Shortest stretches  origin_nice" class="gt_row gt_left"><div class="gt_from_md"><p>My sister’s house<br><span class="smaller-address">Shelley, ID, USA</span></p>
</div></td>
<td headers="Shortest stretches  destination_nice" class="gt_row gt_left"><div class="gt_from_md"><p>AmericInn by Wyndham Rexburg BYUI<br><span class="smaller-address">1098 Golden Beauty Dr, Rexburg, ID 83440, USA</span></p>
</div></td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="7"> Stretches less than 10 miles omitted (like if we had lunch somewhere and drove down the street to get gas).</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
</div>
<p>What about the stops? How long was a typical gas/bathroom break? Figure&nbsp;4 shows the distribution of the duration of all the non-touristy stops, and it actually reveals a pretty neat trimodal distribution! We had three general types of stops:</p>
<ul>
<li><strong>Fast</strong> (<em>10ish minutes</em>): stops for switching drivers, getting gas right after a sightseeing visit, or letting one kid go to the bathroom</li>
<li><strong>Standard</strong> (<em>25ish minutes</em>): stops where we got gas and had everyone go to the bathroom</li>
<li><strong>Meal</strong> (<em>40ish minutes</em>): stops where we got gas, went to the bathroom, ate food (typically peanut butter sandwiches that we made in the hotel in the morning), and walked around to stretch</li>
</ul>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cut duration into three categories</span></span>
<span id="cb34-2">places_hist_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> place_visits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(driving_stop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(duration), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)))</span>
<span id="cb34-5"></span>
<span id="cb34-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(places_hist_data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(duration), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> range)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">boundary =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fast stop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Standard gas + bathroom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gas + bathroom + meal"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.35</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> clrs[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minutes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-stop-duration-dist" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-stop-duration-dist-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;4: Distribution of non-sightseeing stops for the first four days of the trip</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="elevation-over-time" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="elevation-over-time">Elevation over time</h2>
<p>And finally, just for fun since Google tracked this data and we might as well do something neat with it, we can look at how much the elevation changed over the course of the trip. Atlanta is 1,000 feet above sea level, and Utah County is 4,500 feed above sea level, but the 3,500-foot increase in elevation was hardly uniform. We dropped down to below sea level in New Orleans, climbed up to above 4,000 feet in Carlsbad (it turns out that Carlsbad Caverns is on top of a big mountain), and then climbed rapidly up to the Grand Canyon and Southern Utah in general at 7,500ish feet until dropping down to 4,500 feet at our final destination in Utah.</p>
<p>On the way back, we stayed at around 4,500ish feet until Yellowstone, where we hit the highest elevation of the whole trip at 8,530 feet. We then gradually worked our way down toward sea level as we traveled further east, finally hitting 1,000ish feet at the Mississippi River at Nauvoo, Illinois, where we mostly stayed until getting home (with a little Appalachian spike near the end).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">elevation_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_locations <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elevation =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_feet</span>(altitude))</span>
<span id="cb35-3"></span>
<span id="cb35-4">elevation_stops <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb35-5">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>id,                       <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>direction,  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>nudge_direction, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>stop_label,</span>
<span id="cb35-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJv30_Xw-mIIYRpt26QbLBh58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New Orleans,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Louisiana"</span>,</span>
<span id="cb35-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJX4k2TVVfXIYRIsTnhA-P-Rc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"down"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"San Antonio,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Texas"</span>,</span>
<span id="cb35-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJW9e4xBN544YRvbI7vfc91G4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"down"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carlsbad Caverns,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">New Mexico"</span>,</span>
<span id="cb35-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJrSLbJJIQM4cR4l5HTswDY8k"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Grand Canyon,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Arizona"</span>,</span>
<span id="cb35-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJU6LnB_8ASocRB_9PSFPsO94"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Capitol Reef,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Utah"</span>,</span>
<span id="cb35-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJz6VI3AMLVFMREvSOw9M0VR4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"down"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rexburg,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Idaho"</span>,</span>
<span id="cb35-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJSWHsxv8JTlMR82z8b6wF_BM"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Wyoming"</span>,</span>
<span id="cb35-13">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJ39Y-tdg1fYcRQcZcBb499do"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mount Rushmore,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">South Dakota"</span>,</span>
<span id="cb35-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJDUPPu3Im54cRKj6BG8UkOko"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"down"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nauvoo,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Illinois"</span>,</span>
<span id="cb35-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChIJtUcJ-n36ZIgRhzY2PM19eWA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nashville,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Tennessee"</span></span>
<span id="cb35-16">)</span>
<span id="cb35-17"></span>
<span id="cb35-18">stops_to_show <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> place_visits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_drop_geometry</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> elevation_stops<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(elevation_stops, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(id)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Magical new join_by(closest(...)) syntax for inexact, approximate matching</span></span>
<span id="cb35-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to get the closest elevation for the stop(!)</span></span>
<span id="cb35-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(elevation_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">closest</span>(startTimestamp_local <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> timestamp))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get rid of duplicate ids</span></span>
<span id="cb35-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb35-29"></span>
<span id="cb35-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(elevation_data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> timestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> elevation)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(</span>
<span id="cb35-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(stops_to_show, nudge_direction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"up"</span>),</span>
<span id="cb35-34">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> startTimestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> stop_label),</span>
<span id="cb35-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lineheight =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>,</span>
<span id="cb35-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span></span>
<span id="cb35-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(</span>
<span id="cb35-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(stops_to_show, nudge_direction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"down"</span>),</span>
<span id="cb35-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> startTimestamp_local, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> stop_label),</span>
<span id="cb35-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lineheight =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>,</span>
<span id="cb35-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span></span>
<span id="cb35-43">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_datetime</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_breaks =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1 day"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_labels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%B %e"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(</span>
<span id="cb35-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>),</span>
<span id="cb35-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" ft."</span>)</span>
<span id="cb35-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Elevation"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(direction), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display column-page-right">
<div id="fig-elevation" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-elevation-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Elevation over the course of the trip</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-end" class="level1">
<h1>The end</h1>
<p>This only scratches the surface of what you can do with your Google Location History data. There’s a ton of other stuff in those JSON files, including second-by-second data of each <code>activitySegment</code> (though those entries seem to use Google’s internal <code>ChIJ********</code> <a href="https://developers.google.com/maps/documentation/places/web-service/place-id">Place IDs</a> and not latitude and longitude coordinates), sub-visits for <code>placeVisits</code>, and lots of other stuff. Smarter people than me can dig through and figure out that data!</p>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {Road Trip Analysis! {How} to Use and Play with {Google}
    {Location} {History} in {R}},
  date = {2023-07-03},
  url = {https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip},
  doi = {10.59350/24rwv-k9n62},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“Road Trip Analysis! How to Use and Play with
Google Location History in R.”</span> July 3, 2023. <a href="https://doi.org/10.59350/24rwv-k9n62">https://doi.org/10.59350/24rwv-k9n62</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>gis</category>
  <category>maps</category>
  <guid>https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index.html</guid>
  <pubDate>Sun, 02 Jul 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/07/03/using-google-location-history-with-r-roadtrip/index_files/figure-html/fig-map-with-dates-1.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>How to make fancy road trip maps with R and OpenStreetMap</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index.html</link>
  <description><![CDATA[ 




<p>In a couple days, I’m going to drive across the country to Utah, my home state. I haven’t been out west with my whole family in four years—not since 2019 when we moved from Spanish Fork, Utah to Atlanta, Georgia. According to Google Maps, <a href="https://goo.gl/maps/aGXJPL85LMTW2cuS9">it’s a mere 1,900 miles</a> (3,000 kilometers) through the middle of the United States and should take 28 hours, assuming no stops.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/img/google-maps-ga-to-ut.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Google Maps route from Atlanta, Georgia to Spanish Fork, Utah</figcaption>
</figure>
</div>
<p>For bonus fun though, my wife and I decided to make this trip even more adventurous and hit as many exciting stops as possible. So rather than drive through the middle of Kansas, we’re going along the southern border on the way there, visiting New Orleans, Louisiana; San Antonio, Texas; <a href="https://en.wikipedia.org/wiki/Carlsbad_Caverns_National_Park">Carlsbad Caverns</a>, New Mexico; the <a href="https://en.wikipedia.org/wiki/Grand_Canyon">Grand Canyon</a> in Arizona; and then camping for a couple days at <a href="https://en.wikipedia.org/wiki/Capitol_Reef_National_Park">Capitol Reef National Park</a> in Southern Utah before finally arriving at my aunt’s house in Spanish Fork, Utah. On the way home, we’re going across the northern part of the United States, visiting my sister in Idaho before heading towards <a href="https://en.wikipedia.org/wiki/Yellowstone_National_Park">Yellowstone</a> in Wyoming; <a href="https://en.wikipedia.org/wiki/Devils_Tower">Devil’s Tower</a> in Wyoming; <a href="https://en.wikipedia.org/wiki/Mount_Rushmore">Mount Rushmore</a> in South Dakota; and <a href="https://en.wikipedia.org/wiki/Nauvoo,_Illinois">Nauvoo, Illinois</a> (<a href="https://www.churchofjesuschrist.org/learn/locations/historic-nauvoo">Mormons!</a>). It’s going to be an awesome—but <em>way</em> longer—mega road trip.</p>
<p>To help keep six kids entertained beyond just plugging them into iPads, my wife made some road trip journals to make the experience more memorable and educational, and we’re bringing a bunch of books and extra materials about each of the stops we’ll be making so they can do research along the way.</p>
<p>I just finished revamping my <a href="https://datavizs23.classes.andrewheiss.com/">online data visualization class</a> this week since the summer semester is starting next week, so visualizing data through maps has been on my mind. In my session on visualizing maps, <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data">I added a section on making and visualizing your own geocoded data</a> (i.e.&nbsp;plotting specific cities on a map), so I figured it would be neat to visualize this huge road trip somehow to make some maps to include in the kids’ journals.</p>
<p>Getting the latitude and longitude coordinates for specific cities or addresses is super easy—you can either <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data">right click on Google Maps and copy specific coordinates</a>, or you can <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#automatic-geoencoding-by-address">automate it</a> with the <a href="https://jessecambon.github.io/tidygeocoder/">{tidygeocoder} package</a> in R.</p>
<p>Getting route coordinates is a lot trickier though, since it involves all sorts of complex algorithms (accounting for road locations, speed limits, traffic, etc.). This is why Google Maps is so invaluable—it does an excellent job of figuring this out. But Google’s data is proprietary.</p>
<p>There’s an R package named <a href="https://github.com/michaeldorman/mapsapi">{mapsapi}</a> that makes it really easy to get data from the Google Maps API, and if you get an API key from Google (<a href="https://developers.google.com/maps/documentation/directions/start#create-project">following these instructions</a>), you can extract geocoded {sf}-compatible route data from Google with the <code>mp_directions()</code> function. It’s neat and quick and easy, but it’s expensive. When I first started playing with the maps API in R, I racked up $0.50 in charges just with testing a bunch of routing options. The Google Maps API gives you $200 in free credits every month and I was well below that amount, but it still was a little nervewracking to see that it was that expensive in just an hour of tinkering. Also, setting up the API key was fairly complicated (creating a Google Cloud project, setting up billing, enabling specific services, storing the API key securely on my computer, etc.), and I don’t want to go through that hassle in the future.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/img/google-maps-api-costs.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Google Maps API costs</figcaption>
</figure>
</div>
<p>I’m a fan of the <a href="https://www.openstreetmap.org/">OpenStreetMap project</a>, and it’s <a href="https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html">one of the backends</a> (through <a href="https://nominatim.org/">Nominatim</a>) for {tidygeocoder} (and I used it in a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#in-the-united-states">previous blog post</a> showing some coordinates in interactive Leaflet maps). In searching around the internet for open source alternatives to the Google Maps API, I discovered that OpenStreetMap can also do directions and routing through the <a href="http://project-osrm.org/">Open Source Routing Machine (OSRM) project</a>. You can use OSRM’s <a href="https://map.project-osrm.org">public demo server</a> for small-scale routing things, or you can <a href="https://github.com/Project-OSRM/osrm-backend#using-docker">install your own local instance through Docker</a>. And super conveniently, there’s also an R package called <a href="https://github.com/riatelab/osrm">{osrm}</a> for accessing the OSRM API. This means that it’s possible to pull geocoded routing and directions data into R in an open source (and free!) way.</p>
<p>So let’s see how to use {osrm} and make some neat road trip maps with {sf} and {ggplot2}!</p>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<section id="who-this-post-is-for" class="level2">
<h2 class="anchored" data-anchor-id="who-this-post-is-for">Who this post is for</h2>
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re somewhat familiar with <a href="https://r-spatial.github.io/sf/">{sf}</a> for working with geographic data. I have a <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html">whole tutorial here</a> and a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles">simplified one here</a> and the <a href="https://r-spatial.github.io/sf/">{sf} documentation has a ton of helpful vignettes and blog posts</a>, and there are also two free books about it: <a href="https://r-spatial.org/book/"><em>Spatial Data Science</em></a> and <a href="https://r.geocompx.org/"><em>Geocomputation with R</em></a>. Also <a href="https://www.jessesadler.com/post/simple-feature-objects/">check this fantastic post out</a> to learn more about the anatomy of a <code>geometry</code> column with {sf}.</li>
</ul>
</section>
<section id="packages-and-functions" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-functions">Packages and functions</h2>
<p>Before officially getting started, let’s load all the packages we need and create some helpful functions and variables:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Handle spatial data in R in a tidy way</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tigris)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Access geographic data from the US Census</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidygeocoder)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Automated geocoding</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(osrm)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Access OSRM through R</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer non-overlapping labels</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Easier string interpolation</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine plots nicely</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggspatial)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer map features like scale bars</span></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://fonts.google.com/specimen/Overpass</span></span>
<span id="cb1-14">theme_roadtrip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb1-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb1-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(</span>
<span id="cb1-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>,</span>
<span id="cb1-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-21">    )</span>
<span id="cb1-22">}</span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make labels use Overpass by default</span></span>
<span id="cb1-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label_repel"</span>, </span>
<span id="cb1-26">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-27">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, </span>
<span id="cb1-29">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-30">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_repel"</span>, </span>
<span id="cb1-33">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-34">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, </span>
<span id="cb1-36">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb1-37">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>))</span>
<span id="cb1-38"></span>
<span id="cb1-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Yellowstone colors</span></span>
<span id="cb1-40">clrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> NatParksPalettes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">natparks.pals</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Format duration in minutes and hours</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' This function takes a numeric input \code{x} representing a duration in minutes,</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' rounds it to the nearest 15 minutes, and formats the result as a string</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' indicating the number of hours and minutes in the duration.</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param x A numeric input representing a duration in minutes.</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @return A character vector of formatted duration strings.</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @examples</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' fmt_duration(c(93, 1007, 3056))</span></span>
<span id="cb2-11">fmt_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb2-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Round to the nearest 15 minutes</span></span>
<span id="cb2-13">  n_seconds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb2-14">  n_seconds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds_to_period</span>(n_seconds)</span>
<span id="cb2-15">  </span>
<span id="cb2-16">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(n_seconds, \(n) {</span>
<span id="cb2-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">59</span>) {</span>
<span id="cb2-18">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If this is less than an hour, don't format anything with hours</span></span>
<span id="cb2-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{MM} minutes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MM =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minute</span>(n))</span>
<span id="cb2-20">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb2-21">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I only want to format this as a number of hours. If the duration is</span></span>
<span id="cb2-22">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># longer than 24 hours, seconds_to_period() rolls over into days (i.e.</span></span>
<span id="cb2-23">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># seconds_to_period(60 * 60 * 24) returns "1d 0H 0M 0S"), and it shows</span></span>
<span id="cb2-24">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># zero hours. So we extract the day part of the period, multiply it by 24,</span></span>
<span id="cb2-25">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and add it to the hour component that we want to display</span></span>
<span id="cb2-26">      extra_day_hours <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">day</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb2-27">  </span>
<span id="cb2-28">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{HH} hour{s} {MM} minutes"</span>,</span>
<span id="cb2-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">HH =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>()(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> extra_day_hours),</span>
<span id="cb2-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MM =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minute</span>(n),</span>
<span id="cb2-31">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hour</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s"</span>)</span>
<span id="cb2-32">      )</span>
<span id="cb2-33">    }</span>
<span id="cb2-34">  })</span>
<span id="cb2-35">  </span>
<span id="cb2-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb2-37">}</span>
<span id="cb2-38"></span>
<span id="cb2-39">fmt_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" miles"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">big.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)</span>
<span id="cb2-40"></span>
<span id="cb2-41">miles_to_meters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb2-42">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb2-43">}</span>
<span id="cb2-44"></span>
<span id="cb2-45">meters_to_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb2-46">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb2-47">}</span>
<span id="cb2-48"></span>
<span id="cb2-49">km_to_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb2-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_miles</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb2-51">}</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="state-data" class="level1 page-columns page-full">
<h1>State data</h1>
<p>First we need state boundaries. We can get these from the US Census with <code>states()</code> from {tigris}:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">states</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20m"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cb =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3">lower_48 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alaska"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hawaii"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Puerto Rico"</span>)))</span></code></pre></div>
</details>
</div>
<p>Here’s what they look like (using the <a href="https://epsg.io/102003">Albers projection for the contiguous USA</a>):</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-states-only-1.png" class="img-fluid figure-img" style="width:100.0%" alt="48 contiguous states"></p>
<figcaption class="figure-caption margin-caption">48 contiguous states</figcaption>
</figure>
</div>
</div>
</div>
<p>Super quick and easy.</p>
</section>
<section id="stops-data" class="level1 page-columns page-full">
<h1>Stops data</h1>
<p>Next we need to geocode and plot all the stops we’ll be making on the trip. I’ll stick them all in a data frame with columns indicating the direction (with a nod to Bilbo Baggins’s <a href="https://en.wikipedia.org/wiki/There_and_Back_Again_(disambiguation)">“There and Back Again”</a> journey with the dwarves in <em>The Hobbit</em>) and the day of the leg of the trip:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">stops_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb5-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>direction,   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>day, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>city,</span>
<span id="cb5-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Atlanta, Georgia"</span>, </span>
<span id="cb5-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New Orleans, Louisiana"</span>, </span>
<span id="cb5-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"San Antonio, Texas"</span>, </span>
<span id="cb5-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carlsbad, New Mexico"</span>, </span>
<span id="cb5-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grand Canyon NP, Arizona"</span>,</span>
<span id="cb5-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>,      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grover, Utah"</span>,  </span>
<span id="cb5-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spanish Fork, Utah"</span>, </span>
<span id="cb5-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shelley, Idaho"</span>,  </span>
<span id="cb5-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone NP, Wyoming"</span>,</span>
<span id="cb5-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Devil's Tower, Wyoming"</span>,  </span>
<span id="cb5-13">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mount Rushmore, South Dakota"</span>, </span>
<span id="cb5-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Albert Lea, Minnesota"</span>, </span>
<span id="cb5-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nauvoo, Illinois"</span>, </span>
<span id="cb5-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Atlanta, Georgia"</span></span>
<span id="cb5-17">)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(direction))</span>
<span id="cb5-19">stops_raw</span>
<span id="cb5-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 14 × 3</span></span>
<span id="cb5-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day city                        </span></span>
<span id="cb5-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                       </span></span>
<span id="cb5-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia            </span></span>
<span id="cb5-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana      </span></span>
<span id="cb5-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas          </span></span>
<span id="cb5-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico        </span></span>
<span id="cb5-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona    </span></span>
<span id="cb5-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                </span></span>
<span id="cb5-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah          </span></span>
<span id="cb5-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho              </span></span>
<span id="cb5-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming     </span></span>
<span id="cb5-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming      </span></span>
<span id="cb5-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota</span></span>
<span id="cb5-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota       </span></span>
<span id="cb5-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois            </span></span>
<span id="cb5-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 Back again     6 Atlanta, Georgia</span></span></code></pre></div>
</details>
</div>
<p>I could go to Google Maps and right click on each of these places and copy the latitude/longitude coordinates, but that’s not very reproducible and involves a lot of clicking around. We can do it programmatically with <code>geocode()</code> from {tidygeocoder}, but first we need to help the API a little. With most of these places, OpenStreetMap will return the center of the city (like with Atlanta), and that’s fine. With larger places like the Grand Canyon and Yellowstone, though, OpenStreetMap will give coordinates for the middle of the parks, which are literally in the middle of nowhere and will mess up our directions (since it’s not really possible to drive to the middle of the whole Grand Canyon). To fix this we’ll make a little dataset of some more specific addresses and join it to the list of stops. We’ll geocode the more specific address column:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">stops_addresses <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb6-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>city, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>address,</span>
<span id="cb6-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grand Canyon NP, Arizona"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Grand Canyon Visitor Center, Arizona"</span>,</span>
<span id="cb6-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yellowstone NP, Wyoming"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Old Faithful, Teton County, Wyoming"</span>,</span>
<span id="cb6-5">)</span>
<span id="cb6-6"></span>
<span id="cb6-7">stops_to_geocode <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stops_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(stops_addresses, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(city)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine the address and city columns, with a preference for address</span></span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">address =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(address, city))</span>
<span id="cb6-11"></span>
<span id="cb6-12">stops_to_geocode</span>
<span id="cb6-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 14 × 4</span></span>
<span id="cb6-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day city                         address                             </span></span>
<span id="cb6-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                        &lt;chr&gt;                               </span></span>
<span id="cb6-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                    </span></span>
<span id="cb6-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana              </span></span>
<span id="cb6-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas           San Antonio, Texas                  </span></span>
<span id="cb6-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                </span></span>
<span id="cb6-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona</span></span>
<span id="cb6-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                 Grover, Utah                        </span></span>
<span id="cb6-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                  </span></span>
<span id="cb6-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                      </span></span>
<span id="cb6-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming </span></span>
<span id="cb6-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming              </span></span>
<span id="cb6-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota        </span></span>
<span id="cb6-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota               </span></span>
<span id="cb6-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                    </span></span>
<span id="cb6-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia</span></span></code></pre></div>
</details>
</div>
<p>To get the coordinates, we’ll feed the address column to <code>geocode()</code> and then convert the resulting numeric <code>long</code> and <code>lat</code> into an official sf geometry column (with the <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS 84 (−180 to 180) scale</a>):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">stops_geocoded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stops_to_geocode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geocode</span>(address, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"osm"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lat"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">stops_geocoded</span>
<span id="cb8-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 14 features and 4 fields</span></span>
<span id="cb8-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb8-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb8-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span id="cb8-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb8-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 14 × 5</span></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day city                         address                                  geometry</span></span>
<span id="cb8-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                        &lt;chr&gt;                                 &lt;POINT [°]&gt;</span></span>
<span id="cb8-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)</span></span>
<span id="cb8-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana                 (-90.1 30)</span></span>
<span id="cb8-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas           San Antonio, Texas                   (-98.5 29.4)</span></span>
<span id="cb8-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                  (-104 32.4)</span></span>
<span id="cb8-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona  (-112 36.1)</span></span>
<span id="cb8-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                 Grover, Utah                          (-111 38.2)</span></span>
<span id="cb8-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                    (-112 40.1)</span></span>
<span id="cb8-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                        (-112 43.4)</span></span>
<span id="cb8-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming   (-111 44.5)</span></span>
<span id="cb8-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming                (-105 44.6)</span></span>
<span id="cb8-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota          (-103 43.9)</span></span>
<span id="cb8-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota                (-93.4 43.6)</span></span>
<span id="cb8-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                     (-91.4 40.6)</span></span>
<span id="cb8-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)</span></span></code></pre></div>
</details>
</div>
<p>Atlanta is in there twice, so we’ll need to drop the last row so that we don’t plot the points and labels for it twice:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">all_stops_unique <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stops_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</details>
</div>
<p>And let’s plot it all:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb10-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique,</span>
<span id="cb10-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb10-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb10-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb10-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb10-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb10-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb10-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-stops-only-1.png" class="img-fluid figure-img" style="width:100.0%" alt="All the main stops for our road trip"></p>
<figcaption class="figure-caption margin-caption">All the main stops for our road trip</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="routing" class="level1 page-columns page-full">
<h1>Routing</h1>
<p>Next we need to figure out the routes between each of these points. The <code>osrmRoute()</code> function in {osrm} takes two main arguments: (1) coordinates for the source location (<code>src</code>) and (2) coordinates for the destination location (<code>dst</code>). To make it easy to work with routing data in a dataframe, we need to manipulate the data a bit so that we get a row per route, with columns for the origin and destination cities.</p>
<p>We’ll create a copy of the geometry column in <code>stops_geocoded</code> and shift it forward one row with <code>lead()</code> and drop the last row because it doesn’t have a destination:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">routes_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> stops_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>address) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(</span>
<span id="cb11-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_geometry =</span> geometry,</span>
<span id="cb11-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin_city =</span> city</span>
<span id="cb11-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_geometry =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lead</span>(origin_geometry),</span>
<span id="cb11-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">destination_city =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lead</span>(origin_city)</span>
<span id="cb11-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb11-12">routes_raw</span>
<span id="cb11-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 13 features and 4 fields</span></span>
<span id="cb11-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: origin_geometry</span></span>
<span id="cb11-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb11-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb11-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span id="cb11-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb11-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 13 × 6</span></span>
<span id="cb11-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day origin_city                  origin_geometry destination_geometry destination_city            </span></span>
<span id="cb11-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                       </span></span>
<span id="cb11-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana      </span></span>
<span id="cb11-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas          </span></span>
<span id="cb11-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico        </span></span>
<span id="cb11-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona    </span></span>
<span id="cb11-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                </span></span>
<span id="cb11-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah          </span></span>
<span id="cb11-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho              </span></span>
<span id="cb11-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming     </span></span>
<span id="cb11-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming      </span></span>
<span id="cb11-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota</span></span>
<span id="cb11-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota       </span></span>
<span id="cb11-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois            </span></span>
<span id="cb11-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia</span></span></code></pre></div>
</details>
</div>
<p>With the data like this, we can now feed each row individually to <code>osrmRoute</code> and get geocoded paths between each origin and destination:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">routes_geocoded_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">route =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">osrmRoute</span>(</span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">src =</span> origin_geometry, </span>
<span id="cb12-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dst =</span> destination_geometry)</span>
<span id="cb12-6">  )</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">routes_geocoded_raw</span>
<span id="cb13-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 13 features and 5 fields</span></span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: origin_geometry</span></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb13-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 13 × 7</span></span>
<span id="cb13-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Rowwise: </span></span>
<span id="cb13-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route$src $dst  $duration $distance                                                                                 $geometry</span></span>
<span id="cb13-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                        &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;</span></span>
<span id="cb13-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst        513.      753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...</span></span>
<span id="cb13-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst        596.      870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...</span></span>
<span id="cb13-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst        458.      727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...</span></span>
<span id="cb13-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst        749.     1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....</span></span>
<span id="cb13-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst        510.      628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...</span></span>
<span id="cb13-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst        197.      273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....</span></span>
<span id="cb13-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst        262.      411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...</span></span>
<span id="cb13-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst        199.      240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...</span></span>
<span id="cb13-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst        552.      694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....</span></span>
<span id="cb13-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst        161.      215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....</span></span>
<span id="cb13-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst        548.      866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...</span></span>
<span id="cb13-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst        359.      487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...</span></span>
<span id="cb13-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst        847.     1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...</span></span></code></pre></div>
</details>
</div>
<p>The route details are included in a <a href="https://tidyr.tidyverse.org/articles/nest.html">nested data frame list column</a> named <code>route</code>, so we’ll need to unnest it. The resulting data frame now has three different geometry columns (!) for the origin point, destination point, and the route, so we’ll set the route column as the data frame’s primary geometry column (which makes it so we can just use <code>geom_sf(data = routes_geocoded)</code> instead of <code>geom_sf(data = routes_geocoded, aes(geometry = whatever))</code>). The route data also includes some helpful details about the distance (in kilometers) and duration (in minutes), so we’ll create nicely formatted text-based versions of these too:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">routes_geocoded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_geocoded_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(route, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"route_geometry"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb14-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_miles =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">km_to_miles</span>(route_distance),</span>
<span id="cb14-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_miles</span>(distance_miles),</span>
<span id="cb14-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration_text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_duration</span>(route_duration)</span>
<span id="cb14-8">  )</span>
<span id="cb14-9">routes_geocoded</span>
<span id="cb14-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 13 features and 11 fields</span></span>
<span id="cb14-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: route_geometry</span></span>
<span id="cb14-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: LINESTRING</span></span>
<span id="cb14-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb14-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9</span></span>
<span id="cb14-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb14-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 13 × 14</span></span>
<span id="cb14-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text   </span></span>
<span id="cb14-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                        &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;           </span></span>
<span id="cb14-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minu…</span></span>
<span id="cb14-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minu…</span></span>
<span id="cb14-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minu…</span></span>
<span id="cb14-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 min…</span></span>
<span id="cb14-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minu…</span></span>
<span id="cb14-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minu…</span></span>
<span id="cb14-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minu…</span></span>
<span id="cb14-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minu…</span></span>
<span id="cb14-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minu…</span></span>
<span id="cb14-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minu…</span></span>
<span id="cb14-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minu…</span></span>
<span id="cb14-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minut…</span></span>
<span id="cb14-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minu…</span></span></code></pre></div>
</details>
</div>
<p>Let’s see how this looks! Because we set the default geometry of <code>routes_geocoded</code> to the route, <code>geom_sf(data = routes_geocoded)</code> will automatically plot the <code>LINESTRING</code> geometries for the routes as paths:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb15-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique,</span>
<span id="cb15-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb15-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb15-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb15-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb15-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb15-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb15-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb15-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Automatically geocoded routes between all our road trip stops"></p>
<figcaption class="figure-caption margin-caption">Automatically geocoded routes between all our road trip stops</figcaption>
</figure>
</div>
</div>
</div>
<p>AHH that’s so cool! It works!</p>
<p>We’re not done yet though—let’s make this even fancier!</p>
</section>
<section id="states-crossed-through" class="level1 page-columns page-full">
<h1>States crossed through</h1>
<p>We’re going to be driving through a lot of states. Let’s highlight each of the states we’ll cross through to see how many there are. To do this we can use <code>st_intersection()</code> to find which of the <code>lower_48</code> states contain a part of the different routes. We’ll then make a copy of <code>lower_48</code> with a new column indicating if we’ll visit the state:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">states_crossed_through <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(</span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(routes_geocoded)),</span>
<span id="cb16-3">  routes_geocoded</span>
<span id="cb16-4">)</span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># There are 32 rows here, but 18 unique states (i.e. one day will end in a state</span></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and start the next day in the same state, so it gets counted twice)</span></span>
<span id="cb16-8">states_crossed_through <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(STATEFP, NAME, direction, day)</span>
<span id="cb16-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 32 features and 4 fields</span></span>
<span id="cb16-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: GEOMETRY</span></span>
<span id="cb16-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb16-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9</span></span>
<span id="cb16-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb16-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## First 10 features:</span></span>
<span id="cb16-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      STATEFP        NAME direction day                       geometry</span></span>
<span id="cb16-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4         13     Georgia     There   1 LINESTRING (-84.4 33.7, -84...</span></span>
<span id="cb16-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10        22   Louisiana     There   1 LINESTRING (-89.6 30.3, -89...</span></span>
<span id="cb16-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 32        28 Mississippi     There   1 LINESTRING (-88.4 30.5, -88...</span></span>
<span id="cb16-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 41        01     Alabama     There   1 LINESTRING (-85.2 32.9, -85...</span></span>
<span id="cb16-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1         48       Texas     There   2 LINESTRING (-93.7 30.1, -93...</span></span>
<span id="cb16-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10.1      22   Louisiana     There   2 LINESTRING (-90.1 30, -90.3...</span></span>
<span id="cb16-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1.1       48       Texas     There   3 LINESTRING (-98.5 29.4, -98...</span></span>
<span id="cb16-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 36        35  New Mexico     There   3 LINESTRING (-104 32, -104 3...</span></span>
<span id="cb16-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 36.1      35  New Mexico     There   4 LINESTRING (-104 32.4, -104...</span></span>
<span id="cb16-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 47        04     Arizona     There   4 LINESTRING (-109 35.4, -109...</span></span>
<span id="cb16-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(states_crossed_through<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME)</span>
<span id="cb16-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  [1] "Georgia"      "Louisiana"    "Mississippi"  "Alabama"      "Texas"        "New Mexico"   "Arizona"      "Utah"         "Idaho"        "Montana"      "Wyoming"      "South Dakota" "Minnesota"    "Illinois"     "Iowa"         "Kentucky"     "Missouri"     "Tennessee"</span></span>
<span id="cb16-29"></span>
<span id="cb16-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a column that flags if the state is cross through</span></span>
<span id="cb16-31">lower_48_highlighted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb16-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visited =</span> NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(states_crossed_through<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME))</span></code></pre></div>
</details>
</div>
<p>Now we can fill using the <code>visited</code> column and make the visited states subtly darker:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb17-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique,</span>
<span id="cb17-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb17-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb17-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb17-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb17-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb17-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb17-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-highlighted-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Map of road trip route with crossed-through states highlighted"></p>
<figcaption class="figure-caption margin-caption">Map of road trip route with crossed-through states highlighted</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="summary-statistics" class="level1 page-columns page-full">
<h1>Summary statistics</h1>
<p>Now that we have a list of the states we’ll cross through, let’s play with some quick summary statistics.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">n_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(states_crossed_through<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME))</span>
<span id="cb18-2">n_states</span>
<span id="cb18-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 18</span></span>
<span id="cb18-4"></span>
<span id="cb18-5">total_distance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(routes_geocoded<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>route_distance) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">km_to_miles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_miles</span>()</span>
<span id="cb18-6">total_distance</span>
<span id="cb18-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "5,260 miles"</span></span>
<span id="cb18-8"></span>
<span id="cb18-9">total_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(routes_geocoded<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>route_duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_duration</span>()</span>
<span id="cb18-10">total_time</span>
<span id="cb18-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] "99 hours 15 minutes"</span></span></code></pre></div>
</details>
</div>
<p><strong>We’re going to drive through 18 states, with a total distance of 5,260 miles over the span of 99 hours 15 minutes (!!)</strong></p>
<p>We can use these distance or duration columns to add some extra detail to the map:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb19-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded,</span>
<span id="cb19-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> distance_text, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> route_geometry),</span>
<span id="cb19-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12345</span>,</span>
<span id="cb19-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb19-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb19-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb19-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb19-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb19-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb19-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{n_states} states; {total_distance}; and {total_time} in the car. Bring it on."</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-distances-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Map of road trip showing the distances between each stop"></p>
<figcaption class="figure-caption margin-caption">Map of road trip showing the distances between each stop</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="faceting" class="level1 page-columns page-full">
<h1>Faceting</h1>
<p>We have some nice tidy data here with columns for direction and day, which makes it easy to subset the data. We can make separate maps for the drive there and the drive back, or even separate maps for each day of the trip. Let’s add <code>facet_wrap()</code> to the plot:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb20-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb20-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb20-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb20-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(direction), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-facet-subset-issues-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Road trip map faceted by direction"></p>
<figcaption class="figure-caption margin-caption">Road trip map faceted by direction</figcaption>
</figure>
</div>
</div>
</div>
<p>There are two problems with this though:</p>
<ol type="1">
<li>The highlighted states are the same in both facets</li>
<li>The final destination point is missing in each facet (Spanish Fork, Utah in the “There” facet; Atlanta, Georgia in the “Back Again” facet)</li>
</ol>
<p>Both of these issues are fixable though.</p>
<section id="fixing-state-highlighting" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="fixing-state-highlighting">Fixing state highlighting</h2>
<p>First we need to change how we identify the states we’ll cross through. Before, we kept the unique state names, but this stripped away the details about the direction of the trip, so we’ll find all the distinct combinations of direction and state and then join that little dataset to <code>lower_48</code> to make the <code>visited</code> column:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">states_crossed_through_better <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(</span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(routes_geocoded)),</span>
<span id="cb21-3">  routes_geocoded</span>
<span id="cb21-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(direction, NAME)</span>
<span id="cb21-6">states_crossed_through_better</span>
<span id="cb21-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       direction         NAME</span></span>
<span id="cb21-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4         There      Georgia</span></span>
<span id="cb21-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10        There    Louisiana</span></span>
<span id="cb21-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 32        There  Mississippi</span></span>
<span id="cb21-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 41        There      Alabama</span></span>
<span id="cb21-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1         There        Texas</span></span>
<span id="cb21-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 36        There   New Mexico</span></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 47        There      Arizona</span></span>
<span id="cb21-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 35        There         Utah</span></span>
<span id="cb21-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12   Back again        Idaho</span></span>
<span id="cb21-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 35.2 Back again         Utah</span></span>
<span id="cb21-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15   Back again      Montana</span></span>
<span id="cb21-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 25   Back again      Wyoming</span></span>
<span id="cb21-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 23   Back again South Dakota</span></span>
<span id="cb21-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 16   Back again    Minnesota</span></span>
<span id="cb21-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14   Back again     Illinois</span></span>
<span id="cb21-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 18   Back again         Iowa</span></span>
<span id="cb21-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3    Back again     Kentucky</span></span>
<span id="cb21-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4.1  Back again      Georgia</span></span>
<span id="cb21-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 7    Back again     Missouri</span></span>
<span id="cb21-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 9    Back again    Tennessee</span></span>
<span id="cb21-28"></span>
<span id="cb21-29">lower_48_highlighted_better <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(states_crossed_through_better, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(NAME)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visited =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(direction))</span>
<span id="cb21-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(lower_48_highlighted_better)</span>
<span id="cb21-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 51 × 12</span></span>
<span id="cb21-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    STATEFP STATENS  AFFGEOID    GEOID STUSPS NAME       LSAD         ALAND      AWATER direction                                                                                 geometry visited</span></span>
<span id="cb21-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;                                                                           &lt;MULTIPOLYGON [°]&gt; &lt;lgl&gt;  </span></span>
<span id="cb21-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 48      01779801 0400000US48 48    TX     Texas      00    676685555821 18974391187 There      (((-107 31.9, -107 32, -107 32, -107 32, -106 32, -106 32, -106 32, -106 32, -105 32... TRUE   </span></span>
<span id="cb21-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 06      01779778 0400000US06 06    CA     California 00    403673617862 20291712025 &lt;NA&gt;       (((-119 33.5, -118 33.5, -118 33.4, -118 33.4, -118 33.3, -118 33.3, -118 33.3, -118... FALSE  </span></span>
<span id="cb21-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 21      01779786 0400000US21 21    KY     Kentucky   00    102266581101  2384240769 Back again (((-89.5 36.6, -89.5 36.6, -89.4 36.6, -89.4 36.6, -89.3 36.6, -89.3 36.6, -89.3 36.... TRUE   </span></span>
<span id="cb21-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 There      (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   </span></span>
<span id="cb21-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 Back again (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   </span></span>
<span id="cb21-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 55      01779806 0400000US55 55    WI     Wisconsin  00    140292518676 29343193162 &lt;NA&gt;       (((-86.9 45.4, -86.8 45.5, -86.8 45.4, -86.9 45.4, -86.9 45.3, -87 45.4, -86.9 45.4)... FALSE  </span></span>
<span id="cb21-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 41      01155107 0400000US41 41    OR     Oregon     00    248630319014  6169061220 &lt;NA&gt;       (((-125 42.8, -124 43, -124 43, -124 43.1, -124 43.2, -124 43.2, -124 43.3, -124 43.... FALSE  </span></span>
<span id="cb21-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 29      01779791 0400000US29 29    MO     Missouri   00    178052253239  2487526202 Back again (((-95.8 40.6, -95.5 40.6, -95.4 40.6, -95.3 40.6, -95.2 40.6, -95.1 40.6, -94.9 40.... TRUE   </span></span>
<span id="cb21-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 51      01779803 0400000US51 51    VA     Virginia   00    102258178227  8528072639 &lt;NA&gt;       (((-76 37.3, -76 37.4, -76 37.4, -75.9 37.5, -75.9 37.6, -75.9 37.6, -75.9 37.7, -75... FALSE  </span></span>
<span id="cb21-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 47      01325873 0400000US47 47    TN     Tennessee  00    106792368794  2322190840 Back again (((-90.3 35, -90.3 35, -90.2 35.1, -90.2 35.1, -90.2 35.1, -90.1 35.1, -90.1 35.2, -... TRUE   </span></span>
<span id="cb21-46"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # ℹ 41 more rows</span></span></code></pre></div>
</details>
</div>
<p>Let’s see how it works by adding a new <code>geom_sf()</code> layer for the highlighted states. We need to double up here with both <code>lower_48</code> and <code>lower_48_highlighted_better</code> because if we only plot the highlighted states, each facet will only contain those states and not the underlying US map, which we don’t want.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(lower_48_highlighted_better), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_unique) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb22-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb22-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb22-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb22-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(direction), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-facet-subset-issues-fixed1-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Each facet now only shows the states corresponding to each direction"></p>
<figcaption class="figure-caption margin-caption">Each facet now only shows the states corresponding to each direction</figcaption>
</figure>
</div>
</div>
</div>
<p>There, we fixed issue #1. ✅</p>
<p>Issue #2—the missing endpoint in each facet—is a little trickier to deal with, but still doable. Before messing with the real data, let’s look at a simpler toy example first. Here’s a little dataset with three different “routes” between cities. The coordinates here aren’t actually coordinates—they’re just some arbitrary numbers. But that’s okay—this basically mirrors what we have in <code>routes_geocoded</code></p>
</section>
<section id="fixing-missing-destination-cities" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="fixing-missing-destination-cities">Fixing missing destination cities</h2>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">example <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb23-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>day, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>origin_city, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>destination_city, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>origin_coords, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>destination_coords,</span>
<span id="cb23-3">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Atlanta"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Boston"</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,           <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5678</span>,</span>
<span id="cb23-4">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Boston"</span>,     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chicago"</span>,         <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5678</span>,           <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">91011</span>,</span>
<span id="cb23-5">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chicago"</span>,    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Denver"</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">91011</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">131415</span></span>
<span id="cb23-6">) </span>
<span id="cb23-7">example</span>
<span id="cb23-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 3 × 5</span></span>
<span id="cb23-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     day origin_city destination_city origin_coords destination_coords</span></span>
<span id="cb23-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;                    &lt;dbl&gt;              &lt;dbl&gt;</span></span>
<span id="cb23-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1 Atlanta     Boston                    1234               5678</span></span>
<span id="cb23-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     2 Boston      Chicago                   5678              91011</span></span>
<span id="cb23-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     3 Chicago     Denver                   91011             131415</span></span></code></pre></div>
</details>
</div>
<p>The reason we’re not getting the final point in each facet or subset is because there are only three rows here, but four cities. If we plotted the <code>origin_coords</code> column, Atlanta would be missing; if we plotted the <code>destination_coords</code> column, Denver would be missing. We need to manipulate this data so that it has 4 rows (Atlanta, Boston, Chicago, Denver), with the correct coordinates for each city.</p>
<p>There’s an easy way to do this with <code>pivot_longer()</code> from {tidyr}. We can pivot with multiple columns that follow a pattern in their names. Here, all four of the columns we care about are are prefixed <code>destination</code> or <code>origin</code>, followed by a <code>_</code>. If we specify these name settings in <code>pivot_longer()</code>, it’ll automatically create a column named <code>type</code> for destination and origin and it’ll put the rest of the data in corresponding columns:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">example <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb24-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(origin_city, destination_city, origin_coords, destination_coords),</span>
<span id="cb24-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".value"</span>),</span>
<span id="cb24-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span></span>
<span id="cb24-6">  )</span>
<span id="cb24-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 4</span></span>
<span id="cb24-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     day type        city    coords</span></span>
<span id="cb24-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span id="cb24-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1 origin      Atlanta   1234</span></span>
<span id="cb24-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     1 destination Boston    5678</span></span>
<span id="cb24-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     2 origin      Boston    5678</span></span>
<span id="cb24-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4     2 destination Chicago  91011</span></span>
<span id="cb24-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5     3 origin      Chicago  91011</span></span>
<span id="cb24-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6     3 destination Denver  131415</span></span></code></pre></div>
</details>
</div>
<p>Now we have one row per city, which is close to what we need. Boston and Chicago are duplicated (since they’re both destination and origin cities), so we need to filter out duplicate cities. There are lots of ways to do this—my preferred way is to group by city and keep the first row in each group using <code>slice()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">example <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb25-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(origin_city, destination_city, origin_coords, destination_coords),</span>
<span id="cb25-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".value"</span>),</span>
<span id="cb25-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span></span>
<span id="cb25-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb25-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 4 × 4</span></span>
<span id="cb25-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   city [4]</span></span>
<span id="cb25-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     day type        city    coords</span></span>
<span id="cb25-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span id="cb25-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1     1 origin      Atlanta   1234</span></span>
<span id="cb25-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2     1 destination Boston    5678</span></span>
<span id="cb25-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3     2 destination Chicago  91011</span></span>
<span id="cb25-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4     3 destination Denver  131415</span></span></code></pre></div>
</details>
</div>
<p>Woohoo! A dataset with four rows and the correct coordinates for each city. If we could plot this, we’d get both endpoints (Atlanta and Denver).</p>
<p>This same double pivot approach (magically!!) works with the special geometry columns in our actual routes data:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">all_stops_endpoints <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb26-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(origin_city, destination_city, origin_geometry, destination_geometry),</span>
<span id="cb26-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".value"</span>),</span>
<span id="cb26-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span></span>
<span id="cb26-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(direction, city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(direction, day, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use "geometry" as the default geometry column instead of the routes</span></span>
<span id="cb26-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"geometry"</span>)</span>
<span id="cb26-12"></span>
<span id="cb26-13">all_stops_endpoints</span>
<span id="cb26-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 15 features and 11 fields</span></span>
<span id="cb26-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: geometry</span></span>
<span id="cb26-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb26-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb26-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span id="cb26-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb26-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 15 × 13</span></span>
<span id="cb26-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   direction, city [15]</span></span>
<span id="cb26-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text       type        city                             geometry</span></span>
<span id="cb26-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;               &lt;chr&gt;       &lt;chr&gt;                         &lt;POINT [°]&gt;</span></span>
<span id="cb26-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  origin      Atlanta, Georgia             (-84.4 33.7)</span></span>
<span id="cb26-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  destination New Orleans, Louisiana         (-90.1 30)</span></span>
<span id="cb26-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          2 src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minutes  destination San Antonio, Texas           (-98.5 29.4)</span></span>
<span id="cb26-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          3 src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minutes  destination Carlsbad, New Mexico          (-104 32.4)</span></span>
<span id="cb26-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          4 src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 minutes destination Grand Canyon NP, Arizona      (-112 36.1)</span></span>
<span id="cb26-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          5 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minutes  destination Grover, Utah                  (-111 38.2)</span></span>
<span id="cb26-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 There          6 src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minutes  destination Spanish Fork, Utah            (-112 40.1)</span></span>
<span id="cb26-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  origin      Spanish Fork, Utah            (-112 40.1)</span></span>
<span id="cb26-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  destination Shelley, Idaho                (-112 43.4)</span></span>
<span id="cb26-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     1 src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes  destination Yellowstone NP, Wyoming       (-111 44.5)</span></span>
<span id="cb26-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     2 src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minutes  destination Devil's Tower, Wyoming        (-105 44.6)</span></span>
<span id="cb26-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 Back again     2 src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minutes  destination Mount Rushmore, South Dakota  (-103 43.9)</span></span>
<span id="cb26-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 13 Back again     3 src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minutes  destination Albert Lea, Minnesota        (-93.4 43.6)</span></span>
<span id="cb26-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 14 Back again     4 src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minutes   destination Nauvoo, Illinois             (-91.4 40.6)</span></span>
<span id="cb26-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 Back again     5 src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minutes  destination Atlanta, Georgia             (-84.4 33.7)</span></span></code></pre></div>
</details>
</div>
<p>And plotted:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(lower_48_highlighted_better), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes_geocoded, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_endpoints) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb27-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> all_stops_endpoints,</span>
<span id="cb27-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb27-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb27-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb27-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb27-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb27-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb27-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb27-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(direction), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-facet-subset-issues-fixed2-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Each facet now shows the destination city"></p>
<figcaption class="figure-caption margin-caption">Each facet now shows the destination city</figcaption>
</figure>
</div>
</div>
</div>
<p>Issue #2 fixed. ✅</p>
</section>
</section>
<section id="zooming-in" class="level1 page-columns page-full">
<h1>Zooming in</h1>
<p>We can also make separate maps that are zoomed in on each day of the trip in addition these bigger overarching ones. This will allow us to add more details like driving time and distances without getting too crowded on the map.</p>
<p>We’ll create a mini map of the first day by itself, and then scale up the process to make all the mini maps programmatically.</p>
<section id="one-day-of-the-trip" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="one-day-of-the-trip">One day of the trip</h2>
<p>First we’ll extract the route, cities, and states for the first day of the trip out there:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">route_day1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(direction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb28-3"></span>
<span id="cb28-4">stops_day1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_stops_endpoints <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(direction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There"</span>, day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb28-6"></span>
<span id="cb28-7">states_crossed_day1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(</span>
<span id="cb28-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(route_day1)),</span>
<span id="cb28-9">  route_day1</span>
<span id="cb28-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(NAME)</span>
<span id="cb28-12"></span>
<span id="cb28-13">lower_48_highlighted_day1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visited =</span> NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> states_crossed_day1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME)</span></code></pre></div>
</details>
</div>
<p>Let’s plot these to make sure it worked:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted_day1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> route_day1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(</span>
<span id="cb29-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1, </span>
<span id="cb29-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city),</span>
<span id="cb29-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb29-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb29-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day1-preliminary-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Drive for the first day on the full US map"></p>
<figcaption class="figure-caption margin-caption">Drive for the first day on the full US map</figcaption>
</figure>
</div>
</div>
</div>
<p>Yep, it worked. But we don’t need to show the whole map—we want to zoom in on just the area around the route for the day. To do this, we can use <code>st_bbox()</code> to extract a rectangle of coordinates around the route, creating a bounding box for the map that we can then use with <code>coord_sf()</code> to zoom in.</p>
<p><code>st_bbox()</code> returns a named vector of numbers with the x- and y-axis limits:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">bbox <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>(route_day1)</span>
<span id="cb30-2">bbox</span>
<span id="cb30-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  xmin  ymin  xmax  ymax </span></span>
<span id="cb30-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## -90.1  30.0 -84.4  33.7</span></span></code></pre></div>
</details>
</div>
<p>Since the elements are all named, we can use them to specify the different values in <code>coord_sf()</code>. First we’ll temporarily stop using the <a href="https://en.wikipedia.org/wiki/Albers_projection">Albers projection</a>, since the numbers we’ve extracted with <code>st_bbox()</code> are on the <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS 84 (−180 to 180) scale</a> and Albers uses meters, which will make the map not work. (But we’ll fix that in a minute!)</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted_day1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> route_day1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(</span>
<span id="cb31-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1, </span>
<span id="cb31-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city),</span>
<span id="cb31-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We're not using Albers, so this isn't measured in meters; it's decimal degrees</span></span>
<span id="cb31-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span></span>
<span id="cb31-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb31-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb31-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span></span>
<span id="cb31-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb31-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmin"</span>], bbox[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmax"</span>]), </span>
<span id="cb31-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymin"</span>], bbox[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymax"</span>])</span>
<span id="cb31-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day1-bbox-basic-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, but zoomed in a little too far"></p>
<figcaption class="figure-caption margin-caption">Trip for the first day, but zoomed in a little too far</figcaption>
</figure>
</div>
</div>
</div>
<p>We’re zoomed in (yay) but the edges of the bounding box window are too close to the points and the route, and the labels are cropped funny. Also, to shift the labels up we had to think in <a href="https://en.wikipedia.org/wiki/Decimal_degrees">decimal degrees</a> instead of meters, which I can’t do naturally. And also, we can’t change projections—because we’re specifying the bounding box coordinates in decimal degrees, we’re stuck with WGS 84 instead of Albers or any other projection. These are all fixable issues, fortunately.</p>
<p>To fix all this, we’ll expand the bounding box window by 150 miles on all sides using <code>st_buffer()</code> and then convert the coordinates to Albers before extracting the coordinates of the window for plotting:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">bbox_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> route_day1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the coordinates</span></span>
<span id="cb32-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sfc</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the bounding box matrix back to an sf object</span></span>
<span id="cb32-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_buffer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add 150 miles to all sides</span></span>
<span id="cb32-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Switch to Albers</span></span>
<span id="cb32-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the expanded box</span></span>
<span id="cb32-7">bbox_nice</span>
<span id="cb32-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     xmin     ymin     xmax     ymax </span></span>
<span id="cb32-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   301851 -1071395  1366321  -105313</span></span></code></pre></div>
</details>
</div>
<p>These are no longer in decimal degrees, so we can use them with the Albers projection. We’ve also added a 150-mile buffer around the window, so we should have room for all the labels now. Let’s check it:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted_day1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> route_day1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(</span>
<span id="cb33-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1, </span>
<span id="cb33-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city),</span>
<span id="cb33-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We're in Albers again, so we can work with meters (or miles)</span></span>
<span id="cb33-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb33-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb33-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb33-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb33-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width_hint =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb33-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb33-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmax"</span>]), </span>
<span id="cb33-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymax"</span>]),</span>
<span id="cb33-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)</span>
<span id="cb33-21">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day1-bbox-buffer-albers-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, correctly zoomed and using the Albers projection"></p>
<figcaption class="figure-caption margin-caption">Trip for the first day, correctly zoomed and using the Albers projection</figcaption>
</figure>
</div>
</div>
</div>
<p>Heck yeah.</p>
<p>However, the shapes look a little curved and distorted because we’re zoomed in so much. Albers is great for big countries, but on a small scale like this, WGS 84 is probably fine. That’s what Google Maps does—it only starts getting weird and curvy along horizontal latitude lines when you zoom out really far. Let’s do the first day map one last time without the Albers conversion:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">bbox_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> route_day1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the coordinates</span></span>
<span id="cb34-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sfc</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the bounding box matrix back to an sf object</span></span>
<span id="cb34-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_buffer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add 150 miles to all sides</span></span>
<span id="cb34-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the expanded box</span></span>
<span id="cb34-6"></span>
<span id="cb34-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48_highlighted_day1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> route_day1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(</span>
<span id="cb34-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops_day1, </span>
<span id="cb34-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city),</span>
<span id="cb34-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We're in WGS 84, so these are decimal degrees</span></span>
<span id="cb34-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb34-16">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb34-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> route_day1,</span>
<span id="cb34-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> distance_text, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> route_geometry),</span>
<span id="cb34-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12345</span>,</span>
<span id="cb34-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>,</span>
<span id="cb34-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb34-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb34-24">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb34-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb34-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb34-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width_hint =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb34-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb34-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmax"</span>]), </span>
<span id="cb34-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymax"</span>]),</span>
<span id="cb34-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)</span>
<span id="cb34-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day1-bbox-buffer-wgs84-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, correctly zoomed and using the WGS 84 projection"></p>
<figcaption class="figure-caption margin-caption">Trip for the first day, correctly zoomed and using the WGS 84 projection</figcaption>
</figure>
</div>
</div>
</div>
<p>Neat. The northern borders of Georgia, Alabama, and Mississippi are all flat here, which is great.</p>
</section>
<section id="all-the-days-of-the-trip" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="all-the-days-of-the-trip">All the days of the trip</h2>
<p>We successfully plotted one day of the trip. But we’ll be driving for 11 days (!) and need 11 plots. I don’t want to copy/paste this all code 11 times, so we’ll stick each major step into a function:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take a set of routes and do some pivoting to create a dataset that includes</span></span>
<span id="cb35-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the start and end points</span></span>
<span id="cb35-3">expand_endpoints <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(routes) {</span>
<span id="cb35-4">  routes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb35-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(origin_city, destination_city, origin_geometry, destination_geometry),</span>
<span id="cb35-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".value"</span>),</span>
<span id="cb35-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span></span>
<span id="cb35-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(city) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"geometry"</span>)</span>
<span id="cb35-14">}</span>
<span id="cb35-15"></span>
<span id="cb35-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take a set of routes and return a dataset with a flag marking which states they cross</span></span>
<span id="cb35-17">find_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(routes) {</span>
<span id="cb35-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># st_intersection() complains about innocuous things so suppress the warnings</span></span>
<span id="cb35-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>({</span>
<span id="cb35-20">    states_crossed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_intersection</span>(</span>
<span id="cb35-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(routes)),</span>
<span id="cb35-22">      routes</span>
<span id="cb35-23">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(NAME)</span>
<span id="cb35-25">  })</span>
<span id="cb35-26">  </span>
<span id="cb35-27">  lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">visited =</span> NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> states_crossed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NAME)</span>
<span id="cb35-29">}</span>
<span id="cb35-30"></span>
<span id="cb35-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use routes, stopes, and states to build a plot</span></span>
<span id="cb35-32">build_day_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(routes, stops, states, direction, day) {</span>
<span id="cb35-33">  bbox_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-34">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the coordinates</span></span>
<span id="cb35-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sfc</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the bounding box matrix back to an sf object</span></span>
<span id="cb35-36">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_buffer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add 150 miles to all sides</span></span>
<span id="cb35-37">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounding box of the expanded box</span></span>
<span id="cb35-38"></span>
<span id="cb35-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> states, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> visited)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(</span>
<span id="cb35-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stops,</span>
<span id="cb35-45">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> city),</span>
<span id="cb35-46">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We're in WGS 84, so these are decimal degrees</span></span>
<span id="cb35-47">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb35-48">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-49">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb35-50">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> routes,</span>
<span id="cb35-51">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> distance_text, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> route_geometry),</span>
<span id="cb35-52">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12345</span>,</span>
<span id="cb35-53">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>,</span>
<span id="cb35-54">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb35-55">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">segment.color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.segment.length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-56">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-57">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(</span>
<span id="cb35-58">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb35-59">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb35-60">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width_hint =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb35-61">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-62">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-63">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(</span>
<span id="cb35-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xmax"</span>]),</span>
<span id="cb35-65">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymin"</span>], bbox_nice[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ymax"</span>]),</span>
<span id="cb35-66">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)</span>
<span id="cb35-67">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-68">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{direction}, day {day}"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-69">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_roadtrip</span>()</span>
<span id="cb35-70">}</span></code></pre></div>
</details>
</div>
<p>With everything functionalized, we can do some super wild {purrr} magic. If we take <code>routes_geocoded</code> and group it by direction and day (so there’s a group per driving day), we’ll get a list column that contains the geocded coordinates for each day:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">daily_plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(direction, day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.key =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"routes"</span>)</span>
<span id="cb36-4"></span>
<span id="cb36-5">daily_plots</span>
<span id="cb36-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 11 × 3</span></span>
<span id="cb36-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   direction, day [11]</span></span>
<span id="cb36-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day routes       </span></span>
<span id="cb36-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;      &lt;dbl&gt; &lt;list&gt;       </span></span>
<span id="cb36-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 &lt;sf [2 × 12]&gt;</span></span>
<span id="cb36-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     2 &lt;sf [2 × 12]&gt;</span></span>
<span id="cb36-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     3 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     4 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     5 &lt;sf [1 × 12]&gt;</span></span>
<span id="cb36-21"></span>
<span id="cb36-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the first day</span></span>
<span id="cb36-23">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>routes[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb36-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 1 feature and 9 fields</span></span>
<span id="cb36-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: route_geometry</span></span>
<span id="cb36-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: LINESTRING</span></span>
<span id="cb36-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb36-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -90.1 ymin: 30 xmax: -84.4 ymax: 33.7</span></span>
<span id="cb36-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb36-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 12</span></span>
<span id="cb36-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   origin_city      origin_geometry destination_geometry destination_city       route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     </span></span>
<span id="cb36-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                  &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;             </span></span>
<span id="cb36-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Atlanta, Georgia    (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes</span></span>
<span id="cb36-34"></span>
<span id="cb36-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the first day of the return trip</span></span>
<span id="cb36-36">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>routes[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]]</span>
<span id="cb36-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 2 features and 9 fields</span></span>
<span id="cb36-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Active geometry column: route_geometry</span></span>
<span id="cb36-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: LINESTRING</span></span>
<span id="cb36-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb36-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -112 ymin: 40.1 xmax: -111 ymax: 44.7</span></span>
<span id="cb36-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb36-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 12</span></span>
<span id="cb36-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   origin_city        origin_geometry destination_geometry destination_city        route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     </span></span>
<span id="cb36-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                  &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                   &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;             </span></span>
<span id="cb36-46"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Spanish Fork, Utah     (-112 40.1)          (-112 43.4) Shelley, Idaho          src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes</span></span>
<span id="cb36-47"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Shelley, Idaho         (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes</span></span></code></pre></div>
</details>
</div>
<p>We can then use <code>purrr::map()</code> and <code>purrr::pmap()</code> to feed that nested list-column data frame through the different functions to expand endpoints, find crossed-through states, and build the daily plot.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">daily_plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> routes_geocoded <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(direction, day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb37-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.key =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"routes"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb37-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb37-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stops =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(routes, expand_endpoints),</span>
<span id="cb37-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">states =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(routes, find_states),</span>
<span id="cb37-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(routes, stops, states, direction, day), build_day_map)</span>
<span id="cb37-8">  )</span></code></pre></div>
</details>
</div>
<p>Before looking at the plots, check out all these nested datasets! Each day has a dataset for the routes, stops, states, and final plot, and everything is contained here in a data frame. MAGICAL.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">daily_plots</span>
<span id="cb38-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 11 × 6</span></span>
<span id="cb38-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # Groups:   direction, day [11]</span></span>
<span id="cb38-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    direction    day routes        stops         states         plot  </span></span>
<span id="cb38-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;      &lt;dbl&gt; &lt;list&gt;        &lt;list&gt;        &lt;list&gt;         &lt;list&gt;</span></span>
<span id="cb38-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 There          1 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 There          2 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 There          3 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 There          4 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 There          5 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 There          6 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 Back again     1 &lt;sf [2 × 12]&gt; &lt;sf [3 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 Back again     2 &lt;sf [2 × 12]&gt; &lt;sf [3 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 Back again     3 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 Back again     4 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span id="cb38-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 Back again     5 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;</span></span></code></pre></div>
</details>
</div>
<p>We can extract the plot for any single day with indexing:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day10-indexed-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the day 4 of the return trip"></p>
<figcaption class="figure-caption margin-caption">Trip for the day 4 of the return trip</figcaption>
</figure>
</div>
</div>
</div>
<p>Or we can filter, pull, and pluck like good denizens of the tidyverse:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">daily_plots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(direction <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Back again"</span>, day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(plot) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-day5-verbose-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the day 5 of the return trip"></p>
<figcaption class="figure-caption margin-caption">Trip for the day 5 of the return trip</figcaption>
</figure>
</div>
</div>
</div>
<p>Here’s all of them simultaneously inside a <a href="https://quarto.org/docs/output-formats/html-basics.html#tabsets">Quarto tabset</a>, just for fun:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">The trip there</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">The trip back again</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">Day 1</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Day 2</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">Day 3</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false">Day 4</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false">Day 5</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" aria-controls="tabset-1-6" aria-selected="false">Day 6</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day1-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day2-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" aria-labelledby="tabset-1-6-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-there-day6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">Day 1</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Day 2</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false">Day 3</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" aria-controls="tabset-2-4" aria-selected="false">Day 4</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" aria-controls="tabset-2-5" aria-selected="false">Day 5</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-back-day1-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-back-day2-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-back-day3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" aria-labelledby="tabset-2-4-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-back-day4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" aria-labelledby="tabset-2-5-tab">
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">daily_plots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>]]</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/panel-back-day5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Or, instead of extracting each plot individually like this, we can use <code>wrap_plots()</code> from {patchwork} to combine a whole list of plots automatically, though we have a lot less control over the plots this way—some of the maps use a landscape orientation and some use a portrait orientation, so they’re a big mess when combined like this:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">daily_plots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb52-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(plot) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb52-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wrap_plots</span>()</span></code></pre></div>
</details>
<div class="cell-output-display column-screen-inset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/patchwork-everything-ugly-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Ugly massive plot of all the days of the trip"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Time to add some maps to road trip journals and finish packing!</p>


<!-- -->

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {How to Make Fancy Road Trip Maps with {R} and
    {OpenStreetMap}},
  date = {2023-06-01},
  url = {https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r},
  doi = {10.59350/rgwda-0tv16},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“How to Make Fancy Road Trip Maps with R and
OpenStreetMap.”</span> June 1, 2023. <a href="https://doi.org/10.59350/rgwda-0tv16">https://doi.org/10.59350/rgwda-0tv16</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>gis</category>
  <category>maps</category>
  <guid>https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index.html</guid>
  <pubDate>Wed, 31 May 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-distances-1.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>A guide to Bayesian proportion tests with R and {brms}</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index.html</link>
  <description><![CDATA[ 




<div class="cell" data-layout-align="center">
<style type="text/css">
.magic-block {
  font-style: normal;
  user-select: none;
  padding: 0 0.1em 0 0.15em;
  line-height: 1;
  font-size: 120%;
}
</style>
</div>
<p>I’ve been working on converting a couple of my dissertation chapters into standalone articles, so I’ve been revisiting and improving my older R code. As part of my dissertation work, I ran a global survey of international NGOs to see how they adjust their programs and strategies when working under authoritarian legal restrictions in dictatorship. In the survey, I asked a bunch of questions with categorical responses (like “How would you characterize your organization’s relationship with your host-country government?”, with the possible responses “Positive,” “Negative”, and “Neither”).</p>
<p>Analyzing this kind of categorical data can be tricky. What I ended up doing (and what people typically do) is looking at the differences in proportions of responses (i.e.&nbsp;is there a substantial difference in the proportion reporting “Positive” or “Negative” in different subgroups?). But doing this requires a little bit of extra work because of how proportions work. We can’t just treat proportions like continuous values. Denominators matter and help determine the level of uncertainty in the proportions. We need to account for these disparate sample sizes underlying the proportions.</p>
<div class="page-columns page-full"><p>Additionally, it’s tempting to treat <a href="https://en.wikipedia.org/wiki/Likert_scale">Likert scale responses</a><sup>1</sup> (i.e.&nbsp;things like “strongly agree”, “agree”, “neutral”, etc.) as numbers (e.g.&nbsp;make “strongly agree” a 2, “agree” a 1, “neutral” a 0, and so on), and then find things like averages (e.g.&nbsp;“the average response is a 1.34”), but those summary statistics aren’t actually that accurate. What would a 1.34 mean? A little higher than agree? What does that even mean?</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Pronounced “lick-ert”!</p></li></div></div>
<p>We need to treat these kinds of survey questions as the categories that they are, which requires a different set of analytical tools than just findings averages and running linear regressions. We instead need to use things like frequencies, proportions, <a href="https://en.wikipedia.org/wiki/Contingency_table">contingency tables and crosstabs</a>, and fancier regression like ordered logistic models.</p>
<p>I’m a fan of Bayesian statistical inference—I find it way more intuitive and straightforward than frequentist null hypothesis testing. I first “converted” to Bayesianism back when I first analyzed my dissertation data in 2017 and used the newly-invented <a href="https://mc-stan.org/rstanarm/">{rstanarm} package</a> to calculate the difference in proportions of my various survey responses in Bayesian ways, based on <a href="https://www.sumsar.net/blog/2014/06/bayesian-first-aid-prop-test/">a blog post and package for Bayesian proportion tests by Rasmus Bååth</a>. He used <a href="https://mcmc-jags.sourceforge.io/">JAGS</a>, though, and I prefer to use <a href="https://mc-stan.org/">Stan</a>, hence my use of {rstanarm} back then.</p>
<p>Since 2017, though, I’ve learned a lot more about Bayesianism. I’ve <a href="https://bayesf22.classes.andrewheiss.com/">worked</a> <a href="https://bayesf22-notebook.classes.andrewheiss.com/">through</a> both <a href="https://xcelab.net/rm/statistical-rethinking/">Richard McElreath’s <em>Statistical Rethinking</em></a> and <a href="https://www.bayesrulesbook.com/">the gloriously accessible <em>Bayes Rules!</em></a>, and I no longer use {rstanarm}. I instead use <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for everything (or raw Stan if I’m feeling extra fancy).</p>
<p>So, as a reference for myself while rewriting these chapters, and as a way to consolidate everything I’ve learned about Bayesian-flavored proportion tests, here’s a guide to thinking about differences in proportions in a principled Bayesian way. I explore two different questions (explained in detail below). For the first one I’ll be super pedagogical and long-winded, showing how to find differences in proportions with classical frequentist statistical tests, with different variations of Stan code, and with different variations of {brms} code. For the second one I’ll be less pedagogical and just show the code and results.</p>
<section id="who-this-post-is-for" class="level1">
<h1>Who this post is for</h1>
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws</li>
</ul>
</section>
<section id="wrangling-and-exploring-the-data" class="level1 page-columns page-full">
<h1>Wrangling and exploring the data</h1>
<p>Before getting started, let’s load all the packages we need and create some helpful functions and variables:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot, dplyr, and friends</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fancy tables</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Easier string interpolation</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nicer labeling functions</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggmosaic)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosaic plots with ggplot</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggpattern)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pattern fills in ggplot</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine plots nicely</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(parameters)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract model parameters as data frames</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cmdstanr)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run Stan code from R</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nice frontend for Stan</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Manipulate MCMC chains in a tidy way</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(likert)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Contains the pisaitems data</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the cmdstanr backend for brms because it's faster and more modern than the</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># default rstan backend. You need to install the cmdstanr package first</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install cmdstan on your computer.</span></span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb1-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">brms.backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set some global Stan options</span></span>
<span id="cb1-22">CHAINS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-23">ITER <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span></span>
<span id="cb1-24">WARMUP <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-25">BAYES_SEED <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span></span>
<span id="cb1-26"></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span id="cb1-29">theme_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-32">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-33">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost Medium"</span>),</span>
<span id="cb1-34">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-35">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb1-36">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb1-37">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-38">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb1-39">}</span>
<span id="cb1-40"></span>
<span id="cb1-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for formatting axes as percentage points</span></span>
<span id="cb1-42">label_pp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb1-43">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" pp."</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_negative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minus"</span>)</span></code></pre></div>
</details>
</div>
<p>Throughout this guide, we’ll use data from the 2009 <a href="https://en.wikipedia.org/wiki/Programme_for_International_Student_Assessment">Programme of International Student Assessment (PISA) survey</a>, which is available in the <a href="https://github.com/jbryer/likert">{likert} package</a>. PISA is administered every three years to 15-year-old students in dozens of countries, and it tracks academic performance, outcomes, and student attitudes cross-nationally.</p>
<p>One of the questions on the <a href="https://www.oecd.org/pisa/pisaproducts/PISA09_Student_questionnaire.pdf">PISA student questionnaire</a> (Q25) asks respondents how often they read different types of materials:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/img/pisa.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">2009 PISA Q25</figcaption>
</figure>
</div>
<p>The excerpt of PISA data included in the {likert} package only includes responses from Canada, Mexico, and the United States, and for this question it seems to omit data from Canada, so we’ll compare the reading frequencies of American and Mexican students. Specifically we’ll look at how these students read comic books and newspapers. My wife is currently finishing her masters thesis on religious representation in graphic novels, and I’m a fan of comics in general, so it’ll be interesting to see how students in the two countries read these books. We’ll look at newspapers because it’s an interesting category with some helpful variation (reading trends for magazines, fiction, and nonfiction look basically the same in both countries so we’ll ignore them here.)</p>
<p>First we’ll load and clean the data. For the sake of illustration in this post, I collapse the five possible responses into just three:</p>
<ul>
<li>Rarely = Never or almost never</li>
<li>Sometimes = A few times a year &amp; About once a month</li>
<li>Often = Several times a month &amp; Several times a week</li>
</ul>
<p>In real life it’s typically a bad idea to collapse categories like this, and I’m not an education researcher so this collapsing is probably bad and wrong, but whatever—just go with it :)</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the data</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pisaitems"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"likert"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a clean wide version of the data</span></span>
<span id="cb2-5">reading_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pisaitems <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add ID column</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep a few columns</span></span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> CNT, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Comic books</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ST25Q02, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Newspapers =</span> ST25Q05) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collapse these categories</span></span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Comic books</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, Newspapers), </span>
<span id="cb2-12">                <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_collapse</span>(</span>
<span id="cb2-13">                  .,</span>
<span id="cb2-14">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rarely"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Never or almost never"</span>),</span>
<span id="cb2-15">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sometimes"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A few times a year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"About once a month"</span>),</span>
<span id="cb2-16">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Several times a month"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Several times a week"</span>)))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make sure the new categories are ordered correctly</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Comic books</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, Newspapers), </span>
<span id="cb2-19">                <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(., <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rarely"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sometimes"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>)))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only keep the US and Mexico and get rid of the empty Canada level</span></span>
<span id="cb2-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mexico"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_drop</span>(country))</span>
<span id="cb2-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(reading_wide)</span>
<span id="cb2-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      id country Comic books Newspapers</span></span>
<span id="cb2-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 23208  Mexico   Sometimes      Often</span></span>
<span id="cb2-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 23209  Mexico      Rarely      Often</span></span>
<span id="cb2-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 23210  Mexico       Often      Often</span></span>
<span id="cb2-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 23211  Mexico   Sometimes  Sometimes</span></span>
<span id="cb2-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 23212  Mexico      Rarely      Often</span></span>
<span id="cb2-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 23213  Mexico   Sometimes  Sometimes</span></span>
<span id="cb2-31"></span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a tidy (long) version</span></span>
<span id="cb2-33">reading <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(id, country),</span>
<span id="cb2-35">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"book_type"</span>,</span>
<span id="cb2-36">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"frequency"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(frequency)</span>
<span id="cb2-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(reading)</span>
<span id="cb2-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 6 × 4</span></span>
<span id="cb2-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      id country book_type   frequency</span></span>
<span id="cb2-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;int&gt; &lt;fct&gt;   &lt;chr&gt;       &lt;fct&gt;    </span></span>
<span id="cb2-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 23208 Mexico  Comic books Sometimes</span></span>
<span id="cb2-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 23208 Mexico  Newspapers  Often    </span></span>
<span id="cb2-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 23209 Mexico  Comic books Rarely   </span></span>
<span id="cb2-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 4 23209 Mexico  Newspapers  Often    </span></span>
<span id="cb2-46"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 5 23210 Mexico  Comic books Often    </span></span>
<span id="cb2-47"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 6 23210 Mexico  Newspapers  Often</span></span></code></pre></div>
</details>
</div>
<p>Since we created a tidy (long) version of the data, we can use {dplyr} to create some overall group summaries of reading frequency by type of material across countries. Having data in this format, with a column for the specific total (i.e.&nbsp;Mexico + Comic books + Rarely, and so on, or <code>n</code> here) and the overall country total (or <code>total</code> here), allows us to calculate group proportions (<code>n / total</code>):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">reading_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, book_type, frequency) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, book_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n),</span>
<span id="cb3-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb3-8">reading_counts</span>
<span id="cb3-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 12 × 6</span></span>
<span id="cb3-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    country       book_type   frequency     n total  prop</span></span>
<span id="cb3-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;fct&gt;         &lt;chr&gt;       &lt;fct&gt;     &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb3-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 Mexico        Comic books Rarely     9897 37641 0.263</span></span>
<span id="cb3-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 Mexico        Comic books Sometimes 17139 37641 0.455</span></span>
<span id="cb3-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 Mexico        Comic books Often     10605 37641 0.282</span></span>
<span id="cb3-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 Mexico        Newspapers  Rarely     6812 37794 0.180</span></span>
<span id="cb3-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 Mexico        Newspapers  Sometimes 12369 37794 0.327</span></span>
<span id="cb3-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 Mexico        Newspapers  Often     18613 37794 0.492</span></span>
<span id="cb3-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 United States Comic books Rarely     3237  5142 0.630</span></span>
<span id="cb3-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 United States Comic books Sometimes  1381  5142 0.269</span></span>
<span id="cb3-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 United States Comic books Often       524  5142 0.102</span></span>
<span id="cb3-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 United States Newspapers  Rarely     1307  5172 0.253</span></span>
<span id="cb3-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 11 United States Newspapers  Sometimes  1925  5172 0.372</span></span>
<span id="cb3-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 12 United States Newspapers  Often      1940  5172 0.375</span></span></code></pre></div>
</details>
</div>
<p>And we can do a little pivoting and formatting and make this nice little contingency table / crosstab summarizing the data across the two countries:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">fancy_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nice =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{prop}&lt;br&gt;&lt;span style='font-size:70%'&gt;({n})&lt;/span&gt;"</span>,</span>
<span id="cb4-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()(prop),</span>
<span id="cb4-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>()(n))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"frequency"</span>,</span>
<span id="cb4-7">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nice"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_label</span>(</span>
<span id="cb4-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">book_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb4-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_markdown</span>(</span>
<span id="cb4-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>()</span>
<span id="cb4-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_horizontal_padding</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opt_table_font</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">font =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fira Sans"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_labels.font.weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb4-19">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_group.font.weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb4-20">fancy_table</span></code></pre></div>
</details>
<div class="cell-output-display">

<div id="pzveloiefp" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#pzveloiefp table {
  font-family: 'Fira Sans', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#pzveloiefp thead, #pzveloiefp tbody, #pzveloiefp tfoot, #pzveloiefp tr, #pzveloiefp td, #pzveloiefp th {
  border-style: none;
}

#pzveloiefp p {
  margin: 0;
  padding: 0;
}

#pzveloiefp .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pzveloiefp .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#pzveloiefp .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pzveloiefp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pzveloiefp .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#pzveloiefp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pzveloiefp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pzveloiefp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pzveloiefp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pzveloiefp .gt_spanner_row {
  border-bottom-style: hidden;
}

#pzveloiefp .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#pzveloiefp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pzveloiefp .gt_from_md > :first-child {
  margin-top: 0;
}

#pzveloiefp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pzveloiefp .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pzveloiefp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#pzveloiefp .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#pzveloiefp .gt_row_group_first td {
  border-top-width: 2px;
}

#pzveloiefp .gt_row_group_first th {
  border-top-width: 2px;
}

#pzveloiefp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#pzveloiefp .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#pzveloiefp .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#pzveloiefp .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#pzveloiefp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pzveloiefp .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pzveloiefp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pzveloiefp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#pzveloiefp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pzveloiefp .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#pzveloiefp .gt_left {
  text-align: left;
}

#pzveloiefp .gt_center {
  text-align: center;
}

#pzveloiefp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pzveloiefp .gt_font_normal {
  font-weight: normal;
}

#pzveloiefp .gt_font_bold {
  font-weight: bold;
}

#pzveloiefp .gt_font_italic {
  font-style: italic;
}

#pzveloiefp .gt_super {
  font-size: 65%;
}

#pzveloiefp .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#pzveloiefp .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#pzveloiefp .gt_indent_1 {
  text-indent: 5px;
}

#pzveloiefp .gt_indent_2 {
  text-indent: 10px;
}

#pzveloiefp .gt_indent_3 {
  text-indent: 15px;
}

#pzveloiefp .gt_indent_4 {
  text-indent: 20px;
}

#pzveloiefp .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=""></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Rarely">Rarely</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Sometimes">Sometimes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Often">Often</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="Mexico">Mexico</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>26.29%<br><span style="font-size:70%">(9,897)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>45.53%<br><span style="font-size:70%">(17,139)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>28.17%<br><span style="font-size:70%">(10,605)</span></p>
</div></td></tr>
    <tr><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>18.02%<br><span style="font-size:70%">(6,812)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>32.73%<br><span style="font-size:70%">(12,369)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>49.25%<br><span style="font-size:70%">(18,613)</span></p>
</div></td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="United States">United States</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>62.95%<br><span style="font-size:70%">(3,237)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>26.86%<br><span style="font-size:70%">(1,381)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center"><div class="gt_from_md"><p>10.19%<br><span style="font-size:70%">(524)</span></p>
</div></td></tr>
    <tr><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>25.27%<br><span style="font-size:70%">(1,307)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>37.22%<br><span style="font-size:70%">(1,925)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center"><div class="gt_from_md"><p>37.51%<br><span style="font-size:70%">(1,940)</span></p>
</div></td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>This table has a lot of numbers and it’s hard to immediately see what’s going on, so we’ll visualize it really quick to get a sense for some of the initial trends. Visualizing this is a little tricky though. It’s easy enough to make a bar chart of the percentages, but doing that is a little misleading. Notice the huge differences in the numbers of respondents here—there are thousands of Mexican students and only hundreds of American students. <a href="https://clauswilke.com/dataviz/nested-proportions.html">We should probably visualize the data in a way that accounts for these different denominators</a>, and percentages by themselves don’t do that.</p>
<p>We can use a <a href="https://en.wikipedia.org/wiki/Mosaic_plot">mosaic plot</a> (also known as a <a href="https://datavizcatalogue.com/methods/marimekko_chart.html">Marimekko chart</a>) to visualize both the distribution of proportions of responses (Rarely, Sometimes, Often) and the proportions of respondents from each country (Mexico and the United States). We can use the <a href="https://haleyjeppson.github.io/ggmosaic/">{ggmosaic} package</a> to create ggplot-flavored mosaic plots:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Base R works too!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Mosaic plots are actually also built into base R!</p>
<p>Try running <code>plot(table(mtcars$cyl, mtcars$am))</code>.</p>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(reading) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_mosaic</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">product</span>(frequency, country),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at combination of frequency by country</span></span>
<span id="cb5-3">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> country),</span>
<span id="cb5-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">divider =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mosaic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the plot divide vertically</span></span>
<span id="cb5-5">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">offset =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add thin white border around boxes</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_productlist</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the x-axis take up almost the full panel width, with 2% spacing on each side</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_productlist</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the y-axis take up the full panel width</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E51B24"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFDE00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(book_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-13">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using labs(x = NULL) with scale_x_productlist() apparently doesn't</span></span>
<span id="cb5-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># work, so we can turn off the axis title with theme() instead</span></span>
<span id="cb5-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-17">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-mosaic-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Mosaic plot of the proportions of comic book and newspaper reading frequency in the United States and Mexico"></p>
<figcaption class="figure-caption margin-caption">Mosaic plot of the proportions of comic book and newspaper reading frequency in the United States and Mexico</figcaption>
</figure>
</div>
</div>
</div>
<p>There are a few quick things to point out here in this plot. The Mexico rectangles are super tall, since there are so many more respondents from Mexico than from the United States. It looks like the majority of American students only rarely read comic books, while their Mexican counterparts do it either sometimes or often. Mexican students also read newspapers a lot more than Americans do, with “Often” the clear most common category. For Americans, the “Sometimes” and “Often” newspaper responses look about the same.</p>
</section>
<section id="the-questions" class="level1">
<h1>The questions</h1>
<p>Throughout this post, I’ll illustrate the logic of Bayesian proportion tests by answering two questions that I had while looking at the contingency table and mosaic plot above:</p>
<ol type="1">
<li>Do students in Mexico read comic books more often than students in the United States? (the <span style="color: #CD8A39">two yellow cells in the “Often” column</span>)</li>
<li>Do students in the United States vary in their frequency of reading newspapers? (the <span style="color: #009DDC">blue row for newspapers in the United States</span>)</li>
</ol>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">fancy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb6-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CD8A39"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)),</span>
<span id="cb6-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CD8A39"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb6-6">    ),</span>
<span id="cb6-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb6-9">    )</span>
<span id="cb6-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb6-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)),</span>
<span id="cb6-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb6-15">    ),</span>
<span id="cb6-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb6-18">    )</span>
<span id="cb6-19">  )</span></code></pre></div>
</details>
<div class="cell-output-display">

<div id="dbgvzfontn" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#dbgvzfontn table {
  font-family: 'Fira Sans', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#dbgvzfontn thead, #dbgvzfontn tbody, #dbgvzfontn tfoot, #dbgvzfontn tr, #dbgvzfontn td, #dbgvzfontn th {
  border-style: none;
}

#dbgvzfontn p {
  margin: 0;
  padding: 0;
}

#dbgvzfontn .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dbgvzfontn .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#dbgvzfontn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dbgvzfontn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dbgvzfontn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#dbgvzfontn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dbgvzfontn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dbgvzfontn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dbgvzfontn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dbgvzfontn .gt_spanner_row {
  border-bottom-style: hidden;
}

#dbgvzfontn .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#dbgvzfontn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dbgvzfontn .gt_from_md > :first-child {
  margin-top: 0;
}

#dbgvzfontn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dbgvzfontn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dbgvzfontn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#dbgvzfontn .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#dbgvzfontn .gt_row_group_first td {
  border-top-width: 2px;
}

#dbgvzfontn .gt_row_group_first th {
  border-top-width: 2px;
}

#dbgvzfontn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#dbgvzfontn .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#dbgvzfontn .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#dbgvzfontn .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#dbgvzfontn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dbgvzfontn .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dbgvzfontn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dbgvzfontn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#dbgvzfontn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dbgvzfontn .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#dbgvzfontn .gt_left {
  text-align: left;
}

#dbgvzfontn .gt_center {
  text-align: center;
}

#dbgvzfontn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dbgvzfontn .gt_font_normal {
  font-weight: normal;
}

#dbgvzfontn .gt_font_bold {
  font-weight: bold;
}

#dbgvzfontn .gt_font_italic {
  font-style: italic;
}

#dbgvzfontn .gt_super {
  font-size: 65%;
}

#dbgvzfontn .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#dbgvzfontn .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#dbgvzfontn .gt_indent_1 {
  text-indent: 5px;
}

#dbgvzfontn .gt_indent_2 {
  text-indent: 10px;
}

#dbgvzfontn .gt_indent_3 {
  text-indent: 15px;
}

#dbgvzfontn .gt_indent_4 {
  text-indent: 20px;
}

#dbgvzfontn .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=""></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Rarely">Rarely</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Sometimes">Sometimes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Often">Often</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="Mexico">Mexico</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>26.29%<br><span style="font-size:70%">(9,897)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>45.53%<br><span style="font-size:70%">(17,139)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center" style="background-color: #FFD8BB; color: #CD8A39; font-weight: bold;"><div class="gt_from_md"><p>28.17%<br><span style="font-size:70%">(10,605)</span></p>
</div></td></tr>
    <tr><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>18.02%<br><span style="font-size:70%">(6,812)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>32.73%<br><span style="font-size:70%">(12,369)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>49.25%<br><span style="font-size:70%">(18,613)</span></p>
</div></td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="United States">United States</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>62.95%<br><span style="font-size:70%">(3,237)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>26.86%<br><span style="font-size:70%">(1,381)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center" style="background-color: #FFD8BB; color: #CD8A39; font-weight: bold;"><div class="gt_from_md"><p>10.19%<br><span style="font-size:70%">(524)</span></p>
</div></td></tr>
    <tr><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center" style="background-color: #D7EBFF; color: #009DDC; font-weight: bold;"><div class="gt_from_md"><p>25.27%<br><span style="font-size:70%">(1,307)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center" style="background-color: #D7EBFF; color: #009DDC; font-weight: bold;"><div class="gt_from_md"><p>37.22%<br><span style="font-size:70%">(1,925)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center" style="background-color: #D7EBFF; color: #009DDC; font-weight: bold;"><div class="gt_from_md"><p>37.51%<br><span style="font-size:70%">(1,940)</span></p>
</div></td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</section>
<section id="question-1-comic-book-readership-in-the-us-vs.-mexico" class="level1 page-columns page-full">
<h1>Question 1: Comic book readership in the US vs.&nbsp;Mexico</h1>
<section id="estimand" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="estimand">Estimand</h2>
<p>For our first question, we want to know if there’s a substantial difference in the proportion of students who read comic books often in the United States and Mexico, or whether the difference between the <span style="color: #CD8A39">two yellow cells</span> is greater than zero:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">fancy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb7-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CD8A39"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)),</span>
<span id="cb7-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CD8A39"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb7-6">    ),</span>
<span id="cb7-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb7-9">    )</span>
<span id="cb7-10">  )</span></code></pre></div>
</details>
<div class="cell-output-display">

<div id="xdduhtxcdz" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#xdduhtxcdz table {
  font-family: 'Fira Sans', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#xdduhtxcdz thead, #xdduhtxcdz tbody, #xdduhtxcdz tfoot, #xdduhtxcdz tr, #xdduhtxcdz td, #xdduhtxcdz th {
  border-style: none;
}

#xdduhtxcdz p {
  margin: 0;
  padding: 0;
}

#xdduhtxcdz .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#xdduhtxcdz .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#xdduhtxcdz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#xdduhtxcdz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#xdduhtxcdz .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xdduhtxcdz .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xdduhtxcdz .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xdduhtxcdz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#xdduhtxcdz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#xdduhtxcdz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#xdduhtxcdz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#xdduhtxcdz .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#xdduhtxcdz .gt_spanner_row {
  border-bottom-style: hidden;
}

#xdduhtxcdz .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#xdduhtxcdz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#xdduhtxcdz .gt_from_md > :first-child {
  margin-top: 0;
}

#xdduhtxcdz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#xdduhtxcdz .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#xdduhtxcdz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#xdduhtxcdz .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#xdduhtxcdz .gt_row_group_first td {
  border-top-width: 2px;
}

#xdduhtxcdz .gt_row_group_first th {
  border-top-width: 2px;
}

#xdduhtxcdz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#xdduhtxcdz .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#xdduhtxcdz .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#xdduhtxcdz .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xdduhtxcdz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#xdduhtxcdz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#xdduhtxcdz .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#xdduhtxcdz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#xdduhtxcdz .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xdduhtxcdz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xdduhtxcdz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#xdduhtxcdz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xdduhtxcdz .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#xdduhtxcdz .gt_left {
  text-align: left;
}

#xdduhtxcdz .gt_center {
  text-align: center;
}

#xdduhtxcdz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#xdduhtxcdz .gt_font_normal {
  font-weight: normal;
}

#xdduhtxcdz .gt_font_bold {
  font-weight: bold;
}

#xdduhtxcdz .gt_font_italic {
  font-style: italic;
}

#xdduhtxcdz .gt_super {
  font-size: 65%;
}

#xdduhtxcdz .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#xdduhtxcdz .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#xdduhtxcdz .gt_indent_1 {
  text-indent: 5px;
}

#xdduhtxcdz .gt_indent_2 {
  text-indent: 10px;
}

#xdduhtxcdz .gt_indent_3 {
  text-indent: 15px;
}

#xdduhtxcdz .gt_indent_4 {
  text-indent: 20px;
}

#xdduhtxcdz .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=""></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Rarely">Rarely</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Sometimes">Sometimes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Often">Often</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="Mexico">Mexico</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>26.29%<br><span style="font-size:70%">(9,897)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>45.53%<br><span style="font-size:70%">(17,139)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center" style="background-color: #FFD8BB; color: #CD8A39; font-weight: bold;"><div class="gt_from_md"><p>28.17%<br><span style="font-size:70%">(10,605)</span></p>
</div></td></tr>
    <tr><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>18.02%<br><span style="font-size:70%">(6,812)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>32.73%<br><span style="font-size:70%">(12,369)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>49.25%<br><span style="font-size:70%">(18,613)</span></p>
</div></td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="United States">United States</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>62.95%<br><span style="font-size:70%">(3,237)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>26.86%<br><span style="font-size:70%">(1,381)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center" style="background-color: #FFD8BB; color: #CD8A39; font-weight: bold;"><div class="gt_from_md"><p>10.19%<br><span style="font-size:70%">(524)</span></p>
</div></td></tr>
    <tr><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>25.27%<br><span style="font-size:70%">(1,307)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>37.22%<br><span style="font-size:70%">(1,925)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center"><div class="gt_from_md"><p>37.51%<br><span style="font-size:70%">(1,940)</span></p>
</div></td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>To be more formal about this, we’ll call this estimand <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, which is the difference between the two proportions <img src="https://latex.codecogs.com/png.latex?%5Cpi">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%20%5Cpi_%5Ctext%7BMexico,%20comic%20books,%20often%7D%20-%20%5Cpi_%5Ctext%7BUnited%20States,%20comic%20books,%20often%7D%0A"></p>
<p>When visualizing this, we’ll use colors to help communicate the idea of between-group differences. We’ll get fancier with the colors in question 2, where we’ll look at three sets of pairwise differences, but here we’re just looking at a single pairwise difference (the difference between the US and Mexico), so we’ll use a bit of subtle and not-quite-correct color theory. In kindergarten we all learned the <a href="https://en.wikipedia.org/wiki/RYB_color_model">RYB color model</a>, where primary pigments can be mixed to create secondary pigments. For instance</p>
<blockquote class="blockquote">
<p><span style="color: #0074D9">blue</span> + <span style="color: #FFDC00">yellow</span> = <span style="color: #2ECC40">green</span>.</p>
</blockquote>
<p>If we do some (wrong color-theory-wise) algebra, we can rearrange the formula so that</p>
<blockquote class="blockquote">
<p><span style="color: #0074D9">blue</span> − <span style="color: #2ECC40">green</span> = <span style="color: #FFDC00">yellow</span></p>
</blockquote>
<p>If we make the United States <span style="color: #0074D9">blue</span> and Mexico <span style="color: #2ECC40">green</span>, the ostensible color for their difference is <span style="color: #FFDC00">yellow</span>. This is TOTALLY WRONG and <a href="https://xkcd.com/1882/">a lot more complicated</a> according to actual color theory, but it’s a cute and subtle visual cue, so we’ll use it.</p>
<p>These primary colors are a little too bright for my taste though, so let’s artsty them up a bit. We’re looking at data about the US and Mexico, so we’ll use the Saguaro palette from <a href="https://github.com/kevinsblake/NatParksPalettes">the {NatParksPalettes} package</a>, since <a href="https://en.wikipedia.org/wiki/Saguaro_National_Park">Saguaro National Park</a> is near the US-Mexico border and it has a nice blue, yellow, and green.</p>
<p>We’ll use <span style="color: #CD8A39">yellow for the difference (θ)</span> between the <span style="color: #127088">United States</span> and <span style="color: #57643C">Mexico</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/img/saguaro.jpg" class="img-fluid"></p>
<p><a href="https://www.nps.gov/media/photo/gallery-item.htm?pg=1937068&amp;id=D0458FC7-155D-451F-678551BE57482110&amp;gid=D0377EAB-155D-451F-67573A9D0FD80A08">“Saguaro Fruit Ripens in June”</a> by the <a href="https://www.nps.gov/">US National Park Service</a></p>
</div></div><div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># US/Mexico question colors</span></span>
<span id="cb8-2">clrs_saguaro <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> NatParksPalettes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">natparks.pals</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Saguaro"</span>)</span>
<span id="cb8-3">clr_usa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clrs_saguaro[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-4">clr_mex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clrs_saguaro[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]</span>
<span id="cb8-5">clr_diff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clrs_saguaro[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/show-saguaro-pal-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="classically" class="level2">
<h2 class="anchored" data-anchor-id="classically">Classically</h2>
<p>In classical frequentist statistics, there are lots of ways to test for the significance of a difference in proportions of counts, rates, proportions, and other categorical-related things, like chi-squared tests, <a href="https://www.tjmahr.com/bayesian-fisher-exact-test/">Fisher’s exact test</a>, or proportion tests. Each of these tests have special corresponding “flavors” that apply to specific conditions within the data being tested or the estimand being calculated (corrections for sample sizes, etc.). In standard stats classes, you memorize <a href="https://www.google.com/search?q=statistical+test+flow+chart">big flowcharts of possible statistical operations</a> and select the correct one for the situation.</p>
<p>Since we want to test the difference between two group proportions, we’ll use R’s <code>prop.test()</code>, which tests the null hypothesis that the proportions in some number of groups are the same:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AH_0:%20%5Ctheta%20=%200%0A"></p>
<p>Our job with null hypothesis significance testing is to calculate a test statistic (<img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"> in this case) for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, determine the probability of seeing that statistic in a world where <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is actually 0, and infer whether the value we see could plausibly fit in a world where the null hypothesis is true.</p>
<p>We need to feed <code>prop.test()</code> either a matrix with a column of counts of successes (students who read comic books often) and failures (students who do not read comic books often) or two separate vectors: one of counts of successes (students who read comic books often) and one of counts of totals (all students). We’ll do it both ways for fun.</p>
<p>First we’ll make a matrix of the counts of students from Mexico and the United States, with columns for the counts of those who read often and of those who don’t read often.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">often_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comic books"</span>, frequency <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_not_often =</span> total <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_often =</span> n, n_not_often) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>()</span>
<span id="cb9-6">often_matrix</span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      n_often n_not_often</span></span>
<span id="cb9-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]   10605       27036</span></span>
<span id="cb9-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,]     524        4618</span></span></code></pre></div>
</details>
</div>
<p>Now we can feed that to <code>prop.test()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.test</span>(often_matrix)</span>
<span id="cb10-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb10-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2-sample test for equality of proportions with continuity correction</span></span>
<span id="cb10-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb10-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## data:  often_matrix</span></span>
<span id="cb10-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## X-squared = 759, df = 1, p-value &lt;2e-16</span></span>
<span id="cb10-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## alternative hypothesis: two.sided</span></span>
<span id="cb10-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 95 percent confidence interval:</span></span>
<span id="cb10-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  0.170 0.189</span></span>
<span id="cb10-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## sample estimates:</span></span>
<span id="cb10-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## prop 1 prop 2 </span></span>
<span id="cb10-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  0.282  0.102</span></span></code></pre></div>
</details>
</div>
<p>This gives us some helpful information. The “flavor” of the formal test is a “2-sample test for equality of proportions with continuity correction”, which is fine, I guess.</p>
<p>We have proportions that are the same as what we have in the highlighted cells in the contingency table (28.17% / 10.19%) and we have 95% confidence interval for the difference. Oddly, R doesn’t show the actual difference in these results, but we can see that difference if we use <code>model_parameters()</code> from <a href="https://easystats.github.io/parameters/">the {parameters} package</a> (which is the apparent successor to <code>broom::tidy()</code>?). Here we can see that the difference in proportions is 18 percentage points:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.test</span>(often_matrix) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_parameters</span>()</span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2-sample test for equality of proportions</span></span>
<span id="cb11-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb11-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Proportion      | Difference |       95% CI | Chi2(1) |      p</span></span>
<span id="cb11-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## --------------------------------------------------------------</span></span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 28.17% / 10.19% |     17.98% | [0.17, 0.19] |  759.26 | &lt; .001</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Alternative hypothesis: two.sided</span></span></code></pre></div>
</details>
</div>
<p>And finally we have a test statistic: a <img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"> value of 759.265, which is huge and definitely statistically significant. In a hypothetical world where there’s no difference in the proportions, the probability of seeing a difference of at least 18 percentage points is super tiny (p &lt; 0.001). We have enough evidence to confidently reject the null hypothesis and declare that the proportions of the groups are not the same. With the confidence interval, we can say that we are 95% confident that the interval 0.17–0.189 captures the true population parameter. We can’t say that there’s a 95% chance that the true value falls in this range—we can only talk about the range.</p>
<p>We can also do this without using a matrix by feeding <code>prop.test()</code> two vectors: one with counts of people who read comics often and one with counts of total respondents:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">often_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comic books"</span>, frequency <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>)</span>
<span id="cb12-3"></span>
<span id="cb12-4">(n_often <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])))</span>
<span id="cb12-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 10605   524</span></span>
<span id="cb12-6">(n_respondents <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])))</span>
<span id="cb12-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 37641  5142</span></span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.test</span>(n_often, n_respondents)</span>
<span id="cb12-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb12-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2-sample test for equality of proportions with continuity correction</span></span>
<span id="cb12-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb12-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## data:  n_often out of n_respondents</span></span>
<span id="cb12-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## X-squared = 759, df = 1, p-value &lt;2e-16</span></span>
<span id="cb12-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## alternative hypothesis: two.sided</span></span>
<span id="cb12-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 95 percent confidence interval:</span></span>
<span id="cb12-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  0.170 0.189</span></span>
<span id="cb12-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## sample estimates:</span></span>
<span id="cb12-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## prop 1 prop 2 </span></span>
<span id="cb12-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  0.282  0.102</span></span></code></pre></div>
</details>
</div>
<p>The results are the same.</p>
</section>
<section id="bayesianly-with-stan" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="bayesianly-with-stan">Bayesianly with Stan</h2>
<section id="why-bayesian-modeling" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="why-bayesian-modeling">Why Bayesian modeling?</h3>
<p>I don’t like null hypotheses and I don’t like flowcharts.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/img/golem.jpg" class="img-fluid"></p>
<p><a href="https://www.flickr.com/photos/botosynthetic/5837348219">“Golem”</a> by <a href="https://www.flickr.com/people/botosynthetic/">smokeghost</a></p>
</div></div><p>Regular classical statistics classes teach about null hypotheses and flowcharts, but there’s a better way. In his magisterial <a href="https://xcelab.net/rm/statistical-rethinking/"><em>Statistical Rethinking</em></a>, Richard McElreath <a href="https://www.youtube.com/watch?v=cclUd_HoRlo">describes how in legends people created mythological clay robots called golems that could protect cities from attacks</a>, but that could also spin out of control and wreak all sorts of havoc. McElreaths uses the idea of golems as a metaphor for classical statistical models focused on null hypothesis significance testing, which also consist of powerful quasi-alchemical procedures that have to be followed precisely with specific flowcharts:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/img/golem-flowchart.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption margin-caption">Statistical models as golems (slide 9 in <a href="https://speakerdeck.com/rmcelreath/statistical-rethinking-2022-lecture-01?slide=9">Statistical Rethinking 2022 Lecture 01</a>)</figcaption>
</figure>
</div>
</div>
</div>
<p>McElreath argues that this golem-based approach to statistics is incredibly limiting, since (1) you have to choose the right test, and if it doesn’t exist, you have to wait for some fancy statistician to invent it, and (2) you have to focus on rejecting null hypotheses instead of exploring research hypotheses.</p>
<p>For instance, in the null hypothesis framework section above, this was the actual question undergirding the analysis:</p>
<blockquote class="blockquote">
<p>In a hypothetical world where <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%200"> (or where there’s no difference between the proportions) what’s the probability that this one-time collection of data fits in that world—and if the probability is low, is there enough evidence to confidently reject that hypothetical world of no difference?</p>
</blockquote>
<p>oof. We set our <code>prop.test()</code> golem to work and got a p-value for the probability of seeing the 18 percentage point difference in a world where there’s actually no difference. That p-value was low, so we confidently declared <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> to be statistically significant and not zero. But that was it. We rejected the null world. Yay. But that doesn’t say much about our main research hypothesis. Boo.</p>
<p>Our <em>actual</em> main question is far simpler:</p>
<blockquote class="blockquote">
<p>Given the data here, what’s the probability that there’s no difference between the proportions, or that <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cneq%200">?</p>
</blockquote>
<p>Bayesian-flavored statistics lets us answer this question and avoid null hypotheses and convoluted inference. Instead of calculating the probability of seeing some data given a null hypothesis (<img src="https://latex.codecogs.com/png.latex?P(%5Ctext%7BData%7D%20%5Cmid%20H_0)">), we can use <a href="https://en.wikipedia.org/wiki/Bayesian_inference">Bayesian inference</a> to calculate the probability of a hypothesis given some data (<img src="https://latex.codecogs.com/png.latex?P(%5Ctheta%20%5Cneq%200%20%5Cmid%20%5Ctext%7BData%7D)">).</p>
</section>
<section id="formal-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="formal-model">Formal model</h3>
<p>So instead of thinking about a specific statistical golem, we can think about modeling the data-generating process that could create the counts and proportions that we see in the PISA data.</p>
<p>Remember that our data looks like this, with <code>n</code> showing a count of the people who read comic books often in each country and <code>total</code> showing a count of the people who responded to the question.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comic books"</span>, frequency <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>)</span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 6</span></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   country       book_type   frequency     n total  prop</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;chr&gt;       &lt;fct&gt;     &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Mexico        Comic books Often     10605 37641 0.282</span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 United States Comic books Often       524  5142 0.102</span></span></code></pre></div>
</details>
</div>
<p>The actual process for generating that <code>n</code> involved asking thousands of individual, independent people if they read comic books often. If someone says yes, it’s counted as a “success” (or marked as “often”); if they say no, it’s not marked as “often”. It’s a binary choice repeated across thousands of independent questions, or “trials.” There’s also an underlying overall probability for reporting “often,” which corresponds to the proportion of people selecting it.</p>
<p>The official statistical term for this kind of data-generating processes (a bunch of independent trials with some probability of success) is a <a href="https://en.wikipedia.org/wiki/Binomial_distribution">binomial distribution</a>, and it’s defined like this, with three parameters:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay%20%5Csim%20%5Coperatorname%7BBinomial%7D(n,%20%5Cpi)%0A"></p>
<ol type="1">
<li>Number of successes (<img src="https://latex.codecogs.com/png.latex?y">: the number of people responding yes to “often,” or <code>n</code> in our data</li>
<li>Probability of success (<img src="https://latex.codecogs.com/png.latex?%5Cpi">): the probability someone says yes to “often,” or the thing we want to model for each country</li>
<li>Number of trials (<img src="https://latex.codecogs.com/png.latex?n">): the total number of people asked the question, or <code>total</code> in our data</li>
</ol>
<p>The number of successes and trials are just integers—they’re counts—and we already know those, since they’re in the data. The probability of success <img src="https://latex.codecogs.com/png.latex?%5Cpi"> is a percentage and ranges somewhere between 0 and 1. We don’t know this value, but we can estimate it with Bayesian methods by defining a prior and a likelihood, churning through a bunch of Monte Carlo Markov Chain (MCMC) simulations, and finding a posterior distribution of <img src="https://latex.codecogs.com/png.latex?%5Cpi">.</p>
<p>We can use a Beta distribution to model <img src="https://latex.codecogs.com/png.latex?%5Cpi">, since Beta distributions are naturally bound between 0 and 1 and they work well for probability-scale things. Beta distributions are defined by two parameters: (1) <img src="https://latex.codecogs.com/png.latex?%5Calpha"> or <img src="https://latex.codecogs.com/png.latex?a"> or <code>shape1</code> in R and (2) <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> or <img src="https://latex.codecogs.com/png.latex?b"> or <code>shape2</code> in R. <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#beta-distributions-and-shape-parameters">See this section of my blog post</a> on zero-inflated Beta regression for way more details about how these parameters work and what they mean.</p>
<p>Super quickly, we’re interested in the probability of a “success” (or where “often” is yes), which is the number of “often”s divided by the total number of responses:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Ctext%7BNumber%20of%20successes%7D%7D%7B%5Ctext%7BNumber%20of%20trials%7D%7D%0A"></p>
<p>or</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Ctext%7BNumber%20of%20often%20=%20yes%7D%7D%7B%5Ctext%7BNumber%20of%20responses%7D%7D%0A"></p>
<p>We can separate that denominator into two parts:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Ctext%7BNumber%20of%20often%20=%20yes%7D%7D%7B(%5Ctext%7BNumber%20of%20often%20=%20yes%7D)%20+%20(%5Ctext%7BNumber%20of%20often%20%7D%20%5Cneq%20%5Ctext%7Byes%7D)%7D%0A"></p>
<p>The <img src="https://latex.codecogs.com/png.latex?%5Calpha"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> parameters correspond to the counts of successes and failures::</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Calpha%7D%7B%5Calpha%20+%20%5Cbeta%7D%0A"></p>
<p>With these two shape parameters, we can create any percentage or fraction we want. We can also control the uncertainty of the distribution by tinkering with the scale of the parameters. For instance, if we think there’s a 40% chance of something happening, this could be represented with <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%204"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20=%206">, since <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B4%7D%7B4%20+%206%7D%20=%200.4">. We could also write it as <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%2040"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20=%2060">, since <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B40%7D%7B40%20+%2060%7D%20=%200.4"> too. Both are centered at 40%, but Beta(40, 60) is a lot narrower and less uncertain.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbeta</span>(., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>,</span>
<span id="cb14-3">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Beta(4, 6)"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbeta</span>(., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>,</span>
<span id="cb14-5">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Beta(40, 60)"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Beta(4, 6)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFDC00"</span>,</span>
<span id="cb14-8">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Beta(40, 60)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F012BE"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"π"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb14-12">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-beta-example-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Beta(4, 6) and Beta(40, 60) distributions"></p>
<figcaption class="figure-caption margin-caption">Beta(4, 6) and Beta(40, 60) distributions</figcaption>
</figure>
</div>
</div>
</div>
<p>We’ve already seen the data and know that the proportion of students who read comic books often is 10ish% in the United States and 30ish% in Mexico, but we’ll cheat and say that we think that around 25% of students read comic books often, ± some big amount. This implies something like a Beta(2, 6) distribution (since <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B2%7D%7B2+6%7D%20=%200.25">), with lots of low possible values, but not a lot of <img src="https://latex.codecogs.com/png.latex?%5Cpi">s are above 50%. We could narrow this down by scaling up the parameters (like Beta(20, 60) or Beta(10, 40), etc.), but leaving the prior distribution of <img src="https://latex.codecogs.com/png.latex?%5Cpi"> wide like this allows for more possible responses (maybe 75% of students in one country read comic books often!).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbeta</span>(., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#AC3414"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Possible values for π"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-beta-prior-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Prior distribution for π using Beta(2, 6)"></p>
<figcaption class="figure-caption margin-caption">Prior distribution for π using Beta(2, 6)</figcaption>
</figure>
</div>
</div>
</div>
<p>Okay, so with our Beta(2, 6) prior, we now have all the information we need to specify the official formal model of the data generating process for our estimand <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> without any flowchart golems or null hypotheses:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BEstimand%7D%20%5C%5C%0A%5Ctheta%20=&amp;%5C%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BMexico%7D%7D%20-%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BUS%7D%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BBeta-binomial%20model%20for%20Mexico%7D%20%5C%5C%0Ay_%7Bn%20%5Ctext%7B%20comic%20books,%20often%7D_%5Ctext%7BMexico%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D_%5Ctext%7BMexico%7D%7D,%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BMexico%7D%7D)%20%5C%5C%0A%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BMexico%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBeta%7D(%5Calpha_%5Ctext%7BMexico%7D,%20%5Cbeta_%5Ctext%7BMexico%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BBeta-binomial%20model%20for%20the%20United%20States%7D%20%5C%5C%0Ay_%7Bn%20%5Ctext%7B%20comic%20books,%20often%7D_%5Ctext%7BUS%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D_%5Ctext%7BUS%7D%7D,%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BUS%7D%7D)%20%5C%5C%0A%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D_%5Ctext%7BUS%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBeta%7D(%5Calpha_%5Ctext%7BUS%7D,%20%5Cbeta_%5Ctext%7BUS%7D)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Calpha_%5Ctext%7BMexico%7D,%20%5Calpha_%5Ctext%7BUS%7D%20=&amp;%5C%202%20%5C%5C%0A%5Cbeta_%5Ctext%7BMexico%7D,%20%5Cbeta_%5Ctext%7BUS%7D%20=&amp;%5C%206%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="basic-stan-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="basic-stan-model">Basic Stan model</h3>
<p>The neat thing about Stan is that it translates fairly directly from this mathematical model notation into code. Here we’ll define three different blocks in a Stan program:</p>
<ol type="1">
<li>Data that gets fed into the model, or the counts of respondents (or <img src="https://latex.codecogs.com/png.latex?y"> and <img src="https://latex.codecogs.com/png.latex?n">)</li>
<li>Parameters to estimate, or <img src="https://latex.codecogs.com/png.latex?%5Cpi_%5Ctext%7BUS%7D"> and <img src="https://latex.codecogs.com/png.latex?%5Cpi_%5Ctext%7BMexico%7D"></li>
<li>The prior and model for estimating those parameters, or <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BBeta%7D(2,%206)"> and <img src="https://latex.codecogs.com/png.latex?y%20%5Csim%20%5Coperatorname%7BBinomial%7D(n,%20%5Cpi)"></li>
</ol>
<div class="cell" data-layout-align="center" data-file="props-basic.stan" data-output.var="">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>props-basic.stan</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stuff from R</span></span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span> {</span>
<span id="cb16-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; often_us;</span>
<span id="cb16-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; total_us;</span>
<span id="cb16-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; often_mexico;</span>
<span id="cb16-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; total_mexico;</span>
<span id="cb16-7">}</span>
<span id="cb16-8"></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Things to estimate</span></span>
<span id="cb16-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span> {</span>
<span id="cb16-11">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; pi_us;</span>
<span id="cb16-12">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; pi_mexico;</span>
<span id="cb16-13">}</span>
<span id="cb16-14"></span>
<span id="cb16-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Prior and likelihood</span></span>
<span id="cb16-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span> {</span>
<span id="cb16-17">  pi_us ~ beta(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>);</span>
<span id="cb16-18">  pi_mexico ~ beta(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>);</span>
<span id="cb16-19">  </span>
<span id="cb16-20">  often_us ~ binomial(total_us, pi_us);</span>
<span id="cb16-21">  often_mexico ~ binomial(total_mexico, pi_mexico);</span>
<span id="cb16-22">}</span></code></pre></div>
</div>
</div>
<p>Using {cmdstanr} as our interface with Stan, we first have to compile the script into an executable file:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/compile-model-props-basic_dd59d414c6c3684c4b1f92e0090c2b14">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">model_props_basic <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"props-basic.stan"</span>)</span></code></pre></div>
</details>
</div>
<p>We can then feed it a list of data and run a bunch of MCMC chains:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">often_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comic books"</span>, frequency <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>)</span>
<span id="cb18-3"></span>
<span id="cb18-4">(n_often <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])))</span>
<span id="cb18-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 10605   524</span></span>
<span id="cb18-6">(n_respondents <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], often_values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])))</span>
<span id="cb18-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 37641  5142</span></span>
<span id="cb18-8"></span>
<span id="cb18-9">props_basic_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_props_basic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb18-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">often_us =</span> n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb18-11">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_us =</span> n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb18-12">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">often_mexico =</span> n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb18-13">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_mexico =</span> n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb18-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_sampling =</span> (ITER <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> WARMUP), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb18-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb18-16">)</span>
<span id="cb18-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb18-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb18-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb18-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb18-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb18-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb18-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb18-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb18-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb18-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.2 seconds.</span></span>
<span id="cb18-27"></span>
<span id="cb18-28">props_basic_samples<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb18-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi_us"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi_mexico"</span>), </span>
<span id="cb18-30">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"median"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>))</span>
<span id="cb18-31">)</span>
<span id="cb18-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   variable mean median   sd 2.5% 97.5%</span></span>
<span id="cb18-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  pi_us     0.10   0.10 0.00 0.09  0.11</span></span>
<span id="cb18-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  pi_mexico 0.28   0.28 0.00 0.28  0.29</span></span></code></pre></div>
</details>
</div>
<p>We have the two proportions—10% and 28%—and they match what we found in the original table and in the frequentist <code>prop.test()</code> results (yay!). Let’s visualize these things:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">props_basic_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(pi_us, pi_mexico) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .variable, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> .variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 1.5% so that the right "%" isn't cut off</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_usa, clr_mex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of students who read comic books often"</span>,</span>
<span id="cb19-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-props-basic-stan-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distributions of the proportion of students who read comic books often in the United States and Mexico"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the proportion of students who read comic books often in the United States and Mexico</figcaption>
</figure>
</div>
</div>
</div>
<p>This plot is neat for a couple reasons. First it shows the difference in variance across these two distributions. The sample size for Mexican respondents is huge, so the average is a lot more precise and <span style="color: #57643C">the distribution</span> is narrower than <span style="color: #127088">the American one</span>. Second, by just eyeballing the plot we can see that there’s definitely no overlap between the two distributions, which implies that <span style="color: #CD8A39">the difference (θ) between the two</span> is definitely not zero—Mexican respondents are way more likely than Americans to read comic books often. We can find <span style="color: #CD8A39">that difference</span> by taking the pairwise difference between the two with <code>compare_levels()</code> from {tidybayes}, which subtracts one group’s posterior from the other:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">basic_diffs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> props_basic_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(pi_us, pi_mexico) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare_levels() subtracts things using alphabetical order, so by default it</span></span>
<span id="cb20-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># would calculate pi_us - pi_mexico, but we want the opposite, so we have to</span></span>
<span id="cb20-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make pi_us the first level</span></span>
<span id="cb20-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(.variable, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi_us"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(.value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> .variable, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pairwise"</span>)</span>
<span id="cb20-9"></span>
<span id="cb20-10">basic_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb20-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb20-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb20-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-diffs-basic-stan-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distribution of the difference in proportions of students who read comic books often in the United States and Mexico"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the difference in proportions of students who read comic books often in the United States and Mexico</figcaption>
</figure>
</div>
</div>
</div>
<p>We can also do some Bayesian inference and find the probability that <span style="color: #CD8A39">that difference between the two groups</span> is greater than 0 (or a kind of Bayesian p-value, but way more logical than null hypothesis p-values). We can calculate how many posterior draws are bigger than 0 and divide that by the number of draws to get the official proportion.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">basic_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.value),</span>
<span id="cb21-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_gt_0 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(median)</span>
<span id="cb21-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 8</span></span>
<span id="cb21-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .variable             y  ymin  ymax .width .point .interval p_gt_0</span></span>
<span id="cb21-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;dbl&gt;</span></span>
<span id="cb21-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 pi_mexico - pi_us 0.180 0.170 0.189   0.95 median qi             1</span></span></code></pre></div>
</details>
</div>
<p>There’s a 100% chance that <span style="color: #CD8A39">that difference</span> is not zero, or a 100% chance that Mexican respondents are way more likely than their American counterparts to read comic books often.</p>
</section>
<section id="stan-model-improvements" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="stan-model-improvements">Stan model improvements</h3>
<p>This basic Stan model is neat, but we can do a couple things to make it better:</p>
<ol type="1">
<li>Right now we have to feed it 4 separate numbers (counts and totals for the US and Mexico). It would be nice to just feed it a vector of counts and a vector of totals (or even a whole matrix like we did with <code>prop.test()</code>).</li>
<li>Right now we have to manually calculate the difference between the two groups (0.28 − 0.10). It would be nice to have Stan do that work for us.</li>
</ol>
<p>We’ll tackle each of these issues in turn.</p>
<p>First we’ll change how the script handles the data so that it’s more dynamic. Now instead of defining explicit variables and parameters as <code>total_us</code> or <code>pi_mexico</code> or whatever, we’ll use arrays and vectors so that we can use any arbitrary number of groups if we want:</p>
<div class="cell" data-layout-align="center" data-file="props-better.stan" data-output.var="">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>props-better.stan</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stuff from R</span></span>
<span id="cb22-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span> {</span>
<span id="cb22-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; n;</span>
<span id="cb22-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; often;</span>
<span id="cb22-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; total;</span>
<span id="cb22-6">}</span>
<span id="cb22-7"></span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Things to estimate</span></span>
<span id="cb22-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span> {</span>
<span id="cb22-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt;[n] pi;</span>
<span id="cb22-11">}</span>
<span id="cb22-12"></span>
<span id="cb22-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Prior and likelihood</span></span>
<span id="cb22-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span> {</span>
<span id="cb22-15">  pi ~ beta(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>);</span>
<span id="cb22-16">  </span>
<span id="cb22-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// We could specify separate priors like this</span></span>
<span id="cb22-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pi[1] ~ beta(2, 6);</span></span>
<span id="cb22-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pi[2] ~ beta(2, 6);</span></span>
<span id="cb22-20">  </span>
<span id="cb22-21">  often ~ binomial(total, pi);</span>
<span id="cb22-22">}</span></code></pre></div>
</div>
</div>
<p>Let’s make sure it works. Note how we now have to feed it an <code>n</code> for the number of countries and vectors of counts for <code>often</code> and <code>total</code>:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/compile-model-props-better_0ca87cc88692d261a40f548531f1cf93">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">model_props_better <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"props-better.stan"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">props_better_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_props_better<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb24-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb24-3">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">often =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb24-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])),</span>
<span id="cb24-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_sampling =</span> (ITER <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> WARMUP), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb24-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-7">)</span>
<span id="cb24-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb24-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb24-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb24-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb24-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb24-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb24-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb24-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb24-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb24-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span>
<span id="cb24-18"></span>
<span id="cb24-19">props_better_samples<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb24-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi[1]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi[2]"</span>), </span>
<span id="cb24-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"median"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>))</span>
<span id="cb24-22">)</span>
<span id="cb24-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  variable mean median   sd 2.5% 97.5%</span></span>
<span id="cb24-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     pi[1] 0.10   0.10 0.00 0.09  0.11</span></span>
<span id="cb24-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     pi[2] 0.28   0.28 0.00 0.28  0.29</span></span></code></pre></div>
</details>
</div>
<p>It worked and the results are the same! The parameter names are now <span style="color: #127088">“<code>pi[1]</code>”</span> and <span style="color: #57643C">“<code>pi[2]</code>”</span> and we’re responsible for keeping track of which subscripts correspond to which countries, which is annoying, but that’s Stan :shrug:.</p>
<p>Finally, we can modify the script a little more to automatically calculate <span style="color: #CD8A39">θ</span>. We’ll add a <code>generated quantities</code> block for that:</p>
<div class="cell" data-layout-align="center" data-file="props-best.stan" data-output.var="">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>props-best.stan</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stuff from R</span></span>
<span id="cb25-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span> {</span>
<span id="cb25-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; n;</span>
<span id="cb25-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; often;</span>
<span id="cb25-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; total;</span>
<span id="cb25-6">}</span>
<span id="cb25-7"></span>
<span id="cb25-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Things to estimate</span></span>
<span id="cb25-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span> {</span>
<span id="cb25-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt;[n] pi;</span>
<span id="cb25-11">}</span>
<span id="cb25-12"></span>
<span id="cb25-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Prior and likelihood</span></span>
<span id="cb25-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span> {</span>
<span id="cb25-15">  pi ~ beta(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>);</span>
<span id="cb25-16">  </span>
<span id="cb25-17">  often ~ binomial(total, pi);</span>
<span id="cb25-18">}</span>
<span id="cb25-19"></span>
<span id="cb25-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stuff Stan will calculate before sending back to R</span></span>
<span id="cb25-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">generated quantities</span> {</span>
<span id="cb25-22">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> theta;</span>
<span id="cb25-23">  theta = pi[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] - pi[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>];</span>
<span id="cb25-24">}</span></code></pre></div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/compile-model-props-best_50bb0990b3ac3f1cfdb445bddc4fe9d6">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">model_props_best <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"props-best.stan"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">props_best_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model_props_best<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb27-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb27-3">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">often =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], n_often[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb27-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], n_respondents[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])),</span>
<span id="cb27-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_sampling =</span> (ITER <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> WARMUP), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb27-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb27-7">)</span>
<span id="cb27-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb27-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb27-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb27-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb27-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb27-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb27-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb27-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb27-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span>
<span id="cb27-18"></span>
<span id="cb27-19">props_best_samples<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb27-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi[1]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi[2]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>), </span>
<span id="cb27-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"median"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>))</span>
<span id="cb27-22">)</span>
<span id="cb27-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  variable mean median   sd 2.5% 97.5%</span></span>
<span id="cb27-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     pi[1] 0.10   0.10 0.00 0.09  0.11</span></span>
<span id="cb27-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     pi[2] 0.28   0.28 0.00 0.28  0.29</span></span>
<span id="cb27-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     theta 0.18   0.18 0.00 0.17  0.19</span></span></code></pre></div>
</details>
</div>
<p>Check that out! Stan returned our <span style="color: #CD8A39">18 percentage point difference</span> and we didn’t need to use <code>compare_levels()</code>! We can plot it directly:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Raw Stan doesn't preserve the original country names or order, so we have to</span></span>
<span id="cb28-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do a bunch of reversing and relabeling on our own here</span></span>
<span id="cb28-3">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> props_best_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spread_draws</span>(pi[i]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(i)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> pi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(i), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(i))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 1.5% so that the right "%" isn't cut off</span></span>
<span id="cb28-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mexico"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_usa, clr_mex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of students who read comic books often"</span>,</span>
<span id="cb28-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span>
<span id="cb28-16"></span>
<span id="cb28-17">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> props_best_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spread_draws</span>(theta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> theta)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb28-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb28-24">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb28-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb28-28"></span>
<span id="cb28-29">(p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb28-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heights =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.785</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.185</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-diffs-best-stan-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from raw Stan code"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from raw Stan code</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="bayesianly-with-brms" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="bayesianly-with-brms">Bayesianly with {brms}</h2>
<p>Working with raw Stan code like that is fun and exciting—understanding the inner workings of these models is really neat and important! But in practice, I rarely use raw Stan. It takes too much pre- and post-processing for my taste (the data has to be fed in a list instead of a nice rectangular data frame; the variable names get lost unless you do some extra programming work; etc.).</p>
<p>Instead, I use <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for pretty much all my Bayesian models. It uses R’s familiar formula syntax, it works with regular data frames, it maintains variable names, and it’s just an all-around super-nice-and-polished frontend for working with Stan.</p>
<p>With a little formula finagling, we can create the same beta binomial model we built with raw Stan using {brms}</p>
<section id="counts-and-trials-as-formula-outcomes" class="level3">
<h3 class="anchored" data-anchor-id="counts-and-trials-as-formula-outcomes">Counts and trials as formula outcomes</h3>
<p>In R’s standard formula syntax, you put the outcome on the left-hand side of a <code>~</code> and the explanatory variables on the right-hand side:</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> whatever)</span></code></pre></div>
<p>You typically feed the model function a data frame with columns for each of the variables included. One neat and underappreciated feature of the <code>glm()</code> function is that you can feed function aggregated count data (instead of long data with lots of rows) by specifying the number of successes and the total number of failures as the outcome part of the formula. This runs something called aggregated logistic regression or aggregated binomial regression.</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(n_successes, n_failures) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> whatever, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> binomial)</span></code></pre></div>
<p>{brms} uses slightly different syntax for <a href="https://bookdown.org/content/4857/god-spiked-the-integers.html#binomial-regression">aggregated logistic regression</a>. Instead of the number of failures, it needs the total number of trials, and it doesn’t use <code>cbind(...)</code>—it uses <code>n | trials(total)</code>, like this:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x)</span>
<span id="cb31-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> whatever,</span>
<span id="cb31-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> binomial</span>
<span id="cb31-5">)</span></code></pre></div>
<p>Our comic book data is already in this count form, and we have columns for the number of “successes” (number of respondents reading comic books often) and the total number of “trials” (number of respondents reading comic books):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">often_comics_only <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comic books"</span>, frequency <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often"</span>)</span>
<span id="cb32-3">often_comics_only</span>
<span id="cb32-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 6</span></span>
<span id="cb32-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   country       book_type   frequency     n total  prop</span></span>
<span id="cb32-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;chr&gt;       &lt;fct&gt;     &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb32-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Mexico        Comic books Often     10605 37641 0.282</span></span>
<span id="cb32-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 United States Comic books Often       524  5142 0.102</span></span></code></pre></div>
</details>
</div>
</section>
<section id="binomial-model-with-logistic-link" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="binomial-model-with-logistic-link">Binomial model with logistic link</h3>
<p>Since we have columns for <code>n</code>, <code>total</code>, and <code>country</code>, we can run an aggregated binomial logistic regression model like this:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/q1-model-logit_2e9383be0fccc9b224919092290b101e">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">often_comics_model_logit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> country),</span>
<span id="cb33-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> often_comics_only,</span>
<span id="cb33-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb33-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb33-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb33-7">)</span>
<span id="cb33-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb33-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb33-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb33-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb33-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb33-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb33-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb33-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb33-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb33-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb33-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">often_comics_model_logit</span>
<span id="cb34-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb34-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = logit </span></span>
<span id="cb34-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: n | trials(total) ~ country </span></span>
<span id="cb34-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: often_comics_only (Number of observations: 2) </span></span>
<span id="cb34-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb34-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb34-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb34-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb34-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb34-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Intercept              -0.94      0.01    -0.96    -0.91 1.00     4706     3051</span></span>
<span id="cb34-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryUnitedStates    -1.24      0.05    -1.34    -1.15 1.00      981     1123</span></span>
<span id="cb34-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb34-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb34-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb34-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>Because we used a logit link for the binomial family, these results are on the log odds scale, which, ew. We can’t really interpret them directly unless we do some extra math with <code>plogis()</code> (<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#fractional-logistic-regression">see here for more about how to do that</a>). The logistic-ness of the results is also apparent in the formal mathy model for this approach, which no longer uses a Beta distribution for estimating <img src="https://latex.codecogs.com/png.latex?%5Cpi">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Ay_%7Bn%20%5Ctext%7B%20comic%20books,%20often%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D%7D,%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D)%20%5C%5C%0A%5Coperatorname%7Blogit%7D(%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D)%20=&amp;%5C%20%5Cbeta_0%20+%20%5Cbeta_1%20%5Ctext%7BUnited%20States%7D%20%5C%5C%5B5pt%5D%0A%5Cbeta_0,%20%5Cbeta_1%20=&amp;%20%5Ctext%7BWhatever%20brms%20uses%20as%20default%20priors%7D%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>We can still work with percentage point values if we use <code>epred_draws()</code> and a bit of data wrangling, since that automatically back-transforms <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7Blogit%7D(%5Cpi)"> from log odds to counts (<a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">see here for an explanation of how and why</a>). We can convert these posterior counts to a proportion again by dividing each predicted count by the total for each row.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># brms keeps all the original factor/category names, so there's no need for</span></span>
<span id="cb35-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extra manual work here!</span></span>
<span id="cb35-3">draws_logit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> often_comics_model_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This gives us counts...</span></span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> often_comics_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...so divide by the original total to get proportions again</span></span>
<span id="cb35-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total)</span>
<span id="cb35-8"></span>
<span id="cb35-9">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> country)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_usa, clr_mex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of students who read comic books often"</span>,</span>
<span id="cb35-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span>
<span id="cb35-18"></span>
<span id="cb35-19">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare_levels() subtracts things using alphabetical order, so so we have to</span></span>
<span id="cb35-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make the United States the first level</span></span>
<span id="cb35-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(country, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(.epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb35-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb35-30">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make it so the pointrange doesn't get cropped</span></span>
<span id="cb35-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clip =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb35-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb35-36"></span>
<span id="cb35-37">(p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heights =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.785</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.185</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q1-plot-logit-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from logistic regression model in {brms}"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from logistic regression model in {brms}</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">draws_logit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred_prop)</span>
<span id="cb36-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb36-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   country       .epred_prop .lower .upper .width .point .interval</span></span>
<span id="cb36-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;               &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb36-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Mexico              0.282 0.277   0.286   0.95 median qi       </span></span>
<span id="cb36-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 United States       0.102 0.0936  0.110   0.95 median qi</span></span></code></pre></div>
</details>
</div>
<p>Cool cool, all the results are the same as using raw Stan.</p>
</section>
<section id="binomial-model-with-identity-link" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="binomial-model-with-identity-link">Binomial model with identity link</h3>
<p>We didn’t set any priors here, and if we want to be good Bayesians, we should. However, given the logit link, we’d need to specify priors on the log odds scale, and I can’t naturally think in logits. I <em>can</em> think about percentages though, which is why I like the Beta distribution for priors for proportions—it just makes sense.</p>
<p>Also, the raw Stan models spat out percentage-point scale parameters—it’d be neat if {brms} could too.</p>
<p>And it can! We just have to change the link function for the binomial family from <code>"logit"</code> to <code>"identity"</code>. This isn’t really documented anywhere (I don’t think?), and it feels weird and wrong, but it works. Note how we take the “logit” out of the second line of the model—we’re no longer using a link function:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Ay_%7Bn%20%5Ctext%7B%20comic%20books,%20often%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D%7D,%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D)%20%5C%5C%0A%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D%20=&amp;%5C%20%5Cbeta_0%20+%20%5Cbeta_1%20%5Ctext%7BUnited%20States%7D%20%5C%5C%5B5pt%5D%0A%5Cbeta_0,%20%5Cbeta_1%20=&amp;%5C%20%5Ctext%7BWhatever%20brms%20uses%20as%20default%20priors%7D%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>Doing this works, but there are some issues. The identity link in a binomial model means that the model parameters won’t be transformed to the logit scale and will instead stay on the proportion scale. We’ll get some errors related to MCMC values because the outcome needs to be constrained between 0 and 1, and the MCMC chains will occasionally wander down into negative numbers and make Stan mad. The model will mostly fit if we specify initial MCMC values at 0.1 or something, but it’ll still complain.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/q1-model-identity-intercept_d51a31a0fbeee309bd071b9951ff4391">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">often_comics_model_identity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> country),</span>
<span id="cb37-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> often_comics_only,</span>
<span id="cb37-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>),</span>
<span id="cb37-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb37-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb37-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb37-8">)</span>
<span id="cb37-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb37-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb37-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Rejecting initial value:</span></span>
<span id="cb37-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3   Error evaluating the log probability at the initial value.</span></span>
<span id="cb37-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0175658, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0175658, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Rejecting initial value:</span></span>
<span id="cb37-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3   Error evaluating the log probability at the initial value.</span></span>
<span id="cb37-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0471304, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0471304, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Rejecting initial value:</span></span>
<span id="cb37-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3   Error evaluating the log probability at the initial value.</span></span>
<span id="cb37-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[2] is -0.03896, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[2] is -0.03896, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Rejecting initial value:</span></span>
<span id="cb37-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3   Error evaluating the log probability at the initial value.</span></span>
<span id="cb37-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0529492, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 Exception: binomial_lpmf: Probability parameter[1] is -0.0529492, but must be in the interval [0, 1] (in '/var/folders/17/g3pw3lvj2h30gwm67tbtx98c0000gn/T/RtmpQKMbv4/model-d1884317c1cb.stan', line 36, column 4 to column 44)</span></span>
<span id="cb37-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb37-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.1 seconds.</span></span>
<span id="cb37-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.1 seconds.</span></span>
<span id="cb37-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.1 seconds.</span></span>
<span id="cb37-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb37-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb37-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.1 seconds.</span></span>
<span id="cb37-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.3 seconds.</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">often_comics_model_identity</span>
<span id="cb38-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb38-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb38-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: n | trials(total) ~ country </span></span>
<span id="cb38-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: often_comics_only (Number of observations: 2) </span></span>
<span id="cb38-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb38-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb38-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb38-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb38-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb38-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Intercept               0.28      0.00     0.28     0.29 1.00     3627     2558</span></span>
<span id="cb38-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryUnitedStates    -0.18      0.00    -0.19    -0.17 1.00     1472     1907</span></span>
<span id="cb38-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb38-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb38-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb38-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>One really nice thing about this identity-link model is that the coefficient for <code>countryUnitedStates</code> shows us the percentage-point-scale difference in proportions: −0.18! This is just a regular regression model, so the intercept shows us the average proportion when United States is false (i.e.&nbsp;for Mexico), and the United States coefficient shows the offset from the intercept.</p>
<p>Working with the <code>countryUnitedStates</code> coefficient directly is convenient—there’s no need to divide predicted values by totals or use <code>compare_levels()</code> to find the difference between the United States and Mexico. We have <span style="color: #CD8A39">our estimand</span> immediately.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">draws_diffs_identity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> often_comics_model_identity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gather_draws</span>(b_countryUnitedStates) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reverse the value since our theta is Mexico - US, not US - Mexico</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.value =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>.value)</span>
<span id="cb39-5"></span>
<span id="cb39-6">draws_diffs_identity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb39-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb39-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb39-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb39-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q1-plot-model-identity-intercept-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distribution of the difference in proportions of students who read comic books often in the United States and Mexico; results from binomial model with identity link in {brms}"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the difference in proportions of students who read comic books often in the United States and Mexico; results from binomial model with identity link in {brms}</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">draws_diffs_identity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.value)</span>
<span id="cb40-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 7</span></span>
<span id="cb40-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   .variable             .value .lower .upper .width .point .interval</span></span>
<span id="cb40-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb40-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 b_countryUnitedStates  0.180  0.170  0.189   0.95 median qi</span></span></code></pre></div>
</details>
</div>
</section>
<section id="intercept-free-binomial-model-with-identity-link" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="intercept-free-binomial-model-with-identity-link">Intercept-free binomial model with identity link</h3>
<p>However, I’m still not entirely happy with it. For one thing, I don’t like all the initial MCMC errors. The model still eventually fit, but I’d prefer it to have a less rocky start. I could probably tinker with more options to get it working, but that’s a hassle.</p>
<p>More importantly, though, is the issue of priors. We still haven’t set any. Also, we’re no longer using a beta-binomial model—this is just regular old logistic regression, which means we’re working with intercepts and slopes. If we use the <code>n | trials(total) ~ country</code> model with an identity link, we’d need to set priors for the intercept and for the difference, which means we need to think about two types of values: (1) the prior average percentage for Mexico and (2) the prior average difference between Mexico and the United States. In the earlier raw Stan model, we set priors for the average percentages for each country and didn’t worry about thinking about the difference. Conceptually, I think this is easier. In my own work, I can think about the prior distributions for specific survey response categories (30% might agree, 50% might disagree, 20% might be neutral), but thinking about differences is less natural and straightforward (there might be a 20 percentage point difference between agree and disagree? that feels weird).</p>
<p>To get percentages for each country <em>and</em> avoid the odd initial value errors <em>and</em> set more natural priors, and ultimately use a beta-binomial model, we can fit an intercept-free model by including a 0 in the right-hand side of the formula. This disables the Mexico reference category and returns estimates for both Mexico and the United States. Now we can finally set a prior too. Here, as I did with the Stan model earlier, I use Beta(2, 6) for both countries, but it could easily be different for each country too. This is one way to force {brms} to essentially use a beta-binomial model, and results in something like this:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Ay_%7Bn%20%5Ctext%7B%20comic%20books,%20often%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D%7D,%20%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D)%20%5C%5C%0A%5Cpi_%7B%5Ctext%7Bcomic%20books,%20often%7D%7D%20=&amp;%5C%20%5Cbeta_%5Ctext%7BMexico%7D%20+%20%5Cbeta_%5Ctext%7BUnited%20States%7D%20%5C%5C%5B10pt%5D%0A%5Cbeta_%5Ctext%7BMexico%7D,%20%5Cbeta_%5Ctext%7BUnited%20States%7D%20=&amp;%5C%20%5Coperatorname%7BBeta%7D(2,%206)%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/q1-model-identity_152e3da9a11ccb2a400ae2a70b9a0343">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">often_comics_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb41-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country),</span>
<span id="cb41-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> often_comics_only,</span>
<span id="cb41-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>),</span>
<span id="cb41-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ub =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb41-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb41-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb41-8">)</span>
<span id="cb41-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb41-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb41-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb41-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb41-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb41-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb41-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb41-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb41-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb41-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb41-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">often_comics_model</span>
<span id="cb42-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb42-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb42-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: n | trials(total) ~ 0 + country </span></span>
<span id="cb42-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: often_comics_only (Number of observations: 2) </span></span>
<span id="cb42-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb42-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb42-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb42-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb42-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb42-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryMexico           0.28      0.00     0.28     0.29 1.00     3581     2914</span></span>
<span id="cb42-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryUnitedStates     0.10      0.00     0.09     0.11 1.00     2824     2470</span></span>
<span id="cb42-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb42-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb42-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb42-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>The coefficients here represent the average proportions for each country. The <span style="color: #CD8A39">main estimand we care about</span> is still the difference between the two, so we need to do a little bit of data manipulation to calculate that, just like we did with the first logit version of the model:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> often_comics_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> often_comics_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> country)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_usa, clr_mex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of students who read comic books often"</span>,</span>
<span id="cb43-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span>
<span id="cb43-12"></span>
<span id="cb43-13">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> often_comics_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> often_comics_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare_levels() subtracts things using alphabetical order, so so we have to</span></span>
<span id="cb43-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make the United States the first level</span></span>
<span id="cb43-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(country, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(.epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> country,</span>
<span id="cb43-21">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pairwise"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb43-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb43-27">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make it so the pointrange doesn't get cropped</span></span>
<span id="cb43-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clip =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb43-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb43-32">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb43-33"></span>
<span id="cb43-34">(p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb43-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heights =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.785</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.185</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q1-plot-model-identity-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from an intercept-free binomial model with identity link in {brms}"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the proportions and difference in proportions of students who read comic books often in the United States and Mexico; results from an intercept-free binomial model with identity link in {brms}</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="actual-beta-binomial-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="actual-beta-binomial-model">Actual beta-binomial model</h3>
<p>Until {brms} 2.17, there wasn’t an official beta-binomial distribution for {brms}, but it was used as <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html">the example for creating your own custom family</a>. It is now implemented in {brms} and allows you to define both a mean (<img src="https://latex.codecogs.com/png.latex?%5Cmu">) and precision (<img src="https://latex.codecogs.com/png.latex?%5Cphi">) for a Beta distribution, just like {brms}’s other Beta-related models (like zero-inflated, etc.—<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">see here for a lot more about those</a>). This means that we can model both parts of the distribution simultaneously, which is neat, since it allows us to deal with potential overdispersion in outcomes. <a href="https://discourse.mc-stan.org/t/beta-binomial-why-not-a-default-family-in-the-package/10625/2">Paul Bürkner’s original rationale for not including it</a> was that a regular binomial model with a random effect for the observation id also allows you to account for overdispersion, so there’s not really a need for an official beta-binomial family. <a href="https://github.com/paul-buerkner/brms/pull/1319">But in March 2022</a> the <code>beta_binomial</code> family was added as an official distributional family, which is neat.</p>
<p>We can use it here instead of <code>family = binomial(link = "identity")</code> with a few adjustments. The family uses a different mean/precision parameterization of the Beta distribution instead of the two shapes <img src="https://latex.codecogs.com/png.latex?%5Calpha"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, but we can switch between them with some algebra (<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#mean-and-precision-instead-of-shapes">see this for more details</a>):</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bequation%7D%0A%5Cbegin%7Baligned%7D%5Bt%5D%0A%5Ctext%7BShape%201:%7D%20&amp;&amp;%20%5Calpha%20&amp;=%20%5Cmu%20%5Cphi%20%5C%5C%0A%5Ctext%7BShape%202:%7D%20&amp;&amp;%20%5Cbeta%20&amp;=%20(1%20-%20%5Cmu)%20%5Cphi%0A%5Cend%7Baligned%7D%0A%5Cqquad%5Cqquad%5Cqquad%0A%5Cbegin%7Baligned%7D%5Bt%5D%0A%5Ctext%7BMean:%7D%20&amp;&amp;%20%5Cmu%20&amp;=%20%5Cfrac%7B%5Calpha%7D%7B%5Calpha%20+%20%5Cbeta%7D%20%5C%5C%0A%5Ctext%7BPrecision:%7D%20&amp;&amp;%20%5Cphi%20&amp;=%20%5Calpha%20+%20%5Cbeta%0A%5Cend%7Baligned%7D%0A%5Cend%7Bequation%7D%0A"></p>
<p>By default, <img src="https://latex.codecogs.com/png.latex?%5Cmu"> is modeled on the log odds scale and <img src="https://latex.codecogs.com/png.latex?%5Cphi"> is modeled on the log scale, but I find both of those really hard to think about, so we can use an identity link for both parameters like we did before with <code>binomial()</code> to think about counts and proportions instead. This makes it so the <img src="https://latex.codecogs.com/png.latex?%5Cphi"> parameter measures the standard deviation of the count on the count scale, so a prior like Exponential(1 / 1000) would imply that the precision (or variance-ish) of the count could vary by mostly low numbers, but maybe up to ±5000ish, which seems reasonable, especially since the Mexico part of the survey has so many respondents:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dexp</span>(., <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#AC3414"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">big.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Possible values for φ"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/plot-exponential-prior-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Exponential(1/1000) distribution"></p>
<figcaption class="figure-caption margin-caption">Exponential(1/1000) distribution</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/q1-model-beta-binomial_892ea1810318bc52873bf1795630c2a2">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">often_comics_model_beta_binomial <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb45-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country),</span>
<span id="cb45-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> often_comics_only,</span>
<span id="cb45-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta_binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link_phi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>),</span>
<span id="cb45-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ub =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb45-6">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"phi"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)),</span>
<span id="cb45-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb45-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb45-9">)</span>
<span id="cb45-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb45-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb45-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb45-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb45-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb45-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb45-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb45-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb45-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb45-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Separate model for <img src="https://latex.codecogs.com/png.latex?%5Cphi">
</div>
</div>
<div class="callout-body-container callout-body">
<p>If we wanted to be super fancy, we could define a completely separate model for the <img src="https://latex.codecogs.com/png.latex?%5Cphi"> part of the distribution like this, but we don’t need to here:</p>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">often_comics_model_beta_binomial <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb46-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country,</span>
<span id="cb46-3">     phi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country),</span>
<span id="cb46-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> often_comics_only,</span>
<span id="cb46-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta_binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link_phi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>),</span>
<span id="cb46-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ub =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb46-7">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"phi"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)),</span>
<span id="cb46-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb46-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb46-10">)</span></code></pre></div>
</div>
</div>
<p>Check out the results:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">often_comics_model_beta_binomial</span>
<span id="cb47-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: beta_binomial </span></span>
<span id="cb47-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = identity; phi = identity </span></span>
<span id="cb47-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: n | trials(total) ~ 0 + country </span></span>
<span id="cb47-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: often_comics_only (Number of observations: 2) </span></span>
<span id="cb47-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb47-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb47-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb47-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb47-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb47-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryMexico           0.28      0.03     0.22     0.33 1.00     1786      890</span></span>
<span id="cb47-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## countryUnitedStates     0.11      0.02     0.08     0.16 1.00     1626     1085</span></span>
<span id="cb47-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb47-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Family Specific Parameters: </span></span>
<span id="cb47-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb47-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## phi  1031.27   1022.22    38.29  3841.42 1.01      751      958</span></span>
<span id="cb47-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb47-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb47-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb47-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>Those coefficients are the group proportions, as expected, and we have a <img src="https://latex.codecogs.com/png.latex?%5Cphi"> parameter representing the overall variation in counts. The proportions here are a little more uncertain than before, though, which is apparent if we plot the distributions. The distributions have a much wider range now (note that the x-axis now goes all the way up to 60%), and the densities are a lot bumpier and jankier. I don’t know why though! This is weird! I’m probably doing something wrong!</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">often_comics_model_beta_binomial <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> often_comics_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb48-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> country)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_usa, clr_mex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of students who read comic books often"</span>,</span>
<span id="cb48-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q1-plot-model-beta-binomial-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the proportion of students who read comic books often in the United States and Mexico</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="final-answer-to-the-question" class="level2">
<h2 class="anchored" data-anchor-id="final-answer-to-the-question">Final answer to the question</h2>
<p>Phew, that was a lot of slow pedagogical exposure. What’s our <span style="color: #CD8A39">official estimand</span>? What’s our final answer to the question “Do respondents in Mexico read comic books more often than respondents in the United States?”?</p>
<p>Yes. They most definitely do.</p>
<p>In an official sort of report or article, I’d write something like this:</p>
<blockquote class="blockquote">
<p>Students in Mexico are far more likely to read comic books often than students in the United States. On average, 28.2% (between 27.7% and 28.6%) of PISA respondents in Mexico read comic books often, compared to 10.2% (between 9.4% and 11.1%) in the United States. There is a 95% posterior probability that the difference between these proportions is between 17.0 and 18.9 percentage points, with a median of 18.0 percentage points. This difference is substantial, and there’s a 100% chance that the difference is not zero.</p>
</blockquote>
</section>
</section>
<section id="question-2-frequency-of-newspaper-readership-in-the-us" class="level1 page-columns page-full">
<h1>Question 2: Frequency of newspaper readership in the US</h1>
<p>Now that we’ve got the gist of proportion tests with {brms}, we’ll go a lot faster for this second question. We’ll forgo all frequentist stuff and the raw Stan stuff and just skip straight to the intercept-free binomial model with an identity link.</p>
<section id="estimand-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="estimand-1">Estimand</h2>
<p>For this question, we want to know the differences in the the proportions of American newspaper-reading frequencies, or whether the differences between (1) <span style="color: #E51B24">rarely</span> and <span style="color: #FFDE00">sometimes</span>, (2) <span style="color: #FFDE00">sometimes</span> and <span style="color: #009DDC">often</span>, and (3) <span style="color: #E51B24">rarely</span> and <span style="color: #009DDC">often</span> are greater than zero:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1">fancy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb49-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E51B24"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)),</span>
<span id="cb49-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E51B24"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb49-6">    ),</span>
<span id="cb49-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb49-9">    )</span>
<span id="cb49-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb49-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFDE00"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)),</span>
<span id="cb49-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">darken</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFDE00"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb49-15">    ),</span>
<span id="cb49-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb49-18">    )</span>
<span id="cb49-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb49-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_style</span>(</span>
<span id="cb49-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-22">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_fill</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lighten</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)),</span>
<span id="cb49-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cell_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb49-24">    ),</span>
<span id="cb49-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb49-26">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cells_body</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb49-27">    )</span>
<span id="cb49-28">  )</span></code></pre></div>
</details>
<div class="cell-output-display">

<div id="oogwyrknbv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#oogwyrknbv table {
  font-family: 'Fira Sans', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#oogwyrknbv thead, #oogwyrknbv tbody, #oogwyrknbv tfoot, #oogwyrknbv tr, #oogwyrknbv td, #oogwyrknbv th {
  border-style: none;
}

#oogwyrknbv p {
  margin: 0;
  padding: 0;
}

#oogwyrknbv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#oogwyrknbv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#oogwyrknbv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#oogwyrknbv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#oogwyrknbv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oogwyrknbv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oogwyrknbv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oogwyrknbv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#oogwyrknbv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#oogwyrknbv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#oogwyrknbv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#oogwyrknbv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#oogwyrknbv .gt_spanner_row {
  border-bottom-style: hidden;
}

#oogwyrknbv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#oogwyrknbv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#oogwyrknbv .gt_from_md > :first-child {
  margin-top: 0;
}

#oogwyrknbv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#oogwyrknbv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#oogwyrknbv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#oogwyrknbv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#oogwyrknbv .gt_row_group_first td {
  border-top-width: 2px;
}

#oogwyrknbv .gt_row_group_first th {
  border-top-width: 2px;
}

#oogwyrknbv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#oogwyrknbv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#oogwyrknbv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#oogwyrknbv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oogwyrknbv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#oogwyrknbv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#oogwyrknbv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#oogwyrknbv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#oogwyrknbv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oogwyrknbv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oogwyrknbv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#oogwyrknbv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oogwyrknbv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#oogwyrknbv .gt_left {
  text-align: left;
}

#oogwyrknbv .gt_center {
  text-align: center;
}

#oogwyrknbv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#oogwyrknbv .gt_font_normal {
  font-weight: normal;
}

#oogwyrknbv .gt_font_bold {
  font-weight: bold;
}

#oogwyrknbv .gt_font_italic {
  font-style: italic;
}

#oogwyrknbv .gt_super {
  font-size: 65%;
}

#oogwyrknbv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#oogwyrknbv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#oogwyrknbv .gt_indent_1 {
  text-indent: 5px;
}

#oogwyrknbv .gt_indent_2 {
  text-indent: 10px;
}

#oogwyrknbv .gt_indent_3 {
  text-indent: 15px;
}

#oogwyrknbv .gt_indent_4 {
  text-indent: 20px;
}

#oogwyrknbv .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=""></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Rarely">Rarely</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Sometimes">Sometimes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Often">Often</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="Mexico">Mexico</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>26.29%<br><span style="font-size:70%">(9,897)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>45.53%<br><span style="font-size:70%">(17,139)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>28.17%<br><span style="font-size:70%">(10,605)</span></p>
</div></td></tr>
    <tr><td headers="Mexico  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="Mexico  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>18.02%<br><span style="font-size:70%">(6,812)</span></p>
</div></td>
<td headers="Mexico  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>32.73%<br><span style="font-size:70%">(12,369)</span></p>
</div></td>
<td headers="Mexico  Often" class="gt_row gt_center"><div class="gt_from_md"><p>49.25%<br><span style="font-size:70%">(18,613)</span></p>
</div></td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="4" class="gt_group_heading" scope="colgroup" id="United States">United States</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Comic books</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center"><div class="gt_from_md"><p>62.95%<br><span style="font-size:70%">(3,237)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center"><div class="gt_from_md"><p>26.86%<br><span style="font-size:70%">(1,381)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center"><div class="gt_from_md"><p>10.19%<br><span style="font-size:70%">(524)</span></p>
</div></td></tr>
    <tr><td headers="United States  book_type" class="gt_row gt_left"><div class="gt_from_md"><p>Newspapers</p>
</div></td>
<td headers="United States  Rarely" class="gt_row gt_center" style="background-color: #FFD9D9; color: #E51B24; font-weight: bold;"><div class="gt_from_md"><p>25.27%<br><span style="font-size:70%">(1,307)</span></p>
</div></td>
<td headers="United States  Sometimes" class="gt_row gt_center" style="background-color: #FFF8E4; color: #E3C508; font-weight: bold;"><div class="gt_from_md"><p>37.22%<br><span style="font-size:70%">(1,925)</span></p>
</div></td>
<td headers="United States  Often" class="gt_row gt_center" style="background-color: #D7EBFF; color: #009DDC; font-weight: bold;"><div class="gt_from_md"><p>37.51%<br><span style="font-size:70%">(1,940)</span></p>
</div></td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>We’ll again call this estimand <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, but have three different versions of it:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctheta_1%20&amp;=%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20often%7D%20-%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20sometimes%7D%20%5C%5C%0A%5Ctheta_2%20&amp;=%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20sometimes%7D%20-%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20rarely%7D%20%5C%5C%0A%5Ctheta_3%20&amp;=%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20often%7D%20-%20%5Cpi_%5Ctext%7BUS,%20newspapers,%20rarely%7D%0A%5Cend%7Baligned%7D%0A"> We just spent a bunch of time talking about comic books, and now we’re looking at data about newspapers and America. Who represents all three of these things simultaneously? Clark Kent / Superman, obviously, the <em>Daily Planet</em> journalist and superpowered alien dedicated to <a href="https://variety.com/2021/film/news/superman-new-motto-dc-fandome-1235090712/">truth, justice, and <del>the American way</del> a better tomorrow</a>. I found this palette at <a href="https://color.adobe.com/Copy%20of%20Superman-color-theme-11627723">Adobe Color</a>.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># US newspaper question colors</span></span>
<span id="cb50-2">clr_often <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009DDC"</span></span>
<span id="cb50-3">clr_sometimes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFDE00"</span></span>
<span id="cb50-4">clr_rarely <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E51B24"</span></span></code></pre></div>
</details>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/img/superman.jpg" class="img-fluid"></p>
<p><a href="https://www.flickr.com/photos/27745117@N00/25903472957">“Superman”</a> by <a href="https://www.flickr.com/photos/27745117@N00/">Hannaford</a></p>
</div></div><div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/show-superman-pal-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bayesianly-with-brms-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="bayesianly-with-brms-1">Bayesianly with {brms}</h2>
<p>Let’s first extract the aggregated data we’ll work with—newspaper frequency in the United States only:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">newspapers_only <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reading_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb51-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(book_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Newspapers"</span>, country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>)</span>
<span id="cb51-3">newspapers_only</span>
<span id="cb51-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 3 × 6</span></span>
<span id="cb51-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   country       book_type  frequency     n total  prop</span></span>
<span id="cb51-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;         &lt;chr&gt;      &lt;fct&gt;     &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb51-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 United States Newspapers Rarely     1307  5172 0.253</span></span>
<span id="cb51-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 United States Newspapers Sometimes  1925  5172 0.372</span></span>
<span id="cb51-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 United States Newspapers Often      1940  5172 0.375</span></span></code></pre></div>
</details>
</div>
<p>We’ll define this formal beta-binomial model for each of the group proportions and we’ll use a Beta(2, 6) prior again (so 25% ± a bunch):</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5C%20%5Ctextbf%7BEstimands%7D%20%5C%5C%0A%5Ctheta_1%20=&amp;%5C%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20often%7D_%5Ctext%7BUS%7D%7D%20-%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20sometimes%7D_%5Ctext%7BUS%7D%7D%20%5C%5C%0A%5Ctheta_2%20=&amp;%5C%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20sometimes%7D_%5Ctext%7BUS%7D%7D%20-%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20rarely%7D_%5Ctext%7BUS%7D%7D%20%5C%5C%0A%5Ctheta_3%20=&amp;%5C%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20often%7D_%5Ctext%7BUS%7D%7D%20-%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20rarely%7D_%5Ctext%7BUS%7D%7D%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BBeta-binomial%20model%7D%20%5C%5C%0Ay_%7Bn%20%5Ctext%7B%20newspapers,%20%5Bfrequency%5D%7D_%5Ctext%7BUS%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBinomial%7D(n_%7B%5Ctext%7BTotal%20students%7D_%5Ctext%7BUS%7D%7D,%20%5Cpi_%7B%5Ctext%7Bnewspapers,%20%5Bfrequency%5D%7D_%5Ctext%7BUS%7D%7D)%20%5C%5C%0A%5Cpi_%7B%5Ctext%7Bnewspapers,%20%5Bfrequency%5D%7D_%5Ctext%7BUS%7D%7D%20%5Csim&amp;%5C%20%5Coperatorname%7BBeta%7D(%5Calpha,%20%5Cbeta)%20%5C%5C%5B10pt%5D%0A&amp;%5C%20%5Ctextbf%7BPriors%7D%20%5C%5C%0A%5Calpha%20=&amp;%5C%202%20%5C%5C%0A%5Cbeta%20=&amp;%5C%206%0A%5Cend%7Baligned%7D%0A"></p>
<p>We can estimate this model with {brms} using an intercept-free binomial model with an identity link:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/q2-model-identity_e20215c5599ebf60f002f2535c1a8b29">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">freq_newspapers_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb52-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trials</span>(total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> frequency),</span>
<span id="cb52-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> newspapers_only,</span>
<span id="cb52-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>),</span>
<span id="cb52-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lb =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ub =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb52-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> CHAINS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> WARMUP, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> ITER, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> BAYES_SEED,</span>
<span id="cb52-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb52-8">)</span>
<span id="cb52-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb52-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb52-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb52-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb52-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb52-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb52-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb52-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb52-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb52-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb52-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.1 seconds.</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">freq_newspapers_model</span>
<span id="cb53-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb53-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb53-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: n | trials(total) ~ 0 + frequency </span></span>
<span id="cb53-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: newspapers_only (Number of observations: 3) </span></span>
<span id="cb53-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb53-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb53-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb53-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb53-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb53-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## frequencyRarely        0.25      0.01     0.24     0.26 1.00     4536     2758</span></span>
<span id="cb53-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## frequencySometimes     0.37      0.01     0.36     0.38 1.00     4084     2933</span></span>
<span id="cb53-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## frequencyOften         0.37      0.01     0.36     0.39 1.00     4318     3217</span></span>
<span id="cb53-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb53-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb53-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb53-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>It works! These group proportions are the same as what we found in the contingency table:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">plot_props_newspaper <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> freq_newspapers_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newspapers_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb54-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> frequency)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_rarely, clr_sometimes, clr_often)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of frequencies of newspaper reading"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span>
<span id="cb54-11">plot_props_newspaper</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-plot-model-identity-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distributions of the proportions of the frequency of reading newspapers among American students"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the proportions of the frequency of reading newspapers among American students</figcaption>
</figure>
</div>
</div>
</div>
<p>We’re interested in our three <img src="https://latex.codecogs.com/png.latex?%5Ctheta">s, or the posterior differences between each of these proportions. We can again use <code>compare_levels()</code> to find these all at once. If we specify <code>comparison = "pairwise"</code>, {tidybayes} will calculate the differences between each pair of proportions.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1">freq_newspapers_diffs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> freq_newspapers_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">epred_draws</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newspapers_only) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.epred_prop =</span> .epred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_levels</span>(.epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> frequency) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put these in the right order</span></span>
<span id="cb55-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frequency =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often - Sometimes"</span>, </span>
<span id="cb55-8">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sometimes - Rarely"</span>,</span>
<span id="cb55-9">                                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Often - Rarely"</span>)))</span>
<span id="cb55-10"></span>
<span id="cb55-11">freq_newspapers_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb55-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(frequency), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> frequency)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_diff) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F012BE"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb55-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb55-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb55-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-plot-model-identity-diffs-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distributions of the differences between various frequencies of reading newspapers among American students; all density plots are filled with the same color for now"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the differences between various frequencies of reading newspapers among American students; all density plots are filled with the same color for now</figcaption>
</figure>
</div>
</div>
</div>
<p>We can also calculate the official median differences and the probabilities that the posteriors are greater than 0:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1">freq_newspapers_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>),</span>
<span id="cb56-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_gt_0 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.epred_prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(median)</span>
<span id="cb56-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 3 × 8</span></span>
<span id="cb56-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   frequency                y    ymin   ymax .width .point .interval p_gt_0</span></span>
<span id="cb56-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;fct&gt;                &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;dbl&gt;</span></span>
<span id="cb56-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 Often - Sometimes  0.00268 -0.0161 0.0214   0.95 median qi         0.615</span></span>
<span id="cb56-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2 Sometimes - Rarely 0.119    0.101  0.136    0.95 median qi         1    </span></span>
<span id="cb56-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3 Often - Rarely     0.122    0.104  0.140    0.95 median qi         1</span></span></code></pre></div>
</details>
</div>
<p>There’s only a 60ish% chance that the difference between <span style="color: #009DDC">often</span> and <span style="color: #FFDE00">sometimes</span> is bigger than zero, so there’s probably not an actual difference between those two categories, but there’s a 100% chance that the differences between <span style="color: #FFDE00">sometimes</span> and <span style="color: #E51B24">rarely</span> and <span style="color: #009DDC">often</span> and <span style="color: #E51B24">rarely</span> are bigger than zero.</p>
</section>
<section id="better-fill-colors" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="better-fill-colors">Better fill colors</h2>
<p>Before writing up the final official answer, we need to tweak the plot of differences. With the comic book question, we used some overly-simplified-and-wrong color theory and created a <span style="color: #CD8A39">yellow</span> color for the difference (since <span style="color: #127088">blue</span> − <span style="color: #57643C">green</span> = <span style="color: #CD8A39">yellow</span>). We could maybe do that here too, but we’ve actually used all primary colors in our Superman palette. I don’t know what <span style="color: #009DDC">blue</span> − <span style="color: #FFDE00">yellow</span> or <span style="color: #FFDE00">yellow</span> − <span style="color: #E51B24">red</span> would be, and even if I calculated it somehow, it wouldn’t be as cutely intuitive as blue minus green.</p>
<p>So instead, we’ll do some fancy fill work with the neat <a href="https://coolbutuseless.github.io/package/ggpattern/">{ggpattern} package</a>, which lets us fill ggplot geoms with multiply-colored patterns. We’ll fill each distribution of <img src="https://latex.codecogs.com/png.latex?%5Ctheta">s with the combination of the two colors: we’ll fill the difference between <span style="color: #009DDC">often</span> and <span style="color: #FFDE00">sometimes</span> with stripes of those two colors, and so on.</p>
<p>We can’t use <code>geom/stat_halfeye()</code> because {tidybayes} does fancier geom work when plotting its density slabs, but we can use <code>geom_density_pattern()</code> to create normal density plots:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">freq_newspapers_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb57-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_fill =</span> frequency)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density_pattern</span>(</span>
<span id="cb57-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stripe"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stripes</span></span>
<span id="cb57-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_density =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take up 50% of the pattern (i.e. stripes equally sized)</span></span>
<span id="cb57-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_spacing =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thicker stripes</span></span>
<span id="cb57-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No border on the stripes</span></span>
<span id="cb57-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trim =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trim the ends of the distributions</span></span>
<span id="cb57-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No border on the distributions</span></span>
<span id="cb57-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F012BE"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb57-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set colors for fills and pattern fills</span></span>
<span id="cb57-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_often, clr_sometimes, clr_often)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_pattern_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_sometimes, clr_rarely, clr_rarely)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn off legends</span></span>
<span id="cb57-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb57-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(frequency), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb57-23">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-diffs-plot-patterns-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distributions of the differences between various frequencies of reading newspapers among American students; all density plots are filled with two stripes corresponding to the difference of their two categories"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the differences between various frequencies of reading newspapers among American students; all density plots are filled with two stripes corresponding to the difference of their two categories</figcaption>
</figure>
</div>
</div>
</div>
<p>Ahhh that’s so cool!</p>
<p>The only thing that’s missing is the pointrange that we get from <code>stat_halfeye()</code> that shows the median and the 50%, 80%, and 95% credible intervals. We can calculate those ourselves and add them with <code>geom_pointinterval()</code>:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find medians and credible intervals</span></span>
<span id="cb58-2">freq_newspapers_intervals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> freq_newspapers_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb58-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(frequency) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb58-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_qi</span>(.epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>))</span>
<span id="cb58-5"></span>
<span id="cb58-6">plot_diffs_nice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> freq_newspapers_diffs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb58-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_fill =</span> frequency)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density_pattern</span>(</span>
<span id="cb58-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stripe"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stripes</span></span>
<span id="cb58-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_density =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take up 50% of the pattern (i.e. stripes equally sized)</span></span>
<span id="cb58-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_spacing =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thicker stripes</span></span>
<span id="cb58-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No border on the stripes</span></span>
<span id="cb58-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trim =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trim the ends of the distributions</span></span>
<span id="cb58-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No border on the distributions</span></span>
<span id="cb58-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add 50%, 80%, and 95% intervals + median</span></span>
<span id="cb58-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointinterval</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> freq_newspapers_intervals, </span>
<span id="cb58-18">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred_prop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> .lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> .upper)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F012BE"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply axis limits by 0.5% so that the right "pp." isn't cut off</span></span>
<span id="cb58-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_pp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set colors for fills and pattern fills</span></span>
<span id="cb58-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_often, clr_sometimes, clr_often)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_pattern_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clr_sometimes, clr_rarely, clr_rarely)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern_fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn off legends</span></span>
<span id="cb58-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point difference in proportions"</span>,</span>
<span id="cb58-27">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(frequency), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make it so the pointrange doesn't get cropped</span></span>
<span id="cb58-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clip =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb58-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_nice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb58-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span>
<span id="cb58-34">plot_diffs_nice</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-diffs-plot-patterns-pointrange-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Posterior distributions of the differences between various frequencies of reading newspapers among American students; density plots are filled with stripes and a pointrange shows the median and 50%, 80%, and 95% credible intervals"></p>
<figcaption class="figure-caption margin-caption">Posterior distributions of the differences between various frequencies of reading newspapers among American students; density plots are filled with stripes and a pointrange shows the median and 50%, 80%, and 95% credible intervals</figcaption>
</figure>
</div>
</div>
</div>
<p>Perfect!</p>
</section>
<section id="final-answer-to-the-question-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="final-answer-to-the-question-1">Final answer to the question</h2>
<p>So, given these results, what’s the answer to the question “Do students in the United States vary in their frequency of reading newspapers?”? What are our three <img src="https://latex.codecogs.com/png.latex?%5Ctheta">s? The frequencies vary, but only between <span style="color: #E51B24">rarely</span> and the other two categories. There’s no difference between <span style="color: #FFDE00">sometimes</span> and <span style="color: #009DDC">often</span></p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1">(</span>
<span id="cb59-2">  (plot_props_newspaper <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb59-3">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response proportions"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> </span>
<span id="cb59-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_spacer</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb59-5">    (plot_diffs_nice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage point differences"</span>))</span>
<span id="cb59-6">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb59-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">widths =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.475</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.475</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-plot-final-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Posterior distribution of the proportions and difference in proportions of the frequency of reading newspapers among American students"></p>
<figcaption class="figure-caption margin-caption">Posterior distribution of the proportions and difference in proportions of the frequency of reading newspapers among American students</figcaption>
</figure>
</div>
</div>
</div>
<p>Here’s how I’d write about the results:</p>
<blockquote class="blockquote">
<p>Students in the United States tend to read the newspaper at least sometimes, and are least likely to read it rarely. On average, 25.3% of American PISA respondents report reading the newspaper rarely (with a 95% credible interval of between 24.1% and 26.5%), compared to 37.2% reading sometimes (35.9%–38.5%) and 37.5% reading sometimes (36.2%–38.8%).</p>
<p>There is no substantial difference in proportions between those reporting reading newspapers often and sometimes. The posterior median difference is between −1.6 and 2.1 percentage points, with a median of 0.3 percentage points, and there’s only a 61.5% probability that this difference is greater than 0, which implies that the two categories are indistinguishable from each other.</p>
<p>There <em>is</em> a clear substantial difference between the proportion reading newspapers rarely and the other two responses, though. The posterior median difference between sometimes and rarely is between 10.1 and 13.6 percentage points (median = 11.9), while the difference between often and rarely is between 10.4 and 14.0 percentage points (median = 12.2). The probability that each of these differences is greater than 0 is 100%.</p>
</blockquote>
<hr>
<p>Et voila! Principled, easily interpretable, non-golem-based tests of differences in proportions using Bayesian statistics!</p>


<!-- -->

</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {A Guide to {Bayesian} Proportion Tests with {R} and \{Brms\}},
  date = {2023-05-15},
  url = {https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props},
  doi = {10.59350/kw2gj-kw740},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“A Guide to Bayesian Proportion Tests with R
and {Brms}.”</span> May 15, 2023. <a href="https://doi.org/10.59350/kw2gj-kw740">https://doi.org/10.59350/kw2gj-kw740</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>bayes</category>
  <category>brms</category>
  <category>stan</category>
  <category>surveys</category>
  <category>categorical data</category>
  <guid>https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index.html</guid>
  <pubDate>Sun, 14 May 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/05/15/fancy-bayes-diffs-props/index_files/figure-html/q2-plot-final-1.png" medium="image" type="image/png" height="66" width="144"/>
</item>
<item>
  <title>Making Middle Earth maps with R</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index.html</link>
  <description><![CDATA[ 




<p>I’ve taught a course on data visualization with R since 2017, and it’s become one of my more popular classes, especially since <a href="https://datavizs22.classes.andrewheiss.com/">it’s all available asynchronously online</a> with hours of Creative Commons-licensed videos and materials. One of the most popular sections of the class (as measured by my server logs and by how often I use it myself) is <a href="https://datavizs22.classes.andrewheiss.com/example/12-example/">a section on GIS-related visualization</a>, or how to work with maps in {ggplot2}. Nowadays, since the advent of the <a href="https://r-spatial.github.io/sf/">{sf} package</a>, I find that making maps with R is incredibly easy and fun.</p>
<p>I’m also a huge fan of J. R. R. Tolkien and his entire <a href="https://en.wikipedia.org/wiki/Tolkien%27s_legendarium">Legendarium</a> (as evidenced by <a href="https://www.andrewheiss.com/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/">my previous blog post here</a> simulating Aragorn’s human-scale age based on an obscure footnote in Tolkien’s writings about Númenor).</p>
<p>Back in 2020, as I was polishing up my data visualization course page on visualizing spatial data, I stumbled across <a href="https://github.com/jvangeld/ME-GIS">a set of shapefiles for Middle Earth</a>, meaning that it was possible to use R and ggplot to make maps of Tolkien’s fictional world. I whipped up a quick example and <a href="https://twitter.com/andrewheiss/status/1291380121069330432">tweeted about it</a> back then, but then kind of forgot about it.</p>
<p>With Twitter dying, and with my recent read of <em>The Fall of Númenor</em>, Middle Earth maps have been on my mind again, so I figured I’d make a more formal didactic blog post about how to make and play with these maps. So consider this blog post a fun little playground for learning more about doing GIS work with {sf} and ggplot, and learn some neat data visualization tricks along the way.</p>
<p>Let’s put the R in “J. R. R.”</p>
<section id="lightning-quick-overview-of-sf-and-shapefiles" class="level1 page-columns page-full">
<h1>Lightning quick overview of {sf} and shapefiles</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a wildly brief intro to the {sf} package. For more details, see my <a href="https://datavizs22.classes.andrewheiss.com/example/12-example/">data visualization lesson on visualizing space</a>, as well as the free <a href="https://r-spatial.org/book/"><em>Spatial Data Science</em></a> and <a href="https://r.geocompx.org/">Geocomputation with R</a> books.</p>
</div>
</div>
<p>Thanks to the magic of the <a href="https://r-spatial.github.io/sf/">{sf} package</a> (“sf” = <a href="https://en.wikipedia.org/wiki/Simple_Features">“simple features”</a>), working with geographic (or GIS) data in R is really really straightforward and fun.</p>
<p>Geographic data is a lot more complex than regular tabular spreadsheet-like data, since it includes information about points (latitude, longitude), paths (a bunch of connected latitudes and longitudes) and areas (a bunch of connected latitudes and longitudes that form a complete shape). Additionally, it has to keep track of units and distances and map projections (or methods for <a href="https://www.youtube.com/watch?v=kIID5FDi2JQ">flattening parts of a round globe onto a two-dimensional surface</a>). This kind of data is often stored in <a href="https://en.wikipedia.org/wiki/Shapefile">shapefile format</a> (though there are alternatives like <a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a>), which consist of multiple files. For instance, here’s what the 2022 US Census’s shapefile for US states looks like when unzipped:</p>
<pre class="text"><code>cb_2022_us_state_20m
├── cb_2022_us_state_20m.cpg
├── cb_2022_us_state_20m.dbf
├── cb_2022_us_state_20m.prj
├── cb_2022_us_state_20m.shp
├── cb_2022_us_state_20m.shp.ea.iso.xml
├── cb_2022_us_state_20m.shp.iso.xml
└── cb_2022_us_state_20m.shx</code></pre>
<p>It has 7 different files, each with different purposes! Fortunately, it’s easy to read all these in with {sf}. Feed the name of the main <code>.shp</code> file to <code>read_sf()</code> and it’ll handle all the other secondary files (like <code>.dbf</code> and <code>.shx</code> and <code>.prj</code>).</p>
<p>Here I’ve downloaded the <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">US Census’s 1:20,000,000 Cartographic Boundary File shapefile</a> and put it in a folder named <code>data</code>. We can load it into R with <code>read_sf()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html</span></span>
<span id="cb2-6">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/cb_2022_us_state_20m/cb_2022_us_state_20m.shp"</span>)</span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just show some of the columns</span></span>
<span id="cb2-9">us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(STATEFP, STUSPS, NAME, geometry)</span>
<span id="cb2-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 52 features and 3 fields</span></span>
<span id="cb2-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb2-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb2-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -179 ymin: 17.9 xmax: 180 ymax: 71.4</span></span>
<span id="cb2-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  NAD83</span></span>
<span id="cb2-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 52 × 4</span></span>
<span id="cb2-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    STATEFP STUSPS NAME                                                                                      geometry</span></span>
<span id="cb2-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;                                                                           &lt;MULTIPOLYGON [°]&gt;</span></span>
<span id="cb2-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 48      TX     Texas      (((-107 31.9, -107 32, -107 32, -107 32, -106 32, -106 32, -106 32, -106 32, -105 32...</span></span>
<span id="cb2-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 06      CA     California (((-119 33.5, -118 33.5, -118 33.4, -118 33.4, -118 33.3, -118 33.3, -118 33.3, -118...</span></span>
<span id="cb2-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 21      KY     Kentucky   (((-89.5 36.6, -89.5 36.6, -89.4 36.6, -89.4 36.6, -89.3 36.6, -89.3 36.6, -89.3 36....</span></span>
<span id="cb2-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 13      GA     Georgia    (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3...</span></span>
<span id="cb2-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 55      WI     Wisconsin  (((-86.9 45.4, -86.8 45.5, -86.8 45.4, -86.9 45.4, -86.9 45.3, -87 45.4, -86.9 45.4)...</span></span>
<span id="cb2-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 41      OR     Oregon     (((-125 42.8, -124 43, -124 43, -124 43.1, -124 43.2, -124 43.2, -124 43.3, -124 43....</span></span>
<span id="cb2-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 29      MO     Missouri   (((-95.8 40.6, -95.5 40.6, -95.4 40.6, -95.3 40.6, -95.2 40.6, -95.1 40.6, -94.9 40....</span></span>
<span id="cb2-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 51      VA     Virginia   (((-76 37.3, -76 37.4, -76 37.4, -75.9 37.5, -75.9 37.6, -75.9 37.6, -75.9 37.7, -75...</span></span>
<span id="cb2-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 47      TN     Tennessee  (((-90.3 35, -90.3 35, -90.2 35.1, -90.2 35.1, -90.2 35.1, -90.1 35.1, -90.1 35.2, -...</span></span>
<span id="cb2-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 22      LA     Louisiana  (((-94 32.7, -94 32.8, -94 32.9, -94 33, -93.8 33, -93.8 33, -93.7 33, -93.5 33, -93...</span></span>
<span id="cb2-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # … with 42 more rows</span></span></code></pre></div>
</details>
</div>
<p>It looks like a regular R dataframe, and it is (all the regular dplyr functions work on it), but it has one added part—there’s a special list column at the end named <code>geometry</code> that contains the actual geographic data, and the dataframe has special metadata with details about the map projection. As seen above, the data uses <a href="https://geodesy.noaa.gov/datums/horizontal/north-american-datum-1983.shtml">NAD 83</a>. We can change that to any projection we want, though, with <code>st_transform()</code>. To make life a little easier when calculating distances and combining maps later in this post, we’ll convert this US map to the WGS 84 projection, which is what Google Maps (and all GPS systems) use:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://datavizs22.classes.andrewheiss.com/example/12-example/#projections-and-coordinate-reference-systems">See this for a short overview</a> of projections and coordinate reference systems (CRS). You can <a href="https://epsg.io/">look up their ID numbers here</a>.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># WGS 84</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just show some of the columns</span></span>
<span id="cb3-5">us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(STATEFP, STUSPS, NAME, geometry)</span>
<span id="cb3-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 52 features and 3 fields</span></span>
<span id="cb3-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb3-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb3-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -179 ymin: 17.9 xmax: 180 ymax: 71.4</span></span>
<span id="cb3-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb3-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 52 × 4</span></span>
<span id="cb3-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    STATEFP STUSPS NAME                                                                                      geometry</span></span>
<span id="cb3-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;                                                                           &lt;MULTIPOLYGON [°]&gt;</span></span>
<span id="cb3-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  1 48      TX     Texas      (((-107 31.9, -107 32, -107 32, -107 32, -106 32, -106 32, -106 32, -106 32, -105 32...</span></span>
<span id="cb3-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  2 06      CA     California (((-119 33.5, -118 33.5, -118 33.4, -118 33.4, -118 33.3, -118 33.3, -118 33.3, -118...</span></span>
<span id="cb3-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  3 21      KY     Kentucky   (((-89.5 36.6, -89.5 36.6, -89.4 36.6, -89.4 36.6, -89.3 36.6, -89.3 36.6, -89.3 36....</span></span>
<span id="cb3-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  4 13      GA     Georgia    (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3...</span></span>
<span id="cb3-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  5 55      WI     Wisconsin  (((-86.9 45.4, -86.8 45.5, -86.8 45.4, -86.9 45.4, -86.9 45.3, -87 45.4, -86.9 45.4)...</span></span>
<span id="cb3-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  6 41      OR     Oregon     (((-125 42.8, -124 43, -124 43, -124 43.1, -124 43.2, -124 43.2, -124 43.3, -124 43....</span></span>
<span id="cb3-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  7 29      MO     Missouri   (((-95.8 40.6, -95.5 40.6, -95.4 40.6, -95.3 40.6, -95.2 40.6, -95.1 40.6, -94.9 40....</span></span>
<span id="cb3-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  8 51      VA     Virginia   (((-76 37.3, -76 37.4, -76 37.4, -75.9 37.5, -75.9 37.6, -75.9 37.6, -75.9 37.7, -75...</span></span>
<span id="cb3-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  9 47      TN     Tennessee  (((-90.3 35, -90.3 35, -90.2 35.1, -90.2 35.1, -90.2 35.1, -90.1 35.1, -90.1 35.2, -...</span></span>
<span id="cb3-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 10 22      LA     Louisiana  (((-94 32.7, -94 32.8, -94 32.9, -94 33, -93.8 33, -93.8 33, -93.7 33, -93.5 33, -93...</span></span>
<span id="cb3-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # … with 42 more rows</span></span></code></pre></div>
</details>
</div>
<p>The data’s the same; the projection is different now. Neat.</p>
<p>Since this is just a dataframe, we can manipulate it like any other dataframe. Let’s filter it so that we only keep the 48 contiguous states:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">lower_48 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alaska"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hawaii"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Puerto Rico"</span>)))</span></code></pre></div>
</details>
</div>
<p>{sf} makes it incredibly easy to plot maps too. By relying on the geographic details embedded in the special <code>geometry</code> plot, the <code>geom_sf()</code> function automatically plots the correct kind of data (points, lines, or areas). And since we’re just working with a dataframe, everything in the grammar of graphics paradigm works too. We can map columns to specific aesthetics. For instance, the Census shapefile happened to come with a column named <code>ALAND</code> that measures the total land area in each state in square meters. We can fill by that column and create a choropleth map showing states by size:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ALAND))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/us-map-basic-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Basic map of the US, with states filled by area"></p>
<figcaption class="figure-caption margin-caption">Basic map of the US, with states filled by area</figcaption>
</figure>
</div>
</div>
</div>
<p>Since this is just a regular ggplot geom, all other ggplot things work, like modifying themes, scales, etc. We can also change the projection on-the-fly with <code>coord_sf()</code> (here I use <a href="https://epsg.io/102003">Albers</a>):</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ALAND),</span>
<span id="cb6-5">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rocket"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb6-7">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale_cut =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut_short_scale</span>()),</span>
<span id="cb6-8">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_colorbar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">barwidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">barheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,</span>
<span id="cb6-9">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title.vjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers projection</span></span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Land area (m²)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb6-14">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb6-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>)),</span>
<span id="cb6-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/us-map-fancy-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Fancier map of the US, with states filled by area"></p>
<figcaption class="figure-caption margin-caption">Fancier map of the US, with states filled by area</figcaption>
</figure>
</div>
</div>
</div>
<section id="getting-geographic-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="getting-geographic-data">Getting geographic data</h2>
<p>Shapefiles are everywhere. They’re one of the de facto standard formats for GIS data, and most government agencies provide them for their jurisdictions (<a href="https://datavizs22.classes.andrewheiss.com/example/12-example/#shapefiles">see here for a list of some different sources</a>). You can view and edit them graphically with the free and open source <a href="https://qgis.org/en/site/">QGIS</a> or with the expensive and industry-standard <a href="https://www.arcgis.com/index.html">ArcGIS</a>.</p>
<p>We’ve already seen how to load shapefiles into R with <code>sf::read_sf()</code>, and that works great. But doing that requires that you go and find and download the shapefiles that you want, which can involve hunting through complicated websites. There are also lots of different R packages that let you get shapefiles directly from different websites’ APIs.</p>
<p>For example, we’ve already loaded the 2022 US Census maps by downloading and unzipping the shapefile and using <code>read_sf()</code>. We could have also used the <a href="https://github.com/walkerke/tigris">{tigris}</a> package to access the data directly from the Census, like this:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tigris)</span>
<span id="cb7-2"></span>
<span id="cb7-3">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">states</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20m"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cb =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-4"></span>
<span id="cb7-5">lower_48 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alaska"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hawaii"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Puerto Rico"</span>)))</span></code></pre></div>
</details>
</div>
<p>For world-level data, <a href="https://www.naturalearthdata.com/">Natural Earth</a> has incredibly well-made shapefiles. We could download the <a href="https://www.naturalearthdata.com/downloads/50m-cultural-vectors/">1:50m cultural data</a> from their website, unzip it, and load it with <code>read_sf()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Medium scale data, 1:50m Admin 0 - Countries</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download from https://www.naturalearthdata.com/downloads/50m-cultural-vectors/</span></span>
<span id="cb8-3">world_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(iso_a3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATA"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove Antarctica</span></span></code></pre></div>
</details>
</div>
<p>Or we can use the <a href="https://github.com/ropensci/rnaturalearth">{rnaturalearth}</a> package to do the same thing:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rnaturalearth)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rerturnclass = "sf" makes it so the resulting dataframe has the special</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sf-enabled geometry column</span></span>
<span id="cb9-5">world_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ne_countries</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">returnclass =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(iso_a3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATA"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove Antarctica</span></span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Throughout this post, I use {rnaturalearth} for world-level shapefiles and downloaded shapefiles for the US, but that’s just for the sake of illustration. Both can be done with packages or through downloading.</p>
</div>
</div>
<p>And finally, for fun, here are some examples of different maps and projections and ggplot tinkering. I’m perpetually astounded by how easy it is to plot GIS data with <code>geom_sf()</code>! That <code>geometry</code> list column is truly magical.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb10-2"></span>
<span id="cb10-3">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0074D9"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4269"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NAD83</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NAD83 projection"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>))</span>
<span id="cb10-9"></span>
<span id="cb10-10">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0074D9"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb10-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Albers projection"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>))</span>
<span id="cb10-16"></span>
<span id="cb10-17">p3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> world_map, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF4136"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:3395"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mercator</span></span>
<span id="cb10-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mercator projection"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>))</span>
<span id="cb10-23"></span>
<span id="cb10-24">p4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> world_map, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF4136"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:54030"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Robinson</span></span>
<span id="cb10-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robinson projection"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>))</span>
<span id="cb10-30"></span>
<span id="cb10-31">(p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (p3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p4)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/example-projections-1.png" class="img-fluid figure-img" style="width:90.0%" alt="Examples of different North American and world map projections"></p>
<figcaption class="figure-caption margin-caption">Examples of different North American and world map projections</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="quick-reminder-latitude-vs.-longitude" class="level1 page-columns page-full">
<h1>Quick reminder: latitude vs.&nbsp;longitude</h1>
<p>One last little GIS-related thing before going to Middle Earth. Geographic data doesn’t rely on the standard X/Y Cartesian plane. Instead, it uses latitudes and longitudes. I’ve loved maps and globes all my life, but I <em>can never remember</em> how latitudes and longitudes translate to X and Y, especially since coordinates are often reported as <code>lat, lon</code>, which is technically the reverse of <code>x, y</code>.</p>
<p>I have this graph printed and hanging on my office wall next to my computer and refer to it all the time. It’s my gift to all of you.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">point_example <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{x} x, {y} y</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{y} lat, {x} lon"</span>))</span>
<span id="cb11-3">lat_labs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Latitude"</span>)</span>
<span id="cb11-4">lon_labs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Longitude"</span>)</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> point_example, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> point_example, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> label),</span>
<span id="cb11-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lat_labs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> label),</span>
<span id="cb11-11">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lon_labs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> label),</span>
<span id="cb11-13">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Light"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_equal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb11-22">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/lat-lon-plot-1.png" class="img-fluid figure-img" style="width:65.0%" alt="Helpful diagram showing how latitude and longitude translate to x and y coordinates"></p>
<figcaption class="figure-caption margin-caption">Helpful diagram showing how latitude and longitude translate to x and y coordinates</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="loading-middle-earth-shapefiles" class="level1">
<h1>Loading Middle Earth shapefiles</h1>
<p>Phew, okay. With that quick overview done, we can start playing with the <a href="https://github.com/jvangeld/ME-GIS">ME-GIS data</a>. There’s isn’t a pre-built R package for the data, so we’ll need to download the GitHub repository ourselves. I put all the files in a folder named <code>data/ME-GIS</code> relative to this document. I also downloaded the <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">2022 US Census cartographic boundary files</a> and put them in a folder named <code>data/cb_2022_us_state_20m</code>. If you’re following along, I suggest you do the same.</p>
<p>The ME-GIS project includes tons of different shapefile layers: data for coastline borders, elevation contours, forest boundaries, city locations, and so on. We’ll load a bunch of them here.</p>
<p>Notice the extra <code>iconv(., from = "ISO-8859-1", to = "UTF-8")</code> that I’ve added to each <code>read_sf()</code> call. This is necessary because the original data isn’t stored as Unicode, which is an issue because Tolkien used all sorts of accents (like “Lórien”), and R can choke on these characters. To make life easier, I use <code>iconv()</code> to convert all the character columns in each shapefile from <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-1">Latin 1 (ISO-8859-1)</a> to Unicode (UTF-8).</p>
<p>Make sure you download and install the <a href="https://fonts.google.com/specimen/Overpass">Overpass font from Google Fonts</a> if you want to use the custom fonts throughout the post.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rnaturalearth)</span>
<span id="cb12-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggspatial)</span>
<span id="cb12-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb12-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb12-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(leaflet)</span>
<span id="cb12-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)</span></code></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">coastline <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Coastline2.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-3"></span>
<span id="cb13-4">contours <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Contours_18.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-6"></span>
<span id="cb13-7">rivers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Rivers.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-9"></span>
<span id="cb13-10">roads <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Roads.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-12"></span>
<span id="cb13-13">lakes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Lakes.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-15"></span>
<span id="cb13-16">regions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Regions_Anno.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-18"></span>
<span id="cb13-19">forests <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Forests.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-21"></span>
<span id="cb13-22">mountains <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Mountains_Anno.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb13-24"></span>
<span id="cb13-25">placenames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Combined_Placenames.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span></code></pre></div>
</details>
</div>
<p>We’ll also load and process the Census data and Natural Earth data (we did this before in the overivew, but we’ll do it again here in case you skipped that part):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Census data</span></span>
<span id="cb14-2">us_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/cb_2022_us_state_20m/cb_2022_us_state_20m.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>))</span>
<span id="cb14-4"></span>
<span id="cb14-5">lower_48 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_states <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alaska"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hawaii"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Puerto Rico"</span>)))</span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Natural Earth data</span></span>
<span id="cb14-9">world_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ne_countries</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">returnclass =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(iso_a3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATA"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove Antarctica</span></span></code></pre></div>
</details>
</div>
<p>Finally, we’ll define a couple little helper functions to convert between meters and miles (the Middle Earth data is stored as meters), and define some colors that we’ll use in the maps.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">miles_to_meters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb15-2">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb15-3">}</span>
<span id="cb15-4"></span>
<span id="cb15-5">meters_to_miles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb15-6">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1609.344</span></span>
<span id="cb15-7">}</span>
<span id="cb15-8"></span>
<span id="cb15-9">clr_green <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#035711"</span></span>
<span id="cb15-10">clr_blue <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0776e0"</span></span>
<span id="cb15-11">clr_yellow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#fffce3"</span></span>
<span id="cb15-12"></span>
<span id="cb15-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format numeric coordinates with degree symbols and cardinal directions</span></span>
<span id="cb15-14">format_coords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(coords) {</span>
<span id="cb15-15">  ns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(coords[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb15-16">  ew <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(coords[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span>)</span>
<span id="cb15-17">  </span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{latitude}°{ns} {longitude}°{ew}"</span>,</span>
<span id="cb15-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">latitude =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%.6f"</span>, coords[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]),</span>
<span id="cb15-20">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">longitude =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%.6f"</span>, coords[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]))</span>
<span id="cb15-21">}</span></code></pre></div>
</details>
</div>
</section>
<section id="exploring-the-different-layers" class="level1 page-columns page-full">
<h1>Exploring the different layers</h1>
<p>With all these shapefiles loaded, we can experiment with them and see what’s in them. Here’s the coastline:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) </span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/basic-coastline-1.png" class="img-fluid figure-img" style="width:70.0%" alt="Middle Earth's coastline"></p>
<figcaption class="figure-caption margin-caption">Middle Earth’s coastline</figcaption>
</figure>
</div>
</div>
</div>
<p>Neat. We can add some rivers and lakes to it:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_blue)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/basic-coastline-rivers-1.png" class="img-fluid figure-img" style="width:70.0%" alt="Middle Earth with rivers and lakes"></p>
<figcaption class="figure-caption margin-caption">Middle Earth with rivers and lakes</figcaption>
</figure>
</div>
</div>
</div>
<p>The level of detail in these coastlines and borders is <em>incredible</em>. Great work, ME-DEM team!</p>
<p>Let’s add placenames:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_blue) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> placenames, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/basic-coastline-rivers-places-1.png" class="img-fluid figure-img" style="width:70.0%" alt="Middle Earth with rivers and lakes and too many places"></p>
<figcaption class="figure-caption margin-caption">Middle Earth with rivers and lakes and too many places</figcaption>
</figure>
</div>
</div>
</div>
<p>Ha, that’s less than helpful. There are 785 different placenames in the data. Since the <code>placenames</code> object is just a fancy dataframe, we can filter it and just look at a few of the places: Hobbiton (the Shire), Rivendell, Edoras (capital of Rohan), and Minas Tirith (capital of Gondor). We’ll also add labels with <code>geom_sf_label()</code> and scoot the labels up a bit so that they’re not on top of the points. The geographic data here is measured in meters, so we can specify how many meters we want each label moved up. Because I don’t think in the metric system, and because there are 1,609 meters in a mile and that implies big numbers, I’ll specify the label offset in miles with the <code>miles_to_meters()</code> function we made earlier. We’ll push the labels up by 50 miles (or 80,467 meters):</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">places <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>))</span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_blue) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> places, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> places, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/basic-coastline-rivers-places-small-1.png" class="img-fluid figure-img" style="width:70.0%" alt="Middle Earth with rivers, lakes, and four cities"></p>
<figcaption class="figure-caption margin-caption">Middle Earth with rivers, lakes, and four cities</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="fancy-map-of-middle-earth-with-lots-of-layers" class="level1 page-columns page-full">
<h1>Fancy map of Middle Earth with lots of layers</h1>
<p>So far we’ve seen that we can stack up as many <code>geom_sf()</code> layers as we want to combine each of these shapefiles into a single plot, and we can modify each of the layers just like a standard ggplot geom. Here’s a more polished fancy final version of Middle Earth with better colors, fonts, elevation contours, and so on.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">places <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>))</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> contours, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lakes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_blue) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> forests, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_green, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> mountains, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> places) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> places, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>),</span>
<span id="cb20-13">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb20-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_yellow))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/full-nice-map-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Complete fancy map of Middle Earth"></p>
<figcaption class="figure-caption margin-caption">Complete fancy map of Middle Earth</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="map-of-just-the-shire" class="level1 page-columns page-full">
<h1>Map of just the Shire</h1>
<p>That’s a really neat map! We can get even fancier though! Given the quality of the geographic data, we can zoom in and get much more detail for specific regions. For instance, we can zoom in on just the Shire. We can specify a window of coordinates in <code>coord_sf()</code> to zoom the plot, and with actual real world data we could <a href="https://www.openstreetmap.org/export#map=4/54.47/12.79">use a tool like this</a> to find those coordinates on a map, but since this is fictional data, it’s a little bit trickier to define specific bounds.</p>
<p>To find the rough bounds of the Shire, we’ll first extract the coordinates for Hobbiton, home of Bilbo and Frodo Baggins. The geographic data is currently stuck in the <code>geometry</code> list column, but we can use <code>map_dbl()</code> from {purrr} to extract the values as numbers:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">hobbiton <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry_x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(geometry, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(.)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb21-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(geometry, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(.)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb21-5"></span>
<span id="cb21-6">hobbiton <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb21-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(LAYER, NAME, geometry_x, geometry_y)</span>
<span id="cb21-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 1 feature and 4 fields</span></span>
<span id="cb21-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb21-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb21-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: 516000 ymin: 1040000 xmax: 516000 ymax: 1040000</span></span>
<span id="cb21-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Projected CRS: UTM_Zone_31_Northern_Hemisphere</span></span>
<span id="cb21-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 5</span></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   LAYER     NAME     geometry_x geometry_y         geometry</span></span>
<span id="cb21-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;      &lt;POINT [m]&gt;</span></span>
<span id="cb21-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 TownNames Hobbiton    515948.   1043820. (515948 1043820)</span></span></code></pre></div>
</details>
</div>
<p>Alternatively, we can avoid {purrr} stuff and pull out the numbers directly with <code>st_geometry()</code>. I prefer keeping everything inside the dataframe, though, so I typically use {purrr} for this kind of thing.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">hobbiton_no_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>()</span>
<span id="cb22-4">hobbiton_no_df</span>
<span id="cb22-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry set for 1 feature </span></span>
<span id="cb22-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb22-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb22-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: 516000 ymin: 1040000 xmax: 516000 ymax: 1040000</span></span>
<span id="cb22-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Projected CRS: UTM_Zone_31_Northern_Hemisphere</span></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## POINT (515948 1043820)</span></span>
<span id="cb22-11">hobbiton_no_df[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb22-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 515948</span></span>
<span id="cb22-13">hobbiton_no_df[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb22-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 1043820</span></span></code></pre></div>
</details>
</div>
<p>Those (515948, 1043820) coordinates are the location of Hobbiton and they’re measured in meters. We can add and subtract some amount of meters to each side of the coordinates to build a window around Hobbiton and set the bounds of the map. Here I add 30 miles to the west, 60 miles to the east, 35 miles to the north, and 20 miles to the south of Hobbiton (I figured those out through a bunch of trial and error to get the main features and labels that I wanted to show in the fancier map below)</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">shire_towns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(LAYER <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TownNames"</span>)</span>
<span id="cb23-2"></span>
<span id="cb23-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> roads) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> shire_towns, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> shire_towns, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb23-8">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), </span>
<span id="cb23-10">                    hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)),</span>
<span id="cb23-11">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>), </span>
<span id="cb23-12">                    hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/shire-zoomed-in-basic-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Basic zoomed-in map of the Shire"></p>
<figcaption class="figure-caption margin-caption">Basic zoomed-in map of the Shire</figcaption>
</figure>
</div>
</div>
</div>
<p>Using that window of coordinates, we can make the map extra fancy with some more enhancements. The roads data, for instance, includes a column that indicates if a road is primary, secondary, or tertiary, so we can size by road importance. We can also add some neat little annotations, like a compass indicator and a scale marker (using <code>annotation_scale()</code> and <code>annotation_north_arrow()</code> from the <a href="https://paleolimbot.github.io/ggspatial/">{ggspatial} package</a>). We’ll also add a Tolkienesque plot title with <a href="https://www.dafont.com/aniron.font">the Aniron font</a>:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">shire_towns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(LAYER <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TownNames"</span>)</span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> roads, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> TYPE), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rivers, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue,</span>
<span id="cb24-8">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass SemiBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> regions, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> name),</span>
<span id="cb24-10">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Heavy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> forests, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_green, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> forests, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb24-13">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_green, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> shire_towns, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> shire_towns, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb24-16">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plain"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linewidth_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb24-19">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb24-20">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_north_arrow</span>(</span>
<span id="cb24-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pad_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb24-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">north_arrow_fancy_orienteering</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>), </span>
<span id="cb24-24">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>,</span>
<span id="cb24-25">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), </span>
<span id="cb24-27">                    hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)),</span>
<span id="cb24-28">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>), </span>
<span id="cb24-29">                    hobbiton<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>geometry_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Shire"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb24-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_yellow),</span>
<span id="cb24-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aniron"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb24-34">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/shire-zoomed-in-fancy-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Fancy zoomed-in map of the Shire"></p>
<figcaption class="figure-caption margin-caption">Fancy zoomed-in map of the Shire</figcaption>
</figure>
</div>
</div>
</div>
<p>ahhh that’s so cool!</p>
</section>
<section id="distances-between-places" class="level1">
<h1>Distances between places</h1>
<p>We’re not done yet though! We can do a lot more GIS-related work with R. Let’s calculate some distances for fun!</p>
<p>In the first half of <em>The Fellowship of the Ring</em>, Frodo, Sam, Merry, and Pippin travel from the Shire to Rivendell. How long of a journey was that?</p>
<p>To figure this out we can extract the coordinates for Rivendell and then find the difference between it and Hobbiton. This doesn’t follow any roads or anything—it’s just as the Nazgûl flies—but it should be fairly accurate.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find coordinates for Rivendell</span></span>
<span id="cb25-2">rivendell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>)</span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(hobbiton, rivendell) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_miles</span>()</span>
<span id="cb25-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Units: [m]</span></span>
<span id="cb25-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      [,1]</span></span>
<span id="cb25-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]  229</span></span></code></pre></div>
</details>
</div>
<p>According to Karen Wynn Fonstad’s <a href="https://www.amazon.com/Atlas-Middle-Earth-Revised-Karen-Fonstad/dp/0618126996"><em>Atlas of Middle-earth</em></a>, though, <a href="Karen Wynn Fonstad">this should be 458 miles</a>, which is exactly double the amount we just found! Somehow the distances between everything in the shapefiles are halved from regular-Earth miles.</p>
<p>To fix this we can double the distance between Hobbiton and everything else in the dataset, expanding the data from Hobbiton, which now acts like the center of the world</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">me_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb26-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take the existing coordinates, subtract the doubled Hobbiton coordinates,</span></span>
<span id="cb26-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and add the Hobbiton coordinates</span></span>
<span id="cb26-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton))</span>
<span id="cb26-6"></span>
<span id="cb26-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract new coordinates from scaled-up version</span></span>
<span id="cb26-8">hobbiton_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> me_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>)</span>
<span id="cb26-9">rivendell_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> me_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>)</span>
<span id="cb26-10"></span>
<span id="cb26-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fixed!</span></span>
<span id="cb26-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(hobbiton_scaled, rivendell_scaled) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meters_to_miles</span>()</span>
<span id="cb26-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      [,1]</span></span>
<span id="cb26-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]  458</span></span></code></pre></div>
</details>
</div>
<p>That’s correct now—it was 458 miles from the Shire to Rivendell.</p>
</section>
<section id="sticking-middle-earth-in-real-earth" class="level1 page-columns page-full">
<h1>Sticking Middle Earth in Real Earth</h1>
<p>Now that we can work with correct distances, we can sick Middle Earth inside Real Earth to help visualize how far spread out Tolkien’s world is.</p>
<section id="in-the-united-states" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="in-the-united-states">In the United States</h2>
<p>First, let’s stick a scaled-up version of Middle Earth in the United States. For fun, we’ll put the Shire in the geographic center of the US, and we’ll calculate the coordinates for that with R just to show that it’s possible.</p>
<p>Currently we have a dataset with 49 rows (48 states + DC). We can use the <code>st_centroid()</code> function to find the center of geographic areas, but if we use it on our current data, we’ll get 49 separate centers. So instead, we’ll melt all the states into one big geographic shape with <code>group_by()</code> and <code>summarize()</code> (using <code>summarize()</code> on the <code>geometry</code> column in an <code>sf</code> dataset combines the geographic areas), and then use <code>st_centroid()</code> on that:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Melt the lower 48 states into one big shape first, then use st_centroid()</span></span>
<span id="cb27-2">us_dissolved <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lower_48 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb27-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"US"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create new column with the country name </span></span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Group by that country name column</span></span>
<span id="cb27-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collapse all the geographic data into one big blob</span></span>
<span id="cb27-6">us_dissolved</span>
<span id="cb27-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Simple feature collection with 1 feature and 1 field</span></span>
<span id="cb27-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb27-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb27-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -125 ymin: 24.5 xmax: -66.9 ymax: 49.4</span></span>
<span id="cb27-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb27-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 1 × 2</span></span>
<span id="cb27-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   country                                                                                geometry</span></span>
<span id="cb27-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   &lt;chr&gt;                                                                        &lt;MULTIPOLYGON [°]&gt;</span></span>
<span id="cb27-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1 US      (((-68.9 43.8, -68.9 43.8, -68.8 43.8, -68.9 43.9, -68.9 43.9, -68.9 43.8)), ((-71.6...</span></span>
<span id="cb27-16"></span>
<span id="cb27-17">us_center <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_dissolved <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb27-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the geometry column</span></span>
<span id="cb27-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_centroid</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the center</span></span>
<span id="cb27-20">us_center</span>
<span id="cb27-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry set for 1 feature </span></span>
<span id="cb27-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb27-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb27-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: -99 ymin: 39.8 xmax: -99 ymax: 39.8</span></span>
<span id="cb27-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb27-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## POINT (-99 39.8)</span></span></code></pre></div>
</details>
</div>
<p>According to these calculations, the center of the contiguous US is 39.751441°N -98.965620°W. Technically that’s not 100% correct—<a href="https://en.wikipedia.org/wiki/Geographic_center_of_the_United_States#Contiguous_United_States">the true location</a> is at 39.833333°N -98.583333°W, but this is close enough (<a href="https://www.google.com/maps/dir/39.751441,+-98.965620/39.833333,-98.583333/@39.8236494,-98.9352692,11z/">according to Google, it’s 25 miles off</a>). I’m guessing the discrepancy is due to differences in the shapefile—I’m not using the highest resolution possible, and there might be islands I need to account for (or not account for). Who knows.</p>
<p>Here’s where that is. I’m using the <a href="https://rstudio.github.io/leaflet/">{leaflet} package</a> just for fun here (this post is a showcase of different R-based GIS things, so let’s showcase!):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">us_center_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> us_dissolved <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_centroid</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fancy_coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format_coords</span>(geometry)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='display: block; text-align: center;'&gt;&lt;strong&gt;Roughly of the center of the contiguous US&lt;/strong&gt;"</span>,</span>
<span id="cb28-5">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;{fancy_coords}&lt;/span&gt;"</span>))</span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">leaflet</span>(us_center_plot) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setView</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(us_center_plot)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb28-9">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(us_center_plot)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb28-10">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zoom =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addTiles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb28-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addCircleMarkers</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(label),</span>
<span id="cb28-13">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labelOptions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labelOptions</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noHide =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb28-14">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, </span>
<span id="cb28-15">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">textOnly =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-a897801540c9add8bd01" style="width:100%;height:355.995055624227px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-a897801540c9add8bd01">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"setView":[[39.7514407352008,-98.9656202327183],4,[]],"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircleMarkers","args":[39.7514407352008,-98.9656202327183,10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,"<span style='display: block; text-align: center;'><strong>Roughly of the center of the contiguous US<\/strong><br>39.751441°N -98.965620°W<\/span>",{"interactive":false,"permanent":true,"direction":"top","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[39.7514407352008,39.7514407352008],"lng":[-98.9656202327183,-98.9656202327183]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Next, we need to transform the Middle Earth data so that it fits on the US map. We need to do a few things to make this work:</p>
<ol type="1">
<li>Double all the distances so they match Real World miles</li>
<li>Change the projection of each of the Middle Earth-related datasets to match the projection of <code>lower_48</code>, or <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS 84</a>, or <a href="https://epsg.io/4326">EPSG:4326</a></li>
<li>Shift the Middle Earth-related datasets so that Hobbiton aligns with the center of the US.</li>
</ol>
<p>Changing the projection of an {sf}-enabled dataset is super easy with <code>st_transform()</code>. Let’s first transform the CRS for the Hobbiton coordinates:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">hobbiton_in_us <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hobbiton <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(lower_48))</span>
<span id="cb29-3"></span>
<span id="cb29-4">hobbiton_in_us <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>()</span>
<span id="cb29-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry set for 1 feature </span></span>
<span id="cb29-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geometry type: POINT</span></span>
<span id="cb29-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Dimension:     XY</span></span>
<span id="cb29-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bounding box:  xmin: 3.15 ymin: 9.44 xmax: 3.15 ymax: 9.44</span></span>
<span id="cb29-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Geodetic CRS:  WGS 84</span></span>
<span id="cb29-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## POINT (3.15 9.44)</span></span></code></pre></div>
</details>
</div>
<p>Note how the coordinates are now on the <a href="https://en.wikipedia.org/wiki/Decimal_degrees">decimal degrees scale</a> (3.15, 9.44) instead of the meter scale (515948, 1043820). That’s how the US map is set up, so now we can do GIS math with the two maps.</p>
<p>Next, we need to calculate the offset from the center of the US and Hobbiton by finding the difference between the two sets of coordinates:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">me_to_us <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>(us_center) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>(hobbiton_in_us)</span>
<span id="cb30-2">me_to_us</span>
<span id="cb30-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##         X    Y</span></span>
<span id="cb30-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] -102 30.3</span></span></code></pre></div>
</details>
</div>
<p>Now we can use that offset to redefine the geometry column in any Middle Earth-related {sf}-enabled dataset we have. Here’s the process for the <code>places</code> data—it’ll be the same for any of the other shapefiles.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">me_places_in_us <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the Middle Earth data match the US projection</span></span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(lower_48)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just look at a handful of places</span></span>
<span id="cb31-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Double the distances</span></span>
<span id="cb31-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_us)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_us)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shift everything around so that Hobbiton is in the center of the US</span></span>
<span id="cb31-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> me_to_us) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb31-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All the geometry math made us lose the projection metadata; set it again</span></span>
<span id="cb31-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(lower_48))</span></code></pre></div>
</details>
</div>
<p>We can now stick this US-transformed set of place locations insde a map of the US. (Note the ±70000 values for nudging. I have no idea what scale these are on—they’re not meters or miles (maybe feet? maybe decimal degrees?). I had to tinker with different values until it looked okay.)</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF851B"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> me_places_in_us) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_us, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>)),</span>
<span id="cb32-5">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_us, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)),</span>
<span id="cb32-7">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb32-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/basic-us-me-places-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Middle Earth locations placed in the US"></p>
<figcaption class="figure-caption margin-caption">Middle Earth locations placed in the US</figcaption>
</figure>
</div>
</div>
</div>
<p>Assuming the Shire is in the middle of Kansas, Rivendell would be near the Mississippi River in Missouri. Rohan is down in southern Arkansas, while Gondor is in southern Alabama.</p>
<p>We could be even fancier and reshift <em>all</em> the Middle Earth shapefiles to fit in the US, and then overlay all of Middle Earth on the US, but I won’t do that here. I’ll just stick the coastline on so we can compare the relative sizes of the US and Middle Earth:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">coastline_in_us <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coastline <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(lower_48)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_us)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_us)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> me_to_us) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(lower_48))</span>
<span id="cb33-6"></span>
<span id="cb33-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> lower_48, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF851B"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline_in_us, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> me_places_in_us) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_us, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>)),</span>
<span id="cb33-12">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_us, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)),</span>
<span id="cb33-14">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ESRI:102003"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Albers</span></span>
<span id="cb33-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/fancier-us-me-places-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Middle Earth locations and borders placed in the US"></p>
<figcaption class="figure-caption margin-caption">Middle Earth locations and borders placed in the US</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="in-europe" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="in-europe">In Europe</h2>
<p>Sticking Middle Earth in the US makes sense because I live in the US, so these relative distances are straightforward to me. (I’m in Georgia, which is the middle of Mordor in the maps above).</p>
<p>But Tolkien was from England and lived in Oxford—at <a href="https://en.wikipedia.org/wiki/Northmoor_Road">20 Northmoor Road</a> to be precise, or at <a href="https://www.google.com/maps/place/20+Northmoor+Rd,+Oxford+OX2+6UR,+UK/@51.7710103,-1.2626846,17z/">51.771004°N -1.260142°W</a> to be even more precise (I found this by going to Google Maps, right clicking on Tolkien’s home, and copying the coordinates). Here’s where that is:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">tolkien_home <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb34-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>place, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>lat, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>long,</span>
<span id="cb34-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tolkien's home"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">51.771003605142724</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2601418874304429</span></span>
<span id="cb34-4">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lat"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)) </span>
<span id="cb34-6"></span>
<span id="cb34-7">tolkien_home_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tolkien_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fancy_coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format_coords</span>(geometry)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='display: block; text-align: center;'&gt;&lt;strong&gt;{place}&lt;/strong&gt;"</span>,</span>
<span id="cb34-10">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;{fancy_coords}&lt;/span&gt;"</span>))</span>
<span id="cb34-11"></span>
<span id="cb34-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">leaflet</span>(tolkien_home_plot) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setView</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lng =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(tolkien_home_plot)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb34-14">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(tolkien_home_plot)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb34-15">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zoom =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb34-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addTiles</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb34-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addCircleMarkers</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(label),</span>
<span id="cb34-18">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labelOptions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labelOptions</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noHide =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb34-19">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, </span>
<span id="cb34-20">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">textOnly =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-ff3c3b473e9309dcc84b" style="width:100%;height:355.995055624227px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-ff3c3b473e9309dcc84b">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"setView":[[51.7710036051427,-1.26014188743044],14,[]],"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircleMarkers","args":[51.7710036051427,-1.26014188743044,10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,"<span style='display: block; text-align: center;'><strong>Tolkien's home<\/strong><br>51.771004°N -1.260142°W<\/span>",{"interactive":false,"permanent":true,"direction":"top","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.7710036051427,51.7710036051427],"lng":[-1.26014188743044,-1.26014188743044]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We can put Hobbiton in Tolkien’s home and then see the relative distances to the rest of Middle Earth from Oxford.</p>
<p>We’ll use the Natural Earth data that we loaded at the beginning of this post. We could theoretically filter it to only look at European countries, since it includes a column for continent, but doing so causes all sorts of issues:</p>
<ul>
<li>Russia is huuuuge</li>
<li>French Guiana is officially part of France, so the map includes a part of South America</li>
<li>Other countries like Denmark, Norway, and the UK have similar overseas province-like territories, so the map gets even more expanded</li>
</ul>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">europe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> world_map <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(continent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Europe"</span>)</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> europe)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/europe-only-not-great-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Ugly map of all European countries"></p>
<figcaption class="figure-caption margin-caption">Ugly map of all European countries</figcaption>
</figure>
</div>
</div>
</div>
<p>We could do some fancy filtering and <a href="https://github.com/nvkelso/natural-earth-vector/issues/196">use more detailed data that splits places like France into separate subdivisions</a> (i.e.&nbsp;one row for continental Europe France, one row for French Guiana, etc.), but that’s a lot of work. So instead, we’ll use <code>coord_sf()</code> to define a window so we can zoom in on just a chunk of Europe. Before, we added some arbitrary number of miles around the coordinates for Hobbiton. This time we’ll <a href="https://www.openstreetmap.org/export#map=4/54.47/12.79">use a helpful tool from OpenStreetMap</a> that lets you draw a bounding box on a world map to get coordinates to work with:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/img/osm-export.png" class="img-fluid figure-img" style="width:100.0%" alt="OpenStreetMap's site for exporting bounding box coordinates"></p>
<figcaption class="figure-caption margin-caption">OpenStreetMap’s site for exporting bounding box coordinates</figcaption>
</figure>
</div>
</div>
</div>
<p>We can then create a <a href="https://felixanalytix.medium.com/how-to-map-any-region-of-the-world-using-r-programming-bb3c4146f97f">little matrix of coordinates</a>. We’re ultimately going to use the <a href="https://epsg.io/5633">PTRA08 / LAEA Europe projection</a>, which is centered in Portugal and is a good Europe-centric projection, so we’ll convert the list of coordinates to that projection.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">europe_window <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_sfc</span>(</span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">29.31</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># left (west), bottom (south)</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.74</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">64.62</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># right (east), top (north)</span></span>
<span id="cb36-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:4326"</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># WGS 84</span></span>
<span id="cb36-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb36-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LAEA Europe, centered in Portugal</span></span>
<span id="cb36-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>()</span>
<span id="cb36-8">europe_window</span>
<span id="cb36-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##            X       Y</span></span>
<span id="cb36-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] 2135398 1019399</span></span>
<span id="cb36-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [2,] 5912220 5020959</span></span></code></pre></div>
</details>
</div>
<p>Now we can plot the full world map data and use <code>coord_sf()</code> to limit it to just this window:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> world_map) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>),</span>
<span id="cb37-4">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> europe_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>],</span>
<span id="cb37-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> europe_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>],</span>
<span id="cb37-6">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/try-europe-window-1.png" class="img-fluid figure-img" style="width:60.0%" alt="World map cropped to just show part of Europe"></p>
<figcaption class="figure-caption margin-caption">World map cropped to just show part of Europe</figcaption>
</figure>
</div>
</div>
</div>
<p>Neat. Now that we know how to zoom in on Europe, we can go through the same process we did with the US—we’ll convert the Middle Earth shapefiles to the European projection, center Hobbiton on Tolkien’s home in Oxford, double all the distances, and shift everything around.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the Tolkien home coordinates to European coordinates</span></span>
<span id="cb38-2">tolkien_home <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tolkien_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>))</span>
<span id="cb38-4"></span>
<span id="cb38-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the Hobbiton coordinates to European coordinates</span></span>
<span id="cb38-6">hobbiton_in_europe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hobbiton <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>))</span>
<span id="cb38-8"></span>
<span id="cb38-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the offset between Tolkien's home and Hobbiton</span></span>
<span id="cb38-10">me_to_europe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>(tolkien_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_coordinates</span>(hobbiton_in_europe)</span>
<span id="cb38-11"></span>
<span id="cb38-12">me_places_in_europe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the Middle Earth data match the Europe projection</span></span>
<span id="cb38-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just look at a handful of places</span></span>
<span id="cb38-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Double the distances</span></span>
<span id="cb38-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_europe)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_europe)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shift everything around so that Hobbiton is in Oxford</span></span>
<span id="cb38-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> me_to_europe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All the geometry math made us lose the projection metadata; set it again</span></span>
<span id="cb38-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>))</span>
<span id="cb38-23"></span>
<span id="cb38-24">coastline_in_europe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> coastline <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_europe)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton_in_europe)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> me_to_europe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb38-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> world_map, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#39CCCC"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> coastline_in_europe, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> me_places_in_europe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_europe, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Edoras"</span>)),</span>
<span id="cb39-6">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(me_places_in_europe, NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Minas Tirith"</span>)),</span>
<span id="cb39-8">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> NAME), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPSG:5633"</span>),</span>
<span id="cb39-10">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> europe_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>],</span>
<span id="cb39-11">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> europe_window[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>],</span>
<span id="cb39-12">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/fancy-europe-me-places-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Middle Earth locations and borders placed in Europe"></p>
<figcaption class="figure-caption margin-caption">Middle Earth locations and borders placed in Europe</figcaption>
</figure>
</div>
</div>
</div>
<p>With Hobbiton in Oxford, Rivendell is in north central Germany (near Hanover?), with Rohan in Switzerland and Gondor on the border of Croatia and Bosnia.</p>
</section>
</section>
<section id="things-i-want-to-do-someday-but-am-not-smart-enough-to-do" class="level1 page-columns page-full">
<h1>Things I want to do someday but am not smart enough to do</h1>
<p>And there’s our quick tour of {sf} and Middle Earth! It’s incredible how much GIS-related stuff you can do with R, and the plots are all beautiful thanks to the magic of ggplot!</p>
<section id="paths" class="level2">
<h2 class="anchored" data-anchor-id="paths">Paths</h2>
<p>It would be really cool to be able to plot the pathways different characters took in each of the books (Bilbo and Thorin’s company; Frodo and Sam; Aragorn, Legolas, and Gimli, etc.). This data exists! <a href="http://lotrproject.com/map/#zoom=3&amp;lat=-1315.5&amp;lon=1500&amp;layers=BTTTTT">The LOTR Project has detailed maps</a> with the pathways of all of the main characters’ journeys. However, it’s not (as far as I can tell) open source or Creative Commons-licensed, and I don’t think the coordinates are directly comparable to the shapefiles from the ME-GIS project. Alas.</p>
</section>
<section id="first-and-second-ages" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="first-and-second-ages">First and Second Ages</h2>
<p>In addition to <em>The Lord of the Rings</em> and <em>The Hobbit</em>, Tolkien wrote a ton about other ages in Middle Earth (see this <a href="https://www.andrewheiss.com/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/#super-quick-crash-course-in-the-ages-of-arda-n%C3%BAmenor">super quick crash course in the Ages of Arda from my post on Númenorean ages</a>). A separate mapping project—<a href="https://github.com/kwoxer/Arda-Maps">Arda-Maps</a>—has shapefiles for all three ages of Tolkien’s world, including Valinor, Beleriand, and Númenor.</p>
<p>However, the maps aren’t as detailed as the ME-GIS project, and they’re on a completely different scale. For example, here’s the island of Númenor (featured in Amazon’s <em>The Rings of Power</em>). I downloaded the shapefiles from their <a href="https://github.com/kwoxer/Arda-Maps">GitHub repository</a>—the Second Age shapefiles are buried in <code>QGIS/second age/arda2</code></p>
<p>Here I use <code>st_bbox()</code> to create a bounding box of coordinates that I then use to crop the underlying data. This is different from what we did with Europe, where we plotted the whole world map and then zoomed in on just a chunk of western Europe. Here, <code>st_crop()</code> cuts out the geographic data that doesn’t fall within the box (similar to filtering).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">numenor_box <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.007</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.017</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>))</span>
<span id="cb40-2"></span>
<span id="cb40-3">numenor_outlines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/poly_outline.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Numenor"</span>)</span>
<span id="cb40-5"></span>
<span id="cb40-6">numenor_rivers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/line_river.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_box)</span>
<span id="cb40-8"></span>
<span id="cb40-9">numenor_cities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/point_city.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb40-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_box)</span>
<span id="cb40-11"></span>
<span id="cb40-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_outlines, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F2CB9B"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_rivers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_cities) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use geom_label_repel with the geometry column!</span></span>
<span id="cb40-17">  ggrepel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb40-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_cities, </span>
<span id="cb40-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> eventname, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb40-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb40-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb40-23">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb40-24">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_north_arrow</span>(</span>
<span id="cb40-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pad_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb40-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">north_arrow_fancy_orienteering</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>), </span>
<span id="cb40-28">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>,</span>
<span id="cb40-29">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Númenor"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb40-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_yellow),</span>
<span id="cb40-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aniron"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb40-34">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/numenor-map-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Fancy map of Númenor"></p>
<figcaption class="figure-caption margin-caption">Fancy map of Númenor</figcaption>
</figure>
</div>
</div>
</div>
<p>The map looks fantastic! But notice the scale bar in the top left corner—in this data, Númenor is only a couple thousand feet wide—less than half a mile. The distances are all way wrong. I could probably scale it up by comparing the projection distances in the Arda Maps’ version of regular Middle Earth with the ME-GIS project’s version of regular Middle Earth and then do some fancy math, <del>but that goes beyond my skills</del>.</p>
</section>
</section>
<section id="update-second-age-maps-scaled-to-real-world-distances" class="level1 page-columns page-full">
<h1>Update! Second Age maps scaled to Real World distances!</h1>
<p>Just kidding! Scaling stuff up doesn’t go beyond my skills. We’ll do it.</p>
<p>We already converted the data from ME-GIS into Real World miles by doubling all the coordinates centered on Hobbiton, which became the de facto center of the world. We’ll do it again here since all those calculations happened way earlier in this post:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the shapefile</span></span>
<span id="cb41-2">placenames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/ME-GIS/Combined_Placenames.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb41-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.character), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iconv</span>(., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ISO-8859-1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)))</span>
<span id="cb41-4"></span>
<span id="cb41-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull out Hobbiton</span></span>
<span id="cb41-6">hobbiton <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>)</span>
<span id="cb41-7"></span>
<span id="cb41-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Double all the distances</span></span>
<span id="cb41-9">places_ta_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> placenames <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Take the existing coordinates, subtract the doubled Hobbiton coordinates,</span></span>
<span id="cb41-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and add the Hobbiton coordinates</span></span>
<span id="cb41-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(hobbiton)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames))</span>
<span id="cb41-14"></span>
<span id="cb41-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Confirm that it's 458 miles between Hobbiton and Rivendell</span></span>
<span id="cb41-16">hobbiton_ta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places_ta_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hobbiton"</span>)</span>
<span id="cb41-17">rivendell_ta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places_ta_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>)</span>
<span id="cb41-18"></span>
<span id="cb41-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use set_units() just for fun since st_distance returns the units as metadata</span></span>
<span id="cb41-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(hobbiton_ta, rivendell_ta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"miles"</span>)</span>
<span id="cb41-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Units: [miles]</span></span>
<span id="cb41-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      [,1]</span></span>
<span id="cb41-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]  458</span></span></code></pre></div>
</details>
</div>
<p>The Second Age data doesn’t have Hobbiton in it since Hobbits didn’t exist yet (you can see the <a href="https://lotr.fandom.com/wiki/Harfoots">Harfoots</a>, Amazon’s version of proto-Hobbits, in <em>The Rings of Power</em>), but it does have Bree, which is a village near the Shire.</p>
<p>So first, we’ll find the distance between Bree and Rivendell:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">bree_ta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> places_ta_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(NAME <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bree"</span>)</span>
<span id="cb42-2">bree_to_rivendell_ta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(bree_ta, rivendell_ta)</span>
<span id="cb42-3">bree_to_rivendell_ta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"miles"</span>)</span>
<span id="cb42-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Units: [miles]</span></span>
<span id="cb42-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      [,1]</span></span>
<span id="cb42-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]  360</span></span></code></pre></div>
</details>
</div>
<p>360 miles. Lovely.</p>
<p>Next, let’s see how far apart Bree and Rivendell are in the Arda-Maps Second Age map. We’ll reload the data and convert the projection to use the same CRS as the ME-GIS map so that things are comparable.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">sa_cities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/point_city.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb43-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames))</span>
<span id="cb43-3"></span>
<span id="cb43-4">rivendell_sa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sa_cities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>)</span>
<span id="cb43-5">bree_sa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sa_cities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bree"</span>)</span>
<span id="cb43-6"></span>
<span id="cb43-7">bree_to_rivendell_sa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(bree_sa, rivendell_sa)</span>
<span id="cb43-8">bree_to_rivendell_sa <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"miles"</span>)</span>
<span id="cb43-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Units: [miles]</span></span>
<span id="cb43-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       [,1]</span></span>
<span id="cb43-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,] 0.166</span></span></code></pre></div>
</details>
</div>
<p>Hahaha, in this tiny map, it’s only a sixth of a mile between Bree and Rivendell. Assuming there are 2,000 steps in a mile, that’s only 333 steps, which is just a little more than what Fitbits and Apple Watches try to make you do over the course of an hour.</p>
<p>We need to turn this sixth of a mile into 360 miles, which involves dividing by… something. I always forget how to rescale things, so I find it helpful to write out the algebra for it:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A0.1666x%20&amp;=%20360%20%5C%5C%0Ax%20&amp;=%20%5Cfrac%7B360%7D%7B0.1666%7D%20%5C%5C%0Ax%20&amp;=%202160%5Ctext%7Bish%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>If we multiply everything in the Second Age map data by 2160ish, we should be good. First we’ll get the official, more precise number (since we’re missing decimals in the quick algebra above):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">sa_to_ta_conversion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(bree_to_rivendell_ta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> bree_to_rivendell_sa)</span>
<span id="cb44-2">sa_to_ta_conversion</span>
<span id="cb44-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 2174</span></span></code></pre></div>
</details>
</div>
<p>Next we’ll scale up the Second Age map data, using Bree as the central reference point:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">sa_cities_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sa_cities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(bree_sa)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sa_to_ta_conversion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(bree_sa)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames))</span></code></pre></div>
</details>
</div>
<p>Finally let’s make sure it worked. We’re looking for 360 miles:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">rivendell_sa_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sa_cities_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rivendell"</span>)</span>
<span id="cb46-2">bree_sa_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sa_cities_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bree"</span>)</span>
<span id="cb46-3"></span>
<span id="cb46-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_distance</span>(bree_sa_scaled, rivendell_sa_scaled) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"miles"</span>)</span>
<span id="cb46-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Units: [miles]</span></span>
<span id="cb46-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##      [,1]</span></span>
<span id="cb46-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1,]  360</span></span></code></pre></div>
</details>
</div>
<p>It worked!</p>
<p>Now we can plot this thing. Since we’re working with a different projection, the bounding box (<code>numenor_box</code>) that we previously made for cropping the shapefiles won’t work. But we can be even more precise by extracting the bounding box from the Númenor outlines and then using <em>that</em> as the cropping box.</p>
<p>Also, we’ll add some more layers to the map for fun, but because this rescaling business can get repetitive and tedious, we’ll make a little function to cut down on repetition.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">numenor_outlines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/poly_outline.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Numenor"</span>)</span>
<span id="cb47-4"></span>
<span id="cb47-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the bounds for Númenor so we can crop everything else with it</span></span>
<span id="cb47-6">numenor_bbox <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_bbox</span>(numenor_outlines)</span>
<span id="cb47-7"></span>
<span id="cb47-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Little helper function to scale things from the Second Age to the real world</span></span>
<span id="cb47-9">scale_sa_to_real_world <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb47-10">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_geometry</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(.) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(bree_sa)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(sa_to_ta_conversion) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_geometry</span>(bree_sa)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_set_crs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames))</span>
<span id="cb47-13">}</span>
<span id="cb47-14"></span>
<span id="cb47-15">numenor_outlines_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> numenor_outlines <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span>
<span id="cb47-17"></span>
<span id="cb47-18">numenor_rivers_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/line_river.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_bbox) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span>
<span id="cb47-22"></span>
<span id="cb47-23">numenor_cities_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/point_city.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_bbox) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span>
<span id="cb47-27"></span>
<span id="cb47-28">numenor_forests_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/poly_forest.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_bbox) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span>
<span id="cb47-32"></span>
<span id="cb47-33">numenor_highlands_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/poly_highland.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_bbox) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span>
<span id="cb47-37"></span>
<span id="cb47-38">numenor_regions_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/Arda-Maps/QGIS/second age/arda2/poly_region.shp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_transform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(placenames)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crop</span>(numenor_bbox) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb47-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_sa_to_real_world</span>()</span></code></pre></div>
</details>
</div>
<p>Mapping time!</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Background of the island</span></span>
<span id="cb48-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_outlines_scaled, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F2CB9B"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_forests_scaled, </span>
<span id="cb48-5">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> clr_green, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_highlands_scaled, </span>
<span id="cb48-7">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> colorspace<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">darken</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F2CB9B"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_rivers_scaled, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clr_blue) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Region borders</span></span>
<span id="cb48-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_regions_scaled, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"33"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Island borders to cover up the dotted region lines on the coast</span></span>
<span id="cb48-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_outlines_scaled, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(numenor_regions_scaled, eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mittalmar"</span>), </span>
<span id="cb48-14">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> eventname),</span>
<span id="cb48-15">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Heavy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(numenor_regions_scaled, eventname <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mittalmar"</span>), </span>
<span id="cb48-17">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> eventname),</span>
<span id="cb48-18">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass Heavy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>,</span>
<span id="cb48-19">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">miles_to_meters</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_cities_scaled) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-21">  ggrepel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label_repel</span>(</span>
<span id="cb48-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> numenor_cities_scaled, </span>
<span id="cb48-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> eventname, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geometry =</span> geometry),</span>
<span id="cb48-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf_coordinates"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>,</span>
<span id="cb48-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass ExtraBold"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_scale</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>),</span>
<span id="cb48-27">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>,</span>
<span id="cb48-28">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit_category =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imperial"</span>,</span>
<span id="cb48-29">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width_hint =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_north_arrow</span>(</span>
<span id="cb48-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tl"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pad_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb48-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">north_arrow_fancy_orienteering</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>), </span>
<span id="cb48-33">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey30"</span>,</span>
<span id="cb48-34">                                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overpass"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Númenor"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb48-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#bacdf7"</span>),</span>
<span id="cb48-38">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aniron"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rel</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb48-39">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/numenor-map-correct-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Correctly scaled fancy map of Númenor"></p>
<figcaption class="figure-caption margin-caption">Correctly scaled fancy map of Númenor</figcaption>
</figure>
</div>
</div>
</div>
<p>We can compare it with Karen Wynn Fonstad’s map of Númenor from page 43 in <a href="https://www.amazon.com/Atlas-Middle-Earth-Revised-Karen-Fonstad/dp/0618126996"><em>Atlas of Middle-earth</em></a> and the scaling all seems correct—the island is about 600 miles wide in both the book and in the data.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/img/numenor-fonstad.png" class="img-fluid figure-img" style="width:100.0%" alt="Karen Wynn Fonstad's map of Númenor"></p>
<figcaption class="figure-caption margin-caption">Karen Wynn Fonstad’s map of Númenor</figcaption>
</figure>
</div>
</div>
</div>
<p>Success!</p>


<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {Making {Middle} {Earth} Maps with {R}},
  date = {2023-04-26},
  url = {https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis},
  doi = {10.59350/ccrtd-z3s22},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“Making Middle Earth Maps with R.”</span>
April 26, 2023. <a href="https://doi.org/10.59350/ccrtd-z3s22">https://doi.org/10.59350/ccrtd-z3s22</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>gis</category>
  <category>maps</category>
  <category>nerdery</category>
  <guid>https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index.html</guid>
  <pubDate>Tue, 25 Apr 2023 21:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/04/26/middle-earth-mapping-sf-r-gis/index_files/figure-html/shire-zoomed-in-fancy-1.png" medium="image" type="image/png" height="100" width="144"/>
</item>
<item>
  <title>How old was Aragorn in regular human years?</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index.html</link>
  <description><![CDATA[ 




<p>In <em>The Two Towers</em>, while talking with <a href="https://en.wikipedia.org/wiki/%C3%89owyn">Eowyn</a>, <a href="https://en.wikipedia.org/wiki/Aragorn">Aragorn</a> casually mentions that he’s actually 87 years old.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/img/aragorn-87-50.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Aragorn announcing his age</figcaption>
</figure>
</div>
<p>When Aragorn is off running for miles and miles and fighting orcs and trolls and Uruk-hai and doing all his other <em>Lord of the Rings</em> adventures, he hardly behaves like a regular human 87-year-old. How old is he really?</p>
<p>It turns out that Tolkien left us a clue in some of his unfinished writings about Númenor, and we can use that information to make some educated guesses about Aragon’s actual human-scale age. In this post I’ll (1) look at Tolkien’s Númenórean years → human years conversion system and (2) extrapolate that system through two types of statistical simulation—(a) just drawing random numbers and (b) Bayesian modeling—to make some predictions about a range of possible ages.</p>
<p>But first, some context about why Aragon is so old!</p>
<section id="super-quick-crash-course-in-the-ages-of-arda-númenor" class="level2">
<h2 class="anchored" data-anchor-id="super-quick-crash-course-in-the-ages-of-arda-númenor">Super quick crash course in the Ages of Arda + Númenor</h2>
<p><em>The Lord of the Rings</em> occurs at the end of the Third Age of the world. In <a href="https://en.wikipedia.org/wiki/Cosmology_of_Tolkien%27s_legendarium#Arda">Arda</a> (the whole world Tolkien created) there are four recorded ages, plus some pre-game stuff:</p>
<ul>
<li><p><strong>Creation</strong>: The main god <a href="https://en.wikipedia.org/wiki/Cosmology_of_Tolkien%27s_legendarium#Eru_Il%C3%BAvatar">Eru Ilúvatar</a> and a couple dozen sub-gods (<a href="https://en.wikipedia.org/wiki/Ainur_in_Middle-earth">Ainur</a>) and bunch of angel-like-sub-sub-gods (<a href="https://en.wikipedia.org/wiki/Maiar_in_Middle-earth">Maiar</a>, including <a href="https://en.wikipedia.org/wiki/Gandalf">Gandalf</a>, <a href="https://en.wikipedia.org/wiki/Saruman">Saruman</a>, and <a href="https://en.wikipedia.org/wiki/Sauron">Sauron</a>) created the world through music. This is all covered in the first part of <a href="https://en.wikipedia.org/wiki/The_Silmarillion"><em>The Silmarillion</em></a> in a sub-book called <a href="https://en.wikipedia.org/wiki/Ainulindal%C3%AB"><em>The Ainulindalë</em></a>.</p></li>
<li><p><strong>The First Age</strong>: After the creation, the Elves all lived in a place outside of the main world called <a href="https://en.wikipedia.org/wiki/Valinor">Valinor</a> until the main bad guy, a fallen Ainu named <a href="https://en.wikipedia.org/wiki/Morgoth">Morgoth</a> (aka Melkor) destroyed key parts of it and divided the Elves so that a bunch fled to the far west of Middle-earth to a land called <a href="https://en.wikipedia.org/wiki/Beleriand">Beleriand</a>. This starts the First Age, which is mostly about the Elves of Beleriand and their battles with Morgoth/Melkor. Sauron (the main bad guy of <em>The Lord of the Rings</em>) serves as Morgoth’s lieutenant and they destroy a ton of cities (with armies of balrogs and orcs) and kill a ton of elves. The elves eventually win, but all of Beleriand sinks into the ocean and the elves either go back to Valinor (technically just outside of Valinor, which serves as elvish heaven), or to eastern Middle-earth. This is all covered in the bulk of <em>The Silmarillion</em>.</p></li>
<li><p><strong>The Second Age</strong>: While the First Age is mostly about elves, mortal men eventually show up in Beleriand and they play a key role in the battle against Morgoth. They also intermingle with the immortal elves, sometimes falling in love—including the famous <a href="https://en.wikipedia.org/wiki/L%C3%BAthien_and_Beren">Lúthien and Beren</a> (who are <a href="https://en.wikipedia.org/wiki/L%C3%BAthien_and_Beren#The_Tolkien_grave">stand-ins for Tolkien and his wife Edith</a>). Beren and Lúthien had kids, and their kids had kids, and so on until two half-elf brothers were born at the end of the First Age: <a href="https://en.wikipedia.org/wiki/Elrond">Elrond</a> (the same Elrond from <em>The Hobbit</em> and <em>The Lord of the Rings</em> and <em>The Rings of Power</em>) and <a href="https://lotr.fandom.com/wiki/Elros">Elros</a>.</p>
<p>As Beleriand sinks, Elrond and Elros escape to eastern Middle-earth and are then given a choice of how to proceed with their futures. Elrond decides to become immortal like an elf; Elros decides to become mortal like a man, eventually building <a href="https://en.wikipedia.org/wiki/Rivendell">Rivendell</a>. The gods reward Elros and the men who helped the elves against Morgoth by creating a utopic island in the middle of the ocean between Valinor and Middle-earth named <a href="https://en.wikipedia.org/wiki/N%C3%BAmenor">Númenor</a>. The gods also granted them super long life (400+ years, as we’ll explore below), but imposed a strict ban on them—the Númenóreans were forbidden from ever sailing west toward Valinor. Thus begins the two parallel stories of the Second Age—(1) Elrond and other refugees from Valinor doing stuff in Middle-earth, and (2) Elros and his descendants doing stuff on the island of Númenor. This is all covered in a final short part of <em>The Silmarillion</em> (the <a href="https://en.wikipedia.org/wiki/The_Silmarillion#Akallab%C3%AAth"><em>Akallabêth</em></a>), and in random appendices in <em>The Lord of the Rings</em>, and in the newer <a href="https://en.wikipedia.org/wiki/The_Fall_of_N%C3%BAmenor"><em>The Fall of Númenor</em></a>, and in Amazon’s TV series <a href="https://en.wikipedia.org/wiki/The_Lord_of_the_Rings:_The_Rings_of_Power"><em>The Rings of Power</em></a>.</p>
<p>Númenor and Middle-earth hum along happily for three thousand years until Sauron (who fled to Middle-earth after Morgoth was destroyed) shows up. He disguises himself as a super affable friendly dude who everyone loves and then sows chaos. He visits the elves and convinces them to make a bunch of rings, and then he heads to Númenor to convince them to violate the ban and sail to Valinor. The Númenóreans do, they get in trouble, the gods sink their island, and Númenórean refugees flee to Middle-earth, led by <a href="https://en.wikipedia.org/wiki/Elendil">Elendil</a> and his sons <a href="https://en.wikipedia.org/wiki/Isildur">Isildur</a> and <a href="https://lotr.fandom.com/wiki/An%C3%A1rion">Anárion</a>, who set up a Númenórean kingdom in <a href="https://en.wikipedia.org/wiki/Gondor">Gondor</a>. Sauron starts using his fancy new One Ring and tries to conquer Middle-earth; there’s a big war against him (see the first few minutes of <em>The Fellowship of the Ring</em>); Sauron kills Elendil; Isildur cuts off Sauron’s finger and makes him lose the ring, which destroys him; Isildur keeps the ring; he gets killed and the kingdom of Gondor falls, thus ending the Second Age.</p></li>
<li><p><strong>The Third Age</strong>: The ring disappears for a few thousand years until Gollum picks it up, then Bilbo gets it in <em>The Hobbit</em>, and then Frodo gets it in <em>The Fellowship of the Ring</em> and destroys it in <em>The Return of the King</em>.</p>
<p>Meanwhile, Gondor is ruled by a series of stewards who are supposed to take care of the kingdom until a Númenórean king returns to take his place. The magic long life of the Númenóreans starts declining, except for some special refugees from Gondor named the Dúnedain (singular Dúnadan), of which Aragorn is one. These Dúnedain maintain some of the magic Númenórean longevity—they don’t live 400+ years like their Númenórean ancestors, but they live well beyond 150. After the ring is destroyed, Aragorn is installed as king of Gondor, all the remaining elves go back to Valinor (except Arwen, Aragorn’s now-wife), and the Third Age ends.</p></li>
<li><p><strong>The Fourth Age</strong>: Aragorn reigns until he’s 210, then he dies, someone else takes over, and Middle-earth lives happily ever after.</p></li>
</ul>
</section>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>Before diving into the data and simulations, we need to load some R libraries and make some helper functions. For the sake of narrative here, the code is automatically collapsed—click on the little triangle arrow to show it.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggtext)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggimage)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Diavlo Medium"</span>))</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Diavlo Medium"</span>))</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Diavlo: https://www.exljbris.com/diavlo.html</span></span>
<span id="cb1-15">theme_numenor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Diavlo Medium"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),</span>
<span id="cb1-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),</span>
<span id="cb1-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>))</span>
<span id="cb1-25">}</span>
<span id="cb1-26"></span>
<span id="cb1-27">clrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0E2B50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#415B6B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0B4C7D"</span>, </span>
<span id="cb1-28">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#EE9359"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8C6D46"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#BF3B0B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#400101"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="tolkiens-númenórean-years-normal-human-years-system" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="tolkiens-númenórean-years-normal-human-years-system">Tolkien’s Númenórean years → normal human years system</h2>
<p>In the appendix of the newly published <em>The Fall of Númenor and Other Tales From the Second Age of Middle-earth</em> is a fascinating footnote that explains exactly how to convert Second Age Númenórean years into normal human years. Tolkien writes:</p>
<blockquote class="blockquote">
<ol type="1">
<li>Deduct 20: Since at 20 years a Númenórean would be at about the same stage of development as an ordinary person.<br>
</li>
<li>Add to this 20 the remainder divided by 5. Thus a Númenórean man or woman of years [X] would be approximately of the “age” [Y] <span class="citation" data-cites="Tolkien:2022">(Tolkien 2022, “The Life of the Númenóreans,” note 8, p.&nbsp;262)</span></li>
</ol>
</blockquote>
<p>And he provides this helpful table, which we’ll stick in an R data frame so we can play with it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">ages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numenor_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">125</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">175</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">225</span>, </span>
<span id="cb2-3">                  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">275</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">325</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">350</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">375</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">425</span>),</span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">46</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">51</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">61</span>, </span>
<span id="cb2-5">                       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">71</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">76</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">81</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">86</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">91</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)</span>
<span id="cb2-6">)</span></code></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">ages <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Númenórean age"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> numenor_age,</span>
<span id="cb3-3">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal human age"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> normal_human_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>()</span></code></pre></div>
</details>
<div class="cell-output-display column-page-inset-right">
<div id="tbl-ages-orig" class="anchored">
<table class="table table-sm table-striped small">
<caption>Table&nbsp;1: Tolkien’s original table for converting between Númenórean and human ages</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: left;">Númenórean age</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">125</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">200</td>
<td style="text-align: right;">225</td>
<td style="text-align: right;">250</td>
<td style="text-align: right;">275</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">325</td>
<td style="text-align: right;">350</td>
<td style="text-align: right;">375</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">425</td>
</tr>
<tr class="even">
<td style="text-align: left;">Normal human age</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">86</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">96</td>
<td style="text-align: right;">101</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Tolkien’s logic is a little convoluted, but it works. For example, if a Númenórean is 125, subtract 20, then divide the remainder by 5 and add that to 20 to get 41 normal human years:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft(%5Cfrac%7B125-20%7D%7B5%7D%20+%2020%5Cright)%20=%20(21%20+%2020)%20=%2041%0A"></p>
<p>If we plot all of Tolkien’s example ages, we get a nice linear relationship between Númenórean ages and human ages:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(ages, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> numenor_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normal_human_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Númenórean years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-numenor-normal-basic" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-numenor-normal-basic-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;1: Scatterplot of Tolkien’s original table for converting between Númenórean and human ages</figcaption>
</figure>
</div>
</div>
</div>
<p>Since it’s linear, we can skip the convoluted subtract-20-add-divided-remainder logic and instead figure out a slope and intercept for the line.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">age_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(normal_human_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> numenor_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ages)</span>
<span id="cb5-2">age_model</span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb5-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Call:</span></span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## lm(formula = normal_human_age ~ numenor_age, data = ages)</span></span>
<span id="cb5-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb5-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Coefficients:</span></span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (Intercept)  numenor_age  </span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##        16.0          0.2</span></span></code></pre></div>
</details>
</div>
<p>The line starts at the y-axis at 16 normal human years and then increases by 0.2 for every Númenórean year (the 0.2 is that divide-by-5 rule, since 1/5 = 0.2).</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BNormal%20human%20years%7D%20=%2016%20+%20(0.2%20%5Ctimes%20%5Ctext%7BN%C3%BAmen%C3%B3rean%20years%7D)%0A"></p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(ages, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> numenor_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normal_human_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Númenórean years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, </span>
<span id="cb6-6">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal human years =&lt;br&gt;16 + (0.2 × Númenórean years)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>()</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-numenor-normal-annotated" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-numenor-normal-annotated-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;2: Linear model for converting between Númenórean and human ages</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="estimating-the-dúnedain-normal-human-age-system" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="estimating-the-dúnedain-normal-human-age-system">Estimating the Dúnedain → normal human age system</h2>
<p>Aragorn was a Dúnedan, or a descendant of the Númenórean refugees Elendil and Isildur, so he inherited their unnaturally long lifespan. Aragorn was 87 at the end of the Third Age, and he lived until he was 210. If we naively assume he lived as long as a standard Númenórean, he would have gone through the events of <em>The Lord of the Rings</em> at 33 and died surprisingly young at 58:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(ages, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> numenor_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normal_human_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>, </span>
<span id="cb7-6">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">58</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">58</span>, </span>
<span id="cb7-8">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_image</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numenor_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, </span>
<span id="cb7-10">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"img/aragorn-alive.jpg"</span>),</span>
<span id="cb7-11">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> image), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.618</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">62</span>, </span>
<span id="cb7-13">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[1]};'&gt;87 Númenórean years&lt;/span&gt;"</span>,</span>
<span id="cb7-14">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;"</span>,</span>
<span id="cb7-15">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[6]};'&gt;33 human years&lt;/span&gt;"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_image</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numenor_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, </span>
<span id="cb7-17">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"img/aragorn-dead.jpg"</span>),</span>
<span id="cb7-18">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> image), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.618</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">98</span>, </span>
<span id="cb7-20">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[1]};'&gt;210 Númenórean years&lt;/span&gt;"</span>,</span>
<span id="cb7-21">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;"</span>,</span>
<span id="cb7-22">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[6]};'&gt;58 human years&lt;/span&gt;"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Númenórean years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb7-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb7-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]),</span>
<span id="cb7-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-aragorn-numenor-wrong" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-aragorn-numenor-wrong-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;3: A naive estimate of Aragorn’s human ages, assuming he’s a full Númenórean</figcaption>
</figure>
</div>
</div>
</div>
<p>But the refugee Númenóreans (the Dúnedain) gradually lost their long-living powers after Númenor was destroyed, so this Númenórean formula doesn’t really apply to Aragorn.</p>
<p>According to <a href="https://lotr.fandom.com/wiki/D%C3%BAnedain#Waning">supplemental Tolkien writings</a>, the 7th steward of Gondor was the last person to live to 150 years, and by the time of the events of <em>The Lord of the Rings</em>, nobody in Gondor had lived past 100 years since Belecthor II, the 21st steward of Gondor. Denethor II—the <a href="https://www.youtube.com/watch?v=huvRffhxJXs">tomato-massacring</a> father of Boromir and Faramir—was the 26th steward and took the position 112 years after Belecthor II died. So it had been a long time since anyone had lived that long. With the exception of Aragorn and the other Dúnedan Rangers of the North, all the magic Númenórean power had waned.</p>
<p>After the Ring was destroyed, something seems to have changed, though. Faramir—likely distantly related to the Dúnedain—<a href="https://lotr.fandom.com/wiki/Faramir">lived until 120</a>, so <em>something</em> new was in the air at the beginning of the post-Sauron Fourth Age. Aragorn—an actual Dúnedan and descendant of Númenor—made it to 210, but he maybe had some special elf help from Arwen.</p>
<p>So given that some of the old Númenórean power seems to have returned (and given that Aragorn was unnaturally long-lived), we can try to figure out the Dúnedan → regular human age conversion three different ways.</p>
<section id="arbitrary-maximum-age" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="arbitrary-maximum-age">Arbitrary maximum age</h3>
<p>Since the Númenórean → regular human age line is perfectly linear, we’ll assume that the Dúnedan → regular human age line is also perfectly linear, just scaled down. We’ll start the line at 16 again, but now we’ll pretend that 210 years in Fourth Age Dúnedan years is 100 in human years (Aragorn lived a stunningly long time).</p>
<p>To figure out the equation for the new Dúnedan line, we need to figure out the slope. We have two points (<img src="https://latex.codecogs.com/png.latex?(0,%2016)"> and <img src="https://latex.codecogs.com/png.latex?(210,%20100)">) that we can use to calculate the slope:</p>
<p>By hand:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BSlope%7D%20&amp;=%20%5Cfrac%7By_2%20-%20y_1%7D%7Bx_2%20-%20x_1%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7B100%20-%2016%7D%7B210%20-%200%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7B84%7D%7B210%7D%20%5C%5C%0A&amp;=%200.4%0A%5Cend%7Baligned%7D%0A"></p>
<p>Or with R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">find_slope <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(point1, point2) {</span>
<span id="cb8-2">  (point2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> point1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (point2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> point1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb8-3">}</span>
<span id="cb8-4"></span>
<span id="cb8-5">slope <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">find_slope</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb8-6">slope</span>
<span id="cb8-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 0.4</span></span></code></pre></div>
</div>
<p>That gives us this equation:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BNormal%20human%20years%7D%20=%2016%20+%20(0.4%20%5Ctimes%20%5Ctext%7BD%C3%BAnedan%20years%7D)%0A"></p>
<p>To make it easier to plot things and plug numbers into the formula, we’ll generate a dataset with a range of possible Dúnedan and regular human ages:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">ages_dunedain <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> slope <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dunedain_age)</span></code></pre></div>
</div>
<p>Using this equation, we can figure out Aragorn’s normal human age during <em>The Lord of the Rings</em> and when he died:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">age_model_dunedain <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(normal_human_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dunedain_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ages_dunedain)</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">augment</span>(age_model_dunedain, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> .fitted)</span>
<span id="cb10-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 2</span></span>
<span id="cb10-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dunedain_age normal_human_age</span></span>
<span id="cb10-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb10-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1           87             50.8</span></span>
<span id="cb10-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2          210            100</span></span></code></pre></div>
</div>
<p>When Aragorn tells Eowyn that he’s 87, that’s actually the equivalent of 51ish. This fits with Tolkien’s writings, since in <em>The Fellowship of the Ring</em>, Aragorn was nearing the prime of life <span class="citation" data-cites="Tolkien:2012">(Tolkien 2012, bk. 1, ch.&nbsp;10, “Strider”)</span>.</p>
<p>Here’s what that looks like across the whole hypothetical Dúnedan lifespan:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(ages_dunedain, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> dunedain_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normal_human_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.8</span>, </span>
<span id="cb11-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"segment"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb11-7">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_image</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, </span>
<span id="cb11-9">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"img/aragorn-alive.jpg"</span>),</span>
<span id="cb11-10">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> image), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.618</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span>, </span>
<span id="cb11-12">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[3]};'&gt;87 Dúnedan years&lt;/span&gt;"</span>,</span>
<span id="cb11-13">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;"</span>,</span>
<span id="cb11-14">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[6]};'&gt;50.8 human years&lt;/span&gt;"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_image</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, </span>
<span id="cb11-16">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"img/aragorn-dead.jpg"</span>),</span>
<span id="cb11-17">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">image =</span> image), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.618</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"richtext"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">86</span>, </span>
<span id="cb11-19">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[3]};'&gt;210 Dúnedan years&lt;/span&gt;"</span>,</span>
<span id="cb11-20">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;br&gt;"</span>,</span>
<span id="cb11-21">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:{clrs[6]};'&gt;100 human years&lt;/span&gt;"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Dúnedan years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">110</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb11-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb11-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]),</span>
<span id="cb11-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-aragorn-numenor-static" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-aragorn-numenor-static-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;4: A better estimate of Aragorn’s human ages, scaling down the full Númenórean range of ages to a more plausible range of Dúnedan ages</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="simulating-a-bunch-of-slopes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="simulating-a-bunch-of-slopes">Simulating a bunch of slopes</h3>
<p>Deciding that 210 Dúnedan years was 100 human years was a pretty arbitrary choice. Maybe Aragorn lived to be the equivalent of 90? Or 80? Or 120 like Faramir?</p>
<p>Instead of choosing one single endpoint, we can simulate the uncertainty around the final age at death. We’ll say that 210 years in Fourth Age-era Dúnedan years is the equivalent of somewhere between 80 and 120 regular human years.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/generate-lots-of-slopes_1c07b67559f4cdb2c791ace6396dda88">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate a bunch of maximum human ages, centered around 100, ± 20ish</span></span>
<span id="cb12-2">lots_of_slopes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_human_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the slope of each of these new lines</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(max_human_age, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">find_slope</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, .x)))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate data for each of the new lines</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ages =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(slope, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb12-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb12-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normal_human_age =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dunedain_age)</span>
<span id="cb12-9">  })) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(ages)</span></code></pre></div>
</details>
</div>
<p>Each of these simulated lines is a plausible age conversion formula.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">lots_of_slopes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> dunedain_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normal_human_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> id), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smooth"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Dúnedan years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb13-9">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb13-10">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]),</span>
<span id="cb13-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-lots-of-slopes-lines" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-lots-of-slopes-lines-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;5: Plausible Dúnedan-to-human age conversion equations</figcaption>
</figure>
</div>
</div>
</div>
<p>At lower values of Dúnedan ages, there’s a lot less of a range of uncertainty, but as Dúnedan age increases, so too does the range of possible human ages. We can look at the distribution of the predicted normal human ages at both 87 and 210 to get a sense for these ranges:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">lots_of_slopes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dunedain_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dunedain_age} Dúnedan years"</span>),</span>
<span id="cb14-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(dunedain_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> normal_human_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> dunedain_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal human age"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(dunedain_age), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-lots-of-slopes-dists" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-lots-of-slopes-dists-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;6: Distribution of predicted human ages at 87 and 210 Dúnedan years</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="bayesian-simulation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="bayesian-simulation">Bayesian simulation</h3>
<p>As a final approach for guessing at Aragorn’s age, we’ll use a Bayesian model to generate a posterior distribution of plausible conversion lines and predicted ages. Technically this isn’t a true posterior—there’s no actual data or anything, so we’ll sample just from the prior distributions that we feed the model. But it’s still a helpful exercise in simulation.</p>
<p>We’ll define this statistical model:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7BNormal%20human%20age%7D%20&amp;%5Csim%20%5Cmathcal%7BN%7D(%5Cmu,%20%5Csigma)%20%5C%5C%0A%5Cmu%20&amp;=%20%5Cbeta_0%20+%20%5Cbeta_1%5C%20%5Ctext%7BD%C3%BAnedan%20age%7D%20%5C%5C%5B10pt%5D%0A%5Cbeta_0%20&amp;=%2016%20%5C%5C%0A%5Cbeta_1%20&amp;%5Csim%20%5Cmathcal%7BN%7D(0.4,%200.05)%20%5C%5C%0A%5Csigma%20&amp;%5Csim%20%5Coperatorname%7BExponential%7D(1)%0A%5Cend%7Baligned%7D%0A"></p>
<p>We fix the intercept at 16 as before, and we say that the slope is around 0.4 ± 0.1ish. We’ll use <a href="https://mc-stan.org/">Stan</a> (through <a href="https://paul-buerkner.github.io/brms/">brms</a>) to fit a model based on just these priors:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-bayes-dunedan-human-age_448d204fe666d481d7b645ea9996fb26">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stan likes to work with mean-centered variables, so we'll center dunedain_age</span></span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># here, so that 0 represents 115</span></span>
<span id="cb15-3">ages_dunedain_centered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ages_dunedain <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(dunedain_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span>
<span id="cb15-5"></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set some priors</span></span>
<span id="cb15-7">priors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">constant</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> Intercept),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constant 16 for the intercept</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coef =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunedain_age"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Slope of 0.4 ± 0.1</span></span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exponential</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> sigma)</span>
<span id="cb15-11">)</span>
<span id="cb15-12"></span>
<span id="cb15-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run some MCMC chains just with the priors, since we don't have any actual data</span></span>
<span id="cb15-14">age_model_bayes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb15-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(normal_human_age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dunedain_age),</span>
<span id="cb15-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ages_dunedain_centered,</span>
<span id="cb15-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> priors,</span>
<span id="cb15-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample_prior =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"only"</span>,</span>
<span id="cb15-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cmdstanr"</span>,</span>
<span id="cb15-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb15-21">)</span>
<span id="cb15-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Start sampling</span></span>
<span id="cb15-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Running MCMC with 4 parallel chains...</span></span>
<span id="cb15-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb15-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 1 finished in 0.0 seconds.</span></span>
<span id="cb15-26"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 2 finished in 0.0 seconds.</span></span>
<span id="cb15-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 3 finished in 0.0 seconds.</span></span>
<span id="cb15-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Chain 4 finished in 0.0 seconds.</span></span>
<span id="cb15-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb15-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## All 4 chains finished successfully.</span></span>
<span id="cb15-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mean chain execution time: 0.0 seconds.</span></span>
<span id="cb15-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total execution time: 0.2 seconds.</span></span>
<span id="cb15-33">age_model_bayes</span>
<span id="cb15-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  Family: gaussian </span></span>
<span id="cb15-35"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Links: mu = identity; sigma = identity </span></span>
<span id="cb15-36"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Formula: normal_human_age ~ dunedain_age </span></span>
<span id="cb15-37"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##    Data: ages_dunedain_centered (Number of observations: 191) </span></span>
<span id="cb15-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb15-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb15-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb15-41"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb15-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb15-43"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Intercept       16.00      0.00    16.00    16.00   NA       NA       NA</span></span>
<span id="cb15-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## dunedain_age     0.40      0.05     0.30     0.50 1.00     2258     2191</span></span>
<span id="cb15-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb15-46"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Family Specific Parameters: </span></span>
<span id="cb15-47"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb15-48"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## sigma     0.99      0.98     0.02     3.51 1.00     1985     1394</span></span>
<span id="cb15-49"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## </span></span>
<span id="cb15-50"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span id="cb15-51"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb15-52"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</details>
</div>
<p>The results from the model aren’t too surprising, given (1) we’ve seen similar results with the other methods, and (2) the 16 intercept and 0.4 slope match the priors, wince we’re only dealing with priors.</p>
<p>Now that we have a “posterior” (again, it’s not a true posterior since there’s no actual data), we can play with it in a few different ways. First we can look at the whole range of Dúnedan ages and see lots of plausible slopes. As expected, most are around 0.4, resulting in a final age of 100, but some lines are steeper and some are shallower. Since these are posterior distributions, we can find credible intervals too (which we can interpret much more naturally than convoluted confidence intervals):</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">draws_prior <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_epred_draws</span>(age_model_bayes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb16-3"></span>
<span id="cb16-4">draws_prior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> dunedain_age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .epred)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> .draw), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in Dúnedan years"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age in normal human years"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb16-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb16-12">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]),</span>
<span id="cb16-13">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]))</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-bayes-range" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-bayes-range-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;7: Spaghetti plot of plausible posterior Dúnedan → human conversions</figcaption>
</figure>
</div>
</div>
</div>
<p>We can also look at the posterior distribution of predicted human ages at just 87 and 210, along with credible intervals. There’s a 95% chance that at 87, he’s actually between 42 and 59 (with an average of 51ish), and at 210 he’s actually between 79ish and 121.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">draws_aragorn_ages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_epred_draws</span>(age_model_bayes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb17-3"></span>
<span id="cb17-4">draws_aragorn_ages <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(dunedain_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median_hdci</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb17-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## # A tibble: 2 × 7</span></span>
<span id="cb17-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   dunedain_age .epred .lower .upper .width .point .interval</span></span>
<span id="cb17-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span id="cb17-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1           87   50.7   41.9   59.2   0.95 median hdci     </span></span>
<span id="cb17-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2          210   99.8   78.4  120.    0.95 median hdci</span></span></code></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">draws_aragorn_ages <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{dunedain_age} Dúnedan years"</span>),</span>
<span id="cb18-3">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dunedain_age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(dunedain_age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .epred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dunedain_age))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_halfeye</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], clrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal human age"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(dunedain_age), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_numenor</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div id="fig-bayes-dist" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index_files/figure-html/fig-bayes-dist-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;8: Posterior distribution of predicted human ages at 87 and 210 Dúnedan years</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Given all the evidence we have about Númenórean ages, and after making some reasonable assumptions about Dúnedan and human lifespans, when Aragorn tells Eowyn that that he’s 87, that’s really the equivalent of 50ish, with a 95% chance that he’s somewhere between 42 and 59.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/img/aragorn-final-50.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Aragorn announcing his actual age</figcaption>
</figure>
</div>
</section>
<section id="references" class="level2">



<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Tolkien:2012" class="csl-entry">
Tolkien, J. R. R. 2012. <em>The Fellowship of the Ring: Being the First Part of the Lord of the Rings</em>. The Lord of the Rings, pt.&nbsp;1. Boston: William Morrow &amp; Company.
</div>
<div id="ref-Tolkien:2022" class="csl-entry">
———. 2022. <em>The Fall of Númenor and Other Tales from the Second Age of Middle-Earth</em>. Edited by Brian Sibley. 1st ed. New York, NY: William Morrow.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {How Old Was {Aragorn} in Regular Human Years?},
  date = {2023-03-21},
  url = {https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation},
  doi = {10.59350/e0855-b1171},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“How Old Was Aragorn in Regular Human
Years?”</span> March 21, 2023. <a href="https://doi.org/10.59350/e0855-b1171">https://doi.org/10.59350/e0855-b1171</a>.
</div></div></section></div> ]]></description>
  <category>r</category>
  <category>tidyverse</category>
  <category>ggplot</category>
  <category>simulations</category>
  <category>brms</category>
  <category>nerdery</category>
  <guid>https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/index.html</guid>
  <pubDate>Mon, 20 Mar 2023 22:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/03/21/aragorn-dunedan-numenorean-simulation/img/aragorn-final-50.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>One Simple Trick™ to create inline bibliography entries with Markdown and pandoc</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/01/09/syllabus-csl-pandoc/index.html</link>
  <description><![CDATA[ 




<p>Pandoc-flavored Markdown makes it really easy to <a href="https://pandoc.org/MANUAL.html#citations">cite and reference things</a>. You can write something like this (assuming you use <a href="references.bib">this <code>references.bib</code> BibTeX file</a>):</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb1-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Some title"</span></span>
<span id="cb1-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">According to @Lovelace:1842, computers can calculate things. This was important </span>
<span id="cb1-7">during World War II <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Turing:1936</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>.</span></code></pre></div>
<p>And it’ll convert to this after running the document through pandoc:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rendered document
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="fs-2"><strong>Some title</strong></span></p>
<p>According to Lovelace (1842), computers can calculate things. This was important during World War II (Turing 1936).</p>
<p><span class="fs-4"><strong>References</strong></span></p>
<div class="references csl-bib-body hanging-indent">
<div class="csl-entry">
Lovelace, Augusta Ada. 1842. “Sketch of the Analytical Engine Invented by Charles Babbage, by LF Menabrea, Officer of the Military Engineers, with Notes Upon the Memoir by the Translator.” <em>Taylor’s Scientific Memoirs</em> 3: 666–731.
</div>
<div class="csl-entry">
Turing, Alan Mathison. 1936. “On Computable Numbers, with an Application to the Entscheidungsproblem.” <em>Journal of Math</em> 58 (345-363): 230–65.
</div>
</div>
</div>
</div>
<p>This is all great and ideal when working with documents that have a single bibliography at the end.</p>
<section id="the-limits-of-default-in-text-citations" class="level2">
<h2 class="anchored" data-anchor-id="the-limits-of-default-in-text-citations">The limits of default in-text citations</h2>
<p>Some documents—like course syllabuses and readings lists—don’t have a final bibliography. Instead they have lists of things people should read. However, if you try to insert citations like normal, you’ll get the inline references and a final bibliography:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb2-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Some course syllabus"</span></span>
<span id="cb2-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Course schedule</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 1</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Lovelace:1842</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-11"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Turing:1936</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 2</span></span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Keynes:1937</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rendered document
</div>
</div>
<div class="callout-body-container callout-body">
<p class="fs-2">
<strong>Some course syllabus</strong>
</p>
<p class="fs-4">
<strong>Course schedule</strong>
</p>
<p class="fs-6">
<strong>Week 1</strong>
</p>
<ul>
<li>(Lovelace 1842)</li>
<li>(Turing 1936)</li>
</ul>
<p class="fs-6">
<strong>Week 2</strong>
</p>
<ul>
<li>(Keynes 1937)</li>
</ul>
<p><span class="fs-4"><strong>References</strong></span></p>
<div class="references csl-bib-body hanging-indent">
<div class="csl-entry">
Keynes, John Maynard. 1937. “The General Theory of Employment.” <em>The Quarterly Journal of Economics</em> 51 (2): 209–23.
</div>
<div class="csl-entry">
Lovelace, Augusta Ada. 1842. “Sketch of the Analytical Engine Invented by Charles Babbage, by LF Menabrea, Officer of the Military Engineers, with Notes Upon the Memoir by the Translator.” <em>Taylor’s Scientific Memoirs</em> 3: 666–731.
</div>
<div class="csl-entry">
Turing, Alan Mathison. 1936. “On Computable Numbers, with an Application to the Entscheidungsproblem.” <em>Journal of Math</em> 58 (345-363): 230–65.
</div>
</div>
</div>
</div>
<p>The full citations are all in the document, but not in a very convenient location. Readers have to go to the back of the document to see what they actually need to read (especially if there’s a website or DOI URL they need to click on).</p>
</section>
<section id="making-note-based-styles-appear-in-the-text" class="level2">
<h2 class="anchored" data-anchor-id="making-note-based-styles-appear-in-the-text">Making note-based styles appear in the text</h2>
<p>It would be great if the full citation could be included in the lists <em>in</em> the document instead of at the end of the document.</p>
<p>And it’s possible, with just a minor tweak to the Citation Style Language (CSL) style file that you’re using (thanks to <a href="https://stackoverflow.com/a/63582716/120898">adam.smith at StackOverflow for pointing out how</a>).</p>
<p>By default pandoc uses Chicago author-date for bibiliographic references—hence the <code>(Lovelace 1842)</code> style of references. You can download any other CSL file from <a href="https://www.zotero.org/styles">Zotero’s searchable style repository</a>, from <a href="https://editor.citationstyles.org/searchByName/">the Citation Styles project’s searchable list</a>, or clone the full massive <a href="https://github.com/citation-style-language/styles">GitHub repository of styles</a> to find others, like Chicago notes, APA, MLA, and so on.</p>
<p>The easiest way to get full citations inline is to find a CSL that uses note-based citations, like <a href="https://editor.citationstyles.org/styleInfo/?styleId=http%3A%2F%2Fwww.zotero.org%2Fstyles%2Fchicago-fullnote-bibliography">the Chicago full note style</a> and edit the CSL file to tell it to be an inline style instead of a note style.</p>
<p>The second line of all CSL files contains a <code>&lt;style&gt;</code> XML element with a <code>class</code> attribute. Inline styles like APA and Chicago author date have <code>class="in-text"</code>:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb3-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">style</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> xmlns=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://purl.org/net/xbiblio/csl"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in-text"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> demote-non-dropping-particle=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display-and-sort"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> page-range-format=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chicago"</span>&gt;</span>
<span id="cb3-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">info</span>&gt;</span>
<span id="cb3-4">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;Chicago Manual of Style 17th edition (author-date)&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;</span>
<span id="cb3-5">    ...</span></code></pre></div>
<p>…while note-based styles like Chicago notes have <code>class="note"</code>:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb4-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">style</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> xmlns=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://purl.org/net/xbiblio/csl"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> demote-non-dropping-particle=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display-and-sort"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> page-range-format=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chicago"</span>&gt;</span>
<span id="cb4-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">info</span>&gt;</span>
<span id="cb4-4">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;Chicago Manual of Style 17th edition (full note)&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;</span>
<span id="cb4-5">    ...</span></code></pre></div>
<p>If you download a note-based CSL style and manually change it to be <code>in-text</code>, the footnotes that it inserts will get inserted in the text itself instead of as foonotes.</p>
<p>Here I downloaded <a href="https://editor.citationstyles.org/styleInfo/?styleId=http%3A%2F%2Fwww.zotero.org%2Fstyles%2Fchicago-fullnote-bibliography">Chicago full note</a>, edited the second line to say <code>class="in-text"</code>, and saved it as <code>chicago-syllabus.csl</code>:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">&lt;?xml</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> encoding=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">?&gt;</span></span>
<span id="cb5-2">&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">style</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> xmlns=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://purl.org/net/xbiblio/csl"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in-text"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> version=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> demote-non-dropping-particle=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display-and-sort"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> page-range-format=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chicago"</span>&gt;</span>
<span id="cb5-3">  &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">info</span>&gt;</span>
<span id="cb5-4">    &lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;Chicago Manual of Style 17th edition (full note, but in-text)&lt;/<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">title</span>&gt;</span>
<span id="cb5-5">    ...</span></code></pre></div>
<p>I can then tell pandoc to use that CSL when rendering the document:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb6-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Some course syllabus"</span></span>
<span id="cb6-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb6-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">csl:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> chicago-syllabus.csl</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Course schedule</span></span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 1</span></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Lovelace:1842</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-12"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Turing:1936</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-13"></span>
<span id="cb6-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 2</span></span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Keynes:1937</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>…and the full references are included in the document itself!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rendered document
</div>
</div>
<div class="callout-body-container callout-body">
<p class="fs-2">
<strong>Some course syllabus</strong>
</p>
<p class="fs-4">
<strong>Course schedule</strong>
</p>
<p class="fs-6">
<strong>Week 1</strong>
</p>
<ul>
<li>Augusta Ada Lovelace, “Sketch of the Analytical Engine Invented by Charles Babbage, by LF Menabrea, Officer of the Military Engineers, with Notes Upon the Memoir by the Translator,” <em>Taylor’s Scientific Memoirs</em> 3 (1842): 666–731.</li>
<li>Alan Mathison Turing, “On Computable Numbers, with an Application to the Entscheidungsproblem,” <em>Journal of Math</em> 58, no. 345-363 (1936): 230–65.</li>
</ul>
<p class="fs-6">
<strong>Week 2</strong>
</p>
<ul>
<li>John Maynard Keynes, “The General Theory of Employment,” <em>The Quarterly Journal of Economics</em> 51, no. 2 (1937): 209–23.</li>
</ul>
<p><span class="fs-4"><strong>References</strong></span></p>
<div class="references csl-bib-body hanging-indent">
<div class="csl-entry">
Keynes, John Maynard. “The General Theory of Employment.” <em>The Quarterly Journal of Economics</em> 51, no. 2 (1937): 209–23.
</div>
<div class="csl-entry">
Lovelace, Augusta Ada. “Sketch of the Analytical Engine Invented by Charles Babbage, by LF Menabrea, Officer of the Military Engineers, with Notes Upon the Memoir by the Translator.” <em>Taylor’s Scientific Memoirs</em> 3 (1842): 666–731.
</div>
<div class="csl-entry">
Turing, Alan Mathison. “On Computable Numbers, with an Application to the Entscheidungsproblem.” <em>Journal of Math</em> 58, no. 345-363 (1936): 230–65.
</div>
</div>
</div>
</div>
</section>
<section id="a-few-minor-tweaks-to-perfect-the-output" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="a-few-minor-tweaks-to-perfect-the-output">A few minor tweaks to perfect the output</h2>
<p>This isn’t quite perfect, though. There are three glaring problems with this:</p>
<ol type="1">
<li><p>We have a bibliography at the end, since Chicago notes-bibliography requires it. This makes sense for regular documents where you have footnotes throughout the body of the text with a list of references at the end, but it’s not necessary here.</p></li>
<li><p>The in-text references all have hyperlinks to their corresponding references in the final bibliography. We don’t need those since the linked text <em>is</em> the bibliography.</p></li>
<li><p>If you render this in Quarto, you get helpful popups that contain the full reference when you hover over the link. But again, the link <em>is</em> the full reference, so that extra hover information is redundant.</p></li>
</ol>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/09/syllabus-csl-pandoc/citation-hover.png" class="border rounded img-fluid figure-img" style="width:70.0%" alt="Citation reference hovering popup"></p>
<figcaption class="figure-caption margin-caption">Citation reference hovering popup</figcaption>
</figure>
</div>
<p>All these problems are easy to fix with some additional YAML settings that suppress the final bibliography, turn off citation links, and disable Quarto’s hovering:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb7-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Some course syllabus"</span></span>
<span id="cb7-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb7-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">csl:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> chicago-syllabus.csl</span></span>
<span id="cb7-5"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">suppress-bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> true</span></span>
<span id="cb7-6"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">link-citations:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> false</span></span>
<span id="cb7-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">citations-hover:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> false</span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Course schedule</span></span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 1</span></span>
<span id="cb7-13"></span>
<span id="cb7-14"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Lovelace:1842</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-15"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Turing:1936</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 2</span></span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Keynes:1937</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>Perfect!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Perfect final rendered document
</div>
</div>
<div class="callout-body-container callout-body">
<p class="fs-2">
<strong>Some course syllabus</strong>
</p>
<p class="fs-4">
<strong>Course schedule</strong>
</p>
<p class="fs-6">
<strong>Week 1</strong>
</p>
<ul>
<li>Augusta Ada Lovelace, “Sketch of the Analytical Engine Invented by Charles Babbage, by LF Menabrea, Officer of the Military Engineers, with Notes Upon the Memoir by the Translator,” <em>Taylor’s Scientific Memoirs</em> 3 (1842): 666–731.</li>
<li>Alan Mathison Turing, “On Computable Numbers, with an Application to the Entscheidungsproblem,” <em>Journal of Math</em> 58, no. 345-363 (1936): 230–65.</li>
</ul>
<p class="fs-6">
<strong>Week 2</strong>
</p>
<ul>
<li>John Maynard Keynes, “The General Theory of Employment,” <em>The Quarterly Journal of Economics</em> 51, no. 2 (1937): 209–23.</li>
</ul>
</div>
</div>
</section>
<section id="using-other-styles" class="level2">
<h2 class="anchored" data-anchor-id="using-other-styles">Using other styles</h2>
<p>This is all great and super easy if you (like me) are fond of Chicago. What if you want to use APA, though? Or MLA? Or any other style that doesn’t use footnotes?</p>
<p>For APA, you’re in luck! There’s an <a href="https://www.zotero.org/styles?q=id%3Aapa-cv">APA (curriculum vitae) CSL style</a> that you can use, and you don’t need to edit it beforehand—it just works:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb8-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Some course syllabus with APA"</span></span>
<span id="cb8-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb8-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">csl:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> apa-cv.csl</span></span>
<span id="cb8-5"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">suppress-bibliography:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> true</span></span>
<span id="cb8-6"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">link-citations:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> false</span></span>
<span id="cb8-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">citations-hover:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> false</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Course schedule</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 1</span></span>
<span id="cb8-13"></span>
<span id="cb8-14"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Lovelace:1842</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-15"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Turing:1936</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-16"></span>
<span id="cb8-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Week 2</span></span>
<span id="cb8-18"></span>
<span id="cb8-19"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">@Keynes:1937</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Final rendered document using APA CV
</div>
</div>
<div class="callout-body-container callout-body">
<p class="fs-2">
<strong>Some course syllabus with APA</strong>
</p>
<p class="fs-4">
<strong>Course schedule</strong>
</p>
<p class="fs-6">
<strong>Week 1</strong>
</p>
<ul>
<li>Lovelace, A. A. (1842). Sketch of the analytical engine invented by Charles Babbage, by LF Menabrea, officer of the military engineers, with notes upon the memoir by the translator. <em>Taylor’s Scientific Memoirs</em>, 3, 666–731.</li>
<li>Turing, A. M. (1936). On computable numbers, with an application to the Entscheidungsproblem. <em>Journal of Math</em>, 58(345-363), 230–265.</li>
</ul>
<p class="fs-6">
<strong>Week 2</strong>
</p>
<ul>
<li>Keynes, J. M. (1937). The general theory of employment. <em>The Quarterly Journal of Economics</em>, 51(2), 209–223.</li>
</ul>
</div>
</div>
<p>For any other style though, you’re (somewhat) out of luck. The simple trick of switching <code>class="note"</code> to <code>class="in-text"</code> doesn’t work if the underlying style is already in-text like APA or Chicago author-date. You’d have to do some major editing and rearranging in the CSL file to force the bibliography entries to show up as inline citations, which goes beyond my skills.</p>
<p>As a workaround you can use <a href="https://cran.r-project.org/web/packages/RefManageR/index.html">the {RefManageR} package</a> in R to read the bibliography file with R and output the bibliography part of the citations as Markdown. Steve Miller <a href="http://svmiller.com/blog/2022/01/print-references-reading-list-syllabus-r-markdown-stevemisc/">has a helpful guide for this here</a>.</p>


<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {One {Simple} {Trick}\textsuperscript{{TM}} to Create Inline
    Bibliography Entries with {Markdown} and Pandoc},
  date = {2023-01-09},
  url = {https://knuutila.net/blog/2023/01/09/syllabus-csl-pandoc},
  doi = {10.59350/hwwgk-v9636},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“One Simple Trick<sup>TM</sup> to Create
Inline Bibliography Entries with Markdown and Pandoc.”</span> January 9,
2023. <a href="https://doi.org/10.59350/hwwgk-v9636">https://doi.org/10.59350/hwwgk-v9636</a>.
</div></div></section></div> ]]></description>
  <category>writing</category>
  <category>markdown</category>
  <category>citations</category>
  <category>pandoc</category>
  <category>zotero</category>
  <guid>https://knuutila.net/blog/2023/01/09/syllabus-csl-pandoc/index.html</guid>
  <pubDate>Sun, 08 Jan 2023 22:00:00 GMT</pubDate>
</item>
<item>
  <title>How to migrate from BibDesk to Zotero for pandoc-based writing</title>
  <dc:creator>Andrew Heiss</dc:creator>
  <link>https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/index.html</link>
  <description><![CDATA[ 




<section id="my-longstanding-workflow-for-writing-citing-and-pdf-management" class="level2">
<h2 class="anchored" data-anchor-id="my-longstanding-workflow-for-writing-citing-and-pdf-management">My longstanding workflow for writing, citing, and PDF management</h2>
<p>When I started my first master’s degree program in 2008, I decided to stop using Word for all my academic writing and instead use plain text Markdown for everything. <a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> itself had been a thing for 4 years, and <a href="https://fletcherpenney.net/multimarkdown/">MultiMarkdown</a>—a <a href="https://en.wikipedia.org/wiki/Pandoc">pandoc</a>-like extension of Markdown that could handle BibTeX bibliographies—was brand new. I did all my writing for my courses and my thesis in Markdown and converted it all to PDF through LaTeX using MultiMarkdown. I didn’t know about pandoc yet, so I only ever converted to PDF, not HTML or Word.</p>
<p>I stored all my bibliographic references in a tiny little <code>references.bib</code> BibTeX file that I managed with <a href="https://bibdesk.sourceforge.io/">BibDesk</a>. BibDesk is a wonderful and powerful program with an active developer community and it does all sorts of neat stuff like auto-filing PDFs, importing references from DOIs, searching for references on the internet from inside the program, and just providing a nice overall front end for dealing with BibTeX files.</p>
<p>I kept using my MultiMarkdown + LaTeX output system throughout my second master’s degree, and my <code>references.bib</code> file and PDF database slowly grew. R Markdown hadn’t been invented yet and I still hadn’t discovered pandoc, so living in a mostly LaTeX-based world was fine.</p>
<p>When I started my PhD in 2012, something revolutionary happened: <a href="https://yihui.org/knitr/">the {knitr} package</a> was invented. The new <a href="https://rmarkdown.rstudio.com/">R Markdown</a> format let you to mix R code with Markdown text and create multiple outputs (HTML, LaTeX, and docx) through pandoc. I abandoned MultiMarkdown and fully converted to pandoc (thanks also in part to Kieran Healy’s <a href="https://plain-text.co/"><em>Plain Person’s Gide to Plain Text Social Science</em></a>). Since 2012, I’ve written exclusively in pandoc-flavored Markdown and always make sure that I can convert everything to PDF, HTML, and Word (see the “Manuscript” entry <a href="https://stats.andrewheiss.com/cautioning-canary/">in the navigation bar here</a>, for instance, where you can download the preprint version of that paper in a ton of different formats). I recently converted <a href="https://github.com/andrewheiss/hikmah-academic-quarto">a bunch of my output templates</a> to <a href="https://quarto.org/">Quarto pandoc</a> too.</p>
<p>During all this time, I didn’t really keep up with other reference managers. I used super early <a href="https://www.zotero.org/">Zotero</a> as an undergrad back in 2006–2008, but it didn’t fit well with my Markdown-based workflow, so I kind of ignored it. I picked it up again briefly at the beginning of my PhD, but I couldn’t get it to play nicely with R Markdown and pandoc, so I kept using trusty old BibDesk. My <code>references.bib</code> file got bigger and bigger as I took more and more doctoral classes and did more research, but BibDesk handled the growing library just fine. As of today, I’ve got 1,400 items in there with nearly 1,000 PDFs, and everything still works great—mostly.</p>
</section>
<section id="why-switch-away-from-bibtex-and-bibdesk" class="level2">
<h2 class="anchored" data-anchor-id="why-switch-away-from-bibtex-and-bibdesk">Why switch away from BibTeX and BibDesk?</h2>
<p>BibDesk got me through my dissertation and all my research projects up until now, so why consider switching away to some other system? Over the past few years, as I’ve done more reading on my iPad and worked on more coauthored projects, I’ve run into a few pain points in my citation workflow.</p>
<section id="problem-1-cross-device-reading" class="level3">
<h3 class="anchored" data-anchor-id="problem-1-cross-device-reading">Problem 1: Cross-device reading</h3>
<p>I enjoy reading PDFs on my iPad (particularly in the <a href="https://www.folia.com/iannotate">iAnnotate app</a>), but getting PDFs from BibDesk onto the iPad has always required a bizarre dance:</p>
<ol type="1">
<li>Store <code>references.bib</code> and the BibDesk-managed folder of PDFs in Dropbox</li>
<li>Use the <a href="https://sites.google.com/site/appsformaths/references">References</a> iPad app to open the BibTeX file from Dropbox on the iPad</li>
<li>Use iAnnotate to navigate Dropbox and find the PDF I want to read</li>
<li>Read and annotate the PDF in iAnnotate</li>
<li>Send the finished PDF from iAnnotate back to Dropbox and go back to References to ensure that the annotated PDF updates</li>
</ol>
<p>I’d often get sick of this convoluted process and just find the PDF on my computer and AirDrop it to my iPad directly, completely circumventing Dropbox. I’d then AirDrop it back to my computer and attach the marked up PDF to the reference in BibDesk. It’s inconvenient, but less inconvenient than bouncing around a bunch of different apps and hoping everything works.</p>
</section>
<section id="problem-2-collaboration-across-many-projects-with-many-coauthors" class="level3">
<h3 class="anchored" data-anchor-id="problem-2-collaboration-across-many-projects-with-many-coauthors">Problem 2: Collaboration across many projects with many coauthors</h3>
<p>Collaboration with a single huge <code>references.bib</code> file is impossible. I could share my Dropbox folder with coauthors, but then they’d see all my entries and have access to all my annotated PDFs, which seems like overkill. As I started working with coauthors, I decided to make smaller project-specific <code>.bib</code> files that would be shareable and editable.</p>
<p>This is great for project modularity—see how <a href="https://github.com/andrewheiss/cautioning-canary/blob/master/manuscript/bibliography.bib">this <code>bibliography.bib</code> file</a> only contains things we cited? But it caused <em>major</em> synchronization problems. If me or a coauthor makes any edits to the project-specific files (adding a DOI to an existing entry, adding a new entry, etc.), those changes don’t show up in my big master <code>references.bib</code> file. I have to remember to copy those changes to the main file, and I never remember. With some recent projects, I’ve actually been copying some entries from previous projects’ <code>.bib</code> files rather than from the big <code>references.bib</code> file. Everything’s diverging and it’s a pain.</p>
</section>
<section id="problem-3-bibtex-was-designed-for-latexbut-just-latex" class="level3">
<h3 class="anchored" data-anchor-id="problem-3-bibtex-was-designed-for-latexbut-just-latex">Problem 3: BibTeX was designed for LaTeX—but just LaTeX</h3>
<p>BibTeX works great with LaTeX. That’s why it was invented in the first place! The fact that things like pandoc work with it is partially a historical accident—<code>.bib</code> files were a convenient and widely used plain text bibliography format, so pandoc and MultiMarkdown used BibTeX for citations.</p>
<p>But citations are often more complicated than BibTeX can handle. Consider the LaTeX package <a href="https://ctan.org/pkg/biblatex-chicago?lang=en">biblatex-chicago</a>—in order to be fully compliant with all the intricacies of the Chicago Manual of Style, it has to expand the BibTeX (technically BibLaTeX) format to include fields like <code>entrysubtype</code> for distinguishing between magazine/newspaper articles and journal articles, among dozens of other customizations and tweaks. BibTeX has a limited set of entry types, and anything that’s not one of those types gets shoehorned into the <code>misc</code> type.</p>
<p>Internally, programs like pandoc that can read BibTeX files convert them into a standard <a href="https://en.wikipedia.org/wiki/Citation_Style_Language">Citation Style Language (CSL)</a> format, which it then uses to format references as Chicago, APA, MLA, or whatever. It would be great to store all my citations in a CSL-compliant format in the first place rather than as a LaTeX-only format that has to be constantly converted on-the-fly when converting to any non-LaTeX output.</p>
</section>
<section id="the-solution-zotero" class="level3">
<h3 class="anchored" data-anchor-id="the-solution-zotero">The solution: Zotero</h3>
<p>Zotero conveniently fixes all these issues:</p>
<ol type="1">
<li><p>It has <a href="https://www.zotero.org/support/sync">a synchronization service</a> that works across platforms (including iOS). <a href="https://ikashnitsky.github.io/2019/zotero/">It can work with Dropbox too</a> if you don’t want to be bound by their file size limit or pay for extra storage, though I ended up paying for storage to (1) support open source software and (2) not have to deal with multiple programs. I’ve been doing the BibDesk → iAnnotate → Dropbox → MacBook → AirDrop dance for too many years—I just want Zotero to handle all the syncing for me.</p></li>
<li><p>It’s <strong>super easy</strong> to collaborate with Zotero. You can create shared group libraries with different sets of coauthors and not worry about Dropbox synchronization issues or accidental deletion of <code>}</code> characters in the <code>.bib</code> file. For one of my reading-intensive class, <a href="https://compasp23.classes.andrewheiss.com/class/">I’ve even created a shared Zotero group library</a> that all the students can join and cite from, which is neat.</p>
<p>It’s also far easier to maintain a master list of references. You can create a <a href="https://www.zotero.org/support/collections_and_tags">Zotero collection</a> for specific projects, and items can live in multiple collections. Editing an item in one collection updates that item in all other collections. Zotero treats collections like iTunes/Apple Music playlists—just like songs can belong to multiple playlists, bibliographic entries can belong to multiple collections.</p></li>
<li><p>Zotero follows the CSL standard that pandoc uses. It was the first program to adopt CSL (way back in 2006!). It supports all kinds of entry types and fields, beyond what BibTeX supports.</p></li>
</ol>
</section>
</section>
<section id="preparing-for-the-migration" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="preparing-for-the-migration">Preparing for the migration</h2>
<p>Migrating my big <code>.references.bib</code> file to Zotero was a relatively straightforward process, but it required a few minor shenanigans to get everything working right.</p>
<section id="make-a-backup" class="level3">
<h3 class="anchored" data-anchor-id="make-a-backup">Make a backup</h3>
<p>Preparing everything for migration meant I had to make a ton of edits to the original <code>references.bib</code> file, so I made a copy of it first and worked with the copy.</p>
</section>
<section id="install-extensions" class="level3">
<h3 class="anchored" data-anchor-id="install-extensions">Install extensions</h3>
<p>To make Zotero work nicely with a pandoc-centric writing workflow, and to make file management and tag management easier, I installed these three extensions:</p>
<ul>
<li><a href="https://retorque.re/zotero-better-bibtex/">Better BibTeX</a></li>
<li><a href="http://zotfile.com/">ZotFile</a></li>
<li><a href="https://github.com/windingwind/zotero-tag">Zotero Tag</a></li>
</ul>
</section>
<section id="ratings-and-read-status" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ratings-and-read-status">Ratings and read status</h3>
<p>BibDesk allows you to add a couple extra metadata fields to entries for ratings and to mark them as read. I’ve used these fields for years and find them super useful for keeping track of how much I like articles and for remembering which ones I’ve actually finished.</p>
<p>Internally, BibDesk stores this data as entries in the raw BibTex:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bibtex code-with-copy"><code class="sourceCode bibtex"><span id="cb1-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@article</span>{<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">the_citekey_for_this_entry</span>,</span>
<span id="cb1-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">author</span> = {Whoever},</span>
<span id="cb1-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span> = {Whatever},</span>
<span id="cb1-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb1-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rating</span> = {4},</span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">read</span> = {1}}</span></code></pre></div>
<p>These fields are preserved and transferred to Zotero when you import the file, but they show up in the “Extra” field and aren’t easily filterable or sortable there:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/extra-fields.png" class="border rounded img-fluid figure-img" style="width:60.0%" alt="Extra fields from a BibTeX file"></p>
<figcaption class="figure-caption margin-caption">Extra fields from a BibTeX file</figcaption>
</figure>
</div>
<p>I decided to treat these as Zotero tags, which BibDesk calls keywords. I considered making some sort of programmatic solution and writing a script to convert all the <code>rating</code> and <code>read</code> fields to <code>keywords</code>, but that seemed like too much work—many entries have existing keywords and parsing the file and concatenating ratings and read status to the list of keywords would be hard.</p>
<p>So instead I sorted all my entries in BibDesk by rating, selected all the 5 star ones and added a <code>zzzzz</code> tag, selected all the 4 star ones and added a <code>zzzz</code> tag, and so on (so that 1 star entries got a <code>z</code>) tag. I then sorted the entries by read status and assigned <code>xxx</code> to all the ones I’ve read. These tag names were just temporary—in Zotero I changed these to emojis (⭐️⭐️⭐️ and ✅), but because I was worried about transferring complex Unicode characters like emojis across programs, I decided to simplify things by temporarily just using ASCII characters.</p>
</section>
<section id="files" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="files">Files</h3>
<section id="a-note-on-bibdesks-stored-filename" class="level4">
<h4 class="anchored" data-anchor-id="a-note-on-bibdesks-stored-filename">A note on BibDesk’s stored filename</h4>
<p>BibDesk can autofile attached PDFs and manage their location. To keep track of where the files are, it stores their path as a base64-encoded path in a <code>bdsk-file-N</code> field in the <code>.bib</code> file, like this:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bibtex code-with-copy"><code class="sourceCode bibtex"><span id="cb2-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@article</span>{<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">HeissKelley:2017</span>,</span>
<span id="cb2-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">author</span> = {Andrew Heiss and Judith G. Kelley},</span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">doi</span> = {10.1086/691218},</span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">journal</span> = {Journal of Politics},</span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">month</span> = {4},</span>
<span id="cb2-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">number</span> = {2},</span>
<span id="cb2-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pages</span> = {732--41},</span>
<span id="cb2-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span> = {Between a Rock and a Hard Place: International {NGOs} and the Dual Pressures of Donors and Host Governments},</span>
<span id="cb2-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">volume</span> = {79},</span>
<span id="cb2-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">year</span> = {2017},</span>
<span id="cb2-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bdsk-file-1</span> = {YnBsaXN0MDDSAQIDBFxyZWxhdGl2ZVBhdGhZYWxpYXNEYXRhXxBcUGFwZXJzL0hlaXNzS2VsbGV5MjAxNyAtIEJldHdlZW4gYSBSb2NrIGFuZCBhIEhhcmQgUGxhY2UgSW50ZXJuYXRpb25hbCBOR09zIGFuZCB0aGUgRHVhbC5wZGZPEQJ8AAAAAAJ8AAIAAAxNYWNpbnRvc2ggSEQAAAAAAAAAAAAAAAAAAADfgQ51QkQAAf////8fSGVpc3NLZWxsZXkyMDE3IC0gI0ZGRkZGRkZGLnBkZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////9T5sk0AAAAAAAAAAAABAAMAAAogY3UAAAAAAAAAAAAAAAAABlBhcGVycwACAHwvOlVzZXJzOmFuZHJldzpEcm9wYm94OlJlYWRpbmdzOlBhcGVyczpIZWlzc0tlbGxleTIwMTcgLSBCZXR3ZWVuIGEgUm9jayBhbmQgYSBIYXJkIFBsYWNlIEludGVybmF0aW9uYWwgTkdPcyBhbmQgdGhlIER1YWwucGRmAA4ArABVAEgAZQBpAHMAcwBLAGUAbABsAGUAeQAyADAAMQA3ACAALQAgAEIAZQB0AHcAZQBlAG4AIABhACAAUgBvAGMAawAgAGEAbgBkACAAYQAgAEgAYQByAGQAIABQAGwAYQBjAGUAIABJAG4AdABlAHIAbgBhAHQAaQBvAG4AYQBsACAATgBHAE8AcwAgAGEAbgBkACAAdABoAGUAIABEAHUAYQBsAC4AcABkAGYADwAaAAwATQBhAGMAaQBuAHQAbwBzAGgAIABIAEQAEgB6VXNlcnMvYW5kcmV3L0Ryb3Bib3gvUmVhZGluZ3MvUGFwZXJzL0hlaXNzS2VsbGV5MjAxNyAtIEJldHdlZW4gYSBSb2NrIGFuZCBhIEhhcmQgUGxhY2UgSW50ZXJuYXRpb25hbCBOR09zIGFuZCB0aGUgRHVhbC5wZGYAEwABLwAAFQACAA3//wAAAAgADQAaACQAgwAAAAAAAAIBAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAMD}}</span></code></pre></div>
<p>Zotero doesn’t parse that gnarly field—it needs a field named <code>file</code>—and it doesn’t decode that messy string into a plain text file path, so the attached PDF won’t get imported correctly.</p>
<p><em>However</em>, <a href="https://github.com/retorquere/zotero-better-bibtex/issues/2374">thanks to Emiliano Heyns</a>, the Better BibTeX add-on will automatically convert these base64-encoded paths to plain text fields that Zotero can work with just fine. All PDFs will import automatically!</p>
</section>
<section id="customizing-zoteros-renaming-rules" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="customizing-zoteros-renaming-rules">Customizing Zotero’s renaming rules</h4>
<p>I wanted all the PDFs that Zotero would manage to have nice predictable filenames. In BibDesk, I used this pattern:</p>
<pre><code>citekey - First few words of title.pdf</code></pre>
<p>That’s been fine, but it uses spaces in the file name and doesn’t remove any punctuation or special characters, so it was a little trickier to work with in the terminal or with scripts or for easy consistent searching (especially when searching in the iPad Dropbox app when looking for a PDF to read). But because I set up that pattern in 2008, <a href="https://en.wikipedia.org/wiki/Path_dependence">path dependency</a> kind of locked me in and I’ve been unwilling to change it since.</p>
<p>Since I’m starting with a whole new reference manager, I figured it was time to adopt a better PDF naming system. In the ZotFile preferences, I set this pattern:</p>
<pre><code>{%a-}{%y-}{%t}</code></pre>
<p>…which translates to</p>
<pre><code>up_to_three_last_names-year-first_few_characters_of_title.pdf</code></pre>
<p><em>(see <a href="http://zotfile.com/index.html#renaming-rules">this for a list of all the possible wildcards</a>)</em></p>
<p>…with <code>-</code> separating the three logical units (authors, year, title), and <code>_</code> separating all the words within each unit (which follows <a href="http://www2.stat.duke.edu/~rcs46/lectures_2015/01-markdown-git/slides/naming-slides/naming-slides.pdf">Jenny Bryan’s principles of file naming</a>). In practice, the pattern looks like this:</p>
<pre><code>heiss_kelley-2017-between_a_rock_and_a_hard_place.pdf</code></pre>
<p>I had to tweak a few other renaming settings too. Here’s the final set of preferences:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/zotfile-preferences.png" class="img-fluid figure-img" style="width:80.0%" alt="ZotFile preferences"></p>
<figcaption class="figure-caption margin-caption">ZotFile preferences</figcaption>
</figure>
</div>
<p>I wanted to switch the roles of <code>-</code> and <code>_</code> and do</p>
<pre><code>heiss-kelley_2017_between-a-rock-and-a-hard-place.pdf</code></pre>
<p>…but Zotero and/or ZotFile seems to hardwire <code>_</code> as the space replacement in its titles. Oh well.</p>
</section>
</section>
<section id="citekeys" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="citekeys">Citekeys</h3>
<p>In BibDesk, I’ve had a citation key pattern that I’ve used for years: <code>Lastname:Year</code>, with up to three last names for coauthored things, and an incremental lowercase letter in the case of duplicates:</p>
<pre><code>HeissKelley:2017
HeissKelley:2017a
Imbens:2021
LundbergJohnsonStewart:2021</code></pre>
<p>Zotero and Better BibTeX preserve citekeys when you import a <code>.bib</code> file, but I wanted to make sure I keep using this system for new items I add going forward, so I changed the Better BibTeX preferences to use the same pattern:</p>
<pre><code>auth(0,1) + auth(0,2) + auth(0,3) + ":" + year</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/bbt-settings.png" class="img-fluid figure-img" style="width:90.0%" alt="Better BibTeX settings"></p>
<figcaption class="figure-caption margin-caption">Better BibTeX settings</figcaption>
</figure>
</div>
</section>
</section>
<section id="post-import-tweaks" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="post-import-tweaks">Post-import tweaks</h2>
<p>With all that initial prep work done, I imported the <code>.bib</code> file into my Zotero library (File &gt; Import…). I made sure “Place imported collections and items to new collection” was checked and that files were copied to the Zotero storage folder:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/zotero-import.png" class="img-fluid figure-img" style="width:90.0%" alt="Zotero's import dialog"></p>
<figcaption class="figure-caption margin-caption">Zotero’s import dialog</figcaption>
</figure>
</div>
<section id="ratings-and-read-status-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ratings-and-read-status-1">Ratings and read status</h3>
<p>The Tags panel in Zotero then showed all the project/class-specific keywords from BibDesk, in addition to the ratings and read status tags I added previously:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/tags-pre-renaming.png" class="img-fluid figure-img" style="width:50.0%" alt="Tags before renaming"></p>
<figcaption class="figure-caption margin-caption">Tags before renaming</figcaption>
</figure>
</div>
<p>I renamed each of the <code>zzz*</code> rating tags to use emoji stars and renamed the <code>xxx</code> read tag to use ✅.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/tags-post-renaming.png" class="img-fluid figure-img" style="width:50.0%" alt="Tags after renaming"></p>
<figcaption class="figure-caption margin-caption">Tags after renaming</figcaption>
</figure>
</div>
<p>Zotero has the ability to assign tags specific colors and pin them in a specific order, which also makes the tags display in the main Zotero library list. Following <a href="https://github.com/windingwind/zotero-tag/blob/master/docs/item-star.md">advice from the Zotero Tag extension</a>, I pinned the read status ✅ tag as the first tag, the 5-star rating as the second tag, the 4-star rating as the third tag, and so on.</p>
<p>Now the read status and ratings tags are easily accessible and appear directly in the main Zotero library list!</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/library-with-read-ratings.png" class="img-fluid figure-img" style="width:100.0%" alt="Zotero library with read status and ratings tags"></p>
<figcaption class="figure-caption margin-caption">Zotero library with read status and ratings tags</figcaption>
</figure>
</div>
</section>
<section id="tags-to-collections" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="tags-to-collections">Tags to collections</h3>
<p>Zotero has two different methods for categorizing entries—<a href="https://www.zotero.org/support/collections_and_tags">tags and collections</a>—while BibDesk / BibTeX only uses keywords, which Zotero treats as tags.</p>
<p>I decided that in Zotero I’d use both tags and collections. Tags are reserved for things like general topics, ratings, to-read designations, etc., while collections represent specific projects or classes.</p>
<p>I already assigned project- and class-specific keywords in BibDesk, so I just needed to move those keyworded entries into Zotero collections. There’s no way (that I could find) to include collection information in the <code>.bib</code> file and have it import into Zotero, so I ended up manually creating collections for each of the imported keywords. I filtered the library to only show items from one of the future collections, selected all the items, right-clicked, and chose “Add to collection” &gt; “New collection…” and created a new collection. I then deleted the tag.</p>
<p>For instance, here’s what Zotero looked like after I assigned these 6 items, tagged as “Polsci 733”, to the new “Polsci 733” collection (shown in the folder in the sidebar). I just had to delete the tag after:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/example-733.png" class="img-fluid figure-img" style="width:100.0%" alt="Example of the Polsci 733 tag after being converted to a collection"></p>
<figcaption class="figure-caption margin-caption">Example of the Polsci 733 tag after being converted to a collection</figcaption>
</figure>
</div>
</section>
<section id="incollection-inbook-and-crossref" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="incollection-inbook-and-crossref"><code>incollection</code> / <code>inbook</code> and <code>crossref</code></h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>This <a href="https://github.com/andrewheiss/ath-quarto/blob/74041ee1b8eab2f1054a4422651f0d49e12137bc/blog/2023/01/08/bibdesk-to-zotero-pandoc/index.qmd#L253">used to cause problems</a> with child references not importing fields from their parents, but <a href="https://github.com/retorquere/zotero-better-bibtex/issues/2373">thanks to Emiliano Heynes</a>, this all works flawlessly if you have verison 6.7.47+ of Better BibTeX installed.</p>
</div>
</div>
<p><a href="https://bibdesk.sourceforge.io/manual/BibDeskHelp_2.html#SEC18">BibDesk natively supports the <code>crossref</code> field</a>, which biber and biblatex use when working with LaTeX. This field lets you set up child/parent relationships with items, where children inherit fields from their parents. For instance, consider these two items—an edited book with lots of chapters from different authors and a chapter from that book:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bibtex code-with-copy"><code class="sourceCode bibtex"><span id="cb10-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@inbook</span>{<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">El</span>-<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">HusseiniToeplerSalamon:2004</span>,</span>
<span id="cb10-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">author</span> = {Hashem El-Husseini and Stefan Toepler and Lester M. Salamon},</span>
<span id="cb10-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">chapter</span> = {12},</span>
<span id="cb10-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">crossref</span> = {SalamonSokolowski:2004},</span>
<span id="cb10-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pages</span> = {227--32},</span>
<span id="cb10-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span> = {Lebanon}}</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">@book</span>{<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">SalamonSokolowski:2004</span>,</span>
<span id="cb10-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">address</span> = {Bloomfield, CT},</span>
<span id="cb10-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">editor</span> = {Lester M. Salamon and S. Wojciech Sokolowski},</span>
<span id="cb10-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">publisher</span> = {Kumarian Press},</span>
<span id="cb10-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span> = {Global Civil Society: Dimensions of the Nonprofit Sector},</span>
<span id="cb10-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">volume</span> = {2},</span>
<span id="cb10-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">year</span> = {2004}}</span></code></pre></div>
<p>In BibDesk, the chapter displays like this:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/bibdesk-crossref.png" class="img-fluid figure-img" style="width:100.0%" alt="BibDesk editor window for a book chapter that inherits its parent book's attributes"></p>
<figcaption class="figure-caption margin-caption">BibDesk editor window for a book chapter that inherits its parent book’s attributes</figcaption>
</figure>
</div>
<p>Fields like book title, publisher, year, etc., are all greyed out because they’re inherited from the parent book, with the citekey <code>SalamonSokolowski:2004</code></p>
<p>If you install version 6.7.47+ of the <a href="https://retorque.re/zotero-better-bibtex/">Better BibTeX</a> add-on, the chapter will inherit all the information from its parent book—the book title, date, publisher, etc., will all be imported correctly:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/correct-crossref-fields.png" class="img-fluid figure-img" style="width:50.0%" alt="Cross referenced parent attributes in Zotero are imported correctly"></p>
<figcaption class="figure-caption margin-caption">Cross referenced parent attributes in Zotero are imported correctly</figcaption>
</figure>
</div>
</section>
<section id="all-done" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="all-done">All done!</h3>
<p>And with that, I have a complete version of my 15-year-old <code>references.bib</code> file inside Zotero!</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/zotero-final.png" class="img-fluid figure-img" style="width:100.0%" alt="Complete Zotero library"></p>
<figcaption class="figure-caption margin-caption">Complete Zotero library</figcaption>
</figure>
</div>
</section>
</section>
<section id="example-workflow-with-quarto-r-markdown-pandoc" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-workflow-with-quarto-r-markdown-pandoc">Example workflow with Quarto / R Markdown / pandoc</h2>
<p>Part of the reason I’ve been hesitant to switch away from BibDesk for so long is because I couldn’t figure out a way to connect a Markdown document to my Zotero database. With documents that get parsed through pandoc (like R Markdown or Quarto), you add a line in the YAML front matter to specify what file contains your references:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb11-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Whatever</span></span>
<span id="cb11-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Whoever</span></span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bibliography</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> references.bib</span></span>
<span id="cb11-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div>
<p>Since Zotero keeps everything in one big database, I didn’t see a way to add something like <code>bibliography: My Zotero Database</code> to the YAML front matter—pandoc requires that you point to a plain text file like <code>.bib</code> or <code>.json</code> or <code>.yml</code>, not a Zotero database.</p>
<p>However, the <a href="https://retorque.re/zotero-better-bibtex/">magical Better BibTeX add-on</a> clarified everything for me and makes it super easy to point pandoc at a single file that contains a collection of reference items.</p>
<section id="export-collection-to-.bib-file" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="export-collection-to-.bib-file">Export collection to <code>.bib</code> file</h3>
<p>First, create a collection of items that you want to cite in your writing project. Since collections are like playlists and items can belong to multiple collections, there’s no need to manage duplicate entries or anything (like I was running into with Problem 2 above).</p>
<p>Right click on the collection name and choose “Export collection…”.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/export-collection.png" class="img-fluid figure-img" style="width:70.0%" alt="Exporting a Zotero collection"></p>
<figcaption class="figure-caption margin-caption">Exporting a Zotero collection</figcaption>
</figure>
</div>
<p>Change the format to “Better BibLaTeX”, check “Keep updated”, and choose a place to save the resulting <code>.bib</code> file.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/export-format.png" class="img-fluid figure-img" style="width:60.0%" alt="Changing the export format"></p>
<figcaption class="figure-caption margin-caption">Changing the export format</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You could also export it as “Better CSL JSON” or “Better CSL YAML”, which would create a <code>.json</code> or <code>.yml</code> file that you could then point to in your YAML front matter, which would keep everything in CSL format instead of converting things to <code>.bib</code> and back again (see Problem 3 above). However, in my academic writing projects I still like to let LaTeX, BibLaTeX, and biber handle the citation generation instead of pandoc <em>for PDFs</em>, so I still rely on <code>.bib</code> files. But if you’re not converting to PDF, or if you’re letting the CSL style template handle the citations instead of BibLaTeX, <a href="https://retorque.re/zotero-better-bibtex/exporting/pandoc/">you should probably keep everything as JSON or YAML</a> instead of <code>.bib</code>.</p>
</div>
</div>
<p>The “Keep updated” option is the magical part of this whole thing. If you add an item or edit an existing item in the collection in Zotero, <strong>Better BibTeX will automatically re-export the collection</strong> to the <code>.bib</code> file. You can have one central repository of citations and lots of dynamically updated plain text <code>.bib</code> files that you don’t have to edit or keep track of. Truly magical.</p>
</section>
<section id="point-the-.qmd-.rmd-.md-to-the-exported-file" class="level3">
<h3 class="anchored" data-anchor-id="point-the-.qmd-.rmd-.md-to-the-exported-file">Point the <code>.qmd</code> / <code>.Rmd</code> / <code>.md</code> to the exported file</h3>
<p>You’ll now have a <code>.bib</code> file that contains all the references that you can cite. Put that filename in your front matter (use <code>.json</code> or <code>.yml</code> if you export the file as JSON or YAML instead):</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb12-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Whatever</span></span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Whoever</span></span>
<span id="cb12-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bibliography</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> name_of_file_you_exported_from_zotero.bib</span></span>
<span id="cb12-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div>
</section>
<section id="cite-things" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="cite-things">Cite things</h3>
<p>Cite things <a href="https://quarto.org/docs/authoring/footnotes-and-citations.html#sec-citations">like normal</a>.</p>
<p>Because the front matter is pointed at a plain text <code>.bib</code> file that contains all the bibliographic references, it’ll generate the citations correctly. And because Better BibTeX is configured to automatically update the exported plain text file, any changes you make in Zotero will automatically be reflected. Again, this is magic.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/vscode-output.png" class="img-fluid figure-img" style="width:100.0%" alt="Visual Studio Code with a Quarto Markdown file configured to look at an auto-updating .bib file exported from Zotero"></p>
<figcaption class="figure-caption margin-caption">Visual Studio Code with a Quarto Markdown file configured to look at an auto-updating .bib file exported from Zotero</figcaption>
</figure>
</div>
</section>
<section id="rstudio-based-alternative" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="rstudio-based-alternative">RStudio-based alternative</h3>
<p>Alternatively, if you write in RStudio, you can connect RStudio to your Zotero database and have it do a similar auto-export thing. You can also tell it to use Better BibTeX to keep things automatically synced:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/rstudio-zotero.png" class="img-fluid figure-img" style="width:80.0%" alt="RStudio preferences pane for enabling Zotero"></p>
<figcaption class="figure-caption margin-caption">RStudio preferences pane for enabling Zotero</figcaption>
</figure>
</div>
<p><em>(<a href="https://rstudio.github.io/visual-markdown-editing/citations.html">See here for more details about Zotero citations in RStudio</a>)</em></p>
<p>One extra nice thing about using RStudio is its <a href="https://rstudio.github.io/visual-markdown-editing/citations.html#inserting-citations">fancy Insert Citation dialog</a>, which makes adding citations in Markdown just like adding citations in Word or Google Docs. It only works in the Visual Markdown Editor, though, which I don’t normally use, so I just use Better BibTeX alone rather than RStudio’s Zotero connection when I write in RStudio.</p>


<!-- -->

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {How to Migrate from {BibDesk} to {Zotero} for Pandoc-Based
    Writing},
  date = {2023-01-08},
  url = {https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc},
  doi = {10.59350/cwrq4-m7h10},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas">
Heiss, Andrew. 2023. <span>“How to Migrate from BibDesk to Zotero for
Pandoc-Based Writing.”</span> January 8, 2023. <a href="https://doi.org/10.59350/cwrq4-m7h10">https://doi.org/10.59350/cwrq4-m7h10</a>.
</div></div></section></div> ]]></description>
  <category>writing</category>
  <category>markdown</category>
  <category>citations</category>
  <category>pandoc</category>
  <category>zotero</category>
  <guid>https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/index.html</guid>
  <pubDate>Sat, 07 Jan 2023 22:00:00 GMT</pubDate>
  <media:content url="https://knuutila.net/blog/2023/01/08/bibdesk-to-zotero-pandoc/img/zotero-final.png" medium="image" type="image/png" height="87" width="144"/>
</item>
</channel>
</rss>
